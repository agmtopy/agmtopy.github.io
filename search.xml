<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>rediså¦‚ä½•å®ç°æŒä¹…åŒ–çš„</title>
      <link href="2022/01/20/1.%E6%9D%82%E8%AE%B0/redis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84/"/>
      <url>2022/01/20/1.%E6%9D%82%E8%AE%B0/redis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<h1>rediså¦‚ä½•å®ç°æŒä¹…åŒ–çš„</h1><p>redisç›®å‰å®ç°æŒä¹…åŒ–ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼,ä¸€ç§æ˜¯é€šè¿‡<B>RDBæ–‡ä»¶</B>,å¦å¤–ä¸€ç§æ˜¯é€šè¿‡<B>AOFæ–‡ä»¶</B>.<br>rediså¯¹äºæŒä¹…åŒ–æ”¯æŒ4ç§éƒ¨ç½²æ–¹å¼</p><ul><li>æ— æŒä¹…æ€§</li><li>RDB</li><li>AOF</li><li>RDB + AOF</li></ul><p>è®©å°±è®©æˆ‘ä»¬æ¥è¯¦ç»†æ¯”è¾ƒå’Œåˆ†æä»¥ä¸‹redisåº•å±‚æ˜¯å¦‚ä½•å®ç°çš„RDBå’ŒAOFæœºåˆ¶çš„</p><h2 id="RDBæ–‡ä»¶"><a class="header-anchor" href="#RDBæ–‡ä»¶"></a>RDBæ–‡ä»¶</h2><ul><li>RDBå®šä¹‰</li></ul><blockquote><p>RDB æŒä¹…æ€§æŒ‡çš„æ˜¯åœ¨æŒ‡å®šæ—¶é—´é—´éš”åæ‰§è¡Œè®°å½•å½“å‰æ•°æ®é›†çš„å…¨éƒ¨æ•°æ®å¿«ç…§</p></blockquote><p>RDBæ–‡ä»¶å°±ç±»ä¼¼äºMySqlè¿›è¡Œå…¨é‡å¤‡ä»½,è®°å½•æŸä¸€ä¸ªæ—¶é—´ç‚¹çš„å…¨éƒ¨æ•°æ®</p><ul><li>RDBä¼˜ç‚¹</li></ul><ol><li>æ–‡ä»¶å³æ•°æ®,ä¸æµªè´¹ç©ºé—´</li><li>å¼‚æ­¥ç”Ÿæˆæ–‡ä»¶,æ€§èƒ½æŸè€—æœ€å°</li><li>ä¸éœ€è¦é‡æ–°æ‰§è¡ŒæŒ‡ä»¤,æ•°æ®æ¢å¤æ›´å¿«</li><li>æ”¯æŒä¸»ä»åˆ‡æ¢åçš„æ•°æ®åŒæ­¥</li></ol><ul><li>RDBç¼ºç‚¹</li></ul><ol><li>æ²¡æœ‰é‡‡ç”¨LSMæ—¥å¿—å¤„ç†,ä¼šä¸¢å¤±æ•°æ®</li><li>å¯¹äºéœ€è¦æŒä¹…åŒ–å¤§é‡æ•°æ®æ—¶,æ€§èƒ½ä¸å¦‚AOFå¢é‡æ¨¡å¼</li></ol><h3 id="ä½¿ç”¨å®ä¾‹"><a class="header-anchor" href="#ä½¿ç”¨å®ä¾‹"></a>ä½¿ç”¨å®ä¾‹</h3><p>RDBæœ‰ä¸¤ç§è§¦å‘æ–¹å¼:</p><ol><li>é…ç½®æ–‡ä»¶è§¦å‘</li><li>å‘½ä»¤è§¦å‘</li></ol><ul><li>é…ç½®æ–‡ä»¶è§¦å‘</li></ul><p>é…ç½®æ–‡ä»¶è§¦å‘ä¸ºåœ¨<B>redis.conf</B>ä¸­è®¾ç½®</p><pre class="line-numbers language-config" data-language="config"><code class="language-config">#æ–‡ä»¶è·¯å¾„dir#RDBæ–‡ä»¶åç§°dbfilename #æ˜¯å¦å¯ç”¨æ•°æ®æ ¡éªŒrdbchecksum yes#æ˜¯å¦å¯ç”¨RDBæ–‡ä»¶å‹ç¼©æ ¼å¼rdbcompression yes#bgsaveå¼‚å¸¸æ—¶æ˜¯å¦åœæ­¢å†™å…¥ç¼“å­˜stop-writes-on-bgsave-error yes#60ç§’å†…æœ‰5ä¸ªå€¼å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘ç”ŸæˆRDBæ–‡ä»¶save 60 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>å‘½ä»¤è§¦å‘</p><ul><li>save<br>åŒæ­¥é˜»å¡å‘½ä»¤</li><li>bgsave<br>forkå­è¿›ç¨‹å¼‚æ­¥ç”ŸæˆRDBæ–‡ä»¶</li></ul></li></ul><h3 id="æºç è§£æ"><a class="header-anchor" href="#æºç è§£æ"></a>æºç è§£æ</h3><ul><li>bgsaveçš„æ‰§è¡Œè°ƒç”¨é“¾</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-22%20230847.jpg" alt="bgsaveçš„æ‰§è¡Œé“¾"></p><blockquote><p><B>server.main()</B> -&gt; <B>server.processCommand()</B> -&gt; <B>rdb.rdbSaveBackground()</B> -&gt; <B>rdb.redisFork()</B></p></blockquote><p>ä¸‹é¢è‡ªåº•å‘ä¸Šä¾æ¬¡åˆ†æä¸‹è¿™ä¸ªå››ä¸ªæ–¹æ³•</p><ul><li><B>rdbSave()</B></li></ul>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* å°†æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸Š */</span><span class="token keyword">int</span> <span class="token function">rdbSave</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> rdbSaveInfo <span class="token operator">*</span>rsi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> tmpfile<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> cwd<span class="token punctuation">[</span>MAXPATHLEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Current working dir path for error messages. */</span>    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    rio rdb<span class="token punctuation">;</span>    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">snprintf</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">"temp-%d.rdb"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>cwdp <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span>MAXPATHLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>            <span class="token string">"Failed opening the RDB file %s (in server root dir %s) "</span>            <span class="token string">"for saving: %s"</span><span class="token punctuation">,</span>            filename<span class="token punctuation">,</span>            cwdp <span class="token operator">?</span> cwdp <span class="token operator">:</span> <span class="token string">"unknown"</span><span class="token punctuation">,</span>            <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">rioInitWithFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdb<span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startSaving</span><span class="token punctuation">(</span>RDBFLAGS_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_save_incremental_fsync<span class="token punctuation">)</span>        <span class="token function">rioSetAutoSync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdb<span class="token punctuation">,</span>REDIS_AUTOSYNC_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rdbSaveRio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdb<span class="token punctuation">,</span><span class="token operator">&amp;</span>error<span class="token punctuation">,</span>RDBFLAGS_NONE<span class="token punctuation">,</span>rsi<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        errno <span class="token operator">=</span> error<span class="token punctuation">;</span>        <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* Make sure data will not remain on the OS's output buffers */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fflush</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fsync</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token comment">//é‡å‘½åæ–‡ä»¶æ¥å®ç°å†™å…¥æ–‡ä»¶çš„åŸå­æ€§</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span>filename<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>cwdp <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span>MAXPATHLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>            <span class="token string">"Error moving temp DB file %s on the final "</span>            <span class="token string">"destination %s (in server root dir %s): %s"</span><span class="token punctuation">,</span>            tmpfile<span class="token punctuation">,</span>            filename<span class="token punctuation">,</span>            cwdp <span class="token operator">?</span> cwdp <span class="token operator">:</span> <span class="token string">"unknown"</span><span class="token punctuation">,</span>            <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">unlink</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">stopSaving</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"RDBè½ç›˜æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span>lastsave <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span>lastbgsave_status <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>    <span class="token function">stopSaving</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>werr<span class="token operator">:</span>    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Write error saving DB on disk: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unlink</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">stopSaving</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>rdbSave()</B>å®Œæˆå¯¹RDBæ–‡ä»¶çš„å†™å…¥æ“ä½œ:</p><ol><li>åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶,å°†å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œå†™å…¥,ç„¶ååˆ·ç›˜</li><li>å¯¹ä¸´æ—¶æ–‡ä»¶è¿›è¡Œrename(ğŸ‘å†™å…¥æ–‡ä»¶ä¸ä¸€å®šæ˜¯åŸå­,ä½†æ˜¯rename fileä¸€å®šæ˜¯åŸå­æ€§çš„),æ¥ä¿è¯æ–‡ä»¶å†™å…¥çš„åŸå­æ€§</li></ol><ul><li><B>rdbSaveBackground</B></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">rdbSaveBackground</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> rdbSaveInfo <span class="token operator">*</span>rsi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pid_t</span> childpid<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>    server<span class="token punctuation">.</span>dirty_before_bgsave <span class="token operator">=</span> server<span class="token punctuation">.</span>dirty<span class="token punctuation">;</span>    server<span class="token punctuation">.</span>lastbgsave_try <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//forkå­è¿›ç¨‹è¿›è¡Œå¤„ç†RDBæ–‡ä»¶,è¿™é‡Œçš„fork()è¿”å›å€¼-1è¡¨ç¤ºæ²¡æœ‰åˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸ,0è¡¨ç¤ºåˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>childpid <span class="token operator">=</span> <span class="token function">redisFork</span><span class="token punctuation">(</span>CHILD_TYPE_RDB<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> retval<span class="token punctuation">;</span>        <span class="token comment">/* Child */</span>        <span class="token function">redisSetProcTitle</span><span class="token punctuation">(</span><span class="token string">"redis-rdb-bgsave"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">redisSetCpuAffinity</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>bgsave_cpulist<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"RDBæ–‡ä»¶ä¸º: %s"</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>        retval <span class="token operator">=</span> <span class="token function">rdbSave</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span>rsi<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç”Ÿæˆrdbæ–‡ä»¶</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">sendChildCowInfo</span><span class="token punctuation">(</span>CHILD_INFO_TYPE_RDB_COW_SIZE<span class="token punctuation">,</span> <span class="token string">"RDB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">exitFromChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>retval <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/* çˆ¶è¿›ç¨‹å¤„ç† */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>childpid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            server<span class="token punctuation">.</span>lastbgsave_status <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Can't save in background: fork: %s"</span><span class="token punctuation">,</span>                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Background saving started by pid %ld"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> childpid<span class="token punctuation">)</span><span class="token punctuation">;</span>        server<span class="token punctuation">.</span>rdb_save_time_start <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        server<span class="token punctuation">.</span>rdb_child_type <span class="token operator">=</span> RDB_CHILD_TYPE_DISK<span class="token punctuation">;</span>        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span> <span class="token comment">/* unreached */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨é€šè¿‡<B>redisFork()</B>åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹æ¥å®Œæˆ<B>rdbSave()</B>çš„è°ƒç”¨</p><p>çˆ¶è¿›ç¨‹ä¸ä¼šé˜»å¡è€Œæ˜¯ç›´æ¥æ‰“å°RDBæ–‡ä»¶å¼€å§‹å¤„ç†çš„æ¶ˆæ¯</p><p>éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯fork()è¿›ç¨‹çš„æ–¹æ³•è¿”å›å€¼æ˜¯0-æˆåŠŸ/-1-å¤±è´¥</p><p>åœ¨è¿™ä¸€æ­¥çš„è°ƒç”¨ä¸­çœç•¥<B>rdb.bgsaveCommand()</B>çš„è°ƒç”¨é€»è¾‘,ç›´æ¥åˆ†æ<B>server.c</B>ä¸­çš„é€»è¾‘</p><ul><li><B>server.c()</B></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> redisCommandTable<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span><span class="token string">"module"</span><span class="token punctuation">,</span>moduleCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token string">"admin no-script"</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span><span class="token string">"get"</span><span class="token punctuation">,</span>getCommand<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token string">"read-only fast @string"</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span><span class="token string">"bgsave"</span><span class="token punctuation">,</span>bgsaveCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token string">"admin no-script"</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">//çœç•¥å…¶ä»–å‘½ä»¤</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä½¿ç”¨å‘½ä»¤æ¨¡å¼å°†æ‰€æœ‰å®¢æˆ·ç«¯å‘½ä»¤ä»¥åŠå‘½ä»¤çš„å¤„ç†æ–¹å¼æ”¾åˆ°<B>redisCommandTable</B>ä¸­è¿›è¡Œå¤„ç†,ç„¶ååœ¨å’Œç½‘ç»œæ—¶é—´ç»‘å®šå°±å½¢æˆæœ€å¼€å§‹è¯´çš„è°ƒç”¨é“¾ç»“æ„</p><ul><li>cronæ–¹å¼å¯åŠ¨<br>cronæ–¹å¼å¯åŠ¨çš„é€»è¾‘ä½äº<B>server.serverCron()</B>ä¸­</li></ul><h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“"></a>å°ç»“</h3><p>RDBæ–‡ä»¶æ˜¯é€šè¿‡fork()å­è¿›ç¨‹æ¥å¤„ç†æ–‡ä»¶,é‡‡ç”¨çš„æ˜¯rename temp fileçš„æ–¹å¼ä¿è¯åŸå­æ€§. çˆ¶è¿›ç¨‹å¹¶ä¸ä¼šé˜»å¡,è€Œæ˜¯å¯åŠ¨å­è¿›ç¨‹åç«‹å³è¿”å›</p><h2 id="AOFæ–‡ä»¶"><a class="header-anchor" href="#AOFæ–‡ä»¶"></a>AOFæ–‡ä»¶</h2><p>AOFæ–‡ä»¶å°±ç±»ä¼¼äºMySqlä¸­çš„binlogä½¿ç”¨çš„Statementæ ¼å¼è®°å½•æ•°æ®å˜åŒ–,æ¯æ¬¡åªè®°å½•æŒ‡ä»¤,å¹¶ä¸”è¶…è¿‡è®¾å®šçš„å¤§å°åä¼šè¿›è¡Œè¦†ç›–</p><h3 id="ä½¿ç”¨å®ä¾‹-v2"><a class="header-anchor" href="#ä½¿ç”¨å®ä¾‹-v2"></a>ä½¿ç”¨å®ä¾‹</h3><ul><li>é…ç½®æ–‡ä»¶</li></ul><pre class="line-numbers language-config" data-language="config"><code class="language-config">#å¼€å¯redis aofappendonly yes#aofåˆ·æ–°æœºåˆ¶ always:æ¯ä¸€æ¡éƒ½å†™å…¥ç£ç›˜,everysec:æ¯ç§’å†™å…¥ç£ç›˜ä¸€æ¬¡,no:æ–‡ä»¶ç³»ç»Ÿåˆ·æ–°appendfsync everysec#aofæ–‡ä»¶æ‰©å®¹çš„é˜€å€¼æ¯”ä¾‹auto-aof-rewrite-percentage 100#aofæ–‡ä»¶é‡å†™åçš„åˆå§‹å¤§å°auto-aof-rewrite-min-size 64mb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æºç è§£æ-v2"><a class="header-anchor" href="#æºç è§£æ-v2"></a>æºç è§£æ</h3><h3 id="å°ç»“-v2"><a class="header-anchor" href="#å°ç»“-v2"></a>å°ç»“</h3><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><h2 id="å‚è€ƒæ–‡ç« "><a class="header-anchor" href="#å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://redis.io/topics/persistence">Redis Persistence</a><br><a href="http://oldblog.antirez.com/post/redis-persistence-demystified.html">Redis persistence demystified</a><br><a href="https://redis.io/topics/latency">Redis å»¶è¿Ÿé—®é¢˜æ’æŸ¥</a><br><a href="https://dl.acm.org/doi/fullHtml/10.1145/3318159">TxFSï¼šåˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿå´©æºƒä¸€è‡´æ€§æ¥æä¾› ACID äº‹åŠ¡</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisæºä»£ç æ„å»º</title>
      <link href="2022/01/19/1.%E6%9D%82%E8%AE%B0/redis%E6%BA%90%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA/"/>
      <url>2022/01/19/1.%E6%9D%82%E8%AE%B0/redis%E6%BA%90%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1>redisæºä»£ç æ„å»º</h1><p>ä¸»è¦ç”¨æ¥è®°å½•ä»¥ä¸‹åœ¨WSLä¸‹ç¼–è¯‘å’Œéƒ¨ç½²redisæºç çš„è¿‡ç¨‹</p><h2 id="ç¯å¢ƒå‡†å¤‡"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ul><li><p>WSL<br>wsl2æ­é…Ubuntu 18.04ä½¿ç”¨,è¿™ä¸€é¡¹ä¸æ˜¯å¿…é¡»çš„<br><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20220306.jpg" alt="wsl"></p></li><li><p>Clion<br>JetBrainsçš„C/C++ IDE,è¿™ä¸€é¡¹ä¹Ÿä¸æ˜¯å¿…é¡»çš„</p></li><li><p>æºä»£ç <br><a href="https://github.com/redis/redis">https://github.com/redis/redis</a></p></li></ul><h2 id="æ„å»ºè¿‡ç¨‹"><a class="header-anchor" href="#æ„å»ºè¿‡ç¨‹"></a>æ„å»ºè¿‡ç¨‹</h2><ul><li>æŒ‰ç…§Linuxç¼–è¯‘å·¥å…·</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> update<span class="token function">apt</span> <span class="token function">install</span> <span class="token function">git</span>  cmake <span class="token function">make</span> gcc g++ gdb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>æ„å»ºrelease.h</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#æˆæƒ</span><span class="token function">chmod</span> +x mkreleasehdr.sh<span class="token comment">#æ‰§è¡Œmake</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤å°±å®Œæˆredisæºä»£ç çš„ç¼–è¯‘,æ¥ä¸‹æ¥è®©æˆ‘ä»¬æŠŠæºä»£ç å¯¼å…¥CLionä¸­è¿›è¡Œdebug</p><h2 id="è°ƒè¯•è¿‡ç¨‹"><a class="header-anchor" href="#è°ƒè¯•è¿‡ç¨‹"></a>è°ƒè¯•è¿‡ç¨‹</h2><ul><li>å¯¼å…¥é¡¹ç›®</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20231623.jpg" alt="å¯¼å…¥é¡¹ç›®"></p><ul><li>è®¾ç½®è¿œç¨‹éƒ¨ç½²</li></ul><ol><li>è®¾ç½®è¿œç¨‹éƒ¨ç½²å·¥å…·é“¾</li></ol><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20231847.jpg" alt="å·¥å…·é“¾"></p><ol start="2"><li>è®¾ç½®CMake</li></ol><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20231912.jpg" alt="CMake"></p><ol start="3"><li>è®¾ç½®MakeFile</li></ol><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20232004.jpg" alt="MakeFile"></p><ul><li>è®¾ç½®è°ƒè¯•å™¨</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20232030.jpg" alt="è®¾ç½®è°ƒè¯•å™¨"></p><h2 id="debug"><a class="header-anchor" href="#debug"></a>debug</h2><ul><li>å¯åŠ¨redis-server</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20232618.jpg" alt="å¯åŠ¨redis-server"></p><ul><li>è®¾ç½®æ–­ç‚¹</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20235133.jpg" alt="è®¾ç½®æ–­ç‚¹"></p><p>ä»¥setä¸ºä¾‹,åŸºæœ¬è°ƒç”¨è¿‡ç¨‹ä¸º<br><B>server.c</B> -&gt; <B>connection.c</B> -&gt; <B>t_set.c</B></p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯æœ¬åœ°ç¼–è¯‘redisçš„è¿‡ç¨‹,åç»­å®˜ç½‘ä¸Šè¿˜æœ‰ç¼–è¯‘æŒ‚è½½redisæ‰©å±•åº“çš„è¿‡ç¨‹å’Œdockerfileçš„ç›¸å…³æ“ä½œ(æœªå®Œå¾…ç»­!)</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisåº•å±‚æ•°æ®ç»“æ„åˆ†æ</title>
      <link href="2022/01/05/1.%E6%9D%82%E8%AE%B0/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/"/>
      <url>2022/01/05/1.%E6%9D%82%E8%AE%B0/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>redisåº•å±‚æ•°æ®ç»“æ„åˆ†æ</h1><p>redisåº•å±‚æ•°æ®ç»“æ„åˆ†æä¸»è¦æ˜¯æ ¹æ®ã€ŠRedis5 è®¾è®¡ä¸æºç åˆ†æã€‹ä¸€ä¹¦çš„ç« èŠ‚è€Œæ¥,å‚è€ƒå¯¹ç…§ä»£ç ç‰ˆæœ¬ä¸º6.2,æºä»£ç çš„ç¼–è¯‘å’Œéƒ¨ç½²å¯ä»¥æŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« </p><p>redisåº•å±‚æ•°æ®ç»“æ„å¯ä»¥åˆ’åˆ†ä¸º</p><ul><li>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</li><li>è·³è·ƒè¡¨</li><li>å‹ç¼©åˆ—è¡¨</li><li>å­—å…¸</li><li>æ•´æ•°é›†åˆ</li><li>quicklist</li><li>stream</li></ul><p>è¿™ä¸ƒç§æ•°æ®ç±»å‹,ä¸‹é¢åˆ†åˆ«å¯¹è¿™ä¸ƒç§æ•°æ®ç±»å‹è¿›è¡Œåˆ†æ</p><h2 id="ç®€å•åŠ¨æ€å­—ç¬¦ä¸²"><a class="header-anchor" href="#ç®€å•åŠ¨æ€å­—ç¬¦ä¸²"></a>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</h2><h3 id="æ•°æ®ç»“æ„"><a class="header-anchor" href="#æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²åˆè¢«ç§°ä¸º<B>SDS</B>,å‡ ä¹è´¯ç©¿redisä¸­æ‰€æœ‰çš„æ¨¡å—ã€‚redisä¸­é‡æ–°è®¾è®¡å­—ç¬¦ä¸²çš„åŸå› æ˜¯ç”±äºCè¯­è¨€ä¸­çš„char*,ä¸æ»¡è¶³redisä¸­çš„ä¸€äº›å¸¸ç”¨æ“ä½œä¾‹å¦‚è¿½åŠ å­—ç¬¦ã€<br>è®¡æ•°ç­‰ã€‚</p><ul><li><p>char*<br>åœ¨Cè¯­è¨€ä¸­å®šä¹‰çš„å­—ç¬¦ä¸²ç»“æ„ä¸º:å­—ç¬¦+å­—ç¬¦ç»“å°¾ï¼Œä¾‹å¦‚&quot;hello world!/n&quot;,è€Œ/nå°±æ˜¯å­—ç¬¦ç»“å°¾ï¼Œè¿™æ ·çš„ç»“æ„ä¸æ»¡è¶³redisæ‰€éœ€è¦çš„å¿«é€Ÿè¿½åŠ å’Œè®¡æ•°æ“ä½œ</p></li><li><p>SDS<br>SDSç»“æ„æ˜¯ä¸€ä¸ªå¯ä»¥æè¿°å­—ç¬¦ä¸²ç±»å‹(rediså†…éƒ¨ç”¨äºåŒºåˆ†é•¿åº¦)ã€å­—ç¬¦ä¸²é•¿åº¦ã€å­—ç¬¦æŒ‡é’ˆçš„ç±»å‹,ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„SDSçš„å®šä¹‰</p></li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">typedef char *sds;struct __attribute__ ((__packed__)) sdshdr8 &#123;    uint8_t len; &#x2F;* used *&#x2F;    uint8_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;    char buf[];&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°SDSçš„ç±»å‹è¿˜æ˜¯*charï¼Œä½†æ˜¯åœ¨å†…éƒ¨é‡æ–°å®šä¹‰äº†len-å ç”¨é•¿åº¦ã€alloc-æœ€å¤§é•¿åº¦ã€flags-æ ‡è¯†ç­‰ã€‚</p><p><img src="https://s2.loli.net/2022/01/17/VpmsYwhPUc9KBCq.png" alt="sdsçš„æ•°æ®ç»“æ„"></p><p>åœ¨è¿™å¼ å›¾ä¸­çš„<B>sdshdr8</B>ã€<B>sdshdr16</B>,flagsçš„ä½ä¸‰ä½å­˜å‚¨çš„æ˜¯SDSçš„ç±»å‹ï¼Œé«˜5ä½æ²¡æœ‰å«ä¹‰ï¼Œåœ¨SDS5ä¸­é«˜5ä½å­˜å‚¨çš„æ˜¯é•¿åº¦ã€‚<br>å®é™…å­˜å‚¨æ•°æ®çš„æ˜¯<B>buf[]</B>,buf[]æ˜¯ä¸€ä¸ªæŸ”æ€§æ•°ç»„ï¼ŒæŸ”æ€§æ•°ç»„æŒ‡çš„æ˜¯æ•°æ®ç»“æ„å’Œå†…å®¹åœ¨å†…å­˜ä¸Šæ˜¯è¿ç»­çš„ï¼Œè¿™æ ·çš„ç»“æ„æŸ¥è¯¢æ›´å¿«é€Ÿ(å› ä¸ºä¸éœ€è¦é¢å¤–è¿›è¡ŒæŒ‡é’ˆæ“ä½œ)<br>ä½¿ç”¨<B><strong>attribute</strong></B>è®©ç¼–è¯‘å™¨ä»¥ç´§å‡‘æ¨¡å¼è¿›è¡Œå†…å­˜åˆ†é…,è¿™æ ·å¯ä»¥èŠ‚çœ<B>flags</B>çš„3ä¸ªå­—èŠ‚ï¼Œé»˜è®¤å†…å­˜åˆ†é…æ˜¯ä»¥4ä¸ªå­—èŠ‚è¿›è¡Œåˆ†é…çš„</p><ul><li>å°ç»“<br>å…³äºSDSéœ€è¦è®°ä½çš„tags:</li></ul><ol><li>[ç»§æ‰¿] ç»§æ‰¿äºchar*</li><li>[ç±»å‹] æ˜¯ä¸€ç§åŠ¨æ€çš„å­—ç¬¦ä¸²ï¼Œæ ¹æ®å­—ç¬¦çš„é•¿åº¦å¯ä»¥åˆ†é…ä¸åŒçš„SDSç±»å‹</li><li>[ç»„æˆ] ç”±äºlenã€allocã€flagsã€buf[]æ„æˆ</li><li>[ç´§å‡‘] ç´§å‡‘æ¨¡å¼åˆ†é…ç±»å‹</li></ol><h3 id="æ“ä½œ"><a class="header-anchor" href="#æ“ä½œ"></a>æ“ä½œ</h3><p>SDS-åŠ¨æ€å­—ç¬¦ä¸²å…·æœ‰çš„æ“ä½œåˆ†åˆ«æœ‰å¢åˆ æ”¹æŸ¥è¿™å‡ ç§ï¼Œå…¶ä¸­åˆ é™¤çš„è®¾è®¡æ¯”è¾ƒç‰¹åˆ«ã€‚</p><ul><li>åˆ é™¤</li></ul><p>SDSçš„åˆ é™¤æ˜¯é€šè¿‡<B>sdsclear</B>æ¥å®ç°çš„,ç›´æ¥è®¾ç½®lenä¸º0çš„æ–¹å¼æ¥å®ç°</p><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* Modify an sds string in-place to make it empty (zero length).* However all the existing buffer is not discarded but set as free space* so that next append operations will not require allocations up to the* number of bytes previously available. *&#x2F;void sdsclear(sds s) &#123;    sdssetlen(s, 0);    s[0] &#x3D; &#39;\0&#39;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¢åŠ </li></ul><p>å¢åŠ æœºåˆ¶å¯å‚è€ƒä¸‹å›¾<br><img src="https://s2.loli.net/2022/01/06/LUTovNR2k3hyIKm.png" alt="redis_sds_æ‰©å®¹æœºåˆ¶"></p><p>ä¸»è¦æ˜¯è¿›è¡Œä¸¤ä¸ªåˆ¤æ–­</p><ol><li>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç±»å‹æ›´æ”¹</li></ol><p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸ä¼šä½¿ç”¨SDS5çš„ç±»å‹,å› ä¸ºRedisè®¤ä¸ºæ‰©å®¹æ˜¯ä¸€ç§å¸¸è§çš„æ“ä½œ,å› æ­¤SDS5å¾ˆå¤§çš„å‡ ç‡ä¼šæ›´æ–°æˆä¸ºSDS8ç±»å‹.</p><h2 id="è·³è·ƒåˆ—è¡¨"><a class="header-anchor" href="#è·³è·ƒåˆ—è¡¨"></a>è·³è·ƒåˆ—è¡¨</h2><h3 id="æ•°æ®ç»“æ„-v2"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v2"></a>æ•°æ®ç»“æ„</h3><p>è·³è·ƒåˆ—è¡¨æŒ‡çš„æ˜¯é€šè¿‡ç»´æŠ¤ä¸€ä¸ªå¤šå±‚çš„é“¾è¡¨ç»“æ„æ¥å®ç°å¿«é€ŸæŸ¥æ‰¾çš„æ•°æ®ç»“æ„<br><a href="https://zh.wikipedia.org/wiki/%E8%B7%B3%E8%B7%83%E5%88%97%E8%A1%A8">è·³è·ƒåˆ—è¡¨</a>çš„è§£é‡Š.<br>ä¸‹é¢æ˜¯ä¸€ä¸ªè·³è·ƒåˆ—è¡¨çš„æ•°æ®ç»“æ„</p><p><img src="https://s2.loli.net/2022/01/06/uciEDA9j2THBkJx.gif" alt="è·³è·ƒåˆ—è¡¨"></p><blockquote><p>é€šè¿‡å°†æœ‰åºé›†åˆçš„éƒ¨åˆ†èŠ‚ç‚¹åˆ†å±‚ï¼Œç”±æœ€ä¸Šå±‚å¼€å§‹ä¾æ¬¡å‘åæŸ¥æ‰¾ï¼Œå¦‚æœæœ¬å±‚çš„nextèŠ‚ç‚¹å¤§äºè¦æŸ¥æ‰¾çš„å€¼æˆ–nextèŠ‚ç‚¹ä¸ºNULLï¼Œåˆ™ä»æœ¬èŠ‚ç‚¹å¼€å§‹ï¼Œé™ä½ä¸€å±‚ç»§ç»­å‘åæŸ¥æ‰¾ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå¦‚æœæ‰¾åˆ°åˆ™è¿”å›èŠ‚ç‚¹ï¼›å¦åˆ™è¿”å›NULLã€‚é‡‡ç”¨è¯¥åŸç†æŸ¥æ‰¾èŠ‚ç‚¹ï¼Œåœ¨èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤šæ—¶ï¼Œå¯ä»¥è·³è¿‡ä¸€äº›èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢æ•ˆç‡å¤§å¤§æå‡ï¼Œè¿™å°±æ˜¯è·³è·ƒè¡¨çš„åŸºæœ¬æ€æƒ³ã€‚</p></blockquote><p>redisä¸­çš„è·³è·ƒåˆ—è¡¨ä¸»è¦æ˜¯ç”±ä¸¤ä¸ªå…ƒç´ è¿›è¡Œå®ç°<B>zskiplistNode</B>ã€<B>zskiplist</B>,ä¸‹é¢æ¥è¯¦ç»†åˆ†æä¸€ä¸‹è¿™ä¸¤ä¸ªå…ƒç´ çš„æºä»£ç </p><ul><li>zskiplistNode</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* ZSETs æ‰€ä½¿ç”¨çš„ç‰¹æ®Šç‰ˆæœ¬çš„Skiplists *&#x2F;typedef struct zskiplistNode &#123;    &#x2F;&#x2F;å­—ç¬¦ä¸²ç±»å‹ele    sds ele;    &#x2F;&#x2F;ç”¨äºå­˜å‚¨æ’åºçš„åˆ†å€¼,æœ€åº•å±‚çš„åˆ—è¡¨å°±æ˜¯æ ¹æ®è¿™ä¸ªåˆ†å€¼è¿›è¡Œæ’åº    double score;    &#x2F;&#x2F;åé€€æŒ‡é’ˆ    struct zskiplistNode *backward;    &#x2F;&#x2F;å±‚ä¿¡æ¯æè¿°    struct zskiplistLevel &#123;        &#x2F;&#x2F;åŒå±‚ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ        struct zskiplistNode *forward;        &#x2F;&#x2F;åŒå±‚ä¸­çš„è·¨åº¦,ç”¨äºè®¡æ•°        unsigned long span;    &#125; level[];&#125; zskiplistNode;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>zskiplist</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">typedef struct zskiplist &#123;    &#x2F;&#x2F;åˆ†åˆ«æŒ‡å‘è·³è·ƒåˆ—è¡¨çš„å¤´ç»“ç‚¹æŒ‡é’ˆå’Œå°¾èŠ‚ç‚¹æŒ‡é’ˆ    struct zskiplistNode *header, *tail;    &#x2F;&#x2F;åˆ—è¡¨çš„é•¿åº¦    unsigned long length;    &#x2F;&#x2F;åˆ—è¡¨çš„é«˜åº¦    int level;&#125; zskiplist;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ“ä½œ-v2"><a class="header-anchor" href="#æ“ä½œ-v2"></a>æ“ä½œ</h3><ul><li>æŸ¥æ‰¾è¿‡ç¨‹</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* æŸ¥è¯¢åŒ…å«åœ¨æŒ‡å®šèŒƒå›´å†…çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåä¹‹è¿”å›null. *&#x2F;zskiplistNode *zslFirstInRange(zskiplist *zsl, zrangespec *range)&#123;    zskiplistNode *x;    int i;    &#x2F;* åˆ¤æ–­ä¼ å…¥èŒƒå›´è¶…è¿‡åˆ—è¡¨èŒƒå›´ *&#x2F;    if (!zslIsInRange(zsl, range))        return NULL;    x &#x3D; zsl-&gt;header;    &#x2F;&#x2F;ä»æœ€é«˜å±‚å‘ä¸‹æŸ¥æ‰¾    for (i &#x3D; zsl-&gt;level - 1; i &gt;&#x3D; 0; i--)    &#123;        &#x2F;* åœ¨åŒä¸€å±‚å†…ä»å·¦åˆ°å³ä¾æ¬¡æŸ¥æ‰¾ *&#x2F;        while (x-&gt;level[i].forward &amp;&amp; !zslValueGteMin(x-&gt;level[i].forward-&gt;score, range))            x &#x3D; x-&gt;level[i].forward;    &#125;    &#x2F;* ç›®æ ‡èŠ‚ç‚¹ä¸èƒ½æ˜¯æœ€åä¸€ä¸ª*tailèŠ‚ç‚¹ *&#x2F;    x &#x3D; x-&gt;level[0].forward;    serverAssert(x !&#x3D; NULL);    &#x2F;*å†æ¬¡æ£€æµ‹åˆ†æ•°é™åˆ¶ *&#x2F;    if (!zslValueLteMax(x-&gt;score, range))        return NULL;    return x;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆä»ä¸Šåˆ°ä¸‹ï¼Œå†ä»å·¦åˆ°å³çš„è¿›è¡ŒæŸ¥æ‰¾</p><ul><li>è·³è·ƒåˆ—è¡¨çš„å®é™…åº”ç”¨</li></ul><p>è·³è·ƒåˆ—è¡¨ä¸»è¦æ˜¯ä½œä¸º<B>zset</B>çš„ä¸€ç§åº•å±‚å®ç°,åœ¨æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶åzsetä¼šä½¿ç”¨<B>å‹ç¼©åˆ—è¡¨-ziplist</B>ä½œä¸ºåº•å±‚å®ç°</p><ol><li>æœ‰åºé›†åˆå…ƒç´ æ•°é‡å°äº128ä¸ªæ—¶</li><li>å…ƒç´ å¤§å°ä¸è¶…è¿‡64å­—èŠ‚æ—¶</li><li>é›†åˆå¤§å°æ“ä½œ1Gæ—¶<br>å¦‚æœä¸åŒæ—¶æ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶æ—¶,åˆ™ä½¿ç”¨<B>skipList-è·³è·ƒåˆ—è¡¨</B>ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„,è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯zsetåº•å±‚ç»“æ„è½¬æ¢æˆä¸ºskipListä»¥å,å°±ä¸ä¼šåœ¨è½¬æ¢æˆä¸ºziplist</li></ol><ul><li>zset</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">//å¦‚æœå½“å‰åˆ—è¡¨é•¿åº¦å¤§äº128ä¸ªæ—¶è¿›è¡Œè½¬åŒ–</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zzlLength</span><span class="token punctuation">(</span>zobj<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">></span> server<span class="token punctuation">.</span>zset_max_ziplist_entries <span class="token operator">||</span> <span class="token comment">//å¦‚æœå½“å‰åˆ—è¡¨æ ¼å¼å¤§äº64ä¸ªæ—¶è¿›è¡Œè½¬åŒ–</span>    <span class="token function">sdslen</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span> <span class="token operator">></span> server<span class="token punctuation">.</span>zset_max_ziplist_value <span class="token operator">||</span>  <span class="token comment">//å¦‚æœå½“å‰åˆ—è¡¨å¤§å°å¤§äº1Gæ—¶è¿›è¡Œè½¬åŒ–</span>    <span class="token operator">!</span><span class="token function">ziplistSafeToAdd</span><span class="token punctuation">(</span>zobj<span class="token operator">-></span>ptr<span class="token punctuation">,</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>      <span class="token comment">//è½¬æ¢ä¸ºskipç»“æ„</span>      <span class="token function">zsetConvert</span><span class="token punctuation">(</span>zobj<span class="token punctuation">,</span>OBJ_ENCODING_SKIPLIST<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//ç»§ç»­æ·»åŠ æ•°æ®</span>      zobj<span class="token operator">-></span>ptr <span class="token operator">=</span> <span class="token function">zzlInsert</span><span class="token punctuation">(</span>zobj<span class="token operator">-></span>ptr<span class="token punctuation">,</span>ele<span class="token punctuation">,</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newscore<span class="token punctuation">)</span> <span class="token operator">*</span>newscore <span class="token operator">=</span> score<span class="token punctuation">;</span>      <span class="token operator">*</span>out_flags <span class="token operator">|=</span> ZADD_OUT_ADDED<span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‹ç¼©åˆ—è¡¨"><a class="header-anchor" href="#å‹ç¼©åˆ—è¡¨"></a>å‹ç¼©åˆ—è¡¨</h2><blockquote><p>å‹ç¼©åˆ—è¡¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„,æ˜¯redisä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´è€Œè®¾è®¡çš„ç´§å‡‘æ€§æ•°æ®ç»“æ„,å¯ä»¥åŒ…å«å¤šä¸ªå…ƒç´ .å‹ç¼©åˆ—è¡¨å¯ä»¥ä½œä¸ºæœ‰åºé›†åˆ(zset)ã€æ•£åˆ—(hash)ã€åˆ—è¡¨(list)</p></blockquote><h3 id="æ•°æ®ç»“æ„-v3"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v3"></a>æ•°æ®ç»“æ„</h3><p><img src="https://s2.loli.net/2022/01/10/79cA85aCil3IzJf.png" alt="ziplistç»“æ„"></p><ul><li>zlbytesï¼šå‹ç¼©åˆ—è¡¨çš„å­—èŠ‚é•¿åº¦ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œå› æ­¤å‹ç¼©åˆ—è¡¨æœ€å¤šæœ‰232-1ä¸ªå­—èŠ‚</li><li>zltailï¼šå‹ç¼©åˆ—è¡¨å°¾å…ƒç´ ç›¸å¯¹äºå‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»é‡ï¼Œå 4ä¸ªå­—èŠ‚</li><li>zllenï¼šå‹ç¼©åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå 2ä¸ªå­—èŠ‚ã€‚zllenæ— æ³•å­˜å‚¨å…ƒç´ ä¸ªæ•°è¶…è¿‡65535ï¼ˆ216-1ï¼‰çš„å‹ç¼©åˆ—è¡¨ï¼Œå¿…é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è·å–åˆ°å…ƒç´ ä¸ªæ•°</li><li>entryXï¼šå‹ç¼©åˆ—è¡¨å­˜å‚¨çš„å…ƒç´ ï¼Œå¯ä»¥æ˜¯å­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°ï¼Œé•¿åº¦ä¸é™ã€‚entryçš„ç¼–ç ç»“æ„å°†åœ¨åé¢è¯¦ç»†ä»‹ç»</li><li>zlendï¼šå‹ç¼©åˆ—è¡¨çš„ç»“å°¾ï¼Œå 1ä¸ªå­—èŠ‚ï¼Œæ’ä¸º0xFF</li></ul><p>ä»¥ä¸‹æ˜¯åˆ›å»ºziplistçš„ä»£ç </p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* åˆ›å»ºä¸€ä¸ªç©ºç™½çš„ziplist *&#x2F;  unsigned char *ziplistNew(void) &#123;      &#x2F;&#x2F;ZIPLIST_HEADER_SIZE &#x3D; (sizeof(uint32_t)*2+sizeof(uint16_t))  + (sizeof(uint8_t))      &#x2F;&#x2F;8ä¸ªå­—èŠ‚ + 2ä¸ªå­—èŠ‚ + 1ä¸ªå­—èŠ‚      unsigned int bytes &#x3D; ZIPLIST_HEADER_SIZE+ZIPLIST_END_SIZE;      &#x2F;&#x2F;åˆ†é…å†…å­˜,è¿”å›åˆ—è¡¨æŒ‡é’ˆ      unsigned char *zl &#x3D; zmalloc(bytes);      &#x2F;&#x2F;å°è¯•å°†å¤§ç«¯æ•°æ®è½¬æ¢æˆå°ç«¯æ•°æ®      ZIPLIST_BYTES(zl) &#x3D; intrev32ifbe(bytes);      ZIPLIST_TAIL_OFFSET(zl) &#x3D; intrev32ifbe(ZIPLIST_HEADER_SIZE);      &#x2F;&#x2F;åˆå§‹åŒ–åˆ—è¡¨é•¿åº¦      ZIPLIST_LENGTH(zl) &#x3D; 0;      &#x2F;&#x2F;è®¾ç½®åˆ—è¡¨å°¾éƒ¨å­—ç¬¦ä¸ºhex_ff      zl[bytes-1] &#x3D; ZIP_END;      return zl;  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸‰ä¸ªæ­¥éª¤ä½¿ç”¨<B>intrev32ifbe()</B>å°è¯•å°†å¤§ç«¯æ•°æ®è½¬æ¢æˆä¸ºå°æ®µæ•°æ®;</p><p>å¤§å°ç«¯æ•°æ®å®šä¹‰</p><blockquote><p>å­—èŠ‚çš„æ’åˆ—æ–¹å¼æœ‰ä¸¤ä¸ªé€šç”¨è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªå¤šä½æ•°çš„ä½ä½æ”¾åœ¨è¾ƒå°çš„åœ°å€å¤„ï¼Œé«˜ä½æ”¾åœ¨è¾ƒå¤§çš„åœ°å€å¤„ï¼Œåˆ™ç§°å°ç«¯åºï¼›åä¹‹åˆ™ç§°å¤§ç«¯åºã€‚åœ¨ç½‘ç»œåº”ç”¨ä¸­ï¼Œå­—èŠ‚åºæ˜¯ä¸€ä¸ªå¿…é¡»è¢«è€ƒè™‘çš„å› ç´ ï¼Œå› ä¸ºä¸åŒæœºå™¨ç±»å‹å¯èƒ½é‡‡ç”¨ä¸åŒæ ‡å‡†çš„å­—èŠ‚åºï¼Œæ‰€ä»¥å‡æŒ‰ç…§ç½‘ç»œæ ‡å‡†è½¬åŒ–ã€‚<br>è¿™é‡Œrediså°½é‡é‡‡ç”¨å°ç«¯çš„åŸå› æ˜¯åœ¨äº<B>X86æ¶æ„</B>å’Œ<B>ARMæ¶æ„</B>æ˜¯é‡‡ç”¨çš„å°ç«¯æ¨¡å¼,ä½†æ˜¯ç½‘ç»œä¼ è¾“é‡‡ç”¨çš„æ˜¯å¤§ç«¯æ¨¡å¼.</p></blockquote><h3 id="Entryçš„å†…éƒ¨ç»“æ„"><a class="header-anchor" href="#Entryçš„å†…éƒ¨ç»“æ„"></a>Entryçš„å†…éƒ¨ç»“æ„</h3><p>entryçš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹:</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥æ¥æ”¶æœ‰å…³ ziplist æ¡ç›®çš„ä¿¡æ¯ã€‚   è¯·æ³¨æ„ï¼Œè¿™ä¸æ˜¯æ•°æ®çš„å®é™…ç¼–ç æ–¹å¼ï¼Œè¿™æ˜¯æˆ‘ä»¬  è¢«ä¸€ä¸ªå‡½æ•°å¡«å……ä»¥ä¾¿æ›´å®¹æ˜“æ“ä½œã€‚ *&#x2F;typedef struct zlentry &#123;    unsigned int prevrawlensize; &#x2F;* å¯¹prevrawlenç¼–ç åçš„å­—èŠ‚å¤§å°*&#x2F;    unsigned int prevrawlen;     &#x2F;* ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ *&#x2F;    unsigned int lensize;        &#x2F;* å¯¹lenç¼–ç åçš„é•¿åº¦*&#x2F;    unsigned int len;            &#x2F;* å½“å‰èŠ‚ç‚¹çš„é•¿åº¦ *&#x2F;    unsigned int headersize;     &#x2F;* prevrawlensize + lensize. *&#x2F;    unsigned char encoding;      &#x2F;* å½“å‰èŠ‚ç‚¹æ‰€ä½¿ç”¨çš„ç¼–ç ç±»å‹:ZIP_STR_* or ZIP_INT *&#x2F;    unsigned char *p;            &#x2F;* æŒ‡å‘åˆ—è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆ *&#x2F;&#125; zlentry;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ziplistä¸­éœ€è¦æ³¨æ„çš„æ˜¯â€™è¿é”æ›´æ–°â€™é—®é¢˜,ç”±äºziplistçš„ç»“æ„å¹¶ä¸æ˜¯é“¾è¡¨ç»“æ„è€Œæ˜¯è¿ç»­å†…å­˜ç»“æ„,å¯¼è‡´åœ¨åˆ é™¤ä¸Šä¸€ä¸ªå¤§èŠ‚ç‚¹æ—¶ä¼šå¯¼è‡´æ•°ç»„æ•´ä½“ç§»åŠ¨çš„é—®é¢˜</p><h2 id="å­—å…¸"><a class="header-anchor" href="#å­—å…¸"></a>å­—å…¸</h2><blockquote><p>å­—å…¸åˆç§°æ•£åˆ—è¡¨ï¼Œæ˜¯ç”¨æ¥å­˜å‚¨é”®å€¼ï¼ˆkey-valueï¼‰å¯¹çš„ä¸€ç§æ•°æ®ç»“æ„.</p></blockquote><h3 id="æ•°æ®ç»“æ„-v4"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v4"></a>æ•°æ®ç»“æ„</h3><p>Rediså­—å…¸å®ç°ä¾èµ–çš„æ•°æ®ç»“æ„ä¸»è¦åŒ…å«äº†ä¸‰éƒ¨åˆ†ï¼šå­—å…¸ã€Hashè¡¨ã€Hashè¡¨èŠ‚ç‚¹ã€‚å­—å…¸ä¸­åµŒå…¥äº†ä¸¤ä¸ªHashè¡¨ï¼ŒHashè¡¨ä¸­çš„tableå­—æ®µå­˜æ”¾ç€Hashè¡¨èŠ‚ç‚¹ï¼ŒHashè¡¨èŠ‚ç‚¹å¯¹åº”å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹ã€‚</p><p>ç»“æ„å¦‚ä¸‹:<br><img src="https://s2.loli.net/2022/01/16/sbcuXE1oLvhFzi9.jpg" alt="ç©ºHashè¡¨ç»“æ„ç¤ºæ„"></p><ul><li>dict</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;** hashç»“æ„ä½“* ä¼šåŒæ—¶ä½¿ç”¨ä¸¤ä¸ªhashç»“æ„ä½“,ä»¥ä¾¿å®ç°å¢é‡æ‰©å®¹*&#x2F;typedef struct dictht &#123;    &#x2F;&#x2F;æŒ‡é’ˆæ•°ç»„,ç”¨äºå­˜å‚¨é”®å€¼å¯¹    dictEntry **table;    &#x2F;&#x2F;tableæ•°ç»„çš„å¤§å°    unsigned long size;    &#x2F;&#x2F;æ©ç (size-1)    unsigned long sizemask;    &#x2F;&#x2F;å·²å­˜å‚¨çš„å…ƒç´ æ•°é‡    unsigned long used;&#125; dictht;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œç€é‡ä»‹ç»ä¸€ä¸‹æ©ç (sizemask)è¿™ä¸ªå­—æ®µ,sizemaskçš„è®¡ç®—æ–¹å¼ä¸ºå–(size-1)è¿™æ ·çš„å¥½å¤„æ˜¯é€šè¿‡<br><B>hash_key&amp;sizemask = hash_key/size</B><br>ä½æ“ä½œçš„æ€§èƒ½è¦é«˜äºå–ä½™æ“ä½œ</p><ul><li>dictEntry</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">typedef struct dictEntry &#123;    void *key;    union &#123;        void *val;        uint64_t u64;        int64_t s64;        double d;    &#125; v;    struct dictEntry *next;&#125; dictEntry;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>dictEntryæ˜¯hashçš„èŠ‚ç‚¹å…ƒç´ ç»“æ„,éœ€è¦æ³¨æ„çš„æ˜¯<B>V</B>æ˜¯ä¸€ç§è”åˆä½“ç»“æ„,æ ¹æ®ä½¿ç”¨åœºæ™¯ä½¿ç”¨ä¸åŒç±»å‹<br>*nextæ˜¯ç”¨æ¥è§£å†³hashå†²çªçš„,é‡‡ç”¨çš„æ˜¯å¤´æ’æ³•</p><ul><li>æ¸è¿›å¼ReHash</li></ul><ol><li>å½“æ‰§è¡Œæ’å…¥\åˆ é™¤\æŸ¥æ‰¾\ä¿®æ”¹æ—¶éƒ½ä¼šå…ˆåˆ¤æ–­å½“å‰å­—å…¸æ˜¯å¦åœ¨è¿›è¡Œrehash,ç„¶åå°è¯•è¿›è¡Œrehashåæ‰ä¼šæ‰§è¡Œæ“ä½œ</li><li>çº¿ç¨‹ç©ºé—²æ—¶ä¼šæ¯æ¬¡å¯¹100ä¸ªèŠ‚ç‚¹è¿›è¡Œrehash</li></ol><h3 id="æ“ä½œ-v3"><a class="header-anchor" href="#æ“ä½œ-v3"></a>æ“ä½œ</h3><ul><li>è¿­ä»£æ“ä½œ</li></ul><p>redisä¸­çš„æ•°æ®è¿­ä»£åˆ†ä¸ºä¸¤ç§ç±»å‹</p><ol><li>æ™®é€šè¿­ä»£å™¨<br>æ™®é€šè¿­ä»£å™¨åªä¼šéå†æ•°æ®</li><li>å®‰å…¨è¿­ä»£å™¨<br>å®‰å…¨è¿­ä»£å™¨,åœ¨éå†è¿‡ç¨‹ä¸­ä¼šåˆ é™¤æ•°æ®</li></ol><p>è¿™ä¸¤ç§è¿­ä»£å™¨å¯¹è¿­ä»£è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿé‡å¤æ•°æ®çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·</p><ol><li>æ™®é€šè¿­ä»£å™¨<br>æ™®é€šè¿­ä»£å™¨æ˜¯é€šè¿‡æ ‡å¿—ä½æ¥é™åˆ¶å­—å…¸ç»“æ„çš„å˜åŒ–</li><li>å®‰å…¨è¿­ä»£å™¨<br>å®‰å…¨è¿­ä»£å™¨æ˜¯é€šè¿‡é™åˆ¶rehashæ¥ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§</li></ol><h2 id="æ•´æ•°é›†åˆ"><a class="header-anchor" href="#æ•´æ•°é›†åˆ"></a>æ•´æ•°é›†åˆ</h2><p>redisä¸­çš„<B>æ•´æ•°é›†åˆ</B>æ˜¯ä½œä¸ºé›†åˆçš„åº•å±‚æ•°æ®ç»“æ„,ç”¨æ¥ä¿å­˜å°‘é‡çš„æ•°æ®å’Œæ•´æ•°å…ƒç´ ,ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æå®ƒçš„æ•°æ®ç»“æ„å’Œæ“ä½œ</p><h3 id="æ•°æ®ç»“æ„-v5"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v5"></a>æ•°æ®ç»“æ„</h3><ul><li>intset.h</li></ul><pre class="line-numbers language-h" data-language="h"><code class="language-h">&#x2F;*** æ•´æ•°é›†åˆç»“æ„ä½“*&#x2F;typedef struct intset &#123;    &#x2F;&#x2F;ç¼–ç æ ¼å¼    uint32_t encoding;    &#x2F;&#x2F;æ•°ç»„é•¿åº¦    uint32_t length;    &#x2F;&#x2F;å…ƒç´ æ•°ç»„    int8_t contents[];&#125; intset;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æ•´æ•°é›†åˆçš„ç»“æ„ä½“æ¯”è¾ƒç®€å•,åªæœ‰ç¼–ç æ ¼å¼/é•¿åº¦/æ•°æ®,è¿™ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ.ä¸‹é¢ç»§ç»­åˆ†æä¸€ä¸‹æ•´æ•°æ•°ç»„åˆ›å»ºçš„è¿‡ç¨‹</p><ul><li>intsetNew</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* åˆ›å»ºç©ºç™½çš„intset *&#x2F;intset *intsetNew(void) &#123;    &#x2F;&#x2F;é€šè¿‡zmallocåˆ†é…è¿ç»­å†…å­˜    intset *is &#x3D; zmalloc(sizeof(intset));    &#x2F;&#x2F;è®¾ç½®ç¼–ç     is-&gt;encoding &#x3D; intrev32ifbe(INTSET_ENC_INT16);    &#x2F;&#x2F;è®¾ç½®é•¿åº¦    is-&gt;length &#x3D; 0;    return is;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ“ä½œ-v4"><a class="header-anchor" href="#æ“ä½œ-v4"></a>æ“ä½œ</h3><p>æ“ä½œä¸»è¦åˆ†ææ·»åŠ å…ƒç´ (intsetAdd)å’Œåˆ é™¤å…ƒç´ ()è¿™ä¸¤ä¸ªæ“ä½œ</p><ul><li>intsetAdd</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* æ·»åŠ å…ƒç´  *&#x2F;intset *intsetAdd(intset *is, int64_t value, uint8_t *success) &#123;    &#x2F;&#x2F;1. è®¡ç®—valueçš„ç¼–ç æ ¼å¼    uint8_t valenc &#x3D; _intsetValueEncoding(value);    uint32_t pos;    if (success) *success &#x3D; 1;    &#x2F;*    *åˆ¤æ–­å³å°†æ·»åŠ çš„å…ƒç´ æ˜¯å¦éœ€è¦ä¿®æ”¹intsetä¿®æ”¹ç¼–ç æ‰èƒ½æ·»åŠ     *&#x2F;    if (valenc &gt; intrev32ifbe(is-&gt;encoding)) &#123;        &#x2F;* è¿™ä¸ªæ“ä½œé»˜è®¤éƒ½æ˜¯æˆåŠŸçš„ *&#x2F;        return intsetUpgradeAndAdd(is, value);    &#125; else &#123;        &#x2F;&#x2F;åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­,å¦‚æœæœ‰åˆ™è¿”å›å¤±è´¥        &#x2F;&#x2F;*pos        if (intsetSearch(is, value, &amp;pos)) &#123;            if (success) *success &#x3D; 0;            return is;        &#125;        &#x2F;&#x2F;åˆ¤æ–­å½“å‰æ·»åŠ å…ƒç´ åæ˜¯å¦éœ€è¦æ‰©å®¹        is &#x3D; intsetResize(is, intrev32ifbe(is-&gt;length) + 1);        &#x2F;&#x2F;poså¦‚æœåœ¨å½“å‰æ•°ç»„ä¸­,éœ€è¦å¯¹å…ƒç´ è¿›è¡Œç§»ä½æ“ä½œ        if (pos &lt; intrev32ifbe(is-&gt;length)) intsetMoveTail(is, pos, pos + 1);    &#125;    &#x2F;&#x2F;å‘posçš„ä½ç½®ä¸Šæ’å…¥å…ƒç´ value    _intsetSet(is, pos, value);    &#x2F;&#x2F;è®¾ç½®length    is-&gt;length &#x3D; intrev32ifbe(intrev32ifbe(is-&gt;length) + 1);    return is;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ·»åŠ å…ƒç´ æ˜¯é€šè¿‡*posæŒ‡é’ˆæ¥è¿›è¡Œç¡®å®šä½ç½®çš„,å…ˆè·å–å¯ä»¥æ’å…¥çš„ä½ç½®,åœ¨å°†å…ƒç´ æ’åˆ°æŒ‡å®šçš„ä½ç½®ä¸Š,æœ€ååœ¨è¿›è¡Œä½ç§»æ“ä½œ</p><ul><li>intsetRemove</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* åˆ é™¤å…ƒç´  *&#x2F;intset *intsetRemove(intset *is, int64_t value, int *success) &#123;    &#x2F;&#x2F;åˆ¤æ–­å…ƒç´ ç¼–ç     uint8_t valenc &#x3D; _intsetValueEncoding(value);    uint32_t pos;    if (success) *success &#x3D; 0;    &#x2F;&#x2F;æŸ¥æ‰¾å…ƒç´ ä½ç½®    if (valenc &lt;&#x3D; intrev32ifbe(is-&gt;encoding) &amp;&amp; intsetSearch(is, value, &amp;pos)) &#123;        uint32_t len &#x3D; intrev32ifbe(is-&gt;length);        &#x2F;* We know we can delete *&#x2F;        if (success) *success &#x3D; 1;        &#x2F;*ä½¿ç”¨ä½ç§»æ“ä½œè¦†ç›–å…ƒç´ *&#x2F;        if (pos &lt; (len - 1)) intsetMoveTail(is, pos + 1, pos);        &#x2F;&#x2F;é‡æ–°è®¾ç½®æ•°ç»„é•¿åº¦        is &#x3D; intsetResize(is, len - 1);        is-&gt;length &#x3D; intrev32ifbe(len - 1);    &#125;    return is;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆæŸ¥æ‰¾å…ƒç´ ,åœ¨æ ¹æ®å…ƒç´ çš„ä½ç½®è¿›è¡Œç§»ä½æ“ä½œ.<br>ä»<B>intsetAdd</B>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°æ•´æ•°é›†åˆä¸­çš„æ•°æ®æ˜¯ä¸å…è®¸é‡å¤çš„,æ˜¯æœ‰åºçš„æ•°ç»„ç»„æˆ.</p><h2 id="quicklist"><a class="header-anchor" href="#quicklist"></a>quicklist</h2><p>quicklistæ˜¯ä¸ºä¼˜åŒ–å¤„ç†<B>List</B>çš„åº•å±‚å­˜å‚¨ç»“æ„ziplistå’Œadlistè€Œæ¥,å…³äºListçš„å®šä¹‰è¿™ä¸ªæè¿°çš„æ¯”è¾ƒå¥½</p><blockquote><p>é“¾è¡¨æ˜¯è¿™æ ·ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¶ä¸­çš„å„å¯¹è±¡æŒ‰çº¿æ€§é¡ºåºæ’åˆ—ã€‚é“¾è¡¨ä¸æ•°ç»„çš„ä¸åŒç‚¹åœ¨äºï¼Œæ•°ç»„çš„é¡ºåºç”±ä¸‹æ ‡å†³å®šï¼Œé“¾è¡¨çš„é¡ºåºç”±å¯¹è±¡ä¸­çš„æŒ‡é’ˆå†³å®šã€‚</p></blockquote><p>å…³äºquicklistçš„å®šä¹‰å¦‚ä¸‹</p><blockquote><p>Redisä¸­å¯¹quciklistçš„æ³¨é‡Šä¸ºA doubly linked list of ziplistsã€‚quicklistæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªziplistç»“æ„ã€‚quicklistå¯ä»¥çœ‹æˆæ˜¯ç”¨åŒå‘é“¾è¡¨å°†è‹¥å¹²å°å‹çš„ziplistè¿æ¥åˆ°ä¸€èµ·ç»„æˆçš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</p></blockquote><h3 id="æ•°æ®ç»“æ„-v6"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v6"></a>æ•°æ®ç»“æ„</h3><ul><li>quicklist</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;*** quickListç»“æ„ä½“* å¤§å°ä¸º40å­—èŠ‚*&#x2F;typedef struct quicklist &#123;    &#x2F;&#x2F;é¦–å°¾èŠ‚ç‚¹    quicklistNode *head;    quicklistNode *tail;    &#x2F;&#x2F;æ€»æ¡æ•°    unsigned long count;    &#x2F;&#x2F;èŠ‚ç‚¹æ•°é‡    unsigned long len;    &#x2F;&#x2F;å•ä¸ªèŠ‚ç‚¹çš„å¡«å……å› å­    int fill : QL_FILL_BITS;    &#x2F;&#x2F;ä¸åŒèŠ‚ç‚¹çš„æ·±åº¦    unsigned int compress : QL_COMP_BITS;    unsigned int bookmark_count: QL_BM_BITS;    &#x2F;&#x2F;ä¹¦ç­¾åˆ—è¡¨(ç”¨äºå¿«é€ŸæŸ¥æ‰¾èŠ‚ç‚¹ä½¿ç”¨)    quicklistBookmark bookmarks[];&#125; quicklist;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºè¶…å¤§å‹åˆ—è¡¨ä¼šé‡‡ç”¨åˆ—è¡¨å°¾éƒ¨ä½¿ç”¨ä¹¦ç­¾è¿™ç§æ•°æ®ç»“æ„æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾</p><ul><li>quicklistBookmark</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">typedef struct quicklistBookmark &#123;    quicklistNode *node;    char *name;&#125; quicklistBookmark;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥ä»quicklist/quicklistBookmarkçš„ç»“æ„ä½“ä¸­çœ‹åˆ°<B>quicklistNode</B>æ˜¯åº•å±‚å…ƒç´ å­˜å‚¨èŠ‚ç‚¹çš„ç»“æ„ä½“</p><ul><li>quicklistNode</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;*** quicklistNode æ˜¯ä¸€ä¸ª 32 å­—èŠ‚çš„ç»“æ„ï¼Œç”¨äºæè¿°ä¸€ä¸ªå¿«é€Ÿåˆ—è¡¨çš„ziplistã€‚* æˆ‘ä»¬ä½¿ç”¨sz(ä½åŸŸ)å°† quicklistNode ä¿æŒåœ¨ 32 å­—èŠ‚ã€‚* count: 16ä½ï¼Œæœ€å¤§ 65536ï¼ˆæœ€å¤§ zl å­—èŠ‚ä¸º 65kï¼Œå› æ­¤æœ€å¤§è®¡æ•°å®é™…ä¸Š &lt; 32kï¼‰ã€‚* encoding: 2ä½ï¼ŒRAW&#x3D;1ï¼ŒLZF&#x3D;2ã€‚* container: 2 ä½ï¼ŒNONE&#x3D;1ï¼ŒZIPLIST&#x3D;2ã€‚* recompress: 1 ä½ï¼Œå¸ƒå°”å€¼ï¼Œå¦‚æœèŠ‚ç‚¹ä¸´æ—¶è§£å‹ç¼©ä»¥ä¾›ä½¿ç”¨ï¼Œåˆ™ä¸º trueã€‚* attempted_compress: 1 ä½ï¼Œå¸ƒå°”å€¼ï¼Œç”¨äºæµ‹è¯•æœŸé—´çš„éªŒè¯ã€‚* extra: 10 ä½ï¼Œå…è´¹ä¾›ä»¥åä½¿ç”¨ï¼› å¡«å……å‰©ä½™çš„ 32 ä½*&#x2F;typedef struct quicklistNode &#123;    struct quicklistNode *prev;    struct quicklistNode *next;    unsigned char *zl;    unsigned int sz;             &#x2F;* ziplist size in bytes *&#x2F;    unsigned int count : 16;     &#x2F;* count of items in ziplist *&#x2F;    unsigned int encoding : 2;   &#x2F;* RAW&#x3D;&#x3D;1 or LZF&#x3D;&#x3D;2 *&#x2F;    unsigned int container : 2;  &#x2F;* NONE&#x3D;&#x3D;1 or ZIPLIST&#x3D;&#x3D;2 *&#x2F;    unsigned int recompress : 1; &#x2F;* was this node previous compressed? *&#x2F;    unsigned int attempted_compress : 1; &#x2F;* node can&#39;t compress; too small *&#x2F;    unsigned int extra : 10; &#x2F;* more bits to steal for future usage *&#x2F;&#125; quicklistNode;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£æquicklistNode:</p><ol><li>ç»“æ„ä¸Šäºziplistä¸ç›¸åŒ,é‡‡ç”¨çš„æ˜¯åˆ—è¡¨æ ¼å¼è®°å½•æ•°æ®</li><li>å•ä¸ªnodeæœ€å¤§é“¾è¡¨æ•°é‡ä¸æ“ä½œ32K</li><li>encoding:LZFè¿›è¡Œå‹ç¼©ç¼–ç </li></ol><p>æ€»ç»“:<br>redisåº•å±‚æ•°æ®æ ¼å¼åˆ†ä¸ºå…­ç§</p><ul><li><p>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²<br>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²(SDS),é€»è¾‘ä¸Šæ˜¯å¯¹*charæŒ‡é’ˆçš„æ‰©å±•,ç»“æ„ä¸Šæ ¹æ®ä¸åŒçš„é•¿åº¦å¯ä»¥åˆ†ä¸ºå¤šç§ç±»å‹,ä½¿ç”¨æƒ°æ€§åˆ é™¤æœºåˆ¶</p></li><li><p>è·³è·ƒåˆ—è¡¨<br>è·³è·ƒåˆ—è¡¨(skipList)ç»“æ„ä¸ŠzskiplistNode/zskiplist,zsetåœ¨æ»¡è¶³ä»»æ„æ¡ä»¶(å…ƒç´ ä¸ªæ•°è¶…è¿‡128/å…ƒç´ å¤§å°å¤§äº64å­—èŠ‚/ziplistå¤§å°è¶…è¿‡1G)åä½¿ç”¨skipä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ä¸”ä¸ä¼šå›é€€</p></li><li><p>å‹ç¼©åˆ—è¡¨<br>å‹ç¼©åˆ—è¡¨(ziplist)ç»“æ„ä¸Šåˆ†ä¸º*ziplist/entry,éœ€è¦æ³¨æ„çš„æ˜¯ziplistæ˜¯è¿ç»­çš„å†…å­˜èŠ‚ç‚¹ç»„æˆ,å¹¶ä¸”entryä¸Šè¿˜æœ‰ä¸Šä¸€èŠ‚ç‚¹çš„ä¿¡æ¯</p></li><li><p>å­—å…¸<br>å­—å…¸(dict)ç»“æ„æ˜¯é€šè¿‡hashç»“æ„æ¥ç»„æˆ,ç‰¹ç‚¹æ˜¯é‡‡ç”¨ä½è¿ç®—ä¸æ¥å–ä½™æ•°,å¹¶ä¸”é‡‡ç”¨ä¸¤ä¸ªhashæ¥å®ç°æ¸è¿›å¼Rehash,æ˜¯é€šè¿‡æ‡’å¤„ç†å’Œçº¿ç¨‹ç©ºé—²æ—¶å¤„ç†çš„æ–¹å¼æ¥å®Œæˆ</p></li><li><p>æ•´æ•°é›†åˆ<br>æ•´æ•°é›†åˆç»“æ„æ˜¯è¿ç»­çš„å†…å­˜,æ¯æ¬¡æ·»åŠ å‰éƒ½è¦å…ˆè®¡ç®—ç¼–ç é•¿åº¦å’Œæ’å…¥ä½ç½®ä»¥ä¾¿è¿›è¡Œæ‰©å®¹</p></li><li><p>quicklist<br>quicklistæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„,æ¯ä¸ªèŠ‚ç‚¹åˆæ˜¯ziplistç»„æˆ</p></li><li><p>stream<br>çœç•¥,è¯¦è§src/stream.hæ–‡ä»¶</p></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://redis.io/topics/internals-sds">Hacking Strings</a><br><a href="http://www.itabin.com/redis-zskiplist/">zskiplist</a><br><a href="https://www.geek-share.com/detail/2714589322.html">redisdæºä»£ç çš„å¤§ç«¯ä¸å°ç«¯</a><br><a href="https://cache.one/read/2884987">rediså‹ç¼©åˆ—è¡¨ziplistçš„è¿é”æ‰©å®¹</a><br><a href="https://redisbook.readthedocs.io/en/latest/compress-datastruct/intset.html">æ•´æ•°é›†åˆ</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£linuxå†…æ ¸ç¬”è®°</title>
      <link href="2021/12/08/1.%E6%9D%82%E8%AE%B0/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E5%86%85%E6%A0%B8%E7%AC%94%E8%AE%B0/"/>
      <url>2021/12/08/1.%E6%9D%82%E8%AE%B0/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E5%86%85%E6%A0%B8%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥ç†è§£linuxå†…æ ¸ç¬”è®°</h1><h2 id="å†…æ ¸"><a class="header-anchor" href="#å†…æ ¸"></a>å†…æ ¸</h2><p>unixå†…æ ¸æ ¹æ®æ‰§è¡ŒçŠ¶æ€åˆ†ä¸ºâ€™ç”¨æˆ·æ€â€™å’Œâ€™æ‰§è¡Œæ€â€™</p><ul><li>ç”¨æˆ·ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li></ul><ol><li>è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</li><li>è§¦å‘å¼‚å¸¸(exception)</li><li>å“åº”ä¸­æ–­</li><li>å†…æ ¸çº¿ç¨‹çš„æ‰§è¡Œ(è¿™é‡Œæœ‰ä¸€äº›æ­§ä¹‰,æœ¬èº«å°±æ˜¯å†…æ ¸æ€)</li></ol><ul><li>è¿›ç¨‹æè¿°ç¬¦</li></ul><p>è¿›ç¨‹æè¿°ç¬¦æ˜¯ç”¨æ¥æè¿°å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯,åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†<br>- ç¨‹åºè®¡æ•°å™¨å’Œæ ˆæŒ‡é’ˆ<br>- é€šç”¨å¯„å­˜å™¨<br>- æµ®ç‚¹å¯„å­˜å™¨<br>- å†…å­˜ç®¡ç†å¯„å­˜å™¨</p><ul><li>å¯é‡å…¥å†…æ ¸</li></ul><p>unixæ˜¯å¯é‡å…¥å†…æ ¸,æ„å‘³ç€åŒæ—¶æœ‰è‹¥å¹²ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œ,åœ¨æŠ¢å å¼å†…æ ¸è°ƒåº¦ç³»ç»Ÿä¸­è¿›ç¨‹ä¼šäº¤æ›¿æ‰§è¡Œ</p><ul><li><p>åƒµå°¸è¿›ç¨‹<br>åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿæ˜¯ç”±çˆ¶è¿›ç¨‹é€šè¿‡â€™wait4()'çš„ç³»ç»Ÿè°ƒç”¨ç­‰å¾…å­è¿›ç¨‹çš„ç»“æŸçš„çŠ¶æ€,</p></li><li><p>è¿›ç¨‹ç»„ä¸ä¼šè¯<br>è¿›ç¨‹ç»„æ˜¯å¯¹ä¸€ç§&quot;ä½œä¸š&quot;çš„æŠ½è±¡<br>ç™»å½•ä¼šè¯æŒ‡çš„æ˜¯</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥å‰–æKubernetesä¹‹ç¼–æ’èƒ½åŠ›</title>
      <link href="2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/3.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E7%BC%96%E6%8E%92%E8%83%BD%E5%8A%9B/"/>
      <url>2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/3.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E7%BC%96%E6%8E%92%E8%83%BD%E5%8A%9B/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹ç¼–æ’èƒ½åŠ›</h1><ul><li>åè¯è§£é‡Š</li></ul><blockquote><p>ç¼–æ’: å¼•ç”³ä¸ºæè¿°å¤æ‚è®¡ç®—æœºç³»ç»Ÿã€ä¸­é—´ä»¶ (middleware) å’Œä¸šåŠ¡çš„è‡ªåŠ¨åŒ–çš„å®‰æ’ã€åè°ƒå’Œç®¡ç†ã€‚</p></blockquote><h2 id="ç¼–æ’èƒ½åŠ›"><a class="header-anchor" href="#ç¼–æ’èƒ½åŠ›"></a>ç¼–æ’èƒ½åŠ›</h2><ul><li><p>ä¸ºä»€ä¹ˆéœ€è¦ç¼–æ’èƒ½åŠ›?<br>åœ¨åº”ç”¨å¤§è§„æ¨¡çš„æ‹†åˆ†å®æ–½å¾®æœåŠ¡åŒ–ä»¥å,éœ€è¦è§£å†³å¾®æœåŠ¡ä¹‹é—´çš„æœåŠ¡ä¾èµ–/æ³¨å†Œå‘ç°/èµ„æºç®¡ç†ç­‰é—®é¢˜.</p></li><li><p>ç¼–æ’èƒ½åŠ›éœ€è¦é‚£ä¸€å±‚æ¥å®ç°?<br>ä¹‹æ‰€ä»¥éœ€è¦æå‡ºè¿™ä¸ªé—®é¢˜æ˜¯å› ä¸º,ç›®å‰åº”ç”¨çš„æŒ‰å±‚åˆ’åˆ†,å¯ä»¥åœ¨æ¯ä¸€å±‚éƒ½å®ç°ç›¸åŒçš„èƒ½åŠ›,ä½†æ˜¯ä¸ºä»€ä¹ˆç›®å‰ä¸»æµçš„è§£å†³ç¼–æ’é—®é¢˜æ˜¯åœ¨åŸºç¡€è®¾æ–½å±‚è§£å†³,ä¸»è¦æ˜¯ä¾æ®è´£ä»»çš„åˆ’åˆ†,åŸºç¡€èƒ½åŠ›çš„ä¸‹æ²‰</p></li></ul><h2 id="ç¼–æ’å¯¹è±¡"><a class="header-anchor" href="#ç¼–æ’å¯¹è±¡"></a>ç¼–æ’å¯¹è±¡</h2><ul><li><p>èµ„æºç¼–æ’<br>èµ„æºç¼–æ’æŒ‡çš„æ˜¯å¯¹å…·ä½“å®¹å™¨çš„NameSpace\Cgroup\ç½‘ç»œçš„ç®¡ç†,æ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†ç­‰</p></li><li><p>å·¥ä½œè´Ÿè½½ç¼–æ’<br>å·¥ä½œè´Ÿè½½ç¼–æ’æŒ‡çš„æ˜¯å¯¹podç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</p></li><li><p>æœåŠ¡ç¼–æ’<br>æœåŠ¡ç¼–æ’æ˜¯åº”ç”¨å¼€å‘äººå‘˜æ¯”è¾ƒç†Ÿæ‚‰çš„ä¸€ä¸ªé¢†åŸŸ,æŒ‡çš„æ˜¯å¯¹å…·ä½“çš„æœåŠ¡çš„æœåŠ¡å‘ç°/é«˜å¯ç”¨çš„ç®¡ç†</p></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://zhuanlan.zhihu.com/p/36062500">ç¼–æ’çš„è‰ºæœ¯| K8S ä¸­çš„å®¹å™¨ç¼–æ’å’Œåº”ç”¨ç¼–æ’</a><br><a href="https://zhuanlan.zhihu.com/p/144452103">äº‘åŸç”Ÿæ—¶ä»£ï¼ˆäº”ï¼‰ï¼šKubernetesä¸å®¹å™¨ç¼–æ’ä¹‹æˆ˜</a></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥å‰–æKubernetesä¹‹Podsçš„æ¦‚å¿µ</title>
      <link href="2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/2.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BPod%E7%9A%84%E6%A6%82%E5%BF%B5/"/>
      <url>2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/2.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BPod%E7%9A%84%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹Podsçš„æ¦‚å¿µ</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­äº†è§£åˆ°kubernetesçš„éƒ¨ç½²åœ¨é€»è¾‘ä¸Šæ˜¯æŒ‰ç…§<B>Pod</B>çš„æ¦‚å¿µè¿›è¡Œçš„,ä¸‹é¢æ¥è¯¦ç»†çš„äº†è§£ä¸€ä¸‹podçš„çŸ¥è¯†</p><h2 id="åŸºç¡€æ¦‚å¿µ"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><blockquote><p>Podsæ˜¯æ‚¨å¯ä»¥åœ¨ Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„æœ€å°çš„å¯éƒ¨ç½²è®¡ç®—å•å…ƒã€‚Podsæ˜¯ä¸€ç»„ç”±ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Šçš„å®¹å™¨ç»„æˆçš„å…±äº«å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œä»¥åŠå¦‚ä½•è¿è¡Œå®¹å™¨çš„è§„èŒƒã€‚Pod çš„å†…å®¹å§‹ç»ˆä½äºåŒä¸€åœ°ç‚¹å¹¶å…±åŒè°ƒåº¦ï¼Œå¹¶åœ¨å…±äº«ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚Pod ä¸ºç‰¹å®šäºåº”ç”¨ç¨‹åºçš„â€œé€»è¾‘ä¸»æœºâ€å»ºæ¨¡ï¼šå®ƒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å¯¹ç´§å¯†è€¦åˆçš„åº”ç”¨ç¨‹åºå®¹å™¨ã€‚åœ¨éäº‘ç¯å¢ƒä¸­ï¼Œåœ¨åŒä¸€ç‰©ç†æˆ–è™šæ‹Ÿæœºä¸Šæ‰§è¡Œçš„åº”ç”¨ç¨‹åºç±»ä¼¼äºåœ¨åŒä¸€é€»è¾‘ä¸»æœºä¸Šæ‰§è¡Œçš„äº‘åº”ç”¨ç¨‹åºã€‚</p></blockquote><p>Podsçš„å®˜ç½‘å®šä¹‰,è¿™ä¸ªå®šä¹‰ä¼ è¾¾å‡ºä¸‰ä¸ªè§„èŒƒ:</p><ol><li>Podsæ˜¯Kubernetesç®¡ç†æ‰§è¡Œçš„æœ€å°å•å…ƒ</li><li>Podsæ˜¯å®¹å™¨ç»„æˆ,å¹¶ä¸”å®¹å™¨å†…éƒ¨å¯ä»¥å…±äº«ç½‘ç»œå’Œå­˜å‚¨</li><li>Podsæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µ,æ›¿kuberneteså®Œæˆåº•å±‚æ“ä½œçš„è¿˜æ˜¯å®¹å™¨ä¸‰å‰‘å®¢â€™Namespaceâ€™ã€â€˜Cgroupâ€™ã€â€˜rootFsâ€™</li></ol><h2 id="Podsç»„æˆ"><a class="header-anchor" href="#Podsç»„æˆ"></a>Podsç»„æˆ</h2><p>Podsçš„ç»„æˆå¯ä»¥å‚è€ƒè¿™å¼ å›¾:<br><img src="https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg" alt="Podsç»„æˆ"></p><p>Podsé™¤äº†æœ¬èº«çš„å®¹å™¨â€™ContainerA/ContainerBâ€™ä»¥å¤–è¿˜æœ‰ä¸€ä¸ª<B>Infra container</B>å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨çš„é•œåƒå¾ˆå°è§£å‹åä¹Ÿåªæœ‰100kb~200kbå¤§å°ã€‚</p><ul><li><p>Initå®¹å™¨<br>initå®¹å™¨æ˜¯åœ¨ç”¨æˆ·å®¹å™¨å¯åŠ¨ä¹‹å‰-ç½‘ç»œå’Œæ•°æ®å·åˆå§‹åŒ–å®Œæˆåå¯åŠ¨<br>ç”¨äºä»£ç†ç”¨æˆ·å®¹å™¨çš„ç½‘ç»œå’ŒIO,å…¶å®å°±æ˜¯Sidecaræ¨¡å¼</p></li><li><p>ç”¨æˆ·å®¹å™¨<br>ç”¨æˆ·å®¹å™¨æ˜¯â€™Web Serverâ€™ä¹Ÿå°±æ˜¯åœ¨YMLä¸­å®šä¹‰çš„å®¹å™¨</p></li></ul><h2 id="PodsåŠŸèƒ½"><a class="header-anchor" href="#PodsåŠŸèƒ½"></a>PodsåŠŸèƒ½</h2><ul><li><p>volume</p><p>volumeæ•°æ®å·å…¶ä¸­æœ‰ä¸€ç§ç‰¹æ®Šçš„volume-&gt;â€˜Projected Volumeâ€™(æŠ•å°„æ•°æ®å·)ä¸»è¦æ˜¯ç”¨æ¥å‘å®¹å™¨å†…éƒ¨æä¾›é¢„å…ˆå®šä¹‰å¥½çš„æ•°æ®ï¼Œå¯ä»¥åˆ’åˆ†ä¸º</p><ol><li>Secret</li><li>ConfigMao</li><li>DownwardApi</li><li>ServiceAccountToken</li></ol><p>è¿™å‡ ç§ç±»å‹ï¼Œå…¶ä¸­SecretæŒ‡çš„æ˜¯å°†é…ç½®æ·»åŠ åˆ°kubernetesä¸­é•œåƒç®¡ç†çš„æ•°æ®ï¼Œåœ¨é€šè¿‡Podsçš„YMALæ–‡ä»¶çš„å®šä¹‰å¯ä»¥å°†è¿™éƒ¨åˆ†é…ç½®ä¿¡æ¯ç›´æ¥å†™å…¥å®¹å™¨ä¸­ï¼Œå¹¶ä¸”å¯ä»¥éšç€Kubernetesä¸­å†…å®¹çš„å˜åŒ–è€Œå˜åŒ–ï¼Œç±»ä¼¼ä¸é…ç½®ä¸­å¿ƒçš„ä½¿ç”¨</p></li><li><p>å¼‚å¸¸æ¢å¤ç­–ç•¥</p><p>Podsçš„å¼‚å¸¸æ¢å¤ç­–ç•¥å¯ä»¥åˆ†ä¸º:</p><ol><li>åªè¦å®¹å™¨æ²¡æœ‰è¿è¡Œå°±è¿›è¡Œè‡ªåŠ¨é‡å¯</li><li>åªæœ‰åœ¨å®¹å™¨å¼‚å¸¸æ—¶æ‰è¿›è¡Œchongq</li><li>æ°¸ä¸è‡ªåŠ¨é‡å¯å®¹å™¨</li></ol><p>æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œçš„æ–¹æ³•æœ‰:</p><ol><li>å“åº”å¤–éƒ¨è¯·æ±‚ï¼Œä¾‹å¦‚httpè¯·æ±‚</li><li>å¤–éƒ¨æ£€æŸ¥é¢„è®¾çš„å¯åŠ¨åçš„é’©å­æ–¹æ³•ï¼Œä¾‹å¦‚æ£€æŸ¥æ–‡ä»¶å·å®—é¢„è®¾çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ç­‰</li></ol><p>å®ç°å¯¹å®¹å™¨è¿›è¡Œå®šæœŸè¯Šæ–­çš„åŠŸèƒ½å«â€™å®¹å™¨æ¢é’ˆâ€™ï¼Œç”±å®¹å™¨å†…éƒ¨è¿›è¡Œå®ç°ã€‚åˆ†ä¸ºä¸‰ç§ç±»å‹</p><ol><li>ExecAction</li><li>TCPSocketAction</li><li>HTTPGetAction</li></ol><p>å®¹å™¨æ¢é’ˆåˆåˆ†ä¸ºï¼š</p><ol><li>å­˜æ´»æ¢é’ˆ<br>å­˜æ´»æ¢é’ˆæŒ‡çš„æ˜¯è¦ç¡®è®¤ä¸€ä¸ªå®¹å™¨æ˜¯å¦çœŸæ­£çš„æ­»äº¡çš„åœºæ™¯ï¼Œä¾‹å¦‚é‡å¯æ—¶æ£€æµ‹ä¹‹å‰çš„å¤±è´¥å®¹å™¨æ˜¯å¦å·²ç»æ­»äº¡</li><li>å°±ç»ªæ¢é’ˆ<br>å°±ç»ªæ¢é’ˆæŒ‡çš„æ˜¯åŒºåˆ†åº”ç”¨æ˜¯å¦å‡†å¤‡å°±ç»ªçš„åœºæ™¯</li><li>å¯åŠ¨æ¢é’ˆ<br>å¯åŠ¨æ¢é’ˆæŒ‡çš„æ˜¯å¯¹äºå¤§å‹å®¹å™¨çš„å¯åŠ¨æ¯”è¾ƒæ…¢çš„åœºæ™¯éœ€è¦åŒºåˆ†å®¹å™¨æ˜¯å¦è¿˜åœ¨å¯åŠ¨</li></ol></li></ul><h2 id="Podsç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#Podsç”Ÿå‘½å‘¨æœŸ"></a>Podsç”Ÿå‘½å‘¨æœŸ</h2><p>Podçš„é˜¶æ®µåˆ†ä¸º</p><table><thead><tr><th>å–å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>Pendingï¼ˆæ‚¬å†³ï¼‰</td><td>Pod å·²è¢« Kubernetes ç³»ç»Ÿæ¥å—ï¼Œä½†æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨å°šæœªåˆ›å»ºäº¦æœªè¿è¡Œã€‚æ­¤é˜¶æ®µåŒ…æ‹¬ç­‰å¾… Pod è¢«è°ƒåº¦çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´ï¼Œ</td></tr><tr><td>Runningï¼ˆè¿è¡Œä¸­ï¼‰</td><td>Pod å·²ç»ç»‘å®šåˆ°äº†æŸä¸ªèŠ‚ç‚¹ï¼ŒPod ä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å·²è¢«åˆ›å»ºã€‚è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€ã€‚</td></tr><tr><td>Succeededï¼ˆæˆåŠŸï¼‰</td><td>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯ã€‚</td></tr><tr><td>Failedï¼ˆå¤±è´¥ï¼‰</td><td>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨ä»¥é 0 çŠ¶æ€é€€å‡ºæˆ–è€…è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</td></tr><tr><td>Unknownï¼ˆæœªçŸ¥ï¼‰</td><td>å› ä¸ºæŸäº›åŸå› æ— æ³•å–å¾— Pod çš„çŠ¶æ€ã€‚è¿™ç§æƒ…å†µé€šå¸¸æ˜¯å› ä¸ºä¸ Pod æ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥ã€‚</td></tr></tbody></table><h2 id="Podçš„ä¸Šå±‚æŠ½è±¡-Service"><a class="header-anchor" href="#Podçš„ä¸Šå±‚æŠ½è±¡-Service"></a>Podçš„ä¸Šå±‚æŠ½è±¡:Service</h2><p>è¿™é‡Œå…ˆç®€å•çš„ä»‹ç»ä»¥ä¸‹Serviceï¼Œkubernetesä¸­Serviceæ˜¯å°†ä¸€ç»„Podæš´éœ²ç»™å¤–ç•Œçš„ä¸€ç§æ–¹å¼ã€‚å¯¹å¤–æä¾›ä¸¤ç§è®¿é—®æ–¹å¼</p><ol><li><p>VIP<br>é€šè¿‡å¯¹å¤–æä¾›Serviceçš„è™šæ‹ŸIP,ç„¶ååœ¨å°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„Podä¸Šã€‚</p></li><li><p>DNS<br>- Normal Service<br>ä¸VIPæ–¹å¼ç±»ä¼¼<br>- Headles Service<br>å¯¹äºè¯·æ±‚ç›´æ¥è¿”å›å…·ä½“Podçš„IPã€‚ç±»ä¼¼äºDNSç›´æ¥è§£æå‡ºçœŸå®Podçš„IP</p></li></ol><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/">podæ˜¯ä»€ä¹ˆ?</a><br><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase">podçš„ç”Ÿå‘½å‘¨æœŸ</a></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ-åŸºç¡€ç¯‡</title>
      <link href="2021/11/09/19.%E5%88%86%E5%B8%83%E5%BC%8F/0.%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F-%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
      <url>2021/11/09/19.%E5%88%86%E5%B8%83%E5%BC%8F/0.%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F-%E5%9F%BA%E7%A1%80%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1>å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ-åŸºç¡€ç¯‡</h1><p>ä¸»è¦æ˜¯è®°å½•é˜…è¯»ã€Šå¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼šåŸç†è§£æä¸æ¶æ„å®æˆ˜ã€‹åŸºç¡€ç¯‡ä¸­çš„ä¸€äº›çŸ¥è¯†å’Œç†è§£ã€‚</p><ul><li>ä¹¦è¯„</li></ul><p><a href="https://book.douban.com/subject/25723658/">å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ</a></p><p>åŸºç¡€ç¯‡ä¸»è¦æ˜¯ä»<B>å•æœºå­˜å‚¨ç³»ç»Ÿ</B>åˆ°<B>åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ</B>çš„æ¼”åŒ–è¿‡ç¨‹ä»¥åŠå„è‡ªçš„ç‰¹ç‚¹è¿›è¡Œåˆ†æ</p><h2 id="å•æœºå­˜å‚¨ç³»ç»Ÿ"><a class="header-anchor" href="#å•æœºå­˜å‚¨ç³»ç»Ÿ"></a>å•æœºå­˜å‚¨ç³»ç»Ÿ</h2><p>å•æœºå­˜å‚¨ç³»ç»Ÿæœ€æ—©åº”è¯¥æ˜¯æ¥æºè‡ªå…³ç³»å‹æ•°æ®åº“çš„ç†è®ºï¼Œæ ¹æ®æ•°æ®åº“æ“ä½œåœ¨å‘å±•å‡ºäº‹åŠ¡çš„æ¦‚å¿µ</p><h3 id="ç¡¬ä»¶åŸºç¡€"><a class="header-anchor" href="#ç¡¬ä»¶åŸºç¡€"></a>ç¡¬ä»¶åŸºç¡€</h3><p>ä»‹ç»CPUã€IOæ€»çº¿ã€ç½‘ç»œæ‹“æ‰‘ç­‰çŸ¥è¯†ï¼Œå…¶ä¸­å—æ¡¥/åŒ—æ¡¥çš„ä½œç”¨æ¯”è¾ƒæœ‰æ„æ€</p><ul><li>å—æ¡¥è´Ÿè´£ä¸ä½é€Ÿè®¾å¤‡çš„äº¤äº’</li><li>åŒ—æ¡¥è´Ÿè´£ä¸é«˜é€Ÿè®¾å¤‡çš„äº¤äº’</li></ul><p><img src="https://i.loli.net/2021/11/09/6OIbyw3zZGTFCkc.jpg" alt="å—åŒ—æ¡¥ç»“æ„"></p><h3 id="å­˜å‚¨å¼•æ“"><a class="header-anchor" href="#å­˜å‚¨å¼•æ“"></a>å­˜å‚¨å¼•æ“</h3><p>å­˜å‚¨å¼•æ“æ˜¯æ ¹æ®æ–‡ä»¶ç³»ç»Ÿå¯¹å­˜å‚¨ç³»ç»Ÿæä¾›åº•å±‚çš„CRUDèƒ½åŠ›çš„å¼•æ“,æ ¹æ®å­˜å‚¨å¼•æ“åº•å±‚ä½¿ç”¨çš„ç®—æ³•å¯ä»¥å¤§è‡´åˆ’åˆ†ä¸ºâ€™hashå­˜å‚¨å¼•æ“â€™ã€â€˜B treeå­˜å‚¨å¼•æ“â€™ã€'LSMå­˜å‚¨å¼•æ“â€™è¿™ä¸‰ç±»</p><ul><li><p>hashå­˜å‚¨å¼•æ“<br>hashå­˜å‚¨å¼•æ“åº•å±‚é‡‡ç”¨hashç®—æ³•ç¡®å®škeyçš„ä½ç½®ï¼Œvalueåˆ™ä»£è¡¨æ–‡ä»¶çš„ç‰©ç†ä½ç½®ã€‚ä½¿ç”¨è¿™ç§ç®—æ³•çš„å¯ä»¥å‚è€ƒRocketMQä¸­çš„indexFileå’ŒcommitLogæ–‡ä»¶ä¹‹é—´çš„å…³ç³».<br>hashå­˜å‚¨å¼•æ“ä¸æ”¯æŒé¡ºåºè¯»å†™</p></li><li><p>B+ treeå­˜å‚¨å¼•æ“<br>B+ treeå­˜å‚¨å¼•æ“å…·ä½“çš„å®ç°å¯ä»¥å‚è€ƒMySQLä¸­çš„innodbå­˜å‚¨å¼•æ“çš„è®¾è®¡æ¨¡å‹ï¼Œä¼šè®¾è®¡å‡ºä¸€ä¸ªç¼“å­˜åŒºæ¥å¯¹çƒ­ç‚¹æ•°æ®çš„ç¼“å­˜ã€‚å¯¹äºç¼“å­˜æ•°æ®çš„æ›¿æ¢ç­–ç•¥æœ‰<B>LRU</B>ã€<B>LIRS</B>ï¼Œå…¶ä¸­LIRSçš„è®¾è®¡æ¯”è¾ƒæœ‰è¶£ï¼ŒLIRSæ˜¯ä¸ºäº†è§£å†³LRUç­–ç•¥æ— æ³•å¤„ç†å› å…¨è¡¨æ‰«æå¯¼è‡´æ±¡æŸ“ç¼“å†²åŒºçš„åœºæ™¯ï¼Œåº•å±‚é‡‡ç”¨å¤šçº§ç¼“å†²çš„ç­–ç•¥ï¼Œè®¾ç½®æ™‹å‡é˜ˆå€¼æ¥é¿å…ä¸€çº§ç¼“å­˜å—åˆ°æ±¡æŸ“</p></li><li><p>LSMå­˜å‚¨å¼•æ“<br>LSMå­˜å‚¨å¼•æ“çš„å…¨ç§°æ˜¯â€™Log-structured merge-treeâ€™. å°†å¯¹æ•°æ®çš„ä¿®æ”¹å¢é‡ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œè¾¾åˆ°æŒ‡å®šçš„å¤§å°é™åˆ¶åå°†è¿™äº›ä¿®æ”¹æ“ä½œæ‰¹é‡é¡ºåºå†™å…¥ç£ç›˜ä¸­ã€‚LSMé€‚åˆäºå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œé€šè¿‡ç‰ºç‰²è¯»å–æ€§èƒ½æ¥æ¢å†™å…¥çš„æ€§èƒ½</p></li></ul><h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“"></a>å°ç»“</h3><p>å…³äºæ›´å¤šçš„å­˜å‚¨å¼•æ“å¯ä»¥å‚è€ƒ<br><a href="https://dev.to/creativcoder/what-is-a-lsm-tree-3d75">What is a LSM Tree?</a><br><a href="ttps://bbs.huaweicloud.com/blogs/detail/197482">å­˜å‚¨å¼•æ“å¯¹æ¯”</a><br><a href="https://www.cs.umb.edu/~poneil/lsmtree.pdf">LSM Tree è®ºæ–‡</a></p><h2 id="æ•°æ®æ¨¡å‹"><a class="header-anchor" href="#æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><p>æ•°æ®æ¨¡å‹æŒ‡çš„æ˜¯å­˜å‚¨å¼•æ“ç”¨ä»€ä¹ˆæ ¼å¼ä¿å­˜æ•°æ®å¸¸ç”¨çš„æ•°æ®æ¨¡å‹æœ‰â€™æ–‡ä»¶â€™ã€â€˜å…³ç³»â€™ã€â€˜é”®å€¼å¯¹â€™</p><h2 id="äº‹åŠ¡"><a class="header-anchor" href="#äº‹åŠ¡"></a>äº‹åŠ¡</h2><ul><li>äº‹åŠ¡çš„ç‰¹æ€§:ACID</li><li>äº‹åŠ¡çš„ç§ç±»:è¯»äº‹åŠ¡ã€å†™äº‹åŠ¡ã€æ··åˆäº‹åŠ¡</li><li>äº‹åŠ¡çš„å®ç°:é”ã€COWã€MVCC</li></ul><h2 id="æ•…éšœæ¢å¤"><a class="header-anchor" href="#æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h2><p>æ•°æ®åº“éœ€è¦å®ç°å®Œå–„çš„æ•…éšœæ¢å¤æœºåˆ¶ï¼Œä¸€èˆ¬æ˜¯é‡‡ç”¨æ“ä½œæ—¥å¿—æ¥å®ç°çš„ã€‚<br>æ“ä½œæ—¥å¿—åˆ†ä¸º</p><ul><li>å›æ»šæ—¥å¿—(UNDO log) ç”¨æ¥è®°å½•äº‹åŠ¡ä¿®æ”¹å‰çš„è®°å½•</li><li>é‡åšæ—¥å¿—(REDO log) ç”¨æ¥è®°å½•äº‹åŠ¡ä¿®æ”¹åçš„çŠ¶æ€</li><li>æ“ä½œæ—¥å¿—(binlog) ç”¨æ¥è®°å½•å¯¹ç‰©ç†ç£ç›˜çš„æ“ä½œ</li></ul><h2 id="æ•°æ®å‹ç¼©"><a class="header-anchor" href="#æ•°æ®å‹ç¼©"></a>æ•°æ®å‹ç¼©</h2><p>æ•°æ®å‹ç¼©æ˜¯å¯¹å¤§é‡æ•°æ®è¿›è¡Œå‹ç¼©ä»¥èŠ‚çœç©ºé—´ã€‚å‹ç¼©ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯æŸ¥æ‰¾é‡å¤æ•°æ®ï¼Œ'åˆ—å¼å­˜å‚¨æŠ€æœ¯â€™æ˜¯æŠŠç›¸åŒåˆ—çš„æ•°æ®ç»„ç»‡åœ¨ä¸€èµ·</p><h3 id="å‹ç¼©ç®—æ³•"><a class="header-anchor" href="#å‹ç¼©ç®—æ³•"></a>å‹ç¼©ç®—æ³•</h3><ul><li>Huffmanç¼–ç </li><li>LZç³»åˆ—å‹ç¼©ç®—æ³•</li></ul><h3 id="åˆ—å¼å­˜å‚¨"><a class="header-anchor" href="#åˆ—å¼å­˜å‚¨"></a>åˆ—å¼å­˜å‚¨</h3><pre><code>åˆ—å¼å­˜å‚¨æ˜¯é’ˆå¯¹äºä¼ ç»Ÿçš„è¡Œå¼å­˜å‚¨çš„å¯¹åº”ï¼Œé’ˆå¯¹çš„æ˜¯OLAPçš„åœºæ™¯ã€‚æŒ‰ç…§åˆ—æ¥å­˜å‚¨æ•°æ®å°±ä¼šå¯¼è‡´åˆ—ä¸Šé‡å¤çš„å€¼è¾ƒå¤šï¼Œå› æ­¤å°±éœ€è¦ä½¿ç”¨å‹ç¼©ç®—æ³•æ¥è¿›è¡Œå‹ç¼©</code></pre><h2 id="åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿç‰¹æ€§"><a class="header-anchor" href="#åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿç‰¹æ€§"></a>åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿç‰¹æ€§</h2><p>åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿåº•å±‚ä¸»è¦ä¾èµ–ä¸¤ä¸ªåè®®<B>Paxosé€‰ä¸¾åè®®</B>ã€<B>ä¸¤é˜¶æ®µæäº¤åè®®</B></p><h3 id="å¼‚å¸¸"><a class="header-anchor" href="#å¼‚å¸¸"></a>å¼‚å¸¸</h3><ul><li>å®•æœº</li><li>ç½‘ç»œå¼‚å¸¸<br>æ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯ä¹±åºã€ç½‘ç»œæ•°æ®åŒ…å¼‚å¸¸</li></ul><blockquote><p>è®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ä¸ªåŸåˆ™æ˜¯:ç½‘ç»œæ°¸è¿œæ˜¯ä¸å¯é çš„</p></blockquote><ul><li>ç£ç›˜æ•…éšœ</li></ul><h3 id="çŠ¶æ€"><a class="header-anchor" href="#çŠ¶æ€"></a>çŠ¶æ€</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®šä¹‰çš„ç³»ç»ŸçŠ¶æ€æœ‰ä¸”åªæœ‰<B>æˆåŠŸ</B>ã€<B>å¤±è´¥</B>ã€<B>æœªçŸ¥</B></p><h3 id="ä¸€è‡´æ€§"><a class="header-anchor" href="#ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ç”±äºå¼‚å¸¸æ˜¯æ— æ³•é¿å…çš„ï¼Œå› æ­¤éœ€è¦å†—ä½™å¤šä»½æ•°æ®æ¥ä¿è¯å¯ç”¨æ€§ã€‚å†—ä½™çš„å¤šä»½å‰¯æœ¬å°±ä¼šå­˜åœ¨æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå¦‚ä½•ä¿è¯å‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§æ˜¯å…³é”®</p><h2 id="æ•°æ®åˆ†å¸ƒ"><a class="header-anchor" href="#æ•°æ®åˆ†å¸ƒ"></a>æ•°æ®åˆ†å¸ƒ</h2><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸å•æœºå­˜å‚¨ç³»ç»Ÿç³»ç»Ÿæœ€å¤§çš„åŒºåˆ«åœ¨äº<B>æ•°æ®åˆ†å¸ƒ</B>ä¸Š,åˆ†å¸ƒå¼ç³»ç»Ÿå¯ä»¥å°†æ•°æ®æŒ‰ç…§<B>Hashåˆ†å¸ƒ</B>ã€<B>é¡ºåºåˆ†å¸ƒ</B>ä¸¤ç§æ–¹å¼è¿›è¡Œåˆ’åˆ†ã€‚</p><h3 id="Hashåˆ†å¸ƒ"><a class="header-anchor" href="#Hashåˆ†å¸ƒ"></a>Hashåˆ†å¸ƒ</h3><p>Hashåˆ†å¸ƒåŸç†æ¯”è¾ƒç®€å•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ‰©å®¹åœºæ™¯ä¸‹çš„å¤„ç†ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•åˆ†åˆ«æ˜¯</p><ul><li>å…ƒæ•°æ®åŒº<br>å¼•å…¥å…ƒæ•°æ®åŒºï¼Œé€šè¿‡å…ƒæ•°æ®åŒºæ¥ç®¡ç†hashçš„keyä¸valueä¹‹é—´çš„å…³ç³»</li><li>ä¸€è‡´æ€§hashç®—æ³•<br>ä½¿ç”¨ä¸€è‡´æ€§hashç®—æ³•,ä¿è¯èŠ‚ç‚¹çš„å¹³å‡åˆ†å¸ƒ</li></ul><blockquote><p>ä¸€è‡´æ€§hashç®—æ³•å¦‚ä½•åœ¨æ‰©å®¹æ—¶ä¿è¯æ•°æ®çš„å¹³å‡åˆ†å¸ƒ?</p></blockquote><p>Hashç®—æ³•ä¸æ”¯æŒé¡ºåºæŸ¥æ‰¾</p><h3 id="é¡ºåºåˆ†å¸ƒ"><a class="header-anchor" href="#é¡ºåºåˆ†å¸ƒ"></a>é¡ºåºåˆ†å¸ƒ</h3><p>é¡ºåºåˆ†å¸ƒæŒ‡çš„æ˜¯æ•°æ®æŒ‰ç…§æŒ‡å®šçš„ç»´åº¦é¡ºåºçš„å†™å…¥æ•°æ®ï¼Œå¤šç”¨äºåˆ†å¸ƒå¼è¡¨æ ¼ç³»ç»Ÿä¸­</p><h2 id="å¤åˆ¶"><a class="header-anchor" href="#å¤åˆ¶"></a>å¤åˆ¶</h2><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®çš„å¤åˆ¶æœºåˆ¶å†³å®šäº†è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹å¯ç”¨æ€§å’Œä¸€è‡´æ€§çš„å–èˆã€‚æ•°æ®çš„å¤åˆ¶å¯ä»¥åˆ†ä¸º<B>å¼ºåŒæ­¥å¤åˆ¶</B>ã€<B>å¼‚æ­¥å¤åˆ¶</B>ä¸¤ç§æ–¹å‘ã€‚<br>åœ¨å·¥ç¨‹å®è·µä¸­åˆå¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªæ–¹å‘åšä¸åŒçš„å–èˆï¼Œä»¥Oracleçš„DataGuardå¤åˆ¶ç»„ä»¶ä¸ºä¾‹,æä¾›äº†ä¸‰ç§ä¸åŒçš„æ¨¡å¼</p><ul><li>æœ€å¤§ä¿æŠ¤æ¨¡å¼<br>æœ€å¤§ä¿æŠ¤æ¨¡å¼ä¹Ÿå°±æ˜¯å¼ºåŒæ­¥å¤åˆ¶æ¨¡å¼</li><li>æœ€å¤§æ€§èƒ½æ¨¡å¼<br>æœ€å¤§æ€§èƒ½æ¨¡å¼ä¹Ÿå°±æ˜¯å¼‚æ­¥å¤åˆ¶æ¨¡å¼</li><li>æœ€å¤§å¯ç”¨æ¨¡å¼<br>æœ€å¤§å¯ç”¨æ¨¡å¼æ˜¯é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨å¼ºåŒæ­¥å¤åˆ¶æ¨¡å¼ï¼Œç½‘ç»œå¼‚å¸¸æ—¶ä½¿ç”¨å¼‚æ­¥å¤åˆ¶æ¨¡å¼</li></ul><h2 id="æ•…éšœæ£€æµ‹"><a class="header-anchor" href="#æ•…éšœæ£€æµ‹"></a>æ•…éšœæ£€æµ‹</h2><p>æ•…éšœæ£€æµ‹å¸¸ç”¨çš„æ–¹æ³•æœ‰å¿ƒè·³ã€Ï†-accrual(ç´¯è®¡å†å²æ•…éšœæ£€æµ‹å™¨)ã€ Gossipæ•…éšœæ£€æµ‹.è¿™å‡ ç§æ–¹å¼</p><p><a href="https://iswade.github.io/database/db_internals_ch09_failure_detection/#gossip">åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹æ•…éšœæ£€æµ‹</a><br><a href="https://www.serf.io/docs/internals/gossip.html">serfå®˜ç½‘</a><br><a href="https://flogx.com/post/using-serf-to-implement-distributed-fault-detection/">ä½¿ç”¨serfå®ç°åˆ†å¸ƒå¼æ•…éšœæ£€æµ‹</a></p><h2 id="æ•…éšœæ¢å¤-v2"><a class="header-anchor" href="#æ•…éšœæ¢å¤-v2"></a>æ•…éšœæ¢å¤</h2><p>æ•…éšœæ¢å¤æ˜¯ç”±äºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹æœºå™¨æˆ–ç½‘ç»œçš„æ•…éšœï¼Œéœ€è¦é€šè¿‡æ•…éšœæ¢å¤çš„æœºåˆ¶å°†æœåŠ¡ä»ä¸å¯ç”¨çŠ¶æ€æ¢å¤æˆå¯ç”¨çŠ¶æ€ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„å­˜å‚¨æ–¹æ¡ˆåˆ†ä¸ºä¸¤ç§ç»“æ„:<B>å•å±‚ç»“æ„</B>ã€<B>åŒå±‚ç»“æ„</B></p><ul><li>å•å±‚ç»“æ„<br>å•å±‚ç»“æ„æŒ‡çš„æ˜¯æœåŠ¡å’Œå­˜å‚¨éƒ½ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæŒ‰ç…§èŠ‚ç‚¹è¿›è¡Œåˆ†ç‰‡</li><li>å¤šå±‚ç»“æ„<br>å¤šå±‚ç»“æ„æŒ‡çš„æ˜¯å­˜å‚¨ç³»ç»ŸæŒ‰ç…§æœåŠ¡å±‚å’Œå­˜å‚¨å±‚è¿›è¡Œåˆ†å±‚,åœ¨æœåŠ¡å±‚åªæä¾›ä¸€ä¸ªä¸€ä»½æ•°æ®</li></ul><h2 id="åˆ†å¸ƒå¼åè®®"><a class="header-anchor" href="#åˆ†å¸ƒå¼åè®®"></a>åˆ†å¸ƒå¼åè®®</h2><p><B>åˆ†å¸ƒå¼åè®®</B>æ ¹æ®ä¸åŒçš„ä½œç”¨åŸŸå¯ä»¥åˆ’åˆ†ä¸ºç§Ÿçº¦\å¤åˆ¶åè®®\ä¸€è‡´æ€§åè®®ç­‰.æ¯”è¾ƒé‡è¦çš„æ˜¯<B>ä¸¤é˜¶æ®µæäº¤åè®®</B>ã€<B>Paxosé€‰ä¸¾åè®®</B></p><ul><li><p>ä¸¤é˜¶æ®µæäº¤åè®®<br>ä¸¤é˜¶æ®µæäº¤åè®®æŒ‡çš„æ˜¯å°†åˆ†å¸ƒå¼äº‹åŠ¡çš„æ“ä½œåˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ,åˆ†åˆ«æ˜¯<B>è¯·æ±‚é˜¶æ®µ</B>ã€<B>æäº¤é˜¶æ®µ</B><br>ä¸¤é˜¶æ®µæäº¤åè®®ä¸­çš„åŒ…æ‹¬çš„èŠ‚ç‚¹æœ‰ä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯<B>åè°ƒè€…</B>å’Œ<B>å‚ä¸è€…</B></p><p><img src="https://i.loli.net/2021/11/11/qxE9X3mhKwDJfBg.jpg" alt="ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹.jpg"></p></li><li><p>Paxosé€‰ä¸¾åè®®<br>Paxosé€‰ä¸¾åè®®ä¸»è¦æ˜¯ç”¨äºè§£å†³å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ä¸€è‡´æ€§é—®é¢˜ã€‚å¯ä»¥å‚è€ƒä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« <a href="https://agmtopy.github.io/2020/06/23/1.%E6%9D%82%E8%AE%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7paxos%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0zab%E5%8D%8F%E8%AE%AE/">åˆ†å¸ƒå¼ä¸­çš„ä¸€è‡´æ€§paxosç®—æ³•ä»¥åŠå…¶å®ç°zabåè®®</a><br>é‡‡ç”¨â€™Quorumæœºåˆ¶â€™æœºåˆ¶æ¥ä¿è¯èŠ‚ç‚¹ä½œä¸ºä¸€ä¸ªæ•´ä½“å¯¹å¤–çš„ä¸€è‡´æ€§,ç®€å•çš„æ¥è¯´å°±æ˜¯é€šè¿‡åºåˆ—å·å’Œå¤§å¤šæ•°ç¡®è®¤æœºåˆ¶æ¥ä¿è¯é›†ç¾¤çš„ä¸€è‡´æ€§</p></li><li><p>Paxosä¸2PCæ··åˆåœºæ™¯<br><img src="https://i.loli.net/2021/11/11/M12yJLwtjePQfnr.jpg" alt="2PCä¸Paoxsçš„å¯¹æ¯”.jpg"></p></li></ul><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>åŸºç¡€ç¯‡ä¸»è¦æ˜¯ä»‹ç»å•æœºå­˜å‚¨ç³»ç»Ÿçš„<B>ç¡¬ä»¶åŸºç¡€</B>ã€<B>å­˜å‚¨å¼•æ“</B>ã€åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ<B>æ•°æ®æ¨¡å‹</B>ã€<B>åˆ†å¸ƒå¼ç‰¹æ€§</B>ã€<B>æ•…éšœæ£€æµ‹/æ¢å¤</B>ã€<B>åˆ†å¸ƒå¼åè®®</B>ç­‰</p><ul><li></li></ul>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯»ä¹¦ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥å‰–æKubernetesä¹‹Kubernetesçš„åŸºç¡€æ¦‚å¿µ</title>
      <link href="2021/11/08/18.%E5%AE%B9%E5%99%A8%E5%8C%96/1.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BKubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
      <url>2021/11/08/18.%E5%AE%B9%E5%99%A8%E5%8C%96/1.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BKubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹Kubernetesçš„åŸºç¡€</h1><blockquote><p>Kubernetesæ˜¯ç”±googleå’ŒRetHotä¸»å¯¼çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œå·²ç»ç§°ä¸ºå®¹å™¨ç¼–æ’çš„æ ‡å‡†.Kubernetesæºè‡ªGoogleå†…éƒ¨çš„Borg,å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </p></blockquote><p><a href="https://kubernetes.io/zh/blog/2015/04/borg-predecessor-to-kubernetes/">Borg: Kubernetes çš„å‰èº«</a></p><h2 id="æ¦‚å¿µ"><a class="header-anchor" href="#æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Kubernetesæ˜¯ä¸€ä¸ªå¯¹å®¹å™¨è¿›è¡Œç®¡ç†çš„æ¡†æ¶,æä¾›äº†<B>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</B>ã€<B>å­˜å‚¨ç¼–æ’</B>ã€<B>è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š</B>ã€<B>è‡ªåŠ¨å®Œæˆè£…ç®±è®¡ç®—</B>ã€<B>è‡ªæˆ‘ä¿®å¤</B>ã€<B>å¯†é’¥ä¸é…ç½®ç®¡ç†</B>ç­‰åŠŸèƒ½ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </p><p><a href="https://kubernetes.io/zh/docs/concepts/overview/">Kubernetes æ˜¯ä»€ä¹ˆ</a></p><h2 id="ç»„ä»¶"><a class="header-anchor" href="#ç»„ä»¶"></a>ç»„ä»¶</h2><p><img src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt="kubernetesç»„ä»¶æ€»è§ˆ"></p><p>kubernetesçš„ç»„ä»¶åˆ†ä¸º<B>æ§åˆ¶å¹³é¢ç»„ä»¶</B>ã€<B>Node ç»„ä»¶</B>ã€<B>æ’ä»¶</B></p><h3 id="æ§åˆ¶å¹³é¢ç»„ä»¶"><a class="header-anchor" href="#æ§åˆ¶å¹³é¢ç»„ä»¶"></a>æ§åˆ¶å¹³é¢ç»„ä»¶</h3><p>æ§åˆ¶å¹³é¢ç»„ä»¶æ˜¯å¯¹é›†ç¾¤åšå‡ºå…¨å±€å†³ç­–(æ¯”å¦‚è°ƒåº¦)ï¼Œä»¥åŠæ£€æµ‹å’Œå“åº”é›†ç¾¤äº‹ä»¶çš„å†³ç­–å’Œå¤„ç†ã€‚</p><h3 id="Node-ç»„ä»¶"><a class="header-anchor" href="#Node-ç»„ä»¶"></a>Node ç»„ä»¶</h3><p>NodeèŠ‚ç‚¹ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾› Kubernetes è¿è¡Œç¯å¢ƒã€‚</p><h3 id="æ’ä»¶ï¼ˆAddonsï¼‰"><a class="header-anchor" href="#æ’ä»¶ï¼ˆAddonsï¼‰"></a>æ’ä»¶ï¼ˆAddonsï¼‰</h3><p>æ’ä»¶æ˜¯æ˜¯å¯¹Kubernetesèµ„æºï¼ˆDaemonSetã€ Deploymentç­‰ï¼‰å®ç°ç®¡ç†çš„åŠŸèƒ½ã€‚ å› ä¸ºè¿™äº›æ’ä»¶æä¾›é›†ç¾¤çº§åˆ«çš„åŠŸèƒ½ï¼Œæ’ä»¶ä¸­å‘½åç©ºé—´åŸŸçš„èµ„æºå±äºkube-systemå‘½åç©ºé—´ã€‚</p><h2 id="éƒ¨ç½²"><a class="header-anchor" href="#éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>Kubernetesçš„éƒ¨ç½²å·¥å…·ç›®å‰æœ‰<B>kubectl</B>ã€<B>kind</B>ã€<B>minikube</B>ã€<B>kubeadm</B></p><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/">kubernetesçš„éƒ¨ç½²å·¥å…·æ–‡æ¡£</a></p><h2 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h2><p>å¦‚ä½•åˆ›å»ºä¸€ä¸ªç®€å•çš„kubernetesçš„æœ¬åœ°ç¯å¢ƒ</p><h3 id="å‰ç½®å‡†å¤‡"><a class="header-anchor" href="#å‰ç½®å‡†å¤‡"></a>å‰ç½®å‡†å¤‡</h3><ul><li><p>å·¥å…·</p><ol><li>minikube</li><li>kubectl</li></ol></li><li><p>æ­¥éª¤</p><ol><li>å®‰è£…minikube</li></ol><ul><li>æ£€æŸ¥æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–</li></ul><blockquote><p>grep -E --color â€˜vmx|svmâ€™ /proc/cpuinfo</p></blockquote><ul><li>å®‰è£…é…ç½® kubectl</li></ul>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https<span class="token function">curl</span> -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -<span class="token builtin class-name">echo</span> <span class="token string">"deb https://apt.kubernetes.io/ kubernetes-xenial main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/apt/sources.list.d/kubernetes.list<span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å®‰è£…minikube</li></ul>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64<span class="token function">sudo</span> <span class="token function">install</span> minikube-linux-amd64 /usr/local/bin/minikube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>å¯åŠ¨</li></ol><ul><li>æŸ¥çœ‹æ‰€æœ‰namespaceä¸‹çš„pod</li></ul><blockquote><p>kubectl get po -A</p></blockquote><ul><li>å®‰è£…ä»ªè¡¨ç›˜</li></ul><blockquote><p>minikube dashboard</p></blockquote><p>å¯åŠ¨æ§åˆ¶å°åå¯ä»¥çœ‹åˆ°<br><img src="https://i.loli.net/2021/11/27/iYAxaecJMdFurZQ.jpg" alt="kubernetesæ§åˆ¶å°"></p></li></ul><h3 id="é…ç½®æ–‡ä»¶"><a class="header-anchor" href="#é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>kubernetesä¸æ¨èä½¿ç”¨å‘½ä»¤è¡Œæ¥æ“ä½œå®¹å™¨ï¼Œè€Œæ˜¯æ¨èä½¿ç”¨YAMLæ–‡ä»¶æ¥è¿›è¡Œé…ç½®</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„zké›†ç¾¤çš„é…ç½®æ–‡ä»¶</p><ul><li>application/zookeeper/zookeeper.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>hs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2888</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> server  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3888</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>election  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>cs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2181</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> client  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>pdb<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> zk  <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> zk  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>hs  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> zk    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"app"</span>                    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                    <span class="token key atrule">values</span><span class="token punctuation">:</span>                    <span class="token punctuation">-</span> zk              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/hostname"</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>zookeeper        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10"</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"1Gi"</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"0.5"</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">2181</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">2888</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> server        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3888</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>election        <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> "start<span class="token punctuation">-</span>zookeeper \          <span class="token punctuation">-</span><span class="token punctuation">-</span>servers=3 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>data_dir=/var/lib/zookeeper/data \          <span class="token punctuation">-</span><span class="token punctuation">-</span>data_log_dir=/var/lib/zookeeper/data/log \          <span class="token punctuation">-</span><span class="token punctuation">-</span>conf_dir=/opt/zookeeper/conf \          <span class="token punctuation">-</span><span class="token punctuation">-</span>client_port=2181 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>election_port=3888 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>server_port=2888 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>tick_time=2000 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>init_limit=10 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>sync_limit=5 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>heap=512M \          <span class="token punctuation">-</span><span class="token punctuation">-</span>max_client_cnxns=60 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>snap_retain_count=3 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>purge_interval=12 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>max_session_timeout=40000 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>min_session_timeout=4000 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>log_level=INFO"        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> sh            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c            <span class="token punctuation">-</span> <span class="token string">"zookeeper-ready 2181"</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> sh            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c            <span class="token punctuation">-</span> <span class="token string">"zookeeper-ready 2181"</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> datadir          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/zookeeper      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> datadir    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é…ç½®æ–‡ä»¶ä»¥â€™â€”'ä½œä¸ºå®¹å™¨é…ç½®åˆ†å‰²ç¬¦ï¼Œåˆ†åˆ«åˆ›å»ºäº†4ä¸ªå®¹å™¨ä»è€Œåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ZKé›†ç¾¤</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">service/zk-hs createdservice/zk-cs createdpoddisruptionbudget.policy/zk-pdb createdstatefulset.apps/zk created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><ol><li>kuberneteså†…éƒ¨æ˜¯ç”±å››ä¸ªç»„ä»¶ç»„æˆ</li></ol><ul><li>æ§åˆ¶å¹³é¢ç»„ä»¶</li><li>NodeèŠ‚ç‚¹ç»„ä»¶</li><li>æ’ä»¶</li></ul><ol start="2"><li>éƒ¨ç½²å·¥å…·</li></ol><ul><li>minikube</li><li>kind</li><li>kubeadm</li></ul><ol start="3"><li>é…ç½®æ–‡ä»¶<br>é…ç½®æ–‡ä»¶å°†å®¹å™¨ä¸­æŒ‰ç…§é›†ç¾¤éƒ¨ç½²çš„æ–¹å¼æ ¹æ®åº”ç”¨ç»´åº¦æ‰“åŒ…å½¢æˆä¸€ä¸ªé…ç½®æ–‡ä»¶,åç»­å°±å¯ä»¥è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œå¯åŠ¨ã€‚è¿™é‡Œåº”ç”¨çš„æ¦‚å¿µåœ¨kubernetesä¸­è¢«ç§°ä¸ºpod,ä¸€ä¸ªpodæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆçš„ã€‚</li></ol><h2 id="å‚è€ƒæ–‡æ¡£"><a class="header-anchor" href="#å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p><a href="https://kubernetes.io/zh">kubernetesä¸­æ–‡å®˜ç½‘</a><br><a href="https://kubernetes.io/zh/docs/tutorials/kubernetes-basics/create-cluster/cluster-interactive/">kubernetesäº¤äº’æ–‡æ¡£</a><br><a href="https://minikube.sigs.k8s.io/docs/handbook/">minikubeå®˜ç½‘</a><br><a href="https://kubernetes.io/zh/docs/tutorials/stateful-application/zookeeper/">éƒ¨ç½²è¿è¡ŒZooKeeperé›†ç¾¤</a></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReadWriteLockçš„æºç åˆ†æ</title>
      <link href="2021/11/02/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/16.ReadWriteLock%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>2021/11/02/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/16.ReadWriteLock%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>ReadWriteLockçš„æºç åˆ†æ</h1><p>ReadWriteLockæ˜¯JUCåŒ…ä¸‹çš„å®šä¹‰çš„è¯»å†™é”çš„æ¥å£,å®šä¹‰ä¸¤ä¸ªæ¥å£<B>readLock()</B>ã€<B>writeLock()</B>åˆ†åˆ«æ˜¯è¿”å›è¯»é”å’Œè¿”å›ä¸€ä¸ªå†™é”ã€‚<br>ReadWriteLocké»˜è®¤æœ‰ä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯<B>ReadWriteLockView</B>ã€<B>ReentrantReadWriteLock</B>ã€‚</p><p>ReentrantReadWriteLockæ˜¯é»˜è®¤çš„è¯»å†™é”çš„å®ç°<br>ReadWriteLockViewæ˜¯<B>StampedLock</B>çš„å†…éƒ¨ç±»ï¼ŒStampedLockæ˜¯JDK 1.8ä¸­å¯¹ReentrantReadWriteLockçš„ä¸€ä¸ªå¢å¼ºçš„å®ç°<br>ä¸‹é¢ä¼šå…ˆåˆ†æReentrantReadWriteLockï¼Œåœ¨å¯¹StampedLockè¿›è¡Œåˆ†æ</p><h2 id="ReentrantReadWriteLock"><a class="header-anchor" href="#ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h2><blockquote><p>ReentrantReadWriteLockæ˜¯å®ç°ReadWriteLockæ¥å£,å¯¹å¤–æä¾›read()å’Œwirte()æ–¹æ³•ã€‚ç‰¹ç‚¹ä¸»è¦æ˜¯æ”¯æŒå…¬å¹³é”é€‰æ‹©ã€å¯é‡å…¥ã€é”é™çº§çš„åˆ†ç±»</p></blockquote><h3 id="ç”¨ä¾‹"><a class="header-anchor" href="#ç”¨ä¾‹"></a>ç”¨ä¾‹</h3><p>è¿™ä¸ªç”¨ä¾‹æ˜¯å¯¹ReentrantReadWriteLockæä¾›çš„ç”¨ä¾‹CachedDataçš„ç®€åŒ–ç‰ˆæœ¬</p><ul><li>CachedData</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> CachedData <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> <span class="token keyword">data</span><span class="token operator">:</span> String    <span class="token keyword">private</span> <span class="token keyword">var</span> cacheValid<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> lock<span class="token operator">:</span> ReentrantReadWriteLock <span class="token operator">=</span> <span class="token function">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">fun</span> <span class="token function">processCacheData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è·å–è¯»é”</span>        lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheValid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è·å–å†™é”ä¹‹å‰å…ˆè¦é‡Šæ”¾è¯»é”</span>            lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">//è·å–å†™é”</span>            lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å†æ¬¡æ£€æŸ¥æ ‡è®°,å› ä¸ºä¸Šä¸€æ¬¡æ£€æŸ¥æ ‡è®°æ˜¯åœ¨è·å–å†™é”ä¹‹å‰</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheValid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                    <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" set data"</span><span class="token punctuation">)</span>                    <span class="token keyword">data</span> <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    cacheValid <span class="token operator">=</span> <span class="token boolean">true</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//é‡æ–°è·å–è¯»é”æ¥å®Œæˆé”é™çº§</span>                lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"æ‰“å°data:"</span> <span class="token operator">+</span>  <span class="token keyword">data</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>main</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ›å»ºçº¿ç¨‹æ± </span>    <span class="token keyword">val</span> poolExecutor <span class="token operator">=</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token function">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//åˆ›å»ºä»»åŠ¡</span>    <span class="token keyword">var</span> cache<span class="token operator">:</span>CachedData <span class="token operator">=</span> <span class="token function">CachedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> barrier<span class="token operator">:</span>CyclicBarrier <span class="token operator">=</span> <span class="token function">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">&#123;</span>        poolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">&#123;</span>            barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            cache<span class="token punctuation">.</span><span class="token function">processCacheData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œç»“æœ</li></ul><p><img src="https://i.loli.net/2021/11/12/wNerlsGfKLpEhzd.jpg" alt="æ‰§è¡Œç»“æœ"><br>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªçº¿ç¨‹å¯¹dataçš„å†™é”è¿›è¡Œç«äº‰,ä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸæ‰§è¡Œsetæ–¹æ³•,å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹åªèƒ½æ‰§è¡Œè¯»é”çš„æ“ä½œ<br>ä»ç°è±¡ä¸Šæ¥çœ‹ä¸€ä¸ª<B>ReentrantReadWriteLock</B>å¯¹å¤–æä¾›äº†è¯»é”å’Œå†™é”ä¸¤ä¸ªåŠŸèƒ½,ä¸‹é¢å°±å¼€å§‹å¯¹ä»£ç è¿›è¡Œè¯¦ç»†çš„åˆ†æ</p><h3 id="æ„é€ å‡½æ•°"><a class="header-anchor" href="#æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3>  <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Creates a new &#123;@code ReentrantReadWriteLock&#125; with * default (nonfair) ordering properties. */</span><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * Creates a new &#123;@code ReentrantReadWriteLock&#125; with * the given fairness policy. * * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy */</span><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    readerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    writerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æ— å‚çš„æ„é€ å‡½æ•°æ˜¯éå…¬å¹³é”çš„ç­–ç•¥,åœ¨æ„é€ æ–¹æ³•ä¸­ä¸»è¦æ˜¯åˆ›å»ºäº†ä¸‰ä¸ªæˆå‘˜å˜é‡</p>  <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å…¬å¹³é”ç±»å‹</span>    <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>    <span class="token comment">//å†…éƒ¨è¯»é”</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readerLock<span class="token punctuation">;</span>    <span class="token comment">//å†…éƒ¨å†™é”</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writerLock<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æºç è§£æ"><a class="header-anchor" href="#æºç è§£æ"></a>æºç è§£æ</h3><h4 id="æ„é€ æ–¹æ³•"><a class="header-anchor" href="#æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><ul><li>è·å–é”çš„æ–¹æ³•<br>è·å–è¯»é”/å†™é”å°±æ˜¯ç›´æ¥è¿”å›å†…éƒ¨çš„è¯»é”/å†™é”å˜é‡</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> writerLock<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span>  <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> readerLock<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°é”çš„ç±»å‹åˆ†åˆ«æ˜¯ReadLockå’ŒWriteLock,ç»§ç»­åˆ†æReadLock/WriteLock</p><ul><li><p>ReadLockä¸WriteLockå¯¹æ¯”</p></li><li><p>ReadLock</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5992448646407690164L</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token class-name">ReadLock</span><span class="token punctuation">(</span><span class="token class-name">ReentrantReadWriteLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync <span class="token operator">=</span> lock<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireSharedNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> sync<span class="token punctuation">.</span><span class="token function">getReadLockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">"[Read locks = "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>WriteLock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4992448646407690164L</span><span class="token punctuation">;</span>    <span class="token comment">//ReentrantReadWriteLockå†…éƒ¨çš„AQSå…¬å¹³/éå…¬å¹³æŠ½è±¡ç±»</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token class-name">WriteLock</span><span class="token punctuation">(</span><span class="token class-name">ReentrantReadWriteLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync <span class="token operator">=</span> lock<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Thread</span> o <span class="token operator">=</span> sync<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span>                                    <span class="token string">"[Unlocked]"</span> <span class="token operator">:</span>                                    <span class="token string">"[Locked by thread "</span> <span class="token operator">+</span> o<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æŸ¥è¯¢å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰å†™é”</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å½“å‰å†™é”çš„é”å®šæ¬¡æ•°</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getWriteHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å¯¹æ¯”å¯çŸ¥<B>WriteLock</B>åªæ˜¯æ¯”<B>ReadLock</B>å¤šä¸¤ä¸ªæ–¹æ³•</p><ul><li>isHeldByCurrentThread()<br>æŸ¥è¯¢å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰å†™é”</li><li>getHoldCount()<br>å½“å‰å†™é”çš„é”å®šæ¬¡æ•°</li></ul><p>åŒæ—¶å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯<B>WriteLock</B>ã€<B>ReadLock</B>éƒ½æ˜¯ä½¿ç”¨<B>Sync</B>æ¥å®ç°çš„åŠŸèƒ½ï¼Œä¸‹é¢è¯¦ç»†çš„åˆ†æä¸€ä¸‹<B>Sync</B>ç±»çš„å®ç°</p><ul><li><B>Sync</B></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">ThreadLocalHoldCounter</span> readHolds<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>    <span class="token comment">//æ„é€ å‡½æ•°</span>    <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ›å»ºThreadLocalHoldCounter(è®°å½•çº¿ç¨‹æŒæœ‰çš„é”æ•°é‡)</span>        readHolds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalHoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®çŠ¶æ€ï¼Œè°ƒç”¨AQSçš„setState()</span>        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ensures visibility of readHolds</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º<B>Sync</B>æ˜¯ç»§æ‰¿è‡ª<B>AbstractQueuedSynchronizer</B>ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»º<B>ThreadLocalHoldCounter</B>å’Œè°ƒç”¨AQSçš„<B>setState()</B>æ–¹æ³•</p><p>æœ‰å…³<B>AbstractQueuedSynchronizer</B>çš„å†…å®¹å¯ä»¥å‚è€ƒä¹‹å‰å†™çš„<br><a href="../../../../../2020/05/22/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/13.AbstractQueuedSynchronizer%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">AbstractQueuedSynchronizerçš„æºç åˆ†æ</a></p><ul><li><p>ThreadLocalHoldCounter<br>ThreadLocalHoldCounterçš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p></li><li><p>ThreadLocalHoldCounter</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalHoldCounter</span>    <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HoldCounter</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">HoldCounter</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HoldCounter</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HoldCounter</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹ä¸º0</span>    <span class="token keyword">int</span> count<span class="token punctuation">;</span>    <span class="token comment">//ä½¿ç”¨idæ¥æ ‡è¯†Threadè€Œä¸æ˜¯å¼•ç”¨,é¿å…å¼•ç”¨é€ƒé€¸</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> tid <span class="token operator">=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ThreadLocalHoldCounterç»§æ‰¿äºThreadLocalç„¶ååœ¨åˆå§‹åŒ–æ—¶ç”¨initialValue()æ–¹æ³•è¿”å›ä¸€ä¸ª<B>HoldCounter</B>å¼•ç”¨<br>HoldCounteræ˜¯ç”¨æ¥è®°å½•çº¿ç¨‹ä¸­åŠ é”çš„ç»Ÿè®¡ä¸çº¿ç¨‹idç›¸å…³è”,è¿™é‡Œå…³è”çº¿ç¨‹å¼•ç”¨æ˜¯æ¯”è¾ƒä¼˜ç§€çš„,é€šè¿‡<B>LockSupport.getThreadId</B>è·å–ä¸€ä¸ªlongç±»å‹çš„çº¿ç¨‹æ ‡è¯†</p><ul><li>LockSupport.getThreadId</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//Uæ˜¯Unsafeç±»å‹çš„å¯¹è±¡</span>    <span class="token keyword">return</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> TID<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><B>Sync</B>é™¤äº†é€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–ä¸Šè¿°çš„ThreadLocalHoldCounterå¯¹è±¡ä»¥å¤–,è¿˜æœ‰ä¸€äº›é™æ€æˆå‘˜å˜é‡æ¥å®Œæˆä¸€äº›ä¾‹å¦‚æ§åˆ¶å…è®¸çº¿ç¨‹é‡å¤æŒæœ‰é”çš„æ¬¡æ•°ç­‰</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_SHIFT   <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_UNIT    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_COUNT      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCLUSIVE_MASK <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥...</span><span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span> <span class="token operator">></span> MAX_COUNT<span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Reentrant acquire</span>    <span class="token function">setState</span><span class="token punctuation">(</span>c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯å¯¹åŒä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”è¶…è¿‡é˜ˆå€¼çš„æ¼”ç¤º</p><p><img src="https://i.loli.net/2021/11/13/uon9IW6fcLxPRv5.jpg" alt="è¶…è¿‡é”é˜ˆå€¼åœºæ™¯"></p><h4 id="readLock"><a class="header-anchor" href="#readLock"></a>readLock()</h4><ul><li>lock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç›´æ¥ä½¿ç”¨<B>AbstractQueuedSynchronizer</B>çš„<B>acquireShared()</B>è·å–ä¸€æŠŠå…±äº«é”,å¤±è´¥å°±é˜»å¡</p><ul><li>AbstractQueuedSynchronizer.acquireShared</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è°ƒç”¨å­ç±»çš„tryAcquireShared()å®ç°</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ReentrantReadWriteLock.tryAcquireShared()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ReservedStackAccess</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/*    * ä¾‹å­:    * 1. å¦‚æœå†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰å°±è¿”å›å¤±è´¥    * 2. å› æ­¤è¯¥çº¿ç¨‹è·å–åˆ°å†™å…¥èµ„æ ¼,æ ¹æ®çº¿ç¨‹é˜Ÿåˆ—åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œé˜»å¡,ä¸éœ€è¦è¿›è¡Œé˜»å¡æ—¶å°±é€šè¿‡CASçš„æ–¹å¼æ¥æ“ä½œé”ä»¥åŠè®¡æ•°    * 3. å¯¹caså¤±è´¥çš„åœºæ™¯è¿›è¡Œé‡è¯•    */</span>    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–åŒæ­¥çŠ¶æ€</span>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœæœ‰ç‹¬å çº¿ç¨‹å¹¶ä¸”ç‹¬å çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹æ—¶ç›´æ¥è¿”å›-1(å¤±è´¥)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//å…±äº«è®¡æ•°</span>    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//1. é€šè¿‡readerShouldBlock()åˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥æ“ä½œ,readerShouldBlock()ä¸»è¦æ˜¯å¯¹å…¬å¹³é”å’Œéå…¬å¹³é”çš„ä¸€ä¸ªåˆ¤æ–­</span>    <span class="token comment">//2. åˆ¤æ–­å½“å‰æ˜¯å¦æ“ä½œäº†æœ€å¤§çš„åŠ é”é‡</span>    <span class="token comment">//3. é€šè¿‡CASè¿›è¡Œæ“ä½œ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> MAX_COUNT <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> SHARED_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¦‚æœæ˜¯é¦–æ¬¡åŠ é”,è®¾ç½®é¦–æ¬¡åŠ é”çº¿ç¨‹å’Œæ¬¡æ•°</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>            firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¦‚æœæ˜¯é¦–æ¬¡åŠ é”çº¿ç¨‹è¿›è¡Œç»§ç»­åŠ é”é‚£ä¹ˆæ¬¡æ•°++</span>            firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¤„ç†holdCounterå¯¹è±¡</span>            <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>                cachedHoldCounter <span class="token operator">=</span> rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>            rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é‡å¤å¤„ç†</span>    <span class="token keyword">return</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>tryAcquireShared</B>æ˜¯ä¼šæ‰§è¡Œé”çš„è®¡æ•°ã€åˆå§‹çº¿ç¨‹çš„ç»‘å®šç­‰å·¥ä½œï¼Œå¹¶ä¸”ä¼šå¯¹æ‰§è¡Œå¤±è´¥è¿›è¡Œè‡ªæ—‹é‡è¯•</p><ul><li>unlock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨<B>releaseShared</B>æ¥å®Œæˆé‡Šæ”¾é”çš„æ“ä½œ,AQSåˆæ˜¯é€šè¿‡<B>tryReleaseShared</B>æ¥å®Œæˆçš„ï¼Œä¸‹é¢å¯ä»¥çœ‹ä¸€ä¸‹tryReleaseSharedçš„ä»£ç </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å°è¯•é‡Šæ”¾é”</span><span class="token annotation punctuation">@ReservedStackAccess</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœæ˜¯é¦–æ¬¡åŠ é”çº¿ç¨‹å¯¹é¦–æ¬¡çš„æ ‡è®°è¿›è¡Œä¿®æ”¹</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// assert firstReaderHoldCount > 0;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReaderHoldCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>            firstReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            firstReaderHoldCount<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¯¹HoldCounterè¿›è¡Œä¿®æ”¹</span>        <span class="token comment">//å¦‚æœä¸æ˜¯ä¸´æ—¶holdCounter,é‚£ä¹ˆè·å–holdCounterååœ¨è¿›è¡Œå¤„ç†</span>        <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>            rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> rh<span class="token punctuation">.</span>count<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            readHolds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">throw</span> <span class="token function">unmatchedUnlockException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">--</span>rh<span class="token punctuation">.</span>count<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è‡ªæ—‹</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">-</span> SHARED_UNIT<span class="token punctuation">;</span>        <span class="token comment">//CASçš„æ–¹å¼å¯¹é”è¿›è¡Œé‡Šæ”¾</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="writeLock"><a class="header-anchor" href="#writeLock"></a>writeLock()</h4><ul><li>lock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç›´æ¥ä½¿ç”¨<B>AbstractQueuedSynchronizer</B>çš„<B>acquire()</B>è·å–ä¸€æŠŠç‹¬å é”,å¤±è´¥å°±é˜»å¡</p><ul><li>unlock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨<B>release</B>æ¥å®Œæˆé‡Šæ”¾é”çš„æ“ä½œ</p><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯é€šè¿‡<B>Sync</B>è¿™ä¸ªç±»å§”æ‰˜ç»™<B>AbstractQueuedSynchronizer</B>æ¥è¿›è¡Œçš„,ä¸»è¦æ˜¯ä¸‰ä¸ªåŠŸèƒ½</p><ul><li>åŠ é”(å…±äº«/ç‹¬å )</li><li>è§£é”(å…±äº«/ç‹¬å )</li><li>è®¡æ•°(å…±äº«/ç‹¬å )<br>ç„¶åAQSä½œä¸ºå…¥å£ä¹Ÿä¼šé€šè¿‡è°ƒç”¨<B>ReentrantReadWriteLock</B>çš„å…·ä½“çš„åŠ é”/è§£é”/è®¡æ•°çš„è¿›è¡Œæ“ä½œã€‚<br>è¯»é”ä¸è¿›è¡Œæ’é˜Ÿï¼Œå†™é”ä¼šè¿›è¡Œæ’é˜Ÿé˜»å¡<br><B>ReentrantReadWriteLock</B>ä¸­æœ‰è¶£çš„æ“ä½œæ˜¯æŠŠstateçš„é«˜16ä½ä½œä¸ºè¯»é”æ ‡è¯†ï¼Œä½16ä½ä½œä¸ºå†™é”æ ‡è¯†ï¼Œå› æ­¤ä¹Ÿæ˜¯åªèƒ½åŠ é”2^16çš„åŸå› </li></ul><h2 id="StampedLock"><a class="header-anchor" href="#StampedLock"></a>StampedLock</h2><p><B>StampedLock</B>æ˜¯å¯¹ReentrantReadWriteLockçš„è¿­ä»£ï¼Œåœ¨å¯¹StampedLockä¸­ä¼˜åŒ–äº†å†™é”é¥¥é¥¿çš„é—®é¢˜</p><h3 id="ç”¨ä¾‹-v2"><a class="header-anchor" href="#ç”¨ä¾‹-v2"></a>ç”¨ä¾‹</h3><ul><li>StampedLockDemo</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> StampedLockDemo <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">val</span> stampedLock <span class="token operator">=</span> <span class="token function">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> <span class="token keyword">data</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">fun</span> <span class="token function">writeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">val</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">data</span> <span class="token operator">+=</span> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token number">1</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fun</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">&#123;</span>        <span class="token comment">//1.ä½¿ç”¨ä¹è§‚é”</span>        <span class="token keyword">var</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">var</span> curData <span class="token operator">=</span> <span class="token keyword">data</span>        <span class="token comment">//2. å†™æ³•1 åŒé‡é”ä¿è¯è¯»å–åˆ°çš„æ˜¯æœ€æ–°æ•°æ®</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stampedLock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                curData <span class="token operator">=</span> <span class="token keyword">data</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                stampedLock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//3. å†™æ³•2 å¾ªç¯</span><span class="token comment">//        while(!stampedLock.validate(stamp)) &#123;</span><span class="token comment">//            stamp = stampedLock.tryOptimisticRead();</span><span class="token comment">//            curData = this.data;</span><span class="token comment">//        &#125;</span>        <span class="token keyword">return</span> curData    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>StampedLock</B>åœ¨åŠ é”æ—¶ä¼šè¿”å›ä¸€ä¸ªæˆ³(stamp),å¯ä»¥æŠŠå®ƒç†è§£ä¸ºç‰ˆæœ¬å·/æ—¶é—´æˆ³ï¼Œåœ¨åç»­è§£é”æ—¶ä¼šç”¨åˆ°.</p><ul><li><p>æä¾›äº†ä¹è§‚é”å’Œæ‚²è§‚é”çš„å®ç°</p><ul><li>tryOptimisticRead()</li><li>tryReadLock()</li></ul></li><li><p>é”é™/å‡çº§</p><ul><li>tryConvertToWriteLock()</li><li>tryConvertToReadLock()</li></ul></li></ul><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>ReadWriteLockæ˜¯è¯»å†™é”çš„æ¥å£ï¼Œé»˜è®¤æœ‰ä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯<B>ReentrantReadWriteLock</B>ã€<B>StampedLock</B>,åˆ†åˆ«æ˜¯é’ˆå¯¹è¯»å¤šå†™å°‘çš„åœºæ™¯å’Œéœ€è¦ä½¿ç”¨ä¹è§‚é”çš„åœºæ™¯ã€‚<br>åº•å±‚éƒ½é‡‡ç”¨ä¸€ä¸ªæ ‡å¿—ä½æ¥è¿›è¡ŒåŒºåˆ†è¯»é”/å†™é”æ ‡è¯†,ä¸€ä¸ªæ˜¯Int(32ä½),ä¸€ä¸ªæ˜¯Long(64ä½)ï¼Œå¹¶ä¸”éƒ½ç»§æ‰¿ä¸<B>AbstractQueuedSynchronizer</B>æ¥è¿›è¡Œå®ç°çš„ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.cnblogs.com/zxporz/p/11642176.html">StampedLockçš„ç†è§£å’Œä½¿ç”¨</a><br><a href="https://zxs.io/article/1667">StampedLockæºç åˆ†æ</a></p>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ReadWriteLock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥å‰–æKubernetesä¹‹å®¹å™¨åŒ–çš„åŸºç¡€</title>
      <link href="2021/10/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/0.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%9F%BA%E7%A1%80/"/>
      <url>2021/10/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/0.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹å®¹å™¨åŒ–çš„åŸºç¡€</h1><h2 id="å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†"><a class="header-anchor" href="#å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†"></a>å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†</h2><p><B>å®¹å™¨åŒ–çš„åŸºç¡€</B>æ˜¯ä¾èµ–äºLinuxåº•å±‚æä¾›çš„ä¸¤ç§èƒ½åŠ›åˆ†åˆ«æ˜¯<B>cgroups</B>,<B>Namespace</B></p><h3 id="cgroups"><a class="header-anchor" href="#cgroups"></a>cgroups</h3><blockquote><p>cgroups çš„å…¨ç§°æ˜¯control groups,æ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§å¯ä»¥é™åˆ¶å•ä¸ªè¿›ç¨‹æˆ–è€…å¤šä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨èµ„æºçš„æœºåˆ¶<br>cgroupså¯ä»¥ç®¡ç†çš„èµ„æºæœ‰:</p></blockquote><ul><li><B>cpuå­ç³»ç»Ÿ</B><br>ä¸»è¦é™åˆ¶è¿›ç¨‹çš„cpuä½¿ç”¨ç‡</li><li><B>cpuacctå­ç³»ç»Ÿ</B><br>å¯ä»¥ç»Ÿè®¡cgroupsä¸­çš„è¿›ç¨‹çš„cpuä½¿ç”¨æŠ¥å‘Š</li><li><B>cpuset å­ç³»ç»Ÿ</B><br>å¯ä»¥ä¸ºcgroupsä¸­çš„è¿›ç¨‹åˆ†é…å•ç‹¬çš„cpuèŠ‚ç‚¹æˆ–è€…å†…å­˜èŠ‚ç‚¹</li><li><B>memoryå­ç³»ç»Ÿ</B><br>å¯ä»¥é™åˆ¶è¿›ç¨‹çš„ </B><br>å¯ä»¥é™åˆ¶è¿›ç¨‹çš„å—è®¾å¤‡ io</li><li><B>deviceså­ç³»ç»Ÿ</B><br>å¯ä»¥æ§åˆ¶è¿›ç¨‹èƒ½å¤Ÿè®¿é—®æŸäº›è®¾å¤‡</li><li><B>net_clså­ç³»ç»Ÿ</B><br>å¯ä»¥æ ‡è®°cgroupsä¸­è¿›ç¨‹çš„ç½‘ç»œæ•°æ®åŒ…ï¼Œç„¶åå¯ä»¥ä½¿ç”¨tcæ¨¡å—(traffic control)å¯¹æ•°æ®åŒ…è¿›è¡Œæ§åˆ¶</li><li><B>freezerå­ç³»ç»Ÿ</B><br>å¯ä»¥æŒ‚èµ·æˆ–è€…æ¢å¤cgroupsä¸­çš„è¿›ç¨‹</li><li><B>nså­ç³»ç»Ÿ</B><br>å¯ä»¥ä½¿ä¸åŒcgroupsä¸‹é¢çš„è¿›ç¨‹ä½¿ç”¨ä¸åŒçš„namespace</li></ul><p><B>cgroups</B>æ˜¯é€šè¿‡ä¸å†…æ ¸çš„å…¶ä»–æ¨¡å—æ¥å®Œæˆ<B>è¿›ç¨‹ç»´åº¦</B>å¯¹<B>èµ„æº</B>çš„ç®¡ç†</p><h3 id="Namespace"><a class="header-anchor" href="#Namespace"></a>Namespace</h3><p><B>namespace</B>æ˜¯å¯¹å†…æ ¸èµ„æºè¿›è¡Œåˆ†ç»„ç®¡ç†çš„ä¸€ä¸ªç‰¹æ€§,ç”¨æ¥ä¿®æ”¹è¿›ç¨‹é—´çš„å¯è§æ€§</p><p>namespaceåˆ›å»ºè¿›ç¨‹æ—¶ä¼šä½¿ç”¨<B>CLONE_NEWPID</B>è¿™ä¸ªå‚æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ç©ºé—´</p><h3 id="è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«"><a class="header-anchor" href="#è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«"></a>è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«</h3><p>è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«åœ¨äºè™šæ‹Ÿæœºä¼šé‡‡ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ–åŠŸèƒ½,æ¨¡æ‹Ÿå‡ºæ“ä½œç³»ç»Ÿåº•å±‚çš„è®¾å¤‡;dockeråªæ˜¯åœ¨å®¿ä¸»æœºä¸Šåšäº†è¿›ç¨‹éš”ç¦»å’Œèµ„æºéš”ç¦»</p><h2 id="å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹éš”ç¦»å’Œé™åˆ¶"><a class="header-anchor" href="#å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹éš”ç¦»å’Œé™åˆ¶"></a>å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹éš”ç¦»å’Œé™åˆ¶</h2><p><img src="https://i.loli.net/2021/10/28/HNTkSg5vwd7jymf.jpg" alt="å®¹å™¨åŒ–ä¸è™šæ‹Ÿæœºä¹‹é—´çš„å¯¹æ¯”"></p><p>é€šè¿‡<B>namespace</B>æ¥å®Œæˆè¿›ç¨‹ä¹‹é—´çš„éš”ç¦»,é€šè¿‡<B>cgroups</B>æ¥å®Œæˆå¯¹èµ„æºçš„é™åˆ¶</p><p><B>cgroups</B>æ˜¯é€šè¿‡é…ç½®åœ¨<B>/sys/fs/cgroup</B>æ–‡ä»¶å¤¹ä¸‹ä¼šæœ‰</p><ul><li><p>èµ„æºåˆ†ç»„<br><img src="https://i.loli.net/2021/10/28/gUHWXSlaGd7Lpn8.jpg" alt="cgroupèµ„æºåˆ†ç»„"><br>è¿™äº›é™åˆ¶é¡¹æ¥è¿›è¡Œå¤„ç†</p></li><li><p>æ§åˆ¶ç»„<br><img src="https://i.loli.net/2021/10/28/PFv8caUqsLiYBpo.jpg" alt="cgroupè¯¦ç»†æ§åˆ¶"></p></li></ul><p>é€šè¿‡è¯¦ç»†ä¿¡æ¯å¯ä»¥çœ‹åˆ°è¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸åŒçš„é…ç½®æ–‡ä»¶<B>cgroup.procs</B>,å†…å®¹å¦‚ä¸‹å±•ç¤º</p><p><img src="https://z3.ax1x.com/2021/10/29/5jdCIx.jpg" alt="cgroup.procså†…å®¹"><br>å¯ä»¥çœ‹åˆ°è¿™é‡Œè®°å½•çš„å°±æ˜¯pidåˆ—è¡¨,<cgroup>å°±æ˜¯é€šè¿‡ç®¡ç†ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…èµ„æºçš„æ‰§è¡Œæ—¶é—´æ¥æ§åˆ¶ä¸åŒè¿›ç¨‹çš„èµ„æºä½¿ç”¨æƒ…å†µ</p><p>dockerå°±æ˜¯åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™ä¸ºæ¯ä¸€ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„,åœ¨å°†ç”¨æˆ·æŒ‡å®šçš„dockerå®¹å™¨åˆå§‹åŒ–èµ„æºé…ç½®å†™å…¥æ§åˆ¶ç»„ä¸­å°±å¯ä»¥äº†<br><B>cgroups</B>é‡‡ç”¨çš„èµ„æºé™åˆ¶æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡æ§åˆ¶æ—¶é—´çš„å½¢å¼æ¥å®ç°çš„,å› æ­¤å°±ä¼šå­˜åœ¨å®¹å™¨çš„è¿›ç¨‹å®é™…ä¸Šå¯ä»¥çœ‹åˆ°æ•´ä¸ªå®¿ä¸»æœºçš„ä¸€äº›çŠ¶æ€.è¿™æ˜¯ç›¸è¾ƒä¸è™šæ‹Ÿæœºæ–¹å¼çš„ä¸è¶³</p><blockquote><p><B>å®¹å™¨çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¿›ç¨‹</B></p></blockquote><h2 id="å®¹å™¨ä¸­é•œåƒçš„æ¦‚å¿µ"><a class="header-anchor" href="#å®¹å™¨ä¸­é•œåƒçš„æ¦‚å¿µ"></a>å®¹å™¨ä¸­é•œåƒçš„æ¦‚å¿µ</h2><blockquote><p>é•œåƒæŒ‡çš„æ˜¯ä¸€ä¸ªç”±å®¹å™¨è¯†åˆ«çš„åªè¯»æ¨¡æ¿.é€šå¸¸è¿™ä¸ªæ¨¡æ¿æ˜¯åŸºäºå¦å¤–çš„ä¸€ä¸ªæ¨¡æ¿å¹¶è¿›è¡Œä¸€äº›è‡ªå®šä¹‰æ”¹åŠ¨çš„</p></blockquote><p>ä»¥ä¸Šæ˜¯dockerå®˜ç½‘ä¸­å¯¹é•œåƒæ¦‚å¿µçš„æè¿°,é•œåƒåœ¨ç‰©ç†ä¸ŠæŒ‡çš„æ˜¯å®¹å™¨è¿›ç¨‹å®é™…å¯ç”¨çš„æ–‡ä»¶<br>é€šè¿‡<B>Namespace</B>å’Œ<B>cgroups</B>å®ç°äº†å¯¹è¿›ç¨‹å’Œæ“ä½œæ—¶é—´çš„éš”ç¦»,ä½†æ˜¯å®¹å™¨ä¹‹é—´æ²¡æœ‰å¯¹æ–‡ä»¶çš„éš”ç¦»,å®¹å™¨è¿›ç¨‹çš„å¯ç”¨æ–‡ä»¶ä¸å…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„å¯ç”¨æ–‡ä»¶ç›¸åŒ.<br>å› æ­¤éœ€è¦å¯¹å®¹å™¨çš„å¯ç”¨æ–‡ä»¶è¿›è¡Œé™åˆ¶,åœ¨dockerä¸Šæ˜¯ä¼˜å…ˆä½¿ç”¨<B>pivot_root</B>,å…¶æ¬¡ä½¿ç”¨<B>chroot</B></p><h3 id="pivot-rootä¸chrootçš„åŒºåˆ«"><a class="header-anchor" href="#pivot-rootä¸chrootçš„åŒºåˆ«"></a>pivot_rootä¸chrootçš„åŒºåˆ«</h3><ul><li><p>pivot_rootæ”¹å˜å½“å‰mount namespaceçš„rootfs(&quot;/&quot;ç›®å½•)</p></li><li><p>chrootæ”¹å˜çš„æ˜¯å½“å‰è¿›ç¨‹çš„rootfs(&quot;/&quot;ç›®å½•)</p></li></ul><p>pivot_rootçš„æ‰§è¡Œæ­¥éª¤åˆ†ä¸ºä¸‰æ­¥:</p><ol><li>åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å°†å½“å‰æ‰€æœ‰çš„root mountç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•</li><li>åˆ›å»ºæ–°ç›®å½•(â€œ/â€)</li><li>æ¸…ç†æ–°ç›®å½•</li></ol><h3 id="rootfs"><a class="header-anchor" href="#rootfs"></a>rootfs</h3><p><B>rootfs</B>æŒ‡çš„æ˜¯å°±æ˜¯é•œåƒä¸­çš„æ–‡ä»¶,ä¹Ÿå°±æ˜¯ç™»å½•åˆ°å…·ä½“çš„é•œåƒä¸­çœ‹åˆ°çš„æ–‡ä»¶.<B>rootfs</B>åœ¨ç»“æ„ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰å±‚<B>å¯è¯»å†™å±‚</B>ã€<br><B>initå±‚</B>ã€<B>åªè¯»å±‚</B></p><p>ä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯åº”ç”¨å±‚åˆ°ç³»ç»Ÿå±‚çš„åˆ’åˆ†,åœ¨è¯¦ç»†çš„å¯¹è¿™ä¸‰å±‚è¿›è¡Œåˆ†æä¹‹å‰éœ€è¦äº†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆé•œåƒæ–‡ä»¶ä¸­åˆ†å±‚çš„æ–‡ä»¶åœ¨ä½¿ç”¨çš„æ—¶å€™å¯ä»¥æƒ³åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ä¸€æ ·ï¼Ÿ<br>è¿™æ˜¯é‡‡ç”¨äº†ä¸€ç§è¢«ç§°ä¸ºè”åˆæ–‡ä»¶ç³»ç»Ÿ(union file System)æ¦‚å¿µ,dockerä¸­é»˜è®¤æ˜¯ä½¿ç”¨Overlay2çš„å®ç°ï¼Œå…³äºè”åˆæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ç« çœ‹å¯ä»¥å‚è€ƒ<br><a href="https://lwn.net/Articles/324291/">https://lwn.net/Articles/324291/</a></p><ul><li><p>å¯è¯»å†™å±‚<br>å¯è¯»å†™å±‚æ˜¯rootfsä¸­æœ€ä¸Šé¢çš„ä¸€å±‚ï¼Œæ˜¯æ‰¿è½½å®¹å™¨ä¸­æ–‡ä»¶è¯»å†™çš„æ“ä½œä¸€å±‚,åœ¨è¿™ä¸€å±‚ä¸­çš„æŒ‚è½½æ–¹å¼æ˜¯read + write</p></li><li><p>initå±‚<br>initå±‚æŒ‡çš„æ˜¯Dockeré¡¹ç›®ç”¨æ¥å­˜æ”¾å¯¹åº•å±‚æ“ä½œç³»ç»Ÿçš„æ”¹åŠ¨ä¿¡æ¯ä¾‹å¦‚â€™etc/hostsâ€™ã€â€˜etc/resolv.confâ€™ç­‰ï¼Œå› ä¸ºå®¹å™¨åœ¨å¯åŠ¨æ—¶å¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚initå±‚åœ¨æŒ‚è½½æ—¶æ˜¯é‡‡ç”¨â€™roâ€™ + 'whâ€™çš„æ–¹å¼ï¼Œ'roâ€™æŒ‡çš„æ˜¯read onley,'whâ€™æŒ‡çš„æ˜¯whiteout,å³åªè¯» + â€˜whiteoutâ€™,whiteoutæŒ‡çš„æ˜¯å¯¹æ–‡ä»¶çš„æ“ä½œä¼šåœ¨é€šè¿‡ä¸€å®šçš„æ‰‹æ®µè¿›è¡Œéšè—ï¼Œç±»ä¼¼ä¸javaä¸­çš„ä¸´æ—¶å˜é‡çš„æ¦‚å¿µï¼Œåªåœ¨å½“å‰å®¹å™¨ä¸­æœ‰æ•ˆï¼Œä¸ä¼šçœŸæ­£çš„ä¿®æ”¹åº•å±‚çš„æ–‡ä»¶</p></li><li><p>åªè¯»å±‚<br>åªè¯»å±‚æŒ‡çš„æ˜¯é•œåƒä¸­æœ€åº•å±‚çš„ç³»ç»Ÿé•œåƒå±‚ï¼Œå®ƒä»¬çš„æŒ‚è½½æ–¹å¼ä¹Ÿæ˜¯â€™roâ€™ + â€˜whâ€™</p></li></ul><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><p>dockerä¸­çš„é•œåƒé€šè¿‡è¿™ç§åˆ†å±‚æ„å»ºçš„æ–¹å¼å¤§å¤§çš„å‡å°‘äº†ä¼ ç»Ÿé•œåƒä¸­æ“ä½œç³»ç»Ÿçš„å¤§å°ï¼ŒåªåŒ…å«äº†å¯è¯»å†™å±‚ä¸­åº”ç”¨çš„éƒ¨åˆ†ã€‚åº•å±‚æ”¯æŒè¿™ç§æ„å»ºæ–¹å¼ä¸»è¦æ˜¯ä¾èµ–<B>chroot</B>(åˆ‡æ¢æ ¹ç›®å½•çš„èƒ½åŠ›)å’Œ<B>union file System</B>(è”åˆæ–‡ä»¶ç³»ç»Ÿ)</p><h2 id="æ€»ç»“-v2"><a class="header-anchor" href="#æ€»ç»“-v2"></a>æ€»ç»“</h2><p>dockerå®¹å™¨åŒ–çš„åŸºç¡€æ˜¯ä¸‰ä¸ªéƒ¨åˆ†</p><ul><li>Namespaceæä¾›çš„è¿›ç¨‹éš”ç¦»èƒ½åŠ›</li><li>Cgroupæä¾›çš„èµ„æºé™åˆ¶èƒ½åŠ›</li><li>rootfsçš„æ–‡ä»¶åˆ†å±‚ç»“æ„è®¾è®¡</li></ul><p><B>clone(true)/cgroup file/union file System</B></p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://tech.meituan.com/2015/03/31/cgroups.html">Linuxèµ„æºç®¡ç†ä¹‹cgroupsç®€ä»‹</a><br><a href="https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/">ä»€ä¹ˆæ˜¯å‘½åç©ºé—´å’Œcgroup,ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</a></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqç´¢å¼•å®ç°åŸç†ä¹‹IndexService</title>
      <link href="2021/10/13/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/15.rocketmq%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BIndexService/"/>
      <url>2021/10/13/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/15.rocketmq%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BIndexService/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqç´¢å¼•å®ç°åŸç†ä¹‹IndexService</h1><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­åˆ†æäº†æ¶ˆæ¯æ˜¯å¦‚æœé€šè¿‡Commitlogçš„é€»è¾‘è®¾è®¡åˆ°MappedFileçš„ä¸æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº¤ä»˜çš„è¿‡ç¨‹ï¼Œè¿™ç¯‡æ–‡ç« æ¥åˆ†ææ¶ˆæ¯ä½“æ˜¯å¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾çš„ä»¥åŠåº•å±‚å®ç°<br>RocketMQçš„ç´¢å¼•ç›¸å…³çš„å·¥ä½œéƒ½æ˜¯ç”±StoreåŒ…ä¸‹çš„<B>IndexService</B>å®ç°çš„,<B>IndexService</B>æ“ä½œçš„å¯¹è±¡æ˜¯<B>IndexFile</B>,ä¸‹é¢ä¸»è¦æ¥åˆ†æIndexFileçš„<B>åˆ›å»º</B>ã€<B>åŠ è½½</B>ã€<B>æ’å…¥</B>ã€<B>å†…å®¹</B>è¿‡ç¨‹ã€‚</p><h2 id="IndexFileæ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹</h2><p>åˆ›å»ºIndexç´¢å¼•æ–‡ä»¶çš„è¿‡ç¨‹çš„è§¦å‘ç‚¹æ˜¯åœ¨<B>load()</B>æ–¹æ³•ä¸­è¿›è¡Œè§¦å‘çš„,ä¸»è¦æ˜¯é€šè¿‡<B>IndexService.retryGetAndCreateIndexFile()</B>æ–¹æ³•æ‰§è¡Œçš„</p><ul><li>IndexService.retryGetAndCreateIndexFile</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">IndexFile</span> <span class="token function">retryGetAndCreateIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">IndexFile</span> indexFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">//1. é‡å¤å°è¯•åˆ›å»ºç´¢å¼•æ–‡ä»¶</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">null</span> <span class="token operator">==</span> indexFile <span class="token operator">&amp;&amp;</span> times <span class="token operator">&lt;</span> MAX_TRY_IDX_CREATE<span class="token punctuation">;</span> times<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//2.è·å–æˆ–åˆ›å»ºindexæ–‡ä»¶</span>        indexFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAndCreateLastIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> indexFile<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//çº¿ç¨‹ä¼‘çœ 1s,é‡æ–°å°è¯•åˆ›å»ºindexFileæ–‡ä»¶</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Tried to create index file fail. times: %s ,start sleep 1s"</span><span class="token punctuation">,</span> times<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Interrupted"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> indexFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getAccessRights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeIndexFileError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Mark index file cannot build flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> indexFile<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>retryGetAndCreateIndexFile()</B>æ–¹æ³•ä¸»è¦æ˜¯å¯¹æ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹æœ‰ä¸€ä¸ªé‡è¯•çš„æœºåˆ¶æ¥å°½é‡ä¿è¯<B>indexæ–‡ä»¶</B>çš„æˆåŠŸåˆ›å»º,å…·ä½“çš„åˆ›å»ºè¿‡ç¨‹å°±æ˜¯é€šè¿‡<br><B>getAndCreateLastIndexFile()</B>æ–¹æ³•æ¥è¿›è¡Œåˆ›å»º</p><ul><li>getAndCreateLastIndexFile()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * è·å–æˆ–åˆ›å»ºindexæ–‡ä»¶ */</span><span class="token keyword">private</span> <span class="token class-name">IndexFile</span> <span class="token function">getAndCreateLastIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–æˆå‘˜å˜é‡</span>    <span class="token class-name">IndexFile</span> indexFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token class-name">IndexFile</span> prevIndexFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> lastUpdateEndPhyOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> lastUpdateIndexTimestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//ä½¿ç”¨ä»£ç å—?</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//æ‰§è¡Œè¯»é”</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¦‚æœindexFileListä¸ä¸ºç©º</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è·å–æœ€åä¸€ä¸ªindexFile</span>            <span class="token class-name">IndexFile</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åˆ¤æ–­å½“å‰indexFileæ–‡ä»¶æ˜¯å¦å†™å…¥æ»¡é¢</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">.</span><span class="token function">isWriteFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å¦‚æœå†™å…¥æ»¡é¢çš„æ³•ç›´æ¥ä½¿ç”¨indexFile</span>                indexFile <span class="token operator">=</span> tmp<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å¦‚æœå†™å…¥æ»¡é¢å°±ä¼šæŸ¥è¯¢è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€æ¬¡å†™å…¥çš„offset</span>                lastUpdateEndPhyOffset <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getEndPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//æŸ¥è¯¢æœ€åä¸€æ¬¡æ›´æ–°çš„æ—¶é—´æˆ³</span>                lastUpdateIndexTimestamp <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//æ ‡è®°å½“å‰æ–‡ä»¶ä¸ºä¸Šä¸€ä¸ªä½¿ç”¨çš„ç´¢å¼•æ–‡ä»¶</span>                prevIndexFile <span class="token operator">=</span> tmp<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//é‡Šæ”¾é”æ“ä½œ</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//indexFileæ–‡ä»¶æ²¡æœ‰è·å–æˆåŠŸæ—¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è®¡ç®—index fileName æ ¼å¼ä¸ºyyyyMMddHHmmssSSS</span>            <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeIndexPath <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">timeMillisToHumanString</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ–°å»ºindexFileæ–‡ä»¶</span>            indexFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> lastUpdateEndPhyOffset<span class="token punctuation">,</span> lastUpdateIndexTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å ç”¨å†™é”</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"getLastIndexFile exception "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//é‡Šæ”¾å†™é”</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¯¹ä¸Šä¸€ä¸ªindexæ–‡ä»¶è¿›è¡Œåˆ·ç›˜æ“ä½œ</span>            <span class="token keyword">final</span> <span class="token class-name">IndexFile</span> flushThisFile <span class="token operator">=</span> prevIndexFile<span class="token punctuation">;</span>            <span class="token class-name">Thread</span> flushThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushThisFile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"FlushIndexFileThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            flushThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            flushThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> indexFile<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>getAndCreateLastIndexFile()</B>æ–¹æ³•ä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤</p><ul><li>æŸ¥è¯¢å¯ä»¥ä½¿ç”¨çš„indexFileæ–‡ä»¶</li><li>å¦‚æœæ²¡æœ‰indexæ–‡ä»¶å°±æ–°å»ºä¸€ä¸ªindexFileæ–‡ä»¶</li><li>å°è¯•å°†å·²ç»æ»¡é¢çš„indexFileæ–‡ä»¶åˆ·ç›˜</li></ul><h2 id="IndexFileæ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹</h2><p><B>IndexService</B>çš„åŠ è½½è¿‡ç¨‹æ˜¯ç”±<B>load()</B>æ–¹æ³•å®ç°çš„,è¿™ä¸ªæ–¹æ³•çš„è¢«è°ƒç”¨é“¾æ˜¯ç”±<br><B>BrokerController</B> -&gt; <B>DefaultMessageStore</B> -&gt; <B>IndexService</B></p><p><img src="https://i.loli.net/2021/10/17/KA9awWtHXcfGjRL.jpg" alt="IndexServiceè¢«è°ƒç”¨é“¾"><br><B>load()</B>æ„é€ æ–¹æ³•ä¸»è¦æ˜¯å¯¹åŸæœ‰çš„indexæ–‡ä»¶åˆ†æç„¶åç”ŸæˆIndexFileå¯¹è±¡çš„è¿‡ç¨‹</p><ul><li>load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1.æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨</span>    <span class="token class-name">File</span> dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeIndexPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//2.æŒ‰ç…§æ–‡ä»¶åç§°è¿›è¡Œå‡åº</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//3.æ ¹æ®indexæ–‡ä»¶åˆå§‹åŒ–indexFileå¯¹è±¡</span>                <span class="token class-name">IndexFile</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//3.åˆå§‹åŒ–indexFileå¯¹è±¡çš„å¤´æ–‡ä»¶ä¿¡æ¯</span>                f<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//4.åˆ¤æ–­ä¸Šæ¬¡æ˜¯å¦æ­£å¸¸é€€å‡ºï¼Œæœªæ­£å¸¸é€€å‡ºå¹¶ä¸”æ–‡ä»¶è®°å½•åœ¨æ—¥å¿—ä¿å­˜ç‚¹ä¹‹åçš„è¿›è¡Œèˆå¼ƒ</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastExitOK <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexMsgTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">//4.1 èˆå¼ƒæœªåˆ°ä¿å­˜ç‚¹çš„æ•°æ®</span>                    f<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load index file OK, "</span> <span class="token operator">+</span> f<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//5.å°†æ–‡ä»¶è£…è½½åˆ°indexFileListä¸­</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e <span class="token operator">|</span> <span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//çœç•¥...</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç å°±æ˜¯å¯¹ä¹‹å‰çš„indexFileæ–‡ä»¶è¿›è¡ŒåŠ è½½ï¼Œå¹¶ä¸”å¯¹åœ¨æ—¥å¿—ä¿å­˜ç‚¹ä¹‹åçš„æ•°æ®è¿›è¡ŒæŠ›å¼ƒã€‚</p><ul><li>IndexFile()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> indexNum<span class="token punctuation">,</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> endPhyOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> endTimestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è®¡ç®—indexæ–‡ä»¶å¤§å° = å¤´ä¿¡æ¯é•¿åº¦ + å“ˆå¸Œslotæ•°é‡*å“ˆå¸Œsloté•¿åº¦ + indexæ•°é‡*indexé•¿åº¦</span>    <span class="token keyword">int</span> fileTotalSize <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span>INDEX_HEADER_SIZE <span class="token operator">+</span> <span class="token punctuation">(</span>hashSlotNum <span class="token operator">*</span> hashSlotSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>indexNum <span class="token operator">*</span> indexSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºmappedFileå¯¹è±¡</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileTotalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¯¹å±æ€§è¿›è¡Œèµ‹å€¼</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getFileChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getMappedByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum <span class="token operator">=</span> hashSlotNum<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum <span class="token operator">=</span> indexNum<span class="token punctuation">;</span>    <span class="token comment">//å¤„ç†æ–‡ä»¶å¤´ä¿¡æ¯</span>    <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆå§‹åŒ–'ç©ºé—´ä½ç½®'å’Œ'æ—¶é—´ä½ç½®'</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>endPhyOffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>endTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>IndexFile()</B>æ–¹æ³•ä¼šæ ¹æ®æ–‡ä»¶åç§°åˆ›å»ºä¸€ä¸ªindexæ–‡ä»¶å¯¹è±¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ä¼šæ ¹æ®é…ç½®æ–‡ä»¶<B>è§£æ</B>ã€<B>åˆ›å»º</B>å¤´æ–‡ä»¶ä¿¡æ¯å¯¹è±¡<B>IndexHeader</B>è€Œä¸”è¿˜æ˜¯æ˜¯é€šè¿‡<B>MappedFile</B>å¯¹è±¡è¿›è¡Œå¤„ç†çš„</p><h2 id="IndexFileæ–‡ä»¶çš„æ’å…¥è¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„æ’å…¥è¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„æ’å…¥è¿‡ç¨‹</h2><p>IndexServiceå¯¹å¤–æä¾›æ’å…¥ç´¢å¼•çš„æ–¹æ³•æ˜¯<B>buildIndex</B>,buildIndex()æ˜¯é€šè¿‡<B>DefaultMessageStore</B>çš„<B>ReputMessageService</B>æ¥è¿›è¡Œè§¦å‘çš„</p><ul><li>ReputMessageService</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ReputMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceThread</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//çœŸæ­£å¯åŠ¨ç´¢å¼•ä»»åŠ¡å…¥å£</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//1.åˆ¤æ–­ç´¢å¼•çš„offsetæ˜¯å¦å°äºcommitLogä¸­æœ€å°çš„offset</span>        <span class="token comment">//2.åªå¤„ç†éœ€è¦è¿›è¡Œç´¢å¼•æ“ä½œçš„æ¶ˆæ¯</span>        <span class="token comment">//3.æ ¹æ®æ¶ˆæ¯ç»„è£…æ¶ˆæ¯åç½®å¤„ç†å™¨</span>        <span class="token comment">//4/5ã€‚å¤„ç†ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„å·®å¼‚</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doReput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨<B>ReputMessageService</B>å¯ä»¥çœ‹åˆ°æ˜¯ä½¿ç”¨ä¸€ä¸ªå¾ªç¯æ¯éš”1så»æŸ¥è¯¢ä¸€æ¬¡commitLogæ–‡ä»¶ä¸­éœ€è¦è¿›è¡Œåç½®å¤„ç†çš„æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†</p><h2 id="IndexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹</h2><p>å‰é¢ä»‹ç»äº†å¯¹indexFileæ–‡ä»¶çš„åˆ›å»ºã€åŠ è½½ã€å†™å…¥çš„è¿‡ç¨‹ï¼Œæ¥ä¸‹ä»‹ç»ä¸€ä¸‹indexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹</p><ul><li>è°ƒç”¨æµç¨‹</li></ul><pre class="line-numbers language-none"><code class="language-none">NettyRemotingServer -&gt; NettyRemotingAbstract -&gt; QueryMessageProcessor -&gt; DefaultMessageStore -&gt; IndexService -&gt; IndexFile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»¥ä¸Šæ˜¯è°ƒç”¨ç´¢å¼•æ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œä»Nettyçš„æœåŠ¡ç«¯åˆ°IndexFileæ–‡ä»¶çš„æ•´ä½“æµç¨‹ï¼Œå…·ä½“çš„æ‰§è¡Œæ–¹æ³•æ˜¯IndexFileæ–‡ä»¶ä¸­çš„selectPhyOffset()</p><ul><li>selectPhyOffset</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è®¡ç®—å‡ºindexFileæ–‡ä»¶ä¸­æ•°æ®çš„å…·ä½“ç‰©ç†ä½ç½®</span><span class="token keyword">int</span> keyHash <span class="token operator">=</span> <span class="token function">indexKeyHashMethod</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> slotPos <span class="token operator">=</span> keyHash <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">;</span><span class="token keyword">int</span> absSlotPos <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span>INDEX_HEADER_SIZE <span class="token operator">+</span> slotPos <span class="token operator">*</span> hashSlotSize<span class="token punctuation">;</span><span class="token comment">//æ ¹æ®å…·ä½“çš„ä½ç½®è¿›è¡Œå–æ•°æ“ä½œ</span><span class="token keyword">int</span> keyHashRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> phyOffsetRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> timeDiff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> prevIndexRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="IndexFileæ–‡ä»¶çš„å†…å®¹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„å†…å®¹"></a>IndexFileæ–‡ä»¶çš„å†…å®¹</h2><p>ç´¢å¼•æ–‡ä»¶æ˜¯æ”¾ç½®åœ¨<B>${rootpath}/index</B>ç›®å½•ä¸‹çš„ï¼Œæ–‡ä»¶åç§°æŒ‰ç…§yyyyMMddhhmmsssssçš„å½¢å¼è¿›è¡Œç”Ÿæˆï¼Œé»˜è®¤å¤§å°ä¸º400MB,ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ</p><ul><li>header</li><li>slot table</li><li>index linked list</li></ul><p>ç»“æ„å¦‚ä¸‹æ‰€ç¤º:</p><pre class="line-numbers language-none"><code class="language-none">|&lt;-- 40 byte --&gt;|&lt;---   500w   ---&gt;|&lt;---   2000w   ---&gt;|+---------------+------------------+-------------------+|    header     |   slot table     | index linked list |+---------------+------------------+-------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¦ç»†çš„æ•°æ®ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><h3 id="B-headerç»“æ„-B"><a class="header-anchor" href="#B-headerç»“æ„-B"></a><B>headerç»“æ„</B></h3><pre class="line-numbers language-none"><code class="language-none">+---------------------+--0| beginTimestampIndex |             ----&gt; ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä¿å­˜æ—¶é—´+---------------------+--8| endTimestampIndex   |             ----&gt; æœ€åä¸€æ¡æ¶ˆæ¯çš„ä¿å­˜æ—¶é—´+---------------------+--16| beginPhyoffsetIndex |             ----&gt; ç¬¬ä¸€æ¡æ¶ˆæ¯çš„åœ¨commitlogä¸­çš„åç§»é‡+---------------------+--24| endPhyoffsetIndex   |             ----&gt; æœ€åä¸€æ¡æ¶ˆæ¯çš„åœ¨commitlogä¸­çš„åç§»é‡+---------------------+--32| hashSlotcountIndex  |             ----&gt; å“ˆå¸Œæ§½æ•°é‡ï¼Œä¿å­˜æ·»åŠ åˆ°æœ¬æ§½åˆ—è¡¨çš„æœ€æ–°ç´¢å¼•ä½ç½®+---------------------+--36| indexCountIndex     |             ----&gt; ç´¢å¼•æ•°é‡ï¼Œå…·ä½“ç´¢å¼•æ•°æ®+---------------------+--40<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®ä»£ç å¯ä»¥å‚è€ƒ<B>IndexHeader</B>çš„é™æ€æˆå‘˜å˜é‡,ä»¥ä¸‹æ˜¯å±•ç¤ºç”¨ä¾‹</p><ul><li>IndexHeader</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INDEX_HEADER_SIZE <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> beginTimestampIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> endTimestampIndex <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> beginPhyoffsetIndex <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> endPhyoffsetIndex <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> hashSlotcountIndex <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> indexCountIndex <span class="token operator">=</span> <span class="token number">36</span><span class="token punctuation">;</span>    <span class="token comment">//æ’å…¥indexFileæ–‡ä»¶çš„å¼€å§‹æ—¶é—´</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeginTimestamp</span><span class="token punctuation">(</span><span class="token keyword">long</span> beginTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æœ¬åœ°ç¼“å­˜</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>beginTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æŒ‡å®šä½ç½®æ’å…¥æ—¶é—´æˆ³,beginTimestampIndexé»˜è®¤ä¸º0</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>beginTimestampIndex<span class="token punctuation">,</span> beginTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåˆå§‹åŒ–çš„é™æ€å˜é‡ä¼šåœ¨æ’å…¥å…·ä½“çš„å¤´æ–‡ä»¶å€¼æ—¶è¿›è¡Œä½¿ç”¨,å¯ä»¥å‚è€ƒ<B>setBeginTimestamp</B>æ–¹æ³•;<br>é€šè¿‡vscodeçš„hexdumpæ’ä»¶å¯ä»¥çœ‹åˆ°indexFileæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹</p><p><img src="https://i.loli.net/2021/11/04/jXilUC1O9em3v4P.jpg" alt="indexFileåŸå§‹æ–‡ä»¶"></p><p>å¯ä»¥çœ‹åˆ°å‰8ä¸ªå­—èŠ‚ä¸º<B>00 00 01 7C E9 D4 AA A5</B>,é€šè¿‡è®¡ç®—å™¨è½¬æ¢ä¸ºåè¿›åˆ¶ä¸º<B>1636010601125</B></p><p><img src="https://i.loli.net/2021/11/04/UHYsJqGEyrotCxP.jpg" alt="æ—¶é—´æˆ³"></p><p>æ—¶é—´æˆ³åœ¨è¿›è¡Œä¸€æ¬¡è½¬æ¢å¯ä»¥çœ‹åˆ°ä¸º<br><img src="https://i.loli.net/2021/11/04/UQqBHVZ4vliWNIs.jpg" alt="å¼€å§‹æ—¶é—´"></p><p>å‰©ä¸‹çš„endTimestampIndexã€beginPhyoffsetIndexã€beginPhyoffsetIndexã€endPhyoffsetIndexã€hashSlotcountIndexã€indexCountIndexä¿¡æ¯çš„å¤„ç†æ–¹å¼ä¸è¿™ä¸ªç±»ä¼¼ï¼Œä¸è¿›è¡Œé‡å¤äº†</p><h3 id="B-slot-tableç»“æ„-B"><a class="header-anchor" href="#B-slot-tableç»“æ„-B"></a><B>slot tableç»“æ„</B></h3><p><B>slot tableç»“æ„</B>æ˜¯å¯¹</p><h3 id="B-index-linked-listç»“æ„-B"><a class="header-anchor" href="#B-index-linked-listç»“æ„-B"></a><B>index linked listç»“æ„</B></h3><p><B>index linked list</B>çš„ç»“æ„æ˜¯åœ¨indexFileä¸Šçš„hashç´¢å¼•ä¹‹åç”¨å­˜æ”¾å®é™…çš„offsetçš„å€¼</p><p>ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><pre class="line-numbers language-none"><code class="language-none">+---------------------+--0| key hash            |             ----&gt; ä¼šæ ¹æ®Topicå’Œkeyçš„å€¼æ‹¼æ¥åœ¨ä¸€èµ·è®¡ç®—çš„ä¸€ä¸ªhashå€¼+---------------------+--4| commitLogOffset     |             ----&gt; commitLog Offsetæ˜¯commitLogæ–‡ä»¶ä¸Šçš„ä½ç½®+---------------------+--12| timeDiff            |             ----&gt; timeDiffæ˜¯å†™å…¥æ—¶çš„ç›¸å¯¹æ—¶é—´æˆ³+---------------------+--16| slotValue           |             ----&gt; slotValueè¡¨ç¤ºçš„æ˜¯è®°å½•å› ä¸ºhashå†²çªé€ æˆçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„ç›¸å¯¹ä½ç½®+---------------------+--20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1. å†™å…¥keyHash é•¿åº¦ä¸º4</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos<span class="token punctuation">,</span> keyHash<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2. å†™å…¥commitLogOffset é•¿åº¦ä¸º 8</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> commitLogOffset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3. å†™å…¥æ—¶çš„ç›¸å¯¹æ—¶é—´æˆ³ é•¿åº¦ä¸º 4</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> timeDiff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4. å†™å…¥slotValue é•¿åº¦ä¸º 4,è®°å½•å› ä¸ºhashå†²çªé€ æˆçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„ç›¸å¯¹ä½ç½®</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> slotValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//5.æ›´æ–°slotä¸Šçš„è®°å½•çš„hashæ§½ä½ä½¿ç”¨æ•°é‡</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absSlotPos<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>IndexFileæ–‡ä»¶æœ€ç²¾åçš„è®¾è®¡åœ¨äºå¯¹ç´¢å¼•æ•°æ®çš„åˆ†ç±»ï¼Œå¹¶ä¸”æŒ‰ç…§åˆ†ç±»å°†æ•°æ®ä¾æ¬¡å†™å…¥IndexFileæ–‡ä»¶ã€‚IndexFileæ–‡ä»¶åˆ†ä¸ºheaderã€Hash soltã€offsetä¸‰ç§ç±»å‹æ•°æ®</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://zjykzk.github.io/post/cs/rocketmq/store/">http://zjykzk.github.io/post/cs/rocketmq/store/</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
            <tag> IndexService </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>G1GCçš„ç®—æ³•ä¸å®ç°</title>
      <link href="2021/09/26/12.JVM/6.G1GC%E7%9A%84%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/"/>
      <url>2021/09/26/12.JVM/6.G1GC%E7%9A%84%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1>G1GCçš„ç®—æ³•ä¸å®ç°-ç®—æ³•ç¯‡</h1><p>æ ¹æ®ã€Šæ·±å…¥Javaè™šæ‹Ÿæœº-JVM G1GCçš„ç®—æ³•ä¸å®ç°ã€‹-ç®—æ³•ç¯‡æ•´ç†è€Œæ¥,è¯¥ç¯‡ä¸»è¦ç”±ä»¥ä¸‹ç« èŠ‚ç»„æˆ</p><ul><li>ç¬¬ä¸€ç«  G1GCæ˜¯ä»€ä¹ˆ?</li><li>ç¬¬äºŒç«  å¹¶å‘æ ‡è®°</li><li>ç¬¬ä¸‰ç«  è½¬ç§»</li><li>ç¬¬å››ç«  è½¯å®æ—¶æ€§</li><li>ç¬¬äº”ç«  åˆ†ä»£G1GCæ¨¡å¼</li><li>ç¬¬å…­ç«  ç®—æ³•ç¯‡æ€»ç»“</li></ul><h2 id="G1GCæ˜¯ä»€ä¹ˆ"><a class="header-anchor" href="#G1GCæ˜¯ä»€ä¹ˆ"></a>G1GCæ˜¯ä»€ä¹ˆ?</h2><blockquote><p>Garbage-First (G1) åƒåœ¾æ”¶é›†å™¨æ˜¯ä¸€ç§æœåŠ¡ç«¯çš„åƒåœ¾æ”¶é›†å™¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜å’Œå¤šå¤„ç†å™¨çš„æœºå™¨ã€‚å®ƒå°è¯•å°½é‡æ»¡è¶³ç”¨æˆ·è®¾å®šçš„åƒåœ¾æ”¶é›† (GC) æš‚åœæ—¶é—´ï¼ŒåŒæ—¶å®ç°é«˜ååé‡ã€‚GCæ“ä½œï¼ˆä¾‹å¦‚å…¨å±€æ ‡è®°ï¼‰ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚<br>è¿™æ˜¯JDKå®˜æ–¹å¯¹äºG1çš„å®šä¹‰,è¿™é‡Œä½œè€…æå‡ºä¸€ä¸ªç»“è®ºG1çš„ç‰¹ç‚¹æ˜¯éå¸¸éå¸¸çš„å…³æ³¨å®æ—¶æ€§,å¹¶ä¸”å®æ—¶æ€§åˆ†ä¸º<B>è½¯å®æ—¶æ€§</B>/<B>ç¡¬å®æ—¶æ€§</B><br>ç¡¬å®æ—¶æ€§æŒ‡çš„æ˜¯ç¡¬æ€§å¼ºåˆ¶è¦æ±‚çš„ï¼Œå¦‚æœè¾¾ä¸åˆ°æŒ‡å®šæ—¶é—´å°±ä¼šè¿”å›å¤±è´¥çš„å¤„ç†;<br>è½¯å®æ—¶æ€§æŒ‡çš„æ˜¯æŸ”æ€§çš„ï¼Œå¯¹äºè®¾å®šçš„æŒ‡å®šæ—¶é—´åªæ˜¯ä¸€ä¸ªæœŸæœ›ï¼Œä¸ä¼šåšå¼ºåˆ¶çš„è¦æ±‚é™åˆ¶;<br>é¢å¤–ä¸€ç‚¹æ˜¯<B>G1æ˜¯æ”¯æŒ4Gä»¥ä¸Šçš„å †å†…å­˜è¿›è¡Œåƒåœ¾æ”¶é›†</B></p></blockquote><h3 id="G1å‡ºç°çš„èƒŒæ™¯"><a class="header-anchor" href="#G1å‡ºç°çš„èƒŒæ™¯"></a>G1å‡ºç°çš„èƒŒæ™¯</h3><p>åœ¨G1å‡ºç°ä¹‹å‰çš„GCå¤„ç†å™¨ä¸»è¦æ˜¯é€šè¿‡å¢é‡GCæˆ–è€…æ˜¯å¹¶å‘GCæ¥æé«˜STWçš„æš‚åœæ—¶é—´ï¼Œä½†æ˜¯è¿™æ ·ç¼©çŸ­æ—¶é—´ä¼šé€ æˆååé‡ä¸‹é™ã€‚<br>G1çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³åœ¨æœŸæœ›çš„æš‚åœæ—¶é—´å‘¨å›´å°½é‡çš„å®Œæˆæ›´å¤§çš„GCååé‡ã€‚ç›®å‰GCçš„å…³æ³¨ç‚¹éƒ½æ˜¯åœ¨å°½å¯èƒ½çš„å‡å°‘æš‚åœæ—¶é—´ï¼Œè€Œä¸æ˜¯å¢å¤§ååé‡ä¸Šï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå †ä¸­çš„å¯¹è±¡å¤§å¤šå±äºæ˜¯æœç”Ÿå¤•æ­»çš„ç±»å‹</p><h3 id="G1çš„ç›®å‰çš„ç°çŠ¶"><a class="header-anchor" href="#G1çš„ç›®å‰çš„ç°çŠ¶"></a>G1çš„ç›®å‰çš„ç°çŠ¶</h3><p>G1åœ¨JDK9ä¸­å°±ä½œä¸ºé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨ï¼Œç°é˜¶æ®µG1åœ¨æœ€åä¸€æ¬¡å¢å¼ºæ˜¯åœ¨JDK14ä¸­å¢åŠ å¯¹NUMA(éç»Ÿä¸€å†…å­˜è®¿é—®)çš„å¢å¼ºã€‚åœ¨JDK14ä¸­æ–°å¢äº†ZGCæ”¶é›†å™¨ï¼Œå¹¶ä¸”é¢„è®¡å°†ZGCåœ¨æœªæ¥çš„JDKç‰ˆæœ¬ä¸­ä½œä¸ºé»˜è®¤GC</p><h2 id="G1GCçš„æ‰§è¡Œè¿‡ç¨‹"><a class="header-anchor" href="#G1GCçš„æ‰§è¡Œè¿‡ç¨‹"></a>G1GCçš„æ‰§è¡Œè¿‡ç¨‹</h2><p>æ‰€æœ‰GCåœ¨æ‰§è¡Œè¿‡ç¨‹å¯ä»¥éƒ½åˆ’åˆ†ä¸º</B>æ ‡è®°</B>å’Œ<B>æ•´ç†</B>ä¸¤ä¸ªå¤§çš„æ­¥éª¤ï¼Œä¸åŒçš„æ˜¯å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹ä¼šæœ‰å·®åˆ«</p><h3 id="G1GCçš„æ ‡è®°è¿‡ç¨‹"><a class="header-anchor" href="#G1GCçš„æ ‡è®°è¿‡ç¨‹"></a>G1GCçš„æ ‡è®°è¿‡ç¨‹</h3><p>G1GCçš„æ ‡è®°è¿‡ç¨‹æ˜¯<B>å¹¶å‘æ ‡è®°</B>,ä½†æ˜¯ç›®å‰çš„GCè¿˜åšä¸åˆ°å…¨å±€å¹¶å‘ï¼Œåªèƒ½åœ¨æŸäº›æ ‡è®°æ­¥éª¤ä¸­åšåˆ°å¹¶å‘ã€‚G1çš„æ ‡è®°è¿‡ç¨‹åˆ’åˆ†ä¸ºäº”ä¸ªæ­¥éª¤åˆ†åˆ«æ˜¯</p><ul><li>åˆå§‹æ ‡è®°é˜¶æ®µ</li><li>å¹¶å‘æ ‡è®°é˜¶æ®µ</li><li>æœ€ç»ˆæ ‡è®°é˜¶æ®µ</li><li>å­˜æ´»å¯¹è±¡è®¡æ•°é˜¶æ®µ</li><li>æ”¶å°¾å·¥ä½œ</li></ul><hr><ul><li><p>åˆå§‹åŒ–æ ‡è®°é˜¶æ®µ<br><b>åˆå§‹åŒ–æ ‡è®°é˜¶æ®µ</b>åªå¯¹<b>æ ¹å¼•ç”¨å¯¹è±¡</b>è¿›è¡Œæ ‡è®°è¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºæ ¹æ‰«æï¼Œç”±äºmutator(ç”¨æˆ·çº¿ç¨‹)ä¼šä¿®æ”¹æ ¹å¯¹è±¡å¼•ç”¨ï¼Œå› æ­¤åœ¨è€…ä¸€æ­¥æ˜¯éœ€è¦å°†mutatoræš‚åœä¸‹æ¥ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰é‡‡ç”¨è¯»/å†™å±éšœçš„æŠ€æœ¯æ¥å®ç°å¹¶å‘ä¸ªäººçŒœæµ‹æ˜¯å› ä¸ºmutatorä¼šé¢‘ç¹ä¿®æ”¹æ ¹å¯¹è±¡ï¼Œå› æ­¤åœ¨æ­¤å¤„ä¿è¯å¹¶å‘åçš„æ€§èƒ½æŸè€—è¿œè¿œå¤§äºé¡ºåºæ‰§è¡Œæ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚<br>åœ¨åˆå§‹åŒ–æ ‡è®°é˜¶æ®µåªä¼šå¯¹æ ¹å¼•ç”¨å¯¹è±¡è¿›è¡Œæ ‡è®°åˆ°ç‰¹å®šçš„å†…å­˜ä¸­ç§°ä¸º<b>æ ‡è®°ä½å›¾</b></p></li><li><p>å¹¶å‘æ ‡è®°é˜¶æ®µ<br><b>å¹¶å‘æ ‡è®°é˜¶æ®µ</b>çš„ç‰¹ç‚¹æ˜¯GCçº¿ç¨‹ä¸mutatorçº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œåœ¨mutatorçº¿ç¨‹ä¿®æ”¹æ ¹å¯¹è±¡å¼•ç”¨æ—¶ä¼šé‡‡ç”¨<b>å†™å±éšœ</b>æ¥è®°å½•å¯¹è±¡ä¹‹é—´å¼•ç”¨å…³ç³»çš„å˜åŒ–ã€‚<br>SATBæ˜¯è®°å½•å¯¹è±¡ä¹‹é—´é€»è¾‘å¼•ç”¨å…³ç³»çš„ç»“æ„ï¼Œå…¨ç§°ä¸ºSnapshot At The Beginning(åˆå§‹å¿«ç…§),åœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°å¯¹è±¡ä¼šä½œä¸ºâ€œå·²å®Œæˆæ‰«æå’Œæ ‡è®°â€çš„å¯¹è±¡ï¼Œåœ¨mutatorçº¿ç¨‹å‘ç”Ÿå¯¹æ ‡è®°å¯¹è±¡çš„ä¿®æ”¹æ—¶ï¼ŒSATBä¸“ç”¨å†™å±éšœä¹Ÿä¼šå°†è¯¥å¯¹è±¡è®°å½•åˆ°SATBé˜Ÿåˆ—ä¸­ã€‚SATBé˜Ÿåˆ—åœ¨å®ç°ä¸Šé‡‡ç”¨ä¸çº¿ç¨‹ç»‘å®šçš„å½¢å¼æ¥è¿›è¡Œï¼Œå½“é˜Ÿåˆ—è£…æ»¡æ—¶ï¼Œå°†ä¼šæ·»åŠ åˆ°å…¨å±€SATBé˜Ÿåˆ—ä¸­ã€‚</p></li></ul><p>log</p><blockquote><p>å¹¶å‘æŒ‡çš„æ˜¯æ›´å¤šçš„æŒ‡çš„æ˜¯è½¯ä»¶é¢†åŸŸçš„æ— åºæ‰§è¡Œï¼Œä¸åŒä»»åŠ¡ä¹‹é—´æ²¡æœ‰é¡ºåºå…³ç³»çš„ä¸€ç§è½¯ä»¶å¯åŠ¨æ–¹å¼</br>å¹¶è¡Œæ›´å¤šçš„æŒ‡çš„æ˜¯åœ¨ç¡¬ä»¶é¢†åŸŸä¸åŒæŒ‡ä»¤åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œçš„</p></blockquote><h2 id="å‚è€ƒæ–‡ç« "><a class="header-anchor" href="#å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://tech.meituan.com/2016/09/23/g1.html">https://tech.meituan.com/2016/09/23/g1.html</a><br><a href="https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html</a></p>]]></content>
      
      
      <categories>
          
          <category> jvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jvm </tag>
            
            <tag> G1 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹commitlog</title>
      <link href="2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/13.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8Bcommitlog/"/>
      <url>2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/13.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8Bcommitlog/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹commitlog</h1><p>åœ¨ä¹‹å‰çš„ã€Šrocketmqçš„å­˜å‚¨åŸç†ã€‹æ–‡ç« ä¸­åˆ†æäº†rocketmqçš„å­˜å‚¨è¿‡ç¨‹ä¸»è¦æ˜¯é€šè¿‡ä¸¤ä¸ªç±»æ¥å®ç°çš„åˆ†åˆ«æ˜¯commitlogå’ŒMappedFileï¼Œè¿™ç¯‡æ–‡ç« é‡ç‚¹åˆ†æcommitlogè¿™ä¸ªç±»çš„å®ç°</p><h2 id="åˆå§‹åŒ–è¿‡ç¨‹"><a class="header-anchor" href="#åˆå§‹åŒ–è¿‡ç¨‹"></a>åˆå§‹åŒ–è¿‡ç¨‹</h2><p>comitlogå¯¹è±¡æ˜¯é€šè¿‡ä¸‰ä¸ªæ–¹æ³•æ¥è´Ÿè´£åˆå§‹åŒ–å¤„ç†è¿‡ç¨‹åˆ†åˆ«æ˜¯æ„é€ æ–¹æ³•<b>commitLog()</b>/åŠ è½½æ–¹æ³•<b>load()</b>/å¯åŠ¨æ–¹æ³•<b>start()</b>,è¿™é‡Œå°†commitlogçš„å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹å’Œloadè¿‡ç¨‹ä»¥åŠå¯åŠ¨-startè¿‡ç¨‹éƒ½åˆ’åˆ†ä¸ºåˆå§‹åŒ–è¿‡ç¨‹ä¸­</p><h3 id="commitLog-æ„é€ æ–¹æ³•"><a class="header-anchor" href="#commitLog-æ„é€ æ–¹æ³•"></a>commitLog()æ„é€ æ–¹æ³•</h3><p>CommitLog()æ„é€ æ–¹æ³•çš„è°ƒç”¨é“¾å¦‚å›¾æ‰€ç¤º<br><img src="https://i.loli.net/2021/09/10/s2fcpiQdSHC8Tyv.png" alt="CommitLog()"><br>å¯ä»¥çœ‹åˆ°åœ¨Brokerå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šé€šè¿‡<B>DefaultMessageStore</B>æ¥è°ƒç”¨<B>Commitlog</B>æ„é€ æ–¹æ³•,commitlogçš„æ„é€ æ–¹æ³•ä¸»è¦æ˜¯åšåˆå§‹åŒ–æ—¥å¿—ç¯å¢ƒçš„åŠŸèƒ½ï¼Œä¸‹é¢è¯¦ç»†çš„çœ‹ä¸€ä¸‹<B>commitLog()</B>æ–¹æ³•çš„å®ç°</p><ul><li>CommitLogæ„é€ æ–¹æ³•</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DefaultMessageStore</span> defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1. åˆå§‹åŒ–æ–‡ä»¶ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„æ˜ å°„çš„queue</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getAllocateMappedFileService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2. è®¾ç½®é»˜è®¤çš„æ¶ˆæ¯å­˜å‚¨</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>    <span class="token comment">//3. è®¾ç½®åˆ·ç›˜ç­–ç•¥</span>    <span class="token comment">//TODO è¿™é‡Œçš„åˆ·ç›˜ç­–ç•¥'FlushCommitLogService'æ˜¯ä½¿ç”¨finalå…³é”®å­—è¿›è¡Œä¿®é¥°çš„ï¼Œåœ¨åˆå§‹åŒ–å®Œæˆä»¥åå°±ä¸å…è®¸æ›´æ–°åˆ·ç›˜ç­–ç•¥çš„ã€‚æš‚æ—¶è¿˜ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™æ ·åš</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FlushDiskType</span><span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è®¾ç½®åŒæ­¥åˆ·ç›˜ç­–ç•¥</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è®¾ç½®å¼‚æ­¥åˆ·ç›˜ç­–ç•¥</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//4. è®¾ç½®æ¶ˆæ¯æäº¤ç­–ç•¥ä¸ºå®æ—¶æäº¤,CommitRealTimeServiceç»§æ‰¿FlushCommitLogServiceå¹¶ä½œä¸ºé»˜è®¤çš„æäº¤ç­–ç•¥ï¼Œå…·ä½“å®ç°ç±»è¿˜æœ‰GroupCommitService/FlushRealTimeService</span>    <span class="token comment">//TODO è¿™é‡Œçš„æŠ½è±¡ä¸æ˜¯å¾ˆå¥½ï¼Œå°†æäº¤ç­–ç•¥é€šè¿‡å†…éƒ¨ç±»çš„æ–¹å¼æ¥éšè—å®ç°</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>commitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//5. è®¾ç½®é»˜è®¤å“åº”ç­–ç•¥</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAppendMessageCallback</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//6. åˆå§‹åŒ–æäº¤æ¶ˆæ¯çº¿ç¨‹</span>    putMessageThreadLocal <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">PutMessageThreadLocal</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//7. åˆå§‹åŒ–æäº¤æ¶ˆæ¯çš„é”ï¼ŒTODO  ä¼šæ ¹æ®é…ç½®åˆå§‹åŒ–å‡ºå¯é‡å…¥é”æˆ–è‡ªæ—‹é”??</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>putMessageLock <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUseReentrantLockWhenPutMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageSpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¥éª¤1~7æ˜¯åˆå§‹åŒ–æ—¥å¿—ç¯å¢ƒçš„å·¥ä½œï¼Œä¾æ¬¡æ˜¯</p><ul><li>åˆå§‹åŒ–messagequeue\messafestore</li><li>è®¾ç½®åˆ·ç›˜ç­–ç•¥ã€æäº¤ç­–ç•¥ã€å“åº”ç­–ç•¥</li><li>åˆå§‹åŒ–æäº¤çº¿ç¨‹æ± </li></ul><hr><h3 id="load-æ–¹æ³•"><a class="header-anchor" href="#load-æ–¹æ³•"></a>load()æ–¹æ³•</h3><p>åœ¨æ„é€ æ–¹æ³•å®Œæˆå<B>BrokerController</B>ä¼šç»§ç»­è°ƒç”¨<B>DefaultMessageStore</B>load()æ–¹æ³•,æ¥å¯¹<B>CommitLog</B>å¯¹è±¡è¿›è¡ŒåŠ è½½</p><ul><li>BrokerController.load</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//initialize()æ–¹æ³•æ‰§è¡ŒmessageåŠ è½½åŠ¨ä½œ</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//çœç•¥...</span>    result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//çœç•¥...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>DefaultMessageStore.load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> loadResult <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//1. é€šè¿‡æ˜¯å¦å­˜åœ¨ä¸´æ—¶æ–‡ä»¶åˆ¤æ–­æ˜¯å¦ä¸Šä¸€æ¬¡æ­£å¸¸é€€å‡º</span>        <span class="token keyword">boolean</span> lastExitOK <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTempFileExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"last shutdown &#123;&#125;"</span><span class="token punctuation">,</span> lastExitOK <span class="token operator">?</span> <span class="token string">"normally"</span> <span class="token operator">:</span> <span class="token string">"abnormally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//2. TODO è¿™é‡Œçš„åˆ¤æ–­æ˜¯å¤šä½™çš„</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> scheduleMessageService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//æ‰§è¡Œè°ƒåº¦</span>            loadResult <span class="token operator">=</span> loadResult <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//3. åŠ è½½CommitLog</span>        loadResult <span class="token operator">=</span> loadResult <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//4.åŠ è½½loadConsumeQueue</span>        loadResult <span class="token operator">=</span> loadResult <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//5.åˆ›å»ºæˆåŠŸåç»­æ“ä½œ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//åˆå§‹åŒ–æ–‡ä»¶å­˜å‚¨çš„æ£€æŸ¥å¯¹è±¡</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>storeCheckpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreCheckpoint</span><span class="token punctuation">(</span><span class="token class-name">StorePathConfigHelper</span><span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åŠ è½½indexçš„ç®¡ç†æœåŠ¡</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ ¹æ®ä¸Šæ¬¡æœåŠ¡æ˜¯å¦å¼‚å¸¸ä¸­æ–­è¿›è¡ŒçŠ¶æ€æ¢å¤</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load over, and the max phy offset = &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"load exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        loadResult <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åŠ è½½å¤±è´¥æ—¶,å…³é—­ TODO è¿™é‡Œå°±åªæœ‰æ–‡ä»¶æ˜ å°„æœåŠ¡(MappedFileService)éœ€è¦å…³é—­å—?</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> loadResult<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨DefaultMessageStore.loadçš„ç¬¬3æ­¥ä¼šå°†commitLogè¿›è¡ŒåŠ è½½,å…¶ä»–æ–¹æ³•æ˜¯å¯¹å¼‚å¸¸æ¢å¤ã€å»¶è¿Ÿæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœåŠ¡ã€ConsumerQueueè¿›è¡ŒåŠ è½½ã€‚<br>ä¸‹é¢ä»‹ç»ä¸€ä¸‹commitLog.loançš„åŠ è½½è¿‡ç¨‹</p><ul><li>CommitLog.load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åŠ è½½mappedFileQueue</span>    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load commit log "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>result <span class="token operator">?</span> <span class="token string">"OK"</span> <span class="token operator">:</span> <span class="token string">"Failed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°CommitLog.load()æ–¹æ³•å°±æ˜¯åŠ è½½<B>MappedFileQueue</B></p><ul><li>MappedFileQueue.load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åŠ è½½commit logæ–‡ä»¶ */</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//é»˜è®¤åœ°å€ä¸ºSystem.getProperty("user.home") + File.separator + "store" + File.separator + "commitlog"; @see org.apache.rocketmq.store.config.MessageStoreConfig.storePathCommitLog</span>    <span class="token class-name">File</span> dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶ä¸å­˜åœ¨æ—¶,ç›´æ¥è¿”å›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token operator">||</span> files<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¯¹æ–‡ä»¶æŒ‰ç…§å‡åºè¿›è¡Œæ’åº TODO è¿™é‡Œä¹Ÿæ˜¯å¤šä½™çš„æ–‡ä»¶çš„å‘½åè§„åˆ™æ˜¯æœ‰åº</span>    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//commitLogçš„æ–‡ä»¶å¤§å°é»˜è®¤ä¸º1G TODO è¿™ä¸ªå¤§å°æ˜¯ä»‹äºæ€§èƒ½å’Œå®¹é‡ä¹‹é—´çš„ä¸€ä¸ªé€‰æ‹©</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>file <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" length not matched message store config value, please check it manually"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è®¾ç½®MappedFileå¯¹è±¡ä¿¡æ¯</span>            <span class="token class-name">MappedFile</span> mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            mappedFile<span class="token punctuation">.</span><span class="token function">setWrotePosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            mappedFile<span class="token punctuation">.</span><span class="token function">setFlushedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            mappedFile<span class="token punctuation">.</span><span class="token function">setCommittedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å°†MappedFileå¯¹è±¡æ·»åŠ åˆ°mappedFilesï¼Œæ³¨æ„æ˜¯é€šè¿‡CopyOnWriteArrayListå®¹å™¨è¿›è¡Œä¿å­˜</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"CommitLog  call MappedFileQueue load &#123;&#125; :OK"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"CommitLog  call MappedFileQueue load &#123;&#125; :ERROR"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>mappedFiles.load()æ–¹æ³•ä¸»è¦é€šè¿‡æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„åŠ è½½æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶å¯¹è±¡é€šè¿‡CopyOnWriteArrayListå®¹å™¨è¿›è¡Œå­˜æ”¾<br>CopyOnWriteArrayListæ˜¯è¯»æ— é”-å†™æœ‰é”çš„å®¹å™¨ï¼Œå­˜å‚¨commitLogä¿¡æ¯</p><h3 id="start-æ–¹æ³•"><a class="header-anchor" href="#start-æ–¹æ³•"></a>start()æ–¹æ³•</h3><ul><li>commitLog.Start()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1.å¯åŠ¨åˆ·ç›˜çº¿ç¨‹</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2.åˆ¤æ–­æ˜¯å¦å¯åŠ¨å¼‚æ­¥æäº¤</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLogService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>commitLog.start()æ–¹æ³•ä¸»è¦æ˜¯å¯åŠ¨åˆ·ç›˜çº¿ç¨‹å’Œåˆ¤æ–­æ˜¯å¦å¯åŠ¨å¼‚æ­¥æäº¤</p><h2 id="è°ƒç”¨è¿‡ç¨‹"><a class="header-anchor" href="#è°ƒç”¨è¿‡ç¨‹"></a>è°ƒç”¨è¿‡ç¨‹</h2><p>CommitLogåº•å±‚æ˜¯é€šè¿‡<B>asyncPutMessage()</B>æ–¹æ³•æ¥å®ç°å¼‚æ­¥å‘æ–‡ä»¶ç³»ç»Ÿæäº¤çš„ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ ¹æ®asyncPutMessage()æ¥åˆ†æä»ä¸Šè‡³ä¸‹çš„è°ƒç”¨é“¾è¿‡ç¨‹</p><h3 id="è°ƒç”¨é“¾"><a class="header-anchor" href="#è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h3><p>é€šè¿‡Arthasåˆ†æ<B>asyncPutMessage()</B>çš„è°ƒç”¨è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</p><p><img src="https://i.loli.net/2021/09/13/rbDHVqyCkc8XJoj.jpg" alt="/è°ƒç”¨é“¾è·¯.jpg"></p><ul><li>arthas cmd</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">stack org.apache.rocketmq.store.CommitLog asyncPutMessage  -n <span class="token number">5</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»å›¾ä¸­å¯ä»¥çœ‹å¤„ç†æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ä»ç½‘ç»œI/Oåˆ°æ–‡ä»¶I/Oæ˜¯éå¸¸çŸ­çš„</p><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">@</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span>CommitLog<span class="token punctuation">.</span>asyncPutMessage<span class="token operator">(</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span>DefaultMessageStore<span class="token punctuation">.</span>asyncPutMessage<span class="token operator">(</span>DefaultMessageStore<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">435</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>SendMessageProcessor<span class="token punctuation">.</span>asyncSendMessage<span class="token operator">(</span>SendMessageProcessor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">314</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>SendMessageProcessor<span class="token punctuation">.</span>asyncProcessRequest<span class="token operator">(</span>SendMessageProcessor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">101</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>SendMessageProcessor<span class="token punctuation">.</span>asyncProcessRequest<span class="token operator">(</span>SendMessageProcessor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">82</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>NettyRemotingAbstract<span class="token operator">$</span>1<span class="token punctuation">.</span>run<span class="token operator">(</span>NettyRemotingAbstract<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">225</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>RequestTask<span class="token punctuation">.</span>run<span class="token operator">(</span>RequestTask<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">80</span><span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NettyRemotingAbstract -&gt; SendMessageProcessor -&gt; CommitLog ä¸‰ä¸ªç±»å°±å®Œæˆäº†å¤„ç†</p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹MappedFile</title>
      <link href="2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/14.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BMappedFile/"/>
      <url>2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/14.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BMappedFile/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹MappedFile</h1><p><B>MappedFile</B>æ˜¯RoketMqå¤„ç†åº•å±‚æ–‡ä»¶çš„ç±»,åœ¨ä¸Šé¢ä¸€ç¯‡æ–‡ç« ä¸­å·²ç»äº†è§£äº†å¦‚ä½•é€šè¿‡<B>CommitLog</B>ç±»æ¥å¤„ç†è¯·æ±‚ä»¥åŠå¦‚ä½•é€šè¿‡<B>MappedFile</B>æ¥å®ç°åº•å±‚å­˜å‚¨çš„<br><B>MappedFile</B>çš„æ•´ä½“é€»è¾‘æ˜¯</p><h2 id="MappedFile"><a class="header-anchor" href="#MappedFile"></a>MappedFile</h2>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nacosä½¿ç”¨æŒ‡å—</title>
      <link href="2021/09/05/17.Nacos/0.Nacos%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
      <url>2021/09/05/17.Nacos/0.Nacos%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h1>Nacosä½¿ç”¨æŒ‡å—</h1><p>Nacosçš„å®šä½æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œæ”¯æŒç›®å‰ä¸»æµçš„åˆ†å¸ƒå¼æ¶æ„K8S/RPC/RESTfulã€‚ä¸»è¦åŠŸèƒ½æœ‰</p><ul><li>æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹</li><li>åŠ¨æ€é…ç½®æœåŠ¡</li><li>åŠ¨æ€ DNS æœåŠ¡</li><li>æœåŠ¡åŠå…¶å…ƒæ•°æ®ç®¡ç†</li></ul><h2 id="æ„å»ºNacos"><a class="header-anchor" href="#æ„å»ºNacos"></a>æ„å»ºNacos</h2><h3 id="Nacos-docker"><a class="header-anchor" href="#Nacos-docker"></a>Nacos docker</h3><ul><li>cloneé¡¹ç›®</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/nacos-group/nacos-docker.git<span class="token builtin class-name">cd</span> nacos-docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å•æœºæ¨¡å¼ Derby</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker-compose -f example/standalone-derby.yaml up<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ³¨æ„ä¸€å®šè¦å¯åŠ¨docker desktopæˆ–è€…dockerè¿›ç¨‹ï¼Œç„¶åå°±ç»è¿‡æ¼«é•¿çš„ç¼–è¯‘ç¯èŠ‚ï¼Œç¼–è¯‘å®Œæˆådockeré•œåƒä¼šè‡ªåŠ¨å¯åŠ¨</p><p><img src="https://i.loli.net/2021/09/08/xpdPVki2fA18yh3.jpg" alt="/é•œåƒimage.jpg"></p><ul><li>æµ‹è¯•æœåŠ¡çŠ¶æ€</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -X POST <span class="token string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/09/08/yt43erZ8ED2SoBm.jpg" alt="/æœåŠ¡æ³¨å†Œ.jpg"><br>Nacosæä¾›çš„æœåŠ¡ä»¥RESTfulé£æ ¼è¿›è¡Œæä¾›ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡httpè¯·æ±‚è¿›è¡Œæ“ä½œ</p><h3 id="Nacos-Cons"><a class="header-anchor" href="#Nacos-Cons"></a>Nacos Cons</h3><ul><li>æœåŠ¡åœ°å€<br><a href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></li><li>è´¦å·/å¯†ç <br>nacos/nacos<br>è¿™ä¸ªè´¦å·/å¯†ç æ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ä¸­çš„ï¼Œå¯ä»¥è¿›è¡Œæ›´æ”¹</li></ul><p><img src="https://i.loli.net/2021/09/08/qSbWEAl1zR4Cpxa.jpg" alt="/nacos_admin.jpg"></p><h3 id="spring-bootç¤ºä¾‹"><a class="header-anchor" href="#spring-bootç¤ºä¾‹"></a>spring bootç¤ºä¾‹</h3><h4 id="é…ç½®ç®¡ç†"><a class="header-anchor" href="#é…ç½®ç®¡ç†"></a>é…ç½®ç®¡ç†</h4><ul><li>ConfigExample</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> serverAddr <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> dataId <span class="token operator">=</span> <span class="token string">"nacos.cfg.dataId1"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> group <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">;</span>    <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">PropertyKeyConst</span><span class="token punctuation">.</span>SERVER_ADDR<span class="token punctuation">,</span> serverAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºè¿æ¥</span>    <span class="token class-name">ConfigService</span> configService <span class="token operator">=</span> <span class="token class-name">NacosFactory</span><span class="token punctuation">.</span><span class="token function">createConfigService</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–é…ç½®</span>    <span class="token class-name">String</span> content <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content1:"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è®¾ç½®ç›‘å¬</span>    configService<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveConfigInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> configInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"recieve:"</span> <span class="token operator">+</span> configInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ¨é€é…ç½®</span>    <span class="token keyword">boolean</span> isPublishOk <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">publishConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>isPublishOk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    content <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content2:"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç§»é™¤é…ç½®</span>    <span class="token keyword">boolean</span> isRemoveOk <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">removeConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>isRemoveOk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    content <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content3:"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ³¨å†Œä¸­å¿ƒ"><a class="header-anchor" href="#æ³¨å†Œä¸­å¿ƒ"></a>æ³¨å†Œä¸­å¿ƒ</h4>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•ç¼–å†™JavaAgent</title>
      <link href="2021/07/03/12.JVM/5.%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99JavaAgent/"/>
      <url>2021/07/03/12.JVM/5.%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99JavaAgent/</url>
      
        <content type="html"><![CDATA[<h1>å¦‚ä½•ç¼–å†™JavaAgent</h1><p>è¿™ç¯‡æ–‡ç« æ˜¯æ ¹æ®MegaEaseçš„è¢ä¼Ÿè€å¸ˆçš„åˆ†äº«è€Œæ¥,åœ°å€æ˜¯<a href="https://www.youtube.com/watch?v=ujhqct2POLU">How To Write a JavaAgent</a></p><h2 id="ç®€ä»‹"><a class="header-anchor" href="#ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="java-agentæ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#java-agentæ˜¯ä»€ä¹ˆï¼Ÿ"></a>java agentæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>java agentæ˜¯jdk1.5æ—¶å€™æ¨å‡ºçš„ä¸€ä¸ªåœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹class,ä»è€Œè¾¾åˆ°åŠ¨æ€ä¿®æ”¹è¡Œä¸ºçš„ç›®çš„</p><h3 id="èƒ½åšä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#èƒ½åšä»€ä¹ˆï¼Ÿ"></a>èƒ½åšä»€ä¹ˆï¼Ÿ</h3><p>åŠŸèƒ½ä¸AOPç±»ä¼¼ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨ä¸å½»åº•å’Œä¸šåŠ¡ä»£ç éš”ç¦»ï¼Œå¯ä»¥å®ŒæˆAOPç›¸åŒçš„äº‹æƒ…ï¼Œå¹¶ä¸”ä¸å…¥ä¾µä¸šåŠ¡ä»£ç ï¼Œé€‚åˆäºæ—¥å¿—é‡‡é›†ã€é“¾è·¯è¿½è¸ªç­‰åŸºç¡€ç»„ä»¶</p><h2 id="ç”¨æ³•"><a class="header-anchor" href="#ç”¨æ³•"></a>ç”¨æ³•</h2><p>java agentä¸»è¦å¯ä»¥åœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹è¿›è¡ŒåŠ è½½ï¼š</p><ol><li>JVMå¯åŠ¨æ—¶</li><li>ç›®æ ‡æ–¹æ³•è¿è¡Œæ—¶</li></ol><h4 id="é¡¹ç›®ç»“æ„"><a class="header-anchor" href="#é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h4><p><img src="https://i.loli.net/2021/07/11/uUxsh1JqQzaSXAW.png" alt="é¡¹ç›®ç»“æ„"></p><h4 id="å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹"><a class="header-anchor" href="#å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹"></a>å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹</h4><ul><li>AgentExampleDemo</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentExampleDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"premain start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>AgentTarget</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentTarget</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>build.gradle</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">  //é‡æ–°å®šä¹‰MANIFEST.MF  jar <span class="token punctuation">&#123;</span>    manifest <span class="token punctuation">&#123;</span>        attributes <span class="token string">'Premain-Class'</span><span class="token builtin class-name">:</span> <span class="token string">'com.agmtopy.source.agent.AgentExampleDemo'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>javaagentå¯åŠ¨å‚æ•°</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-javaagent:build/libs/jvmsource-1.0-SNAPSHOT.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/07/11/kH6wQJD5my7bxuX.png" alt="Ideaè®¾ç½®"></p><ul><li>è¿è¡Œç»“æœ</li></ul><p><a href="https://imgtu.com/i/R7rfyV"><img src="https://z3.ax1x.com/2021/07/07/R7rfyV.png" alt="ç»“æœ"></a></p><blockquote><p>è¿™æ˜¯ç¬¬ä¸€ç§ä½¿ç”¨agentçš„æ–¹å¼,åœ¨ç›®æ ‡ä»£ç è¿è¡Œå‰ä½¿ç”¨,java agentä»£ç ä¸ç›®æ ‡æ–¹æ³•è¿›è¡Œç»„åˆçš„æ–¹å¼è¿›è¡Œæ‰§è¡Œ</p></blockquote><h3 id="è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹"><a class="header-anchor" href="#è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹"></a>è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹</h3><p>ç›®æ ‡æ–¹æ³•è¿œè¡Œæ—¶åŠ è½½è¦ä½¿ç”¨åˆ°javassistè¿™ä¸ªå·¥å…·å¸®åŠ©æˆ‘ä»¬ä¿®æ”¹class,æ³¨æ„javassistæœ‰ä¸¤ä¸ªé¡¹ç›®,è¦ä½¿ç”¨<b>org.javassist</b>ğŸ˜‚æ‰å¯ä»¥</p><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">implementation &quot;org.javassist:javassist:3.28.0-GA&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>ä¿®æ”¹AgentTarget</li></ol><p>ä¿æŒjvmè¿è¡Œ,ä»¥ä¾¿é€šè¿‡Attachçš„æ–¹å¼è¿›è¡Œæ›¿æ¢</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentTarget</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>åœ¨AgentExampleDemoä¸­å¢åŠ agentmainæ–¹æ³•</li></ol><ul><li>AgentExampleDemo</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * attach:æ–¹å¼è¿è¡Œ */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"agentmain start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´</span>    inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShowExecTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//é‡å†™è½½å…¥æ–°çš„å­—èŠ‚ç </span>        inst<span class="token punctuation">.</span><span class="token function">retransformClasses</span><span class="token punctuation">(</span><span class="token class-name">AgentTarget</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnmodifiableClassException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>å¢åŠ ShowExecTimeæ¥ä¿®æ”¹å­—èŠ‚ç </li></ol><ul><li>ShowExecTime</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** è‡ªå®šä¹‰ClassFileTransformer*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShowExecTime</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> classBeingRedefined<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åªé’ˆå¯¹ç›®æ ‡åŒ…ä¸‹è¿›è¡Œè€—æ—¶ç»Ÿè®¡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"com/agmtopy/source/agent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨åŠ è½½ç±»ï¼š"</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            classPool<span class="token punctuation">.</span><span class="token function">appendClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoaderClassPath</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">CtClass</span> cl <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// æ‰€æœ‰æ–¹æ³•ï¼Œç»Ÿè®¡è€—æ—¶</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CtMethod</span> method <span class="token operator">:</span> cl<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ä¿®æ”¹:"</span> <span class="token operator">+</span> method <span class="token operator">+</span><span class="token string">" æ–¹æ³•"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//éœ€è¦é€šè¿‡`addLocalVariable`æ¥å£°æ˜å±€éƒ¨å˜é‡</span>                method<span class="token punctuation">.</span><span class="token function">addLocalVariable</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token class-name">CtClass</span><span class="token punctuation">.</span>longType<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//æ’å…¥ å¼€å§‹è¯­å¥</span>                method<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">"start = java.lang.System.currentTimeMillis();"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getLongName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//åˆ›å»ºå¹¶æ’å…¥ æ‰“å°è¯­å¥ System.out.println("æ–¹æ³•ï¼štestï¼Œ æ‰§è¡Œæ—¶é—´ï¼š" + (System.currentTimeMillis() - start));</span>                <span class="token class-name">String</span> statement <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"java.lang.System.out.println(\"æ–¹æ³•ï¼š%sï¼Œ æ‰§è¡Œæ—¶é—´ï¼š\" + (java.lang.System.currentTimeMillis() - start));"</span><span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>                method<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformed <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> transformed<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>transform()æ–¹æ³•æ˜¯é€šè¿‡javassistæ¥ä¿®æ”¹å­—èŠ‚ç ,åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥å±€éƒ¨å˜é‡ï¼Œç„¶åæ‰“å°æ–¹æ³•æ‰§è¡Œè€—æ—¶</p><ol start="4"><li>è¿è¡Œjarè¿›è¡Œæ›¿æ¢å­—èŠ‚ç æ›¿æ¢</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * ä¿®æ”¹æŒ‡å®šè¿è¡Œä¸­çš„ä»£ç  */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ä¼ å…¥ç›®æ ‡ JVM pid</span>    <span class="token class-name">VirtualMachine</span> vm <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token string">"6068"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    vm<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">"D:\\project\\jvmsource\\build\\libs\\jvmsource-1.0-SNAPSHOT.jar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>ä¿®æ”¹MANIFEST.MF<br>éœ€è¦å°†<b>Agent-Class</b>å†™å…¥MANIFEST.MFæ–‡ä»¶</li></ol><ul><li>gradle</li></ul><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">jar &#123;    manifest &#123;        attributes &#39;Can-Redefine-Classes&#39;: true        attributes &#39;Can-Retransform-Classes&#39;: true        attributes &#39;Agent-Class&#39;: &#39;com.agmtopy.source.agent.AgentExampleDemo&#39;        attributes &#39;Premain-Class&#39;: &#39;com.agmtopy.source.agent.AgentExampleDemo&#39;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢</li></ol><p>6.1 å…ˆå°†é¡¹ç›®æ„å»ºæˆä¸ºjaråŒ…<br>6.2 è¿è¡ŒAgentTarget<br>ä¸éœ€è¦ä½¿ç”¨-javaagentçš„æ–¹å¼è¿›è¡Œå¯åŠ¨<br><img src="https://i.loli.net/2021/07/11/d3kZXA769yheB8L.png" alt="AgentTargetç»“æœ"><br>6.3 æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢</p><ul><li>è¿è¡Œç»“æœ<br><img src="https://i.loli.net/2021/07/11/bksIl8USHRMc72d.png" alt="è¿è¡Œç»“æœ"></li></ul><h2 id="æºç åˆ†æ"><a class="header-anchor" href="#æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>java agentçš„åŸç†æ ¹æ®åŠ è½½æ—¶æœºè¿˜æ˜¯å¯ä»¥åˆ†ä¸ºä¸¤ç±»å…¥å£ï¼Œä¸€ç±»æ˜¯å¯åŠ¨æ—¶å°†agent classæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šï¼Œå¦å¤–ä¸€ç±»å…¥å£æ˜¯è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼Œé‡‡ç”¨çš„æ˜¯JVM attachæŠ€æœ¯</p><h3 id="å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ"><a class="header-anchor" href="#å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ"></a>å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ</h3><h4 id="åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾"><a class="header-anchor" href="#åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾"></a>åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentExampleDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"premain start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ‰“å°è°ƒç”¨æ ˆ</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">StringBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" ClassName: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" Method Name : "</span> <span class="token operator">+</span> elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://i.loli.net/2021/07/07/f4o2qQryOKwpWPL.png" alt="è°ƒç”¨æ ˆ"></p><p>é€šè¿‡è°ƒç”¨æ ˆå¯ä»¥åˆ†æå‡ºæ˜¯<B>InstrumentationImpl</B>è°ƒç”¨<B>premain()</B>æ–¹æ³•çš„,ä¸‹é¢å¼€å§‹åˆ†æInstrumentationImpl</p><h4 id="InstrumentationImpl"><a class="header-anchor" href="#InstrumentationImpl"></a>InstrumentationImpl</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstrumentationImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Instrumentation</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><B>InstrumentationImpl</B>å®ç°<B>Instrumentation</B>,<B>Instrumentation</B>æ¥å£æ˜¯JVMå®šä¹‰å¯¹å­—èŠ‚ç æ“ä½œçš„æ¥å£ï¼Œæˆ‘ä»¬æŒ‰ç…§è°ƒç”¨é“¾çš„é¡ºåºå€’å™è¿›è¡Œåˆ†æï¼ˆæ‰§è¡Œã€è§¦å‘ï¼‰</p><ol><li>permainæ‰§è¡Œè¿‡ç¨‹åˆ†æ</li></ol><p>ç”±äº<B>InstrumentationImpl.loadClassAndCallPremain()</B>æ–¹æ³•å·²ç»æœ€é¡¶å±‚çš„javaä»£ç å…¥å£ï¼Œé€šè¿‡æ–¹æ³•åç§°æŸ¥æ‰¾å¯ä»¥åœ¨<B>JPLISAgent.h</B>æ–‡ä»¶ä¸­æŸ¥è¯¢åˆ°è¯¥æ–¹æ³•åç§°è¢«å®šä¹‰æˆä¸ºä¸€ä¸ªå¸¸é‡</p><ul><li>JPLISAgent.h</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">#define JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODNAME      &quot;loadClassAndCallPremain&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¯¥å¸¸é‡è¢«<B>JPLISAgent.c</B>çš„<B>createInstrumentationImpl</B>æ–¹æ³•æ‰€ä½¿ç”¨</p><ul><li>JPLISAgent.c</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">jboolean createInstrumentationImpl(JNIEnv *jnienv,JPLISAgent *agent)&#123;    &#x2F;&#x2F;çœç•¥....    &#x2F;* Now look up the method ID for the pre-main caller (we will need this more than once) *&#x2F;    if (!errorOutstanding)    &#123;        &#x2F;&#x2F;â‘ è·å–åˆ°è°ƒç”¨permainæ–¹æ³•MethodId        premainCallerMethodID &#x3D; (*jnienv)-&gt;GetMethodID(jnienv,                                                       implClass,                                                       JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODNAME,                                                       JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODSIGNATURE);    &#125;    if (!errorOutstanding)    &#123;        agent-&gt;mInstrumentationImpl &#x3D; resultImpl;        &#x2F;&#x2F;â‘¡æŒ‡é’ˆèµ‹å€¼        agent-&gt;mPremainCaller &#x3D; premainCallerMethodID;        agent-&gt;mAgentmainCaller &#x3D; agentmainCallerMethodID;        agent-&gt;mTransform &#x3D; transformMethodID;    &#125;        &#x2F;&#x2F;çœç•¥....    return !errorOutstanding;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µæ–¹æ³•ä¸»è¦æ˜¯åšä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€æ˜¯è·å–åˆ°è°ƒç”¨permainæ–¹æ³•MethodIdï¼›ç¬¬äºŒä»¶äº‹æ˜¯å°†è¿™ä¸ªMethodIdä¼ é€’å‡ºå»,åˆ†æmPremainCallerçš„ä½¿ç”¨å¯ä»¥å¾—åˆ°è¯¥å€¼åœ¨â€™processJavaStartâ€™ä¸­ä½¿ç”¨</p><p><img src="https://i.loli.net/2021/07/07/WbT3LyNCQilShcv.png" alt="mPremainCaller"></p><ul><li>processJavaStart</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">result &#x3D; startJavaAgent(agent, jnienv,                        agent-&gt;mAgentClassName,                         agent-&gt;mOptionsString,                        agent-&gt;mPremainCaller);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>processJavaStarté€šè¿‡å‰é¢è·å–åˆ°çš„MethodIdå¯åŠ¨javaAgentï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ<B>statrJavaAgent</B></p><ul><li>statrJavaAgent</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//...</span>success <span class="token operator">=</span> <span class="token function">invokeJavaAgentMainMethod</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span>                                    agent<span class="token operator">-></span>mInstrumentationImpl<span class="token punctuation">,</span>                                    agentMainMethod<span class="token punctuation">,</span>                                    classNameObject<span class="token punctuation">,</span>                                    optionsStringObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨</B>invokeJavaAgentMainMethod</B>ä¼ å…¥å¯¹è±¡ã€æ–¹æ³•IDã€å®å‚ï¼Œæ‰§è¡Œå®šä¹‰çš„premainæ–¹æ³•</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æçŸ¥é“äº†permaiæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œç»§ç»­çœ‹ä¸€ä¸‹permainæ–¹æ³•æ˜¯å¦‚ä½•è§¦å‘çš„</p><ol start="2"><li>permainè§¦å‘è¿‡ç¨‹åˆ†æ</li></ol><p><B>processJavaStart</B>æ–¹æ³•æ˜¯æ‰§è¡Œpermainçš„å…¥å£ï¼Œå®ƒåœ¨<B>JPLISAgent.h</B>ä¸­è¿›è¡Œå®šä¹‰çš„,åœ¨æºä»£ç ä¸­å…¨å±€æœç´¢ï¼š<B> JPLISAgent *</B>å¯ä»¥æ‰¾åˆ°JPLISAgentæ˜¯åœ¨&lt;InvocationAdapter.c&gt;ä¸­é‡æ–°è¿›è¡Œè¿‡èµ‹å€¼</p><ul><li>InvocationAdapter.c</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">void JNICALL eventHandlerVMInit(jvmtiEnv *jvmtienv,                    JNIEnv *jnienv,                    jthread thread)  &#123;      JPLISAgent *agent &#x3D; environment-&gt;mAgent;  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>eventHandlerVMInit</B>æ–¹æ³•åœ¨<B>JPLISAgent.c</B>çš„<B>initializeJPLISAgent</B>æ–¹æ³•ä¸­è¢«è®¾ç½®ä¸ºå›è°ƒæ–¹æ³•</p><ul><li>initializeJPLISAgent</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F;å…³é”®æ‰§è¡Œé€»è¾‘if (jvmtierror &#x3D;&#x3D; JVMTI_ERROR_NONE)&#123;    jvmtiEventCallbacks callbacks;    memset(&amp;callbacks, 0, sizeof(callbacks));    &#x2F;&#x2F;è®¾ç½®JVMå›è°ƒ    callbacks.VMInit &#x3D; &amp;eventHandlerVMInit;    jvmtierror &#x3D; (*jvmtienv)-&gt;SetEventCallbacks(jvmtienv,                                                &amp;callbacks,                                                sizeof(callbacks));    check_phase_ret_blob(jvmtierror, JPLIS_INIT_ERROR_FAILURE);    jplis_assert(jvmtierror &#x3D;&#x3D; JVMTI_ERROR_NONE);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–JPLISAgentæ—¶å€™å°±è®¾ç½®äº†JVMåˆå§‹åŒ–å®Œæˆåä¼šå›è°ƒInvocationAdapteræ¥æ‰§è¡Œ<B>permain</B>æ–¹æ³•</p><ol start="3"><li>JPLISAgentçš„åˆå§‹åŒ–</li></ol><p>å›æº¯<B>initializeJPLISAgent</B>æ–¹æ³•å¯ä»¥æ‰¾åˆ°åˆ†åˆ«åœ¨<B>InvocationAdapter.c</B>çš„<B>DEF_Agent_OnLoad</B>ã€<B>DEF_Agent_OnAttach</B>ä¸Šè¢«è°ƒç”¨ã€‚è¿™ä¸¤ç§æ–¹å¼ä¹Ÿæ­£æ˜¯å‰é¢è®²åˆ°çš„agentçš„ä¸¤ç§å¢å¼ºæ–¹å¼çš„å…¥å£ã€‚</p><p>åœ¨JVMå¯åŠ¨æ—¶æœ€å¼€å§‹åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢æ‰¾åˆ°JVMTIçš„å…¥å£æ–¹æ³•ï¼šAgent_OnLoadå’ŒAgent_OnAttachã€‚InvocationAdapter.cçš„å®šä¹‰</p><ul><li>InvocationAdapter.c</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;**  This will be called once for every -javaagent on the command line.*  Each call to Agent_OnLoad will create its own agent and agent data.**  The argument tail string provided to Agent_OnLoad will be of form*  &lt;jarfile&gt;[&#x3D;&lt;options&gt;]. The tail string is split into the jarfile and*  options components. The jarfile manifest is parsed and the value of the*  Premain-Class attribute will become the agent&#39;s premain class. The jar*  file is then added to the system class path, and if the Boot-Class-Path*  attribute is present then all relative URLs in the value are processed*  to create boot class path segments to append to the boot class path.*&#x2F;JNIEXPORT jint JNICALLDEF_Agent_OnLoad(JavaVM *vm, char *tail, void *reserved)&#x2F;**  This will be called once each time a tool attaches to the VM and loads*  the JPLIS library.*&#x2F;JNIEXPORT jint JNICALLDEF_Agent_OnAttach(JavaVM *vm, char *args, void *reserved)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>æ•´ä½“é€»è¾‘<br>æ•´ä½“çš„æ‰§è¡Œé€»è¾‘å°±æ˜¯ï¼š</li></ol><ul><li>JPLISAgentå£°æ˜JVMå¯åŠ¨æ—¶å€™åˆå§‹åŒ–JPLISAgent</li><li>JPLISAgentåˆå§‹åŒ–æ—¶è®¾ç½®InvocationAdapterçš„å›è°ƒæ–¹æ³•</li><li>JVMåˆå§‹åŒ–å®Œæˆåæ‰§è¡Œå›è°ƒæ–¹æ³•</li><li>InvocationAdapterçš„å›è°ƒæ–¹æ³•æ‰§è¡Œpermainæ–¹æ³•</li></ul><h3 id="è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ"><a class="header-anchor" href="#è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ"></a>è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ</h3><ol><li>åˆ†æå­—èŠ‚ç <br>ä½¿ç”¨<B>HSDB</B>æŸ¥çœ‹AgentTargetæœªè¿›è¡Œå­—èŠ‚ç æ›¿æ¢å‰çš„æ•°æ®</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">jhsdb hsdb --pid <span class="token number">21656</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¸¸é‡æ± </li></ul><p><img src="https://i.loli.net/2021/07/11/phklzJKYTs7IG16.jpg" alt="æ›¿æ¢å‰çš„å¸¸é‡æ± "></p><p><img src="https://i.loli.net/2021/07/11/tkaOxIQ62fbs84K.png" alt="æ›¿æ¢åçš„å¸¸é‡æ± "><br>æ˜æ˜¾å¯ä»¥çœ‹åˆ°å¸¸é‡æ± ä¸­å¢åŠ äº†22æ¡æŒ‡ä»¤ï¼Œè¿™22æ¡æŒ‡ä»¤å°±æ˜¯æ–°åŠ å…¥çš„å­—èŠ‚ç æ‰€è¦ä½¿ç”¨åˆ°çš„å¸¸é‡</p><ul><li>æ–¹æ³•åŒº</li></ul><p><img src="https://i.loli.net/2021/07/11/3DvWBpyuHQ7I2cM.jpg" alt="æ›¿æ¢å‰çš„æ–¹æ³•åŒº"></p><p><img src="https://i.loli.net/2021/07/11/e9TObiVwDPH7Whv.jpg" alt="æ›¿æ¢åçš„æ–¹æ³•åŒº"></p><ol start="2"><li>é‡æ–°åŠ è½½å­—èŠ‚ç åŸç†<br>@TODO</li></ol><blockquote><p>é€šè¿‡å­—èŠ‚ç å¯¹æ¯”å¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºåœ¨ä½¿ç”¨<B>Instrumentation.addTransformer();</B>åç¡®å®å°†å­—èŠ‚ç è¿›è¡Œäº†ä¿®æ”¹,å…¶å®ä¿®æ”¹å­—èŠ‚ç è¿˜æ˜¯æœ‰ä¸¤ä¸ªæ—¶æœº:</p></blockquote><ul><li>ä¸€ä¸ªæ˜¯åœ¨å¯åŠ¨ç¼–è¯‘æ—¶,ä¼šåœ¨jvmå¯åŠ¨å®Œæ¯•ååœ¨æ‰§è¡Œpermainæ–¹æ³•æ¥ä¿®æ”¹å­—èŠ‚ç </li><li>ä¸€ä¸ªå°±æ˜¯åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€çš„ä¿®æ”¹å­—èŠ‚ç </li></ul><h3 id="æ•´ä½“æ‰§è¡Œé€»è¾‘"><a class="header-anchor" href="#æ•´ä½“æ‰§è¡Œé€»è¾‘"></a>æ•´ä½“æ‰§è¡Œé€»è¾‘</h3><p><img src="https://i.loli.net/2021/07/11/sCey6D7USV9LRXo.jpg" alt="æ•´ä½“æ‰§è¡Œé€»è¾‘"></p><h2 id="å¼€å‘å·¥å…·"><a class="header-anchor" href="#å¼€å‘å·¥å…·"></a>å¼€å‘å·¥å…·</h2><ul><li><p>ASM</p></li><li><p>Javassist</p></li><li><p>Byte Buddy</p></li></ul><h3 id="åŠŸèƒ½å¯¹æ¯”"><a class="header-anchor" href="#åŠŸèƒ½å¯¹æ¯”"></a>åŠŸèƒ½å¯¹æ¯”</h3><table><thead><tr><th>-</th><th>ASM</th><th>Javassist</th><th>Byte Buddy</th></tr></thead><tbody><tr><td>å­¦ä¹ æˆæœ¬</td><td>é«˜</td><td>ä½</td><td>ä½</td></tr><tr><td>ä½¿ç”¨æ–¹æ³•</td><td>ä½¿ç”¨å­—èŠ‚ç æ–¹å¼è¿›è¡Œæ’å…¥,éœ€è¦äº†è§£classç±»ç»“æ„å’ŒJVMæŒ‡ä»¤é›†</td><td>æä¾›é«˜çº§æŠ½è±¡æ¥å£å’Œä½çº§å­—èŠ‚ç æ¥å£</td><td>åŒJavassist,å¹¶ä¸”æä¾›å£°æ˜å¼æ¥å£</td></tr><tr><td>æ€§èƒ½</td><td>æå¿«</td><td>ä¸€èˆ¬</td><td>å¿«</td></tr></tbody></table><p>è¯¦ç»†çš„å¯¹æ¯”å¯å‚è€ƒbyteBuddyå®˜æ–¹èµ„æ–™:<a href="https://bytebuddy.net/#/tutorial">https://bytebuddy.net/#/tutorial</a></p><h3 id="Byte-Buddy"><a class="header-anchor" href="#Byte-Buddy"></a>Byte Buddy</h3><h4 id="ç¤ºä¾‹"><a class="header-anchor" href="#ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><ul><li>gradle</li></ul><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">&#x2F;&#x2F;ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º1.11.6implementation &quot;net.bytebuddy:byte-buddy:LATEST&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>AgentExampleForByteBuddy</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentExampleForByteBuddy</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Advice.OnMethodEnter</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Advice.Origin</span> <span class="token class-name">Executable</span> method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"byte buddy before : "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Advice.OnMethodExit</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Advice.Origin</span> <span class="token class-name">Executable</span> method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"byte buddy after : "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> arguments<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰§è¡Œ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">AgentBuilder<span class="token punctuation">.</span>RedefinitionStrategy</span><span class="token punctuation">.</span>RETRANSFORMATION<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">AgentBuilder<span class="token punctuation">.</span>InstallationListener<span class="token punctuation">.</span>StreamWriting</span><span class="token punctuation">.</span><span class="token function">toSystemError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">"AgentTarget"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> td<span class="token punctuation">,</span> cl<span class="token punctuation">,</span> m<span class="token punctuation">)</span> <span class="token operator">-></span> builder<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">Advice</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">AgentExampleForByteBuddy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token class-name">MethodDescription</span><span class="token operator">::</span><span class="token function">isConstructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>AgentTarget</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentTarget</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">AgentTarget</span> agentTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        agentTarget<span class="token punctuation">.</span><span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"123"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ¼”ç¤ºçš„æ˜¯ä¸€ä¸ªé‡å†™åŠ è½½ç±»çš„ç¤ºä¾‹:</p><ol><li>é€šè¿‡</B>@Advice.OnMethodEnter</B>å’Œ<B>@Advice.OnMethodExit</B>å®šä¹‰æ‰§è¡Œæ–¹æ³•å‰åæ’å…¥çš„å­—èŠ‚ç </li><li>é€šè¿‡<B>AgentBuilder</B>æŒ‡å®šè¦å¢å¼ºçš„ç±»å’Œç±»å‹</li><li><B>AgentBuilder.with</B>å¯ä»¥æ·»åŠ ç›‘å¬ï¼Œæ–¹ä¾¿è¾“å‡ºè°ƒè¯•</li></ol><h3 id="Byte-Byddyå¸¸è§é—®é¢˜"><a class="header-anchor" href="#Byte-Byddyå¸¸è§é—®é¢˜"></a>Byte Byddyå¸¸è§é—®é¢˜</h3><ul><li>ä¾èµ–å†²çª</li></ul><p>å¤„ç†æ–¹æ¡ˆï¼š</p><ol><li><p>æ„å»ºå·¥å…·æ’é™¤</p></li><li><p>ä½¿ç”¨è‡ªå®šä¹‰classLoaderåŠ è½½agentæ‰€ä½¿ç”¨çš„ç±»<br>é€šè¿‡æŒ‡å®šagentç±»çš„åŠ è½½å™¨,è®©</B>BootstrapClassLoader</B>å»åŠ è½½</p></li></ol><ul><li>Byte-Buddyæä¾›çš„API</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ClassInjector<span class="token punctuation">.</span>UsingInstrumentation</span>         <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">FileJar</span><span class="token punctuation">,</span> <span class="token class-name">ClassInjector<span class="token punctuation">.</span>UsingInstrumentation<span class="token punctuation">.</span>Target</span><span class="token punctuation">.</span>BOOTSTRAP<span class="token punctuation">,</span> instrumentation<span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">injectRaw</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">,</span> <span class="token class-name">ClassFileLocator                 <span class="token punctuation">.</span>ForClassLoader</span><span class="token punctuation">.</span><span class="token function">ofSystemLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token punctuation">.</span><span class="token function">locate</span><span class="token punctuation">(</span><span class="token string">"com.agmtopy.source.agent.AgentExampleForByteBuddy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>java agentä¸­ä¼ å‚</li></ul><p>å¤„ç†æ–¹æ¡ˆ:</p><ol><li>ThreadLocal</li><li>å¢åŠ ä¸´æ—¶çš„æˆå‘˜å˜é‡</li></ol><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://asm.ow2.io/">https://asm.ow2.io/</a><br><a href="https://www.javassist.org/">https://www.javassist.org/</a><br><a href="https://bytebuddy.net/#/">https://bytebuddy.net/#/</a><br><a href="https://blog.csdn.net/wanxiaoderen/article/details/107079741">https://blog.csdn.net/wanxiaoderen/article/details/107079741</a><br><a href="https://www.cnblogs.com/old-cha/p/13264114.html">https://www.cnblogs.com/old-cha/p/13264114.html</a><br><a href="https://www.cnblogs.com/chiangchou/p/javassist.html#_label9">https://www.cnblogs.com/chiangchou/p/javassist.html#_label9</a><br><a href="https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html">https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html</a><br><a href="https://github.com/gzzchh/de-ag">https://github.com/gzzchh/de-ag</a><br><a href="https://gitee.com/mazhimazh/bytecode-examples">https://gitee.com/mazhimazh/bytecode-examples</a></p>]]></content>
      
      
      <categories>
          
          <category> jvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jvm </tag>
            
            <tag> agent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡WSL2ç¼–è¯‘JDKæºç </title>
      <link href="2021/06/19/1.%E6%9D%82%E8%AE%B0/%E9%80%9A%E8%BF%87WSL2%E7%BC%96%E8%AF%91JDK%E6%BA%90%E7%A0%81/"/>
      <url>2021/06/19/1.%E6%9D%82%E8%AE%B0/%E9%80%9A%E8%BF%87WSL2%E7%BC%96%E8%AF%91JDK%E6%BA%90%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h1>é€šè¿‡WSL2ç¼–è¯‘JDKæºç </h1><p>WSLçš„å…¨ç§°æ˜¯â€™Windows Subsystem for Linuxâ€™,é€šè¿‡åœ¨ç³»ç»Ÿå±‚é¢å¯¹Linuxå†…æ ¸è¿›è¡Œæ”¯æŒ,WSL1åªæ˜¯éƒ¨åˆ†æ”¯æŒLinuxå†…æ ¸è€ŒWSL2æ”¯æŒå®Œæ•´çš„Linuxå†…æ ¸ã€‚ä¸ä½†å¯ä»¥é€šè¿‡WSLè¿è¡ŒLinuxå†…æ ¸ï¼Œç”šè‡³å¯ä»¥å°†Windows DockeræŒ‡å®šé€šè¿‡WSL2æ¥è¿›è¡Œè¿œè¡Œ</p><h2 id="WSL1-WSL2"><a class="header-anchor" href="#WSL1-WSL2"></a>WSL1 -&gt; WSL2</h2><ul><li><p>å®‰è£…Linuxå‘è¡Œç‰ˆ<br>WSL1åªéœ€è¦å¼€å¯Linuxå­ç³»ç»Ÿå¹¶ä¸‹è½½linuxå‘è¡Œç‰ˆå³å¯,linuxå‘è¡Œç‰ˆé»˜è®¤æ˜¯åªèƒ½é€šè¿‡Windows Storeè¿›è¡Œä¸‹è½½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹è½½å®‰è£…åŒ…(msi)è¿›è¡Œå®‰è£…,æ‰‹åŠ¨é€‰æ‹©å®‰è£…åŒ…åœ°å€å¦‚ä¸‹(<a href="https://docs.microsoft.com/zh-cn/windows/wsl/install-manual">https://docs.microsoft.com/zh-cn/windows/wsl/install-manual</a>)</p></li><li><p>åˆ‡æ¢WSL2</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wsl --set-default-version <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¯åŠ¨WSL</li></ul><ol><li>åº”ç”¨ç¨‹åºç›´æ¥å¯åŠ¨å®‰è£…Linuxå‘è¡Œç‰ˆ</li><li>â€˜wsl -l -vâ€™ æ£€æŸ¥WSLç‰ˆæœ¬,VERSION -&gt; 2å³å¯<br><a href="https://imgtu.com/i/RPsbr9"><img src="https://z3.ax1x.com/2021/06/19/RPsbr9.png" alt="WSL2"></a></li></ol><h2 id="ç¼–è¯‘JDK"><a class="header-anchor" href="#ç¼–è¯‘JDK"></a>ç¼–è¯‘JDK</h2><p>ä¸¥è°¨çš„è¯´æ³•æ˜¯ç¼–è¯‘OpenJDK</p><h3 id="ä¸‹è½½JDKæºä»£ç "><a class="header-anchor" href="#ä¸‹è½½JDKæºä»£ç "></a>ä¸‹è½½JDKæºä»£ç </h3><p>æ¨èç›´æ¥ä¸‹è½½,ä¸‹é¢æ˜¯JDK11çš„æºä»£ç åœ°å€,ç›´æ¥é€‰æ‹©zip fileè¿›è¡Œä¸‹è½½,ä¹Ÿå¯ä»¥é€‰æ‹©ä¸åŒçš„ç‰ˆæœ¬<br><a href="https://jdk.java.net/java-se-ri/11">https://jdk.java.net/java-se-ri/11</a></p><h3 id="å‡†å¤‡JDKç¼–è¯‘ç¯å¢ƒ"><a class="header-anchor" href="#å‡†å¤‡JDKç¼–è¯‘ç¯å¢ƒ"></a>å‡†å¤‡JDKç¼–è¯‘ç¯å¢ƒ</h3><h4 id="å®‰è£…å¿…è¦ç¨‹åº"><a class="header-anchor" href="#å®‰è£…å¿…è¦ç¨‹åº"></a>å®‰è£…å¿…è¦ç¨‹åº</h4><ul><li>æ¨èå…ˆå…ˆåˆ‡æ¢è½¯ä»¶æº</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">sed</span> -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list<span class="token function">sudo</span> <span class="token function">apt</span> update -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å®‰è£…å¿…è¦è½¯ä»¶</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token function">curl</span> <span class="token function">ssh</span> <span class="token function">zip</span> <span class="token function">unzip</span> ant <span class="token function">git</span> build-essential ccache cpio g++ gcc gdb libx11-dev libxext-dev libxrender-dev libxtst-dev libxt-dev libcups2-dev libfreetype6-dev libasound2-dev libelf-dev ccache libfontconfig1-dev autoconf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="å®‰è£…BootStrap-JDK"><a class="header-anchor" href="#å®‰è£…BootStrap-JDK"></a>å®‰è£…BootStrap JDK</h4><p>BootStrap JDKçš„ä½œç”¨æ˜¯ç¼–è¯‘JDKæºä»£ç ä¸­çš„javaä»£ç ,é»˜è®¤è¦æ¯”ç¼–è¯‘çš„JDKå°ä¸€ä¸ªç‰ˆæœ¬</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openjdk-10-jdkjava -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="è§£å‹JDKæºä»£ç "><a class="header-anchor" href="#è§£å‹JDKæºä»£ç "></a>è§£å‹JDKæºä»£ç </h4><p>ç”±äºæˆ‘æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨VS code,VS codeä¸­å·²ç»é›†æˆäº†è¿æ¥WSLçš„æ’ä»¶ï¼Œå› æ­¤åªéœ€è¦å°†JDKæºä»£ç ç›´æ¥æ‹–æ‹½åˆ°Linuxçš„ç›®å½•ä¸‹å³å¯ã€‚ä¹Ÿå¯ä»¥é€šè¿‡WSLè¿›è¡Œå¤åˆ¶<br>å¾—åˆ°JDKæºä»£ç åå°±å¯ä»¥è¿›è¡Œè§£å‹</p><h4 id="ç¼–è¯‘JDKæºä»£ç "><a class="header-anchor" href="#ç¼–è¯‘JDKæºä»£ç "></a>ç¼–è¯‘JDKæºä»£ç </h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å‡†å¤‡é…ç½®(è­¦å‘Šä¸ä½œä¸ºå¼‚å¸¸æŠ›å‡º)</span><span class="token function">bash</span> ./configure --disable-warnings-as-errors<span class="token function">make</span> all<span class="token comment"># ç¼–è¯‘å¤±è´¥æ—¶æ¨èå…ˆè¿›è¡Œclean,åœ¨é‡æ–°è¿›è¡Œç¼–è¯‘</span><span class="token function">make</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å¼‚å¸¸å¤„ç†"><a class="header-anchor" href="#å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h4><ol><li>åœ¨æ„å»ºä½ç‰ˆæœ¬çš„JDKæ—¶å¯èƒ½å‡ºç°OSç‰ˆæœ¬ä¸æ”¯æŒ<br>ä¿®æ”¹./hotspot/make/linux/Makefile</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 5% å†…æ ¸ç‰ˆæœ¬</span>SUPPORTED_OS_VERSION <span class="token operator">=</span> <span class="token number">2.4</span>% <span class="token number">2.5</span>% <span class="token number">2.6</span>% <span class="token number">2.7</span>% <span class="token number">3</span>% <span class="token number">4</span>%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQä¸­NameSrvçš„è¯¦ç»†è®¾è®¡åˆ†æ</title>
      <link href="2021/06/11/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/98.RocketMQ%E4%B8%ADNameSrv%E7%9A%84%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90/"/>
      <url>2021/06/11/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/98.RocketMQ%E4%B8%ADNameSrv%E7%9A%84%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>RocketMQä¸­NameSrvçš„è¯¦ç»†è®¾è®¡åˆ†æ</h1><h2 id="è®¾è®¡ç›®æ ‡"><a class="header-anchor" href="#è®¾è®¡ç›®æ ‡"></a>è®¾è®¡ç›®æ ‡</h2><p>NameSrvæ˜¯RoctetMQé¡¹ç›®ä¸‹çš„ä¸€ä¸ªæ¨¡å—ï¼Œä½œä¸ºRockerMQä¸­çš„è½»å‹æ³¨å†Œä¸­å¿ƒ,åªè´Ÿè´£ä¸Topicæœ‰å…³çš„åŠŸèƒ½ã€‚<br>ä½¿ç”¨NameSrvæ¥æ›¿ä»£ZKç­‰æ³¨å†Œä¸­å¿ƒä¸»è¦æ˜¯æœ‰ä¸¤ä¸ªå¥½å¤„:</p><ol><li>å‡å°‘æ•´ä½“å¤æ‚æ€§<br>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¼ºä¾èµ–å¦å¤–ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¢åŠ äº†æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚æ€§(æ•´ä½“ä»£ç å¤æ‚æ€§ã€è¿ç»´çš„å¤æ‚æ€§);<br>ä½¿ç”¨å†…ç½®çš„è½»é‡çº§æ³¨å†Œä¸­å¿ƒ,å°±å¯ä»¥æ¶ˆé™¤åŸæ¥ä¸ZKç­‰ç¬¬ä¸‰æ–¹æ³¨å†Œä¸­å¿ƒçš„å„ç§åè®®é€‚é…;<br>Namesrvä¸­åªéœ€è¦å¼€å‘ä¸Topicæœ‰å…³çš„ä¸šåŠ¡åœºæ™¯;<br>ç³»ç»Ÿç»´æŠ¤æ—¶ä¹Ÿä¸ç”¨åœ¨è€ƒè™‘ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„å¤„ç†æœºåˆ¶;</li><li>æ‰©å±•èƒ½åŠ›<br>RocketMQä»è®¾è®¡åˆå°±è€ƒè™‘è¿‡åœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šè¿›è¡Œéƒ¨ç½²çš„èƒ½åŠ›,å› æ­¤é‡‡ç”¨Namesrvçš„è®¾è®¡èƒ½æœ€å¤§é™åº¦çš„æŒæ¡ç³»ç»Ÿ</li></ol><p>ç›®å‰Kafkaåœ¨è¿™æ–¹é¢åšçš„æ›´å¥½ï¼Œåœ¨V2.8ä¹‹åä¸ä½†å»æ‰äº†ZKï¼Œå¹¶ä¸”é‡‡ç”¨brokeré›†ç¾¤ä¸­é€šè¿‡é€‰ä¸¾çš„æ–¹å¼é€‰å‡ºleaderèŠ‚ç‚¹æ¥ç®¡ç†Topicã€brokerã€consumer</p><h2 id="åŸºç¡€åŠŸèƒ½"><a class="header-anchor" href="#åŸºç¡€åŠŸèƒ½"></a>åŸºç¡€åŠŸèƒ½</h2><ul><li><p>æ•´ä½“æ¶æ„<br><img src="https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_architecture_3.png" alt="æ•´ä½“æ¶æ„"><br>Namesrvé›†ç¾¤æ˜¯æ— çŠ¶æ€çš„è®¾è®¡,æ¯ä¸ªç»„ä»¶(Brokerã€Producerã€Consumer)éƒ½ä¼šå‘æ¯ä¸€ä¸ªNamesrvè¿›è¡Œè¯·æ±‚,å› æ­¤Namesrvæ˜¯é€‰æ‹©äº†å¯ç”¨æ€§</p></li><li><p>åŠŸèƒ½è§£æ</p></li></ul><ol><li>Topicè·¯ç”±ç®¡ç†</li><li>Remotingè¿œç¨‹æœåŠ¡</li><li>å®šæ—¶ä»»åŠ¡</li><li>KVç®¡ç†æ¨¡å—</li></ol><h2 id="æºç åˆ†æ"><a class="header-anchor" href="#æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Namesrvæ—¶åºå›¾"><a class="header-anchor" href="#Namesrvæ—¶åºå›¾"></a>Namesrvæ—¶åºå›¾</h3><p><a href="https://imgtu.com/i/2jkklQ"><img src="https://z3.ax1x.com/2021/06/16/2jkklQ.png" alt="Namesrvæ‰§è¡Œæµç¨‹"></a></p><h3 id="NamesrvStartup"><a class="header-anchor" href="#NamesrvStartup"></a>NamesrvStartup</h3><h4 id="main"><a class="header-anchor" href="#main"></a>main()</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">/** * ä¸»å‡½æ•°å…¥å£ */</span><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">main0</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/** * å…·ä½“æ‰§è¡Œé€»è¾‘:é¿å…åœ¨mainå‡½æ•°ä¸­æ·»åŠ è¿‡å¤šçš„é€»è¾‘ */</span><span class="token keyword">fun</span> <span class="token function">main0</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> controller <span class="token operator">=</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>        <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span>        <span class="token keyword">val</span> tip <span class="token operator">=</span>            <span class="token string">"The Name Server boot success. serializeType="</span> <span class="token operator">+</span> RemotingCommand<span class="token punctuation">.</span><span class="token function">getSerializeTypeConfigInThisServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        log<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">println</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * åˆå§‹åŒ–NamesrvController */</span><span class="token keyword">fun</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> NamesrvController <span class="token punctuation">&#123;</span>  <span class="token comment">//å»é™¤TLSå’Œapache.commonsçš„ç‰ˆæœ¬</span>  <span class="token keyword">return</span> <span class="token function">NamesrvController</span><span class="token punctuation">(</span><span class="token function">NamesrvConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NettyServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="start"><a class="header-anchor" href="#start"></a>start()</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">/**  * å¯åŠ¨NamesrvController  */</span><span class="token keyword">fun</span> <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token operator">:</span> NamesrvController<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>controller <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"NamesrvController is null"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//NamesrvControlleræ‰§è¡Œåˆå§‹åŒ–,å¦‚æœå¤±è´¥æ—¶é€€å‡ºè¿›ç¨‹</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        controller<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    controller<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NamesrvStartupå¯åŠ¨æ—¶å€™ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºNamesrvController</li><li>å¤„ç†TLSå’ŒåŠ è½½Namesrvé…ç½®æ–‡ä»¶</li><li>å¯åŠ¨NamesrvController</li><li>å…³é—­NamesrvController</li></ol><ul><li>NamesrvController<br>NamesrvControllerä¸»è¦é€»è¾‘å¾ˆä¸ºä¸¤ä¸ªéƒ¨åˆ†åˆå§‹åŒ–å’Œæ‰§è¡Œ</li></ul><ol><li>åˆå§‹åŒ–</li></ol><ul><li>åˆå§‹åŒ–é‚£äº›ä¸œè¥¿</li></ul><ol><li><p>é…ç½®</p></li><li><p>æœåŠ¡</p></li><li><p>çº¿ç¨‹æ± </p></li><li><p>è‡ªçœ</p></li><li><p>åŠ è½½é…ç½®æ–‡ä»¶</p></li></ol><h2 id="æ‰©å±•æ€è€ƒ"><a class="header-anchor" href="#æ‰©å±•æ€è€ƒ"></a>æ‰©å±•æ€è€ƒ</h2><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://rocketmq.apache.org/">rocketmq</a><br><a href="https://github.com/apache/rocketmq">rocketmq-github</a><br><a href="https://www.confluent.io/blog/kafka-without-zookeeper-a-sneak-peek/">Apache Kafka Made Simple: A First Glimpse of a Kafka Without ZooKeeper</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€äº›å†å²</title>
      <link href="2021/05/08/1.%E6%9D%82%E8%AE%B0/%E5%85%B3%E4%BA%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8E%86%E5%8F%B2/"/>
      <url>2021/05/08/1.%E6%9D%82%E8%AE%B0/%E5%85%B3%E4%BA%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8E%86%E5%8F%B2/</url>
      
        <content type="html"><![CDATA[<h1>å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€äº›å†å²</h1><p>è¿™æ˜¯ä¸€ç¯‡å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„å†å²æ–‡ç« ï¼Œæœ‰å…³æ¶ˆæ¯é˜Ÿåˆ—çš„å‰ä¸–ä»Šç”Ÿçš„ä¸€äº›ä¿¡æ¯ã€‚</p><h2 id="èµ·æº"><a class="header-anchor" href="#èµ·æº"></a>èµ·æº</h2><p>è½¯ä»¶é¢†åŸŸçš„æ¶ˆæ¯é˜Ÿåˆ—æœ€æ—©æ˜¯ç”±Vivek Ranadiveå‚è€ƒç¡¬ä»¶ä¸­çš„ç³»ç»Ÿæ€»çº¿æå‡ºæ¥çš„,è¿™è€å“¥æ˜¯ä¸€ä¸ªå°åº¦è£”,ç°åœ¨è¿˜æ˜¯å›½ç‹é˜Ÿçš„è€æ¿ã€‚<br>ç¡¬ä»¶é¢†åŸŸä¸­çš„ç³»ç»Ÿæ€»çº¿ä¸»è¦åˆ†ä¸ºæ•°æ®æ€»çº¿ã€åœ°å€æ€»çº¿ã€æ§åˆ¶æ€»çº¿è¿™å‡ ä¸ªéƒ¨åˆ†ï¼Œç”¨æ¥è¿æ¥ä¸åŒçš„è®¾å¤‡ä¼ è¾“æ•°æ®ä½¿ç”¨ã€‚<br><a href="https://imgtu.com/i/gJ4Q61"><img src="https://z3.ax1x.com/2021/05/09/gJ4Q61.png" alt="ç³»ç»Ÿæ€»çº¿"></a><br>ç¡¬ä»¶ä¸Šçš„ç³»ç»Ÿæ€»çº¿ç€é‡åœ¨äºé€šè¿‡çº¿è¿æ¥ä¸åŒè®¾å¤‡ä¹‹é—´çš„äº¤äº’ï¼Œè€Œæ¶ˆæ¯é˜Ÿåˆ—æ˜¯è½¯ä»¶é¢†åŸŸçš„è¿æ¥ä¸åŒç³»ç»Ÿä¹‹é—´äº¤äº’çš„æ–¹å¼æœ‰åº”ç”¨å±‚åè®®ï¼Œç°ä»£çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦ç€é‡ç‚¹æ˜¯åœ¨äºé˜Ÿåˆ—ä¸Šã€‚</p><h2 id="ä¸Šå¤æ—¶æœŸ"><a class="header-anchor" href="#ä¸Šå¤æ—¶æœŸ"></a>ä¸Šå¤æ—¶æœŸ</h2><ul><li><p>1985<br>Vivek Ranadiveæ ¹æ®ç³»ç»Ÿæ€»çº¿è®¾è®¡å‡ºæ¥çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿå«The Information Bus(TIB)ï¼ŒTIBä½†æ˜¯ä¸»è¦æ˜¯åœ¨ç”µä¿¡å’Œé‡‘èé¢†åŸŸè¿›è¡Œä½¿ç”¨ã€‚</p></li><li><p>1993<br>IBM MQæ˜¯ç”±è“è‰²å·¨äººIBMä¸1993å¹´æ¨å‡ºçš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“ï¼Œç›®å‰è¿˜ä¿æŒæ›´æ–°ç°åœ¨è¿­ä»£åˆ°äº†V9ç‰ˆæœ¬</p></li><li><p>1997<br>MS MQæ˜¯ç”±å¾®è½¯æ¨å‡ºçš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“,ä¸ç”±æ„Ÿæ…¨ä¸€å¥å¾®è½¯æ˜¯çœŸåŠï¼Œä¸ºäº†.netç¡¬æ˜¯æ•´äº†ä¸€ä¸ªå…¨å®¶æ¡¶ã€‚</p></li></ul><p>è¿™ä¸€æ—¶æœŸç”±äºå„å®¶çš„MQäº§å“éƒ½æ˜¯ä¸ºäº†æ——ä¸‹å…¶ä»–äº§å“è¿›è¡ŒæœåŠ¡ï¼Œä¸ºäº†å½¢æˆå£å’ï¼Œå„å®¶çš„MQäº§å“å¹¶æœªå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒï¼Œå¯¼è‡´ä¸åŒå…¬å¸ä¸‹çš„äº§å“å¹¶ä¸èƒ½ä½¿ç”¨å…¶ä»–å…¬å¸çš„MQã€‚</p><h2 id="ä¸­å¤æ—¶æœŸ"><a class="header-anchor" href="#ä¸­å¤æ—¶æœŸ"></a>ä¸­å¤æ—¶æœŸ</h2><p>ç”±äºæ—©æœŸçš„MQäº§å“å„è‡ªä¸ºæ”¿çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸€æ—¶æœŸä¸»è¦ç»Ÿä¸€äº†æ¶ˆæ¯é˜Ÿåˆ—çš„åè®®ï¼Œè¿™äº›åè®®ä¸€ç›´å½±å“åˆ°äº†ç°åœ¨ï¼Œä¸»è¦è¯ç”Ÿäº†ä»¥ä¸‹å‡ ç§åè®®ä»¥åŠæ¥å…¥è§„èŒƒï¼š</p><ul><li><p>JMS<br>JMSæ˜¯ä¸€å¥—æ¥å…¥MQä¸­é—´ä»¶äº§å“çš„æ¥å£è§„èŒƒï¼Œjavaä¸ºäº†é»åˆå„å®¶çš„æ¶ˆæ¯é˜Ÿåˆ—è¯•å›¾é€šè¿‡ç±»ä¼¼äºJDBCçš„æ–¹æ¡ˆåœ¨javaç«¯é€šè¿‡ç»Ÿä¸€çš„åè®®ï¼Œåœ¨æ ¹æ®ä¸åŒäº§å“çš„é©±åŠ¨å»è¿æ¥MQã€‚<br>å„ä¸ªå‚å•†æ ¹æ®è¿™å¥—æ¥å£è§„èŒƒè‡ªè¡Œé€‰æ‹©å®¢æˆ·ç«¯è¿›è¡Œå®ç°ï¼Œå®ç°äº†è¿™ä¸ªæ¥å£è§„èŒƒçš„å®¢æˆ·ç«¯å¯ä»¥åœ¨javaåº”ç”¨ç¨‹åºå†…è‡ªç”±åˆ‡æ¢ï¼Œç±»ä¼¼äºé€‚é…å™¨æ¨¡å¼</p></li><li><p>AMQP<br>AMQPæ˜¯å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€ç§åè®®ï¼Œåœ¨åè®®å±‚è§„å®šäº†æ¶ˆæ¯é˜Ÿåˆ—åº”è¯¥æœ‰çš„é€»è¾‘è§„èŒƒã€‚AMQPä¸å…·ä½“çš„MQ(ä¾‹å¦‚RabbitMQã€ActiveMQ)çš„å…³ç³»ç±»ä¼¼ä¸jvmè§„èŒƒå’ŒJVMå®ç°(HotSpot)ä¸€æ ·</p></li><li><p>MQTT<br>ä¸ºåµŒå…¥å¼è®¾å¤‡è®¾è®¡çš„ä¸€å¥—æ¶ˆæ¯é˜Ÿåˆ—åè®®</p></li><li><p>STOMP<br>Stompåè®®ï¼Œè‹±æ–‡å…¨åStreaming Text Orientated Message Protocolï¼Œä¸­æ–‡åç§°ä¸º â€˜æµæ–‡æœ¬å®šå‘æ¶ˆæ¯åè®®â€™ã€‚æ˜¯ä¸€ç§ä»¥çº¯æ–‡æœ¬ä¸ºè½½ä½“çš„åè®®ï¼ˆä»¥æ–‡æœ¬ä¸ºè½½ä½“çš„æ„æ€æ˜¯å®ƒçš„æ¶ˆæ¯æ ¼å¼è§„èŒƒä¸­æ²¡æœ‰ç±»ä¼¼XMPPåè®®é‚£æ ·çš„xmlæ ¼å¼è¦æ±‚ï¼Œä½ å¯ä»¥å°†å®ƒçœ‹ä½œâ€˜åŠç»“æ„åŒ–æ•°æ®â€™ï¼‰<br>åŒå‘æ¶ˆæ¯é€šä¿¡åè®®è¿˜æœ‰å¾ˆå¤šï¼Œé™¤äº†AMQPä»¥å¤–å…¶ä»–çš„å¤§å¤šéƒ½æ˜¯å³æ—¶æ¶ˆæ¯åè®®ã€‚</p></li><li><p>ActiveMQ<br>åœ¨è¿™ä¸€æ—¶æœŸè¿˜æœ‰æ ¹æ®AMQPè¿˜è¯ç”Ÿäº†ActiveMQè¿™ä¸€å¼€æºäº§å“ï¼ŒActiveMQæ˜¯ç¬¬ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨åˆ°çš„å¼€æºMQäº§å“</p></li><li><p>RabbitMQ<br>RabbitMQæ˜¯2006å¹´è¯ç”Ÿçš„ï¼Œç°åœ¨å’Œspringæ¡†æ¶åŒå±äºvmwareã€‚ç”±Erlangå¼€å‘çš„ã€‚</p></li></ul><h2 id="ç°ä»£æ—¶æœŸ"><a class="header-anchor" href="#ç°ä»£æ—¶æœŸ"></a>ç°ä»£æ—¶æœŸ</h2><p>ç”±äºActiveMQå’ŒRabbitMQå‘å±•äº†å¤šå¹´ï¼ŒèƒŒè´Ÿç€æ²‰é‡çš„å†å²åŒ…è¢±æ”¯æŒè¿™éå¸¸å…¨çš„MQåŠŸèƒ½ï¼Œåœ¨ç°ä»£çš„MQä½¿ç”¨åœºæ™¯ä¸­è¿™äº›æ¶ˆæ¯é˜Ÿåˆ—ä¸ç¬¦åˆå½“ä¸‹æ•°æ®çˆ†ç‚¸ï¼Œå°å‹æœºç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„åœºæ™¯äº†ã€‚è¿™æ—¶å€™å‡ºç°äº†é’ˆå¯¹æŸä¸ªç»†åˆ†é¢†åŸŸçš„æ¶ˆæ¯é˜Ÿåˆ—æ¡†æ¶Kafkaã€RocketMQã€Pulsar</p><ul><li><p>Kafka<br>Kafkaæ˜¯Linkedinä¸ºè§£å†³ActiveMQæ€§èƒ½é—®é¢˜è€Œå¼€å‘çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›®å‰å·²ç»æˆä¸ºå¤§æ•°æ®é¢†åŸŸå®é™…çš„æ¶ˆæ¯ä¼ é€’ç»„ä»¶</p></li><li><p>RocketMQ<br>RocketMQæ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œåœ¨è®¾è®¡ä¸Šå‚è€ƒäº†kafka,é€šè¿‡javaè¯­è¨€è¿›è¡Œå¼€å‘</p></li><li><p>Pulsar<br>Pulsaræ˜¯é›…è™å¼€æºçš„ï¼Œå¤©ç„¶æ”¯æŒå¤šç»„æˆå¹¶ä¸”æ˜¯è®¡ç®—å’Œå­˜å‚¨åˆ†ç¦»å¼çš„å®ç°</p></li></ul><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>æ¶ˆæ¯é˜Ÿåˆ—çš„è¯ç”Ÿæ˜¯ä»é‡‘èåœºæ™¯å‡ºå‘ï¼Œå‘å±•åˆ°ç°åœ¨æœ€å¼€å§‹çš„é‚£å‡ ç§æ¶ˆæ¯é˜Ÿåˆ—åœ¨åŠŸèƒ½ä¸Šå·²ç»å˜å¾—éå¸¸è‡ƒè‚¿ã€‚ç°ä»£çš„æ¶ˆæ¯é˜Ÿåˆ—æ ¹æ®æŸä¸€æ–¹é¢çš„ç€é‡ç‚¹å¼€å§‹è¿›è¡Œå‘å±•ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://tryrabbitmq.com/">http://tryrabbitmq.com/</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¶ˆæ¯é˜Ÿåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-è¡Œä¸ºæ¨¡å¼</title>
      <link href="2021/04/29/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F/"/>
      <url>2021/04/29/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-è¡Œä¸ºæ¨¡å¼</h1><p>è¡Œä¸ºæ¨¡å¼æ˜¯é€šè¿‡å°†å¤šä¸ªç±»é€šè¿‡ç»§æ‰¿\ç»„åˆçš„å½¢å¼å½¢æˆå¯¹æ–¹æ³•çš„å¤„ç†,ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§</p><ol><li>è´£ä»»é“¾æ¨¡å¼</li><li>å‘½ä»¤æ¨¡å¼</li><li>è§£é‡Šå™¨æ¨¡å¼</li><li>è¿­ä»£å™¨æ¨¡å¼</li><li>ä¸­ä»‹è€…æ¨¡å¼</li><li>å¤‡å¿˜å½•æ¨¡å¼</li><li>è§‚å¯Ÿè€…æ¨¡å¼</li><li>çŠ¶æ€æ¨¡å¼</li><li>ç­–ç•¥æ¨¡å¼</li><li>æ¨¡æ¿æ¨¡å¼</li><li>è®¿é—®è€…æ¨¡å¼</li></ol><h2 id="è´£ä»»é“¾æ¨¡å¼"><a class="header-anchor" href="#è´£ä»»é“¾æ¨¡å¼"></a>è´£ä»»é“¾æ¨¡å¼</h2><h3 id="æ„å›¾"><a class="header-anchor" href="#æ„å›¾"></a>æ„å›¾</h3><blockquote><p>è´£ä»»é“¾æ¨¡å¼æ˜¯ä½¿å¾—å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚,ä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»,è¿™äº›å¯¹è±¡çš„å¤„ç†è¿‡ç¨‹é€»è¾‘ä¸Šå½¢æˆé“¾çŠ¶ç»“æ„,è¯·æ±‚æ²¿ç€è¿™æ¡é“¾ä¾æ¬¡è¢«ä¸åŒçš„å¯¹è±¡è¿›è¡Œå¤„ç†ã€‚æ ‡å‡†çš„å®šä¹‰æ˜¯ç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†è¯·æ±‚ä¸ºæ­¢ï¼Œæˆ‘è‡ªå·±ç†è§£åº”è¯¥æ˜¯ä¾æ¬¡è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯æœ‰ä¸€ä¸ªå¤„ç†å³æ­¢ï¼Œå› ä¸ºå¦‚æœåªæœ‰ä¸€ä¸ªå¤„ç†ï¼Œé‚£ä¹ˆè´£ä»»é“¾æ¨¡å¼ä¸ç­–ç•¥æ¨¡å¼ç±»ä¼¼ã€‚è´£ä»»é“¾æ¨¡å¼æ˜¯é€šè¿‡å°†è¯·æ±‚éœ€è¦ä¾æ¬¡å¤„ç†çš„åœºæ™¯ä»æ˜¾çš„å®¢æˆ·ç«¯ä¸€ä¸ªä¸€ä¸ªè°ƒç”¨çš„è¿‡ç¨‹ï¼Œå‡çº§æˆäº†å°†è¯·æ±‚ä¼ å…¥å’Œç”±è´£ä»»é“¾å®¢æˆ·ç«¯å»ä¸²è”æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼Œå¹¶ä¸”è¿™æ ·æ›´å®¹æ˜“æ‰©å±•æ­¥éª¤ã€‚</p></blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œé€šå¸¸æ¯ä¸ªæ¥æ”¶è€…éƒ½åŒ…å«å¯¹å¦ä¸€ä¸ªæ¥æ”¶è€…çš„å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤„ç†è¯¥è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒä¼šæŠŠç›¸åŒçš„è¯·æ±‚ä¼ ç»™ä¸‹ä¸€ä¸ªæ¥æ”¶è€…ï¼Œä¾æ­¤ç±»æ¨ã€‚</p><h3 id="ç»“æ„"><a class="header-anchor" href="#ç»“æ„"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/2021-chain-of-responsibility.svg" alt="è´£ä»»é“¾æ¨¡å¼"></p><h3 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h3><ul><li>AbstractLogger.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> INFO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> DEBUG <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ERROR <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">int</span> level<span class="token punctuation">;</span>    <span class="token comment">//è´£ä»»é“¾ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ </span>   <span class="token keyword">protected</span> <span class="token class-name">AbstractLogger</span> nextLogger<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNextLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span> nextLogger<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>nextLogger <span class="token operator">=</span> nextLogger<span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">&lt;=</span> level<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token function">write</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>nextLogger <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         nextLogger<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ChainPatternDemo.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChainPatternDemo</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AbstractLogger</span> <span class="token function">getChainOfLoggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token class-name">AbstractLogger</span> errorLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">AbstractLogger</span> fileLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">AbstractLogger</span> consoleLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsoleLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>       errorLogger<span class="token punctuation">.</span><span class="token function">setNextLogger</span><span class="token punctuation">(</span>fileLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>      fileLogger<span class="token punctuation">.</span><span class="token function">setNextLogger</span><span class="token punctuation">(</span>consoleLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> errorLogger<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">AbstractLogger</span> loggerChain <span class="token operator">=</span> <span class="token function">getChainOfLoggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       loggerChain<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token string">"This is an information."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       loggerChain<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span>          <span class="token string">"This is a debug level information."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       loggerChain<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>          <span class="token string">"This is an error information."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ErrorLoggerã€FileLoggerã€ConsoleLoggeréƒ½æ˜¯AbstractLogger.javaçš„å­ç±»ï¼Œåœ¨å®¢æˆ·ç«¯ä¸­ï¼Œé€šè¿‡æä¾›setNextHandlerçš„æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è‡ªç”±ç»„åˆé“¾çš„é¡ºåº</p><h2 id="å‘½ä»¤æ¨¡å¼"><a class="header-anchor" href="#å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h2><h3 id="æ„å›¾-v2"><a class="header-anchor" href="#æ„å›¾-v2"></a>æ„å›¾</h3><p>å°†è¯·æ±‚å°è£…æˆä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œä½¿å¾—ä½ å¯ä»¥ç”¨ä¸åŒçš„è¯·æ±‚å¯¹å®¢æˆ·è¿›è¡Œå‚æ•°åŒ–</p><h3 id="åŠ¨æœº"><a class="header-anchor" href="#åŠ¨æœº"></a>åŠ¨æœº</h3><p>å‘½ä»¤æ¨¡å¼ä¸»è¦æ˜¯å°†è¯·æ±‚å’Œå¯¹è¯·æ±‚æ‰§è¡Œçš„åŠ¨ä½œè´£ä»»åˆ†ç¦»,è®©ä¸¤è€…éƒ½å¯ä»¥ç‹¬ç«‹è¿›è¡Œæ¼”åŒ–ã€‚é€‚åˆè¯·æ±‚å†…å®¹æ˜¯ç±»ä¼¼äºä¿¡å·é‡çš„åœºæ™¯ï¼Œæ¥å—è€…å¯ä»¥æ ¹æ®è¿™ä¸ªè¯·æ±‚å†…å®¹è¿›è¡Œä¸åŒçš„å¤„ç†</p><h3 id="ç»“æ„-v2"><a class="header-anchor" href="#ç»“æ„-v2"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/commanduml.jpg" alt="å‘½ä»¤æ¨¡å¼"></p><h3 id="å®ä¾‹-v2"><a class="header-anchor" href="#å®ä¾‹-v2"></a>å®ä¾‹</h3><ul><li>Command</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * æ‰§è¡Œæ–¹æ³•     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Command.java å®šä¹‰çš„æŠ½è±¡å‘½ä»¤ç±»ï¼Œæ‰€æœ‰å…·ä½“å‘½ä»¤çš„æ¥å£</p><ul><li>PlayCommand.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//å…·ä½“çš„æ‰§è¡Œç±»</span>    <span class="token keyword">private</span> <span class="token class-name">AudioPlayer</span> myAudio<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token class-name">PlayCommand</span><span class="token punctuation">(</span><span class="token class-name">AudioPlayer</span> audioPlayer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        myAudio <span class="token operator">=</span> audioPlayer<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * æ‰§è¡Œæ–¹æ³•     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        myAudio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PlayCommandæ˜¯å…·ä½“çš„å‘½ä»¤æ‰§è¡Œç±»ï¼Œå†…éƒ¨å…·æœ‰ä¸€ä¸ªexecuteæ–¹æ³•,è¯¥æ–¹æ³•ä¼šæ‰§è¡Œè¯¥å‘½ä»¤å®šä¹‰çš„åŠ¨ä½œ</p><ul><li>Keypad.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Keypad</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Command</span> playCommand<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPlayCommand</span><span class="token punctuation">(</span><span class="token class-name">Command</span> playCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>playCommand <span class="token operator">=</span> playCommand<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">//æ‰§è¡Œæ’­æ”¾æ–¹æ³•</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        playCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>keyPadä½œä¸ºè¯·æ±‚ç±»ï¼Œå†æ¬¡å¯¹å‘½ä»¤è¿›è¡Œä¸€æ¬¡å°è£…ï¼Œä¾¿äºå®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨å†æ¬¡å°è£…ï¼Œè‡ªå·±é€šè¿‡å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨</p><ul><li>client.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Julia</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token comment">//åˆ›å»ºæ¥æ”¶è€…å¯¹è±¡</span>        <span class="token class-name">AudioPlayer</span> audioPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆ›å»ºå‘½ä»¤å¯¹è±¡</span>        <span class="token class-name">Command</span> playCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlayCommand</span><span class="token punctuation">(</span>audioPlayer<span class="token punctuation">)</span>         <span class="token comment">//åˆ›å»ºè¯·æ±‚è€…å¯¹è±¡</span>        <span class="token class-name">Keypad</span> keypad <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Keypad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        keypad<span class="token punctuation">.</span><span class="token function">setPlayCommand</span><span class="token punctuation">(</span>playCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//æ‰§è¡Œå…·ä½“çš„ç±»</span>        keypad<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨è¯·æ±‚ç±»==Keypad==çš„æŒ‡å®šæ–¹æ³•ï¼ŒkeyPadä¼šè°ƒç”¨å…·ä½“çš„å‘½ä»¤å°è£…ç±»è¿›è¡Œæ‰§è¡Œã€‚å…¶å®å‘½ä»¤æ¨¡å¼åªæ˜¯å°†è¯·æ±‚å’Œå¯¹åº”çš„åŠ¨ä½œè¿›è¡Œåˆ†ç¦»ï¼Œä¾¿äºå¤æ‚è¯·æ±‚åœºæ™¯çš„æ‰©å±•</p><h2 id="è§£é‡Šå™¨æ¨¡å¼"><a class="header-anchor" href="#è§£é‡Šå™¨æ¨¡å¼"></a>è§£é‡Šå™¨æ¨¡å¼</h2><h3 id="æ„å›¾-v3"><a class="header-anchor" href="#æ„å›¾-v3"></a>æ„å›¾</h3><p>è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreter Patternï¼‰æä¾›äº†è¯„ä¼°è¯­è¨€çš„è¯­æ³•æˆ–è¡¨è¾¾å¼çš„æ–¹å¼ï¼Œå®ƒå±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼å®ç°äº†ä¸€ä¸ªè¡¨è¾¾å¼æ¥å£ï¼Œè¯¥æ¥å£è§£é‡Šä¸€ä¸ªç‰¹å®šçš„ä¸Šä¸‹æ–‡ã€‚è¿™ç§æ¨¡å¼è¢«ç”¨åœ¨ SQL è§£æã€ç¬¦å·å¤„ç†å¼•æ“ç­‰ã€‚</p><h3 id="åŠ¨æœº-v2"><a class="header-anchor" href="#åŠ¨æœº-v2"></a>åŠ¨æœº</h3><p>ç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨è¯¥æ ‡è¯†æ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚</p><h3 id="ç»“æ„-v3"><a class="header-anchor" href="#ç»“æ„-v3"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/interpreter_pattern_uml_diagram.jpg" alt="è§£é‡Šå™¨æ¨¡å¼"></p><h2 id="è¿­ä»£å™¨æ¨¡å¼"><a class="header-anchor" href="#è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h2><h3 id="æ„å›¾-v4"><a class="header-anchor" href="#æ„å›¾-v4"></a>æ„å›¾</h3><p>æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€è¦æš´éœ²èšåˆå¯¹è±¡å†…éƒ¨è¡¨ç¤ºçš„æ¨¡å¼</p><h3 id="åˆ«å"><a class="header-anchor" href="#åˆ«å"></a>åˆ«å</h3><p>æ¸¸æ ‡(Cursor)</p><h3 id="åŠ¨æœº-v3"><a class="header-anchor" href="#åŠ¨æœº-v3"></a>åŠ¨æœº</h3><p>è¿­ä»£å™¨æ¨¡å¼æ˜¯ä¸ºäº†å°†å†…éƒ¨å…ƒç´ å’Œè®¿é—®/éå†åŠ¨ä½œåˆ†ç¦»å¼€ï¼Œé€šè¿‡å¢åŠ ä¸€ä¸ªè¿­ä»£å™¨ï¼Œé€šè¿‡è¿­ä»£å™¨æ¥è®¿é—®å†…éƒ¨å…ƒç´ ã€‚</p><h3 id="ç»“æ„-v4"><a class="header-anchor" href="#ç»“æ„-v4"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/iterator_pattern_uml_diagram.jpg" alt="è¿­ä»£å™¨æ¨¡å¼"></p><h2 id="ä¸­ä»‹è€…æ¨¡å¼"><a class="header-anchor" href="#ä¸­ä»‹è€…æ¨¡å¼"></a>ä¸­ä»‹è€…æ¨¡å¼</h2><h3 id="æ„å›¾-v5"><a class="header-anchor" href="#æ„å›¾-v5"></a>æ„å›¾</h3><p>ç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—çš„å¯¹è±¡äº¤äº’ã€‚ä¸­ä»‹è€…ä½¿å„å¯¹è±¡ä¸éœ€è¦æ˜¾å¼åœ°ç›¸äº’å¼•ç”¨ï¼Œä»è€Œä½¿å…¶è€¦åˆæ¾æ•£ï¼Œè€Œä¸”å¯ä»¥ç‹¬ç«‹çš„æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’</p><h3 id="åŠ¨æœº-v4"><a class="header-anchor" href="#åŠ¨æœº-v4"></a>åŠ¨æœº</h3><p>ç”±äºé¢å‘å¯¹è±¡é¼“åŠ±æŒ‰ç…§è¡Œä¸ºè¿›è¡Œç±»çš„åˆ’åˆ†ï¼Œå› æ­¤ç³»ç»Ÿä¸­ä¼šå­˜åœ¨å¤§é‡çš„ç±»ã€‚å¦‚æœä¸åŒçš„ç±»ä¹‹é—´éƒ½è¦ç›¸äº’å¼•ç”¨æ¥å®Œæˆä¸€ä¸ªè¡Œä¸ºçš„è¯ä¸ç¬¦åˆé¢å‘å¯¹è±¡çš„ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦æœ‰ä¸€ä¸ªä¸­ä»‹æ¥å°†æœåŠ¡èšåˆèµ·æ¥ï¼Œç›¸å½“äºå°†ç»†å°çš„è¡Œä¸ºè¿›è¡Œä¸€æ¬¡èšåˆå½¢æˆè¾ƒå¤§çš„è¡Œä¸ºï¼Œè¿™æ ·ä¸ç”¨å…³æ³¨ç»†å°çš„è¡Œä¸ºå¯¹è±¡ã€‚</p><h3 id="ç»“æ„-v5"><a class="header-anchor" href="#ç»“æ„-v5"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/mediator_pattern_uml_diagram.jpg" alt="ä¸­ä»‹è€…æ¨¡å¼"></p><p>ä¸­ä»‹è€…æ¨¡å¼åœ¨åŠŸèƒ½ä¸Šç±»ä¼¼äºé—¨é¢æ¨¡å¼ï¼Œä½†æ˜¯é—¨é¢æ¨¡å¼ç€é‡äºå¯¹å­ç³»ç»Ÿç±»çš„å°è£…ï¼Œä¸­ä»‹è€…æ¨¡å¼ç€é‡æ˜¯å¯¹è¡Œä¸ºçš„å°è£…å’Œè°ƒå’Œå„ä¸ªå­è¡Œä¸ºä»è€Œå½¢æˆä¸€ä¸ªå¤§çš„è¡Œä¸ºï¼Œå› æ­¤é—¨é¢æ¨¡å¼æ˜¯ç»“æ„å‹è€Œä¸­ä»‹è€…æ¨¡å¼æ˜¯è¡Œä¸ºå‹ã€‚</p><h2 id="å¤‡å¿˜å½•æ¨¡å¼"><a class="header-anchor" href="#å¤‡å¿˜å½•æ¨¡å¼"></a>å¤‡å¿˜å½•æ¨¡å¼</h2><h3 id="æ„å›¾-v6"><a class="header-anchor" href="#æ„å›¾-v6"></a>æ„å›¾</h3><p>åœ¨ä¸ç ´åå¯¹è±¡å°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶å°†è¯¥çŠ¶æ€ä¿å­˜åœ¨å¯¹è±¡ä¹‹å¤–ã€‚åœ¨éœ€è¦æ—¶ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªæ•°æ®è¿›è¡Œæ¢å¤ã€‚ç±»ä¼¼äºæ¸¸æˆä¸­çš„å­˜æ¡£ç‚¹è®¾ç½®ã€‚</p><h3 id="åˆ«å-v2"><a class="header-anchor" href="#åˆ«å-v2"></a>åˆ«å</h3><p>token</p><h3 id="åŠ¨æœº-v5"><a class="header-anchor" href="#åŠ¨æœº-v5"></a>åŠ¨æœº</h3><p>å¤‡å¿˜å½•æ¨¡å¼é’ˆå¯¹äºé‚£äº›éœ€è¦è¿›è¡Œæš‚å­˜çš„æ•°æ®æˆ–å¯¹è±¡ï¼Œåœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ã€‚</p><h3 id="ç»“æ„-v6"><a class="header-anchor" href="#ç»“æ„-v6"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/memento_pattern_uml_diagram.jpg" alt="å¤‡å¿˜å½•æ¨¡å¼"></p><p>CareTaker.java è´Ÿè´£ä¿å­˜æ¯ä¸ªé˜¶æ®µçš„å¯¹è±¡çŠ¶æ€</p><h2 id="è§‚å¯Ÿè€…æ¨¡å¼"><a class="header-anchor" href="#è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h2><h3 id="æ„å›¾-v7"><a class="header-anchor" href="#æ„å›¾-v7"></a>æ„å›¾</h3><p>å®šä¹‰å¯¹è±¡ä¹‹é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘é€æ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½ä¼šå¾—åˆ°é€šçŸ¥</p><h3 id="åˆ«å-v3"><a class="header-anchor" href="#åˆ«å-v3"></a>åˆ«å</h3><p>ä¾èµ–(Dependents),å‘å¸ƒ-è®¢é˜…(Publish-Subscribe)</p><h3 id="åŠ¨æœº-v6"><a class="header-anchor" href="#åŠ¨æœº-v6"></a>åŠ¨æœº</h3><p>åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜ä¼šå¯¼è‡´å¼•èµ·ç›¸å…³å¯¹è±¡çš„æ”¹å˜ï¼Œå¦‚æœè¦ä¿æŒè¿™æ ·çš„ä¸€è‡´æ€§ä¼šå¯¼è‡´å¯¹è±¡é—´å¼ºä¾èµ–ã€‚è§‚å¯Ÿè€…æ¨¡å¼å°±æ˜¯é€šè¿‡å‘å¸ƒ-è®¢é˜…æ¨¡å¼å°†é€šçŸ¥çš„èŒè´£ä»åŠ¨ä½œç±»ä¸­å¼ºåˆ¶ä¾èµ–è½¬æ¢ä¸ºé€šçŸ¥çš„æ¨¡å¼</p><h3 id="ç»“æ„-v7"><a class="header-anchor" href="#ç»“æ„-v7"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/observer_pattern_uml_diagram.jpg" alt="è§‚å¯Ÿè€…æ¨¡å¼"></p><p>Subjectä½œä¸ºè¢«è§‚å¯Ÿè€…ä¸­ç»´æŠ¤ä¸€ä¸ªæ‰€æœ‰è§‚å¯Ÿè€…çš„å¼•ç”¨ï¼ŒObserverä½œä¸ºè¢«è§‚å¯Ÿè€…ç»´æŠ¤ä¸€ä¸ªSubjectçš„å¼•ç”¨ï¼Œå°†è‡ªå·±ç»„æˆåˆ°è¢«è§‚å¯Ÿè€…ä¸­<br>å¯å‚è€ƒ<br><a href="../../../../../2020/05/06/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/#more">è§‚å¯Ÿè€…æ¨¡å¼</a></p><h3 id="å®ä¾‹-v3"><a class="header-anchor" href="#å®ä¾‹-v3"></a>å®ä¾‹</h3><p>springä¸­çš„ApplicationListenerå’ŒApplicationEventã€ApplicationEventPublisherAwareåˆ†åˆ«ä½œä¸ºè¢«è§‚å¯Ÿè€…ã€è§‚å¯Ÿè€…å’Œå®¢æˆ·ç«¯</p><h2 id="çŠ¶æ€æ¨¡å¼"><a class="header-anchor" href="#çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h2><h3 id="æ„å›¾-v8"><a class="header-anchor" href="#æ„å›¾-v8"></a>æ„å›¾</h3><p>å…è®¸ä¸€ä¸ªå¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚ä»è¡¨è±¡ä¸Šæ¥çœ‹å°±æ˜¯å¯¹è±¡å¯ä»¥æ ¹æ®å†…éƒ¨çŠ¶æ€æ‰§è¡Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘ã€‚</p><h3 id="åŠ¨æœº-v7"><a class="header-anchor" href="#åŠ¨æœº-v7"></a>åŠ¨æœº</h3><p>ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºå–å†³äºå†…éƒ¨çŠ¶æ€è¿›è¡Œé©±åŠ¨æ—¶ï¼ŒçŠ¶æ€æ¨¡å¼å¯ä»¥å°†çŠ¶æ€å’Œè¡Œä¸ºåˆ†ç¦»ï¼Œå‡å°‘åˆ†æ”¯çš„æ¡ä»¶è¯­å¥ã€‚</p><h3 id="ç»“æ„-v8"><a class="header-anchor" href="#ç»“æ„-v8"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/state_pattern_uml_diagram.png" alt="çŠ¶æ€æ¨¡å¼"></p><p>å¯ä»¥çœ‹åˆ°doAction()æ–¹æ³•ä¸­æ‰ä¼šæ‰§è¡Œå…·ä½“çš„è¡Œä¸ºï¼Œä¸åŒçš„çŠ¶æ€å…·æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œé€šè¿‡contextç»´æŠ¤çŠ¶æ€ï¼Œå½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¯¹åº”çš„è¡Œä¸ºä¹Ÿéšä¹‹å‘ç”Ÿæ”¹å˜</p><h2 id="ç­–ç•¥æ¨¡å¼"><a class="header-anchor" href="#ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h2><h3 id="æ„å›¾-v9"><a class="header-anchor" href="#æ„å›¾-v9"></a>æ„å›¾</h3><p>ç­–ç•¥æ¨¡å¼æ˜¯å°†ä¸åŒçš„ç®—æ³•å•ç‹¬å®šä¹‰èµ·æ¥ï¼Œé€šè¿‡ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸åŒçš„ç®—æ³•ã€‚å°†å®¢æˆ·ç«¯ä¸­çš„æ¡ä»¶åˆ†æ”¯å»æ‰ï¼Œå¹¶ä¸”æ”¯æŒæ‰©å±•ã€‚</p><h3 id="ç»“æ„-v9"><a class="header-anchor" href="#ç»“æ„-v9"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/strategy_pattern_uml_diagram.jpg" alt="ç­–ç•¥æ¨¡å¼"></p><p>Contextä¸­çš„strategyç±»æ˜¯å…·ä½“æ‰§è¡Œçš„ç®—æ³•ï¼Œè¿™é‡Œæœ‰ä¸¤ç§è®¾è®¡æ–¹æ¡ˆï¼Œç¬¬ä¸€ç§å°±æ˜¯UMLå›¾ä¸­çš„å†™æ³•ï¼Œå°†Contetxxä½œä¸ºæ¯æ¬¡è¡ŒåŠ¨çš„å®¹å™¨ï¼Œæ¯æ¬¡æ‰§è¡Œå‰éƒ½å…ˆè¿›è¡Œèµ‹å€¼ã€‚ç¬¬äºŒç§æ˜¯ContextæŒæœ‰ä¸€ä¸ªStrategyçš„Listæ ¹æ®æ·»åŠ é€‰æ‹©ç®—æ³•ã€</p><p>ç­–ç•¥æ¨¡å¼åœ¨å®é™…å·¥ä½œä¸­å¤§é‡ä½¿ç”¨åˆ°ï¼Œå› ä¸ºæ¶ˆé™¤äº†æ¡ä»¶åˆ¤æ–­å‡å°‘äº†åˆ†æ”¯ã€‚é€šè¿‡å¢åŠ ç±»çš„æ–¹å¼æ¥å‡å°‘åˆ†æ”¯ï¼Œç»“æ„ä¸Šä¾¿äºæ‰©å±•äº†</p><h2 id="æ¨¡æ¿æ¨¡å¼"><a class="header-anchor" href="#æ¨¡æ¿æ¨¡å¼"></a>æ¨¡æ¿æ¨¡å¼</h2><h3 id="æ„å›¾-v10"><a class="header-anchor" href="#æ„å›¾-v10"></a>æ„å›¾</h3><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•çš„éª¨æ¶ï¼Œé€šè¿‡ç»§æ‰¿çš„æ–¹å¼è®©å­ç±»å¯ä»¥æ”¹å˜ç‰¹ç‚¹è¡Œä¸ºï¼Œä½¿å¾—ä¸ç”¨é‡æ–°å®šä¹‰ç®—æ³•çš„é¡ºåºå°±èƒ½æ”¹å˜è¡Œä¸ºã€‚</p><h3 id="åŠ¨æœº-v8"><a class="header-anchor" href="#åŠ¨æœº-v8"></a>åŠ¨æœº</h3><p>æ¨¡æ¿æ–¹æ³•çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³é‡å¤å®šä¹‰çš„ç®—æ³•æ‰§è¡Œé¡ºåºå¹¶ä¸”å…·ä½“æ‰§è¡Œæœ‰å·®å¼‚çš„åœºæ™¯</p><h3 id="ç»“æ„-v10"><a class="header-anchor" href="#ç»“æ„-v10"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/template_pattern_uml_diagram.jpg" alt="æ¨¡æ¿æ¨¡å¼"></p><p>æ¨¡æ¿æ¨¡å¼ä¸ç­–ç•¥æ¨¡å¼çš„åŒºåˆ«åœ¨äºæ¨¡æ¿æ¨¡å¼æ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ¥æ”¹å˜è¡Œä¸ºï¼Œç­–ç•¥æ¨¡å¼æ˜¯é€šè¿‡æ”¹å˜å§”æ‰˜å¯¹è±¡çš„æ–¹å¼æ¥æ”¹å˜è¡Œä¸ºï¼›ç­–ç•¥æ¨¡å¼é’ˆå¯¹çš„åœºæ™¯æ˜¯ç›¸åŒç±»åœ¨å¤„ç†ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æ—¶å€™ç®—æ³•çš„é€‰æ‹©é—®é¢˜ï¼Œæ¨¡æ¿æ¨¡å¼é’ˆå¯¹çš„æ˜¯ç›¸åŒçš„ç±»åœ¨å¤„ç†ç›¸åŒçš„ä¸šåŠ¡åœºæ™¯ä¸‹ç®—æ³•ç»†å¾®çš„å·®å¼‚ç»“æ„ä¸Šã€‚</p><h2 id="è®¿é—®è€…æ¨¡å¼"><a class="header-anchor" href="#è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h2><h3 id="æ„å›¾-v11"><a class="header-anchor" href="#æ„å›¾-v11"></a>æ„å›¾</h3><p>å°†æ•°æ®å’Œæ•°æ®æ“ä½œåˆ†ç¦»</p><h3 id="åŠ¨æœº-v9"><a class="header-anchor" href="#åŠ¨æœº-v9"></a>åŠ¨æœº</h3><p>å¯¹ä¸€ä¸ªå¯¹è±¡éœ€è¦è¿›è¡Œå¤šæ¬¡æ“ä½œæ—¶ï¼Œä¸ºäº†é¿å…è¿™äº›æ“ä½œå°†å¯¹è±¡æ±¡æŸ“ï¼Œå¯ä»¥é€šè¿‡è®¿é—®è€…æ¨¡å¼å°†æ•°æ®å’Œæ“ä½œè¿›è¡Œéš”ç¦»ã€‚å®ç°ä¸åŒçš„è®¿é—®è€…è®¿é—®ä¸åŒçš„æ•°æ®ã€‚</p><h3 id="ç»“æ„-v11"><a class="header-anchor" href="#ç»“æ„-v11"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/visitor_pattern_uml_diagram.jpg" alt="è®¿é—®è€…æ¨¡å¼"></p><p>è®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ˜¯åœ¨äºæ•°æ®å¯¹è±¡ä¼šé’ˆå¯¹ä¸åŒçš„è®¿é—®è€…å®šä¹‰å‡ºä¸åŒçš„è¡Œä¸ºï¼Œç”±äºè®¿é—®è€…çŸ¥é“è¢«è®¿é—®çš„æ•°æ®å¯¹è±¡ä¸­çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤è®¿é—®è€…å¯ä»¥æ ¹æ®ä¸åŒçš„å¯¹è±¡å®šä¹‰å‡ºä¸åŒçš„è¡Œä¸º</p><p>è®¿é—®è€…çš„å¥½å¤„åœ¨äºå°†æ•°æ®å¯¹è±¡çš„æ“ä½œå»¶è¿Ÿåˆ°çš„è®¿é—®è€…é‚£ä¸€æ­¥ä¸­å»äº†ï¼Œé€šè¿‡å®šä¹‰ä¸åŒçš„è®¿é—®è€…å¯ä»¥æ‰§è¡Œä¸åŒçš„åŠ¨ä½œã€‚</p><h2 id="è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾"><a class="header-anchor" href="#è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾"></a>è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾</h2><p><a href="https://imgtu.com/i/gJVn2Q"><img src="https://z3.ax1x.com/2021/05/08/gJVn2Q.png" alt="è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾"></a></p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-ç»“æ„å‹æ¨¡å¼</title>
      <link href="2021/04/24/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
      <url>2021/04/24/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-ç»“æ„å‹æ¨¡å¼</h1><h2 id="ç»“æ„å‹æ¨¡å¼"><a class="header-anchor" href="#ç»“æ„å‹æ¨¡å¼"></a>ç»“æ„å‹æ¨¡å¼</h2><blockquote><p>ç»“æ„å‹æ¨¡å¼æ¶‰åŠåˆ°çš„æ˜¯å¦‚ä½•ç»„ç»‡ç±»å’Œå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»,ä»¥ä¾¿è·å¾—æ›´å¤§çš„ç»„ç»‡ç»“æ„å’Œæ›´å¥½çš„å¯æ‰©å±•æ€§ã€‚ç»“æ„æ€§æ¨¡å¼å¾€å¾€é‡‡ç”¨ç»§æ‰¿å’Œç»„åˆä¸¤ç§æ‰‹æ®µæ¥å®ç°ï¼Œå…³æ³¨çš„é‡ç‚¹åœ¨äºå¯¹è±¡ä¹‹é—´ç›¸äº’ç»„åˆå¼•ç”¨çš„å…³ç³»ä¸Šã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§å…·ä½“çš„æ¨¡å¼ï¼š</p></blockquote><ol><li>é€‚é…å™¨æ¨¡å¼</li><li>æ¡¥æ¥æ¨¡å¼</li><li>ç»„åˆæ¨¡å¼</li><li>è£…é¥°æ¨¡å¼</li><li>å¤–è§‚æ¨¡å¼</li><li>äº«å…ƒæ¨¡å¼</li><li>ä»£ç†æ¨¡å¼</li></ol><h2 id="é€‚é…å™¨æ¨¡å¼"><a class="header-anchor" href="#é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h2><h3 id="æ„å›¾"><a class="header-anchor" href="#æ„å›¾"></a>æ„å›¾</h3><blockquote><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·ç«¯æ‰€æœŸæœ›èƒ½ä½¿ç”¨çš„å¦å¤–ä¸€ä¸ªæ¥å£ã€‚Adapteræ¨¡å¼ä½¿åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹ä¸èƒ½åœ¨ä¸€èµ·ä½¿ç”¨çš„ç±»èƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªä¸­é—´é€‚é…ç±»ä»è€Œèƒ½ä¸€èµ·å·¥ä½œäº†</p></blockquote><h3 id="åˆ«å"><a class="header-anchor" href="#åˆ«å"></a>åˆ«å</h3><p>Wrapper</p><h3 id="ç»“æ„"><a class="header-anchor" href="#ç»“æ„"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/20210223-adapter.png" alt="é€‚é…å™¨æ¨¡å¼"><br>å¯ä»¥çœ‹åˆ°åŸæœ¬AudioPlayerä¸èƒ½ç›´æ¥å¼•ç”¨AdvanceMediaPlayerï¼Œä½†æ˜¯é€šè¿‡MediaAdapterå®ç°AudioPlayeråŒæ ·çš„æ¥å£åï¼Œåœ¨MediaAdapterä¸­å¼•ç”¨AdvanceMediaPlayerå®ç°å»æ‰§è¡Œå…·ä½“çš„æ–¹æ³•ï¼Œä»è€Œè¿‚å›å®ç°AdvanceMediaPlayerçš„è°ƒç”¨</p><h2 id="æ¡¥æ¥æ¨¡å¼"><a class="header-anchor" href="#æ¡¥æ¥æ¨¡å¼"></a>æ¡¥æ¥æ¨¡å¼</h2><h3 id="æ„å›¾-v2"><a class="header-anchor" href="#æ„å›¾-v2"></a>æ„å›¾</h3><blockquote><p>å°†æŠ½è±¡éƒ¨åˆ†å’Œå®ƒçš„å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä»è€Œä½¿å¾—ä¸¤è€…éƒ½å¯ä»¥ç‹¬ç«‹çš„å˜åŒ–ã€‚å‡ºç°æ¡¥æ¥æ¨¡å¼çš„åŸå› åœ¨å› ä¸ºç»§æ‰¿æ¥å£-å®ç°æ–¹æ³•è¿™ç§æ¨¡å¼ä¸‹æ¥å£å®šä¹‰å¥½çš„æ–¹æ³•å­ç±»å¿…é¡»æŒ‰ç…§å®šä¹‰è¿›è¡Œå®ç°ï¼Œç¼ºä¹çµæ´»æ€§(PS:ç»§æ‰¿æ–¹å¼æ˜¯ä¸€ç§å¼ºçº¦æŸçš„å…³ç³»ï¼Œé€‚ç”¨äºå¼ºçº¦æŸçš„åœºåˆ)</p></blockquote><h3 id="åˆ«å-v2"><a class="header-anchor" href="#åˆ«å-v2"></a>åˆ«å</h3><p>Hadnle/Body</p><h3 id="ç»“æ„-v2"><a class="header-anchor" href="#ç»“æ„-v2"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2018/06/1528771072-8457-5780d2384acdbb60ec07fc3c71a1.png" alt="æ¡¥æ¥æ¨¡å¼"></p><p>Abstractionå’ŒImplementoréƒ½æ˜¯æŠ½è±¡ç±»ï¼Œç”±äºAbstractionå†…éƒ¨æŒæœ‰ImplementoræŠ½è±¡ç±»ï¼Œä»è€Œä½¿å¾—è¿™ä¸¤ä¸ªæŠ½è±¡ç±»éƒ½å¯ä»¥ç‹¬ç«‹çš„å‘å±•ï¼Œæ¡¥æ¥æ¨¡å¼çš„æ ¸å¿ƒåº”è¯¥æ˜¯å°†ä¸šåŠ¡ä¸Šä¸åŒçš„æŠ½è±¡éƒ¨åˆ†å•ç‹¬åˆ†ç¦»å¼€ï¼Œç‹¬ç«‹æ¼”åŒ–ï¼Œå…³æ³¨çš„åº”è¯¥æ˜¯ä¸šåŠ¡ä¸ŠæŠ½è±¡çš„åŠŸèƒ½åˆ†ç¦»å’Œåœ¨æŠ½è±¡å¯¹è±¡ç±»çš„ç»„åˆã€‚é€šè¿‡åˆ†ç¦»å’Œç»„åˆæ›´å¥½çš„æè¿°ä¸€ä¸ªç±»</p><h2 id="ç»„åˆæ¨¡å¼"><a class="header-anchor" href="#ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h2><blockquote><p>å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤º&quot;éƒ¨åˆ†-æ•´ä½“&quot;çš„å±‚æ¬¡ç»“æ„ã€‚ç»„åˆæ¨¡å¼ä½¿å¾—ç”¨æˆ·å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„ä½¿ç”¨å…·æœ‰ä¸€è‡´æ€§ã€‚é€‚ç”¨äºå¸Œæœ›å¿½ç•¥ç»„åˆå¯¹è±¡å’Œå•ä¸ªå¯¹è±¡çš„ä¸åŒï¼Œç”¨æˆ·å°†ç»Ÿä¸€çš„ä½¿ç”¨ç»„åˆç»“æ„ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚</p></blockquote><h3 id="ç»“æ„-v3"><a class="header-anchor" href="#ç»“æ„-v3"></a>ç»“æ„</h3><p><a href="https://imgtu.com/i/cztr0P"><img src="https://z3.ax1x.com/2021/04/25/cztr0P.png" alt="cztr0P.png"></a><br>æä¾›Componentæ¥å£(æŠ½è±¡æ„ä»¶)ï¼Œè¯¥æ¥å£æœ‰ä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯å®¹å™¨æ„ä»¶(Composlte)ã€å¶å­æ„ä»¶(Leaf)ã€‚å®¢æˆ·ç«¯é€šè¿‡ç›´æ¥ä½¿ç”¨Componentæ¥å£ï¼Œæ¥å¿½ç•¥å…·ä½“æ˜¯å•ä¸ªå¯¹è±¡è¿˜æ˜¯ç»„åˆå¯¹è±¡æä¾›çš„æœåŠ¡ã€‚composlteå¯¹è±¡å®ç°äº†Componetæ‰€å®šä¹‰çš„ç®¡ç†å¶å­èŠ‚ç‚¹çš„æ–¹æ³•Add()ã€Remove()ã€GetChild()</p><p>ç»„åˆæ¨¡å¼åœ¨å®ç°ä¸Šæœ‰ä¸¤ç§æ–¹æ³•ï¼š1.é€æ˜ç»„åˆæ¨¡å¼ã€2.å®‰å…¨ç»„åˆæ¨¡å¼ã€‚<br>é€æ˜ç»„åˆæ¨¡å¼çš„ç‰¹ç‚¹æ˜¯å¶å­èŠ‚ç‚¹å’Œå®¹å™¨æ„ä»¶éƒ½è¦å®ç°ç›¸åŒçš„æ¥å£ï¼Œä½†æ˜¯å¶å­èŠ‚ç‚¹å’ŒæŠ½è±¡æ„ä»¶èŠ‚ç‚¹å…¶å®éƒ½ç›¸äº’å†—ä½™äº†éƒ¨åˆ†ä¸å±äºè‡ªå·±çš„æ–¹æ³•ã€‚<br>å®‰å…¨ç»„åˆæ¨¡å¼æŒ‡çš„æ˜¯åœ¨æŠ½è±¡æ„ä»¶ä¸­ä¸ä¼šå£°æ˜ä»»ä½•æœ‰å…³å®¹å™¨æ„ä»¶çš„æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨å®¹å™¨æ„ä»¶ä¸­å»å£°æ˜å¹¶å®ç°è¯¥æ–¹æ³•</p><h3 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h3><h4 id="java-awt-Container"><a class="header-anchor" href="#java-awt-Container"></a>java.awt.Container</h4><ul><li>Container.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Container</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span><span class="token punctuation">></span></span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Containerç±»å†…éƒ¨ç®¡ç†ä¸€ä¸ª<b>Component</b>çš„é›†åˆå¼•ç”¨ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯å®‰å…¨çš„ç»„åˆæ¨¡å¼å› æ­¤ç®¡ç†é›†åˆä¸­çš„å…ƒç´ çš„æ–¹æ³•æ˜¯åœ¨Containerä¸­å®ç°çš„</p><h2 id="è£…é¥°æ¨¡å¼"><a class="header-anchor" href="#è£…é¥°æ¨¡å¼"></a>è£…é¥°æ¨¡å¼</h2><blockquote><p>åŠ¨æ€çš„ä¸ºç›®æ ‡å¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ï¼Œè£…é¥°æ¨¡å¼(Decorator)åœ¨åŠŸèƒ½ä¸Šä¸ç»§æ‰¿ç±»ä¼¼éƒ½æ˜¯å¢å¼ºç›®æ ‡æ–¹æ³•ï¼Œä½†æ˜¯è£…é¥°æ¨¡å¼åœ¨ç»“æ„ä¸Šæ˜¯å‘ä¸Šçš„ï¼Œè€Œç»§æ‰¿åœ¨ç»“æ„ä¸Šæ˜¯å‘ä¸‹çš„ã€‚è£…é¥°æ¨¡å¼æ›´åŠ çš„çµæ´»ï¼Œæ²¡æœ‰ç»§æ‰¿é‚£ç§å¼ºä¾èµ–çš„å…³ç³»ã€‚</p></blockquote><h3 id="åˆ«å-v3"><a class="header-anchor" href="#åˆ«å-v3"></a>åˆ«å</h3><p>åŒ…è£…å™¨-Wrapper</p><h3 id="ç»“æ„-v4"><a class="header-anchor" href="#ç»“æ„-v4"></a>ç»“æ„</h3><p><a href="https://imgtu.com/i/gpGYfe"><img src="https://z3.ax1x.com/2021/04/26/gpGYfe.jpg" alt="è£…é¥°å™¨æ¨¡å¼"></a></p><p>Componentæ˜¯é¡¶å±‚æ¥å£ï¼Œåˆ†åˆ«åˆ«ç›®æ ‡å¯¹è±¡å’Œè£…é¥°å™¨å¯¹è±¡å®ç°ï¼Œè£…é¥°å™¨å¯¹è±¡é€šè¿‡å†…éƒ¨æŒæœ‰ç›®æ ‡å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå®¢æˆ·ç«¯åœ¨è°ƒç”¨ç›®æ ‡ç±»çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡è°ƒç”¨è£…é¥°ç±»çš„æä¾›å‡ºæ¥çš„æ–¹æ³•ã€‚è£…é¥°å™¨åœ¨æŒæœ‰ç›®æ ‡ç±»çš„å¼•ç”¨åå°±å¯ä»¥åœ¨æ‰§è¡Œæ–¹æ³•å‰åéƒ½è¿›è¡Œè‡ªå®šä¹‰å¢å¼ºå¤„ç†ï¼Œä»è€Œå®ç°å¯¹ç›®æ ‡ç±»çš„å¢å¼º</p><p>è£…é¥°å™¨çš„ä¼˜ç‚¹åœ¨äºï¼š</p><ol><li>æ¯”é™æ€ç»§æ‰¿çµæ´»ä¸”æ— å¼ºä¾èµ–æ€§</li><li>é¿å…ç±»ç»§æ‰¿ç»“æ„è¿‡é«˜</li></ol><p>è¿™ä¸ªç¼ºç‚¹ä¸ç”šç†è§£ï¼š</p><blockquote><p>è£…é¥°ç±»å’Œç›®æ ‡ç±»æ˜¯ä¸ä¸€æ ·çš„ï¼Œè£…é¥°ç±»å¯¹äºå…¶ä»–å¯¹è±¡æ¥è¯´æ˜¯é€æ˜çš„</p></blockquote><ol start="4"><li>è¿‡å¤šçš„ç±»(ä¸ªäººè®¤ä¸ºä¸æ˜¯ç¼ºç‚¹ï¼Œç±»æŒ‰ç…§èŒè´£åˆ’åˆ†æœ¬æ¥å°±ä¼šäº§ç”Ÿæ›´å¤šçš„å°ç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„ç±»)</li></ol><h2 id="å¤–è§‚æ¨¡å¼"><a class="header-anchor" href="#å¤–è§‚æ¨¡å¼"></a>å¤–è§‚æ¨¡å¼</h2><blockquote><p>ä¸ºå­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªä¸€è‡´çš„ç•Œé¢ï¼ŒFacadeæ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œä½¿å¾—å­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£éƒ½å®ç°è¯¥æ¥å£ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªç›¸åŒçš„æ¥å£ã€‚</p></blockquote><h3 id="åŠ¨æœº"><a class="header-anchor" href="#åŠ¨æœº"></a>åŠ¨æœº</h3><p>å¤æ‚çš„å­ç³»ç»Ÿæœ‰å¤šä¸ªç±»ï¼Œæ¯ä¸ªç±»æš´éœ²å‡ºä¸€äº›å…¬å…±æ–¹æ³•è¿™äº›æ–¹æ³•ç›¸äº’è°ƒç”¨å¹¶å¯¹å¤–æä¾›ä¸€ä¸ªæœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å¤–éƒ¨å®¢æˆ·ç«¯å¹¶ä¸å…³å¿ƒå­ç³»ç»Ÿçš„å†…éƒ¨è°ƒç”¨ï¼Œå°±å¯ä»¥é€šè¿‡Facadeçš„æ¨¡å¼å°†å­ç³»ç»Ÿæš´éœ²å‡ºå»çš„æ¥å£æ•´ç†æˆç‹¬ç«‹çš„æ¥å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><a href="https://imgtu.com/i/gCcIqx"><img src="https://z3.ax1x.com/2021/04/27/gCcIqx.png" alt="é—¨é¢æ¨¡å¼"></a></p><ul><li><p>Facade<br>å°†è¯·æ±‚å‘é€ç»™å­ç³»ç»Ÿå¯¹è±¡</p></li><li><p>Subsystem class<br>å®ç°å­ç³»ç»ŸåŠŸèƒ½<br>å¤„ç†æœ‰FacadeæŒ‡æ´¾çš„ä»»åŠ¡</p></li></ul><h3 id="å®ä¾‹-v2"><a class="header-anchor" href="#å®ä¾‹-v2"></a>å®ä¾‹</h3><ul><li><p>JdbcUtil.java<br>JdbcUtilå°†æœ‰å…³jdbcçš„æ“ä½œå°è£…æˆä¸ºä¸€ä¸ªæ–¹æ³•ï¼Œå¯¹å¤–æä¾›æœåŠ¡</p></li><li><p>RequestFacade.java<br>Tomcatçš„RequestFacade.java</p></li></ul><h2 id="äº«å…ƒæ¨¡å¼"><a class="header-anchor" href="#äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h2><blockquote><p>è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆçš„æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ï¼Œé€šä¿—çš„æ¥å°†å°±æ˜¯ç¼“å­˜å…·ä½“å¯¹è±¡ï¼Œåœ¨ä½¿ç”¨æ—¶è¿”å›è¯¥å¯¹è±¡ã€‚ä¸å•ä¾‹æ¨¡å¼ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå•ä¾‹æ¨¡å¼è¦ä¿è¯å…¨å±€å”¯ä¸€ã€‚äº«å…ƒæ¨¡å¼ä¸ç”¨ä¿è¯å…¨å±€å”¯ä¸€ï¼Œå¹¶ä¸”å¯ä»¥ç»§ç»­åˆ›å»ºå¯¹è±¡ã€‚äº«å…ƒæ¨¡å¼ä¼šé€šè¿‡å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€ä¸¤ä¸ªæ ‡è¯†æ¥ä¿è¯å¯¹è±¡è¡Œä¸ºçš„å†…éƒ¨ä¸€è‡´æ€§å’Œå¤–éƒ¨å·®å¼‚æ€§</p></blockquote><h3 id="ç»“æ„-v5"><a class="header-anchor" href="#ç»“æ„-v5"></a>ç»“æ„</h3><p><a href="https://imgtu.com/i/gC5iBd"><img src="https://z3.ax1x.com/2021/04/28/gC5iBd.png" alt="äº«å…ƒæ¨¡å¼"></a></p><h3 id="å®ä¾‹-v3"><a class="header-anchor" href="#å®ä¾‹-v3"></a>å®ä¾‹</h3><ul><li>Stringå¸¸é‡æ± </li><li>çº¿ç¨‹æ± </li></ul><h2 id="ä»£ç†æ¨¡å¼"><a class="header-anchor" href="#ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h2><blockquote><p>ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®</p></blockquote><h3 id="åˆ«å-v4"><a class="header-anchor" href="#åˆ«å-v4"></a>åˆ«å</h3><p>Surrogate</p><h3 id="åŠ¨æœº-v2"><a class="header-anchor" href="#åŠ¨æœº-v2"></a>åŠ¨æœº</h3><p>ä»£ç†æ¨¡å¼ä¸ºå¯¹è±¡æä¾›äº†ä¸€ä¸ªå¯è‡ªå®šä¹‰çš„è®¿é—®å¯¹è±¡ï¼Œå¯ä»¥å®ç°<b>è¿œç¨‹ä»£ç†</b>ã€<b>è™šä»£ç†</b>ã€<b>ä¿æŠ¤ä»£ç†</b>ã€<b>æ™ºèƒ½æŒ‡å¼•</b>ç­‰åŠŸèƒ½<br>è™šä»£ç†:æŒ‡çš„æ˜¯ä¹Ÿå°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œå°†åˆå§‹åŒ–å»¶è¿Ÿåˆ°è¿è¡Œæ—¶<br>ä¿æŠ¤ä»£ç†/è™šä»£ç†:éƒ½æ˜¯å¯¹ä»£ç†å¯¹è±¡çš„å¢å¼º</p><h3 id="ç»“æ„-v6"><a class="header-anchor" href="#ç»“æ„-v6"></a>ç»“æ„</h3><p><a href="https://z3.ax1x.com/2021/04/28/gC5ujg.png">![ä»£ç†æ¨¡å¼]</a>](<a href="https://imgtu.com/i/gC5ujg">https://imgtu.com/i/gC5ujg</a>)</p><p>ä»£ç†æ¨¡å¼ä¾§é‡äºå¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®æ§åˆ¶ä¸Šï¼Œè£…é¥°æ¨¡å¼ä¾§é‡äºå¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½å¢å¼ºä¸Šã€‚ä»£ç†æ¨¡å¼ä¸»è¦æ˜¯å¯¹ä¸å¯è§çš„å¯¹è±¡è¿›è¡Œè®¿é—®çš„ä»£ç†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼</title>
      <link href="2021/04/17/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
      <url>2021/04/17/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼</h1><h2 id="å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼"><a class="header-anchor" href="#å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼"></a>å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼</h2><blockquote><p>å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼æŠ½è±¡äº†å¯¹è±¡çš„å®ä¾‹åŒ–è¿‡ç¨‹.å¸®åŠ©ä¸€ä¸ªç³»ç»Ÿç‹¬ç«‹äºå¦‚ä½•åˆ›å»ºã€ç»„åˆå’Œè¡¨ç¤ºå®ƒçš„é‚£äº›å¯¹è±¡ã€‚ä¸€ä¸ªç±»å‹åˆ›å»ºæ¨¡å¼ä½¿ç”¨ç»§æ‰¿æ”¹å˜è¢«å®ä¾‹åŒ–çš„ç±»ï¼Œè€Œä¸€ä¸ªå¯¹è±¡åˆ›å»ºå‹æ¨¡å¼å°†å®ä¾‹åŒ–å§”æ‰˜ç»™å¦å¤–ä¸€ä¸ªå¯¹è±¡</p></blockquote><p>åˆ›å»ºå‹æ¨¡å¼çš„ä¸»è¦ç‰¹ç‚¹æ˜¯è¯¥æ¨¡å¼èšç„¦äºå¯¹è±¡çš„åˆ›å»ºä¸Šï¼Œå…³æ³¨äºå¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ã€‚å› ä¸ºåŒä¸€ä¸ªç±»ä¸åŒçš„å®ä¾‹åŒ–è¿‡ç¨‹ä¼šå¯¹è¯¥ç±»æ‰€è¡¨ç°å‡ºæ¥çš„è¡Œä¸ºäº§ç”Ÿå½±å“ã€‚ä»è€Œåœ¨åˆ›å»ºæ—¶ï¼Œé€šè¿‡ä¸åŒçš„è®¾è®¡æ¨¡å¼å°†è¯¥è¿‡ç¨‹æŠ½è±¡å‡ºæ¥é€‚åº”ä¸åŒçš„åœºæ™¯</p><p>åˆ›å»ºå‹æ¨¡å¼ä¸»è¦æœ‰ä»¥ä¸‹5ç§ç±»å‹ï¼š</p><ol><li>æŠ½è±¡å·¥å‚æ¨¡å¼</li><li>æ„é€ å™¨æ¨¡å¼</li><li>å·¥å‚æ¨¡å¼</li><li>åŸå‹æ¨¡å¼</li><li>å•ä¾‹æ¨¡å¼</li></ol><h2 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a class="header-anchor" href="#æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h2><h3 id="æ„å›¾"><a class="header-anchor" href="#æ„å›¾"></a>æ„å›¾</h3><blockquote><p>æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œè€Œæ— éœ€æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»</p></blockquote><h3 id="åˆ«å"><a class="header-anchor" href="#åˆ«å"></a>åˆ«å</h3><p>Kit</p><h3 id="åŠ¨æœº"><a class="header-anchor" href="#åŠ¨æœº"></a>åŠ¨æœº</h3><p>ä¸ºè§£å†³å¯¹è±¡å·¥å‚çš„åˆ›å»ºé—®é¢˜ã€‚å½“ä¸€ä¸ªä¸šåŠ¡åœºæ™¯éœ€è¦å¤šä¸ªå·¥å‚å®ä¾‹æ¥åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¦‚ä½•åˆ›å»ºè¿™äº›å·¥å‚å°±å¯ä»¥ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼æ¥è¿›è¡Œã€‚è¿™ä¸ªæ¨¡å¼æ“ä½œçš„å¯¹è±¡æ˜¯æ˜¯å·¥å‚å¯¹è±¡ï¼Œè€Œä¸æ˜¯å…·ä½“å·¥å‚å¯¹è±¡äº§ç”Ÿçš„å®ä¾‹å¯¹è±¡ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯å¯¹å¤–éƒ¨æ¥è¯´åªéœ€è¦ä¾èµ–AbstractFactoryå’ŒAbstractProductå°±å¯ä»¥äº†ï¼Œä¸ç”¨å…³ç³»å…·ä½“BeanFactoryå’ŒProductFactoryæ˜¯æ€ä¹ˆæ ·è¢«åˆ›å»ºå’Œä¾èµ–çš„ã€‚å¯¹AbstractFactoryå†…éƒ¨å®ç°äº†Factoryå’ŒProductçš„èšåˆã€‚åå¤„åœ¨äºå¢åŠ ä¸€ä¸ªProductyæ—¶ä¼šåŒæ—¶ä¿®æ”¹Abstractå’Œåˆ›å»ºæ–°çš„å…·ä½“çš„BeanFactoryã€‚</p><h3 id="ç»“æ„"><a class="header-anchor" href="#ç»“æ„"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/3E13CDD1-2CD2-4C66-BD33-DECBF172AE03.jpg" alt="æŠ½è±¡å·¥å‚æ¨¡å¼"></p><h3 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h3><h4 id="ç®€å•å®ç°"><a class="header-anchor" href="#ç®€å•å®ç°"></a>ç®€å•å®ç°</h4><ul><li>AbstractFactory.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractFactory</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>AbstractFactoryæŠ½è±¡ç±»å®šä¹‰è·å–å¯¹è±¡çš„æ–¹æ³•</p><ul><li>ObjectFactory1</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectFactory1</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractFactory</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Shape</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> objectType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>objectType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"object1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Object1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>objectType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"object2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Object1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ObjectFactory1ä½œä¸ºå·¥å‚ç±»ç»§æ‰¿æŠ½è±¡å·¥å‚ç±»ï¼Œå¹¶å®ç°å…·ä½“çš„æŠ½è±¡æ–¹æ³•ç”Ÿäº§å¯¹è±¡</p><ul><li>Client</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span><span class="token punctuation">&#123;</span>    <span class="token comment">//1. ç”Ÿæˆå·¥å‚ç±»</span>    <span class="token keyword">public</span> <span class="token class-name">AbstractFactory</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> classType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//2. é€šè¿‡å·¥å‚ç±»ç”Ÿæˆäº§å“</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">AbstractFactory</span> factory <span class="token operator">=</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token string">"classType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> obj <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token string">"objectType"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å®¢æˆ·ç«¯ä¸­ä¸»è¦æœ‰ä¸¤æ­¥ï¼Œç¬¬ä¸€ä¸ªæ˜¯è·å–å…·ä½“çš„å·¥å‚ç±»ã€‚ç¬¬äºŒä¸ªæ˜¯æ ¹æ®å·¥å‚ç±»è·å–å¯¹åº”çš„äº§å“ã€‚ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·¥å‚çš„ç”Ÿæˆå’Œäº§å“çš„ç”Ÿæˆéƒ½éœ€è¦æŒ‰ç…§ä¸åŒçš„ç±»å‹æ¥é€‰æ‹©ç”Ÿæˆçš„å…·ä½“å®ç°ã€‚æŠ½è±¡å·¥å‚æ¨¡å¼ç®¡ç†çš„æ˜¯å·¥å‚ç±»ã€‚</p><h4 id="Springä¸­çš„æŠ½è±¡å·¥å‚æ¨¡å¼"><a class="header-anchor" href="#Springä¸­çš„æŠ½è±¡å·¥å‚æ¨¡å¼"></a>Springä¸­çš„æŠ½è±¡å·¥å‚æ¨¡å¼</h4><p><strong>AbstractBeanFactory__ä¸»è¦æœ‰ä¸‰ä¸ªå®ç°ç±»__XmlBeanFactory(å·²è¿‡æ—¶)</strong>ã€<strong>AbstractAutowireCapableBeanFactory</strong>ã€<strong>DefaultListableBeanFactory</strong><br>å…¶ä¸­ä¸»è¦ä½¿ç”¨çš„æ˜¯ä½œä¸ºè‡ªåŠ¨è£…é…çš„å·¥å‚ç±»AbstractAutowireCapableBeanFactory</p><h2 id="buildæ¨¡å¼"><a class="header-anchor" href="#buildæ¨¡å¼"></a>buildæ¨¡å¼</h2><h3 id="æ„å›¾-v2"><a class="header-anchor" href="#æ„å›¾-v2"></a>æ„å›¾</h3><blockquote><p>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»,ä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒå«ä¹‰çš„å¯¹è±¡ã€‚æ„é€ è€…æ¨¡å¼è¦æ±‚æ„é€ å¯¹è±¡è¶³å¤Ÿå¤æ‚å¹¶ä¸”èƒ½å¤ŸæŒ‰ç…§éƒ¨åˆ†å‚æ•°è¿›è¡Œå¤„ç†ï¼Œæ„é€ è€…æ¨¡å¼å°†å†…éƒ¨å¯¹è±¡åˆå§‹åŒ–çš„ç»†èŠ‚å°è£…èµ·æ¥ï¼Œå¤–éƒ¨å¯¹è±¡ä¹‹é—´è°ƒç”¨å³å¯</p></blockquote><h3 id="ç»“æ„-v2"><a class="header-anchor" href="#ç»“æ„-v2"></a>ç»“æ„</h3><p><a href="https://imgtu.com/i/cqsLl9"><img src="https://z3.ax1x.com/2021/04/22/cqsLl9.png" alt="æ„é€ è€…æ¨¡å¼"></a></p><h3 id="å®ä¾‹-v2"><a class="header-anchor" href="#å®ä¾‹-v2"></a>å®ä¾‹</h3><ul><li>lombokä¸­çš„@Builder</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserParam</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//DELOMBOKä¹‹åçš„ä»£ç </span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserParam</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>        <span class="token class-name">UserParam</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserParamBuilder</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserParamBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UserParamBuilder</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>            <span class="token class-name">UserParamBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">public</span> <span class="token class-name">UserParamBuilder</span> <span class="token function">userName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">public</span> <span class="token class-name">UserParamBuilder</span> <span class="token function">password</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">public</span> <span class="token class-name">UserParam</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserParam</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token string">"UserParam.UserParamBuilder(userName="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">+</span> <span class="token string">", password="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°lombokçš„@Builderæ³¨è§£åªæ˜¯åœ¨å†…éƒ¨è®¾ç½®äº†ä¸€ä¸ªé™æ€æ–¹æ³•å’Œé™æ€ç±»æ¥ç”Ÿæˆbuildæ–¹å¼ï¼Œå°†__Direct__çš„èŒè´£äº¤ç»™ç±»çš„ä½¿ç”¨è€…å»å¤„ç†äº†ã€‚</p><h2 id="å·¥å‚æ¨¡å¼"><a class="header-anchor" href="#å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h2><h3 id="æ„å›¾-v3"><a class="header-anchor" href="#æ„å›¾-v3"></a>æ„å›¾</h3><blockquote><p>å®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å…·ä½“çš„ç±»å¯¹è±¡ã€‚Factort Methodä½¿å¾—ç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°äº†å­ç±»ä½¿ç”¨çš„æ—¶å€™ã€‚</p></blockquote><h3 id="åˆ«å-v2"><a class="header-anchor" href="#åˆ«å-v2"></a>åˆ«å</h3><p>è™šæ„é€ å™¨(Virtual Constructor)</p><h3 id="ç»“æ„-v3"><a class="header-anchor" href="#ç»“æ„-v3"></a>ç»“æ„</h3><p><a href="https://imgtu.com/i/cOCXVJ"><img src="https://z3.ax1x.com/2021/04/22/cOCXVJ.jpg" alt="å·¥å‚æ¨¡å¼"></a></p><p>åœ¨å›¾ä¸­å¯ä»¥çœ‹åˆ°äº§å“å¿…é¡»æŠ½è±¡å‡ºä¸€ä¸ªæ¥å£ï¼Œç„¶ååœ¨é€šè¿‡å·¥å‚å®šä¹‰åˆ›å»ºäº§å“çš„æ–¹æ³•ã€‚é€šè¿‡é›†æˆå·¥å‚æ¥å£å®ç°ä¸åŒçš„äº§å“çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p><h3 id="å®ä¾‹-v3"><a class="header-anchor" href="#å®ä¾‹-v3"></a>å®ä¾‹</h3><h4 id="springå·¥å‚æ¨¡å¼"><a class="header-anchor" href="#springå·¥å‚æ¨¡å¼"></a>springå·¥å‚æ¨¡å¼</h4><ul><li>FactoryBean.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è·å–å…·ä½“çš„ç±»</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–ç±»çš„ç±»å‹</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ˜¯å¦æ˜¯å•ä¾‹</span><span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³›å‹Tæ˜¯æŠ½è±¡çš„äº§å“çš„æ¥å£,åœ¨FactoryBeançš„å®ç°ç±»ä¸Šå¯ä»¥æ ¹æ®æ„é€ å™¨æˆ–è€…åœ¨è°ƒç”¨getObject()æ–¹æ³•ä¹‹å‰è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•æ¥å¯¹ç”Ÿæˆçš„å¯¹è±¡è¿›è¡Œè‡ªå®šä¹‰çš„å‚æ•°é…ç½®,è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ä¸æ”¹å˜è°ƒç”¨ç«¯çš„é€»è¾‘ä»è€Œå¢åŠ ä¸€ä¸ªäº§å“å­ç±»</p><p>åœ¨å…·ä½“çš„å®ç°ä¸Š,å·¥å‚æ¨¡å¼æœ‰ä¸¤ç§æ–¹å¼,1. å·¥å‚ç±»ä½œä¸ºæŠ½è±¡ç±»,æä¾›æŠ½è±¡æ–¹æ³•,ç”±å®ç°è¯¥ç±»çš„å­ç±»å…·ä½“çš„å»åšåˆå§‹åŒ–äº§å“çš„æ“ä½œ;2.å·¥å‚ç±»ä¸åšä¸ºæŠ½è±¡ç±»,å¹¶ä¸”æä¾›é»˜è®¤çš„äº§å“åˆ›å»º</p><h2 id="åŸå‹æ¨¡å¼"><a class="header-anchor" href="#åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h2><h3 id="æ„å›¾-v4"><a class="header-anchor" href="#æ„å›¾-v4"></a>æ„å›¾</h3><blockquote><p>ç”¨åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»,å¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡</p></blockquote><h3 id="ç»“æ„-v4"><a class="header-anchor" href="#ç»“æ„-v4"></a>ç»“æ„</h3><p><a href="https://imgtu.com/i/cOmRSJ"><img src="https://z3.ax1x.com/2021/04/23/cOmRSJ.png" alt="åŸå‹æ¨¡å¼"></a></p><p>åŸå‹æ¨¡å¼æ˜¯é€šè¿‡æ‹·è´ä¸€ä¸ªç°æœ‰å¯¹è±¡ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡,éœ€è¦ä¸»è¦çš„æ˜¯åŸå‹æ¨¡å¼æ˜¯æ·±æ‹·è´è€Œä¸æ˜¯æµ…æ‹·è´</p><h2 id="å•ä¾‹æ¨¡å¼"><a class="header-anchor" href="#å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h2><h3 id="æ„å›¾-v5"><a class="header-anchor" href="#æ„å›¾-v5"></a>æ„å›¾</h3><blockquote><p>ä¿è¯ä¸€ä¸ªå…¨å±€åªæœ‰ä¸€ä¸ªç±»,å¹¶ä¸”æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹</p></blockquote><h3 id="ç»“æ„-v5"><a class="header-anchor" href="#ç»“æ„-v5"></a>ç»“æ„</h3><p><a href="https://www.runoob.com/wp-content/uploads/2014/08/62576915-36E0-4B67-B078-704699CA980A.jpg"><img src="https://z3.ax1x.com/2021/04/23/cOmRSJ.png" alt="å•ä¾‹æ¨¡å¼"></a></p><h3 id="å®ä¾‹-v4"><a class="header-anchor" href="#å®ä¾‹-v4"></a>å®ä¾‹</h3><p>Springä¸­çš„å•ä¾‹æ¨¡å¼</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€</title>
      <link href="2021/04/15/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80/"/>
      <url>2021/04/15/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€</h1><h2 id="è®¾è®¡æ¨¡å¼ç®€ä»‹"><a class="header-anchor" href="#è®¾è®¡æ¨¡å¼ç®€ä»‹"></a>è®¾è®¡æ¨¡å¼ç®€ä»‹</h2><ul><li>è®¾è®¡æ¨¡å¼åˆ—è¡¨</li></ul><ol><li>Abstract Factory</li></ol><blockquote><p>æä¾›ä¸€ä¸ª<b>åˆ›å»º</b>ä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£,è€Œæ— éœ€æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»</p></blockquote><ol start="2"><li>Adapter</li></ol><blockquote><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·ç«¯å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£.Adapteræ¨¡å¼ä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½åœ¨ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»å¯ä»¥åœ¨ä¸€èµ·å·¥ä½œ</p></blockquote><ol start="3"><li>Bridge</li></ol><blockquote><p>ä½¿å¾—æŠ½è±¡éƒ¨åˆ†ä¸å®ƒçš„å®ç°éƒ¨åˆ†åˆ†ç¦»,ä½¿å¾—å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹çš„å˜åŒ–</p></blockquote><ol start="4"><li>Builder</li></ol><blockquote><p>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»,ä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„å¯¹è±¡</p></blockquote><ol start="5"><li>Chain of Responsibility</li></ol><blockquote><p>ä¸ºè§£é™¤è¯·æ±‚çš„å‘é€è€…å’Œæ¥å—è€…ä¹‹é—´çš„è€¦åˆ,ä½¿å¾—å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚.å°†è¿™äº›å¤„ç†å¯¹è±¡è¿æˆé“¾,å¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¯¥è¯·æ±‚,ç›´åˆ°é“¾å°¾</p></blockquote><ol start="6"><li>Command</li></ol><blockquote><p>å°†ä¸€ä¸ªè¯·æ±‚å°è£…æˆä¸ºä¸€ä¸ªå¯¹è±¡,ä»è€Œä½¿ä½ å¯ç”¨ä¸åŒçš„è¯·æ±‚å¯¹å®¢æˆ·è¿›è¡Œå‚æ•°åŒ–;å¯¹è¯·æ±‚æ’é˜Ÿæˆ–è®°å½•æ—¥å¿—,ä»¥åŠæ”¯æŒå¯å–æ¶ˆçš„æ“ä½œ</p></blockquote><ol start="7"><li>Composite</li></ol><blockquote><p>å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€™éƒ¨åˆ†-æ•´ä½“â€™çš„å±‚æ¬¡æœºæ„.Compositeä½¿å¾—å®¢æˆ·å¯¹å•ä¸ªæˆ–å¤åˆå¯¹è±¡çš„ä½¿ç”¨å…·æœ‰ä¸€è‡´æ€§</p></blockquote><ol start="8"><li>Decorator</li></ol><blockquote><p>åŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£.å°±æ‰©å±•åŠŸèƒ½è€Œè¨€Decoratoræ¯”å­—èŠ‚ç”Ÿäº§å­ç±»æ›´ä¸ºçµæ´»</p></blockquote><ol start="9"><li>Facade</li></ol><blockquote><p>ä¸ºå­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªä¸€è‡´çš„ç•Œé¢,Facadeå®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¬¡çš„æ¥å£,è¿™ä¸ªæ¥å£ä½¿å¾—å­ç³»ç»Ÿæ›´åŠ æ˜“ç”¨</p></blockquote><ol start="10"><li>Factory Method</li></ol><blockquote><p>å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£,è®©å­ç±»å»å†³å®šå°†é‚£ä¸ªç±»è¿›è¡Œå®åˆ—åŒ–,Factory Methodä½¿å¾—ç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°äº†å­ç±»ä¸­</p></blockquote><ol start="11"><li>Flyweight</li></ol><blockquote><p>è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆçš„æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡</p></blockquote><ol start="12"><li>Interpreter</li></ol><blockquote><p>ç»™å®šä¸€ä¸ªè¯­è¨€,å®šä¹‰å®ƒçš„æ–‡æ³•çš„ä¸€ç§è¡¨ç¤º,å¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨,è¯¥è§£é‡Šå™¨ä½¿ç”¨è¯¥è¡¨ç¤ºæ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­</p></blockquote><ol start="13"><li>Iterator</li></ol><blockquote><p>æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ ,è€Œåˆä¸éœ€è¦æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤º</p></blockquote><ol start="14"><li>Mediator</li></ol><blockquote><p>ç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—çš„å¯¹è±¡äº¤äº’.ä¸­ä»‹è€…ä½¿å¾—å„ä¸ªå¯¹è±¡ä¸éœ€è¦æ˜¾ç¤ºçš„ç›¸äº’å¼•ç”¨,ä»è€Œä½¿å¾—å…¶è€¦åˆæ¾æ•£,è€Œä¸”å¯ç”¨ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’</p></blockquote><ol start="15"><li>Memento</li></ol><blockquote><p>åœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹,æ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€,å¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€.è¿™æ ·ä»¥åå°±å¯ä»¥å°†è¯¥å¯¹è±¡æ¢å¤åˆ°ä¿å­˜çŠ¶æ€</p></blockquote><ol start="16"><li>Observer</li></ol><blockquote><p>å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»,ä»¥ä¾¿äºå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶,æ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¯ä»¥å¾—åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨åˆ·æ–°</p></blockquote><ol start="17"><li>Prototype</li></ol><blockquote><p>ç”¨åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»,å¹¶é€šè¿‡æ‹·è´è¿™ä¸ªåŸå‹æ¥åˆ›å»ºæ–°çš„å¯¹è±¡</p></blockquote><ol start="18"><li>Proxy</li></ol><blockquote><p>ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶è¿™ä¸ªå¯¹è±¡çš„è®¿é—®</p></blockquote><ol start="19"><li>Singleton</li></ol><blockquote><p>ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹.å¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹</p></blockquote><ol start="20"><li>State</li></ol><blockquote><p>å…è®¸ä¸€ä¸ªå¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸º.å¯¹è±¡çœ‹èµ·æ¥ä¼¼ä¹ä¿®æ”¹äº†å®ƒæ‰€å±çš„ç±».</p></blockquote><ol start="21"><li>Strategy</li></ol><blockquote><p>å®šä¹‰ä¸€ç³»åˆ—çš„ç®—æ³•,æŠŠå®ƒä»¬å°è£…èµ·æ¥,ä½¿å¾—å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢,ä½¿å¾—ç®—æ³•çš„å˜åŒ–å¯ä»¥ç‹¬ç«‹ä¸å®¢æˆ·</p></blockquote><ol start="22"><li>Template Method</li></ol><blockquote><p>å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­ç®—æ³•çš„éª¨æ¶,è€Œå°†ä¸€äº›å…·ä½“æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­å»å®ç°.Template Methodä½¿å¾—ä¹‹ç±»å¯ä»¥å¤ç”¨çˆ¶ç±»å®šä¹‰çš„ç®—æ³•,å¹¶ä¸”è¿›è¡Œç»†èŠ‚çš„ä¿®æ”¹</p></blockquote><ol start="23"><li>visitor</li></ol><blockquote><p>è¡¨ç¤ºä¸€ä¸ªä½œç”¨äºæŸå¯¹è±¡ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œ.ä½¿å¾—ä½ å¯ä»¥åœ¨ä¸æ”¹å˜å„å…ƒç´ ç±»çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°æ“ä½œ</p></blockquote><ul><li>æ ¹æ®ç±»å‹åˆ’åˆ†</li></ul><table><thead><tr><th></th><th></th><th>ç›®çš„</th><th></th><th></th></tr></thead><tbody><tr><td></td><td></td><td>åˆ›å»ºå‹</td><td>ç»“æ„å‹</td><td>è¡Œä¸ºå‹</td></tr><tr><td>èŒƒå›´</td><td>ç±»</td><td>Factory Method</td><td>Adapter(ç±»)</td><td>Interpreter</br>Template Method</td></tr><tr><td></td><td>å¯¹è±¡</td><td>Abstract Factory</br>Builder</br>Prototype</br>Singleton</td><td>Adapter(å¯¹è±¡)</br>Bridge</br>Composite</br>Decorator</br>Facade</br>Flyweight</br>Proxy</br></td><td>Chain of Responsibility</br>Command</br>Iterator</br>Mediator</br>Memento</br>Observer</br>State</br>Strategy</br>Visitor</td></tr></tbody></table><ul><li>è®¾è®¡æ¨¡å¼ä¹‹é—´çš„å…³ç³»<br><a href="https://imgtu.com/i/cRdD4H"><img src="https://z3.ax1x.com/2021/04/15/cRdD4H.jpg" alt=""></a></li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„ä¸­çš„ä¸­ä½æ•°</title>
      <link href="2021/04/02/13.LeetCode/10.%E5%AF%BB%E6%89%BE%E4%B8%A4%E4%B8%AA%E6%AD%A3%E5%BA%8F%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0/"/>
      <url>2021/04/02/13.LeetCode/10.%E5%AF%BB%E6%89%BE%E4%B8%A4%E4%B8%AA%E6%AD%A3%E5%BA%8F%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h1>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„ä¸­çš„ä¸­ä½æ•°_LeetCode4</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><blockquote><p>ç»™å®šä¸¤ä¸ªå¤§å°åˆ†åˆ«ä¸º m å’Œ n çš„æ­£åºï¼ˆä»å°åˆ°å¤§ï¼‰æ•°ç»„ nums1 å’Œ nums2ã€‚è¯·ä½ æ‰¾å‡ºå¹¶è¿”å›è¿™ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ ä¸­ä½æ•° ã€‚</p></blockquote><p>ç¤ºä¾‹ 1ï¼š<br>è¾“å…¥ï¼šnums1 = [1,3], nums2 = [2]<br>è¾“å‡ºï¼š2.00000<br>è§£é‡Šï¼šåˆå¹¶æ•°ç»„ = [1,2,3] ï¼Œä¸­ä½æ•° 2</p><p>ç¤ºä¾‹ 2ï¼š<br>è¾“å…¥ï¼šnums1 = [1,2], nums2 = [3,4]<br>è¾“å‡ºï¼š2.50000<br>è§£é‡Šï¼šåˆå¹¶æ•°ç»„ = [1,2,3,4] ï¼Œä¸­ä½æ•° (2 + 3) / 2 = 2.5</p><p>ç¤ºä¾‹ 3ï¼š<br>è¾“å…¥ï¼šnums1 = [0,0], nums2 = [0,0]<br>è¾“å‡ºï¼š0.00000</p><p>ç¤ºä¾‹ 4ï¼š<br>è¾“å…¥ï¼šnums1 = [], nums2 = [1]<br>è¾“å‡ºï¼š1.00000</p><p>ç¤ºä¾‹ 5ï¼š<br>è¾“å…¥ï¼šnums1 = [2], nums2 = []<br>è¾“å‡ºï¼š2.00000</p><p>æç¤ºï¼š<br>nums1.length == m<br>nums2.length == n<br>0 &lt;= m &lt;= 1000<br>0 &lt;= n &lt;= 1000<br>1 &lt;= m + n &lt;= 2000<br>-106 &lt;= nums1[i], nums2[i] &lt;= 106</p><h2 id="ç¬¬ä¸€ç§è§£æ³•"><a class="header-anchor" href="#ç¬¬ä¸€ç§è§£æ³•"></a>ç¬¬ä¸€ç§è§£æ³•</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è½¬ç½®çŸ©é˜µ</title>
      <link href="2021/04/02/13.LeetCode/9.%E8%BD%AC%E7%BD%AE%E7%9F%A9%E9%98%B5/"/>
      <url>2021/04/02/13.LeetCode/9.%E8%BD%AC%E7%BD%AE%E7%9F%A9%E9%98%B5/</url>
      
        <content type="html"><![CDATA[<h1>è½¬ç½®çŸ©é˜µ_LeetCode867</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><blockquote><p>ç»™ä½ ä¸€ä¸ªäºŒç»´æ•´æ•°æ•°ç»„ matrixï¼Œ è¿”å› matrix çš„ è½¬ç½®çŸ©é˜µ ã€‚çŸ©é˜µçš„è½¬ç½®æ˜¯æŒ‡å°†çŸ©é˜µçš„ä¸»å¯¹è§’çº¿ç¿»è½¬ï¼Œäº¤æ¢çŸ©é˜µçš„è¡Œç´¢å¼•ä¸åˆ—ç´¢å¼•ã€‚</p></blockquote><p>ç¤ºä¾‹ 1ï¼š</p><p>è¾“å…¥ï¼šmatrix = [[1,2,3],[4,5,6],[7,8,9]]<br>è¾“å‡ºï¼š[[1,4,7],[2,5,8],[3,6,9]]<br>ç¤ºä¾‹ 2ï¼š</p><p>è¾“å…¥ï¼šmatrix = [[1,2,3],[4,5,6]]<br>è¾“å‡ºï¼š[[1,4],[2,5],[3,6]]</p><h2 id="è§£æ³•"><a class="header-anchor" href="#è§£æ³•"></a>è§£æ³•</h2><h3 id="ç¬¬ä¸€ç§è§£æ³•"><a class="header-anchor" href="#ç¬¬ä¸€ç§è§£æ³•"></a>ç¬¬ä¸€ç§è§£æ³•</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> matrix<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            matrix<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> matrix<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> matrix<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> matrix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ç§è§£æ³•é”™è¯¯,å› ä¸ºåªè€ƒè™‘äº†è¡Œæ•°å’Œåˆ—æ•°ç›¸ç­‰çš„æƒ…å†µ,æ²¡æœ‰è€ƒè™‘è¡Œæ•°å’Œåˆ—æ•°ä¸ç›¸ç­‰çš„äºŒç»´æ•°ç»„</p><h3 id="ç¬¬äºŒç§è§£æ³•"><a class="header-anchor" href="#ç¬¬äºŒç§è§£æ³•"></a>ç¬¬äºŒç§è§£æ³•</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">[</span>matrix<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            temp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ç§è§£æ³•èƒ½é€šè¿‡,ä½†æ˜¯å†…å­˜æ¶ˆè€—æ¯”è¾ƒå¤§,å› ä¸ºæ˜¯å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„,ç„¶åå¯¹åŸæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éå†ç¡®å®šä½ç½®</p><h3 id="ç¬¬ä¸‰ç§è§£æ³•"><a class="header-anchor" href="#ç¬¬ä¸‰ç§è§£æ³•"></a>ç¬¬ä¸‰ç§è§£æ³•</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> c <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span> r <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r <span class="token operator">*</span> c<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        temp<span class="token punctuation">[</span>i<span class="token operator">/</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">%</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span>i<span class="token operator">%</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">/</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ç§è§£æ³•å·§å¦™çš„è¿ç”¨åˆ°äº†å–ä½™å’Œæ¨¡é™¤ä¸¤ç§,ä½†æ˜¯åœ¨ç©ºé—´å¤æ‚åº¦ä¸Šå’Œç¬¬äºŒç§ç±»ä¼¼,ç”±äºæ•°ç»„å…·æœ‰ä¸å¯å˜æ€§,å› æ­¤æƒ³è¦å®ç°ç©ºé—´å¤æ‚åº¦å°çš„ä»£ç å¾ˆéš¾å®ç°.</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLæ€»ç»“</title>
      <link href="2021/03/30/6.mysql/MySQL%E6%80%BB%E7%BB%93/"/>
      <url>2021/03/30/6.mysql/MySQL%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>é€šè¿‡ä»¥ä¸Šå‡ ç¯‡æ–‡ç« åˆ†åˆ«ä»‹ç»äº†MySQLçš„æ–‡ä»¶ç³»ç»Ÿ/ç´¢å¼•/é”/äº‹åŠ¡ç­‰åŠŸèƒ½ç‚¹,è¿™ç¯‡æ–‡ç« å°†å¯¹è¿™äº›çŸ¥è¯†ç‚¹è¿›è¡Œæ±‡æ€»,æè¿°å‡ºMySQLå¤§æ¦‚çš„æ¶æ„</p></blockquote><h2 id="æ–‡ä»¶æ•°æ®"><a class="header-anchor" href="#æ–‡ä»¶æ•°æ®"></a>æ–‡ä»¶æ•°æ®</h2><p>MySQLåœ¨æ–‡ä»¶æ•°æ®ä¸Šå¯ä»¥åˆ’åˆ†ä¸º__MySQLç³»ç»Ÿæ•°æ®__/<strong>å­˜å‚¨å¼•æ“æ•°æ®</strong></p><ul><li>æ–‡ä»¶æ•°æ®<ul><li>ç³»ç»Ÿæ–‡ä»¶</li><li>å‚æ•°æ–‡ä»¶<br>å‚æ•°æ–‡ä»¶æŒ‡çš„æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶çš„å‚æ•°,ä¸»è¦åˆ†ä¸ºâ€™é™æ€å‚æ•°â€™å’Œâ€™åŠ¨æ€å‚æ•°â€™</li><li>æ—¥å¿—æ–‡ä»¶</li><li>ç³»ç»Ÿé”™è¯¯æ—¥å¿—æ–‡ä»¶</li><li>äºŒè¿›åˆ¶(binlog)<br>binlogç›®å‰æœ‰ä¸‰ç§è®°å½•æ ¼å¼åˆ†åˆ«æ˜¯STATEMENT/ROW/MIXED;RCå’ŒSTATEMENTæ ¼å¼ä¸å…¼å®¹,å› ä¸ºbinlogçš„æ˜¯åœ¨äº‹åŠ¡è¿›è¡Œæäº¤æ—¶å†™å…¥</li><li>æ…¢æŸ¥è¯¢æ—¥å¿—</li><li>æŸ¥è¯¢æ—¥å¿—</li><li>å¥—æ¥å­—æ–‡ä»¶<br>å¥—æ¥å­—æ–‡ä»¶æ˜¯UNIXä¸‹ä½¿ç”¨å¥—æ¥å­—é“¾æ¥æ–¹å¼æ‰“å¼€çš„socketæ–‡ä»¶</li><li>pidæ–‡ä»¶</li><li>è¡¨ç»“æ„æ–‡ä»¶<br>å®šä¹‰è¡¨ç»“æ„çš„æ–‡ä»¶,æ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªfrmçš„è¡¨ç»“æ„æ–‡ä»¶</li></ul></li><li>InnoDBå­˜å‚¨å¼•æ“æ–‡ä»¶<ul><li>è¡¨ç©ºé—´æ–‡ä»¶<br>å®é™…å­˜å‚¨æ•°æ®çš„æ–‡ä»¶,åç§°ä¸ºibdata1çš„æ–‡ä»¶ä½œä¸ºå…±äº«è¡¨ç©ºé—´æ–‡ä»¶,MySQLä¹Ÿæ”¯æŒä¸ºæ¯ä¸ªè¡¨å•ç‹¬è®¾ç½®è¡¨ç©ºé—´æ–‡ä»¶,åç¼€åä¸º.ibd</li><li>redolog<br>redoLogåˆç§°ä¸ºé‡åšæ—¥å¿—,æ–‡ä»¶åç§°ä¸ºib_logfile0/ib_logfile1</li></ul></li></ul><p><a href="https://imgtu.com/i/cESwqK"><img src="https://z3.ax1x.com/2021/04/01/cESwqK.png" alt="cESwqK.png"></a></p><h2 id="ç´¢å¼•ç³»ç»Ÿ"><a class="header-anchor" href="#ç´¢å¼•ç³»ç»Ÿ"></a>ç´¢å¼•ç³»ç»Ÿ</h2><p>MySQLçš„ç´¢å¼•ç³»ç»Ÿä¸»è¦æ˜¯ç”±äºB+ Treeç´¢å¼•ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„,ä¹Ÿæœ‰é‡‡ç”¨Hashè‡ªé€‚åº”ç´¢å¼•åœºæ™¯.</p><ul><li>ç´¢å¼•<ul><li>åˆ†ç±»<ul><li>B+Treeç´¢å¼•<br>B+ TREEç´¢å¼•ä½œä¸ºMySQLåº•å±‚æ•°æ®ç»“æ„çš„å¥½å¤„æ˜¯åœ¨äºB+TREEå¹³è¡¡ä¸”å±‚çº§ä¸é«˜å¹¶ä¸”å¶å­èŠ‚ç‚¹å¯ä»¥ä½œä¸ºèšé›†ç´¢å¼•</li><li>å…¨æ–‡ç´¢å¼•<br>MySQLçš„å…¨æ–‡ç´¢å¼•ä¹Ÿæ˜¯é‡‡ç”¨å€’æ’ç®—æ³•,é€šè¿‡å…³é”®å­—æ¥è¿›è¡Œæ–‡æ¡£æ˜ å°„,ç°å®å·¥ä½œä¸­æœªæ¶‰åŠåˆ°,å› æ­¤æœªè¯¦ç»†ç ”ç©¶</li><li>Hashç´¢å¼•<br>InnoDBåªæ”¯æŒè‡ªé€‚åº”çš„Hashç´¢å¼•,ä¸èƒ½æ˜¾ç¤ºçš„å»åˆ›å»ºå¹¶ä¸”è¦æ»¡è¶³Hashç´¢å¼•è‡ªåŠ¨åˆ›å»ºçš„æ¡ä»¶(ç­‰å€¼æŸ¥è¯¢/å‘½ä¸­èŒƒå›´/æŸ¥è¯¢é¢‘ç‡)</li></ul></li></ul></li></ul><h2 id="é”"><a class="header-anchor" href="#é”"></a>é”</h2><ul><li>é”<ul><li>é”åˆ†ç±»<ul><li>è¡Œçº§é”<ul><li>å…±äº«é”(Sé”)<br>å…±äº«é”å…è®¸äº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€è¡Œæ•°æ®</li><li>æ’ä»–é”(Xé”)<br>æ’ä»–é”æ˜¯ç‹¬å é”,ä¸å…è®¸å…¶ä»–äº‹åŠ¡è¯»å–æˆ–æ“ä½œæ•°æ®</li></ul></li><li>è¡¨é”<ul><li>æ„å‘å…±äº«é”(ISé”)<br>æ„å‘å…±äº«é”æ˜¯è¡¨ç»´åº¦çš„é”,æ„å‘å…±äº«é”æ˜¯åœ¨äº‹åŠ¡è¯»å–è¡¨ä¸­æŸè¡Œæ•°æ®æ—¶å€™è‡ªåŠ¨åŠ ä¸Šçš„,åŒç†æ„å‘æ’ä»–é”ä¹Ÿæ˜¯è¿™ä¸ªé€»è¾‘;è®¾è®¡æ„å‘é”çš„ä¸»è¦ç›®çš„æ˜¯åœ¨äºå½“äº‹åŠ¡æƒ³è¦è·å–åˆ°è¡¨é”æ—¶,å¯ä»¥ç›´æ¥é€šè¿‡æ˜¯å¦èƒ½è·å–åˆ°æ„å‘é”æ¥åˆ¤æ–­,ç›¸å½“äºä¸€ä¸ªè¡¨çº§åˆ«çš„é”æ ‡å¿—</li><li>æ„å‘æ’ä»–é”(IXé”)</li></ul></li><li>é”ç®—æ³•<ul><li>è¡Œé”<br>è¡Œé”çš„ä½œç”¨èŒƒå›´æ˜¯å¯¹æ•°æ®çš„æŸä¸€è¡Œè¿›è¡Œæ“ä½œ</li><li>é—´éš™é”<br>é—´éš™é”æ˜¯å¯¹æ•°æ®é—´éš™è¿›è¡Œä¸Šé”,è¿™æ ·å¯ä»¥é˜²æ­¢æ•°æ®å‡ºç°å¹»è¯»çš„æƒ…å†µ</li><li>Next-Key Lock<br>è¡Œé”+é—´éš™é”å°±æ˜¯Next-Key Lock</li><li>é”é™çº§<br>å½“å‘ç°å¯ä»¥ç”¨è¡Œæ•°æ—¶,Next-Keyä¼šé™çº§æˆè¡Œé”</li></ul></li></ul></li></ul></li></ul><h2 id="äº‹åŠ¡"><a class="header-anchor" href="#äº‹åŠ¡"></a>äº‹åŠ¡</h2><ul><li>äº‹åŠ¡<ul><li>äº‹åŠ¡çš„éš”ç¦»çº§åˆ«<ul><li>ä¸²è¡ŒåŒ–(Serializable)</li><li>è¯»æœªæäº¤(Read Uncommitted)</li><li>è¯»å·²æäº¤(Read Committed)</li><li>å¯é‡å¤è¯»(Repeatable Read)</li></ul></li><li>ä¸²è¡ŒåŒ–<br>ä¸²è¡ŒåŒ–æŒ‡çš„æ˜¯äº‹åŠ¡æŒ‰ç…§ä¸²è¡ŒåŒ–æ‰§è¡Œçš„ç»“æœæ‰§è¡Œ,InnoDBçš„ä¸²è¡ŒåŒ–æ˜¯é€šè¿‡å¢åŠ è¯»é”çš„æ–¹å¼æ¥å®ç°çš„</li><li>è¯»æœªæäº¤<br>è¯»æœªæäº¤æŒ‡çš„æ˜¯å½“å‰äº‹åŠ¡å¯ä»¥è¯»å–åˆ°å…¶ä»–äº‹åŠ¡å°šæœªæäº¤çš„æ•°æ®,åº•å±‚å®ç°æ˜¯å½“å‰äº‹åŠ¡ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼</li><li>è¯»å·²æäº¤<br>è¯»å·²æäº¤æŒ‡çš„æ˜¯äº‹åŠ¡ä¸­çš„SQLåœ¨æ‰§è¡Œæ—¶ä¼šå»è¯»å–æœ€åä¸€æ¬¡æäº¤çš„æ•°æ®ä¿¡æ¯</li><li>å¯é‡å¤è¯»<br>å¯é‡å¤è¯»æŒ‡çš„æ˜¯äº‹åŠ¡å¼€å§‹æ—¶ä¼šåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€ä¸”è‡ªå¢çš„äº‹åŠ¡ID,å¹¶ä¸”å¯é‡å¤è¯»åªèƒ½è¯»å–åˆ°å°äºç­‰äºè¯¥äº‹åŠ¡idçš„æ•°æ®;å¿«ç…§æ•°æ®æ˜¯é€šè¿‡UNDO LOGå®ç°çš„</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLäº‹åŠ¡</title>
      <link href="2021/03/27/6.mysql/MySQL%E4%BA%8B%E5%8A%A1/"/>
      <url>2021/03/27/6.mysql/MySQL%E4%BA%8B%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="äº‹åŠ¡çš„å®šä¹‰"><a class="header-anchor" href="#äº‹åŠ¡çš„å®šä¹‰"></a>äº‹åŠ¡çš„å®šä¹‰</h2><p>äº‹åŠ¡æ˜¯æ•°æ®åº“ä¸æ–‡ä»¶ç³»ç»Ÿæœ€é‡è¦çš„å·®å¼‚ä¹‹ä¸€,æ•°æ®åº“é€šè¿‡äº‹åŠ¡ä¿è¯äº†æ•°æ®çš„ACIDç‰¹æ€§,åˆ†åˆ«æ˜¯åŸå­æ€§/ä¸€è‡´æ€§/éš”ç¦»æ€§/æŒä¹…æ€§</p><h2 id="äº‹åŠ¡çš„åˆ†ç±»"><a class="header-anchor" href="#äº‹åŠ¡çš„åˆ†ç±»"></a>äº‹åŠ¡çš„åˆ†ç±»</h2><p>äº‹åŠ¡å¯ä»¥åˆ’åˆ†ä¸º:<br>1.æ‰å¹³äº‹åŠ¡ä»¥åŠå¸¦æœ‰ä¿å­˜ç‚¹çš„æ‰å¹³äº‹åŠ¡<br>2.é“¾äº‹åŠ¡<br>3.åµŒå¥—äº‹åŠ¡<br>4.åˆ†å¸ƒå¼äº‹åŠ¡</p><h2 id="äº‹åŠ¡çš„å®ç°"><a class="header-anchor" href="#äº‹åŠ¡çš„å®ç°"></a>äº‹åŠ¡çš„å®ç°</h2><p>InnoDBé€šè¿‡æ—¥å¿—ç³»ç»Ÿæ¥å®ç°äº‹åŠ¡,redo logå¯ä»¥ä¿è¯äº‹åŠ¡çš„åŸå­æ€§/ä¸€è‡´æ€§/æŒä¹…æ€§,undo logå¯ä»¥ä¿è¯äº‹åŠ¡çš„åŸå­æ€§å’ŒæŒä¹…æ€§</p><h3 id="redo-logçš„ä½œç”¨"><a class="header-anchor" href="#redo-logçš„ä½œç”¨"></a>redo logçš„ä½œç”¨</h3><p>redo logæ˜¯é‡åšæ—¥å¿—,é€šè¿‡æ¯æ¬¡äº‹åŠ¡æäº¤å‰å…ˆä¿®æ”¹è¯¥äº‹åŠ¡è¦ä¿®æ”¹çš„é¡µ,åœ¨æäº¤è¿‡ç¨‹ä¸­å¦‚æœä¸­æ–­,é€šè¿‡redo logå°±å¯ä»¥ç»§ç»­æäº¤äº‹åŠ¡</p><h3 id="undo-logçš„ä½œç”¨"><a class="header-anchor" href="#undo-logçš„ä½œç”¨"></a>undo logçš„ä½œç”¨</h3><p>undo logæ˜¯å›æ»šæ—¥å¿—,é€šè¿‡è®°å½•æ¯ä¸ªäº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®,åœ¨å›æ»šå‘ç”Ÿä¸­æ–­æ—¶,å¯ä»¥æ ¹æ®undo log ç»§ç»­è¿›è¡Œäº‹åŠ¡å›æ»š</p><h2 id="redo-log"><a class="header-anchor" href="#redo-log"></a>redo log</h2><p>redo logç”±ä¸¤éƒ¨åˆ†ç»„æˆâ€™redo log bufferâ€™å’Œâ€™redo log fileâ€™,åœ¨è¿›è¡Œäº‹åŠ¡connitä¹‹å‰éƒ½ä¼šå°†äº‹åŠ¡çš„æ‰€æœ‰æ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­è¿›è¡ŒæŒä¹…åŒ–<br>InnoDBæä¾›ä¸€ä¸ªå‚æ•°â€™innodb_flush_log_at_trx_commitâ€™æ¥æ§åˆ¶redo logçš„åˆ·ç›˜ç­–ç•¥,0:ç”±master threadè¿›è¡Œæ§åˆ¶ 1:æ¯æ¬¡æäº¤åè¿›è¡ŒåŒæ­¥åˆ·ç›˜ 2:æ¯æ¬¡æäº¤ååªæ˜¯å°†æ•°æ®æäº¤ç»™æ–‡ä»¶ç³»ç»Ÿ,ä¸è¿›è¡Œä¸»åŠ¨åˆ·ç›˜æ“ä½œ</p><h2 id="undo-log"><a class="header-anchor" href="#undo-log"></a>undo log</h2><p>undo logæ˜¯å›æ»šæ—¥å¿—,æ˜¯é€»è¾‘æ—¥å¿—å¹¶ä¸æ˜¯redo logçš„ç‰©ç†æ—¥å¿—,åªæ˜¯åœ¨é€»è¾‘ä¸Šä¿è¯äº†æ•°æ®å›æ»šåˆ°åŸå§‹çŠ¶æ€.ä¾‹å¦‚ç”¨æˆ·æ‰§è¡Œä¸€ä¸ªinsertæ“ä½œ,åœ¨undo logé‡Œé¢å°±éœ€è¦ä¸€ä¸ªdeleteæ“ä½œ</p><h2 id="MVVC"><a class="header-anchor" href="#MVVC"></a>MVVC</h2><p>å¤šç‰ˆæœ¬æ§åˆ¶,InnoDBä¼šåœ¨è¡Œè®°å½•ä¸Šé»˜è®¤å¢åŠ ä¸¤ä¸ªéšè—åˆ—æ¥ä½œä¸ºMVVCå®ç°çš„åŸºç¡€,åˆ†åˆ«æ˜¯DB_TRX_ID-æœ€æ–°ä¸€æ¬¡äº‹åŠ¡æäº¤ç‰ˆæœ¬å·/DB_ROLL_PTR-åˆ é™¤äº‹åŠ¡çš„ç‰ˆæœ¬å·<br>æ•°æ®è¡Œå’Œundo logç»„æˆäº†ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„æ•°æ®é“¾,é€šè¿‡å¯¹æ¯”ç‰ˆæœ¬å·å’Œundo logæ—¥å¿—å°†æ‰€éœ€è¦çš„æ•°æ®è¿˜åŸå‡ºæ¥</p><p>undo logè¿˜ä¼šé‡‡ç”¨æ®µçš„æ–¹å¼è¿›è¡Œä¿å­˜,åœ¨ä¸åŒçš„æ®µä¸­å­˜æ”¾undo log page,é€šè¿‡è¿™æ ·çš„æ–¹å¼è¿›è¡Œå­˜å‚¨</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLç´¢å¼•ä¸é”</title>
      <link href="2021/03/21/6.mysql/MySQL%E7%B4%A2%E5%BC%95%E4%B8%8E%E9%94%81/"/>
      <url>2021/03/21/6.mysql/MySQL%E7%B4%A2%E5%BC%95%E4%B8%8E%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h2 id="ç´¢å¼•"><a class="header-anchor" href="#ç´¢å¼•"></a>ç´¢å¼•</h2><p>InnoDBå­˜å‚¨å¼•æ“æ”¯æŒä»¥ä¸‹å‡ ç§ç´¢å¼•ç»“æ„:</p><ol><li>B+æ ‘ç´¢å¼•</li><li>å…¨æ–‡ç´¢å¼•</li><li>å“ˆå¸Œç´¢å¼•</li></ol><h3 id="B-æ ‘ç´¢å¼•"><a class="header-anchor" href="#B-æ ‘ç´¢å¼•"></a>B+æ ‘ç´¢å¼•</h3><p>ç»“æ„ä¸ºâ€™B+æ ‘â€™çš„ç´¢å¼•æœ‰èšé›†ç´¢å¼•/è¾…åŠ©ç´¢å¼•<br>èšé›†ç´¢å¼•æ˜¯ä»¥ä¸»é”®æ¥æ„é€ B+æ ‘,åœ¨å¶å­èŠ‚ç‚¹ä¸­å­˜æ”¾è¡Œè®°å½•,ä¹Ÿå°±æ˜¯å¶å­èŠ‚ç‚¹ç§°ä¸ºæ•°æ®é¡µ.<br>è¾…åŠ©ç´¢å¼•æ˜¯ä»¥ç´¢å¼•keyæ¥æ„é€ B+æ ‘,å¶å­èŠ‚ç‚¹è®°å½•çš„æ˜¯ä¸»é”®,å› æ­¤åœ¨è¿›è¡ŒæŸ¥æ‰¾æ˜¯ä¼šè¿›è¡Œä¸€æ¬¡è¯»å–èšé›†ç´¢å¼•çš„æ“ä½œ</p><h3 id="å…¨æ–‡ç´¢å¼•"><a class="header-anchor" href="#å…¨æ–‡ç´¢å¼•"></a>å…¨æ–‡ç´¢å¼•</h3><p>å…¨æ–‡ç´¢å¼•æŒ‡çš„æ˜¯å°†å­˜å‚¨ä¸æ•°æ®åº“ä¸­çš„å…¨éƒ¨æ•°æ®ä¸­çš„ä»»æ„å†…å®¹ä¿¡æ¯æŸ¥è¯¢å‡ºæ¥çš„æŠ€æœ¯.<br>å…¨æ–‡ç´¢å¼•ä¸»è¦æ˜¯ç”¨å€’æ’ç´¢å¼•çš„æŠ€æœ¯æ¥è¿›è¡Œå®ç°,å€’æ’ç´¢å¼•éœ€è¦ç”¨åˆ°ä¸€ä¸ªç´¢å¼•è¾…åŠ©è¡¨,å¯¹å…¨æ–‡ä¸­çš„å€¼è¿›è¡Œåˆ†è¯å’Œç´¢å¼•å®šä½</p><h3 id="å“ˆå¸Œç´¢å¼•"><a class="header-anchor" href="#å“ˆå¸Œç´¢å¼•"></a>å“ˆå¸Œç´¢å¼•</h3><p>å“ˆå¸Œç´¢å¼•æŒ‡çš„æ˜¯ç”¨å“ˆå¸Œç®—æ³•æ¥å­˜å‚¨ç´¢å¼•çš„ç»“æ„,InnoDBçš„å“ˆå¸Œç´¢å¼•ä¸èƒ½ç”±ç”¨æˆ·è‡ªå®šä¹‰,è€Œæ˜¯ç”±å®¢æˆ·è¿›è¡Œå¤šæ¬¡æŸ¥è¯¢å’Œå‘½ä¸­æŸç§æ¡ä»¶åä¼šå°†B+æ ‘ç´¢å¼•è¿›è¡Œå‡çº§è½¬æ¢æˆå“ˆå¸Œç´¢å¼•,è¿™ç§ç®—æ³•æœ‰ç‚¹ç±»ä¼¼JVMä¸­å¯¹çƒ­ç‚¹ä»£ç çš„JITæŠ€æœ¯,æå‰å°†çƒ­ç‚¹æ•°æ®æ‹¿å‡ºæ¥</p><h2 id="é”"><a class="header-anchor" href="#é”"></a>é”</h2><blockquote><p>é”æ˜¯æ•°æ®åº“ç³»ç»ŸåŒºåˆ«äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§.é”æœºåˆ¶ç”¨äºç®¡ç†å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®.InnoDBå­˜å‚¨å¼•æ“ä¼šåœ¨è¡Œçº§åˆ«ä¸Šå¯¹è¡¨æ•°æ®ä¸Šé”.</p></blockquote><h3 id="é”ç±»å‹"><a class="header-anchor" href="#é”ç±»å‹"></a>é”ç±»å‹</h3><p>InnoDBå­˜å‚¨å¼•æ“å®ç°äº†ä¸¤ç§æ ‡å‡†çš„è¡Œçº§é”</p><ul><li>å…±äº«é”(S Lock),å…è®¸äº‹åŠ¡è¯»ä¸€è¡Œæ•°æ®</li><li>æ’ä»–é”(X Lock),å…è®¸äº‹åŠ¡åˆ é™¤æˆ–æ›´æ–°ä¸€è¡Œæ•°æ®</li></ul><p>InnoDBå­˜å‚¨å¼•æ“æ”¯æŒå¤šç²’åº¦é”å®š,è¿™ç§é”å®šå…è®¸äº‹åŠ¡åœ¨è¡Œçº§ä¸Šçš„é”å’Œè¡¨çº§ä¸Šçš„é”åŒæ—¶å­˜åœ¨.<br>ä¸ºäº†æ”¯æŒåœ¨ä¸åŒç²’åº¦ä¸Šè¿›è¡ŒåŠ é”æ“ä½œ,InnoDBå­˜å‚¨å¼•æ“æ”¯æŒæ„å‘é”,æ„å‘é”å¯ä»¥åˆ†ä¸ºâ€™æ„å‘å…±äº«é”â€™/â€˜æ„å‘æ’ä»–é”â€™<br>æ„å‘å…±äº«é”:äº‹åŠ¡æƒ³è¦è·å¾—ä¸€å¼ è¡¨ä¸­çš„æŸå‡ è¡Œçš„å…±äº«é”<br>æ„å‘æ’ä»–é”:äº‹åŠ¡æƒ³è¦è·å¾—ä¸€å¼ è¡¨ä¸­çš„æŸå‡ è¡Œçš„æ’ä»–é”</p><h3 id="ä¸€è‡´æ€§éé”å®šè¯»"><a class="header-anchor" href="#ä¸€è‡´æ€§éé”å®šè¯»"></a>ä¸€è‡´æ€§éé”å®šè¯»</h3><p>'ä¸€è‡´æ€§éé”å®šè¯»â€™æŒ‡çš„æ˜¯InnoDBé€šè¿‡è¡Œçš„å¤šç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ,åœ¨è¯»å–æ—¶ä¸å¿…ç­‰å¾…Xé”çš„é‡Šæ”¾.<br>RCéš”ç¦»çº§åˆ«ä¸‹,ä¸€è‡´æ€§éé”å®šè¯»ä¸€å®šæ˜¯è¯»å–æœ€æ–°çš„ä¸€ä»½å¿«ç…§æ•°æ®<br>RRéš”ç¦»çº§åˆ«ä¸‹,ä¸€è‡´æ€§éé”å®šè¯»ä¸€å®šæ˜¯è¯»å–äº‹åŠ¡å¼€å§‹æ—¶çš„ä¸€ä»½å¿«ç…§æ•°æ®</p><h3 id="ä¸€è‡´æ€§é”å®šè¯»"><a class="header-anchor" href="#ä¸€è‡´æ€§é”å®šè¯»"></a>ä¸€è‡´æ€§é”å®šè¯»</h3><p>InnoDBé€šè¿‡ä¸¤ç§æ“ä½œæ˜¾å¼çš„æ”¯æŒä¸€è‡´æ€§é”å®šè¯»,ç¬¬ä¸€ç§æ˜¯</p><ul><li>SELECT * FOR UPDATE åŠ Xé”</li><li>SELECT * LOCK IN SHARE MODE åŠ Sé”</li></ul><h3 id="è‡ªå¢è®¡æ•°"><a class="header-anchor" href="#è‡ªå¢è®¡æ•°"></a>è‡ªå¢è®¡æ•°</h3><p>InnoDBçš„è‡ªå¢è®¡æ•°æ˜¯é€šè¿‡è¡¨ä¸Šçš„ä¸€ä¸ªè‡ªå¢é•¿è®¡æ•°å™¨æ¥è¿›è¡Œçš„,å½“æ’å…¥SQLæ‰§è¡Œå®Œæ¯•åè¯¥è‡ªå¢è®¡æ•°å™¨å°±å®Œæˆè‡ªå¢æ“ä½œå¹¶æäº¤</p><h3 id="é”ç®—æ³•"><a class="header-anchor" href="#é”ç®—æ³•"></a>é”ç®—æ³•</h3><ol><li>Record Lock:è¡Œé”</li><li>Gap Lock:é—´éš™é”</li><li>Next-Key Lock:è¡Œé”+é—´éš™é”</li></ol><ul><li>Next-Key Lockæ˜¯é»˜è®¤InnoDBé»˜è®¤é‡‡ç”¨çš„é”å®šç®—æ³•,ä½†æ˜¯å½“æŸ¥è¯¢æ—¶ä½¿ç”¨åˆ°äº†èšé›†ç´¢å¼•æ—¶ä¼šé™çº§æˆâ€™Record Lockâ€™é”.<br>è¿™é‡Œæœ‰ä¸€ä¸ªå°ç–‘é—®,InnoDBå¯¹äºInsertçš„æ“ä½œä¼šæ£€æŸ¥æ’å…¥è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•æ˜¯å¦è¢«é”å®š,å¦‚æœé”å®šåˆ™ä¸å…è®¸æ“ä½œ</li></ul><p>Next-Key Locåªåœ¨RRéš”ç¦»æ¨¡å¼ä¸‹ä½¿ç”¨,ä¸»è¦æ˜¯ä¸ºäº†è§£å†³RRæ¨¡å¼ä¸‹çš„å¹»è¯»é—®é¢˜(è¿™æ˜¯åˆæœ‰ä¸€ä¸ªç–‘é—®äº†æ—¢ç„¶RRæ¨¡å¼è¯»å–çš„æ˜¯æ•°æ®çš„å¿«ç…§,æŒ‰ç†è¯´è¿™ä¸ªæ—¶å€™åº”è¯¥æ²¡æœ‰æ–°æ’å…¥æ•°æ®çš„å¿«ç…§,ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡å–ƒ)</p><ul><li><p>é˜»å¡<br>é˜»å¡æŒ‡çš„æ˜¯ä¸åŒé”ä¹‹é—´çš„å…¼å®¹å…³ç³»,åœ¨æŸäº›æ—¶åˆ»éœ€è¦ç­‰å¾…å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­çš„é”é‡Šæ”¾.åœ¨é»˜è®¤æƒ…å†µä¸‹InnoDBçš„å­˜å‚¨å¼•æ“åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä¸ä¼šå¯¹å¼‚å¸¸è¿›è¡Œå›æ»š.</p></li><li><p>æ­»é”<br>æ­»é”æŒ‡çš„æ˜¯ä¸¤ä¸ªä»¥ä¸Šçš„äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›¸äº’ç­‰å¾….è§£å†³æ­»é”æœ€ç®€å•çš„æ–¹æ³•æ˜¯è¶…æ—¶æœºåˆ¶.MySQLæ£€æµ‹è¶…æ—¶æœºåˆ¶æ˜¯é€šè¿‡â€™ç­‰å¾…å›¾â€™çš„æœºåˆ¶æ¥è¿›è¡Œæ­»é”æ£€æµ‹.</p></li><li><p>ç­‰å¾…å›¾æ£€æµ‹æœºåˆ¶<br>é€šè¿‡ä¿å­˜é”ä¿¡æ¯å’Œäº‹åŠ¡ç­‰å¾…é“¾è¡¨å½¢æˆä¸€å¼ å›¾ç»“æ„,æ£€æµ‹å›¾ä¸­æ˜¯å¦å­˜åœ¨å›è·¯,å¦‚æœå­˜åœ¨å›è·¯è¯æ˜å‘ç”Ÿäº†æ­»é”.</p></li><li><p>æ­»é”å›æ»š<br>å¯¹äºæ­»é”å¼‚å¸¸,InnoDBä¼šé€‰æ‹©å›æ»šUNDOé‡æœ€å°çš„äº‹åŠ¡è¿›è¡Œå›æ»š</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLæŠ€æœ¯ç–‘é—®</title>
      <link href="2021/03/20/6.mysql/MySQL%E6%8A%80%E6%9C%AF%E7%96%91%E9%97%AE/"/>
      <url>2021/03/20/6.mysql/MySQL%E6%8A%80%E6%9C%AF%E7%96%91%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è®°å½•&lt;&lt;MySQLæŠ€æœ¯å†…å¹•-InnoDBå­˜å‚¨å¼•æ“&gt;&gt;é˜…è¯»ä¸­å­˜åœ¨çš„ç–‘é—®ç‚¹</p></blockquote><ul><li>P77 æ—¥å¿—æ–‡ä»¶</li></ul><blockquote><p>å¦‚æœä½¿ç”¨RCéš”ç¦»çº§åˆ«ä¼šå‡ºç°ç±»ä¼¼æ•°æ®ä¸¢å¤±æ›´æ–°çš„ç°è±¡,ä»è€Œå‡ºç°ä¸»ä»æ•°æ®åº“ä¸Šçš„æ•°æ®ä¸ä¸€è‡´</p></blockquote><p>bin_logçš„è®°å½•æ ¼å¼ä¸ºâ€™STATENEBTâ€™æ˜¯,ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µä¸ºä»€ä¹ˆå–ƒ?</p><p>åŸå› :</p><blockquote><ol><li>bin_logçš„è®°å½•é¡ºåºæ˜¯commitçš„é¡ºåº,è€Œä¸æ˜¯æ‰§è¡Œé¡ºåº</li></ol></blockquote><ol start="2"><li>RCä¸­SQLçš„æ‰§è¡Œæ˜¯ç«‹å³æ‰§è¡Œçš„<br>è¿™æ ·å¦‚æœbin_logè®°å½•æ ¼å¼å¦‚æœæ˜¯sql,å°±ä¼šå‡ºç°ä¸¢å¤±æ•°æ®çš„åœºæ™¯</li></ol><hr><ul><li>P268 é”</li></ul><blockquote><p>InnoDBå¯¹äºInsertçš„æ“ä½œä¼šæ£€æŸ¥æ’å…¥è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•æ˜¯å¦è¢«é”å®š,å¦‚æœé”å®šåˆ™ä¸å…è®¸æ“ä½œ</p></blockquote><ul><li>P269 è§£å†³å¹»è¯»</li></ul><blockquote><p>åœ¨RRæ¨¡å¼ä¸‹é€šè¿‡Next-Key Lockingæœºåˆ¶æ¥è§£å†³å¹»è¯»,æ—¢ç„¶MVVCæ˜¯è¯»å–å¿«ç…§,ä¸ºä»€ä¹ˆè¿˜éœ€è¦Next-Key Lockingæœºåˆ¶æ¥è§£å†³å¹»è¯»é—®é¢˜</p></blockquote><p>InnoDBå®é™…ä¸Šæ˜¯æŠŠè¯»å–æ‹†åˆ†æˆä¸¤ç§ç±»å‹</p><ul><li>å¿«ç…§è¯»<br>é€šè¿‡è¯»å–undo log,å¹¶ä¸”å¯¹æ¯”ç‰ˆæœ¬å·å¾—åˆ°äº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®,è¿™ç§ä¸»è¦æ˜¯select æ“ä½œ,å¯¹æ•°æ®åŠ sé”</li><li>å½“å‰è¯»<br>å½“å‰è¯»æŒ‡çš„æ˜¯é€šè¿‡Next-Key Locking æœºåˆ¶å°†å¯¹æ•°æ®çš„è¯»å–æ“ä½œåºåˆ—åŒ–,è§£å†³å¹»è¯»é—®é¢˜</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.zhihu.com/question/334408495">çŸ¥ä¹MVCCçš„è§£ç­”</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLæ–‡ä»¶å’Œè¡¨ç»“æ„</title>
      <link href="2021/03/20/6.mysql/MySQL%E6%96%87%E4%BB%B6%E5%92%8C%E8%A1%A8%E7%BB%93%E6%9E%84/"/>
      <url>2021/03/20/6.mysql/MySQL%E6%96%87%E4%BB%B6%E5%92%8C%E8%A1%A8%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="MySQLæ–‡ä»¶ä½“ç³»"><a class="header-anchor" href="#MySQLæ–‡ä»¶ä½“ç³»"></a>MySQLæ–‡ä»¶ä½“ç³»</h2><p>MySqlæ–‡ä»¶ä½“ç³»ä¸»è¦åˆ†ä¸º:</p><ol><li>å‚æ•°æ–‡ä»¶<br>å‚æ•°æ–‡ä»¶çš„å®šä¹‰æ˜¯ä½œä¸ºå­˜å‚¨MySqlåˆå§‹åŒ–å‚æ•°çš„ä½œç”¨,è´Ÿè´£è®°å½•å„ç§å‚æ•°</li><li>æ—¥å¿—æ–‡ä»¶:<br>è¿™é‡Œçš„æ—¥å¿—æ–‡ä»¶ä¸»è¦æ˜¯ç³»ç»Ÿæ“ä½œæ—¥å¿—,ä¸»è¦æœ‰é”™è¯¯æ—¥å¿—æ–‡ä»¶,äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶,æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ç­‰</li><li>socketæ–‡ä»¶:<br>UNIXåŸŸå¥—æ¥å­—æ‰€éœ€æ–‡ä»¶</li><li>pidæ–‡ä»¶<br>MySqlå®ä¾‹è¿›ç¨‹çš„IDæ–‡ä»¶</li><li>MySQLè¡¨ç»“æ„æ–‡ä»¶<br>ç”¨æ¥å­˜æ”¾MySQLè¡¨ç»“æ„å®šä¹‰æ–‡ä»¶</li><li>å­˜å‚¨å¼•æ“æ–‡ä»¶<br>å­˜å‚¨å¼•æ“æ–‡ä»¶å­˜æ”¾äº†çœŸæ­£çš„è®°å½•å’Œç´¢å¼•æ•°æ®</li></ol><p>ä¸»è¦å…³å¿ƒçš„æ˜¯æ—¥å¿—æ–‡ä»¶å’Œå­˜å‚¨å¼•æ“æ–‡ä»¶</p><h3 id="æ—¥å¿—æ–‡ä»¶"><a class="header-anchor" href="#æ—¥å¿—æ–‡ä»¶"></a>æ—¥å¿—æ–‡ä»¶</h3><p>æ—¥å¿—æ–‡ä»¶ä¸»è¦æœ‰é”™è¯¯æ—¥å¿—,äºŒè¿›åˆ¶æ—¥å¿—,æ…¢æŸ¥è¯¢æ—¥å¿—,æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶<br>äºŒè¿›åˆ¶æ—¥å¿—å°±æ˜¯bin_logæ–‡ä»¶,ä¼šè®°å½•æ‰€æœ‰å¯¹MySqlæ•°æ®åº“æ‰§è¡Œæ›´æ–°çš„æ“ä½œ,å°±ç®—æœ€åæ•°æ®æœªå‘ç”Ÿæ”¹å˜;<br>å½“ä½¿ç”¨æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“æ—¶,æ‰€æœ‰æœªæäº¤çš„äºŒè¿›åˆ¶æ—¥å¿—ä¼šè¢«è®°å½•åˆ°ä¸€ä¸ªç¼“å­˜ä¸­(å½“è¶…è¿‡ç¼“å­˜å¤§å°æ—¶ä¼šè®°å½•åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­),ç­‰å¾…è¯¥äº‹åŠ¡æäº¤æ—¶ç›´æ¥å°†ç¼“å­˜åˆ·æ–°åˆ°bin_logä¸­<br>bin_logçš„è®°å½•æ ¼å¼æœ‰ä¸‰ç§(è®°å½•æ‰§è¡ŒSQL,è®°å½•æ›´æ–°æ•°æ®,æ··åˆæ¨¡å¼),åœ¨â€™è®°å½•æ‰§è¡ŒSQLâ€™çš„æ¨¡å¼ä¸‹ä¸»ä»å¤åˆ¶ä¸èƒ½ä½¿ç”¨RCæ¨¡å¼</p><h3 id="å­˜å‚¨å¼•æ“æ–‡ä»¶"><a class="header-anchor" href="#å­˜å‚¨å¼•æ“æ–‡ä»¶"></a>å­˜å‚¨å¼•æ“æ–‡ä»¶</h3><p>å­˜å‚¨å¼•æ“æ–‡ä»¶ä¸»è¦æœ‰â€™è¡¨ç©ºé—´æ–‡ä»¶â€™,é‡åšæ—¥å¿—æ–‡ä»¶(redo log)</p><h4 id="è¡¨ç©ºé—´æ–‡ä»¶"><a class="header-anchor" href="#è¡¨ç©ºé—´æ–‡ä»¶"></a>è¡¨ç©ºé—´æ–‡ä»¶</h4><p>è¡¨ç©ºé—´æ–‡ä»¶æŒ‡çš„æ˜¯å®é™…å­˜å‚¨æ•°æ®çš„æ–‡ä»¶,åˆ†ä¸ºä¸¤ç§ç±»å‹é»˜è®¤çš„è¡¨ç©ºé—´,è¿™ç§è¡¨ç©ºé—´æ˜¯å…±äº«æ•°æ®å­˜å‚¨çš„æ¨¡å¼,å¦å¤–ä¸€ç§æ˜¯ç‹¬è‡ªçš„è¡¨ç©ºé—´,ä¸ºæ¯ä¸€å¼ è¡¨å•ç‹¬ç”Ÿäº§ç‹¬ç«‹çš„è¡¨ç©ºé—´æ–‡ä»¶å­˜æ”¾æ•°æ®/ç´¢å¼•/æ’å…¥ç¼“å†²BITMAP,ä½†æ˜¯è¯¥è¡¨å…¶ä½™çš„æ•°æ®è¿˜æ˜¯æ”¾åˆ°é»˜è®¤çš„è¡¨ç©ºé—´ä¸­</p><h4 id="é‡åšæ—¥å¿—æ–‡ä»¶"><a class="header-anchor" href="#é‡åšæ—¥å¿—æ–‡ä»¶"></a>é‡åšæ—¥å¿—æ–‡ä»¶</h4><p>é‡åšæ—¥å¿—æ–‡ä»¶æ˜¯innoDBç”¨æ¥ä¿è¯æ•°æ®å®Œæ•´æ€§çš„å…³é”®,é»˜è®¤é‡‡ç”¨ä¸€ä¸ªé‡åšæ—¥å¿—ç»„ä¸‹é¢æœ‰ä¸¤ä¸ªé•œåƒé‡åšæ—¥å¿—æ–‡ä»¶çš„æ¶æ„.<br>redo_logæ˜¯åœ¨sqlæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸æ–­çš„è¿›è¡Œå†™å…¥å’Œå¤åˆ¶,è¿™é‡Œå’Œbin_logæœ‰æ‰€å·®å¼‚,bin_logæ˜¯åœ¨äº‹åŠ¡æäº¤åè¿›è¡Œçš„å†™å…¥.<br>redo_logçš„è®°å½•å¯¹è±¡æ˜¯å¯¹æ¯ä¸ªé¡µçš„æ›´æ”¹çš„ç‰©ç†è®°å½•,redo_logè®°å½•çš„æ˜¯å‘å‰çš„æ›´æ–°è®°å½•.</p><h2 id="MySQLè¡¨ç»“æ„"><a class="header-anchor" href="#MySQLè¡¨ç»“æ„"></a>MySQLè¡¨ç»“æ„</h2><p>MySQLçš„æ–‡ä»¶ç»“æ„æ˜¯å¦‚ä½•æ•°æ®å¦‚ä½•åœ¨ç‰©ç†ä¸Šçš„ç»“æ„,MySQLå¯¹äºæ•°æ®åœ¨é€»è¾‘ä¸Šçš„ç»“æ„å¯ä»¥åˆ’åˆ†ä¸ºç´¢å¼•ç»„ç»‡è¡¨,InnoDOçš„å­˜å‚¨ç»“æ„,è¡Œè®°å½•ç»“æ„,é¡µè®°å½•ç»“æ„ä»¥åŠè§†å›¾ç­‰</p><h3 id="æ•°æ®å­˜å‚¨çš„æ–¹å¼"><a class="header-anchor" href="#æ•°æ®å­˜å‚¨çš„æ–¹å¼"></a>æ•°æ®å­˜å‚¨çš„æ–¹å¼</h3><p>æ•°æ®å­˜å‚¨æ ¼å¼å¯ä»¥åˆ†ä¸ºâ€™å †è¡¨â€™/â€˜ç´¢å¼•ç»„ç»‡è¡¨â€™</p><ul><li>å †è¡¨æŒ‡çš„æ˜¯æ•°æ®çš„å­˜æ”¾æ˜¯æ— åºçš„,æ˜¯æ ¹æ®ç©ºé—²ç£ç›˜ç©ºé—´æ¥å†³å®šå­˜æ”¾ä½ç½®;</li><li>ç´¢å¼•ç»„ç»‡è¡¨æŒ‡çš„æ˜¯åœ¨å­˜æ”¾æ•°æ®æ—¶æ˜¯æŒ‰ç…§ä¸»é”®ç´¢å¼•æ¥è¿›è¡Œå­˜æ”¾çš„.InnoDBçš„B+æ ‘ç´¢å¼•ç»“æ„å°±æ˜¯ä¸€ç§ç´¢å¼•ç»„ç»‡è¡¨çš„å½¢å¼.</li></ul><h3 id="InnoDBé€»è¾‘å­˜å‚¨ç»“æ„"><a class="header-anchor" href="#InnoDBé€»è¾‘å­˜å‚¨ç»“æ„"></a>InnoDBé€»è¾‘å­˜å‚¨ç»“æ„</h3><p>InnoDBçš„é€»è¾‘å­˜å‚¨ç»“æ„åˆ’åˆ†ä¸º4çº§,åˆ†åˆ«æ˜¯è¡¨ç©ºé—´-æ®µç©ºé—´-åŒºç©ºé—´-é¡µç©ºé—´,é¡µç©ºé—´ä¸Šå­˜å‚¨çš„å°±æ˜¯ä¸€è¡Œä¸€è¡Œçš„æ•°æ®äº†</p><h3 id="è¡¨ç©ºé—´"><a class="header-anchor" href="#è¡¨ç©ºé—´"></a>è¡¨ç©ºé—´</h3><p>è¡¨ç©ºé—´æ˜¯InnoDBé€»è¾‘å­˜å‚¨ä¸Šæœ€ä¸Šå±‚çš„æ“ä½œå•ä½,ä¸€ä¸ªè¡¨ç©ºé—´å­˜å‚¨äº†æ‰€å±è¯¥è¡¨çš„å…¨éƒ¨æ•°æ®(data,index)</p><h3 id="æ®µç©ºé—´"><a class="header-anchor" href="#æ®µç©ºé—´"></a>æ®µç©ºé—´</h3><p>å¯¹è¡¨ç©ºé—´å†…çš„æ•°æ®æŒ‰ç…§ç±»å‹è¿›è¡Œåˆ’åˆ†,åˆå¯ä»¥åˆ’åˆ†ä¸ºæ•°æ®æ®µ/ç´¢å¼•æ®µ/å›æ»šæ®µç­‰,è¿™äº›ä¸åŒçš„ç±»å‹æ•°æ®,è¢«ç§°ä¸ºæ®µç©ºé—´</p><p>------é€»è¾‘-ç‰©ç†åˆ†å‰²å±‚------</p><h3 id="åŒºç©ºé—´"><a class="header-anchor" href="#åŒºç©ºé—´"></a>åŒºç©ºé—´</h3><p>åŒºç©ºé—´æ˜¯ç”±è¿ç»­çš„ç£ç›˜ç©ºé—´ç»„æˆ,é»˜è®¤åŒºç©ºé—´å¤§å°ä¸º1MB,ä¸ºäº†ä¿è¯åŒºç©ºé—´çš„è¿ç»­æ€§è¿˜ä¼šä¸€æ¬¡å‘ç£ç›˜ç”³è¯·å¤šä¸ªåŒºç©ºé—´.åŒºç©ºé—´å®é™…å­˜å‚¨äº†æ®µç©ºé—´å†…çš„æ•°æ®.</p><h3 id="é¡µç©ºé—´"><a class="header-anchor" href="#é¡µç©ºé—´"></a>é¡µç©ºé—´</h3><p>é¡µç©ºé—´æ˜¯InnoDBæœ€å°çš„ç£ç›˜ç®¡ç†å•ä½,åœ¨InnoDBä¸­æ¯ä¸ªé¡µçš„å¤§å°ä¸º16KB,å› æ­¤ä¸€ä¸ªåŒºå¯ä»¥å­˜å‚¨64ä¸ªé¡µ.é¡µæŒ‰ç…§ç±»å‹å¯ä»¥åˆ’åˆ†ä¸º</p><ol><li>æ•°æ®é¡µ</li><li>undoé¡µ</li><li>ç³»ç»Ÿé¡µ</li><li>äº‹åŠ¡æ•°æ®é¡µ</li><li>æ’å…¥ç¼“å†²é¡µ(BitMap/Free List)</li><li>äºŒè¿›åˆ¶å¤§å¯¹è±¡é¡µ</li></ol><h3 id="è¡Œ"><a class="header-anchor" href="#è¡Œ"></a>è¡Œ</h3><p>InnoDBä¸­çš„æ•°æ®æ˜¯æŒ‰ç…§è¡Œæ¥è¿›è¡Œå­˜å‚¨çš„,è¡Œæ•°æ®çš„è®°å½•æ ¼å¼æŒ‰ç…§ç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤ç±».Compactå’ŒRedundantä¸¤ç§ç±»å‹.</p><ul><li><p>Redundant<br>Redundantç±»å‹æ˜¯ä¸ºäº†å…¼å®¹ä¹‹å‰ç‰ˆæœ¬è€Œè®¾è®¡çš„</p></li><li><p>Compact<br>Compactæ ¼å¼æ˜¯MySQL5.0ä¸­å¼•å…¥çš„,ç›®çš„æ˜¯é«˜æ•ˆçš„å­˜å‚¨æ•°æ®.</p></li><li><p>æ•°æ®ç»“æ„</p></li></ul><table><thead><tr><th>å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨</th><th>NULLæ ‡å¿—ä½</th><th>è®°å½•å¤´ä¿¡æ¯</th><th>åˆ—æ•°æ®â€¦</th><th>äº‹åŠ¡ID</th><th>å›æ»šæŒ‡é’ˆ</th></tr></thead><tbody></tbody></table><p>ç‰¹åˆ«è¦æ³¨æ„â€™äº‹åŠ¡IDâ€™å’Œâ€™å›æ»šæŒ‡é’ˆâ€™è¿™ä¸¤é¡¹ä¸éš”ç¦»çº§åˆ«å’Œäº‹åŠ¡å›æ»šæœ‰å…³;<br>NULL,åœ¨è¡Œçš„æ•°æ®ç»“æ„ä¸­éƒ½ä¸å ç”¨ä»»ä½•å­˜å‚¨ç©ºé—´,å› ä¸ºåœ¨è¡Œçš„æ•°æ®ç»“æ„ä¸­æœ‰NULLæ ‡å¿—ä½æ¥å¤„ç†NULL</p><ul><li>Varcharç±»å‹é•¿åº¦<br>Varcharç±»å‹åœ¨MySQLä¸­çš„å®šä¹‰æ˜¯æœ€å¤§èƒ½å­˜å‚¨65535ä¸ªå­—èŠ‚,å¹¶ä¸”æ˜¯è¯¥è¡Œæ‰€æœ‰çš„Varcharç±»å‹é•¿åº¦ä¹‹å’Œ.ç”±äºä¸€ä¸ªé¡µçš„å¤§å°ä¸º16KB,å› æ­¤åœ¨Varcharçš„ç±»å‹é•¿åº¦å®é™…ä¸Šæ˜¯è¶…è¿‡ä¸€é¡µçš„å¤§å°,è¿™æ ·å°±ä¼šå¯¼è‡´ä¸€é¡µä¸Šä¸èƒ½å­˜å‚¨ä¸€è¡Œæ•°æ®.è¿™é‡ŒInnoDBé‡‡ç”¨äº†æº¢å‡ºé¡µçš„æ–¹å¼æ¥è¿›è¡Œå¤„ç†,pageä¸Šåªä¿ç•™æ•°æ®å¤´ä¿¡æ¯,è€Œæº¢å‡ºé¡µä¸Šå­˜å‚¨æº¢å‡ºçš„ä¿¡æ¯(æº¢å‡ºæŒ‡çš„æ˜¯æ•°æ®å¤§å°æº¢å‡ºInnoDBè®¾å®šçš„é¢å®šå¤§å°,è€Œä¸æ˜¯pageé¡µçš„å¤§å°)</li></ul><h2 id="InnoDBæ•°æ®é¡µç»“æ„"><a class="header-anchor" href="#InnoDBæ•°æ®é¡µç»“æ„"></a>InnoDBæ•°æ®é¡µç»“æ„</h2><p>InnoDBçš„æ•°æ®é¡µç»“æ„æŒ‡çš„æ˜¯é¡µç©ºé—´ä¸­æ•°æ®é¡µçš„ç»“æ„,ä¸»è¦ç”±æ•°æ®ç³»ç»Ÿä¿¡æ¯å’Œç”¨æˆ·è®°å½•ä¿¡æ¯ç»„æˆ</p><ul><li>æ•°æ®ç³»ç»Ÿç»“æ„<br>æ•°æ®ç³»ç»Ÿç»“æ„ä¸»è¦æ˜¯ç”±æ–‡ä»¶å¤´/é¡µå¤´/Infimun-Supremum Records/é¡µç›®å½•ç­‰ç»„æˆ,æ ‡è®°äº†è¯¥å—åŒºåŸŸçš„ç³»ç»Ÿä¿¡æ¯</li><li>Infimun-Supremum RecordsæŒ‡çš„æ˜¯ä¸€ä¸ªå°äºæ•°æ®ä¸»é”®çš„åŒºé—´èµ·å§‹å€¼å’Œç»ˆæ­¢å€¼.è¿™ä¸¤ä¸ªå€¼ä¼šåœ¨B+æ ‘ä¸­è¿›è¡Œå­˜å‚¨</li><li>é¡µç›®å½•æŒ‡çš„æ˜¯æŒ‡çš„æ˜¯æ ‡è®°ç”¨æˆ·æ•°æ®çš„ç›¸å¯¹ä½ç½®çš„ç»“æ„</li></ul><blockquote><p>åœ¨è¿›è¡Œæ•°æ®æŸ¥æ‰¾æ—¶,ä¼šå…ˆä»B+æ ‘ä¸­æŸ¥è¯¢åˆ°æ•°æ®å¯¹åº”çš„é¡µ,å°†é¡µåŠ è½½åˆ°å†…å­˜ä¸­å,æ ¹æ®é¡µç›®å½•æ¥å¯¹ç”¨æˆ·æ•°æ®è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾(é‡ç‚¹)</p></blockquote><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://my.oschina.net/xinxingegeya/blog/474895">MySQLèšç°‡ç´¢å¼•&amp;èšé›†ç´¢å¼•&amp;ç´¢å¼•ç»„ç»‡è¡¨</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLä½“ç³»ç»“æ„ä¸å­˜å‚¨å¼•æ“</title>
      <link href="2021/03/15/6.mysql/MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/"/>
      <url>2021/03/15/6.mysql/MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸»è¦ä»‹ç»MySqlçš„æ•´ä½“ä½“ç³»ç»“æ„å’Œå­˜å‚¨å¼•æ“</p></blockquote><h2 id="ä½“ç³»ç»“æ„"><a class="header-anchor" href="#ä½“ç³»ç»“æ„"></a>ä½“ç³»ç»“æ„</h2><p>æ¦‚å¿µä¸Š<B>æ•°æ®åº“</B>æ˜¯æ–‡ä»¶çš„é›†åˆ,æ˜¯æŒ‰ç…§ä¸€å®šçš„æ–‡ä»¶æ¨¡å‹ç»„ç»‡èµ·æ¥å­˜æ”¾æ•°æ®çš„ç»“æ„;<B>æ•°æ®åº“å®åˆ—</B>æ˜¯ç¨‹åºæ˜¯ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹,æ˜¯ç”¨æˆ·å¯¹<B>æ•°æ®åº“</B>è¿›è¡Œæ“ä½œçš„è½¯ä»¶.</p><p>MySqlä¸»è¦ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆ</p><ol><li>è¿æ¥æ± ç»„ä»¶</li><li>ç®¡ç†æœåŠ¡å’Œå·¥å…·ç»„ä»¶</li><li>SQLæ¥å£ç»„ä»¶</li><li>æŸ¥è¯¢åˆ†æå™¨ç»„ä»¶</li><li>ä¼˜åŒ–å™¨ç»„ä»¶</li><li>ç¼“å†²ç»„ä»¶</li><li>æ’ä»¶å¼å­˜å‚¨å¼•æ“(å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ ,è€Œä¸æ˜¯åŸºäºæ•°æ®åº“çš„)</li><li>ç‰©ç†æ–‡ä»¶</li></ol><h2 id="å­˜å‚¨å¼•æ“"><a class="header-anchor" href="#å­˜å‚¨å¼•æ“"></a>å­˜å‚¨å¼•æ“</h2><ul><li><p>æ¦‚è¿°<br>å­˜å‚¨å¼•æ“æ˜¯ä¸MySqlç‰©ç†æ–‡ä»¶è¿›è¡Œäº¤äº’çš„ä¸€ç§æ’ä»¶,å­˜å‚¨å¼•æ“çš„åº•éƒ¨æ˜¯ç‰©ç†å­˜å‚¨å±‚,åŒ…æ‹¬äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶,æ•°æ®æ–‡ä»¶,é”™è¯¯æ–‡ä»¶,æ…¢æŸ¥è¯¢æ—¥å¿—,undo/redoæ—¥å¿—ç­‰</p></li><li><p>selectçš„è¿‡ç¨‹</p></li></ul><p>ä¸‹å›¾æ˜¯ä¸€æ¬¡selectçš„è¿‡ç¨‹<br><img src="https://s3.ax1x.com/2021/03/15/6r8Q7q.png" alt="selectæ‰§è¡Œè¿‡ç¨‹"></p><p>ä»å›¾ä¸­å¾—çŸ¥å­˜å‚¨å¼•æ“ä½äºæ˜¯ç‰©ç†æ–‡ä»¶å’Œç¨‹åºæ•°æ®ä¹‹é—´</p><ul><li>InnoDBçš„ä½“ç³»æ¶æ„</li></ul><p><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-architecture.html"><img src="https://dev.mysql.com/doc/refman/8.0/en/images/innodb-architecture.png" alt="InnoDBæ¶æ„"></a></p><ol><li>å®åˆ—å±‚<br>å®åˆ—å±‚ä¸»è¦åŒ…æ‹¬â€™çº¿ç¨‹â€™å’Œâ€™å†…å­˜â€™ä¸¤ä¸ªéƒ¨åˆ†<br>a. åå°çº¿ç¨‹ä¸»è¦æœ‰</li></ol><ul><li>Master Thread<br>ä¸»çº¿ç¨‹ä¸»è¦è´Ÿè´£å°†ç¼“å†²æ± ä¸­çš„æ•°æ®å¼‚æ­¥åˆ·æ–°åˆ°ç£ç›˜ä¸­,ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</li><li>I/O Thread<br>I/O Thread ä¸»è¦æ˜¯è´Ÿè´£AIO(Async IO)è¯·æ±‚çš„å›è°ƒ</li><li>Purge Thread<br>Purge Threadçš„ä½œç”¨æ˜¯äº‹ç‰©åœ¨è¢«æäº¤åundologå°±å¯èƒ½ä¸åœ¨è¢«ä½¿ç”¨äº†,å› æ­¤éœ€è¦Purge Threadçº¿ç¨‹æ¥å›æ”¶å¹¶åˆ†é…çš„undoé¡µ</li><li>Page Cleaner Thread<br>Page Cleaner Threadçš„ä½œç”¨æ˜¯å›æ”¶åˆ†é…è„é¡µ</li></ul><p>å°ç»“:Master Threadå’ŒI/O Threadä¸€ä¸ªè´Ÿè´£å¼‚æ­¥åˆ·æ–°æ•°æ®ä¸€ä¸ªè´Ÿè´£AIOçš„å›è°ƒ,Purge Threadå’ŒPage Cleaner Threadä¸€ä¸ªè´Ÿè´£å›æ”¶åˆ†é…undologä¸€ä¸ªè´Ÿè´£å›æ”¶åˆ†é…è„é¡µ</p><p>b. å†…å­˜</p><ul><li>ç¼“å†²æ± <br>InnoDBå­˜å‚¨å¼•æ“æ˜¯åŸºäºç£ç›˜å­˜å‚¨,å…¶ä¸­çš„æ•°æ®æ˜¯æŒ‰ç…§é¡µçš„æ–¹å¼è¿›è¡Œç®¡ç†.ç”±äºCPUå’Œç£ç›˜é€Ÿåº¦ä¸­çš„å·®å¼‚å› æ­¤ç”¨ç¼“å†²æ± æŠ€æœ¯æ¥æé«˜æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½<br>ç¼“å†²æ± æ˜¯ä¸€å—å†…å­˜åŒºåŸŸ,åœ¨æ•°æ®åº“è¿›è¡Œè¯»å–é¡µæ“ä½œæ—¶,ä¼šé¦–å…ˆå°†ä»å†…å­˜ä¸­çš„æ•°æ®æ”¾åˆ°ç¼“å†²æ± ä¸­,åœ¨ä¸‹ä¸€æ¬¡è¯»å–ç›¸åŒé¡µæ—¶,ä¼šç›´æ¥è¯»å–ç¼“å†²æ± ä¸­çš„é¡µæ•°æ®.<br>å¯¹äºæ•°æ®åº“ä¸­çš„é¡µçš„ä¿®æ”¹,é¦–å…ˆä¼šä¿®æ”¹ç¼“å†²æ± ä¸­çš„é¡µ,ç„¶åä»¥ä¸€å®šçš„é¢‘ç‡åˆ·æ–°åˆ°ç£ç›˜,è¿™ç§æœºåˆ¶è¢«ç§°ä¸ºCheckPoint<br>ç¼“å†²æ± ä¸­çš„æ•°æ®é¡µç±»å‹åˆ†ä¸º:</li></ul><ol><li>ç´¢å¼•é¡µ</li><li>æ•°æ®é¡µ</li><li>undoé¡µ</li><li>æ’å…¥ç¼“å†²</li><li>è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•</li><li>InnoDBå­˜å‚¨çš„é”ä¿¡æ¯</li><li>æ•°æ®å­—å…¸</li></ol><ul><li><p>LRU list,Freen lst,Flush list<br>æ•°æ®åº“ä¸­çš„ç¼“å†²æ± æ˜¯é€šè¿‡LRUç®—æ³•æ¥è¿›è¡Œç®¡ç†,ä½†æ˜¯InnoDBä¸­çš„LRUç®—æ³•æ˜¯ç»è¿‡ä¼˜åŒ–çš„,å°†æ–°æ•°æ®æ”¾åˆ°åˆ—è¡¨3/8å¤„</p></li><li><p>é‡åšæ—¥å¿—ç¼“å†²<br>é‡åšæ—¥å¿—é¦–å…ˆä¼šæ”¾åˆ°ç¼“å†²åŒº,ç„¶åæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡åˆ·æ–°åˆ°æ—¥å¿—æ–‡ä»¶ä¸Š,æœ‰ä¸‰ç§æƒ…å†µä¼šåˆ·æ–°é‡åšæ—¥å¿—:1.Master Threadæ¯ä¸€ç§’éƒ½ä¼šå°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°æ—¥å¿—æ–‡ä»¶,2.æ¯ä¸ªäº‹åŠ¡æäº¤æ—¶éƒ½ä¼šå°†é‡åšæ—¥å¿—åˆ·æ–°åˆ°æ–‡ä»¶,3.å½“é‡åšæ—¥å¿—ç¼“å†²æ± å‰©ä½™ç©ºé—´å°äº1/2æ—¶,ä¼šå°†æ—¥å¿—åˆ·æ–°åˆ°æ–‡ä»¶ä¸Š</p></li><li><p>é¢å¤–çš„å†…å­˜æ± <br>é¢å¤–çš„å†…å­˜æ± ä½œä¸ºç¼“å†²æ± çš„å¤‡ç”¨,ä½†ç¼“å†²æ± ä¸å¤Ÿçš„æ—¶å€™,å°±ä¼šä»é¢å¤–çš„å†…å­˜æ± ä¸­ç”³è¯·</p></li><li><p>CheckpointæŠ€æœ¯<br>Mysqlä¸­æ•°æ®çš„æŒä¹…æ€§æ˜¯é€šè¿‡Write Ahead Logç­–ç•¥æ¥ä¿è¯,ä¹Ÿå°±æ˜¯å…ˆå†™æ—¥å¿—æ–‡ä»¶,åœ¨ä¿®æ”¹æ•°æ®æ–‡ä»¶.å½“å®•æœºå¯¼è‡´æ•°æ®ä¸¢å¤±æ—¶,ä¼šé€šè¿‡é‡åšæ—¥å¿—æ¥è¿›è¡Œæ•°æ®æ¢å¤.<br>å¦‚æœé‡åšæ—¥å¿—å¤ªå¤§ä¼šå¯¼è‡´æ•°æ®æ¢å¤çš„å¾ˆæ…¢,å› æ­¤mysqlä½¿ç”¨CheckPointçš„æŠ€æœ¯æ¥ä¿è¯,CheckPointæ˜¯å°†ç¼“å†²æ± ä¸­çš„å†…å­˜é¡µåˆ·æ–°åˆ°ç£ç›˜çš„åŠ¨ä½œ</p></li></ul><h2 id="Master-Thread"><a class="header-anchor" href="#Master-Thread"></a>Master Thread</h2><p>Master Threadå…·æœ‰æœ€é«˜çº§åˆ«çš„çº¿ç¨‹ä¼˜å…ˆçº§,å†…éƒ¨æœ‰å¤šä¸ªå¾ªç¯ç»„æˆ:ä¸»å¾ªç¯,åå°å¾ªç¯,åˆ·æ–°å¾ªç¯,æš‚åœå¾ªç¯.<br>Master Threadä¸»è¦åˆ†ä¸º1sæ‰§è¡Œä¸€æ¬¡çš„æ“ä½œ:</p><ol><li>æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜,å³ä½¿è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤</li><li>åˆå¹¶æ’å…¥ç¼“å†²</li><li>æœ€å¤šåˆ·æ–°100ä¸ªInnoDBçš„ç¼“å†²æ± ä¸­çš„è„é¡µåˆ°ç£ç›˜</li><li>å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨,å°±åˆ‡æ¢åˆ°backgroud loop<br>10sæ‰§è¡Œä¸€æ¬¡çš„æ“ä½œ:</li><li>åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜</li><li>åˆå¹¶è‡³å¤š5ä¸ªæ’å…¥ç¼“å†²</li><li>å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜</li><li>åˆ é™¤æ— ç”¨çš„Undoé¡µ</li><li>åˆ·æ–°100ä¸ªæˆ–è€…10ä¸ªè„é¡µ</li></ol><h2 id="InnoDBç‰¹ç‚¹"><a class="header-anchor" href="#InnoDBç‰¹ç‚¹"></a>InnoDBç‰¹ç‚¹</h2><ol><li>æ’å…¥ç¼“å†²(Insert Buffer)</li><li>ä¸¤æ¬¡å†™(Double Write)</li><li>è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(Adaptive Hash Index)</li><li>å¼‚æ­¥IO(Async IO)</li><li>åˆ·æ–°é‚»æ¥é¡µ(Flush Neighbor Page)</li></ol><h2 id="æ’å…¥ç¼“å†²"><a class="header-anchor" href="#æ’å…¥ç¼“å†²"></a>æ’å…¥ç¼“å†²</h2><ol><li>Insert Buffer<br>Insert Bufferæ˜¯åœ¨æ’å…¥æ•°æ®æ—¶å°†è¾…åŠ©ç´¢å¼•å…ˆæ”¾åˆ°Insert Bufferä¸­,ç„¶ååœ¨æŒ‰ç…§ä¸€å®šçš„é¢‘ç‡å°†Insert Bufferä¸­çš„æ•°æ®å’Œè¾…åŠ©ç´¢å¼•é¡µçš„å­èŠ‚ç‚¹è¿›è¡Œåˆå¹¶,è¿™æ ·èƒ½å¤Ÿæé«˜éèšé›†ç´¢å¼•çš„æ’å…¥æ€§èƒ½</li><li>Change Buffer<br>Change Bufferä½œä¸ºInsert Bufferçš„å‡çº§,ä¼šå°†æ‰€æœ‰å¯¹éèšé›†ç´¢å¼•çš„æ“ä½œè¿›è¡Œç¼“å†²</li><li>Insert Bufferçš„å†…éƒ¨ç»“æ„<br>Insert Bufferçš„æ•°æ®ç»“æ„æ˜¯B+æ ‘,åœ¨Mysql4.1ä¹‹å‰æ¯å¼ è¡¨éƒ½æœ‰ä¸€é¢—B+æ ‘;åœ¨ç°åœ¨çš„ç‰ˆæœ¬ä¸­å…¨å±€åªæœ‰ä¸€é¢—B+æ ‘,è´Ÿè´£å¯¹æ‰€æœ‰è¡¨çš„è¾…åŠ©ç´¢å¼•è¿›è¡ŒInsert Buffer,é»˜è®¤ä¸ºibdata1<br>Insert Bufferçš„éå¶å­èŠ‚ç‚¹æ˜¯ç”±space(å¾…æ’å…¥è®°å½•è¡¨çš„è¡¨ç©ºé—´id),offer(åç§»é‡)æ„æˆ;å¶å­èŠ‚ç‚¹æ˜¯ç”±space,offer,metadata(æ“ä½œè¾…åŠ©ç´¢å¼•çš„å…ƒæ•°æ®-é¡ºåº,æ ‡è¯†,ç±»å‹)</li><li>merge Insert Bufferçš„è¿‡ç¨‹<br>åœ¨ä¸‰ç§æƒ…å†µä¸‹,MySqlä¼šå°†Insert Bufferåˆ·æ–°åˆ°è¾…åŠ©ç´¢å¼•æ–‡ä»¶ä¸­,å¹¶ä¸”è™½ç„¶Insert Bufferæ˜¯æœ‰åºçš„,ä½†æ˜¯åœ¨åˆ·æ–°æ—¶,æ˜¯éšæœºé€‰å–Insert Bufferä¸­çš„ä¸€ä¸ªé¡µè¿›è¡Œåˆ·æ–°,åšè¿™ä¸ªçš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯å…¬å¹³æ€§è€Œèˆå¼ƒé¡ºåºæ€§.ä»¥ä¸‹çš„ä¸‰ç§æƒ…å†µä¼šè¿›è¡ŒInser Bufferçš„åˆ·æ–°</li><li>è¾…åŠ©ç´¢å¼•é¡µè¢«è¯»å–åˆ°ç¼“å†²æ± ä¸­</li><li>Insert Buffer BitMapè®°å½•Insert Bufferå¯ç”¨ç©ºé—´ä¸è¶³æ—¶</li><li>Master Threadçº¿ç¨‹å¯¹Insert Bufferçš„åˆ·æ–°</li></ol><h2 id="ä¸¤æ¬¡å†™"><a class="header-anchor" href="#ä¸¤æ¬¡å†™"></a>ä¸¤æ¬¡å†™</h2><p>ä¸¤æ¬¡å†™æŒ‡çš„æ˜¯å½“åœ¨ç›´æ¥å†™å…¥æŸé¡µæ—¶å‘ç”Ÿå®•æœº,ä¼šæœ‰ä¸¢å¤±æ•°æ®çš„é£é™©.é€šè¿‡å‘å°†è„é¡µçš„æ•°æ®è½¬ç§»åˆ°å†…å­˜ä¸­çš„doublewrite bufferä¸­,åœ¨å°†doublewriteä¸­çš„æ•°æ®åŒæ­¥å†™åˆ°å…±äº«è¡¨ç©ºé—´çš„ç‰©ç†ç£ç›˜æ–‡ä»¶ä¸Š,ç¬¬äºŒæ¬¡æ‰å°†doublewrite bufferä¸­çš„æ–‡ä»¶åˆ·æ–°åˆ°æ•°æ®æ–‡ä»¶(.ibd)ä¸­,è¿™æ ·å¯ä»¥å°½é‡ä¿è¯æ•°æ®æ–‡ä»¶çš„å®Œæ•´æ€§</p><h2 id="è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•"><a class="header-anchor" href="#è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•"></a>è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•</h2><p>è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•æŒ‡çš„æ˜¯è¿ç»­å¯¹çƒ­ç‚¹æ•°æ®çš„å¤šæ¬¡æŸ¥è¯¢åä¼šæ ¹æ®B+æ ‘ç´¢å¼•ç”Ÿæˆå¯¹åº”çš„å“ˆå¸Œç´¢å¼•,åŠ å¿«æŸ¥è¯¢æ€§èƒ½</p><h2 id="å¼‚æ­¥IO"><a class="header-anchor" href="#å¼‚æ­¥IO"></a>å¼‚æ­¥IO</h2><p>å¼‚æ­¥IOå¯ä»¥æé«˜æ“ä½œç£ç›˜çš„æ•ˆç‡,</p><h2 id="åˆ·æ–°é‚»æ¥é¡µ"><a class="header-anchor" href="#åˆ·æ–°é‚»æ¥é¡µ"></a>åˆ·æ–°é‚»æ¥é¡µ</h2><p>åˆ·æ–°é‚»æ¥é¡µæŒ‡çš„æ˜¯å¯¹è„é¡µæ‰€åœ¨åŒºçš„é¡µè¿›è¡Œæ£€æµ‹,å‘ç°æ˜¯è„é¡µä¸€å¹¶è¿›è¡Œåˆ·æ–°.</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œåŸºç¡€çŸ¥è¯†(ä¸€)</title>
      <link href="2021/03/08/16.%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/1.HTTP%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>2021/03/08/16.%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/1.HTTP%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h1>åŸºç¡€çŸ¥è¯†</h1><h2 id="è®¡ç®—æœºç½‘ç»œçš„ç±»åˆ«"><a class="header-anchor" href="#è®¡ç®—æœºç½‘ç»œçš„ç±»åˆ«"></a>è®¡ç®—æœºç½‘ç»œçš„ç±»åˆ«</h2><ol><li>å¹¿åŸŸç½‘ WAN(Wide Area Network),ä½œç”¨èŒƒå›´åœ¨å‡ åè‡³å‡ åƒå…¬é‡Œ</li><li>åŸåŸŸç½‘ MAN(Metropolitan Area Network),ä½œç”¨èŒƒå›´åœ¨äº”è‡³äº”åå…¬é‡Œ</li><li>å±€åŸŸç½‘ LAN(Local Area Network),ä½œç”¨èŒƒå›´åœ¨ä¸€åŠŸèƒ½å·¦å³</li><li>ä¸ªäººå±€åŸŸç½‘ PAN(Personal Area Network),é€šå¸¸ä½œç”¨èŒƒå›´ä¸º10ç±³å·¦å³,é€šè¿‡æ— çº¿è¿æ¥èµ·æ¥çš„ä¸ªäººå±€åŸŸç½‘åˆç§°ä¸ºWPAN</li></ol><h2 id="è®¡ç®—æœºç½‘ç»œçš„æ€§èƒ½æŒ‡æ ‡"><a class="header-anchor" href="#è®¡ç®—æœºç½‘ç»œçš„æ€§èƒ½æŒ‡æ ‡"></a>è®¡ç®—æœºç½‘ç»œçš„æ€§èƒ½æŒ‡æ ‡</h2><ol><li>é€Ÿç‡:æŒ‡çš„æ˜¯è¿æ¥åœ¨è®¡ç®—æœºç½‘ç»œä¸Šçš„ä¸»æœºåœ¨æ•°å­—ä¿¡é“ä¸Šä¼ é€æ•°æ®çš„é€Ÿç‡.é€šä¿—æ¥è®²å°±æ˜¯å•ä½æ—¶é—´å†…èƒ½å‘é€çš„æ•°æ®é‡</li><li>å¸¦å®½:æŒ‡çš„æ˜¯ç½‘ç»œçš„é€šä¿¡çº¿è·¯æ‰€èƒ½ä¼ é€æ•°æ®çš„èƒ½åŠ›.é€šä¿—æ¥è®²å°±æ˜¯ç½‘ç»œçº¿è·¯æ‰¿è½½æ•°æ®çš„å®½åº¦</li><li>ååé‡:æŒ‡çš„æ˜¯å•ä½æ—¶é—´å†…é€šè¿‡æŸä¸ªç½‘ç»œçš„æ•°æ®é‡</li><li>æ—¶å»¶:æŒ‡çš„æ˜¯æ•°æ®é€šè¿‡ç½‘ç»œä»ä¸€ç«¯ä¼ é€åˆ°å¦å¤–ä¸€ç«¯çš„æ—¶é—´(æ€»æ—¶å»¶=å‘é€æ—¶å»¶+ä¼ æ’­æ—¶å»¶+å¤„ç†æ—¶å»¶+æ’é˜Ÿæ—¶å»¶)</li><li>æ—¶å»¶å¸¦å®½ç§¯:æŒ‡çš„æ˜¯ä¼ æ’­æ—¶å»¶*è´·æ¬¾è¡¨ç¤ºä»¥æ¯”ç‰¹ä¸ºå•ä½çš„é“¾è·¯é•¿åº¦</li><li>å¾€è¿”æ—¶é—´RTT:æŒ‡çš„æ˜¯ä»å‘é€ç«¯å‘é€æ•°æ®å¼€å§‹åˆ°å‘é€ç«¯æ¥å—åˆ°æ¥å—ç«¯çš„å“åº”ä¸ºæ­¢</li><li>åˆ©ç”¨ç‡:æŒ‡çš„æ˜¯ä¿¡é“åˆ©ç”¨ç‡å’Œç½‘ç»œåˆ©ç”¨ç‡</li></ol><h2 id="è®¡ç®—æœºç½‘ç»œåè®®åˆ’åˆ†"><a class="header-anchor" href="#è®¡ç®—æœºç½‘ç»œåè®®åˆ’åˆ†"></a>è®¡ç®—æœºç½‘ç»œåè®®åˆ’åˆ†</h2><ol><li><p>OSIä¸ƒå±‚åè®®<br>7. åº”ç”¨å±‚<br>6. è¡¨ç¤ºå±‚<br>5. ä¼šè¯å±‚<br>4. è¿è¾“å±‚<br>3. ç½‘ç»œå±‚<br>2. æ•°æ®é“¾è·¯å±‚</p><ol><li>ç‰©ç†å±‚</li></ol></li><li><p>TCP/IPå››å±‚åè®®<br>4. åº”ç”¨å±‚(TELNET,FTP,SMTP)<br>3. è¿è¾“å±‚(TCP/UDP)<br>2. ç½‘é™…å±‚(IP)</p><ol><li>ç½‘ç»œæ¥å£å±‚<br>ç”±äºTCP/IPåè®®ä¸­çš„ç½‘ç»œæ¥å£å±‚æ˜¯å¯¹é€šä¿¡é“¾è·¯çš„ä¸€ä¸ªæŠ½è±¡å› æ­¤å¹¶æ— å…·ä½“å®ç°,å› æ­¤åˆæŠ˜ä¸­å‡ºäº†ä¸€ä¸ªäº”å±‚åè®®çš„æ¶æ„</li></ol></li><li><p>äº”å±‚åè®®<br>5. åº”ç”¨å±‚<br>4. è¿è¾“å±‚<br>3. ç½‘ç»œå±‚<br>2. æ•°æ®é“¾è·¯å±‚</p><ol><li>ç‰©ç†å±‚</li></ol></li></ol><h2 id="TCPå’ŒUDPçš„å¼‚åŒ"><a class="header-anchor" href="#TCPå’ŒUDPçš„å¼‚åŒ"></a>TCPå’ŒUDPçš„å¼‚åŒ</h2><p>TCPå’ŒUDPéƒ½æ˜¯è¿è¾“å±‚åè®®,TCPåœ¨è®¾è®¡æ˜¯å¯é çš„(å› æ­¤æœ‰ä¸‰æ¬¡æ¡æ‰‹)</p><h2 id="TCP-IPåè®®æ—çš„æ²™æ¼æ¨¡å‹"><a class="header-anchor" href="#TCP-IPåè®®æ—çš„æ²™æ¼æ¨¡å‹"></a>TCP/IPåè®®æ—çš„æ²™æ¼æ¨¡å‹</h2><p>åº”ç”¨å±‚ :  HTTP   SMTP    DNS  RTP   H.323  SIP<br>\     /       \    /     \      /<br>è¿è¾“å±‚ :     TCP            UDP        SCTP<br>\             |          /<br>ç½‘é™…å±‚ :                    IP<br>/            |            <br>ç½‘ç»œæ¥å£å±‚:  æ¥å£1          æ¥å£2         æ¥å£3</p><h2 id="é€šä¿¡æ–¹å¼"><a class="header-anchor" href="#é€šä¿¡æ–¹å¼"></a>é€šä¿¡æ–¹å¼</h2><ol><li>å•å‘é€šä¿¡<br>ä¿¡å·åªèƒ½æ²¿ç€ä¸€ä¸ªæ–¹å‘ç§»åŠ¨</li><li>åŒå‘äº¤æ›¿é€šä¿¡(åŠåŒå·¥é€šä¿¡)<br>å•ä½æ—¶é—´å†…ä¿¡å·åªèƒ½æ²¿ç€ä¸€ä¸ªæ–¹å‘ç§»åŠ¨</li><li>åŒå‘åŒæ—¶é€šä¿¡<br>å•ä½æ—¶é—´å†…ä¿¡å·å¯å‘ä¸åŒçš„æ–¹å‘ç§»åŠ¨</li></ol><h2 id="ç½‘é™…å±‚åè®®-IP"><a class="header-anchor" href="#ç½‘é™…å±‚åè®®-IP"></a>ç½‘é™…å±‚åè®®-IP</h2><p>HTTPæ˜¯ä»€ä¹ˆ?<br>HTTPæ˜¯ä¸€ç§è¶…æ–‡æœ¬ä¼ è¾“åè®®(Hypertext Transfer Protocol),ä¸»è¦æ˜¯ç”±äº</p>]]></content>
      
      
      
        <tags>
            
            <tag> ç½‘ç»œåè®® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°æ€è·¯</title>
      <link href="2021/01/20/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/12.%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF/"/>
      <url>2021/01/20/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/12.%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<h1>å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°æ€è·¯</h1><h2 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰"></a>å®šä¹‰</h2><blockquote><p>å»¶è¿Ÿé˜Ÿåˆ—æŒ‡çš„æ˜¯å…ƒç´ æŒ‰ç…§å»¶è¿Ÿæ—¶é—´è¿›è¡Œæ’åºå½¢æˆå¹¶ä¸”åˆ°æ—¶åèƒ½è‡ªåŠ¨å¼¹å‡ºçš„æœ‰åºé˜Ÿåˆ—,åº•å±‚æ•°æ®ç»“æ„æ—¢å¯ä»¥æ˜¯æ•°ç»„ä¹Ÿå¯ä»¥æ˜¯é“¾è¡¨</p></blockquote><h2 id="é€‚ç”¨åœºæ™¯"><a class="header-anchor" href="#é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h2><p>æŒ‰ç…§å€’è®¡æ—¶è§¦å‘çš„ä¸šåŠ¡åœºæ™¯,ä¾‹å¦‚ç”µå•†ç½‘ç«™ä¸­çš„è®¢å•æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ,ç«æ‹,æ—¥å†å¾…åŠæé†’çš„åœºæ™¯,ä»¥åŠç”¨å®šæ—¶ä»»åŠ¡æ‰«è¡¨è§¦å‘çš„ä¸šåŠ¡åœºæ™¯</p><h2 id="å®ç°åŸç†"><a class="header-anchor" href="#å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>å¦‚æœè®©ä½ æ¥è®¾è®¡å»¶æ—¶é˜Ÿåˆ—,ä½ éœ€è¦æ€ä¹ˆæ ·æ¥è®¾è®¡?<br>å…ˆæ¥ä¸ªåŸºç¡€1.0çš„è®¾è®¡:è¦å®ç°å»¶æ—¶é˜Ÿåˆ—éœ€è¦ä¸¤ä¸ªè§’è‰²,ç¬¬ä¸€ä¸ªæ˜¯å­˜å‚¨ä¿¡æ¯çš„é˜Ÿåˆ—,ç¬¬äºŒä¸ªè§’è‰²æ˜¯â€™è®¡æ—¶å™¨â€™è´Ÿè´£ç›‘è§†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ—¶å€™åˆ°æœŸ</p><p>å›¾ç¤º2</p><h2 id="å®ç°æ–¹å¼"><a class="header-anchor" href="#å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h2><h3 id="DelayQueue"><a class="header-anchor" href="#DelayQueue"></a>DelayQueue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1.é˜Ÿåˆ—çš„è§’è‰²</span>    <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DelayedTask</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DelayedTask</span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayedTask</span><span class="token punctuation">(</span><span class="token number">1_0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_1:"</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DelayedTask</span> task5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayedTask</span><span class="token punctuation">(</span><span class="token number">1_5L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_2:"</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task1<span class="token punctuation">)</span><span class="token punctuation">;</span>    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2.è®¡æ—¶å™¨çš„è§’è‰²</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">DelayedTask</span> task <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        task<span class="token punctuation">.</span><span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æºç è§£æ</li></ul><blockquote><p>DelayQueueåº•å±‚é‡‡ç”¨çš„æ˜¯PriorityQueue,ä¸€ç§æä¾›ä¼˜å…ˆçº§çš„é˜Ÿåˆ—,poll()æ–¹æ³•å¦‚ä¸‹:</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//PriorityQueueæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„,å› æ­¤éœ€è¦ç”¨lock</span>    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">E</span> first <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> first<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·çš„å»¶æ—¶é˜Ÿåˆ—å¯ä»¥è§£å†³å•ä¸ªè¿›ç¨‹ä¸‹çš„å»¶è¿Ÿé˜Ÿåˆ—åœºæ™¯,ä½†æ˜¯æ— æ³•è§£å†³å¤šä¸ªåº”ç”¨ä¸‹çš„åœºæ™¯,é‚£ä¹ˆå¦‚ä½•åœ¨å®ç°åˆ†å¸ƒå¼çš„å»¶è¿Ÿé˜Ÿåˆ—å–ƒ?<br>å…ˆä»é—®é¢˜åˆ†æ,æˆ‘ä»¬æƒ³è¦å®ç°çš„æ˜¯åˆ†å¸ƒå¼çš„å»¶è¿Ÿé˜Ÿåˆ—,å¹¶ä¸”çŸ¥é“å»¶è¿Ÿé˜Ÿåˆ—æ˜¯ç”±å®šæ—¶å™¨å’Œé˜Ÿåˆ—æ„æˆ,å®šæ—¶å™¨ç”±å®¢æˆ·ç«¯å®ç°,é‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼çš„å…·æœ‰ä¼˜å…ˆçº§çš„é˜Ÿåˆ—ç»“æ„,èªæ˜çš„ä½ ä¸€å®šå°±æƒ³åˆ°äº†è¿™ä¸æ˜¯redisä¸­çš„zsetå˜›?å¯¹,ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åŸºäºrediså®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„1.0ç‰ˆæœ¬</p><h3 id="åŸºäºRedisçš„å»¶è¿Ÿé˜Ÿåˆ—"><a class="header-anchor" href="#åŸºäºRedisçš„å»¶è¿Ÿé˜Ÿåˆ—"></a>åŸºäºRedisçš„å»¶è¿Ÿé˜Ÿåˆ—</h3><blockquote><p>zsetå®šä¹‰:æ’åºé›†åˆï¼Œç±»ä¼¼äºé›†åˆï¼Œä½†æ¯ä¸ªå­—ç¬¦ä¸²å…ƒç´ éƒ½ä¸ä¸€ä¸ªç§°ä¸ºå¾—åˆ†çš„æµ®ç‚¹å€¼ç›¸å…³è”ã€‚ å…ƒç´ æ€»æ˜¯æŒ‰å®ƒä»¬çš„åˆ†æ•°æ’åºï¼Œå› æ­¤ä¸Setsä¸åŒï¼Œå¯ä»¥æ£€ç´¢ä¸€ç³»åˆ—å…ƒç´ </p></blockquote><ul><li>zset</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">RedissonClient</span> redisClient <span class="token operator">=</span> <span class="token function">getRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RScoredSortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> zset <span class="token operator">=</span> redisClient<span class="token punctuation">.</span><span class="token function">getScoredSortedSet</span><span class="token punctuation">(</span><span class="token string">"redisDelayQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    zset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getTimeLong</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    zset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getTimeLong</span><span class="token punctuation">(</span><span class="token number">20L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    zset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getTimeLong</span><span class="token punctuation">(</span><span class="token number">15L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> values <span class="token operator">=</span> zset<span class="token punctuation">.</span><span class="token function">valueRange</span><span class="token punctuation">(</span><span class="token function">getTimeLong</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getTimeLong</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        values<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RedissonClient</span> <span class="token function">getRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"redis://localhost:6379"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RedissonClient</span> client <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> client<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Long</span> <span class="token function">getTimeLong</span><span class="token punctuation">(</span><span class="token class-name">Long</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>RedissonDelayedTask</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">RedissonClient</span> redisClient <span class="token operator">=</span> <span class="token function">getRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> blockingFairQueue <span class="token operator">=</span> redisClient<span class="token punctuation">.</span><span class="token function">getBlockingQueue</span><span class="token punctuation">(</span><span class="token string">"RedissonDelayed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RDelayedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> delayedQueue <span class="token operator">=</span> redisClient<span class="token punctuation">.</span><span class="token function">getDelayedQueue</span><span class="token punctuation">(</span>blockingFairQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>    delayedQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    delayedQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    delayedQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingFairQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Redissonä¹Ÿå®ç°äº†å»¶è¿Ÿé˜Ÿåˆ—(RedissonDelayedQueue),åº•å±‚æ•°æ®ç»“æ„ä½¿ç”¨çš„æ˜¯zset,list,å‘å¸ƒ/è®¢é˜…,å¹¶ä¸”ä¹Ÿä¸æ˜¯æƒ³æˆ‘ä»¬ç°åœ¨è¿™æ ·é€šè¿‡whileå’Œæ–¹å¼æ¥ç›‘å¬å˜åŒ–çš„,æ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥çœ‹ä¸€ä¸‹Redissonå®ç°æ—¶ä½¿ç”¨çš„Luaè„šæœ¬</p><blockquote><p>ç›®å‰RedissonåŸºäºreidsçš„å»¶è¿Ÿé˜Ÿåˆ—åœ¨åŠŸèƒ½ä¸Šå¾ˆå®Œå–„äº†ä½œä¸ºå»¶è¿Ÿé˜Ÿåˆ—æ¥è¯´å·²ç»æ˜¯æ»¡è¶³çš„äº†,ä½†æ˜¯ä½œä¸ºä¸€ä¸ªå»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´è¿˜ç¼ºå°‘é‡è¯•æœºåˆ¶,ACK,å› æ­¤ä¸‹é¢ä»‹ç»ä¸¤ç§åŸºäºMQå®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„æ–¹å¼</p></blockquote><h3 id="åŸºäºRabbitMQçš„å»¶è¿Ÿé˜Ÿåˆ—"><a class="header-anchor" href="#åŸºäºRabbitMQçš„å»¶è¿Ÿé˜Ÿåˆ—"></a>åŸºäºRabbitMQçš„å»¶è¿Ÿé˜Ÿåˆ—</h3><h4 id="åŸºäºTTLçš„å®ç°æ–¹å¼"><a class="header-anchor" href="#åŸºäºTTLçš„å®ç°æ–¹å¼"></a>åŸºäºTTLçš„å®ç°æ–¹å¼</h4><blockquote><p>åŸºäºç”Ÿå­˜æ—¶é—´(TTL)å’Œæ­»ä¿¡é˜Ÿåˆ—(DLX)ç‰¹æ€§å®ç°çš„å»¶è¿Ÿé˜Ÿåˆ—;TTLæŒ‡çš„æ˜¯æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªç”Ÿå­˜æ—¶é—´,è¶…è¿‡è¿‡æœŸæ—¶é—´åæ¶ˆæ¯å°±ä¼šè¿›å…¥ä¸€ä¸ªç‰¹æ®Šé˜Ÿåˆ—,è¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯æ­»ä¿¡é˜Ÿåˆ—(DLX),DLXå¯ä»¥å°†æ¶ˆæ¯é‡æ–°æŠ•é€’åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­,consumeråªéœ€è¦è®¢é˜…è¿™ä¸ªé˜Ÿåˆ—å°±å¯ä»¥å®ç°å»¶è¿Ÿæ¶ˆè´¹çš„åŠŸèƒ½</p></blockquote><ul><li>Provider</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>consumer</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="åŸºäºæ’ä»¶çš„å®ç°æ–¹å¼"><a class="header-anchor" href="#åŸºäºæ’ä»¶çš„å®ç°æ–¹å¼"></a>åŸºäºæ’ä»¶çš„å®ç°æ–¹å¼</h4><h3 id="åŸºäºRocketMQçš„å»¶è¿Ÿé˜Ÿåˆ—"><a class="header-anchor" href="#åŸºäºRocketMQçš„å»¶è¿Ÿé˜Ÿåˆ—"></a>åŸºäºRocketMQçš„å»¶è¿Ÿé˜Ÿåˆ—</h3><h2 id="é™åˆ¶å’Œæ‰©å±•"><a class="header-anchor" href="#é™åˆ¶å’Œæ‰©å±•"></a>é™åˆ¶å’Œæ‰©å±•</h2><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://zhuanlan.zhihu.com/p/343811173">Redisson å»¶æ—¶é˜Ÿåˆ—åŸç†è¯¦è§£</a><br><a href="https://blog.csdn.net/u010059975/article/details/104537570">kafkaå»¶è¿Ÿæ¶ˆæ¯åŸå› </a></p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¸¸ç¬”è®°</title>
      <link href="2020/12/27/1.%E6%9D%82%E8%AE%B0/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0/"/>
      <url>2020/12/27/1.%E6%9D%82%E8%AE%B0/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1>æ—¥å¸¸ç¬”è®°</h1><blockquote><p>ç”¨äºè®°å½•å¸¸ç”¨çš„å‘½ä»¤ï¼Œçµæ„Ÿï¼Œå¾…åŠä¹‹ç±»çš„</p></blockquote><h2 id="docker-command"><a class="header-anchor" href="#docker-command"></a>docker command</h2><ol><li>mysql å¯åŠ¨å‘½ä»¤</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -p <span class="token number">3306</span>:3306 --name mysql_1 -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> -d mysql:5.7.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>mongo å¯åŠ¨å‘½ä»¤</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -itd --name mongo -p <span class="token number">27017</span>:27017 mongo --auth<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>è®¾ç½®è´¦æˆ·</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> //åˆ›å»ºç”¨æˆ·å¹¶æˆæƒ db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user: <span class="token string">"axonUser"</span>, pwd: <span class="token string">"123456"</span>, roles <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role: <span class="token string">"readWrite"</span>, db: <span class="token string">"interviewTest"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> //æ›´æ–°ç”¨æˆ·æƒé™db.grantRolesToUser<span class="token punctuation">(</span><span class="token string">"axonUser"</span>,<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role:<span class="token string">"readWrite"</span>, db:<span class="token string">"axon"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>4.RabbitMQ å¯åŠ¨å‘½ä»¤</p><ul><li>windows cmd</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -d --name rabbitmq -p <span class="token number">5672</span>:5672 -p <span class="token number">15672</span>:15672 -v E:<span class="token punctuation">\</span>dockerfile<span class="token punctuation">\</span>RabbitMQ:/var/lib/rabbitmq --hostname myRabbit -e <span class="token assign-left variable">RABBITMQ_DEFAULT_VHOST</span><span class="token operator">=</span>my_vhost  -e <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>admin -e <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>admin rabbitmq:latest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>å¯åŠ¨RabbitMQ adminå‘½ä»¤</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java">docker exec <span class="token operator">-</span>it rabbitmq rabbitmq<span class="token operator">-</span>plugins enable rabbitmq_management<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="6"><li>WSL åˆ‡æ¢é»˜è®¤çš„ç™»å½•ç”¨æˆ·,éœ€è¦åœ¨psç®¡ç†ç”¨æˆ·ä¸‹æ‰§è¡Œ</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ubuntu1804.exe config --default-user root<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> guava </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŠJavaå¼‚æ­¥ç¼–ç¨‹å®æˆ˜ã€‹ç¬”è®°</title>
      <link href="2020/12/12/1.%E6%9D%82%E8%AE%B0/java%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/"/>
      <url>2020/12/12/1.%E6%9D%82%E8%AE%B0/java%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1>ã€ŠJavaå¼‚æ­¥ç¼–ç¨‹å®æˆ˜ã€‹ç¬”è®°</h1><h2 id="ç¬¬ä¸€ç« -è®¤è¯†å¼‚æ­¥ç¼–ç¨‹"><a class="header-anchor" href="#ç¬¬ä¸€ç« -è®¤è¯†å¼‚æ­¥ç¼–ç¨‹"></a>ç¬¬ä¸€ç«  è®¤è¯†å¼‚æ­¥ç¼–ç¨‹</h2><p>åŸºç¡€æ¦‚å¿µå’Œåœºæ™¯ä»‹ç»ã€‚ç•¥â€¦</p><h2 id="ç¬¬äºŒç« -æ˜¾ç¤ºä½¿ç”¨çº¿ç¨‹å’Œçº¿ç¨‹æ± å®ç°å¼‚æ­¥ç¼–ç¨‹"><a class="header-anchor" href="#ç¬¬äºŒç« -æ˜¾ç¤ºä½¿ç”¨çº¿ç¨‹å’Œçº¿ç¨‹æ± å®ç°å¼‚æ­¥ç¼–ç¨‹"></a>ç¬¬äºŒç«  æ˜¾ç¤ºä½¿ç”¨çº¿ç¨‹å’Œçº¿ç¨‹æ± å®ç°å¼‚æ­¥ç¼–ç¨‹</h2><p>çº¿ç¨‹å’Œçº¿ç¨‹æ± çš„ä½¿ç”¨åšäº†ä¸ªç®€ä»‹ï¼Œé‡ç‚¹è®²äº†ä¸€ä¸‹çº¿ç¨‹æ± çš„å®ç°åŸç†</p><ul><li>çº¿ç¨‹æ± çš„å®ç°åŸç†<b>ThreadPoolExecutor</b></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>       w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allow interrupts</span>       <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>           <span class="token comment">//å¦‚æœå½“å‰è¿˜æœ‰ä»»åŠ¡</span>           <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>               w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                   wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                   <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                       <span class="token comment">//æ‰§è¡Œä»»åŠ¡</span>                       task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                       thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                       thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                       thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                       <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span>               <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                   task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                   w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>                   w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span>           <span class="token punctuation">&#125;</span>           completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>           <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ³¨æ„ä¸¤ä¸ªåœ°æ–¹:1.Threadä¼šè¢«åŒ…è£…æˆworkerå¯¹è±¡ç”¨<b>HashSet</b>ä¿å­˜;2.Taskæ˜¯ç”¨<b>BlockingQueue</b>æ¥è¿›è¡Œä¿å­˜</p></blockquote><h2 id="ç¬¬ä¸‰ç« -åŸºäºJDKä¸­çš„Futrueå®ç°å¼‚æ­¥ç¼–ç¨‹"><a class="header-anchor" href="#ç¬¬ä¸‰ç« -åŸºäºJDKä¸­çš„Futrueå®ç°å¼‚æ­¥ç¼–ç¨‹"></a>ç¬¬ä¸‰ç«  åŸºäºJDKä¸­çš„Futrueå®ç°å¼‚æ­¥ç¼–ç¨‹</h2><h3 id="FutureTask"><a class="header-anchor" href="#FutureTask"></a>FutureTask</h3><ul><li>run()</li><li>get()</li><li>cancel()</li></ul><blockquote><p>æ³¨æ„ä¸€ä¸‹FutureTaskçš„stateæ˜¯ç”¨volatileè¿›è¡Œä¿®é¥°ï¼Œç»“æœoutcomeæ˜¯ç”¨stateçš„å†…å­˜å±éšœæŠ€æœ¯æ¥ä¿è¯å¯è§æ€§çš„</p></blockquote><h3 id="CompletableFuture"><a class="header-anchor" href="#CompletableFuture"></a>CompletableFuture</h3><ul><li>runAsync()</li><li>supplyAsync()</li><li>thenRun()</li><li>thenAccept()</li><li>thenApply()</li><li>whenComplete()</li><li>thenCompose()</li><li>thenCombine()</li><li>allOf()</li><li>anyOf()</li><li>completeExeceptionally() å¼‚å¸¸å¤„ç†</li></ul><blockquote><p>CompletableFutureé»˜è®¤æ˜¯ç”¨ForkJoinPool,è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹</p></blockquote><h2 id="Springæ¡†æ¶ä¸­çš„å¼‚æ­¥æ‰§è¡Œ"><a class="header-anchor" href="#Springæ¡†æ¶ä¸­çš„å¼‚æ­¥æ‰§è¡Œ"></a>Springæ¡†æ¶ä¸­çš„å¼‚æ­¥æ‰§è¡Œ</h2><h3 id="TaskExecutor"><a class="header-anchor" href="#TaskExecutor"></a>TaskExecutor</h3><p>ç•¥â€¦</p><h3 id="Async"><a class="header-anchor" href="#Async"></a>@Async</h3><p>@EnableAsyncæ˜¯é€šè¿‡AsyncConfigurationSelectorè¿›è¡ŒåŠ è½½ï¼Œ</p><h2 id="åŸºäºååº”å¼ç¼–ç¨‹å®ç°å¼‚æ­¥ç¼–ç¨‹"><a class="header-anchor" href="#åŸºäºååº”å¼ç¼–ç¨‹å®ç°å¼‚æ­¥ç¼–ç¨‹"></a>åŸºäºååº”å¼ç¼–ç¨‹å®ç°å¼‚æ­¥ç¼–ç¨‹</h2><blockquote><p>ååº”å¼ç¼–ç¨‹æ˜¯ä¸€ç§æ¶‰åŠæ•°æ®æµå’Œå˜åŒ–ä¼ æ’­çš„å¼‚æ­¥ç¼–ç¨‹èŒƒå¼ã€‚è¿™æ„å‘³ç€å¯ä»¥é€šè¿‡æ‰€é‡‡ç”¨çš„ç¼–ç¨‹è¯­è¨€è½»æ¾çš„è¡¨è¾¾é™æ€æˆ–åŠ¨æ€æ•°æ®æµã€‚</p></blockquote><p>ååº”å¼ç¼–ç¨‹ä¸»è¦æ˜¯å¼ºè°ƒå¯¹æ•°æ®çš„å¤„ç†è¿‡ç¨‹æ˜¯ä¸»åŠ¨çš„ï¼Œæ˜¯ä»¥æ•°æ®ä¸ºæ ¸å¿ƒå‚ä¸å¯¹è±¡çš„è¿‡ç¨‹ã€‚ä¼ ç»Ÿçš„ç¼–ç¨‹æ¨¡å‹ä¸‹æ˜¯ä»¥ä¸šåŠ¡æµç¨‹ä¸ºæ ¸å¿ƒï¼Œé€šè¿‡ä¸šåŠ¡æµç¨‹å°†æ•°æ®ä¸²è”èµ·æ¥ã€‚</p><h3 id="Reactive-Streamsè§„èŒƒ"><a class="header-anchor" href="#Reactive-Streamsè§„èŒƒ"></a>Reactive Streamsè§„èŒƒ</h3><blockquote><p>Reactive Streamsè§„èŒƒæ˜¯æä¾›ä¸€ä¸ªä½¿ç”¨éé˜»å¡å›å‹åŠŸèƒ½å¯¹å¼‚æ­¥æµè¿›è¡Œå¤„ç†çš„æ ‡å‡†ï¼Œä¹Ÿå°±æ˜¯å®šä¹‰ååº”å¼ç¼–ç¨‹çš„è§„èŒƒ</p></blockquote><h3 id="åŸºäºRxJavaå®ç°å¼‚æ­¥ç¼–ç¨‹"><a class="header-anchor" href="#åŸºäºRxJavaå®ç°å¼‚æ­¥ç¼–ç¨‹"></a>åŸºäºRxJavaå®ç°å¼‚æ­¥ç¼–ç¨‹</h3><p>==RxJava==æ˜¯Reactive Extensionsçš„javaè¯­è¨€å®ç°ï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯å‚è€ƒå®˜ç½‘</p><h3 id="åŸºäºReactorå®ç°å¼‚æ­¥ç¼–ç¨‹"><a class="header-anchor" href="#åŸºäºReactorå®ç°å¼‚æ­¥ç¼–ç¨‹"></a>åŸºäºReactorå®ç°å¼‚æ­¥ç¼–ç¨‹</h3><p>==Reactor==æ˜¯å¦å¤–ä¸€ä¸ªJavaè¯­è¨€ä¸‹çš„æ˜¯Reactiveå®ç°ï¼Œç›®å‰åœ¨webFluxä¸­ä½œä¸ºååº”å¼æ¡†æ¶è¿›è¡Œä½¿ç”¨</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªè½¯ä»¶å‘å±•çš„è¶‹åŠ¿å°±æ˜¯ä¼ ç»Ÿçš„ç¼–ç¨‹æ¨¡å‹æ˜¯åŸºäºcpuå¤šæ ¸æŠ€æœ¯å‘å±•çš„è¿˜ä¸æ˜¯å¾ˆå¥½çš„æ—¶å€™æå‡ºæ¥çš„ï¼Œå·²ç»ä¸å¤ªé€‚ç”¨äºç°ä»£å¤šæ ¸cpuæ¶æ„ã€‚å› æ­¤åŸºäºç°ä»£cpuå¤šæ ¸æ¶æ„å’Œä¼ ç»Ÿè½¯ä»¶æ¶æ„é¢å¯¹çš„é—®é¢˜ï¼Œæå‡ºäº†ååº”å¼ç¼–ç¨‹æ¨¡å‹ã€‚è¿™ç§ç¼–ç¨‹æ–¹å¼ä¹Ÿè®¸ä¸æ˜¯å¾ˆä¾¿äºäººç±»ç†è§£ï¼Œä½†æ˜¯ç¡®æ‹¥æœ‰æ›´é«˜çš„èµ„æºåˆ©ç”¨ç‡ã€‚å¦‚æœæœªæ¥å‡ºç°ä¸€ä¸ªåƒspringå¯¹äºjavaé‚£æ ·å¯¹äºååº”å¼ç¼–ç¨‹çš„æ¡†æ¶ï¼Œååº”å¼ç¼–ç¨‹ç†å¿µåº”è¯¥ä¼šå¾—åˆ°æ›´å¥½çš„å‘å±•ã€‚</p><h2 id="Web-Servletçš„å¼‚æ­¥éé˜»å¡å¤„ç†"><a class="header-anchor" href="#Web-Servletçš„å¼‚æ­¥éé˜»å¡å¤„ç†"></a>Web Servletçš„å¼‚æ­¥éé˜»å¡å¤„ç†</h2><p>åœ¨Servlet3.0ä¸­æä¾›äº†å¼‚æ­¥å¤„ç†èƒ½åŠ›ï¼Œè®©è¯·æ±‚çº¿ç¨‹å’Œå¤„ç†çº¿ç¨‹ä¸åœ¨æ˜¯1ï¼š1çš„å…³ç³»äº†,è¿™é‡Œå°±å¯ä»¥æ›´å¥½çš„åˆ©ç”¨æœåŠ¡å™¨çš„æ€§èƒ½ã€‚<br>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ä»€ä¹ˆServlet 3æ‰æå‡ºçš„å¼‚æ­¥å¤„ç†èƒ½åŠ›å–ƒï¼Ÿ<br>è¿™æ˜¯å› ä¸ºservletæ˜¯åŸºhttp1.1çš„æ–¹æ¡ˆï¼Œhttp1.1å¼€å§‹æ”¯æŒhttpå¯ä»¥ä¿æŒé•¿è¿æ¥çš„å½¢å¼ï¼Œhhtp1.1æ–¹æ¡ˆæ˜¯1999å¹´å¼€å§‹<br>åœ¨Servlet3.1ä¸­æä¾›äº†éé˜»å¡I/Oçš„å¤„ç†æ–¹å¼:Webå®¹å™¨ä¸­çš„éé˜»å¡è¯·æ±‚å¤„ç†æœ‰åŠ©äºå¢åŠ Webå®¹å™¨å¯åŒæ—¶å¤„ç†è¯·æ±‚çš„æ•°é‡ï¼Œå…è®¸æˆ‘ä»¬åœ¨ServletInputStreamä¸Šé€šè¿‡å‡½æ•°setReadListeneræ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨åœ¨å‘ç°å†…æ ¸ä¸­æœ‰æ•°æ®æ—¶æ‰ä¼šè¿›è¡Œå›è°ƒå¤„ç†å‡½æ•°ã€‚</p><h3 id="spring-MVCçš„å¼‚æ­¥å¤„ç†èƒ½åŠ›"><a class="header-anchor" href="#spring-MVCçš„å¼‚æ­¥å¤„ç†èƒ½åŠ›"></a>spring MVCçš„å¼‚æ­¥å¤„ç†èƒ½åŠ›</h3><blockquote><p>Spring MVCæ˜¯å›´ç»•å‰ç«¯æ§åˆ¶å™¨æ¨¡å¼è®¾è®¡ï¼Œç”±ä¸­å¤®å¤„ç†å™¨Servlet DispatcheaServletä½œä¸ºè¯·æ±‚å¤„ç†è¿›è¡Œè·¯ç”±åˆ†æ´¾ï¼Œå®é™…è¯·æ±‚å¤„ç†å·¥ä½œç”±å¯é…ç½®å¤„ç†ç±»è¿›è¡Œæ‰§è¡Œã€‚åœ¨Spring MVCä¸­é€šè¿‡è°ƒç”¨request.startAsync()å°†ServletRequestè®¾ç½®ä¸ºå¼‚æ­¥æ¨¡å¼ï¼Œè¿™æ ·å¯ä»¥è®©Servletåœ¨æ¨å‡ºçš„åŒæ—¶ï¼Œè®©å“åº”ä¿æŒæ‰“å¼€çŠ¶æ€ã€‚</p></blockquote><h2 id="Spring-web-Flux"><a class="header-anchor" href="#Spring-web-Flux"></a>Spring web Flux</h2><p>webFluxä¸spring mvcçš„å¯¹æ¯”<br><img src="https://docs.spring.io/spring-framework/docs/current/reference/html/images/spring-mvc-and-webflux-venn.png" alt="webFlux vs spring mvc"></p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.infoworld.com/article/2077995/java-concurrency-asynchronous-processing-support-in-servlet-3-0.html?page=1">infoworldå…³äºservlet 3.0çš„ä»‹ç»</a><br><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html">springå®˜ç½‘å…³äºwebFluxçš„æ–‡æ¡£</a></p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DockeråŸºç¡€æ¦‚å¿µå…¥é—¨(äºŒ)</title>
      <link href="2020/11/29/1.%E6%9D%82%E8%AE%B0/Docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8(%E4%BA%8C)/"/>
      <url>2020/11/29/1.%E6%9D%82%E8%AE%B0/Docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8(%E4%BA%8C)/</url>
      
        <content type="html"><![CDATA[<h2 id="Dockerfileæ–‡ä»¶"><a class="header-anchor" href="#Dockerfileæ–‡ä»¶"></a>Dockerfileæ–‡ä»¶</h2><blockquote><p>Dockerfileæ–‡ä»¶æ˜¯ç”¨æ¥æ„å»ºé•œåƒçš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ–‡æœ¬æ–‡ä»¶ä¸­åŒ…å«äº†ä¸€ç³»åˆ—æ„å»ºé•œåƒæ‰€éœ€çš„æŒ‡ä»¤å’Œè¯´æ˜</p></blockquote><h2 id="javaåŸºç¡€ç¯å¢ƒ"><a class="header-anchor" href="#javaåŸºç¡€ç¯å¢ƒ"></a>javaåŸºç¡€ç¯å¢ƒ</h2><ul><li>Dockerfile</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åŸºç¡€é•œåƒç‰ˆæœ¬</span>FROM java:latest<span class="token comment"># è®¾ç½®å·¥ä½œç›®å½•</span>WORKDIR /app<span class="token comment"># å¤åˆ¶åˆå§‹æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ä¸­</span>COPY <span class="token builtin class-name">.</span> /app<span class="token comment"># è®¾ç½®Javaç¯å¢ƒå˜é‡</span>ENV <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/binENV <span class="token assign-left variable">JRE_HOME</span><span class="token operator">=</span><span class="token variable">$&#123;JAVA_HOME&#125;</span>/jreENV <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="token variable">$&#123;JRE_HOME&#125;</span>/lib<span class="token comment"># ç¼–è¯‘</span>RUN <span class="token punctuation">[</span><span class="token string">"/usr/lib/jvm/java-8-openjdk-amd64/bin/javac"</span>,<span class="token string">"Docker_java.java"</span><span class="token punctuation">]</span><span class="token comment"># è¿è¡Œ</span>ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"/usr/lib/jvm/java-8-openjdk-amd64/bin/java"</span>, <span class="token string">"Docker_java"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Dockerfileæ–‡ä»¶éœ€è¦åœ¨å½“å‰å·¥ä½œç›®å½•ä¸‹ç¼–å†™ï¼ŒDocker_java.javaæ–‡ä»¶ä¹Ÿéœ€è¦åœ¨å½“å‰å·¥ä½œç›®å½•ä¸‹</p><ul><li>Docker_java.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Docker_java</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello Docker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>buildå‘½ä»¤å’Œå¯åŠ¨å‘½ä»¤</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -rm è¡¨ç¤ºæ„å»ºå®Œæˆååˆ é™¤ä¸­é—´é•œåƒ</span><span class="token comment"># -f  è¡¨ç¤ºæŒ‡å®šDockerfileæ–‡ä»¶,é»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸‹çš„Dockerfileæ–‡ä»¶ </span><span class="token comment"># -t  è¡¨ç¤ºå¯¹é•œåƒæ‰“tag</span>docker build --rm -f <span class="token string">"Dockerfile"</span> -t docker_java:0.0.1<span class="token comment">#è¿è¡Œå‘½ä»¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>docker run docker_java:0.0.1</code></pre><pre class="line-numbers language-none"><code class="language-none">## mysqlç¯å¢ƒ&gt; æ„å»ºä¸€ä¸ªè´¦å·åç§°ä¸ºtest,å¯†ç ä¸ºtestå¹¶ä¸”è‡ªå®šä¹‰åˆå§‹åŒ–sqlmysqlå®¹å™¨- Dockerfile&#96;&#96;&#96;bash#åŸºç¡€ç‰ˆæœ¬FROM mysql:5.7.22#ç¯å¢ƒå˜é‡ENV TZ&#x3D;Asia&#x2F;Shanghai \    MYSQL_DATABASE&#x3D;test \    MYSQL_USER&#x3D;test \    MYSQL_PASSWORD&#x3D;test \    MYSQL_ROOT_PASSWORD&#x3D;test#å°†sqlç›®å½•ä¸‹çš„æ–‡ä»¶å…¨éƒ¨æ‹·è´åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ä¸‹COPY sql&#x2F;. &#x2F;docker-entrypoint-initdb.d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>init.sql</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">USE</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>table_a<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>table_a<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>sync_pk<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span><span class="token punctuation">`</span>hos_code<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span><span class="token punctuation">`</span>study_iuid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span><span class="token punctuation">`</span>study_content<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token punctuation">,</span><span class="token punctuation">`</span>study_state<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token punctuation">`</span>remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span><span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>sync_pk<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ„å»ºå‘½ä»¤</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker build --rm -f <span class="token string">"Dockerfile"</span> -t mysqlc:0.0.1 <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>è¿è¡Œå‘½ä»¤</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#ä¸mysqlå¯åŠ¨ä¸€è‡´</span>docker run -itd --name mysql_local mysqlc:0.0.1 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•ä¼˜åŒ–å¤æ‚æµç¨‹åˆ†æå’Œå»ºæ¨¡æ€è€ƒ</title>
      <link href="2020/11/08/1.%E6%9D%82%E8%AE%B0/%E5%9F%BA%E4%BA%8E%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%BA%E6%A8%A1%E6%80%9D%E8%80%83/"/>
      <url>2020/11/08/1.%E6%9D%82%E8%AE%B0/%E5%9F%BA%E4%BA%8E%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%BA%E6%A8%A1%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ¶æ„çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯å¦‚ä½•å¤„ç†å½“ä¸‹æˆ–æœªæ¥å¯èƒ½å‡ºç°çš„å¿«é€Ÿå¢é•¿çš„è½¯ä»¶å¤æ‚æ€§ï¼Œå› æ­¤è¶Šæ˜¯å¤§å‹ç³»ç»Ÿåœ¨æ¶æ„è®¾è®¡ä¸Šè¶Šæ˜¯è¦ç®€å•ã€‚</p></blockquote><h2 id="è½¯ä»¶çš„å¤æ‚åº¦ä¸ºä»€ä¹ˆä¼šå¢åŠ ï¼Ÿ"><a class="header-anchor" href="#è½¯ä»¶çš„å¤æ‚åº¦ä¸ºä»€ä¹ˆä¼šå¢åŠ ï¼Ÿ"></a>è½¯ä»¶çš„å¤æ‚åº¦ä¸ºä»€ä¹ˆä¼šå¢åŠ ï¼Ÿ</h2><p>å…ˆé˜è¿°è§‚ç‚¹åœ¨å®é™…å¼€å‘ä¸­è½¯ä»¶çš„å¤æ‚æ€§æ˜¯éšç€æ—¶é—´æ„ˆå‘é™¡å³­çš„ï¼Œå¤æ‚åº¦çš„æå‡è¿‘ä¼¼äºy=x^2çš„æ›²çº¿ã€‚ä¸»è¦æ˜¯åŸºäºä»¥ä¸‹å‡ ä¸ªæƒ…å†µå¾—å‡ºçš„ç»“è®ºï¼š</p><ol><li><B>è½¯ä»¶çš„å¤æ‚ç¨‹åº¦æ˜¯é€æ¸è¿­ä»£å‡ºæ¥çš„</B><br>æ‹¿æˆ‘ä¹‹å‰çš„é¡¹ç›®ä¸¾ä¾‹ï¼Œæœ€å¼€å§‹ä¸šåŠ¡éœ€æ±‚å¯èƒ½åªæ˜¯å›´ç»•å•†å“çš„ä¸€ä¸ªä¸šåŠ¡ï¼Œæ ¹æ®è¿™ä¸ªä¸šåŠ¡è®¾è®¡æµç¨‹ï¼Œåæ¥æ…¢æ…¢çš„è¿­ä»£è¿‡ç¨‹ä¸­é€æ¸æŠŠå•†å“ç›¸å…³çš„å±æ€§å®Œå–„ä»è€Œåˆèƒ½æ”¯æ’‘èµ·å¼€å±•å…¶ä»–çš„ä¸šåŠ¡æµç¨‹ã€‚éšç€ä¸šåŠ¡æµç¨‹çš„è†¨èƒ€å’Œäº¤æ±‡ï¼Œè½¯ä»¶çš„å¤æ‚åº¦ä¼šä¸æ–­çš„å¢åŠ ã€‚</li><li><B>ä»£ç è¿­ä»£è¿‡ç¨‹ä¸­çš„ç†è§£å’Œç»´æŠ¤</B><br>è½¯ä»¶å¯¹åº”çš„å®ä½“å³ä¸ºä»£ç ï¼Œåœ¨ç›¸åŒçš„æ¶æ„ä¸‹ä¸åŒçš„ç†è§£ä¼šæœ‰ä¸åŒçš„ä»£ç å®ç°ã€‚ç”±äºå¤§å‹é¡¹ç›®å¾€å¾€æ˜¯å¤šäººè¿›è¡Œåä½œå¼€å‘ï¼Œéœ€è¦ç»Ÿä¸€å¤§å®¶çš„ç†è§£ã€‚é€šä¿—çš„è¯´æ³•å°±æ˜¯å¤šä¸ªäººå†™å‡ºæ¥çš„ä»£ç å°±åƒä¸€ä¸ªäººå†™å‡ºæ¥çš„ä¸€æ ·ï¼Œè¦å®Œæˆè¿™æ ·çš„åˆä½œå¾€å¾€æ˜¯å¾ˆå›°éš¾çš„ã€‚è¿™é‡Œåœ¨è¡¥å……é˜è¿°ä¸€ä¸‹ï¼Œå¹¶ä¸æ˜¯åå¯¹æœ‰ç€å¼ºçƒˆä¸ªäººä»£ç é£æ ¼çš„æ–¹å¼ï¼Œä¸»è¦è¿˜æ˜¯æƒ³è¡¨è¾¾çš„æ˜¯åŒä¸€å›¢é˜Ÿåœ¨é¢å¯¹åŒä¸€é¡¹ç›®æ—¶å¯¹è½¯ä»¶çš„æ¶æ„ã€æŠ€æœ¯ã€ä¸šåŠ¡ç†è§£åº”è¯¥æ˜¯å°½é‡è¦<B>è¶‹åŒ<B>çš„ã€‚</li></ol><blockquote><p>ä¸šåŠ¡æ¶æ„å¸ˆæœ€é‡è¦çš„å·¥ä½œä¸æ˜¯è®¾è®¡è½¯ä»¶ç»“æ„ï¼Œè€Œæ˜¯åº”è¯¥é€šè¿‡APIã€å›¢é˜Ÿè®¾è®¡å‡†åˆ™ã€ç»†èŠ‚çš„å…³æ³¨æŠŠæ§æ¥æ§åˆ¶è½¯ä»¶å¤æ‚åº¦çš„å¢é•¿ã€‚</p></blockquote><h2 id="å¦‚ä½•å®šä¹‰è½¯ä»¶å¤æ‚çš„ç»´åº¦ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å®šä¹‰è½¯ä»¶å¤æ‚çš„ç»´åº¦ï¼Ÿ"></a>å¦‚ä½•å®šä¹‰è½¯ä»¶å¤æ‚çš„ç»´åº¦ï¼Ÿ</h2><p>è½¯ä»¶çš„å¤æ‚åº¦å¯ä»¥å®šä¹‰ä¸ºè®©äººç†è§£å’Œç»´æŠ¤ä¿®æ”¹çš„å›°éš¾ç¨‹åº¦ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è½¯ä»¶çš„å¤æ‚ç¨‹åº¦æ‹†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p><ol><li>è½¯ä»¶çš„è®¤çŸ¥æˆæœ¬ï¼šç†è§£è½¯ä»¶çš„æ¥å£ã€è®¾è®¡å’Œå®ç°ä¸Šçš„æˆæœ¬ï¼Œç®€å•è¯´å°±æ˜¯çœ‹æ‡‚ä»£ç çš„æ—¶é—´æˆæœ¬å’Œè„‘åŠ›æˆæœ¬</li><li>è½¯ä»¶çš„ååŒæˆæœ¬ï¼šä¿®æ”¹ç»´æŠ¤è½¯ä»¶æ—¶ï¼Œæ‰€éœ€è¦ä»˜å‡ºçš„æˆæœ¬<br>ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œè½¯ä»¶çš„æ‰©å±•æ€§ä¸å¥½å°±æ˜¯ååŒæˆæœ¬è¿‡é«˜ï¼Œä¼šå¯¼è‡´æ–°å¢åŠŸèƒ½æ—¶éœ€è¦è¿›è¡Œå¤§é‡ä¿®æ”¹ï¼Œå¹¶ä¸”ä¿®æ”¹åè¿˜ä¼šè¿›ä¸€æ­¥çš„å¢åŠ è®¤çŸ¥è´Ÿæ‹…</li></ol><h3 id="è®¤çŸ¥è´Ÿæ‹…"><a class="header-anchor" href="#è®¤çŸ¥è´Ÿæ‹…"></a>è®¤çŸ¥è´Ÿæ‹…</h3><ol><li>å®šä¹‰æ–°çš„æ¦‚å¿µå¸¦æ¥çš„è®¤çŸ¥è´Ÿæ‹…ï¼Œè¿™ç§è´Ÿæ‹…ä¸æ‰€å®šä¹‰çš„æ¦‚å¿µä¸ç°å®æ¨¡å‹çš„å…³è”åº¦ç›¸å…³</li><li>é€»è¾‘ç¬¦åˆæ€ç»´ä¹ æƒ¯çš„ç¨‹åº¦</li></ol><ul><li>é€»è¾‘æ˜¯å¦ç¬¦åˆæ€ç»´ä¹ æƒ¯çš„ç¨‹åº¦ï¼Œè¿™ä¸ªå› äººè€Œå¼‚ï¼Œæœ€å¥½åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­æœ‰ç»Ÿä¸€çš„è§„èŒƒï¼Œä¾‹å¦‚å¼ºçƒˆå»ºè®®ä½¿ç”¨å«è¯­å¥ã€ä½¿ç”¨Optionalç­‰</li><li>æ¨¡å‹å¤±é…ï¼šæ¨¡å‹çš„å¤±é…æŒ‡çš„æ˜¯å®šä¹‰çš„æ¨¡å‹ä¸ç°å®ä¸–ç•Œçš„ä¸šåŠ¡æ¨¡å‹å­˜åœ¨è¾ƒå¤§å·®å¼‚æ‰€å¸¦æ¥çš„</li></ul><ol start="3"><li>æ¥å£è®¾è®¡ä¸å½“</li></ol><ul><li><p>éœ€è¦è°ƒç”¨è€…ä½¿ç”¨åˆå§‹åŒ–æ‰èƒ½æ­£å¸¸å·¥ä½œçš„æ¥å£ã€‚å°†åˆå§‹åŒ–çš„èŒè´£æ”¾åˆ°äº†è°ƒç”¨æ–¹ï¼Œä½†æ˜¯è°ƒç”¨æ–¹åœ¨é¢å¯¹å¤æ‚çš„åˆå§‹åŒ–å‚æ•°æ—¶ï¼Œå°±éœ€è¦å»äº†è§£æ¯ä¸ªå‚æ•°æ‰€ä»£è¡¨çš„åŠ¨ä½œå’Œæ„ä¹‰ï¼Œæ‰¿æ‹…äº†æœ¬æ¥å±äºæ¥å£å®ç°æ‰€æ‰¿æ‹…çš„èŒè´£ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼æ¥è¿›è¡Œå¤„ç†ï¼Œåœ¨æ¥å£å·¥å‚ç±»ä¸­æ ¹æ®æ¥å£æä¾›çš„åœºæ™¯è¿›è¡Œå¤„ç†</p></li><li><p>ä¸€ä¸ªæ¥å£ä¸­ä¸åŒçš„æ–¹æ³•æä¾›äº†ç›¸åŒçš„åŠŸèƒ½</p></li></ul><ol start="4"><li><p>è¿åå¼€é—­åŸåˆ™ï¼Œä¸€ä¸ªç®€å•çš„ä¿®æ”¹éœ€è¦åœ¨å¤šå¤„ä¸­è¿›è¡Œæ›´æ–°<br>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¾€å¾€ä¼šä¸ºäº†è¿›åº¦æˆ–è€…å®³æ€•æ–°çš„æ”¹åŠ¨ä¼šæ”¹å˜å·²æœ‰ä»£ç çš„é€»è¾‘å› æ­¤å»copy-pastå¤§é‡ç±»ä¼¼çš„é€»è¾‘å’ŒåŠŸèƒ½ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸€ä¸ªç®€å•çš„ä¿®æ”¹éœ€è¦æ›´å¤šçš„ç²¾åŠ›åœ¨å¤šå¤„ä¸­è¿›è¡Œå»æ›´æ–°ï¼Œä»£ç çš„å¤æ‚åº¦ä¹Ÿä¼šæé«˜</p></li><li><p>å‘½å å°½é‡è¦åšåˆ°é€šè¿‡çš„å‘½åå°±çŸ¥é“å˜é‡ã€æ–¹æ³•ã€ç±»ã€æ¨¡å—ç­‰è¦<B>åšä»€ä¹ˆ</B>ï¼Œé‡ç‚¹åœ¨äºåšä»€ä¹ˆä¸Šé¢è€Œä¸æ˜¯æ˜¯ä»€ä¹ˆä¸Šé¢ã€‚</p></li></ol><h3 id="ååŒæˆæœ¬"><a class="header-anchor" href="#ååŒæˆæœ¬"></a>ååŒæˆæœ¬</h3><blockquote><p>ååŒæˆæœ¬æ˜¯æ–°å¢ã€ä¿®æ”¹åŠŸèƒ½æ‰€ä»˜å‡ºçš„æ—¶é—´æˆæœ¬å’Œè„‘åŠ›æˆæœ¬ã€‚</p></blockquote><ol><li><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæ¨¡å—/æœåŠ¡çš„åˆ‡åˆ†æ˜¯å’Œå›¢é˜Ÿå¯¹é½çš„ï¼Œå³&quot;ç»„ç»‡æ¶æ„å†³å®šç³»ç»Ÿæ¶æ„&quot;,ç»„ç»‡æ¶æ„æœ€ä½³çš„åˆ’åˆ†æ˜¯æŒ‰ç…§ç³»ç»Ÿæ¶æ„æ¥è¿›è¡Œçš„ï¼Œå½“ç»„ç»‡åˆ’åˆ†ä¸å¥½æ—¶ï¼Œå¾€å¾€ä¼šå¯¼è‡´é‡å¤çš„å·¥ä½œã€‚</p></li><li><p>æœåŠ¡é—´ç›¸äº’ä¾èµ–ï¼ŒæœåŠ¡é—´ç›¸äº’ä¾èµ–ä¸»è¦æœ‰ä¸¤ç§ç§å½¢å¼ç»„å’Œã€ç»§æ‰¿ã€‚ç»§æ‰¿ä¼šå‘ˆç°å‡ºæ›´å¼ºåˆ¶çš„å…³ç³»ï¼Œå› æ­¤ä¹Ÿä¼šæœ‰æ›´å¤§çš„ååŒå¤æ‚æ€§ã€‚</p></li><li><p>å¯æµ‹è¯•æ€§å¸¦æ¥çš„ååŒæˆæœ¬ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ç”±äºå•å…ƒæµ‹è¯•ä¸å®Œå–„éœ€è¦æ›´å®Œå–„çš„é›†æˆæµ‹è¯•æ¥ä¿è¯è½¯ä»¶çš„æ­£ç¡®æ€§ã€‚</p></li><li><p>æ–‡æ¡£  é™ä½ååŒæˆæœ¬çš„ä¸€ä¸ªå¥½æ–¹æ³•å°±æ˜¯å®Œå–„æ–‡æ¡£ï¼ŒåŒ…æ‹¬ä¸šåŠ¡æ–‡æ¡£ã€è®¾è®¡æ–‡æ¡£ã€æ¥å£æ–‡æ¡£ç­‰ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å·¥ä½œå¹¶ä¸ä¼šç›´æ¥äº§ç”Ÿæ•ˆç›Šï¼Œå› æ­¤ç§¯ææ€§éƒ½ä¸æ˜¯å¾ˆé«˜ã€‚</p></li></ol><h2 id="å¦‚ä½•åº”å¯¹è½¯ä»¶ä¸æ–­å¢é•¿çš„å¤æ‚åº¦ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•åº”å¯¹è½¯ä»¶ä¸æ–­å¢é•¿çš„å¤æ‚åº¦ï¼Ÿ"></a>å¦‚ä½•åº”å¯¹è½¯ä»¶ä¸æ–­å¢é•¿çš„å¤æ‚åº¦ï¼Ÿ</h2><p>æ¯ä¸€æ¬¡æ— æ„è¯†çš„ä»£ç çš„æ”¹åŠ¨éƒ½ä¼šäº§ç”Ÿä¾èµ–/è€¦åˆä»è€Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œè½¯ä»¶çš„å¤æ‚ç¨‹åº¦æ¶åŒ–åˆ°ä¸€å®šç¨‹åº¦åå°±ä¼šå¯¼è‡´ç³»ç»Ÿä¸å¯é¿å…çš„å¤±è´¥ã€‚å› æ­¤éœ€è¦æˆ‘ä»¬å¯¹å¤æ‚åº¦å¢åŠ é‡‡ç”¨é›¶å®¹å¿çš„æ€åº¦ã€‚</p><ul><li>è½¯ä»¶çš„å¤æ‚åº¦å¸¦æ¥çš„å½±å“å¾€å¾€æ˜¯æ»åçš„ï¼Œåœ¨çœ‹åˆ°å½±å“æ—¶ä¹Ÿè®¸å·²ç»è¿‡å»äº†å¾ˆä¹…</li><li>åœ¨è¿›è¡Œä»£ç reviewæ—¶ï¼Œæ¯ä¸€ä¸ªé¢å¤–çš„å¤æ‚åº¦è®¾è®¡åœ¨æ•´ä¸ªç³»ç»Ÿçš„è§’åº¦ä¸‹éƒ½æ˜¾å¾—å¾®ä¸è¶³é“ï¼Œä½†æ˜¯åƒé‡Œä¹‹å ¤ä»¥è¼èšä¹‹æºƒã€‚</li><li>ç ´çª—æ•ˆåº”Broken windowï¼šä¸€ä¸ªå»ºç­‘ï¼Œå½“æœ‰äº†ä¸€ä¸ªç ´çª—è€Œä¸åŠæ—¶ä¿®è¡¥ï¼Œè¿™ä¸ªå»ºç­‘å°±ä¼šè¢«ä¾µå…¥ä½è®¤ä¸ºæ˜¯æ— äººå±…ä½çš„ã€é£é›¨æ›´å®¹æ˜“è¿›æ¥ï¼Œæ›´å¤šçš„çª—æˆ·è¢«äººæœ‰æ„æ‰“ç ´ï¼Œå¾ˆå¿«æ•´ä¸ªå»ºç­‘ä¼šåŠ é€Ÿç ´è´¥ã€‚è¿™å°±æ˜¯ç ´çª—æ•ˆåº”ï¼Œåœ¨è½¯ä»¶çš„è´¨é‡æ§åˆ¶ä¸Šè¿™ä¸ªæ•ˆåº”éå¸¸æ°å½“,æ‰€ä»¥æœ‰é—®é¢˜å°½å¿«ä¿®è¡¥ã€‚</li></ul><p>é›¶å®¹å¿ï¼Œå¹¶ä¸æ˜¯ä¸è®©å¤æ‚åº¦å¢é•¿ï¼šæˆ‘ä»¬éƒ½çŸ¥é“è¿™æ˜¯ä¸å¯èƒ½çš„ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯å°½åŠ›æ§åˆ¶ã€‚å› ä¸ºè¿›åº¦è€Œä¸´æ—¶æ‰“ç ´çª—æˆ·ä¹Ÿèƒ½æ¥å—ï¼Œä½†æ˜¯è¦å°½å¿«è¡¥ä¸Šã€‚</p><h2 id="åŸºäºå¤æ‚ä¸šåŠ¡å¦‚ä½•åˆ†æï¼Ÿ"><a class="header-anchor" href="#åŸºäºå¤æ‚ä¸šåŠ¡å¦‚ä½•åˆ†æï¼Ÿ"></a>åŸºäºå¤æ‚ä¸šåŠ¡å¦‚ä½•åˆ†æï¼Ÿ</h2><h3 id="ä¸šåŠ¡çš„å·®å¼‚æ€§"><a class="header-anchor" href="#ä¸šåŠ¡çš„å·®å¼‚æ€§"></a>ä¸šåŠ¡çš„å·®å¼‚æ€§</h3><p>if/elseæ˜¯ç”±äºä¸šåŠ¡ä¸Šä¸åŒçš„åœºæ™¯ä¼šæœ‰ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™æ ·çš„å·®å¼‚æ€§å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”¨if/elseå®ç°ï¼Œä½†æ˜¯ä¸ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œåœ¨æ‰©å±•æ—¶ä»£ç ä¼šå †ç Œçš„è¶Šæ¥è¶Šåºå¤§ã€‚</p><p>å¦‚ä½•æ¶ˆé™¤if/elseï¼Ÿ</p><ul><li><p>å¤šæ€æ‰©å±•:åˆ©ç”¨é¢å‘å¯¹è±¡çš„å¤šæ€ç‰¹æ€§ï¼Œå®ç°ä»£ç çš„å¤ç”¨å’Œæ‰©å±•</p></li><li><p>ä»£ç åˆ†ç¦»:å¯¹ä¸åŒçš„åœºæ™¯ç”¨ä¸åŒçš„ä»£ç æµç¨‹æ¥å®ç°ä¸šåŠ¡å’Œä»£ç çš„éš”ç¦»</p></li><li><p>å¤šæ€æ‰©å±•<br>å¤šæ€æ‰©å±•æœ‰ç»§æ‰¿å’Œç»„åˆä¸¤ç§æ–¹å¼ã€‚ç»§æ‰¿çš„è¯ä¸è¦ä½¿ç”¨é‡è½½ç‰¹æ€§ï¼Œé‡è½½ç‰¹æ€§ä¸æ˜¯ç»§æ‰¿çˆ¶ç±»çš„æ–¹æ³•ã€‚ç»„åˆç±»ä¼¼äºç­–ç•¥æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æŠŠéœ€è¦æ‰©å±•çš„éƒ¨åˆ†è¿›è¡ŒæŠ½è±¡ã€å°è£…æˆéœ€è¦è¢«ç»„åˆçš„å¯¹è±¡ã€‚ç”¨å¤šæ€çš„ç‰¹æ€§æ¥ç§»é™¤ä¸šåŠ¡çš„å·®å¼‚æ€§ï¼Œè¿™æ ·ä¹Ÿæ›´ç¬¦åˆå®ä½“ä¹‹é—´çš„å…³ç³»ã€‚</p></li><li><p>ä»£ç åˆ†ç¦»<br>ä»£ç åˆ†ç¦»ï¼Œä»£ç çš„å†—ä½™å’Œå¤ç”¨æ€§ä¸å¥½ï¼Œä½†æ˜¯åŒæ ·ä¼šè¾¾åˆ°ä¸šåŠ¡ä»£ç å½¼æ­¤ç‹¬ç«‹çš„çŠ¶æ€</p></li></ul><h3 id="å¤šç»´åˆ†æ"><a class="header-anchor" href="#å¤šç»´åˆ†æ"></a>å¤šç»´åˆ†æ</h3><p>æ ¹æ®æˆ‘ä»¬çš„åˆ†æåœ¨é¢å¯¹ä¸šåŠ¡çš„å·®å¼‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¤šæ€æ‰©å±•å’Œä»£ç åˆ†ç¦»æ¥å®ç°ï¼Œä½†æ˜¯ä»€ä¹ˆæ—¶å€™æ¥ç”¨å¤šæ€æ‰©å±•ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ä»£ç åˆ†ç¦»æ¥ ?å¯¹äºè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é‡‡ç”¨<B>çŸ©é˜µåˆ†ææ³•</B></p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªçŸ©é˜µï¼Œçºµè½´ä»£è¡¨ä¸šåŠ¡åœºæ™¯ã€æ¨ªè½´ä»£è¡¨æ­¥éª¤ï¼Œé‡Œé¢çš„å†…å®¹ä»£è¡¨æ¯ä¸€ä¸ªåŠ¨ä½œï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°è¿™æ ·çš„ä¸€ä¸ªè¡¨æ ¼</p><table><thead><tr><th>-</th><th>step0</th><th>step1</th><th>step2</th></tr></thead><tbody><tr><td>business0</td><td>1.action0<br>2.action1</td><td>1.action1</td><td>1.action1<br>2.action2</td></tr><tr><td>business1</td><td>åŒä¸Š</td><td>åŒä¸Š</td><td>1.action1</td></tr><tr><td>business2</td><td>æ— </td><td>æ— </td><td>1.action1</td></tr></tbody></table><p>é€šè¿‡è¿™æ ·ä¸€ä¸ªçŸ©é˜µæˆ‘ä»¬å°±å¯ä»¥åˆ†æå‡ºbusiness0å’Œbusiness1é€‚ç”¨äºå¤šæ€æ‰©å±•ï¼Œè€Œbusiness2æ›´åŠ é€‚ç”¨äºä»£ç åˆ†ç¦»æ¥è¿›è¡Œå®ç°ã€‚</p><p>è¿™æ ·çš„çŸ©é˜µåœ¨OOPé‡Œè¢«ç§°ä¸ºåˆ†æçŸ©é˜µï¼Œä¸»è¦æ˜¯ç”¨æ¥åˆ†æä¸šåŠ¡æ¶‰åŠè¦ç´ è¿‡å¤šã€ä¿¡æ¯é‡å¤ªå¤§çš„åœºæ™¯ã€‚</p><h3 id="æµç¨‹åˆ†è§£"><a class="header-anchor" href="#æµç¨‹åˆ†è§£"></a>æµç¨‹åˆ†è§£</h3><p>æµç¨‹åˆ†è§£æ˜¯å¯¹ä¸šåŠ¡è¿‡ç¨‹è¿›è¡Œè¯¦ç»†çš„åˆ†è§£ï¼Œç„¶ååœ¨ä½¿ç”¨<B>ç»“æ„åŒ–</B>çš„æ–¹æ³•èšåˆæˆä¸€ä¸ªä¸ªstepï¼Œåœ¨å°†stepç»„åˆæˆä¸šåŠ¡ï¼Œæœ€åå½¢æˆä¸€ä¸ªç±»ä¼¼äºé‡‘å­—å¡”å½¢çŠ¶è‡ªä¸Šè€Œä¸‹çš„æµç¨‹è®¤çŸ¥ã€‚</p><h3 id="é¢†åŸŸæ¨¡å‹"><a class="header-anchor" href="#é¢†åŸŸæ¨¡å‹"></a>é¢†åŸŸæ¨¡å‹</h3><p>é¢†åŸŸæ¨¡å‹æŒ‡çš„æ˜¯æ¨¡å‹å¯¹è±¡é¿å…ä½¿ç”¨è´«è¡€æ¨¡å¼ï¼Œè€Œåº”è¯¥ä½¿ç”¨å……è¡€æ¨¡å¼ï¼Œè®©æ¨¡å‹å…·æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œåœ¨å¤ç”¨æ¨¡å‹çš„æ—¶å€™å°±èƒ½å¤ç”¨ä¸šåŠ¡é€»è¾‘ã€‚å……è¡€çš„æ¨¡å‹ä¹Ÿæ›´ç¬¦åˆç°å®æ¨¡å‹ä¸­å¯¹è±¡çš„å®šä¹‰ã€‚</p><h2 id="åˆ†æçŸ©é˜µ"><a class="header-anchor" href="#åˆ†æçŸ©é˜µ"></a>åˆ†æçŸ©é˜µ</h2><h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰"></a>å®šä¹‰</h3><p>åˆ†æçŸ©é˜µçš„å®šä¹‰æ¥æºäºã€Šè®¾è®¡æ¨¡å¼è§£æã€‹ç¬¬16ç« ,ä½œè€…é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•æ­¥éª¤å®Œæˆå¯¹ç³»ç»Ÿä¸­å˜åŒ–çš„åˆ†æï¼Œä»è€Œè®¾è®¡å‡ºåˆé€‚çš„æ¨¡å¼</p><blockquote><p>1.æ‰¾åˆ°æŸç§ç‰¹å®šæƒ…å†µä¸‹æœ€é‡è¦çš„ç‰¹æ€§ï¼Œå¹¶ç”¨çŸ©é˜µå°†ä»–ä»¬å…³è”èµ·æ¥<br>2.ç»§ç»­å¤„ç†å…¶ä»–æƒ…å†µï¼Œå¹¶ä¸”æŒ‰éœ€æ‰©å±•çŸ©é˜µ<br>3.ç”¨æ–°çš„æ¦‚å¿µæ‰©å±•åˆ†æçŸ©é˜µ<br>4.åœ¨è¡Œç»´åº¦å‘ç°è§„åˆ™<br>5.åœ¨åˆ—ç»´åº¦å‘ç°ç‰¹å®šæƒ…å†µ<br>6.ä»åˆ†æä¸­ç¡®å®šæ¨¡å¼<br>7.å¾—åˆ°é«˜å±‚è®¾è®¡</p></blockquote><h3 id="æ¡ˆä¾‹"><a class="header-anchor" href="#æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>æœ€å¼€å§‹éœ€æ±‚å¾ˆç®€å•ï¼šåªå¤„ç†ç¾å›½å’ŒåŠ æ‹¿å¤§çš„è®¢å•ã€‚ç³»ç»Ÿå¿…é¡»è¿›è¡Œå¤„ç†çš„ç‰¹æ€§æ¸…å•å¦‚ä¸‹ï¼š</p><ul><li>ä¸ºç¾å›½å’ŒåŠ æ‹¿å¤§æ„å»ºä¸€ä¸ªé”€å”®è®¢å•ç³»ç»Ÿ</li><li>æ ¹æ®æ‰€åœ¨å›½å®¶è®¡ç®—è¿è´¹</li><li>è¿è´¹è¿˜åº”è¯¥ä»¥æ‰€åœ¨å›½å®¶çš„è´§å¸è¿›è¡Œæ”¯ä»˜</li><li>åœ¨ç¾å›½ï¼Œç¨é¢éœ€æŒ‰å½“åœ°è®¡ç®—</li><li>ä½¿ç”¨ç¾å›½é‚®æ”¿è§„åˆ™éªŒè¯åœ°å€</li><li>åœ¨åŠ æ‹¿å¤§ä½¿ç”¨è”é‚¦å¿«é€’å‘è´§æ—¶ï¼Œéœ€è¦åŒæ—¶ç¼´çº³è”é‚¦æ”¿åºœé”€å”®ç¨å’Œåœ°æ–¹é”€å”®ç¨</li><li>åŠ æ‹¿å¤§é‚®å¯„åŒ…è£¹æœ‰è¿ç¦å“é‚®å¯„é™åˆ¶</li><li>ç¾å›½çš„è®¢å•å·ç»§æ‰¿äºåŠ æ‹¿å¤§è®¢å•å·è§„åˆ™ï¼Œåˆæœ‰æ‰€æ”¹å˜</li></ul><p>ä»ä½¿ç”¨åœºæ™¯æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œéœ€æ±‚åˆ†ä¸ºä¸¤ç§ï¼šç¾å›½ã€åŠ æ‹¿å¤§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€æ±‚åœºæ™¯åˆ†æå¾—å‡ºè¿™æ ·çš„çŸ©é˜µ</p><table><thead><tr><th>æƒ…å†µ</th><th>è¿‡ç¨‹</th></tr></thead><tbody><tr><td>ç¾å›½</td><td>1.ä½¿ç”¨ç¾å…ƒè®¡è´¹<br>2.ä½¿ç”¨ç¾å›½é‚®æ”¿è§„åˆ™æ ¡éªŒåœ°å€<br>3.æŒ‰ç…§å½“åœ°è®¡ç®—ç¨é¢<br>4.ç¾åˆ¶åŠ æ‹¿å¤§è§„åˆ™è®¢å•å·è§„åˆ™</td></tr><tr><td>åŠ æ‹¿å¤§</td><td>1.ä½¿ç”¨ç¾å…ƒè®¡è´¹<br>2.ä½¿ç”¨ç¾å›½é‚®æ”¿è§„åˆ™æ ¡éªŒåœ°å€<br>3.æŒ‰ç…§åŠ æ‹¿å¤§è§„å®šè®¡ç®—é”€å”®ç¨4. è¿ç¦å“é‚®å¯„é™åˆ¶5.åŠ æ‹¿å¤§è§„åˆ™è®¢å•å·è§„åˆ™</td></tr></tbody></table><p>é€šè¿‡è¿™æ ·ä¸€ä¸ªå…·æœ‰è¯¦ç»†åŠŸèƒ½çš„çŸ©é˜µï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æç‚¼å‡ºæŒ‰ç…§æ­¥éª¤è¿›è¡Œåˆ†è§£çš„çŸ©é˜µ</p><table><thead><tr><th>æ­¥éª¤</th><th>ç¾å›½</th><th>åŠ æ‹¿å¤§</th></tr></thead><tbody><tr><td>è´§å¸å•ä½</td><td>ç¾å…ƒ</td><td>åŠ å…ƒ</td></tr><tr><td>æ ¡éªŒè§„åˆ™</td><td>ç¾å›½é‚®æ”¿è§„åˆ™</td><td>åŠ æ‹¿å¤§é‚®æ”¿è§„åˆ™</td></tr><tr><td>è®¡ç®—ç¨é¢</td><td>ç¾å›½ç¨é¢æ”¿ç­–</td><td>åŠ æ‹¿å¤§ç¨é¢æ”¿ç­–</td></tr><tr><td>é‚®å¯„é™åˆ¶</td><td>æœªçŸ¥</td><td>åŠ æ‹¿å¤§é‚®å¯„é™åˆ¶</td></tr><tr><td>è®¢å•å·è§„åˆ™</td><td>ç¾åˆ¶åŠ æ‹¿å¤§è§„åˆ™</td><td>åŠ æ‹¿å¤§è§„åˆ™</td></tr></tbody></table><p>é€šè¿‡è¿™ä¸ªçŸ©é˜µæˆ‘ä»¬å‘ç°ç¾å›½çš„é‚®å¯„é™åˆ¶æœªçŸ¥ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥è¯¢é—®ä¸šåŠ¡ä¸“å®¶å¾—åˆ°ç­”æ¡ˆã€‚é€šè¿‡è¿™æ ·çš„çŸ©é˜µæˆ‘ä»¬è¿˜å¯ä»¥åˆ†æå‡º</p><table><thead><tr><th>æ­¥éª¤</th><th>ç¾å›½</th><th>åŠ æ‹¿å¤§</th></tr></thead><tbody><tr><td>è´§å¸å•ä½</td><td>å¤šæ€æ‰©å±•</td><td>å¤šæ€æ‰©å±•</td></tr><tr><td>æ ¡éªŒè§„åˆ™</td><td>ä»£ç åˆ†ç¦»</td><td>ä»£ç åˆ†ç¦»</td></tr><tr><td>è®¡ç®—ç¨é¢</td><td>ä»£ç åˆ†ç¦»</td><td>ä»£ç åˆ†ç¦»</td></tr><tr><td>é‚®å¯„é™åˆ¶</td><td>ä»£ç åˆ†ç¦»</td><td>ä»£ç åˆ†ç¦»</td></tr><tr><td>è®¢å•å·è§„åˆ™</td><td>å¤šæ€æ‰©å±•</td><td>å¤šæ€æ‰©å±•</td></tr></tbody></table><blockquote><p>å‚è€ƒæ–‡æ¡£</p></blockquote><ul><li><a href="https://developer.aliyun.com/article/770886">è­¦æƒ•è½¯ä»¶å¤æ‚åº¦å›°å±€</a></li><li><a href="https://mp.weixin.qq.com/s/u7geoZNpLtfr_crkXVHjAg">é¢å¯¹å¤æ‚ä¸šåŠ¡ï¼Œif-else coder å¦‚ä½•å‡çº§</a></li><li><a href="https://developer.aliyun.com/article/712581">å¦‚ä½•å†™å¤æ‚ä¸šåŠ¡ä»£ç ï¼Ÿ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¢†åŸŸå»ºæ¨¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dubbo SPIçš„åŠ è½½æœºåˆ¶</title>
      <link href="2020/10/29/8.duboo%E7%AC%94%E8%AE%B0/1.%20Dubbo%20SPI%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"/>
      <url>2020/10/29/8.duboo%E7%AC%94%E8%AE%B0/1.%20Dubbo%20SPI%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1>Dubbo SPIçš„åŠ è½½æœºåˆ¶</h1><p>SPIå…¨ç§°ä¸ºService Provider Interfaceï¼Œæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚SPI çš„æœ¬è´¨æ˜¯å°†æ¥å£å®ç°ç±»çš„å…¨é™å®šåé…ç½®åœ¨æ–‡ä»¶ä¸­ï¼Œå¹¶ç”±æœåŠ¡åŠ è½½å™¨è¯»å–é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å®ç°ç±»ã€‚</p><h2 id="SPIç¤ºä¾‹"><a class="header-anchor" href="#SPIç¤ºä¾‹"></a>SPIç¤ºä¾‹</h2><h3 id="Java-SPIç¤ºä¾‹"><a class="header-anchor" href="#Java-SPIç¤ºä¾‹"></a>Java SPIç¤ºä¾‹</h3><ul><li>Robot</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Robot</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>RobotImpl</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bumblebee</span> <span class="token keyword">implements</span> <span class="token class-name">Robot</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello, I am Bumblebee."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OptimusPrime</span> <span class="token keyword">implements</span> <span class="token class-name">Robot</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello, I am Optimus Prime."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>MATA/service</li></ul><pre class="line-numbers language-none"><code class="language-none">com.agmtopy.testcontainers.completableFuture.impl.Bumblebeecom.agmtopy.testcontainers.completableFuture.impl.OptimusPrime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>JavaSpiTest</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Robot</span><span class="token punctuation">></span></span> robots <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Robot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    robots<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Robot</span><span class="token operator">::</span><span class="token function">sayHello</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Dubbo-SPIç¤ºä¾‹"><a class="header-anchor" href="#Dubbo-SPIç¤ºä¾‹"></a>Dubbo SPIç¤ºä¾‹</h3><ul><li>Robot</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Robot</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>MATA/dubbo</li></ul><pre class="line-numbers language-none"><code class="language-none">optimusPrime &#x3D; com.agmtopy.testcontainers.completableFuture.impl.Bumblebeebumblebee &#x3D; com.agmtopy.testcontainers.completableFuture.impl.OptimusPrime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Šå¦‚ä½•é«˜æ•ˆå­¦ä¹ ã€‹ç¢ç¢å¿µ</title>
      <link href="2020/10/19/1.%E6%9D%82%E8%AE%B0/%E3%80%8A%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E5%AD%A6%E4%B9%A0%E3%80%8B%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
      <url>2020/10/19/1.%E6%9D%82%E8%AE%B0/%E3%80%8A%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E5%AD%A6%E4%B9%A0%E3%80%8B%E7%A2%8E%E7%A2%8E%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h1>ã€Šå¦‚ä½•é«˜æ•ˆå­¦ä¹ ã€‹ç¢ç¢å¿µ</h1><p>å­¦ä¹ çš„æ­¥éª¤æ‹†åˆ†ä¸º</p><ol><li>è·å–çŸ¥è¯†</li><li>ç†è§£çŸ¥è¯†</li><li>æ‰©å±•çŸ¥è¯†</li><li>çº é”™</li><li>åº”ç”¨</li></ol>]]></content>
      
      
      <categories>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¦‚ä½•é«˜æ•ˆå­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡å®ä¾‹ç†è§£CompletableFutureå¹¶å‘æ¡†æ¶</title>
      <link href="2020/10/19/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/15.%E9%80%9A%E8%BF%87%E5%AE%9E%E4%BE%8B%E7%90%86%E8%A7%A3CompletableFuture%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/"/>
      <url>2020/10/19/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/15.%E9%80%9A%E8%BF%87%E5%AE%9E%E4%BE%8B%E7%90%86%E8%A7%A3CompletableFuture%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<h1>é€šè¿‡å®ä¾‹ç†è§£CompletableFutureå¹¶å‘æ¡†æ¶</h1><p><b>CompletableFuture</b>å®ç°<strong>Future</strong>ã€<strong>CompletionStage</strong>;<strong>CompletionStage</strong>çš„å®šä¹‰æ˜¯ä½œä¸ºä¸€ä¸ªç”¨äºå¼‚æ­¥æ‰§è¡Œä¸­çš„å¤„ç†é˜¶æ®µï¼Œé€‚ç”¨äºlambdaè¡¨è¾¾å¼è®¡ç®—è¿‡ç¨‹ä¸­ã€‚<strong>Future</strong>å®šä¹‰æ˜¯ä½œä¸ºå¼‚æ­¥è¿”å›å€¼å®¹å™¨ã€‚ä¸‹é¢é€šè¿‡ä¸€ç³»åˆ—å®åˆ—å…ˆæ¥ç†Ÿæ‚‰CompletableFutureèƒ½å¤Ÿå®Œæˆçš„åŠŸèƒ½ã€‚</p><h2 id="å®ç°åŠŸèƒ½"><a class="header-anchor" href="#å®ç°åŠŸèƒ½"></a>å®ç°åŠŸèƒ½</h2><ol><li>åˆå§‹åŒ–ä¸€ä¸ªå®Œæˆçš„CompletableFuture</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åˆå§‹åŒ–ä¸€ä¸ªå®Œæˆçš„CompletableFuture */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> completableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">"å®Œæˆç»“æœ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ˜¯å¦å®Œæˆ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>completableFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"completableFutureå·²ç»å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//getNow()è¿”å›</span>    <span class="token class-name">String</span> returnMsg <span class="token operator">=</span> completableFuture<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"å®Œæˆç»“æœ"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>returnMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"completableFuture.getNow()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>åˆ›å»ºä¸€ä¸ªç®€å•çš„å¼‚æ­¥stage</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åˆ›å»ºä¸€ä¸ªç®€å•çš„å¼‚æ­¥stage */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹:"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> done <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"future.isDone() = "</span> <span class="token operator">+</span> future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>å¯¹å®Œæˆçš„CompletableFutureç»§ç»­åŒæ­¥è¿›è¡Œå¤„ç†</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * å¯¹å®Œæˆçš„CompletableFutureç»§ç»­åŒæ­¥è¿›è¡Œå¤„ç† */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//thenApplyå¦‚æœæ²¡æœ‰æŒ‡å®šæ‰§è¡Œçº¿ç¨‹æ± é‚£ä¹ˆå°±ä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œ</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> message <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å½“å‰çº¿ç¨‹ä¸º"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> result <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›ç»“æœä¸º"</span> <span class="token operator">+</span> result <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>å¯¹å®Œæˆçš„CompletableFutureç»§ç»­å¼‚æ­¥è¿›è¡Œå¤„ç†(æœ‰è¿”å›ç»“æœ)</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * å¯¹å®Œæˆçš„CompletableFutureç»§ç»­å¼‚æ­¥è¿›è¡Œå¤„ç† */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//thenApplyAsyncé»˜è®¤ä½¿ç”¨ForkJoinPool.commonPool()çº¿ç¨‹æ± </span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> message <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å½“å‰çº¿ç¨‹ä¸º"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> result <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›ç»“æœä¸º"</span> <span class="token operator">+</span> result <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>å¼‚æ­¥æ¶ˆè´¹ç»“æœ(æ— è¿”å›å€¼)</li></ol><ul><li>thenAccept(Consumer&lt;? super T&gt; action)ã€thenAcceptAsync(Consumer&lt;? super T&gt; action,Executor executor)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * å¼‚æ­¥æ¶ˆè´¹ç»“æœ(æ— è¿”å›å€¼) */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>item <span class="token operator">-></span><span class="token punctuation">&#123;</span>       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>è®¡ç®—æ—¶å‡ºç°å¼‚å¸¸</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * å–æ¶ˆ&amp;å¼‚å¸¸å¤„ç† */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>item <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                item<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">int</span> i1 <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//join()ä¸ä¼šæ˜¾ç¤ºæŠ›å‡ºå¼‚å¸¸</span>    future<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//get()æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸</span>    future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//cancel()æ–¹æ³•ä¼šå–æ¶ˆè®¡ç®—</span>    future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="7"><li>BiConsumeråŒæ—¶å¤„ç†ä¸¤ä¸ªstageç»“æœ</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * BiConsumeræ”¯æŒå¯¹ä¸¤ä¸ªStageçš„ç»“æœè¿›è¡Œæ“ä½œ */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completableFutureExample6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> original <span class="token operator">=</span> <span class="token string">"message"</span><span class="token punctuation">;</span>    <span class="token class-name">StringBuilder</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">thenAcceptBoth</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment">//BiConsumer</span>                    <span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token operator">-></span> result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>v1 <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result:"</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å®ç°åŸç†"><a class="header-anchor" href="#å®ç°åŸç†"></a>å®ç°åŸç†</h2><h3 id="Futureæ¥å£ä»‹ç»"><a class="header-anchor" href="#Futureæ¥å£ä»‹ç»"></a>Futureæ¥å£ä»‹ç»</h3><blockquote><p>JDK5æ–°å¢äº†Futureæ¥å£ï¼Œç”¨äºæè¿°ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚ä½†æ˜¯å¯¹äºç»“æœçš„è·å–å´æ˜¯å¾ˆä¸æ–¹ä¾¿ï¼Œåªèƒ½é€šè¿‡é˜»å¡æˆ–è€…è½®è¯¢çš„æ–¹å¼å¾—åˆ°ä»»åŠ¡çš„ç»“æœã€‚</p></blockquote><h3 id="CompletableFutureç±»ä»‹ç»"><a class="header-anchor" href="#CompletableFutureç±»ä»‹ç»"></a>CompletableFutureç±»ä»‹ç»</h3><blockquote><p>CompletableFutureæä¾›äº†éå¸¸å¼ºå¤§çš„ Future çš„æ‰©å±•åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹çš„å¤æ‚æ€§ï¼Œå¹¶ä¸”æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹çš„èƒ½åŠ›ï¼Œå¯ä»¥é€šè¿‡å›è°ƒçš„æ–¹å¼å¤„ç†è®¡ç®—ç»“æœï¼Œä¹Ÿæä¾›äº†è½¬æ¢å’Œç»„åˆ CompletableFuture çš„æ–¹æ³•ã€‚</p></blockquote><blockquote><p>å¯¹äºé˜»å¡æˆ–è€…è½®è¯¢æ–¹å¼ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡ CompletableFuture ç±»çš„ CompletionStageå’ŒFutureæ¥å£æ–¹å¼æ”¯æŒã€‚CompletableFuture ç±»å£°æ˜äº† CompletionStage æ¥å£ï¼ŒCompletionStage æ¥å£å®é™…ä¸Šæä¾›äº†åŒæ­¥æˆ–å¼‚æ­¥è¿è¡Œè®¡ç®—çš„èˆå°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°å¤šä¸ª CompletionStage å‘½ä»¤ï¼Œå¹¶ä¸”å°†è¿™äº›å‘½ä»¤ä¸²è”åœ¨ä¸€èµ·çš„æ–¹å¼å®ç°å¤šä¸ªå‘½ä»¤ä¹‹é—´çš„è§¦å‘ã€‚</p></blockquote><h2 id="æ‰©å±•çŸ¥è¯†"><a class="header-anchor" href="#æ‰©å±•çŸ¥è¯†"></a>æ‰©å±•çŸ¥è¯†</h2><h2 id="å‚è€ƒæ–‡æ¡£"><a class="header-anchor" href="#å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p><a href="https://developer.ibm.com/zh/articles/j-cf-of-jdk8/">é€šè¿‡å®ä¾‹ç†è§£ JDK8 çš„ CompletableFuture</a></p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CompletableFuture </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mockitoä½¿ç”¨å°ç»“</title>
      <link href="2020/10/13/1.%E6%9D%82%E8%AE%B0/mockito%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%BB%93/"/>
      <url>2020/10/13/1.%E6%9D%82%E8%AE%B0/mockito%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1>mockitoä½¿ç”¨å°ç»“</h1><p>mockæ¡†æ¶æ˜¯æµ‹è¯•ä¸­å¿…ä¸å¯å°‘çš„ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ¨¡æ‹Ÿä¸€äº›åœ¨åº”ç”¨ä¸­ä¸å®¹æ˜“æ„é€ æˆ–è€…æ¯”è¾ƒå¤æ‚çš„å¯¹è±¡ï¼Œä»è€ŒæŠŠæµ‹è¯•ä¸æµ‹è¯•è¾¹ç•Œä»¥å¤–çš„å¯¹è±¡éš”ç¦»å¼€ã€‚ç›®å‰å¸‚é¢ä¸Šæµè¡Œçš„mockæ¡†æ¶ä¸»è¦æœ‰Mockitoã€JMockã€EasyMockã€JMockã€‚è¿™å‡ ç§æ¡†æ¶çš„å¯¹æ¯”å¦‚ä¸‹</p><h2 id="Mockitoä½¿ç”¨ç¤ºä¾‹"><a class="header-anchor" href="#Mockitoä½¿ç”¨ç¤ºä¾‹"></a>Mockitoä½¿ç”¨ç¤ºä¾‹</h2><ul><li>æ¨¡æ‹Ÿå¯¹è±¡</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">mockMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ¨¡æ‹Ÿä¸€ä¸ªMockTestInterfaceçš„å®ä¾‹</span>    <span class="token class-name">MockTestInterface</span> mock <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">MockTestInterface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æœªæŒ‡å®šæ–¹æ³•è¿”å›å€¼å› æ­¤æ‰“å°null</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¨¡æ‹Ÿæ–¹æ³•çš„è¿”å›å€¼</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">mockMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ¨¡æ‹Ÿä¸€ä¸ªMockTestInterfaceçš„å®ä¾‹</span>    <span class="token class-name">MockTestInterface</span> mock <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">MockTestInterface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//1.mockæ–¹å¼ä¸ä¼šæ‰§è¡ŒæŒ‡å®šæ–¹æ³•</span>    <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">doReturn</span><span class="token punctuation">(</span><span class="token string">"mock method"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"mock method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2.stubæ–¹å¼ä¼šæ‰§è¡ŒæŒ‡å®šæ–¹æ³•</span>    <span class="token class-name">MockTestInterface</span> mock1 <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span><span class="token class-name">MockTestInterface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>mock1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token string">"mock method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>mock1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"mock method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¨¡æ‹Ÿæ–¹æ³•æŠ›å‡ºå¼‚å¸¸</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">mockMethod3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ¨¡æ‹Ÿä¸€ä¸ªMockTestInterfaceçš„å®ä¾‹</span>    <span class="token class-name">MockTestInterface</span> mock <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">MockTestInterface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">doThrow</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"mock NPE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertThrows</span><span class="token punctuation">(</span><span class="token class-name">NullPointerException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> mock<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"mock NPE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ps:Mockä¸Stubçš„åŒºåˆ«<br>Mockä¸»è¦æ˜¯å¯¹ä¸å¯ä¿¡èµ–çš„ä»£ç è¿›è¡Œ&quot;æ¨¡æ‹Ÿè¡Œä¸º&quot;ï¼ŒStubä¸»è¦æ˜¯å°†ä¸å¯ä¿¡èµ–çš„ä»£ç ç‰‡æ®µç”¨&quot;ç®€åŒ–&quot;çš„ä»£ç ç‰‡æ®µè¿›è¡Œæ›¿ä»£</p><p><a href="https://segmentfault.com/a/1190000010385247">https://segmentfault.com/a/1190000010385247</a></p>]]></content>
      
      
      <categories>
          
          <category> mockito </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mockito </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡æ„--æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ç¬”è®°</title>
      <link href="2020/09/22/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%87%8D%E6%9E%84-%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%AC%94%E8%AE%B0/"/>
      <url>2020/09/22/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%87%8D%E6%9E%84-%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1>é‡æ„â€“æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ç¬”è®°</h1><ul><li><p>é‡æ„æ˜¯åœ¨ä¸æ”¹å˜è½¯ä»¶å¯è§‚å¯Ÿçš„è¡Œä¸ºçš„å‰æä¸‹æ”¹å–„å…¶å†…éƒ¨ç»“æ„</p></li><li><p>åšæŒæŒç»­ä¸æ–­çš„é‡æ„è¡Œä¸ºæ¥æ•´ç†ä»£ç </p></li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
            <tag> é‡æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DockeråŸºç¡€æ¦‚å¿µå…¥é—¨(ä¸€)</title>
      <link href="2020/09/15/1.%E6%9D%82%E8%AE%B0/Docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8(%E4%B8%80)/"/>
      <url>2020/09/15/1.%E6%9D%82%E8%AE%B0/Docker%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8(%E4%B8%80)/</url>
      
        <content type="html"><![CDATA[<h2 id="Dockerå®æˆ˜"><a class="header-anchor" href="#Dockerå®æˆ˜"></a>Dockerå®æˆ˜</h2><h3 id="åŸºç¡€å‘½ä»¤"><a class="header-anchor" href="#åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h3><ul><li>å®¹å™¨ä½¿ç”¨</li></ul><table><thead><tr><th>åŠŸèƒ½</th><th>å‘½ä»¤</th><th>å‚æ•°</th></tr></thead><tbody><tr><td>è·å–é•œåƒ</td><td>docker pull imageName</td><td></td></tr><tr><td>å¯åŠ¨é•œåƒ(create&amp;start)</td><td>docker run imageName</td><td>-i:äº¤äº’å¼ -t:ç»ˆç«¯ -d:åå°è¿è¡Œ -p portId:portId:æŒ‡å®šç«¯å£</td></tr><tr><td>æŸ¥çœ‹æ‰€æœ‰é•œåƒ</td><td>docker ps -a</td><td></td></tr><tr><td>å¯åŠ¨å·²å­˜åœ¨çš„é•œåƒ</td><td>docker start imageId/imageName</td><td></td></tr><tr><td>åœæ­¢å®¹å™¨</td><td>docker stop imageId</td><td></td></tr><tr><td>é‡å¯å®¹å™¨</td><td>docker restart imageId</td><td></td></tr><tr><td>è¿›å…¥å®¹å™¨</td><td>docker attach</td><td>exec imageId</td></tr><tr><td>åˆ é™¤å®¹å™¨</td><td>docker rm -f imageId</td><td></td></tr><tr><td>åˆ é™¤ä¸åœ¨ä½¿ç”¨çš„é•œåƒ</td><td>docker image prune</td><td>-a:å…¨éƒ¨</td></tr></tbody></table><h4 id="Dockerfileä¹¦å†™åŸåˆ™"><a class="header-anchor" href="#Dockerfileä¹¦å†™åŸåˆ™"></a>Dockerfileä¹¦å†™åŸåˆ™</h4><blockquote><p>Dockerfileæ˜¯æ„å»ºdockeré•œåƒçš„ä¸€ç§æ–¹å¼ï¼Œæ¨èä½œä¸ºç”Ÿäº§ç¯å¢ƒæ„å»ºé•œåƒçš„æ–¹å¼ã€‚</p></blockquote><ol><li>å•ä¸€åŸåˆ™<br>å®¹å™¨çš„æœ¬è´¨æ˜¯è¿›ç¨‹ï¼Œä¸€ä¸ªå®¹å™¨ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹ã€‚å› æ­¤ä¸åŒåŠŸèƒ½çš„åº”ç”¨åº”è¯¥æ‹†åˆ†ä¸ºä¸åŒçš„å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨è´Ÿè´£å•ä¸€çš„ä¸šåŠ¡è¿›ç¨‹ã€‚</li><li>æä¾›æ³¨é‡Šä¿¡æ¯</li><li>ä¿æŒå®¹å™¨æœ€å°åŒ–</li><li>åˆç†é€‰æ‹©åŸºç¡€é•œåƒ<br>å®¹å™¨çš„æ ¸å¿ƒæ˜¯åº”ç”¨ï¼Œå› æ­¤åªè¦åŸºç¡€é•œåƒèƒ½å¤Ÿæ»¡è¶³åº”ç”¨çš„è¿è¡Œç¯å¢ƒå³å¯ã€‚</li><li>ä½¿ç”¨.dockerignoreæ–‡ä»¶<br>.dockerignoreæ–‡ä»¶å…è®¸æˆ‘ä»¬åœ¨æ„å»ºæ—¶å¿½ç•¥ä¸€äº›ä¸éœ€è¦å‚ä¸æ„å»ºçš„æ–‡ä»¶ï¼Œä»è€Œæé«˜æ„å»ºæ•ˆç‡ã€‚</li><li>å°½é‡ä½¿ç”¨æ„å»ºç¼“å­˜</li></ol><ul><li>æ¯ä¸€æ¡DockerfileæŒ‡ä»¤éƒ½ä¼šæäº¤ä¸€ä¸ªé•œåƒå±‚ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯åŸºäºä¸Šä¸€æ¡æŒ‡ä»¤è¿›è¡Œæ„å»ºã€‚å¦‚æœæ„å»ºæ—¶å‘ç°æ„å»ºçš„é•œåƒå±‚çš„çˆ¶é•œåƒå±‚å·²ç»å­˜åœ¨ï¼Œä¸”ä¸‹ä¸€æ¡æŒ‡ä»¤ä½¿ç”¨äº†ç›¸åŒçš„æŒ‡ä»¤å³å‘½ä¸­ç¼“å­˜ã€‚</li></ul><ol start="7"><li><p>æ­£ç¡®è®¾ç½®æ—¶åŒº<br>ä»Docker Hubæ‹‰å–çš„å®˜æ–¹æ“ä½œç³»ç»Ÿé•œåƒå¤§å¤šæ•°éƒ½æ˜¯UTCæ—¶é—´ï¼Œå¦‚æœåœ¨å®¹å™¨ä¸­éœ€è¦ä½¿ç”¨ä¸œå…«åŒºæ—¶é—´ï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹</p></li><li><p>ä½¿ç”¨å›½å†…è½¯ä»¶æºåŠ å¿«é•œåƒæ„å»ºé€Ÿåº¦</p></li><li><p>æœ€å°åŒ–é•œåƒå±‚æ•°</p></li></ol><h4 id="Dockerfileç¼–å†™å»ºè®®"><a class="header-anchor" href="#Dockerfileç¼–å†™å»ºè®®"></a>Dockerfileç¼–å†™å»ºè®®</h4><ol><li><p>RUNæŒ‡ä»¤åœ¨æ„å»ºæ—¶å°†ä¼šç”Ÿæˆä¸€ä¸ªé•œåƒå±‚å¹¶ä¸”æ‰§è¡ŒRUNæŒ‡ä»¤åé¢çš„å†…å®¹</p></li><li><p>CMDå’ŒENTRYPOINTéƒ½æ˜¯å®¹å™¨è¿è¡Œçš„å‘½ä»¤å…¥å£ï¼›åŒºåˆ«åœ¨äºENTRYPOINTæŒ‡ä»¤å¯åŠ¨å®¹å™¨æ—¶ï¼Œéœ€è¦ç”¨â€“entrypointå‚æ•°æ‰èƒ½è¦†ç›–Dockerfileä¸­çš„ENTRYPONTæŒ‡ä»¤ï¼›CMDè®¾ç½®çš„å‘½ä»¤åˆ™å¯ä»¥è¢«docker runåé¢çš„å‚æ•°ç›´æ¥è¦†ç›–<br>3.CMD/ENTRYPOINTçš„ä½¿ç”¨æœ‰ä¸¤ç§æ ¼å¼ï¼›1.jsonæ•°ç»„æ ¼å¼çš„execæ¨¡å¼ 2.command paramæ ¼å¼çš„shellæ¨¡å¼ã€‚è¿™ä¸¤ç§æ ¼å¼çš„åŒºåˆ«åœ¨äºå¯åŠ¨å®¹å™¨å1å·è¿›ç¨‹çš„åŒºåˆ«ã€‚execæ¨¡å¼å¯åŠ¨çš„è¿›ç¨‹å³ä¸ºå®¹å™¨çš„1å·è¿›ç¨‹ï¼Œè€Œshellæ¨¡å¼å¯åŠ¨çš„è¿›ç¨‹ä¸æ˜¯å®¹å™¨çš„1å·è¿›ç¨‹ã€‚</p></li><li><p>addå’Œcopyçš„åŒºåˆ«ã€‚addæ˜¯å°†å¤–éƒ¨èµ„æºåŠ è½½åˆ°å®¹å™¨ä¸­è¿™æ ·ä¼šæ‰©å¤§å®¹å™¨ä½“ç§¯ï¼Œcopyæ˜¯å°†æœ¬åœ°æ–‡ä»¶å‘å®¹å™¨ä¸­æ‹·è´ï¼Œå¯ä»¥æ›´å¥½çš„åˆ©ç”¨æ„å»ºç¼“å­˜ï¼Œæœ‰æ•ˆå‡å°é•œåƒä½“ç§¯ã€‚</p></li></ol><ul><li>åé¢ä¾‹å­</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ADD http://pyropus.ca/software/memtester/old-versions/memtester-4.3.0.tar.gz /tmp/RUN <span class="token function">tar</span> -xvf /tmp/memtester-4.3.0.tar.gz -C /tmpRUN <span class="token function">make</span> -C /tmp/memtester-4.3.0 <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /tmp/memtester-4.3.0 <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>æ›¿ä»£ä¾‹å­</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RUN <span class="token function">wget</span> -O /tmp/memtester-4.3.0.tar.gz http://pyropus.ca/software/memtester/old-versions/memtester-4.3.0.tar.gz <span class="token punctuation">\</span><span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xvf /tmp/memtester-4.3.0.tar.gz -C /tmp <span class="token punctuation">\</span><span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /tmp/memtester-4.3.0 <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /tmp/memtester-4.3.0 <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="åŸºç¡€æ¦‚å¿µ"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h3><h4 id="Namespace"><a class="header-anchor" href="#Namespace"></a>Namespace</h4><blockquote><p>Dockeræ˜¯ä½¿ç”¨Linuxçš„NamespaceæŠ€æœ¯å®ç°å„ç§èµ„æºéš”ç¦»ï¼›Namespaceæ˜¯Linuxå†…æ ¸çš„ä¸€é¡¹åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å¯¹å†…æ ¸èµ„æºè¿›è¡Œåˆ†åŒºï¼Œä½¿ä¸€ç»„è¿›ç¨‹åªèƒ½çœ‹åˆ°ä¸€ç»„èµ„æºï¼Œè€Œå¦ä¸€ç»„è¿›ç¨‹çœ‹åˆ°å¦å¤–ä¸€ç»„èµ„æºã€‚</p></blockquote><ul><li>Linuxæä¾›çš„Namespaceç±»å‹</li></ul><table><thead><tr><th>Namespaceåç§°</th><th>ä½œç”¨</th><th>å†…æ ¸ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>Mount(mnt)</td><td>éš”ç¦»æŒ‚è½½ç‚¹</td><td>2.4.19</td></tr><tr><td>Process ID(pid)</td><td>éš”ç¦»è¿›ç¨‹ID</td><td>2.6.24</td></tr><tr><td>Network(net)</td><td>éš”ç¦»ç½‘ç»œè®¾å¤‡ï¼Œç«¯å£å·ç­‰</td><td>2.6.29</td></tr><tr><td>Interprocess Communication (ipc)</td><td>éš”ç¦» System V IPC å’Œ POSIX message queues</td><td>2.6.19</td></tr><tr><td>UTS Namespace(uts)</td><td>éš”ç¦»ä¸»æœºåå’ŒåŸŸå</td><td>2.6.19</td></tr><tr><td>User Namespace (user)</td><td>éš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„</td><td>3.8</td></tr><tr><td>Control group (cgroup) Namespace</td><td>éš”ç¦» Cgroups æ ¹ç›®å½•</td><td>4.6</td></tr><tr><td>Time Namespace</td><td>éš”ç¦»ç³»ç»Ÿæ—¶é—´</td><td>5.6</td></tr></tbody></table><ul><li>NamespaceåŠŸèƒ½</li></ul><ol><li>Mount Namespace</li></ol><blockquote><p>Mount Namespaceæ˜¯Linuxå†…æ ¸å®ç°çš„ç¬¬ä¸€ä¸ªNamespace,å¯ä»¥ç”¨æ¥éš”ç¦»ä¸åŒçš„è¿›ç¨‹æˆ–è¿›ç¨‹ç»„çœ‹åˆ°çš„æŒ‚è½½ç‚¹ã€‚é€šä¿—åœ°è¯´ï¼Œå°±æ˜¯å¯ä»¥å®ç°åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­çœ‹åˆ°ä¸åŒçš„æŒ‚è½½ç›®å½•ã€‚</p></blockquote><ol start="2"><li>PID Namespace</li></ol><blockquote><p>PID Namespaceçš„ä½œç”¨æ˜¯ç”¨æ¥éš”ç¦»è¿›ç¨‹ã€‚åœ¨ä¸åŒçš„ PID Namespace ä¸­ï¼Œè¿›ç¨‹å¯ä»¥æ‹¥æœ‰ç›¸åŒçš„ PID å·ï¼Œåˆ©ç”¨ PID Namespace å¯ä»¥å®ç°æ¯ä¸ªå®¹å™¨çš„ä¸»è¿›ç¨‹ä¸º 1 å·è¿›ç¨‹ï¼Œè€Œå®¹å™¨å†…çš„è¿›ç¨‹åœ¨ä¸»æœºä¸Šå´æ‹¥æœ‰ä¸åŒçš„PIDã€‚</p></blockquote><ol start="3"><li>UTS Namespace</li></ol><blockquote><p>UTS Namespace ä¸»è¦æ˜¯ç”¨æ¥éš”ç¦»ä¸»æœºåçš„ï¼Œå®ƒå…è®¸æ¯ä¸ª UTS Namespace æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ä¸»æœºåã€‚</p></blockquote><ol start="4"><li>IPC Namespace</li></ol><blockquote><p>IPC Namespace ä¸»è¦æ˜¯ç”¨æ¥éš”ç¦»è¿›ç¨‹é—´é€šä¿¡çš„ã€‚ä¾‹å¦‚ PID Namespace å’Œ IPC Namespace ä¸€èµ·ä½¿ç”¨å¯ä»¥å®ç°åŒä¸€ IPC Namespace å†…çš„è¿›ç¨‹å½¼æ­¤å¯ä»¥é€šä¿¡ï¼Œä¸åŒ IPC Namespace çš„è¿›ç¨‹å´ä¸èƒ½é€šä¿¡ã€‚</p></blockquote><ol start="5"><li>User Namespace</li></ol><blockquote><p>User Namespace ä¸»è¦æ˜¯ç”¨æ¥éš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„ã€‚ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯åœ¨ä¸»æœºä¸Šä»¥é root ç”¨æˆ·è¿è¡Œçš„è¿›ç¨‹å¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„ User Namespace ä¸­æ˜ å°„æˆ root ç”¨æˆ·ã€‚ä½¿ç”¨ User Namespace å¯ä»¥å®ç°è¿›ç¨‹åœ¨å®¹å™¨å†…æ‹¥æœ‰ root æƒé™ï¼Œè€Œåœ¨ä¸»æœºä¸Šå´åªæ˜¯æ™®é€šç”¨æˆ·ã€‚</p></blockquote><ol start="6"><li>Net Namespace</li></ol><blockquote><p>Net Namespaceæ˜¯ç”¨æ¥éš”ç¦»ç½‘ç»œè®¾å¤‡ã€IPåœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯çš„</p></blockquote><ul><li>å°ç»“</li></ul><blockquote><p>å½“Dockeræ–°å»ºä¸€ä¸ªå®¹å™¨æ—¶,ä¼šåˆ›å»ºè¿™6ç§Namespaceï¼Œæ¥è¿›è¡Œèµ„æºéš”ç¦»ã€‚Namespaceæ˜¯Linuxå†…æ ¸æä¾›çš„ç‰¹æ€§ï¼Œè¯¥ç‰¹æ€§å¯ä»¥å®ç°åœ¨åŒä¸€ä¸ªä¸»æœºä¸Šå¯¹__è¿›ç¨‹ID__ã€<strong>ä¸»æœºå</strong>ã€ç”¨æˆ·IDã€<strong>æ–‡ä»¶å</strong>ã€<strong>ç½‘ç»œå’Œè¿›ç¨‹é—´é€šä¿¡ç­‰èµ„æºçš„éš”ç¦»</strong></p></blockquote><h4 id="cgrops"><a class="header-anchor" href="#cgrops"></a>cgrops</h4><blockquote><p>cgropsæ˜¯linuxå†…æ ¸æä¾›é™åˆ¶è¿›ç¨‹æˆ–è¿›ç¨‹ç»„ä½¿ç”¨èµ„æº(å¦‚CPUã€å†…å­˜ã€ç£ç›˜IO)çš„åŠŸèƒ½</p></blockquote><ul><li>cgropsåŠŸèƒ½</li></ul><ol><li>èµ„æºé™åˆ¶</li></ol><blockquote><p>é™åˆ¶èµ„æºçš„ä½¿ç”¨é‡ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é™åˆ¶æŸä¸ªä¸šåŠ¡çš„å†…å­˜ä¸Šé™ï¼Œä»è€Œä¿æŠ¤ä¸»æœºå…¶ä»–ä¸šåŠ¡çš„å®‰å…¨è¿è¡Œã€‚</p></blockquote><ol start="2"><li>ä¼˜å…ˆçº§æ§åˆ¶</li></ol><blockquote><p>ä¸åŒçš„ç»„å¯ä»¥æœ‰ä¸åŒçš„èµ„æºï¼ˆ CPU ã€ç£ç›˜ IO ç­‰ï¼‰ä½¿ç”¨ä¼˜å…ˆçº§</p></blockquote><ol start="3"><li>å®¡è®¡</li></ol><blockquote><p>è®¡ç®—æ§åˆ¶ç»„çš„èµ„æºä½¿ç”¨æƒ…å†µ</p></blockquote><ol start="4"><li>æ§åˆ¶</li></ol><blockquote><p>æ§åˆ¶è¿›ç¨‹çš„æŒ‚èµ·æˆ–æ¢å¤</p></blockquote><blockquote><p>Docker åˆ›å»ºå®¹å™¨æ—¶ï¼ŒDocker ä¼šæ ¹æ®å¯åŠ¨å®¹å™¨çš„å‚æ•°ï¼Œåœ¨å¯¹åº”çš„ cgroups å­ç³»ç»Ÿä¸‹åˆ›å»ºä»¥__å®¹å™¨ID__ä¸ºåç§°çš„ç›®å½•, ç„¶åæ ¹æ®å®¹å™¨å¯åŠ¨æ—¶è®¾ç½®çš„èµ„æºé™åˆ¶å‚æ•°, ä¿®æ”¹å¯¹åº”çš„ cgroups å­ç³»ç»Ÿèµ„æºé™åˆ¶æ–‡ä»¶, ä»è€Œè¾¾åˆ°èµ„æºé™åˆ¶çš„æ•ˆæœã€‚</p></blockquote><h4 id="Dockerç»„ä»¶çš„æ„æˆ"><a class="header-anchor" href="#Dockerç»„ä»¶çš„æ„æˆ"></a>Dockerç»„ä»¶çš„æ„æˆ</h4><p>Dockeræ•´ä½“æ¶æ„é‡‡ç”¨C/Sæ¶æ„ï¼Œä¸»è¦ç”±å®¢æˆ·ç«¯/æœåŠ¡ç«¯ä¸¤å¤§éƒ¨åˆ†ç»„æˆã€‚å®¢æˆ·ç«¯è´Ÿè´£å‘é€æŒ‡ä»¤ï¼ŒæœåŠ¡ç«¯è´Ÿè´£æ‰§è¡ŒæŒ‡ä»¤ã€‚</p><ul><li>Dockerç»„ä»¶</li></ul><ol><li>docker</li></ol><blockquote><p>dockeræ˜¯Dockerå®¢æˆ·ç«¯çš„ä¸€ä¸ªå®Œæ•´å®ç°ï¼Œdocker ç»„ä»¶å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚åï¼ŒæœåŠ¡ç«¯æ ¹æ®è¯·æ±‚æ‰§è¡Œå…·ä½“çš„åŠ¨ä½œå¹¶å°†ç»“æœè¿”å›ç»™ dockerï¼Œdocker è§£ææœåŠ¡ç«¯çš„è¿”å›ç»“æœï¼Œå¹¶å°†ç»“æœé€šè¿‡å‘½ä»¤è¡Œæ ‡å‡†è¾“å‡ºå±•ç¤ºç»™ç”¨æˆ·ã€‚</p></blockquote><ol start="2"><li>dockerd</li></ol><blockquote><p>dockerd æ˜¯ Docker æœåŠ¡ç«¯çš„åå°å¸¸é©»è¿›ç¨‹ï¼Œç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼Œæ‰§è¡Œå…·ä½“çš„å¤„ç†ä»»åŠ¡ï¼Œå¤„ç†å®Œæˆåå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</p></blockquote><ol start="3"><li>docker-init</li></ol><blockquote><p>docker-initæ˜¯ä½œä¸º1å·è¿›ç¨‹ç®¡ç†å®¹å™¨å†…çš„å­è¿›ç¨‹</p></blockquote><ol start="4"><li>docker-proxy</li></ol><blockquote><p>docker-proxyä¸»è¦æ˜¯ç”¨æ¥åšç«¯å£æ˜ å°„ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ docker run å‘½ä»¤å¯åŠ¨å®¹å™¨æ—¶ï¼Œå¦‚æœä½¿ç”¨äº† -p å‚æ•°ï¼Œdocker-proxy ç»„ä»¶å°±ä¼šæŠŠå®¹å™¨å†…ç›¸åº”çš„ç«¯å£æ˜ å°„åˆ°ä¸»æœºä¸Šæ¥ï¼Œåº•å±‚æ˜¯ä¾èµ–äº iptables å®ç°çš„ã€‚</p></blockquote><ol start="5"><li>containerd</li></ol><blockquote><p>containerdè´Ÿè´£å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ã€é•œåƒçš„ç®¡ç†ã€dockerdçš„è¯·æ±‚ã€ç®¡ç†å­˜å‚¨ã€ç½‘ç»œç­‰ç›¸å…³èµ„æºã€‚æ˜¯å®¹å™¨æ ‡å‡†åŒ–åçš„äº§ç‰©</p></blockquote><ol start="6"><li>containerd-shim</li></ol><blockquote><p>ä½œä¸ºcontainerdå’ŒçœŸæ­£çš„å®¹å™¨è¿›ç¨‹çš„ä¸­é—´å±‚</p></blockquote><ol start="7"><li>runc</li></ol><blockquote><p>runc æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ OCI å®¹å™¨è¿è¡Œæ—¶çš„å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ç›´æ¥ç”¨æ¥åˆ›å»ºå’Œè¿è¡Œå®¹å™¨ã€‚</p></blockquote><h3 id="æ•°æ®ç®¡ç†"><a class="header-anchor" href="#æ•°æ®ç®¡ç†"></a>æ•°æ®ç®¡ç†</h3><h3 id="ç½‘ç»œç®¡ç†"><a class="header-anchor" href="#ç½‘ç»œç®¡ç†"></a>ç½‘ç»œç®¡ç†</h3><h3 id="å®¹å™¨ç®¡ç†"><a class="header-anchor" href="#å®¹å™¨ç®¡ç†"></a>å®¹å™¨ç®¡ç†</h3><h3 id="é•œåƒç®¡ç†"><a class="header-anchor" href="#é•œåƒç®¡ç†"></a>é•œåƒç®¡ç†</h3>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ShardingSphereå…¥é—¨ç®€ä»‹</title>
      <link href="2020/09/03/11.orm%E6%A1%86%E6%9E%B6/24.ShardingSpherez%E5%85%A5%E9%97%A8%E7%AE%80%E4%BB%8B/"/>
      <url>2020/09/03/11.orm%E6%A1%86%E6%9E%B6/24.ShardingSpherez%E5%85%A5%E9%97%A8%E7%AE%80%E4%BB%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="ShardingSphereå…¥é—¨ç®€ä»‹"><a class="header-anchor" href="#ShardingSphereå…¥é—¨ç®€ä»‹"></a>ShardingSphereå…¥é—¨ç®€ä»‹</h2><h3 id="æ¦‚è§ˆ"><a class="header-anchor" href="#æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h3><blockquote><p>ShardingSphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarï¼ˆè®¡åˆ’ä¸­ï¼‰è¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚ ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€åˆ†å¸ƒå¼äº‹åŠ¡å’Œæ•°æ®åº“æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p></blockquote><h4 id="åŸºæœ¬æ¦‚å¿µ"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h4><p>æ•°æ®åˆ†ç‰‡æ‹†åˆ†æ–¹å¼</p><ul><li><p>å‚ç›´æ‹†åˆ†<br><b>å‚ç›´æ‹†åˆ†</b>æŒ‡çš„æ˜¯ä¸“åº“ä¸“ç”¨ï¼Œå°†ä¸åŒä¸šåŠ¡çš„è¡¨æ‹†åˆ†åˆ°å¯¹åº”çš„åº“ä¸­ã€‚å¾®æœåŠ¡æ¶æ„ä¸‹å·²åŸºæœ¬å®ç°äº†å‚ç›´æ‹†åˆ†ã€‚</p></li><li><p>æ°´å¹³æ‹†åˆ†<br><b>æ°´å¹³æ‹†åˆ†</b>æŒ‡çš„æ˜¯é€»è¾‘ä¸Šç›¸åŒçš„æ•°æ®é€šè¿‡æ ¹æ®æŸç§è§„åˆ™å°†æ•°æ®åˆ†æ•£å­˜å‚¨åˆ°æŒ‡å®šçš„æ•°æ®èŠ‚ç‚¹ä¸­ã€‚</p></li></ul><p>äº§å“ç»„æˆ</p><ul><li><p><b>Sharding-JDBC</b><br>Sharding-JDBCå®šä½ä¸ºè½»é‡çº§Javaæ¡†æ¶ï¼Œåœ¨Javaçš„JDBCå±‚æä¾›çš„é¢å¤–æœåŠ¡ã€‚ å®ƒä½¿ç”¨å®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“ï¼Œä»¥jaråŒ…å½¢å¼æä¾›æœåŠ¡ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²å’Œä¾èµ–ï¼Œå¯ç†è§£ä¸ºå¢å¼ºç‰ˆçš„JDBCé©±åŠ¨ï¼Œå®Œå…¨å…¼å®¹JDBCå’Œå„ç§ORMæ¡†æ¶ã€‚</p></li><li><p><b>Sharding-Proxy</b><br>Sharding-Proxyå®šä½ä¸ºé€æ˜åŒ–çš„æ•°æ®åº“ä»£ç†ç«¯ï¼Œæä¾›å°è£…äº†æ•°æ®åº“äºŒè¿›åˆ¶åè®®çš„æœåŠ¡ç«¯ç‰ˆæœ¬ï¼Œç”¨äºå®Œæˆå¯¹å¼‚æ„è¯­è¨€çš„æ”¯æŒã€‚</p></li><li><p><b>Sharding-Sidecar</b><br>Sharding-Sidecarå®šä½ä¸ºKubernetesçš„äº‘åŸç”Ÿæ•°æ®åº“ä»£ç†ï¼Œä»¥Sidecarçš„å½¢å¼ä»£ç†æ‰€æœ‰å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œæ˜¯æƒ³ä½œä¸ºDBå±‚é¢çš„æ•°æ®ç½‘æ ¼ã€‚(è§„åˆ’ä¸­)</p></li></ul><h4 id="ä¸“æœ‰åè¯"><a class="header-anchor" href="#ä¸“æœ‰åè¯"></a>ä¸“æœ‰åè¯</h4><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>é€»è¾‘è¡¨</td><td>æ°´å¹³æ‹†åˆ†çš„æ•°æ®åº“ï¼ˆè¡¨ï¼‰çš„ç›¸åŒé€»è¾‘å’Œæ•°æ®ç»“æ„è¡¨çš„æ€»ç§°</td></tr><tr><td>çœŸå®è¡¨</td><td>åœ¨åˆ†ç‰‡çš„æ•°æ®åº“ä¸­çœŸå®å­˜åœ¨çš„ç‰©ç†è¡¨</td></tr><tr><td>æ•°æ®èŠ‚ç‚¹</td><td>æ•°æ®åˆ†ç‰‡çš„æœ€å°å•ä½,ç”±æ•°æ®æºåç§°å’Œæ•°æ®è¡¨ç»„æˆ(shema.tableName)</td></tr><tr><td>ç»‘å®šè¡¨</td><td>ç»‘å®šè¡¨æ˜¯shardingSphereä¸­ç‰¹æœ‰çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åˆ†ç‰‡è§„åˆ™ä¸€è‡´çš„ä¸»è¡¨å’Œå­è¡¨ã€‚å¦‚æœæŒ‡å®šäº’ä¸ºç»‘å®šè¡¨ï¼Œåœ¨è¿›è¡Œè”è¡¨æŸ¥è¯¢æ—¶å°†ä¸ä¼šå‡ºç°ç¬›å¡å°”ç§¯</td></tr><tr><td>å¹¿æ’­è¡¨</td><td>å¹¿æ’­è¡¨ç±»ä¼¼äºmycatä¸­çš„å…¨å±€è¡¨,é€‚ç”¨äºä½œä¸ºå­—å…¸</td></tr><tr><td>ç²¾ç¡®åˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨å•ä¸€é”®ä½œä¸ºåˆ†ç‰‡é”®çš„=ä¸INè¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td></tr><tr><td>èŒƒå›´åˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨å•ä¸€é”®ä½œä¸ºåˆ†ç‰‡é”®çš„BETWEEN ANDã€&gt;ã€&lt;ã€&gt;=ã€&lt;=è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td></tr><tr><td>å¤åˆåˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨å¤šé”®ä½œä¸ºåˆ†ç‰‡é”®è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td></tr><tr><td>Hintåˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨Hintè¡Œåˆ†ç‰‡çš„åœºæ™¯(ä½¿ç”¨å¤–éƒ¨è§„åˆ™è¿›è¡Œåˆ†ç‰‡)</td></tr></tbody></table><h4 id="åŠŸèƒ½åˆ—è¡¨"><a class="header-anchor" href="#åŠŸèƒ½åˆ—è¡¨"></a>åŠŸèƒ½åˆ—è¡¨</h4><ul><li><p><b>æ•°æ®åˆ†ç‰‡</b></p><ol><li>åˆ†åº“ &amp; åˆ†è¡¨</li><li>è¯»å†™åˆ†ç¦»</li><li>åˆ†ç‰‡ç­–ç•¥å®šåˆ¶åŒ–</li><li>æ— ä¸­å¿ƒåŒ–åˆ†å¸ƒå¼ä¸»é”®</li></ol></li><li><p><b>åˆ†å¸ƒå¼äº‹åŠ¡</b></p><ol><li>æ ‡å‡†åŒ–äº‹åŠ¡æ¥å£</li><li>XAå¼ºä¸€è‡´äº‹åŠ¡</li><li>æŸ”æ€§äº‹åŠ¡</li></ol></li><li><p><b>æ•°æ®åº“æ²»ç†</b></p><ol><li>é…ç½®åŠ¨æ€åŒ–</li><li>ç¼–æ’ &amp; æ²»ç†</li><li>æ•°æ®è„±æ•</li><li>å¯è§†åŒ–é“¾è·¯è¿½è¸ª</li></ol></li></ul><h3 id="sharding-jdbc"><a class="header-anchor" href="#sharding-jdbc"></a>sharding-jdbc</h3><h4 id="åŠŸèƒ½åˆ—è¡¨-v2"><a class="header-anchor" href="#åŠŸèƒ½åˆ—è¡¨-v2"></a>åŠŸèƒ½åˆ—è¡¨</h4><pre><code>1. æ•°æ®åˆ†ç‰‡2. è¯»å†™åˆ†ç¦»3. å¼ºåˆ¶è·¯ç”±4. æ•°æ®è„±æ•</code></pre><h4 id="æ•°æ®åˆ†ç‰‡é…ç½®"><a class="header-anchor" href="#æ•°æ®åˆ†ç‰‡é…ç½®"></a>æ•°æ®åˆ†ç‰‡é…ç½®</h4><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">server:  port: 8080  tomcat:    uri-encoding: utf-8spring:  application:    name: shardingsphere-example  jpa:    properties:      hibernate:        enable_lazy_load_no_trans: true  shardingsphere:    datasource:      names: ds0,ds1      ds0:        type: com.zaxxer.hikari.HikariDataSource        driver-class-name: com.mysql.cj.jdbc.Driver        jdbcUrl: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;ds0?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;GMT        username: root        password: 111111      ds1:        type: com.zaxxer.hikari.HikariDataSource        driver-class-name: com.mysql.cj.jdbc.Driver        jdbcUrl: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;ds1?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;GMT        username: root        password: 111111      sharding:        default-database-strategy: # åˆ†åº“è§„åˆ™          inline:            sharding-column: vender_id            algorithm-expression: ds$&#123;vender_id % 2&#125;        tables:          t_user:  #t_userè¡¨            key-generator-column-name: id  #ä¸»é”®            actual-data-nodes: ds$&#123;0..1&#125;.t_user$&#123;0..1&#125;    #çœŸå®æ•°æ®èŠ‚ç‚¹            databaseStrategy: # åˆ†åº“ç­–ç•¥              inline:                sharding-column: vender_id # åˆ†åº“é”®                algorithm-expression: ds$&#123;vender_id % 2&#125;            tableStrategy: #åˆ†è¡¨ç­–ç•¥              inline: #è¡Œè¡¨è¾¾å¼                shardingColumn: vender_id                algorithmExpression: t_user$&#123;vender_id % 2&#125;    sharding: #è¯»å†™åˆ†ç¦»é…ç½®      master-slave-rules:        ms_ds0:          masterDataSourceName: ds0 # ä¸»åº“          slaveDataSourceNames:            - ds0_slave0 #ä»åº“            - ds0_slave1          loadBalanceAlgorithmType: ROUND_ROBIN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="jdbcä¸æ”¯æŒçš„æ“ä½œ"><a class="header-anchor" href="#jdbcä¸æ”¯æŒçš„æ“ä½œ"></a>jdbcä¸æ”¯æŒçš„æ“ä½œ</h4><ol><li>ä¸æ”¯æŒå­˜å‚¨è¿‡ç¨‹ï¼Œå‡½æ•°ï¼Œæ¸¸æ ‡çš„æ“ä½œ</li><li>ä¸æ”¯æŒè”è¡¨åˆ é™¤</li></ol><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> TABLE_XXX1<span class="token punctuation">,</span> TABLE_xxx2 <span class="token keyword">FROM</span> TABLE_XXX1 <span class="token keyword">JOIN</span> TABLE_XXX2<span class="token punctuation">;</span><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> TABLE_XXX1<span class="token punctuation">,</span> TABLE_xxx2 <span class="token keyword">USING</span> TABLE_XXX1 <span class="token keyword">JOIN</span> TABLE_XXX2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>ä¸å»ºè®®ä½¿ç”¨å­æŸ¥è¯¢(4.xç‰ˆæœ¬å¯¹å­æŸ¥è¯¢çš„ä¼˜åŒ–ä¸å¤ªå¥½)</li></ol><h3 id="sharding-proxy"><a class="header-anchor" href="#sharding-proxy"></a>sharding-proxy</h3><h4 id="åŠŸèƒ½åˆ—è¡¨-v3"><a class="header-anchor" href="#åŠŸèƒ½åˆ—è¡¨-v3"></a>åŠŸèƒ½åˆ—è¡¨</h4><pre><code>1. sharding-jdbcæä¾›çš„åŠŸèƒ½2. æƒé™æ§åˆ¶3. DBé«˜å¯ç”¨ç®¡ç†</code></pre><h4 id="æ•°æ®åˆ†ç‰‡é…ç½®-v2"><a class="header-anchor" href="#æ•°æ®åˆ†ç‰‡é…ç½®-v2"></a>æ•°æ®åˆ†ç‰‡é…ç½®</h4><ul><li>server.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">authentication</span><span class="token punctuation">:</span><span class="token key atrule">users</span><span class="token punctuation">:</span><span class="token key atrule">root</span><span class="token punctuation">:</span>     <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span><span class="token key atrule">sharding</span><span class="token punctuation">:</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> sharding     <span class="token key atrule">authorizedSchemas</span><span class="token punctuation">:</span> sharding_db<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>config-sharding.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">schemaName</span><span class="token punctuation">:</span> sharding_db<span class="token key atrule">dataSources</span><span class="token punctuation">:</span><span class="token key atrule">ds0</span><span class="token punctuation">:</span><span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/ds0<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;useSSL=false</span><span class="token key atrule">username</span><span class="token punctuation">:</span> root<span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span><span class="token key atrule">connectionTimeoutMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span><span class="token key atrule">idleTimeoutMilliseconds</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token key atrule">maxLifetimeMilliseconds</span><span class="token punctuation">:</span> <span class="token number">1800000</span><span class="token key atrule">maxPoolSize</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token key atrule">ds1</span><span class="token punctuation">:</span><span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/ds1<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;useSSL=false</span><span class="token key atrule">username</span><span class="token punctuation">:</span> root<span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span><span class="token key atrule">connectionTimeoutMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span><span class="token key atrule">idleTimeoutMilliseconds</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token key atrule">maxLifetimeMilliseconds</span><span class="token punctuation">:</span> <span class="token number">1800000</span><span class="token key atrule">maxPoolSize</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token key atrule">shardingRule</span><span class="token punctuation">:</span><span class="token key atrule">tables</span><span class="token punctuation">:</span><span class="token key atrule">t_order</span><span class="token punctuation">:</span>    <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">&#123;</span>0..1<span class="token punctuation">&#125;</span>.t_user    <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">inline</span><span class="token punctuation">:</span>        <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> vender_id        <span class="token key atrule">algorithmExpression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">&#123;</span>vender_id % 2<span class="token punctuation">&#125;</span>    <span class="token key atrule">keyGenerator</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE    <span class="token key atrule">column</span><span class="token punctuation">:</span> order_id<span class="token key atrule">defaultDatabaseStrategy</span><span class="token punctuation">:</span><span class="token key atrule">inline</span><span class="token punctuation">:</span>    <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id    <span class="token key atrule">algorithmExpression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">&#123;</span>id % 2<span class="token punctuation">&#125;</span><span class="token key atrule">defaultTableStrategy</span><span class="token punctuation">:</span>none<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h4><ol><li>åœ¨éƒ¨ç½²sharding-proxyæ—¶éœ€è¦å°†mysql driveråœ¨libä¸‹</li><li>ä¸å»ºè®®ä½¿ç”¨å­æŸ¥è¯¢(4.xç‰ˆæœ¬å¯¹å­æŸ¥è¯¢çš„ä¼˜åŒ–ä¸å¤ªå¥½)</li><li>é…ç½®æ–‡ä»¶è¯·ä»¥å®˜ç½‘ä¸ºå‡†(5.xç‰ˆæœ¬ä¸4.xç‰ˆæœ¬æ”¹åŠ¨è¾ƒå¤§)</li></ol><h3 id="clientä¸proxyå¯¹æ¯”"><a class="header-anchor" href="#clientä¸proxyå¯¹æ¯”"></a>clientä¸proxyå¯¹æ¯”</h3><h4 id="åŠŸèƒ½å¯¹æ¯”"><a class="header-anchor" href="#åŠŸèƒ½å¯¹æ¯”"></a>åŠŸèƒ½å¯¹æ¯”</h4><table><thead><tr><th>/</th><th>Sharding-JDBC</th><th>Sharding-Proxy</th></tr></thead><tbody><tr><td>æ•°æ®åº“è¿æ¥</td><td>ä»»æ„</td><td>MySql</td></tr><tr><td>è¿æ¥æ¶ˆè€—æ•°</td><td>é«˜</td><td>ä½</td></tr><tr><td>å¼‚æ„è¯­è¨€</td><td>ä»…java</td><td>ä»»æ„</td></tr><tr><td>æ€§èƒ½</td><td>æŸè€—ä½</td><td>æŸè€—ç•¥é«˜</td></tr><tr><td>æ— ä¸­å¿ƒåŒ–</td><td>æ˜¯</td><td>å¦</td></tr><tr><td>é™æ€å…¥å£</td><td>æ— </td><td>æœ‰</td></tr></tbody></table><h4 id="æ€§èƒ½å¯¹æ¯”"><a class="header-anchor" href="#æ€§èƒ½å¯¹æ¯”"></a>æ€§èƒ½å¯¹æ¯”</h4><p>Sharding-JDBCä¸Sharding-Proxyä¿æŒç›¸åŒçš„æ•°æ®åº“ã€æ•°æ®åº“è¿æ¥é…ç½®ã€åç«¯åº”ç”¨ä¸‹è¿›è¡Œæµ‹è¯•</p><ul><li><p>å•è¡¨æ’å…¥<br><img src="https://s1.ax1x.com/2020/09/10/wY071U.png" alt="wY071U.png"></p></li><li><p>å•è¡¨æŸ¥è¯¢<br><img src="https://s1.ax1x.com/2020/09/10/wY0f7n.png" alt="wY0f7n.png"></p></li><li><p>ç»“è®º<br>ä»è€—æ—¶ä¸Šæ¯”è¾ƒå•è¡¨æ’å…¥çš„æ€§èƒ½ä»é«˜åˆ°ä½ä¾æ¬¡æ˜¯Sharding-JDBCã€JDBCã€Sharding-Proxy<br>ä»è€—æ—¶ä¸Šæ¯”è¾ƒå•è¡¨æŸ¥è¯¢çš„æ€§èƒ½ä»é«˜åˆ°ä½ä¾æ¬¡æ˜¯Sharding-JDBCã€JDBCã€Sharding-Proxy</p></li></ul><h3 id="æ‰©å±•éƒ¨åˆ†"><a class="header-anchor" href="#æ‰©å±•éƒ¨åˆ†"></a>æ‰©å±•éƒ¨åˆ†</h3><h4 id="æºç åˆ†æ"><a class="header-anchor" href="#æºç åˆ†æ"></a>æºç åˆ†æ</h4><ul><li>Sharding-JDBCçš„æ•°æ®åˆ†ç‰‡çš„æ‰§è¡Œè¿‡ç¨‹</li></ul><p><img src="https://s1.ax1x.com/2020/09/06/wmlLC9.png" alt="wmlLC9.png"></p><p>ShardingRouter.<strong>route()<strong>æ–¹æ³•ä½œä¸ºè·¯ç”±çš„æ ¸å¿ƒï¼Œä¸»è¦æ˜¯è¿”å›è·¯ç”±å¯¹è±¡</strong>SQLRouteResult</strong>,SQLRouteResultä¿å­˜è·¯ç”±ä¿¡æ¯<br><img src="https://s1.ax1x.com/2020/05/19/Y4Fupq.png" alt="Y4Fupq.png"></p><p><strong>RouteResult</strong>å¯¹è±¡ä¼šè¢«è¿”å›åˆ°<strong>ShardingPreparedStatement</strong>ä¸­ï¼Œè¿™ä¸ªç±»ç»§æ‰¿äº<strong>java.sql.Statement</strong>,Statementæ˜¯å®šä¹‰æ•°æ®åº“è¿›è¡Œäº¤äº’å¹¶è¿”å›ç»“æœçš„æ¥å£</p><ul><li>ShardingPreparedStatementæ‰©å±•çš„æ–¹æ³•</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ShardingPreparedStatement</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractShardingPreparedStatementAdapter</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ†ç‰‡è¿æ¥</span>    <span class="token annotation punctuation">@Getter</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ShardingConnection</span> connection<span class="token punctuation">;</span>        <span class="token comment">//æ‰§è¡Œsql</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> sql<span class="token punctuation">;</span>        <span class="token comment">//åˆ†ç‰‡å¼•æ“</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PreparedQueryShardingEngine</span> shardingEngine<span class="token punctuation">;</span>        <span class="token comment">//æ‰§è¡Œå™¨</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PreparedStatementExecutor</span> preparedStatementExecutor<span class="token punctuation">;</span>        <span class="token comment">//æ‰¹å¤„ç†æ‰§è¡Œå™¨</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BatchPreparedStatementExecutor</span> batchPreparedStatementExecutor<span class="token punctuation">;</span>        <span class="token comment">//sqlè·¯ç”±å™¨</span>    <span class="token keyword">private</span> <span class="token class-name">SQLRouteResult</span> sqlRouteResult<span class="token punctuation">;</span>        <span class="token comment">//ç»“æœé›†</span>    <span class="token keyword">private</span> <span class="token class-name">ResultSet</span> currentResultSet<span class="token punctuation">;</span>    <span class="token comment">//å®ç°executeQueryã€executeUpdateã€executeã€getGeneratedKeysç­‰æ–¹æ³•</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="execute-æ–¹æ³•è¿›è¡Œå…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹"><a class="header-anchor" href="#execute-æ–¹æ³•è¿›è¡Œå…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹"></a>execute()æ–¹æ³•è¿›è¡Œå…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ¸…é™¤ç¯å¢ƒ</span>        <span class="token function">clearPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è¿›è¡Œåˆ†ç‰‡ç¯å¢ƒè®¾ç½®</span>        <span class="token function">shard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹åŒ–é¢„å¤„ç†æ‰§è¡Œå™¨</span>        <span class="token function">initPreparedStatementExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ‰§è¡Œ</span>        <span class="token keyword">return</span> preparedStatementExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token function">clearBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>initPreparedStatementExecutor()æ–¹æ³•åˆå§‹åŒ–é¢„å¤„ç†æ‰§è¡Œ</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initPreparedStatementExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–æ‰§è¡Œå™¨</span>    preparedStatementExecutor<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>sqlRouteResult<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è®¾ç½®è¯­å¥å‚æ•°</span>    <span class="token function">setParametersForStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">replayMethodForStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>**preparedStatementExecutor.execute()**æ–¹æ³•æ˜¯å…·ä½“æ‰§è¡Œçš„æ–¹æ³•</p><p><img src="https://s1.ax1x.com/2020/05/20/Y7XsIA.png" alt="Y7XsIA.png"></p><p>1å¤„å°†å¾…æ‰§è¡Œsqlå°è£…æˆä¸ºå›è°ƒå¯¹è±¡ï¼Œ2å¤„**executeCallback(executeCallback)**æ‰§è¡Œå›è°ƒå¯¹è±¡</p><ul><li>executeCallbackåœ¨å›è°ƒä¸­æ‰§è¡Œsql</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token class-name">Boolean</span> <span class="token function">executeSQL</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ConnectionMode</span> connectionMode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>executeCallback()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> sqlExecuteTemplate<span class="token punctuation">.</span><span class="token function">executeGroup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> executeGroups<span class="token punctuation">,</span> executeCallback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">refreshMetaDataIfNeeded</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sqlStatementContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡<strong>sqlExecuteTemplate.executeGroup</strong>æ‰§è¡Œæ–¹æ³•ï¼Œä¼šå°†æ‰§è¡ŒåŠ¨ä½œä¼ é€’åˆ°æ‰§è¡Œå¼•æ“<strong>ShardingExecuteEngine</strong>çš„<strong>groupExecute</strong>æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token function">groupExecute</span><span class="token punctuation">(</span>    <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingExecuteGroup</span><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputGroups<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> firstCallback<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> callback<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> serial<span class="token punctuation">)</span>    <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputGroups<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> serial <span class="token operator">?</span> <span class="token function">serialExecute</span><span class="token punctuation">(</span>inputGroups<span class="token punctuation">,</span> firstCallback<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">parallelExecute</span><span class="token punctuation">(</span>inputGroups<span class="token punctuation">,</span> firstCallback<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™é‡Œ<strong>åŒæ­¥æ‰§è¡Œæ–¹æ³•</strong>å’Œ<strong>å¼‚æ­¥æ‰§è¡Œæ–¹æ³•</strong>ï¼Œå¹¶ä¸”å°†ç¬¬ä¸€ä¸ªä»»åŠ¡äº¤ç»™å½“å‰çº¿ç¨‹è¿›è¡Œå¤„ç†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token function">parallelExecute</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingExecuteGroup</span><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputGroups<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> firstCallback<span class="token punctuation">,</span>                                       <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingExecuteGroup</span><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputGroupsIterator <span class="token operator">=</span> inputGroups<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ShardingExecuteGroup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span></span> firstInputs <span class="token operator">=</span> inputGroupsIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListenableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> restResultFutures <span class="token operator">=</span> <span class="token function">asyncGroupExecute</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>inputGroupsIterator<span class="token punctuation">)</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœfirstCallbackæœ‰å€¼å°±è®©å½“å‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œå¦‚æœæ²¡å€¼å°±è¿”å›çº¿ç¨‹æ± æ‰§è¡Œç»“æœ</span>    <span class="token keyword">return</span> <span class="token function">getGroupResults</span><span class="token punctuation">(</span><span class="token function">syncGroupExecute</span><span class="token punctuation">(</span>firstInputs<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token operator">==</span> firstCallback <span class="token operator">?</span> callback <span class="token operator">:</span> firstCallback<span class="token punctuation">)</span><span class="token punctuation">,</span> restResultFutures<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç å¾ˆç»†å¿ƒï¼Œä¸ä½†ä½¿ç”¨åˆ°äº†å½“å‰çº¿ç¨‹æ¥æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¹Ÿä½¿ç”¨çš„æ˜¯Guavaæä¾›çš„å¯å›è°ƒçš„çº¿ç¨‹æ± <strong>ListeningExecutorService</strong>,å¯å‚è€ƒ<a href="/2020/05/20/1.%E6%9D%82%E8%AE%B0/Guava%E7%9A%84%E4%BD%BF%E7%94%A8/#more">Guavaçš„ä½¿ç”¨</a></p><p>åœ¨æ‰§è¡Œsqlæ—¶å€™åˆä¼šå›åˆ°å½“åˆåˆ›å»ºå›è°ƒå‡½æ•°çš„åœ°æ–¹è¿›è¡Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚</p><h3 id="å‚è€ƒæ–‡çŒ®"><a class="header-anchor" href="#å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h3><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://shardingsphere.apache.org/">ShardingSphereå®˜ç½‘</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p></li></ol></section>]]></content>
      
      
      <categories>
          
          <category> ShardingSphere </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShardingSphere </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¸¸ç¢ç¢å¿µ</title>
      <link href="2020/08/23/1.%E6%9D%82%E8%AE%B0/%E6%97%A5%E5%B8%B8%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
      <url>2020/08/23/1.%E6%9D%82%E8%AE%B0/%E6%97%A5%E5%B8%B8%E7%A2%8E%E7%A2%8E%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¢ç¢å¿µ"><a class="header-anchor" href="#ç¢ç¢å¿µ"></a>ç¢ç¢å¿µ</h2><ol><li>TimerTask</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Timer</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000L</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token operator">*</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">RefreshTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">reflesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">reflesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// æ‹‰å»æƒé™æ•°æ®</span>    <span class="token comment">// æ›´æ–°ç¼“å­˜æ•°æ®</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>TimerTaskåœ¨æ‰§è¡Œæ—¶ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸ä¸è¿›è¡Œæ•è·å°±ç›´æ¥ç»ˆæ­¢ï¼Œå»ºè®®ä½¿ç”¨ScheduledThreadPoolExecutoræ¥æ›¿ä»£</p></blockquote><ol start="2"><li>mycatå…¨å±€è¡¨æ’å…¥çš„æ—¶æŠ›å‡ºç´¢å¼•é‡å¤<br>ç°è±¡æ˜¯mycatåœ¨æ’å…¥æ—¶ï¼ŒæŠ›å‡ºäº†ç´¢å¼•é‡å¤ä½†æ˜¯å†æ¬¡æŸ¥è¯¢æ—¶ï¼Œç¡®æœ‰æ•°æ®<br>åŸå› æ˜¯å› ä¸ºmycatåœ¨æŸ¥è¯¢æ—¶å€™åªä¼šéšæœºæŸ¥è¯¢ä¸€ä¸ªåˆ†åº“ä¸­çš„æ•°æ®ï¼Œç”±äºä¸åŒåˆ†åº“çš„ä¸»é”®åºåˆ—ä¸ä¸€æ ·ï¼Œå¯¼è‡´æ¯æ¬¡æ’å…¥æ—¶ï¼Œidä¸ä¸€æ ·ï¼Œéšååˆé€šè¿‡idæ¥è¿›è¡Œåˆ é™¤ï¼Œè¿™æ ·åªä¼šåˆ é™¤ä¸€ä¸ªè¡¨çš„æ•°æ®ï¼Œå¯¼è‡´æ•°æ®æœªè¢«åˆ é™¤çš„åº“å†æ¬¡æ’å…¥æ—¶æŠ›å‡ºç´¢å¼•é‡å¤ã€‚</li></ol><ul><li>mycatå…¨å±€è¡¨éšæœºé€‰æ‹©åº“</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getAliveRandomDataNode</span><span class="token punctuation">(</span><span class="token class-name">TableConfig</span> tc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> randomDns <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>tc<span class="token punctuation">.</span><span class="token function">getDataNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">MycatConfig</span> mycatConfig <span class="token operator">=</span> <span class="token class-name">MycatServer</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mycatConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å°†dataNodeséšæœºæ’åˆ—</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>randomDns<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//çœç•¥...æ»¡è¶³æ¡ä»¶é€‰å–ç¬¬ä¸€ä¸ªdataNode</span><span class="token punctuation">&#125;</span><span class="token comment">// all fail return default</span><span class="token keyword">return</span> tc<span class="token punctuation">.</span><span class="token function">getRandomDataNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¯¹é‡å¤æ•°æ®çš„ä¸åŒå¤„ç†åœ¨1.6.xä¸Šå¯¹äºé‡å¤æ•°æ®æ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæœ€æ–°çš„ç‰ˆæœ¬åˆ™æ˜¯è¿”å›ä¿®æ”¹å€¼</li></ul><ol start="3"><li>æŸ¥è¯¢ç«¯å£å ç”¨æƒ…å†µ</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ç«¯å£å ç”¨æƒ…å†µ</span><span class="token function">netstat</span> -nap <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">2181</span><span class="token comment"># ç«¯å£è¿æ¥æ•°</span><span class="token function">netstat</span> -na <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">2181</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¢ç¢å¿µ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shardingSphereç†è®ºåŸºç¡€</title>
      <link href="2020/08/20/11.orm%E6%A1%86%E6%9E%B6/23.shardingSphere%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/"/>
      <url>2020/08/20/11.orm%E6%A1%86%E6%9E%B6/23.shardingSphere%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1>shardingSphereç†è®ºåŸºç¡€</h1><h2 id="ç†è®º"><a class="header-anchor" href="#ç†è®º"></a>ç†è®º</h2><p>shardingSpgereå®ç°JDBCè§„èŒƒï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•</p><h2 id="æ ¸å¿ƒæ¦‚å¿µ"><a class="header-anchor" href="#æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h2><p>æ•°æ®åˆ†ç‰‡æŒ‰ç…§æ‹†åˆ†çš„æ–¹å¼åˆ†ä¸ºæ°´å¹³æ‹†åˆ†å’Œå‚ç›´æ‹†åˆ†</p><ul><li>å‚ç›´æ‹†åˆ†</li></ul><blockquote><p>å‚ç›´æ‹†åˆ†æŒ‡çš„æ˜¯ä¸“åº“ä¸“ç”¨ï¼Œå°†ä¸åŒä¸šåŠ¡çš„è¡¨æ‹†åˆ†åˆ°å¯¹åº”çš„åº“ä¸­ã€‚å¾®æœåŠ¡æ¶æ„ä¸‹å·²åŸºæœ¬å®ç°å‚ç›´æ‹†åˆ†</p></blockquote><ul><li>æ°´å¹³æ‹†åˆ†</li></ul><blockquote><p>æ°´å¹³æ‹†åˆ†æŒ‡çš„æ˜¯é€šè¿‡æ ¹æ®æŸç§è§„åˆ™å°†æ•°æ®æ”¾åˆ°æŒ‡å®šçš„æ•°æ®èŠ‚ç‚¹ä¸­ï¼Œæ•°æ®èŠ‚ç‚¹æ˜¯ç”±åº“å’Œè¡¨ç»„åˆè€Œæˆçš„</p></blockquote><h3 id="shardingSphereä¸­çš„åŸºæœ¬æ¦‚å¿µ"><a class="header-anchor" href="#shardingSphereä¸­çš„åŸºæœ¬æ¦‚å¿µ"></a>shardingSphereä¸­çš„åŸºæœ¬æ¦‚å¿µ</h3><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>é€»è¾‘è¡¨</td><td>åœ¨ä»£ç é€»è¾‘ä¸Šå¯¹æ‹†åˆ†è¡¨çš„æ€»ç§°</td></tr><tr><td>çœŸå®è¡¨</td><td>åœ¨åˆ†ç‰‡çš„æ•°æ®åº“ä¸­çœŸå®å­˜åœ¨çš„ç‰©ç†è¡¨</td></tr><tr><td>æ•°æ®èŠ‚ç‚¹</td><td>æ•°æ®åˆ†ç‰‡çš„æœ€å°å•ä½,ç”±æ•°æ®æºåç§°å’Œæ•°æ®è¡¨ç»„æˆ(shema.tableName)</td></tr><tr><td>ç»‘å®šè¡¨</td><td>ç»‘å®šè¡¨æ˜¯shardingSphereä¸­ç‰¹æœ‰çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åˆ†ç‰‡è§„åˆ™ä¸€è‡´çš„ä¸»è¡¨å’Œå­è¡¨ã€‚å¦‚æœæŒ‡å®šäº’ä¸ºç»‘å®šè¡¨ï¼Œåœ¨è¿›è¡Œè”è¡¨æŸ¥è¯¢æ—¶å°†ä¸ä¼šå‡ºç°ç¬›å¡å°”ç§¯</td></tr><tr><td>å¹¿æ’­è¡¨</td><td>å¹¿æ’­è¡¨ç±»ä¼¼äºmycatä¸­çš„å…¨å±€è¡¨,é€‚ç”¨äºä½œä¸ºå­—å…¸è¡¨</td></tr></tbody></table><ul><li>shardingSphereæ”¯æŒçš„åˆ†ç‰‡ç­–ç•¥</li></ul><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>ç²¾ç¡®åˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨å•ä¸€é”®ä½œä¸ºåˆ†ç‰‡é”®çš„=ä¸INè¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td></tr><tr><td>èŒƒå›´åˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨å•ä¸€é”®ä½œä¸ºåˆ†ç‰‡é”®çš„BETWEEN ANDã€&gt;ã€&lt;ã€&gt;=ã€&lt;=è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td></tr><tr><td>å¤åˆåˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨å¤šé”®ä½œä¸ºåˆ†ç‰‡é”®è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td></tr><tr><td>Hintåˆ†ç‰‡ç®—æ³•</td><td>ç”¨äºå¤„ç†ä½¿ç”¨Hintè¡Œåˆ†ç‰‡çš„åœºæ™¯(ä½¿ç”¨å¤–éƒ¨æ•°æ®è¿›è¡Œåˆ†ç‰‡)</td></tr></tbody></table><h3 id="JDBCè§„èŒƒ"><a class="header-anchor" href="#JDBCè§„èŒƒ"></a>JDBCè§„èŒƒ</h3><ul><li>DataSource</li></ul><blockquote><p>DataSource åœ¨ JDBC è§„èŒƒä¸­ä»£è¡¨çš„æ˜¯ä¸€ç§æ•°æ®æºï¼Œæ ¸å¿ƒä½œç”¨æ˜¯è·å–æ•°æ®åº“è¿æ¥å¯¹è±¡ Connectionã€‚å¯ä»¥ç›´æ¥é€šè¿‡ DriverManager è·å– Connection</p></blockquote><ul><li>Connection</li></ul><blockquote><p>DataSource çš„ç›®çš„æ˜¯è·å– Connection å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Connection ç†è§£ä¸ºä¸€ç§ä¼šè¯ï¼ˆSessionï¼‰æœºåˆ¶ã€‚Connection ä»£è¡¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œè´Ÿè´£å®Œæˆä¸æ•°æ®åº“ä¹‹é—´çš„é€šä¿¡ã€‚æ‰€æœ‰ SQL çš„æ‰§è¡Œéƒ½æ˜¯åœ¨æŸä¸ªç‰¹å®š Connection ç¯å¢ƒä¸­è¿›è¡Œçš„ï¼ŒåŒæ—¶å®ƒè¿˜æä¾›äº†ä¸€ç»„é‡è½½æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºåˆ›å»º Statement å’Œ PreparedStatementã€‚</p></blockquote><ul><li>Statement</li></ul><blockquote><p>JDBC è§„èŒƒä¸­çš„ Statement å­˜åœ¨ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯æ™®é€šçš„ Statementï¼Œä¸€ç§æ˜¯æ”¯æŒé¢„ç¼–è¯‘çš„ PreparedStatement</p></blockquote><p>ps: PreparedStatementå…·ä½“åšäº†ä»€ä¹ˆï¼Ÿ</p><blockquote><p>é¢„ç¼–è¯‘æŒ‡çš„æ˜¯æ•°æ®åº“çš„ç¼–è¯‘å™¨ä¼šå¯¹sqlè¿›è¡Œæå‰ç¼–è¯‘ï¼Œç„¶åå°†é¢„ç¼–è¯‘çš„ç»“æœç¼“å­˜åˆ°æ•°æ®åº“ä¸­ã€‚è¿™æ ·ä¸‹æ¬¡æ‰§è¡Œæ—¶å°±å¯ä»¥åªç”¨æ›¿æ¢å‚æ•°è°ƒç”¨é¢„ç¼–è¯‘çš„sqlè¯­å¥ï¼Œä»è€Œæé«˜sqlçš„æ‰§è¡Œæ•ˆç‡</p></blockquote><ul><li>ResultSet</li></ul><blockquote><p>ä»£è¡¨sqlçš„æ‰§è¡Œç»“æœ</p></blockquote><ul><li>åŸºäºJDBCè§„èŒƒçš„æµç¨‹å›¾</li></ul><p>Driver -&gt; åˆ›å»ºDataSource -&gt; è·å–Connection -&gt; åˆ›å»ºStatement -&gt; æ‰§è¡ŒSQLè¯­å¥ -&gt; å¤„ç†ResultSet -&gt; å…³é—­èµ„æºå¯¹è±¡</p><ul><li>shardingshereåŸºäºé€‚é…å™¨æ¨¡å¼çš„JDBCé‡å†™å®ç°æ–¹æ¡ˆ</li></ul><p>shardingshereé€šè¿‡ç»§æ‰¿jdbcé¢„ç•™çš„Wrapperæ¥å£ï¼Œç„¶ååœ¨wrapperä¸­æ‰§è¡Œjdbcçš„å¢å¼ºã€‚</p><h2 id="åŠŸèƒ½"><a class="header-anchor" href="#åŠŸèƒ½"></a>åŠŸèƒ½</h2><p>shardingSphereåŠŸèƒ½ä¸Šå¯ä»¥åˆ’åˆ†ä¸ºå››å¤§éƒ¨åˆ†ï¼Œ<B>åŸºç¡€è®¾æ–½</B>ã€<B>åˆ†ç‰‡å¼•æ“</B>ã€<B>åˆ†å¸ƒå¼äº‹åŠ¡</B>ã€<B>æ²»ç†ä¸é›†æˆ</B></p><h3 id="åŸºç¡€è®¾æ–½å±‚"><a class="header-anchor" href="#åŸºç¡€è®¾æ–½å±‚"></a>åŸºç¡€è®¾æ–½å±‚</h3><p>åŸºç¡€è®¾æ–½å±‚åŒ…å«<B>å¾®å†…æ ¸æ¶æ„</B>ã€<B>åˆ†å¸ƒå¼ä¸»é”®</B></p><h3 id="åˆ†ç‰‡å¼•æ“"><a class="header-anchor" href="#åˆ†ç‰‡å¼•æ“"></a>åˆ†ç‰‡å¼•æ“</h3><p>åˆ†ç‰‡å¼•æ“åŒ…æ‹¬<B>æ•°æ®åˆ†ç‰‡</B>ã€<B>è¯»å†™åˆ†ç¦»</B></p><h3 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a class="header-anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h3><p>åˆ†å¸ƒå¼äº‹åŠ¡åŒ…æ‹¬<B>æ ‡å‡†åŒ–äº‹åŠ¡å¤„ç†æ¥å£</B>ã€<B>å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡</B></p><h3 id="é›†æˆä¸æ²»ç†"><a class="header-anchor" href="#é›†æˆä¸æ²»ç†"></a>é›†æˆä¸æ²»ç†</h3><p>é›†æˆä¸æ²»ç†åŒ…æ‹¬<B>æ•°æ®è„±æ•</B>ã€<B>é…ç½®ä¸­å¿ƒ</B>ã€<B>æ³¨å†Œä¸­å¿ƒ</B>ã€<B>é“¾è·¯è·Ÿè¸ª</B>ã€<B>ç³»ç»Ÿé›†æˆ</B></p><h2 id="ä¸šåŠ¡é›†æˆ"><a class="header-anchor" href="#ä¸šåŠ¡é›†æˆ"></a>ä¸šåŠ¡é›†æˆ</h2><h3 id="jdbcé›†æˆ"><a class="header-anchor" href="#jdbcé›†æˆ"></a>jdbcé›†æˆ</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ›å»ºåˆ†ç‰‡è§„åˆ™é…ç½®ç±»</span>    <span class="token class-name">ShardingRuleConfiguration</span> shardingRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºåˆ†è¡¨è§„åˆ™é…ç½®ç±»</span>    <span class="token class-name">TableRuleConfiguration</span> tableRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span><span class="token string">"t_user"</span><span class="token punctuation">,</span> <span class="token string">"ds$&#123;0..1&#125;.t_user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºåˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆé…ç½®ç±»</span>    <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"worker.id"</span><span class="token punctuation">,</span> <span class="token string">"33"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">KeyGeneratorConfiguration</span> keyGeneratorConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyGeneratorConfiguration</span><span class="token punctuation">(</span><span class="token string">"SNOWFLAKE"</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>    tableRuleConfig<span class="token punctuation">.</span><span class="token function">setKeyGeneratorConfig</span><span class="token punctuation">(</span>keyGeneratorConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableRuleConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ†åº“è§„åˆ™</span>    shardingRuleConfig<span class="token punctuation">.</span><span class="token function">setDefaultDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InlineShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"ds$&#123;id%2&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºå…·ä½“çš„DataSource</span>    <span class="token keyword">return</span> <span class="token class-name">ShardingDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token function">createDataSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shardingRuleConfig<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ormæ¡†æ¶é›†æˆ"><a class="header-anchor" href="#ormæ¡†æ¶é›†æˆ"></a>ormæ¡†æ¶é›†æˆ</h3><h4 id="jpaæ¡†æ¶"><a class="header-anchor" href="#jpaæ¡†æ¶"></a>jpaæ¡†æ¶</h4><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">shardingsphere:    datasource:      names: ds0,ds1      ds0:        type: com.zaxxer.hikari.HikariDataSource        driver-class-name: com.mysql.cj.jdbc.Driver        jdbcUrl: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;ds0?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;GMT        username: root        password: ******      ds1:        type: com.zaxxer.hikari.HikariDataSource        driver-class-name: com.mysql.cj.jdbc.Driver        jdbcUrl: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;ds1?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;GMT        username: root        password: ******      sharding:        default-database-strategy: # åˆ†åº“è§„åˆ™          inline:            sharding-column: vender_id            algorithm-expression: ds$&#123;vender_id % 2&#125;        tables:          t_user:  #t_userè¡¨            key-generator-column-name: id  #ä¸»é”®            actual-data-nodes: ds$&#123;0..1&#125;.t_user$&#123;0..1&#125;    #çœŸå®æ•°æ®èŠ‚ç‚¹            databaseStrategy: # åˆ†åº“ç­–ç•¥              inline:                sharding-column: vender_id # åˆ†åº“é”®                algorithm-expression: ds$&#123;vender_id % 2&#125;            tableStrategy: #åˆ†è¡¨ç­–ç•¥              inline: #è¡Œè¡¨è¾¾å¼                shardingColumn: vender_id                algorithmExpression: t_user$&#123;vender_id % 2&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="javaConfig"><a class="header-anchor" href="#javaConfig"></a>javaConfig</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">getShardingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ShardingRuleConfiguration</span> shardingRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®åˆ†åº“åˆ†è¡¨ç­–ç•¥</span>        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getOrderTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getOrderItemTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®ç»‘å®šè¡¨</span>        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getBindingTableGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"t_order, t_order_item"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®å¹¿æ’­è¡¨</span>        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getBroadcastTables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"t_config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®åˆ†åº“é»˜è®¤ç­–ç•¥</span>        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">setDefaultDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InlineShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token string">"ds$&#123;user_id % 2&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®åˆ†è¡¨é»˜è®¤ç­–ç•¥</span>        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">setDefaultTableShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">ShardingDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token function">createDataSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shardingRuleConfig<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="shardingSphereçš„é…ç½®"><a class="header-anchor" href="#shardingSphereçš„é…ç½®"></a>shardingSphereçš„é…ç½®</h2><h3 id="è¡Œå†…è¡¨è¾¾å¼"><a class="header-anchor" href="#è¡Œå†…è¡¨è¾¾å¼"></a>è¡Œå†…è¡¨è¾¾å¼</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ds<span class="token variable">$&#123;0..1&#125;</span>.user<span class="token variable">$&#123;1..1&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¡Œå†…è¡¨è¾¾å¼æ˜¯ç”¨æ¥ä½œä¸ºshardingSphereçš„é…ç½®ä¿¡æ¯çš„ä¸€ç§è¡¨è¾¾æ–¹å¼ã€‚</p><p>${beginâ€¦end} æ ‡è¯†çš„æ˜¯ä»beginåˆ°endçš„ä¸€ä¸ªåŒºé—´</p><p>å¤šä¸ª${expression}å¯ä»¥ç”¨ç‚¹å·æ¥å½¢æˆç»„åˆå…³ç³»è¡¨è¾¾å¼</p><h3 id="æ ¸å¿ƒé…ç½®é¡¹"><a class="header-anchor" href="#æ ¸å¿ƒé…ç½®é¡¹"></a>æ ¸å¿ƒé…ç½®é¡¹</h3><blockquote><p>shardingSphereçš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯åˆ†åº“åˆ†è¡¨ï¼Œæ ¸å¿ƒåŠŸèƒ½æ˜¯ä¾èµ–é…ç½®çš„ã€‚æŒæ¡å¦‚ä½•ä½¿ç”¨shardingsphereå°±æ˜¯æŒæ¡å¦‚ä½•è¿›è¡Œé…ç½®ã€‚</p></blockquote><h4 id="ShardingRuleConfiguration"><a class="header-anchor" href="#ShardingRuleConfiguration"></a>ShardingRuleConfiguration</h4>]]></content>
      
      
      <categories>
          
          <category> ShardingSphere </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShardingSphere </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¨‹åºè®¾è®¡ä¸­çš„åŸºçŸ³:æ•°ç»„</title>
      <link href="2020/08/08/15.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%AD%E7%9A%84%E5%9F%BA%E7%9F%B3-%E6%95%B0%E7%BB%84/"/>
      <url>2020/08/08/15.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%AD%E7%9A%84%E5%9F%BA%E7%9F%B3-%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<h1>ç¨‹åºè®¾è®¡ä¸­çš„åŸºçŸ³:æ•°ç»„</h1><h2 id="æ•°ç»„çš„å®šä¹‰"><a class="header-anchor" href="#æ•°ç»„çš„å®šä¹‰"></a>æ•°ç»„çš„å®šä¹‰</h2><blockquote><p>æ•°ç»„å¯ä»¥è¢«å®šä¹‰ä¸ºæ˜¯<B>ä¸€ç»„è¢«ä¿å­˜åœ¨è¿ç»­å­˜å‚¨ç©ºé—´ä¸­ï¼Œå¹¶ä¸”å…·æœ‰ç›¸åŒç±»å‹çš„æ•°æ®å…ƒç´ é›†åˆ</B></p></blockquote><p>ç”±äºæ•°ç»„ä½äºå†…å­˜ä¸­ä¸€æ®µè¿ç»­çš„ç©ºé—´ä¸­ï¼Œå› æ­¤é€šè¿‡ç´¢å¼•å»è¯»å–å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯0(1);ç”±äºæ’å…¥å’Œåˆ é™¤å‡ä¼šç§»åŠ¨å…¶ä»–çš„ç›¸é‚»å…ƒç´ ï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦ä¸ºo(n);</p><h2 id="æ•°ç»„åœ¨redisä¸­çš„ä½¿ç”¨"><a class="header-anchor" href="#æ•°ç»„åœ¨redisä¸­çš„ä½¿ç”¨"></a>æ•°ç»„åœ¨redisä¸­çš„ä½¿ç”¨</h2>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºtestcontainersçš„é›†æˆæµ‹è¯•æ–¹æ¡ˆ</title>
      <link href="2020/07/31/1.%E6%9D%82%E8%AE%B0/%E5%9F%BA%E4%BA%8Etestcontainers%E7%9A%84%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%96%B9%E6%A1%88/"/>
      <url>2020/07/31/1.%E6%9D%82%E8%AE%B0/%E5%9F%BA%E4%BA%8Etestcontainers%E7%9A%84%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºtestcontainersçš„é›†æˆæµ‹è¯•æ–¹æ¡ˆ</h1><blockquote><p>Testcontainersæ˜¯ä¸€ä¸ªJavaåº“ï¼Œæ”¯æŒJUnitæµ‹è¯•ï¼Œå®ƒæä¾›å¸¸è§æ•°æ®åº“ï¼ŒSelenium Webæµè§ˆå™¨æˆ–å¯ä»¥åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œçš„ä»»ä½•å…¶ä»–ä¸œè¥¿çš„è½»é‡çº§ï¼Œä¸€æ¬¡æ€§çš„å®ä¾‹ã€‚</p></blockquote><p><B>testcontainers</B>å®˜ç½‘ä¸ºhttps://www.testcontainers.org/</p><h2 id="åŸºç¡€å·¥ç¨‹"><a class="header-anchor" href="#åŸºç¡€å·¥ç¨‹"></a>åŸºç¡€å·¥ç¨‹</h2><ol><li>dockerç¯å¢ƒ</li><li>springBootå·¥ç¨‹</li></ol><h3 id="dockerç¯å¢ƒ"><a class="header-anchor" href="#dockerç¯å¢ƒ"></a>dockerç¯å¢ƒ</h3><blockquote><p><a href="https://download.docker.com/win/stable/Docker%20Desktop%20Installer.exe">https://download.docker.com/win/stable/Docker Desktop Installer.exe</a><br>ä¸‹è½½Docker Desktop Installer.exeè¿›è¡Œå®‰è£…Docker</p></blockquote><ul><li>æŸ¥çœ‹Dockerç‰ˆæœ¬<br><img src="https://s1.ax1x.com/2020/08/01/a3z3Md.png" alt="a3z3Md.png"></li><li>Docker æœåŠ¡å¯åŠ¨/å…³é—­å‘½ä»¤</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å¯åŠ¨dockeræœåŠ¡</span>Net start com.docker.service<span class="token comment"># åœæ­¢dockeræœåŠ¡</span>Net stop com.docker.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="springBootåº”ç”¨"><a class="header-anchor" href="#springBootåº”ç”¨"></a>springBootåº”ç”¨</h3><blockquote><p><a href="https://github.com/agmtopy/testcontainers-simple">https://github.com/agmtopy/testcontainers-simple</a></p></blockquote><h2 id="redis"><a class="header-anchor" href="#redis"></a>redis</h2><ul><li>RedisTestContainersTest.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Testcontainers</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTestContainersTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">RedisCommands</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> redisCommands<span class="token punctuation">;</span>    <span class="token comment">/**     * åˆå§‹åŒ–redis å®¹å™¨     */</span>    <span class="token annotation punctuation">@Container</span>    <span class="token keyword">public</span> <span class="token class-name">GenericContainer</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericContainer</span><span class="token punctuation">(</span><span class="token string">"redis:5.0.3-alpine"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">withExposedPorts</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@BeforeEach</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> address <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Integer</span> port <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">getFirstMappedPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹åŒ–rediså®¢æˆ·ç«¯</span>        redisCommands <span class="token operator">=</span> <span class="token class-name">RedisClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"redis://%s:%d/0"</span><span class="token punctuation">,</span> address<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimplePutAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        redisCommands<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"example"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> retrieved <span class="token operator">=</span> redisCommands<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"retrieved : "</span> <span class="token operator">+</span> retrieved<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"example"</span><span class="token punctuation">,</span> retrieved<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="mysql"><a class="header-anchor" href="#mysql"></a>mysql</h2><ul><li>MysqlTestContainersTest</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * mysql å®¹å™¨æµ‹è¯• */</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>        classes <span class="token operator">=</span> <span class="token class-name">MysqlTestConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>        properties <span class="token operator">=</span> <span class="token punctuation">&#123;</span>                <span class="token string">"spring.profiles.active=test"</span><span class="token punctuation">,</span>                <span class="token string">"embedded.mysql.install.enabled=true"</span><span class="token punctuation">,</span>                <span class="token string">"embedded.mysql.init-script-path=initScript.sql"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlTestContainersTest</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">;</span>    <span class="token comment">/**     * jdbcTemplate     */</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">propertiesAreAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"embedded.mysql.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"embedded.mysql.host"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"embedded.mysql.schema"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"embedded.mysql.user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"embedded.mysql.password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"embedded.mysql.init-script-path"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldInitDBForMySQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token string">"select count(first_name) from users where first_name = 'Sam' "</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="kafka"><a class="header-anchor" href="#kafka"></a>kafka</h2><ul><li></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.testcontainers.org/">testcontainerså®˜ç½‘</a><br><a href="https://github.com/testcontainers/testcontainers-java/">testcontainersé¡¹ç›®åœ°å€</a><br><a href="https://github.com/testcontainers/testcontainers-spring-boot">testcontainers-spring-boot</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æµ‹è¯• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nettyå…¥é—¨åŸºç¡€äºŒ</title>
      <link href="2020/07/29/10.netty%E7%AC%94%E8%AE%B0/2.Netty%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80%E4%BA%8C/"/>
      <url>2020/07/29/10.netty%E7%AC%94%E8%AE%B0/2.Netty%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80%E4%BA%8C/</url>
      
        <content type="html"><![CDATA[<h1>Nettyå…¥é—¨åŸºç¡€äºŒ</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»äº†Nettyæ˜¯ä»ä½•è€Œæ¥ä»¥åŠæ¦‚å¿µå’Œç»„ä»¶ï¼Œä¸‹é¢å’±ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„ä¾‹å­</p><p>åˆ†æNettyå®ä¾‹ä¸»è¦æ˜¯ä¸ºäº†å±•ç¤ºæœåŠ¡å™¨ç«¯çš„<B>ä¸šåŠ¡é€»è¾‘</B>å’Œ<B>å¼•å¯¼ä»£ç </B>ä¸¤éƒ¨åˆ†<br>æœåŠ¡ç«¯çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ä¸€éƒ¨åˆ†æ˜¯å¯¹äº<B>channel</B>çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯å¯¹<B>ä¸šåŠ¡æ•°æ®</B>çš„å¤„ç†<br>ä¸»è¦ä»¥RocketMQä¸­çš„<a href="https://github.com/apache/rocketmq/blob/master/remoting/src/main/java/org/apache/rocketmq/remoting/netty/NettyRemotingServer.java">NettyRemotingServer</a>ä¸ºä¸»</p><h3 id="å¼•å¯¼ä»£ç "><a class="header-anchor" href="#å¼•å¯¼ä»£ç "></a>å¼•å¯¼ä»£ç </h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ServerBootstrap</span> childHandler <span class="token operator">=</span>    <span class="token comment">//1. è®¾ç½®EventLoopGroup</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventLoopGroupBoss<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eventLoopGroupSelector<span class="token punctuation">)</span>        <span class="token comment">//2. è®¾ç½®channelå¤„ç†ç±»å‹</span>        <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token function">useEpoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">EpollServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>        <span class="token comment">//3. è®¾ç½®ç”¨äºç›‘å¬socketçš„å±æ€§</span>        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_BACKLOG<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>        <span class="token comment">//4. è®¾ç½®åˆ›å»ºsocketåå†åˆ›å»ºçš„socket</span>        <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>TCP_NODELAY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_SNDBUF<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerSocketSndBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_RCVBUF<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerSocketRcvBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">//5. è®¾ç½®é“¾æ¥åœ°å€</span>        <span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getListenPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">//6. è®¾ç½®ä¸šåŠ¡å¤„ç† Channel</span>        <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>                ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>defaultEventExecutorGroup<span class="token punctuation">,</span> HANDSHAKE_HANDLER_NAME<span class="token punctuation">,</span> handshakeHandler<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>defaultEventExecutorGroup<span class="token punctuation">,</span>                        encoder<span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">NettyDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerChannelMaxIdleTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        connectionManageHandler<span class="token punctuation">,</span>                        serverHandler                    <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼•å¯¼ä»£ç ä¸»è¦æ˜¯åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤</p><ol><li>è®¾ç½®EventLoopGroup</li><li>è®¾ç½®Channelå¤„ç†ç±»å‹</li><li>è®¾ç½®ç›‘å¬socketçš„å±æ€§</li><li>è®¾ç½®åœ°å€ç«¯å£</li><li>è®¾ç½®ä¸šåŠ¡å¤„ç†çš„Channel</li></ol><h3 id="ä¸šåŠ¡é€»è¾‘"><a class="header-anchor" href="#ä¸šåŠ¡é€»è¾‘"></a>ä¸šåŠ¡é€»è¾‘</h3><p>ä¸šåŠ¡å¤„ç†é€»è¾‘æ˜¯ç”±<B>ChannelInitializer</B>å®ç°çš„ï¼Œåˆ†åˆ«æ˜¯æ·»åŠ äº†ä¸¤ä¸ªå¤„ç†ç­–ç•¥åˆ†åˆ«æ˜¯</p><ul><li><p>HandshakeHandler handshakeHandler</p></li><li><p>NettyServerHandler serverHandler</p></li></ul><p>è¿™ä¸¤ä¸ªç­–ç•¥éƒ½æ˜¯ç»§æ‰¿äº<B>SimpleChannelInboundHandler</B>,<br>HandshakeHandleråªæ˜¯å¤„ç†å…¥ç«™é“¾æ¥æ˜¯å¦éœ€è¦TSLåŠ å¯†å¤„ç†çš„ï¼Œå› æ­¤ç›¸å…³å‚æ•°ä¹Ÿæ¯”è¾ƒç®€å•<br>NettyServerHandleræ˜¯çœŸæ­£çš„ä¸šåŠ¡å¤„ç†ç±»,å› æ­¤è·Ÿéšäº†å¾ˆå¤šæ‰§è¡Œçš„ç­–ç•¥é…ç½®å‚æ•°ç­‰</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è®¾ç½®ä¸šåŠ¡å¤„ç†ç­–ç•¥</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>defaultEventExecutorGroup<span class="token punctuation">,</span>    encoder<span class="token punctuation">,</span><span class="token comment">//è®¾ç½®è§£ç å™¨</span>    <span class="token keyword">new</span> <span class="token class-name">NettyDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è®¾ç½®ç¼–ç å™¨</span>    <span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerChannelMaxIdleTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    connectionManageHandler<span class="token punctuation">,</span><span class="token comment">//è®¾ç½®åŒå·¥å¤„ç†ç­–ç•¥</span>    serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æ¥åˆ†æä»¥ä¸‹SimpleChannelInboundHandlerçš„è®¾è®¡</p><h2 id="æºç åˆ†æ"><a class="header-anchor" href="#æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="SimpleChannelInboundHandler"><a class="header-anchor" href="#SimpleChannelInboundHandler"></a>SimpleChannelInboundHandler</h3><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ä¸šåŠ¡çš„å¤„ç†ç±»éƒ½ç»§æ‰¿äº<B>SimpleChannelInboundHandler</B><br><img src="https://i.loli.net/2021/11/18/GmHgT5OzsdwFfLk.jpg" alt="SimpleChannelInboundHandlerçš„ç»§æ‰¿å…³ç³»"></p>]]></content>
      
      
      <categories>
          
          <category> Netty </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nettyå…¥é—¨åŸºç¡€ä¸€</title>
      <link href="2020/07/29/10.netty%E7%AC%94%E8%AE%B0/1.Netty%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80%E4%B8%80/"/>
      <url>2020/07/29/10.netty%E7%AC%94%E8%AE%B0/1.Netty%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<h1>Nettyå…¥é—¨åŸºç¡€</h1><h2 id="Nettyæ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#Nettyæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Nettyæ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote><p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚</p></blockquote><p>Nettyé’ˆå¯¹java nioåšäº†å°è£…å’Œæ”¹è¿›</p><h2 id="ç®€å•å®ä¾‹"><a class="header-anchor" href="#ç®€å•å®ä¾‹"></a>ç®€å•å®ä¾‹</h2><h3 id="socket"><a class="header-anchor" href="#socket"></a>socket</h3><ul><li>SocketServerDemo</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">val</span> socketDemo <span class="token operator">=</span> <span class="token function">SocketServerDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    socketDemo<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> SocketServerDemo <span class="token punctuation">&#123;</span>    <span class="token keyword">fun</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token function">ServerSocket</span><span class="token punctuation">(</span><span class="token number">9178</span><span class="token punctuation">)</span>        <span class="token comment">//accept()æ–¹æ³•æ˜¯é˜»å¡å¼çš„,ç›´åˆ°æœ‰è¯·æ±‚è¿›æ¥å»ºç«‹è¿æ¥</span>        <span class="token keyword">val</span> clientSocket <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> input <span class="token operator">=</span> <span class="token function">BufferedReader</span><span class="token punctuation">(</span><span class="token function">InputStreamReader</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> output <span class="token operator">=</span> <span class="token function">PrintWriter</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token keyword">var</span> request<span class="token operator">:</span> String<span class="token operator">?</span>        <span class="token keyword">var</span> response<span class="token operator">:</span> String<span class="token operator">?</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            request <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span>            <span class="token punctuation">&#125;</span>            response <span class="token operator">=</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>            output<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"å“åº”: <span class="token interpolation variable">$request</span>"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>SocketClientDemo</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">SocketClientDemo</span><span class="token punctuation">(</span>ip<span class="token operator">:</span> String<span class="token punctuation">,</span> port<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">Socket</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> output<span class="token operator">:</span> PrintWriter <span class="token operator">=</span> <span class="token function">PrintWriter</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> input<span class="token operator">:</span> BufferedReader <span class="token operator">=</span> <span class="token function">BufferedReader</span><span class="token punctuation">(</span><span class="token function">InputStreamReader</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">/**     * å‘é€æ¶ˆæ¯     */</span>    <span class="token keyword">fun</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">&#123;</span>        output<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>        <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * å…³é—­inputæµ     */</span>    <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">stopConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">val</span> socketClient <span class="token operator">=</span> <span class="token function">SocketClientDemo</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">9178</span><span class="token punctuation">)</span>    <span class="token function">println</span><span class="token punctuation">(</span>socketClient<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    socketClient<span class="token punctuation">.</span><span class="token function">stopConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡SocketClientDemoæ˜¯å®¢æˆ·ç«¯å‘æŒ‡å®šip/portå‘èµ·è¯·æ±‚,SocketServerDemoæ˜¯æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚å¹¶è¿›è¡Œå¤„ç†,å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯</p><ul><li>SocketServersä¸Šçš„accept()æ–¹æ³•ä¼šä¸€ç›´<B>é˜»å¡</B>åˆ°ä¸€ä¸ªè¿æ¥çš„å»ºç«‹,ç„¶ååœ¨è¿”å›ä¸€ä¸ªæ–°çš„socketç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡</li><li>BufferedReaderå’ŒPrintWriteréƒ½ç»§æ‰¿ä¸Socket,BufferedReaderæ˜¯ä»å­—ç¬¦è¾“å…¥æµä¸­è¯»å–æ–‡æœ¬,PrintWriteræ˜¯å¯¹æ–‡æœ¬æ ¼å¼åŒ–æ‰“å°åˆ°è¾“å‡ºæµä¸­</li><li>readLine()æ–¹æ³•æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•,è·³å‡ºé˜»å¡çš„æ–¹æ³•æ˜¯è¯»å–åˆ°ä¸€ä¸ªæ¢è¡Œç¬¦æˆ–å›è½¦ç¬¦ä¸ºæ­¢</li></ul><p>ä¼ ç»Ÿçš„socketç¼–ç¨‹æœ‰ä¸€ä¸‹å‡ ä¸ªç¼ºç‚¹:</p><ol><li>æœåŠ¡ç«¯å¤§é‡åˆ›å»ºçº¿ç¨‹ç­‰å¾…å“åº”</li><li>å†…å­˜å ç”¨é—®é¢˜</li><li>çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢é—®é¢˜<br>è¿™å‡ ä¸ªé—®é¢˜å…¶å®éƒ½æ˜¯ç”±äºä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªå“åº”å¯¼è‡´çš„,é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªå“åº”çš„æ–¹æ³•å˜›?<br>ç­”æ¡ˆæ˜¯æœ‰<B>NIO</B>çš„è§£å†³å¤„ç†æ–¹æ¡ˆ</li></ol><h3 id="åŸç”ŸNIO"><a class="header-anchor" href="#åŸç”ŸNIO"></a>åŸç”ŸNIO</h3><p>NIOåŸæŒ‡(New Input/Output)çš„è‹±æ–‡ç¼©å†™,ä½†æ˜¯ç”±äºè¿™ä¸ªAPIä¹Ÿå·²ç»å‡ºç°çš„å¾ˆä¹…äº†ä¸åœ¨New,ç°åœ¨ä¹Ÿå¯ä»¥æŒ‡çš„æ˜¯éé˜»å¡å¼(Non-blocking I/O)çš„IO<br>NIOçš„å‡ºç°æ˜¯ä¾èµ–äºæ“ä½œç³»ç»Ÿåº•å±‚çš„I/Oå¤šè·¯å¤ç”¨çš„æŠ€æœ¯è€Œæ¥,epoll()å¯ä»¥å‚è€ƒã€ŠScalable Event Multiplexing: epoll vs. kqueueã€‹<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p><h3 id="Nettyå®ä¾‹"><a class="header-anchor" href="#Nettyå®ä¾‹"></a>Nettyå®ä¾‹</h3><ul><li>NettyServer</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1. åˆå§‹åŒ–Bootstrap/boosGroup/workerGroup</span>    <span class="token keyword">val</span> serverBootstrap <span class="token operator">=</span> <span class="token function">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> boosGroup <span class="token operator">=</span> <span class="token function">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> workerGroup <span class="token operator">=</span> <span class="token function">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//2.è®¾ç½®å‰ç½®æ¡ä»¶</span>    serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>boosGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span>NioServerSocketChannel<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> ChannelInitializer<span class="token operator">&lt;</span>NioSocketChannel<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>ch<span class="token operator">:</span> NioSocketChannel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token function">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> SimpleChannelInboundHandler<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> ChannelHandlerContext<span class="token punctuation">,</span> msg<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æœåŠ¡ç«¯æ‰“å°<span class="token interpolation variable">$msg</span>"</span><span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token comment">//3. ç»‘å®šç«¯å£</span>        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">9178</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>NettyClient</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1. åˆå§‹åŒ–bootstrap/group</span>    <span class="token keyword">val</span> bootstrap <span class="token operator">=</span> <span class="token function">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> group <span class="token operator">=</span> <span class="token function">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//2. å‰ç½®å‡†å¤‡é˜¶æ®µ</span>    bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span>NioSocketChannel<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> ChannelInitializer<span class="token operator">&lt;</span>Channel<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>Exception<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>ch<span class="token operator">:</span> Channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token function">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token comment">//3. è®¾ç½®Channelçš„ç½‘ç»œè¿æ¥</span>    <span class="token keyword">val</span> channel<span class="token operator">:</span> Channel <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">9178</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//4. å‘é€æ•°æ®</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": hello world!"</span><span class="token punctuation">)</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NettyServerçš„å¯åŠ¨æµç¨‹</p><ul><li>åˆå§‹åŒ–Bootstrap/boosGroup/workerGroup</li><li>è®¾ç½®å‰ç½®æ¡ä»¶</li><li>ç»‘å®šç«¯å£</li></ul><p>NettyClientçš„å¯åŠ¨æµç¨‹</p><ul><li>åˆå§‹åŒ–bootstrap/group</li><li>å‰ç½®å‡†å¤‡é˜¶æ®µ</li><li>è®¾ç½®Channelçš„ç½‘ç»œè¿æ¥ä¿¡æ¯</li><li>å‘é€æ•°æ®</li></ul><p>å¯ä»¥çœ‹åˆ°åœ¨NettyServer/NettyClientä¸­éƒ½ä¼šæœ‰<B>Bootstrap</B>å’Œ<B>NioEventLoopGroup</B><br>NettyServerç«¯ä¸­NioEventLoopGroupè¿˜åˆ†ä¸º<B>boos</B>å’Œ<B>worker</B><br>NettyServerç«¯ä¸­çš„è¿˜ä¼šè®¾ç½®<B>ChildHandler</B>çš„ç›¸å…³å†…å®¹ä¹‹åä¼šè®²åˆ°</p><h2 id="Nettyç»„ä»¶"><a class="header-anchor" href="#Nettyç»„ä»¶"></a>Nettyç»„ä»¶</h2><p>Nettyçš„ç»„ä»¶ä¸»è¦æ˜¯åˆ†ä¸º<B>channel</B>ã€<B>å›è°ƒ</B>ã€<B>future</B>ã€<B>äº‹ä»¶å’ŒChannelHandler</B></p><ul><li><p>channel<br><B>channel</B>æ˜¯æ•°æ®çš„è½½ä½“ï¼Œå¯ä»¥æŠŠæ•°æ®çœ‹åšäººï¼Œchannelç±»æ¯”ä¸ºè½¦è¾†</p></li><li><p>å›è°ƒ<br>å›è°ƒæŒ‡çš„æ˜¯Nettyçš„ä¸€äº›ç½‘ç»œåŠ¨ä½œä¼šè§¦å‘æ¥å£<B>ChannelHandler</B>çš„å®ç°ï¼Œä¾‹å¦‚é€šé“å»ºç«‹è¿æ¥æ—¶ä¼šè§¦å‘çš„channelActive()æ–¹æ³•ç­‰</p></li><li><p>Future<br>FutureæŒ‡çš„æ˜¯æ“ä½œå®Œæˆåçš„ç»“æœç±»ä¼¼äºJUCä¸­çš„futureï¼ŒNettyä¸­ä¹Ÿè®¾è®¡äº†ä¸€ä¸ªé¡¶å±‚æ¥å£<B>ChannelFuture</B></p></li><li><p>äº‹ä»¶å’ŒChannelHandler<br>Nettyäº‹ä»¶æ˜¯ç”±åŠ¨ä½œè§¦å‘çš„ä¸»è¦æœ‰</p><ul><li>è¿æ¥å·²æ¿€æ´»/å¤±æ•ˆ</li><li>æ•°æ®è¯»å–</li><li>ç”¨æˆ·äº‹ä»¶</li><li>é”™è¯¯äº‹ä»¶</li><li>æ‰“å¼€/å…³é—­è¿œç¨‹èŠ‚ç‚¹è¿æ¥</li><li>å°†æ•°æ®å†™åˆ°channel</li></ul></li></ul><p><img src="https://i.loli.net/2021/11/18/kxJHG9MUN4nXypF.jpg" alt="äº‹ä»¶æ¨¡å‹"></p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>Nettyæ˜¯å¯¹NIOçš„å°è£…å’ŒæŠ½è±¡ï¼Œåœ¨æ“ä½œå¯¹è±¡ä¸ŠæŠ½è±¡å‡º<B>Future</B>ã€<B>å›è°ƒ</B>ã€<B>ChannelHandler</B>ï¼Œåœ¨æ“ä½œè¡Œä¸ºä¸ŠæŠ½è±¡å‡º<B>é€‰æ‹©å™¨</B>ã€<B>äº‹ä»¶</B>ã€<B>EventLoop</B>ç­‰æ¦‚å¿µ</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.baeldung.com/a-guide-to-java-sockets">java socketæŒ‡å—</a><br><a href="https://segmentfault.com/q/1010000018753423">channelReadä¸channelReadCompleteè¿›è¡Œå¯¹æ¯”</a></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://long-zhou.github.io/2012/12/21/epoll-vs-kqueue.html">Scalable Event Multiplexing: epoll vs. kqueue</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p></li></ol></section>]]></content>
      
      
      <categories>
          
          <category> Netty </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leafç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼IDç”Ÿæˆç³»ç»Ÿ</title>
      <link href="2020/07/12/1.%E6%9D%82%E8%AE%B0/Leaf%E7%BE%8E%E5%9B%A2%E7%82%B9%E8%AF%84%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%A0%94/"/>
      <url>2020/07/12/1.%E6%9D%82%E8%AE%B0/Leaf%E7%BE%8E%E5%9B%A2%E7%82%B9%E8%AF%84%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%A0%94/</url>
      
        <content type="html"><![CDATA[<h1>Leaf-ç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼IDç”Ÿæˆç³»ç»Ÿ</h1><p>leafä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼idç”Ÿæˆç³»ç»Ÿï¼Œä»£ç ç®€æ´ä¸”é«˜æ•ˆï¼Œç†è®ºæŒ‡å¯¼éƒ¨åˆ†ä¸º<a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leafâ€”â€”ç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼IDç”Ÿæˆç³»ç»Ÿ</a>,å·¥ç¨‹å®è·µä¸ºhttps://github.com/Meituan-Dianping/Leaf</p><h2 id="ç†è®º"><a class="header-anchor" href="#ç†è®º"></a>ç†è®º</h2><p>leafæä¾›äº†ä¸‰ç§æ–¹å¼çš„åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ¡ˆï¼š</p><ol><li>å§‹ç»ˆä¸º0</li><li>å·æ®µæ¨¡å¼</li><li>é›ªèŠ±ç®—æ³•æ¨¡å¼</li></ol><p>å·æ®µæ¨¡å¼é€šè¿‡æå‰è·å–å·æ®µæ¥ä¼˜åŒ–ç®—æ³•<br>é›ªèŠ±ç®—æ³•é€šè¿‡ç­‰å¾…æˆ–è¶…æ—¶å¼‚å¸¸çš„æ–¹å¼æ¥å¤„ç†æ—¶é’Ÿå›æ‹¨é—®é¢˜</p><h2 id="ä»£ç åˆ†æ"><a class="header-anchor" href="#ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h2><ul><li>SegmentIDGenImplå·æ®µæ¨¡å¼å®ç°</li></ul><ol><li>å¯¹å·æ®µè¿›è¡Œåˆå§‹åŒ–</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">SegmentBuffer</span> buffer <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">isInitOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">//ç”¨synchronizeé”ä½å³å°†è¿›è¡Œåˆå§‹åŒ–ä»buffer</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token comment">//å†æ¬¡æ ¡éªŒèµ„æºæ˜¯å¦ç¬¦åˆ</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">isInitOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                      <span class="token comment">//åˆå§‹åŒ–å·æ®µ</span>                      <span class="token function">updateSegmentFromDb</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Init buffer. Update leafkey &#123;&#125; &#123;&#125; from db"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      buffer<span class="token punctuation">.</span><span class="token function">setInitOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                      logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Init buffer &#123;&#125; exception"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">//åä¹‹ä»å·æ®µä¸­è·å–</span>      <span class="token keyword">return</span> <span class="token function">getIdFromSegmentBuffer</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>è·å–id</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getIdFromSegmentBuffer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SegmentBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è‡ªæ—‹</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            buffer<span class="token punctuation">.</span><span class="token function">rLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">final</span> <span class="token class-name">Segment</span> segment <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//åˆ¤æ–­æ˜¯å¦å ç”¨ä¸‹ä¸€ä¸ªå·æ®µ</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">isNextReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">getIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.9</span> <span class="token operator">*</span> segment<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">.</span><span class="token function">getThreadRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">//å¼‚æ­¥å¼€å¯å ç”¨ä¸‹ä¸€å·æ®µ</span>                    service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Segment</span> next <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">getSegments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>buffer<span class="token punctuation">.</span><span class="token function">nextPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                            <span class="token keyword">boolean</span> updateOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                                <span class="token function">updateSegmentFromDb</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>                                updateOk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"update segment &#123;&#125; from db &#123;&#125;"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" updateSegmentFromDb exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>updateOk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                    buffer<span class="token punctuation">.</span><span class="token function">wLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    buffer<span class="token punctuation">.</span><span class="token function">setNextReady</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    buffer<span class="token punctuation">.</span><span class="token function">getThreadRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    buffer<span class="token punctuation">.</span><span class="token function">wLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                                    buffer<span class="token punctuation">.</span><span class="token function">getThreadRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">&#125;</span>                            <span class="token punctuation">&#125;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//è·å–å€¼segment.getValueæ˜¯çº¿ç¨‹å®‰å…¨çš„AtomicLong</span>                <span class="token keyword">long</span> value <span class="token operator">=</span> segment<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> segment<span class="token punctuation">.</span><span class="token function">getMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                buffer<span class="token punctuation">.</span><span class="token function">rLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//ç­‰å¾…ï¼Œå†æ¬¡è·å–</span>            <span class="token function">waitAndSleep</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>            buffer<span class="token punctuation">.</span><span class="token function">wLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">final</span> <span class="token class-name">Segment</span> segment <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">long</span> value <span class="token operator">=</span> segment<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> segment<span class="token punctuation">.</span><span class="token function">getMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">isNextReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    buffer<span class="token punctuation">.</span><span class="token function">switchPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    buffer<span class="token punctuation">.</span><span class="token function">setNextReady</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Both two segments in &#123;&#125; are not ready!"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>EXCEPTION_ID_TWO_SEGMENTS_ARE_NULL<span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                buffer<span class="token punctuation">.</span><span class="token function">wLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>å¼‚æ­¥ä»æ•°æ®åº“ä¸­è·å–å·æ®µ</li></ol><ul><li>SnowflakeIDGenImplé›ªèŠ±ç®—æ³•å®ç°</li></ul><ol><li>åˆå§‹åŒ–</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**     * @param zkAddress zkåœ°å€     * @param port      snowflakeç›‘å¬ç«¯å£     * @param twepoch   èµ·å§‹çš„æ—¶é—´æˆ³     */</span>    <span class="token keyword">public</span> <span class="token class-name">SnowflakeIDGenImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> zkAddress<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">long</span> twepoch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>twepoch <span class="token operator">=</span> twepoch<span class="token punctuation">;</span>        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> twepoch<span class="token punctuation">,</span> <span class="token string">"Snowflake not support twepoch gt currentTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è·å–ç¬¬ä¸€ä¸ªç½‘å¡çš„ipåœ°å€</span>        <span class="token keyword">final</span> <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SnowflakeZookeeperHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnowflakeZookeeperHolder</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> zkAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>        LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"twepoch:&#123;&#125; ,ip:&#123;&#125; ,zkAddress:&#123;&#125; port:&#123;&#125;"</span><span class="token punctuation">,</span> twepoch<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> zkAddress<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å‘zkæ³¨å†Œæœºå™¨å’Œä¸´æ—¶èŠ‚ç‚¹</span>        <span class="token keyword">boolean</span> initFlag <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>initFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            workerId <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getWorkerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"START SUCCESS USE ZK WORKERID-&#123;&#125;"</span><span class="token punctuation">,</span> workerId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span>initFlag<span class="token punctuation">,</span> <span class="token string">"Snowflake Id Gen is not init ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span>workerId <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> workerId <span class="token operator">&lt;=</span> maxWorkerId<span class="token punctuation">,</span> <span class="token string">"workerID must gte 0 and lte 1023"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è·å–id</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Result</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å½“å‰æ—¶é—´</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¤„ç†æ—¶é’Ÿå›æ‹¨</span>            <span class="token keyword">long</span> offset <span class="token operator">=</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">;</span><span class="token comment">//æ—¶é’Ÿå›æ‹¨è¶…è¿‡5å°±è¿›è¡Œç­‰å¾…</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token function">wait</span><span class="token punctuation">(</span>offset <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¯å“åº”ä¸­æ–­çš„</span>                    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"wait interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTimestamp <span class="token operator">==</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> sequenceMask<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//seq ä¸º0çš„æ—¶å€™è¡¨ç¤ºæ˜¯ä¸‹ä¸€æ¯«ç§’æ—¶é—´å¼€å§‹å¯¹seqåšéšæœº</span>                sequence <span class="token operator">=</span> RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å¦‚æœæ—¶é—´ç›¸ç­‰å†…éƒ¨å°±è¿›è¡Œç­‰å¾…</span>                timestamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¦‚æœæ˜¯æ–°çš„mså¼€å§‹</span>            sequence <span class="token operator">=</span> RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>        <span class="token comment">//è®¡ç®—id</span>        <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> twepoch<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> timestampLeftShift<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> workerIdShift<span class="token punctuation">)</span> <span class="token operator">|</span> sequence<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> guava </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç³»ç»Ÿä¸šåŠ¡ç›‘æ§çš„æ€è€ƒ</title>
      <link href="2020/07/06/1.%E6%9D%82%E8%AE%B0/%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E7%9B%91%E6%8E%A7%E7%9A%84%E6%80%9D%E8%80%83/"/>
      <url>2020/07/06/1.%E6%9D%82%E8%AE%B0/%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E7%9B%91%E6%8E%A7%E7%9A%84%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç³»ç»Ÿä¸šåŠ¡ç›‘æ§ï¼Œä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†è®©å†…éƒ¨äººå‘˜å¯ä»¥æ›´æ¸…æ¥šå½“å‰ç³»ç»Ÿçš„ä¸šåŠ¡è¿è¡ŒçŠ¶æ€ã€‚å®ƒå’Œç³»ç»Ÿè¿è¡Œçº§çš„ç›‘æ§åˆ†åˆ«ä»£è¡¨çš„ä¸€ä¸ªæ˜¯ä¸šåŠ¡ç»´åº¦çš„ç›‘æ§ã€ä¸€ä¸ªæ˜¯ç³»ç»Ÿèµ„æºç»´åº¦çš„ç›‘æ§ï¼Œå…³æ³¨çš„ç‚¹ä¸ä¸€æ ·ã€‚ä¸šåŠ¡ç›‘æ§å¤æ‚çš„ç‚¹åœ¨äºç›‘æ§ç­–ç•¥ä¸ä¸šåŠ¡å¼ºå…³è”å¹¶ä¸”æ•°æ®å‡†ç¡®æ€§è¦æ±‚è¾ƒé«˜ã€‚ä»¥ä¸‹æ ¹æ®å¤§ä½¬ä»¬çš„æ€è€ƒæ•´ç†å‡ºçš„ç¬”è®°</p></blockquote><h2 id="èƒŒæ™¯"><a class="header-anchor" href="#èƒŒæ™¯"></a>èƒŒæ™¯</h2><blockquote><p>éœ€è¦è®¾è®¡ä¸€ä¸ªå¯æ‰©å±•å¹¶ä¸”èƒ½å¤Ÿå¿«é€Ÿå®ç°èƒ½æ”¯æŒä¸šåŠ¡ä»»åŠ¡ä½¿ç”¨å†³ç­–çš„ä¸šåŠ¡ç›‘æ§ç³»ç»Ÿ</p></blockquote><h3 id="èŒƒå›´"><a class="header-anchor" href="#èŒƒå›´"></a>èŒƒå›´</h3><p>è®¾å®šè¯¥ç›‘æ§ç³»ç»Ÿé€‚ç”¨èŒƒå›´ä¸ºsaasåŒ–é‡‘èè¡Œä¸šä½é¢‘ä¸šåŠ¡å±æ€§ä¸‹çš„æ™¯ã€‚æƒ³è¦é€šè¿‡è¯¥ç³»ç»Ÿå®ç°ï¼š</p><ol><li>ç›‘æ§ä¸šåŠ¡æ•°æ®å¹¶ä¸”å¯¹ä¸šåŠ¡å¼‚å¸¸è¿›è¡Œå‘Šè­¦</li><li>å¯¹ä¸šåŠ¡æ•°æ®è¿›è¡Œæ±‡æ€»å½¢æˆæ ‡å‡†åŒ–çš„å¯¹æ¥å¼€å‘å¹³å°</li></ol><h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰"></a>å®šä¹‰</h3><ul><li>ä¸“æœ‰åç§°<br>â€¦</li></ul><h3 id="ç°çŠ¶"><a class="header-anchor" href="#ç°çŠ¶"></a>ç°çŠ¶</h3><p>â€¦</p><h2 id="è®¾è®¡æ€è·¯"><a class="header-anchor" href="#è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h2><ol><li>å°†åº•å±‚æ•°æ®ç»“æ„ä¸ä¸šåŠ¡è§„åˆ™å‰¥ç¦»å¼€ï¼Œç±»ä¼¼äºæ¡¥æ¥æ¨¡å¼çš„è®¾è®¡</li></ol><h2 id="è¯¦ç»†è®¾è®¡"><a class="header-anchor" href="#è¯¦ç»†è®¾è®¡"></a>è¯¦ç»†è®¾è®¡</h2><h3 id="æ€»ä½“æ¦‚è§ˆ"><a class="header-anchor" href="#æ€»ä½“æ¦‚è§ˆ"></a>æ€»ä½“æ¦‚è§ˆ</h3><h3 id="ä¸šåŠ¡ä¸€"><a class="header-anchor" href="#ä¸šåŠ¡ä¸€"></a>ä¸šåŠ¡ä¸€</h3><p>ä»‹ç»ä¸šåŠ¡çš„åŠŸèƒ½</p><ol><li>è¾“å…¥</li></ol><ul><li>ä¸šåŠ¡çš„è¾“å…¥å‚æ•°</li></ul><ol start="2"><li>è¾“å‡º</li></ol><ul><li>ä¸šåŠ¡çš„è¾“å‡ºå‚æ•°</li></ul><ol start="3"><li>ä¸šåŠ¡æµ</li></ol><p>ä¸šåŠ¡æµç¨‹ï¼Œå†…éƒ¨å¤„ç†é€»è¾‘ï¼Œéæ ¸å¿ƒä¸šåŠ¡çš„å¯ä»¥çœç•¥ï¼›è¿™é‡Œå¯ä»¥ç”¨æµç¨‹å›¾æ¥æè¿°</p><ol start="4"><li>å…¶å®ƒ</li></ol><p>å¯ä»¥å†™ä¸€ä¸‹æ³¨æ„äº‹é¡¹</p><h3 id="å­˜å‚¨è®¾è®¡"><a class="header-anchor" href="#å­˜å‚¨è®¾è®¡"></a>å­˜å‚¨è®¾è®¡</h3><p>è¿™é‡Œå­˜å‚¨ä¸»è¦åœ¨æ•°æ®åº“ä¸Šé¢ï¼ˆè¿™éƒ¨åˆ†æ ¹æ®é‡ç‚¹ï¼Œæœ‰çš„é¡¹ç›®é‡ç‚¹åœ¨ç¼“å­˜ä¸Šï¼Œæœ‰äº›åœ¨æ–‡ä»¶ä¸Šï¼‰ï¼Œæ•°æ®åº“å»ºè®®è¿™é‡Œå†™æ¸…æ¥šï¼šæ•°æ®åº“çš„å»ºè¡¨è¯­å¥å’Œæ ¸å¿ƒæŸ¥è¯¢SQLã€‚</p><h3 id="é™çº§ä¸é¢„æ¡ˆ"><a class="header-anchor" href="#é™çº§ä¸é¢„æ¡ˆ"></a>é™çº§ä¸é¢„æ¡ˆ</h3><p>è¿™éƒ¨åˆ†ä¸»è¦æè¿°ï¼Œå½“æˆ‘ä»¬çš„æ­£å¸¸ä¸šåŠ¡ä¸å¯ç”¨ã€ä½¿ç”¨è¶…å‡ºç³»ç»Ÿé™åˆ¶çš„æ—¶å€™ï¼Œä¼šå¦‚ä½•ååº”ã€‚è¿™éƒ¨åˆ†å¯ä»¥åˆ†åœºæ™¯ï¼ˆåˆ†æƒ…å†µï¼‰æ¥æè¿°ï¼Œè®²æ¸…æ¥šå³å¯ã€‚</p><h3 id="éƒ¨ç½²ä¸è¿ç»´"><a class="header-anchor" href="#éƒ¨ç½²ä¸è¿ç»´"></a>éƒ¨ç½²ä¸è¿ç»´</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹å¯ä»¥çœç•¥ã€‚å¦‚æœæ¶‰åŠåˆ°è·¨ç³»ç»Ÿè°ƒç”¨ã€ä¸­é—´ä»¶ï¼Œè¿™é‡Œå»ºè®®æœ‰ä¸€ä¸ªéƒ¨ç½²å›¾ï¼Œå¹¶æè¿°æ¸…æ¥šï¼Œå“ªäº›æ˜¯æ°´å¹³æ‰©å®¹ã€å“ªäº›æ˜¯ä¸»å¤‡æ–¹å¼ã€‚</p><h2 id="é™„å½•"><a class="header-anchor" href="#é™„å½•"></a>é™„å½•</h2><h3 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p>è¡¥å……ææ–™å¯ä»¥æè¿°ï¼Œæˆ‘ä»¬åœ¨åšè°ƒç ”çš„è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°çš„ä¸€äº›å‚è€ƒèµ„æ–™ï¼ˆå¯ä»¥æ˜¯ä¹¦ã€æ–‡ç« ã€è®ºæ–‡ï¼‰</p><h3 id="å…¶ä»–èµ„æ–™"><a class="header-anchor" href="#å…¶ä»–èµ„æ–™"></a>[å…¶ä»–èµ„æ–™]</h3><p>å¦å¤–ï¼Œæœ‰ä¸€äº›ä¸æ–¹ä¾¿åœ¨å‰é¢æå†™çš„ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œå†™ä¸€å†™ï¼Œæ¯”å¦‚ï¼šé”™è¯¯ç¼–å·</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä¸šåŠ¡ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†å¸ƒå¼ä¸­çš„ä¸€è‡´æ€§paxosç®—æ³•ä»¥åŠå…¶å®ç°zabåè®®</title>
      <link href="2020/06/23/1.%E6%9D%82%E8%AE%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7paxos%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0zab%E5%8D%8F%E8%AE%AE/"/>
      <url>2020/06/23/1.%E6%9D%82%E8%AE%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7paxos%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0zab%E5%8D%8F%E8%AE%AE/</url>
      
        <content type="html"><![CDATA[<h1>åˆ†å¸ƒå¼ä¸­çš„ä¸€è‡´æ€§paxosç®—æ³•ä»¥åŠå…¶å®ç°zabåè®®</h1><p>åˆ†å¸ƒå¼æœ€é‡è¦çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è§£å†³ï¼Œä¸åŒèŠ‚ç‚¹ä¸­æ•°æ®çš„ä¸€è‡´æ€§ã€‚paxosç®—æ³•å°±æ˜¯æœ€é‡è¦çš„è§£å†³è¿™ä¸ªé—®é¢˜çš„ç†è®ºã€‚</p><h2 id="paxosåŸºç¡€"><a class="header-anchor" href="#paxosåŸºç¡€"></a>paxosåŸºç¡€</h2><h3 id="Quorumæœºåˆ¶"><a class="header-anchor" href="#Quorumæœºåˆ¶"></a>Quorumæœºåˆ¶</h3><blockquote><p>Quorumæœºåˆ¶æ˜¯è¡¨ç¤ºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œåªè¦å¤§äºæ€»æ•°-è¢«ä¿®æ”¹æ•°æ—¶ï¼Œå°±èƒ½è¯»åˆ°ä¿®æ”¹å€¼</p></blockquote><p>Quorumæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨æ¥ä¿è¯æ•°æ®å†—ä½™å’Œæœ€ç»ˆä¸€è‡´æ€§çš„æŠ•ç¥¨ç®—æ³•ã€‚Quorumæœºåˆ¶ä¸æ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§çš„ï¼Œæ— æ³•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¯»å–åˆ°æœ€æ–°çš„æ•°æ®ï¼Œéœ€è¦ä¸€ä¸ªç±»ä¼¼äºç‰ˆæœ¬å·çš„æœåŠ¡æ¥ç¡®å®šè·å–åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„ã€‚</p><h3 id="paxosç®—æ³•ä¸­å®šä¹‰çš„å‚ä¸è€…è§’è‰²"><a class="header-anchor" href="#paxosç®—æ³•ä¸­å®šä¹‰çš„å‚ä¸è€…è§’è‰²"></a>paxosç®—æ³•ä¸­å®šä¹‰çš„å‚ä¸è€…è§’è‰²</h3><ul><li>proposer ææ¡ˆè€…</li><li>acceptor æ‰¹å‡†è€…</li><li>learner å­¦ä¹ è€…</li></ul><h3 id="paxosç®—æ³•çš„æµç¨‹"><a class="header-anchor" href="#paxosç®—æ³•çš„æµç¨‹"></a>paxosç®—æ³•çš„æµç¨‹</h3><ol><li><p>å‡†å¤‡é˜¶æ®µ<br>proposerææ¡ˆè€…å‘acceptoræ‰¹å‡†è€…å‘é€ä¸€ä¸ªå½“å‰ææ¡ˆè€…æœ€å¤§çš„ProposallID,acceptoræ‰¹å‡†è€…æ”¶åˆ°ProposallIDåï¼Œå°†ä¸è‡ªå·±çš„maxIdè¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·ä¼šäº§ç”Ÿä¸‰ç§ç»“æœ</p><ol><li>å›å¤æ•°é‡ä¸­å¤§äºä¸€åŠçš„èŠ‚ç‚¹è¿”å›çš„éƒ½æ˜¯ç©ºï¼Œææ¡ˆè€…ç›´æ¥å‘æ‰¹å‡†è€…å‘é€<strong>æ›´æ”¹</strong></li><li>å›å¤æ•°é‡ä¸­å¤§äºä¸€åŠçš„èŠ‚ç‚¹è¿”å›çš„ä¸æ˜¯ç©ºï¼Œææ¡ˆè€…ç›´æ¥å‘æ‰¹å‡†è€…å‘é€<strong>è‡ªå·±æœ€å¤§çš„proposallID</strong>å’Œ<strong>æ›´æ”¹</strong></li><li>å›å¤æ•°é‡ä¸­å°äºä¸€åŠçš„èŠ‚ç‚¹ï¼Œææ¡ˆè€…é‡æ–°è¿›å…¥å‡†å¤‡é˜¶æ®µ</li></ol></li><li><p>é€‰ä¸¾é˜¶æ®µ</p></li></ol><p>proposerææ¡ˆè€…å‘acceptoræ‰¹å‡†è€…å‘é€ä¸€ä¸ª__(proposallId,å˜æ›´)__ï¼Œacceptoræ¥å—åˆ°ä¹‹åä¼šæ¯”è¾ƒmaxIdæ˜¯å¦è¿›è¡Œæ›´æ–°æ“ä½œï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ææ¡ˆè€…ã€‚è¿™æ ·åˆäº§ç”Ÿäº†ä¸‰ç§ç»“æœï¼š<br>1. å¤§äºä¸€åŠçš„èŠ‚ç‚¹è¿”å›æ›´æ–°æˆåŠŸï¼Œè¿›è¡Œå…¨å±€å¹¿æ’­å†™å…¥æˆåŠŸ,å­¦ä¹ è€…è¿›è¡Œæ›´æ”¹<br>2. å°äºä¸€åŠçš„èŠ‚ç‚¹æ—¶æ—¶ï¼Œé‡æ–°è¿›å…¥å‡†å¤‡é˜¶æ®µ<br>3. å½“æ”¶åˆ°ä¸€æ¡æäº¤å¤±è´¥æ—¶ï¼Œè¯´æ˜æœ‰å…¶ä»–çš„æäº¤è€…è¿›è¡Œäº†æäº¤ï¼Œå› æ­¤é‡æ–°è¿›å…¥å‡†å¤‡é˜¶æ®µ</p><h3 id="paxosç®—æ³•çš„å¸¸è§é—®é¢˜"><a class="header-anchor" href="#paxosç®—æ³•çš„å¸¸è§é—®é¢˜"></a>paxosç®—æ³•çš„å¸¸è§é—®é¢˜</h3><ol><li>proposalIdæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</li></ol><blockquote><p>é€šè¿‡ç±»ä¼¼äºç‰ˆæœ¬å·çš„proposalId,å°†å½“å‰æ›´æ”¹å’Œç‰ˆæœ¬è¿›è¡Œå…³è”ï¼Œç‰ˆæœ¬å·å¤§çš„å¯ä»¥æ›¿ä»£ç‰ˆæœ¬å·å°çš„æ›´æ”¹</p></blockquote><h2 id="Zabç®—æ³•"><a class="header-anchor" href="#Zabç®—æ³•"></a>Zabç®—æ³•</h2><p>Zabåè®®æ˜¯zkç”¨æ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡æœ€ç»ˆä¸€è‡´æ€§çš„çš„paxosç®—æ³•çš„å·¥ç¨‹å®è·µï¼Œå…¶æ”¯æŒå´©æºƒæ¢å¤</p><p>zabåè®®çš„å…·ä½“å®ç°å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š<br>pk</p><ul><li>æ¶ˆæ¯å¹¿æ’­é˜¶æ®µ</li></ul><blockquote><p>LeaderèŠ‚ç‚¹æ¥å—æ›´æ”¹ï¼Œå†é€šçŸ¥ä»èŠ‚ç‚¹ï¼Œæœ€åè¿›è¡Œcommit</p></blockquote><ul><li>å´©æºƒæ¢å¤é˜¶æ®µ</li></ul><blockquote><p>å½“LeaderèŠ‚ç‚¹å®•æœºï¼Œä¼šè¿›å…¥å´©æºƒæ¢å¤é˜¶æ®µï¼Œé‡æ–°è¿›è¡ŒLeaderé€‰ä¸¾</p></blockquote><h3 id="Zxid"><a class="header-anchor" href="#Zxid"></a>Zxid</h3><p><strong>Zxid</strong>æ˜¯zabåè®®ä¸­çš„ä¸€ä¸ªäº‹åŠ¡ç¼–å·ï¼Œç”±64ä½æ•°å­—ç»„æˆï¼Œå…¶ä¸­ä½32ä½æ˜¯ä¸€ä¸ªç®€å•çš„å•è°ƒé€’å¢è®¡æ•°å™¨ï¼Œé«˜32ä½è¡¨ç¤ºleaderèŠ‚ç‚¹çš„å”¯ä¸€ä»»èŒå‘¨æœŸã€‚</p><h3 id="zabçš„å…·ä½“æµç¨‹"><a class="header-anchor" href="#zabçš„å…·ä½“æµç¨‹"></a>zabçš„å…·ä½“æµç¨‹</h3><h4 id="æ¶ˆæ¯å¹¿æ’­é˜¶æ®µ"><a class="header-anchor" href="#æ¶ˆæ¯å¹¿æ’­é˜¶æ®µ"></a>æ¶ˆæ¯å¹¿æ’­é˜¶æ®µ</h4><p>æ¶ˆæ¯å¹¿æ’­é˜¶æ®µä¸»è¦æ˜¯åˆ†ä¸º</p><ol><li><strong>leader</strong>èŠ‚ç‚¹å°†æ“ä½œåˆ†é…ä¸€ä¸ªzidï¼Œå°è£…æˆä¸€ä¸ªäº‹åŠ¡ï¼Œæ”¾åˆ°å¯¹åº”çš„followerèŠ‚ç‚¹å¯¹åº”çš„é˜Ÿåˆ—ä¸­</li><li>å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ°å¯¹åº”çš„followerèŠ‚ç‚¹ï¼Œè¿”å›ç›¸åº”çš„ACKæ¶ˆæ¯åˆ°leaderèŠ‚ç‚¹</li><li>leaderèŠ‚ç‚¹æ ¹æ®followerèŠ‚ç‚¹è¿”å›çš„æ¶ˆæ¯è¿›è¡Œæ“ä½œï¼Œè¿‡åŠè¿›è¡Œ<strong>å¹¿æ’­äº‹åŠ¡çš„æäº¤</strong></li></ol><h4 id="å´©æºƒæ¢å¤é˜¶æ®µ"><a class="header-anchor" href="#å´©æºƒæ¢å¤é˜¶æ®µ"></a>å´©æºƒæ¢å¤é˜¶æ®µ</h4><p>å¯èƒ½å¯¼è‡´è¿›å…¥å´©æºƒæ¢å¤é˜¶æ®µçš„æƒ…å†µæœ‰ï¼š</p><ol><li>åˆå§‹åŒ–é›†ç¾¤</li><li>leaderå´©æºƒ</li><li>leaderå¤±å»åŠæ•°ä»¥ä¸Šçš„æœºå™¨</li></ol><p>zkä¸­çš„èŠ‚ç‚¹ä¸€å…±æœ‰ä¸‰ç§çŠ¶æ€</p><table><thead><tr><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>following</td><td>ä»å±èŠ‚ç‚¹</td></tr><tr><td>leading</td><td>leaderèŠ‚ç‚¹ï¼Œè´Ÿè´£åè°ƒ</td></tr><tr><td>election/looking</td><td>å¤„äºå€™é€‰çŠ¶æ€</td></tr></tbody></table><ul><li>é€‰ä¸¾çš„è§„åˆ™<br>å€™é€‰èŠ‚ç‚¹é¦–å…ˆåœ¨ç¬¬ä¸€æ¬¡æŠ•ç¥¨ä¸­å…ˆå°†è‡ªå·±æŠ•ä¸ºleanderï¼Œç„¶åå°†æ¶ˆæ¯å¹¿æ’­å‡ºå»ã€‚å…¶ä»–çš„å€™é€‰èŠ‚ç‚¹æ¥å—åˆ°æ¶ˆæ¯åè¿›è¡Œé€‰ä¸¾å¤„ç†ã€‚<br>é€‰ä¸¾å¤„ç†å°±æ˜¯ï¼š</li></ul><ol><li>é¦–å…ˆé€‰ä¸¾ epoch æœ€å¤§çš„</li><li>å¦‚æœ epoch ç›¸ç­‰ï¼Œåˆ™é€‰ zxid æœ€å¤§çš„</li><li>è‹¥ epoch å’Œ zxid éƒ½ç›¸ç­‰ï¼Œåˆ™é€‰æ‹© server id æœ€å¤§çš„ï¼Œå°±æ˜¯é…ç½® zoo.cfg ä¸­çš„ myid</li><li>æœ€åå¾—å‡ºæœ€ç»ˆç»“æœï¼Œæ”¹å˜å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ã€‚é€‰ä¸¾ç»“æŸã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> paxosç®—æ³• </tag>
            
            <tag> zabåè®® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Šjava8å®æˆ˜ã€‹è¯»ä¹¦ç¬”è®°</title>
      <link href="2020/06/20/1.%E6%9D%82%E8%AE%B0/%E3%80%8Ajava8%E5%AE%9E%E6%88%98%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
      <url>2020/06/20/1.%E6%9D%82%E8%AE%B0/%E3%80%8Ajava8%E5%AE%9E%E6%88%98%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1>ã€Šjava8å®æˆ˜ã€‹è¯»ä¹¦ç¬”è®°</h1><p>ä¸»è¦æ˜¯å…³äºjava8çš„ä¸€äº›ç¬”è®°ã€‚</p><h2 id="åŸºç¡€"><a class="header-anchor" href="#åŸºç¡€"></a>åŸºç¡€</h2><h3 id="java8ä¸­è®¾è®¡çš„ä¸‰ä¸ªç¼–ç¨‹æ¦‚å¿µ"><a class="header-anchor" href="#java8ä¸­è®¾è®¡çš„ä¸‰ä¸ªç¼–ç¨‹æ¦‚å¿µ"></a>java8ä¸­è®¾è®¡çš„ä¸‰ä¸ªç¼–ç¨‹æ¦‚å¿µ</h3><ol><li><strong>æµå¤„ç†</strong></li><li><strong>å‡½æ•°ä¼ é€’</strong></li><li>å¹¶è¡Œä¸å…±äº«çš„å¯å˜æ•°æ®</li></ol><h3 id="å‡½æ•°ä¼ é€’"><a class="header-anchor" href="#å‡½æ•°ä¼ é€’"></a>å‡½æ•°ä¼ é€’</h3><blockquote><p>è¡Œä¸ºå‚æ•°åŒ–(å‡½æ•°ä¼ é€’)å°±æ˜¯å¯ä»¥å¸®åŠ©ä½ å¤„ç†é¢‘ç¹å˜æ›´çš„éœ€æ±‚çš„ä¸€ç§è½¯ä»¶å¼€å‘æ¨¡å¼</p></blockquote><ul><li>ä¾‹1:ç”¨Comparatoræ¥æ’åº</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ls <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Comparatorè¿›è¡Œæ’åº</span>ls<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> i1<span class="token punctuation">,</span><span class="token class-name">Integer</span> i2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token operator">-</span>i1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>i2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ä¾‹2:ç”¨Runableæ‰§è¡Œä»£ç å—</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ls <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Comparatorè¿›è¡Œæ’åº</span>ls<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> i1<span class="token punctuation">,</span><span class="token class-name">Integer</span> i2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token operator">-</span>i1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>i2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="lambdaè¡¨è¾¾å¼"><a class="header-anchor" href="#lambdaè¡¨è¾¾å¼"></a>lambdaè¡¨è¾¾å¼</h3><p>ä¸»è¦è®°å½•ä¸€ä¸‹<strong>anyMatch</strong>ã€<strong>allMatch</strong>ã€<strong>noneMatch</strong>ã€<strong>findAny</strong></p><ul><li><strong>anyMatch</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> intList <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…¨éƒ¨å¤§äº</span><span class="token keyword">if</span><span class="token punctuation">(</span>intList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-></span> item <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"lsé›†åˆå­˜åœ¨å¤§äº4çš„æ•°å­—!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å­˜åœ¨å¤§äº</span><span class="token keyword">if</span><span class="token punctuation">(</span>intList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-></span> item <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"lsé›†åˆå­˜åœ¨å¤§äº5çš„æ•°å­—!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>findAny</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> optional <span class="token operator">=</span> intList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>findAny</strong>è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯è¿”å›çš„æ˜¯steamæµä¸­çš„æŸä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸ä¸€å®šæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚åœ¨ä¸²è¡Œçš„æƒ…å†µä¸‹å¯èƒ½è¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä½†æ˜¯ä¸ä¿è¯å¹¶è¡Œçš„æƒ…å†µä¸‹ä»ç„¶æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</p><h3 id="Optional"><a class="header-anchor" href="#Optional"></a>Optional</h3><blockquote><p>Optional<T>ç±»ï¼ˆjava.util.Optionalï¼‰æ˜¯ä¸€ä¸ªå®¹å™¨ç±»ï¼Œä»£è¡¨ä¸€ä¸ªå€¼å­˜åœ¨æˆ–ä¸å­˜åœ¨ã€‚</p></blockquote><ul><li><p>isPresent<br>è¡¨ç¤ºå¦‚æœå…ƒç´ å­˜åœ¨è¿”å›trueï¼Œåä¹‹è¿”å›false</p></li><li><p>ifPresent<br>è¡¨ç¤ºå¦‚æœå…ƒç´ å­˜åœ¨æ‰§è¡Œæ–¹æ³•,ä¸å­˜åœ¨ä¸æ‰§è¡Œ</p></li><li><p>get<br>ç‰¹åˆ«è¦æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨ä¸å­˜åœ¨å€¼çš„æƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸</p></li><li><p>orElse()<br>å½“å€¼ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›é»˜è®¤å€¼</p></li></ul><h3 id="reduceæ“ä½œ"><a class="header-anchor" href="#reduceæ“ä½œ"></a>reduceæ“ä½œ</h3><blockquote><p>åˆå¹¶æ“ä½œ</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> reduceSumls <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç¬¬ä¸€ç§å†™æ³•</span><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> sum <span class="token operator">=</span> reduceSumls<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> a<span class="token punctuation">,</span> <span class="token class-name">Integer</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> a <span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç¬¬äºŒç§å†™æ³•</span><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> sum <span class="token operator">=</span> reduceSumls<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"reduceSum = "</span> <span class="token operator">+</span> sum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java8 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gradleçš„å®‰è£…ä¸ä½¿ç”¨</title>
      <link href="2020/06/16/1.%E6%9D%82%E8%AE%B0/gradle%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>2020/06/16/1.%E6%9D%82%E8%AE%B0/gradle%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1>gradleçš„å®‰è£…ä¸ä½¿ç”¨</h1><blockquote><p>ç”±äºæ–°çš„é¡¹ç›®å¤§å¤šæ˜¯ä½¿ç”¨gradleè¿›è¡Œä¾èµ–ç®¡ç†ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†å…¶ç”¨æ³•åšä¸€ä¸‹æ€»ç»“</p></blockquote><h2 id="å®‰è£…"><a class="header-anchor" href="#å®‰è£…"></a>å®‰è£…</h2><p>ä¸»è¦æ­¥éª¤æ˜¯ï¼š</p><ol><li>ä¸‹è½½å®‰è£…åŒ…</li><li>é…ç½®ç¯å¢ƒå˜é‡</li><li>æŸ¥çœ‹ç‰ˆæœ¬å·</li></ol><blockquote><p>gradle -v</p></blockquote><ul><li>æ˜¾ç¤ºå¯¹åº”ç‰ˆæœ¬å·è¡¨ç¤ºå®‰è£…æˆåŠŸ<br><img src="https://s1.ax1x.com/2020/06/16/NkXXFA.png" alt="NkXXFA.png"></li></ul><h2 id="åŸºç¡€çŸ¥è¯†"><a class="header-anchor" href="#åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>gradleæ˜¯ä¸€ä¸ªåŸºäºAntå’ŒMavençš„ç†å¿µçš„é¡¹ç›®è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·ã€‚åŸºäºGroovyçš„ç‰¹å®šé¢†åŸŸè¯­è¨€ï¼ˆDSLï¼‰æ¥å£°æ˜é¡¹ç›®è®¾ç½®ã€‚</p><h3 id="gradleä¸mavençš„å¯¹æ¯”"><a class="header-anchor" href="#gradleä¸mavençš„å¯¹æ¯”"></a>gradleä¸mavençš„å¯¹æ¯”</h3><ol><li>çµæ´»æ€§æ›´é«˜</li><li>æ€§èƒ½æ›´å¥½</li><li>ä¾èµ–ç®¡ç†</li></ol><h3 id="gradleæ„å»ºç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#gradleæ„å»ºç”Ÿå‘½å‘¨æœŸ"></a>gradleæ„å»ºç”Ÿå‘½å‘¨æœŸ</h3><p>gradleæ„å»ºç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ†ä¸ºï¼š<strong>åˆå§‹åŒ–</strong>ã€<strong>é…ç½®</strong>ã€<strong>è¿è¡Œ</strong>ä¸‰ä¸ªé˜¶æ®µ</p><p><img src="https://s1.ax1x.com/2020/06/20/NQ6IOg.png" alt="NQ6IOg.png"></p><ol><li>åˆå§‹åŒ–é˜¶æ®µ<br>æ­¤é˜¶æ®µè¯»å–æ ¹ç›®å½•ä¸‹çš„<strong>setting.gradle</strong>ä¸­çš„includeä¿¡æ¯ï¼Œæ¥å†³å®šæ„å»ºå“ªäº›å·¥ç¨‹ã€‚ä»¥springä¸ºä¾‹</li></ol><pre class="line-numbers language-Groovy" data-language="Groovy"><code class="language-Groovy">## çœç•¥è‹¥å¹²é¡¹ç›®include &quot;spring-websocket&quot;include &quot;spring-framework-bom&quot;&#x2F;&#x2F; Exposes gradle buildSrc for IDE supportinclude &quot;buildSrc&quot;rootProject.children.find&#123; it.name &#x3D;&#x3D; &quot;buildSrc&quot; &#125;.name &#x3D; &quot;spring-build-src&quot;rootProject.name &#x3D; &quot;spring&quot;rootProject.children.each &#123;project -&gt;project.buildFileName &#x3D; &quot;$&#123;project.name&#125;.gradle&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>é…ç½®é˜¶æ®µ<br>æ­¤é˜¶æ®µä¸»è¦è§£ææ¯ä¸ªé¡¹ç›®ä¸­çš„<strong>build.gradle</strong>é…ç½®æ–‡ä»¶ã€<strong>å¤„ç†ä¾èµ–å…³ç³»</strong>ã€<strong>æ‰§è¡Œé¡ºåº</strong><br>ä»¥<strong>spring beans</strong>å’Œ<strong>spring-core</strong>ä¸¤ä¸ªé¡¹ç›®ä¸ºä¾‹</li></ol><ul><li><strong>spring-beans</strong>çš„gradleæ–‡ä»¶</li></ul><pre class="line-numbers language-Groovy" data-language="Groovy"><code class="language-Groovy">&#x2F;&#x2F;æœ¬é¡¹ç›®çš„æè¿°description &#x3D; &quot;Spring Beans&quot;&#x2F;&#x2F;æ’ä»¶apply plugin: &quot;groovy&quot;&#x2F;&#x2F;ä¾èµ–å…³ç³»dependencies &#123;    &#x2F;&#x2F;ä¾èµ–åŒä¸€ä¸ªé¡¹ç›®ä¸‹çš„spring-coreæ¨¡å—compile(project(&quot;:spring-core&quot;))    &#x2F;&#x2F;&quot;javax.inject:javax.inject:1&quot;ç­‰åŒä¸pomæ–‡ä»¶    &#x2F;&#x2F;&lt;dependency&gt;    &#x2F;&#x2F; &lt;groupId&gt;javax.inject&lt;&#x2F;groupId&gt;    &#x2F;&#x2F; &lt;artifactId&gt;javax.inject&lt;&#x2F;artifactId&gt;    &#x2F;&#x2F; &lt;version&gt;1&lt;&#x2F;version&gt;    &#x2F;&#x2F; &lt;scope&gt;compile&lt;&#x2F;scope&gt;    &#x2F;&#x2F;&lt;&#x2F;dependency&gt;optional(&quot;javax.inject:javax.inject:1&quot;)optional(&quot;org.yaml:snakeyaml:1.20&quot;)    optional(&quot;org.codehaus.groovy:groovy-all:$&#123;groovyVersion&#125;&quot;)optional(&quot;org.jetbrains.kotlin:kotlin-reflect:$&#123;kotlinVersion&#125;&quot;)optional(&quot;org.jetbrains.kotlin:kotlin-stdlib:$&#123;kotlinVersion&#125;&quot;)    &#x2F;&#x2F;åªä¼šåœ¨æµ‹è¯•æœŸé—´å­˜åœ¨testCompile(&quot;org.apache.tomcat.embed:tomcat-embed-core:$&#123;tomcatVersion&#125;&quot;)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>spring-core</strong>çš„gradleæ–‡ä»¶</li></ul><pre class="line-numbers language-Groovy" data-language="Groovy"><code class="language-Groovy">dependencies &#123;    &#x2F;&#x2F;çœç•¥...cglib(&quot;cglib:cglib:$&#123;cglibVersion&#125;@jar&quot;)objenesis(&quot;org.objenesis:objenesis:$&#123;objenesisVersion&#125;@jar&quot;)jarjar(&quot;com.googlecode.jarjar:jarjar:1.3&quot;)    &#x2F;&#x2F;çœç•¥...compile(files(cglibRepackJar))compile(project(&quot;:spring-jcl&quot;))optional(&quot;io.netty:netty-buffer&quot;)testCompile(&quot;com.fasterxml.woodstox:woodstox-core:5.0.3&quot;) &#123;exclude group: &quot;stax&quot;, module: &quot;stax-api&quot;&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>è¿è¡Œé˜¶æ®µ</li></ol><blockquote><p>æ ¹æ®Gradleå‘½ä»¤ä¼ é€’è¿‡æ¥çš„ä»»åŠ¡åç§°ï¼Œæ‰§è¡Œç›¸å…³ä¾èµ–ä»»åŠ¡ã€‚æ­¤é˜¶æ®µçœŸæ­£æ„å»ºé¡¹ç›®å¹¶æ‰§è¡Œé¡¹ç›®ä¸‹çš„å„ä¸ªä»»åŠ¡ã€‚Gradleå°±ä¼šå°†è¿™ä¸ªä»»åŠ¡é“¾ä¸Šçš„æ‰€æœ‰ä»»åŠ¡å…¨éƒ¨æŒ‰ä¾èµ–é¡ºåºæ‰§è¡Œä¸€éã€‚</p></blockquote><h3 id="gradleæ’ä»¶"><a class="header-anchor" href="#gradleæ’ä»¶"></a>gradleæ’ä»¶</h3><h3 id="taskçš„æ¦‚å¿µ"><a class="header-anchor" href="#taskçš„æ¦‚å¿µ"></a>taskçš„æ¦‚å¿µ</h3><p><strong>gradle</strong>æ˜¯é€šè¿‡taskä»»åŠ¡çš„æ¨¡å‹è¿›è¡Œé©±åŠ¨å¼€å‘çš„ï¼Œåœ¨ä¸€ä¸ªgradleå·¥ç¨‹ä¸­å°†ä¸åŒçš„æ„å»ºå·¥ä½œæ‰“æ•£æˆä¸åŒçš„taskã€‚taskè„šæœ¬é‡‡ç”¨Groovyè¯­è¨€è¿›è¡Œç¼–å†™ã€‚</p><ul><li>taskå®šä¹‰ç¤ºä¾‹</li></ul><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">task helloword &#123;    println &#39;hello word!&#39;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>taskä¾èµ–ç¤ºä¾‹</li></ul><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">&#x2F;&#x2F;taskæ˜¾å¼è°ƒç”¨ task task1 &#123;       println &#39;hello word!&#39; &#125; task task2 &#123;     println &#39;hello task2!&#39; &#125; task1.dependsOn task2 &#x2F;&#x2F;taskå†…ä¾èµ– task task3(dependsOn: task2) &#123;     println &#39;hello task3!&#39; &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è·³è¿‡ä¾èµ–</li></ul><pre class="line-numbers language-Gradle" data-language="Gradle"><code class="language-Gradle">compile.doFirst &#123;    &#x2F;&#x2F; Here you would put arbitrary conditions in real life.    &#x2F;&#x2F; But this is used in an integration test so we want defined behavior.    if (true) &#123; throw new StopExecutionException() &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Gradleç”³æ˜ä¾èµ–"><a class="header-anchor" href="#Gradleç”³æ˜ä¾èµ–"></a>Gradleç”³æ˜ä¾èµ–</h3><h3 id="é…ç½®è¿œç¨‹ä»“åº“"><a class="header-anchor" href="#é…ç½®è¿œç¨‹ä»“åº“"></a>é…ç½®è¿œç¨‹ä»“åº“</h3><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">repositories &#123;   maven &#123;      url &quot;http:&#x2F;&#x2F;repo.mycompany.com&#x2F;maven2&quot;   &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åŸºç¡€å‘½ä»¤"><a class="header-anchor" href="#åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h2><ul><li>build ç¼–è¯‘å‘½ä»¤</li></ul><blockquote><p>./gradlew build --scan</p></blockquote><p>è¡¨ç¤ºç¼–è¯‘é¡¹ç›®å¹¶ä¸Šä¼ ç›¸åº”çš„ç¼–è¯‘æ•°æ®åˆ°äº‘ç«¯è¿›è¡Œåˆ†æï¼Œæœ¬åœ°åˆ†æçš„å‘½ä»¤æ˜¯</p><blockquote><p>./gradlew clean app:assembleDebug --profile<br>è¯¥å‘½ä»¤ä¼šåœ¨<strong>build/report</strong>ä¸­ç”Ÿæˆå¯¹åº”çš„æŠ¥å‘Š</p></blockquote><ul><li>gradle  build</li></ul><blockquote><p>gradle  build<br> ç¼–è¯‘ï¼ˆç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¿›è¡Œå•å…ƒæµ‹è¯•ï¼‰</p></blockquote><ul><li>gradle test</li></ul><blockquote><p>gradle test <br> å•å…ƒæµ‹è¯•</p></blockquote><ul><li>gradle test</li></ul><blockquote><p>gradle build -x test <br> ç¼–è¯‘æ—¶è·³è¿‡å•å…ƒæµ‹è¯•</p></blockquote><ul><li>gradle run</li></ul><blockquote><p>gradle run <br> ç›´æ¥è¿è¡Œé¡¹ç›®</p></blockquote><ul><li>gradle clean</li></ul><blockquote><p>gradle clean æ¸…ç©ºæ‰€æœ‰ç¼–è¯‘ã€æ‰“åŒ…ç”Ÿæˆçš„æ–‡ä»¶(å³ï¼šæ¸…ç©ºbuildç›®å½•)</p></blockquote><h2 id="build-gradleæ¨¡æ¿"><a class="header-anchor" href="#build-gradleæ¨¡æ¿"></a>build.gradleæ¨¡æ¿</h2><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">&#x2F;&#x2F; åˆ›å»ºJavaé¡¹ç›®æ’ä»¶ï¼Œæä¾›äº†æ‰€æœ‰æ„å»ºå’Œæµ‹è¯•Javaç¨‹åºæ‰€éœ€é¡¹ç›®ç»“æ„apply plugin: &#39;java&#39;&#x2F;&#x2F; å¼•å…¥Mavenæ’ä»¶ï¼Œä»¥ä¾¿Gradleå¯ä»¥å¼•ç”¨Mavenä»“åº“çš„JaråŒ…apply plugin: &#39;maven&#39;&#x2F;&#x2F; è¿›è¡Œæ‰“åŒ…æ’ä»¶apply plugin: &#39;war&#39;&#x2F;&#x2F; Webé¡¹ç›®æœåŠ¡å™¨æ’ä»¶,æ­¤å¤„é…ç½®åï¼Œä¸éœ€å†å•ç‹¬é…ç½®WebæœåŠ¡å™¨apply plugin: &#39;jetty&#39;&#x2F;&#x2F; Webé¡¹ç›®å¼€å‘æ’ä»¶apply plugin: &#39;eclipse&#39;group &#x3D; &quot;com.suneee&quot;&#x2F;&#x2F; æŒ‡å®šç¼–è¯‘*.javaæ–‡ä»¶çš„JDKç‰ˆæœ¬sourceCompatibility &#x3D; 1.8version &#x3D; &#39;1.0&#39;&#x2F;&#x2F; Webé¡¹ç›®ç¤ºä¾‹å·¥ç¨‹jar &#123;    manifest &#123;        attributes &#39;Implementation-Title&#39;: &#39;Gradle Quickstart&#39;, &#39;Implementation-Version&#39;: version        &#x2F;&#x2F; é¢˜å¤–è¯ï¼šJavaé¡¹ç›®ï¼Œæ­¤å¤„å¯ä»¥ç”¨æ¥é…ç½®ç¨‹åºå…¥å£ç‚¹        &#x2F;&#x2F; attributes &#39;Main-Class&#39;:&#39;com.suneee.**&#39;    &#125;&#125;&#x2F;&#x2F; é»˜è®¤æƒ…å†µï¼ŒGradleæ²¡æœ‰å®šä¹‰ä»»ä½•èµ„æºåº“repositories &#123;    &#x2F;&#x2F; ä½¿ç”¨Mavençš„ä¸­å¤®å­˜å‚¨åº“    mavenCentral()    &#x2F;&#x2F; ä½¿ç”¨Mavençš„æœ¬åœ°å­˜å‚¨åº“    mavenLocal()&#125;&#x2F;&#x2F; å¢åŠ è‡ªå®šä¹‰çš„åº“repositories &#123;    flatDir&#123;            &#x2F;&#x2F; é¡¹ç›®ç›®å½•ä¸‹çš„libæ–‡ä»¶å¤¹            dirs &#39;lib&#39;         &#125;&#125;&#x2F;&#x2F; è§£å†³Gradleç¼–è¯‘æ—¶å‡ºç°ï¼š ç¼–ç GBKçš„ä¸å¯æ˜ å°„å­—ç¬¦[compileJava, compileTestJava]*.options*.encoding &#x3D; &#39;UTF-8&#39;&#x2F;&#x2F; è§£å†³é¡¹ç›®JaråŒ…ä¾èµ–é—®é¢˜dependencies &#123;    &#x2F;&#x2F; ç¼–è¯‘æ—¶ï¼ŒåŠ å…¥é¡¹ç›®ç›®å½•ä¸‹libæ–‡ä»¶    compile fileTree(dir:&#39;lib&#39;,include:&#39;*.jar&#39;)    compile &#39;c3p0:c3p0:0.9.1.2&#39;    compile &#39;mysql:mysql-connector-java:5.1.31&#39;     compile &#39;org.springframework.data:spring-data-redis:1.3.4.RELEASE&#39;    compile group: &#39;com.google.code.gson&#39;, name: &#39;gson&#39;, version: &#39;2.7&#39;    compile group: &#39;commons-collections&#39;, name: &#39;commons-collections&#39;, version: &#39;3.2&#39;    testCompile &quot;org.springframework:spring-test:4.1.0.RELEASE&quot;    testCompile group: &#39;junit&#39;, name: &#39;junit&#39;, version: &#39;4.+&#39;    compile &#39;com.alibaba:dubbo:2.8.4a&#39;    compile &#39;org.apache.zookeeper:zookeeper:3.4.8&#39;    compile &#39;com.101tec:zkclient:0.8&#39;    compile &#39;log4j:log4j:1.2.17&#39;    compile group: &#39;javax.activation&#39;, name: &#39;activation&#39;, version: &#39;1.1.1&#39;    compile group: &#39;javax.mail&#39;, name: &#39;mail&#39;, version: &#39;1.4.7&#39;    compile group: &#39;org.quartz-scheduler&#39;, name: &#39;quartz&#39;, version: &#39;1.7.2&#39;    compile group: &#39;aspectj&#39;, name: &#39;aspectjweaver&#39;, version: &#39;1.5.4&#39;    compile group: &#39;org.hibernate&#39;, name: &#39;hibernate-core&#39;, version: &#39;5.1.0.Final&#39;    compile group: &#39;org.hibernate&#39;, name: &#39;hibernate-entitymanager&#39;, version: &#39;5.1.0.Final&#39;    compile group: &#39;org.springframework&#39;, name: &#39;spring-orm&#39;, version: &#39;4.2.4.RELEASE&#39;    &#125;test &#123;    systemProperties &#39;property&#39;: &#39;value&#39;&#125;&#x2F;&#x2F; å‘å¸ƒé¡¹ç›®å¯¼å‡ºçš„JaråŒ…åˆ°æŒ‡å®šä»“åº“uploadArchives &#123;    repositories &#123;       flatDir &#123;           dirs &#39;repos&#39;       &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><ul><li>æŸ¥çœ‹task</li></ul><blockquote><p>gradle task</p></blockquote><ul><li>ç¼–è¯‘-ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¿›è¡Œå•å…ƒæµ‹è¯•</li></ul><blockquote><p>gradle build</p></blockquote><ul><li>å•å…ƒæµ‹è¯•</li></ul><blockquote><p>gradle test</p></blockquote><ul><li>ç¼–è¯‘æ—¶è·³è¿‡å•å…ƒæµ‹è¯•</li></ul><blockquote><p>gradle build -x test</p></blockquote><ul><li>ç›´æ¥è¿œè¡Œé¡¹ç›®</li></ul><blockquote><p>gradle run</p></blockquote><ul><li>æ¸…ç©ºbuildæ–‡ä»¶</li></ul><blockquote><p>gradle clean</p></blockquote><ul><li>å®‰è£…jaråˆ°mavenä»“åº“</li></ul><blockquote><p>gradle install</p></blockquote><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://gradle.org/release-candidate/">å®˜æ–¹ä¸‹è½½åœ°å€</a><br><a href="https://www.cnblogs.com/shaloo/p/6096277.html">Gradleå­¦ä¹ ç¬”è®°</a><br><a href="https://www.cnblogs.com/NyanKoSenSei/p/11458953.html">Gradleçš„å®‰è£…ä¸é…ç½®</a><br><a href="https://www.cnblogs.com/lucas1024/p/9533566.html">ã€å…¥é—¨ã€‘Gradleçš„åŸºæœ¬ä½¿ç”¨ã€åœ¨IDEAä¸­çš„é…ç½®ã€å¸¸ç”¨å‘½ä»¤</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gradle </tag>
            
            <tag> ç¼–è¯‘å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœ€é•¿å…¬å…±å‰ç¼€_LeetCode08</title>
      <link href="2020/06/14/13.LeetCode/8.%E6%9C%80%E9%95%BF%E5%85%AC%E5%85%B1%E5%89%8D%E7%BC%80/"/>
      <url>2020/06/14/13.LeetCode/8.%E6%9C%80%E9%95%BF%E5%85%AC%E5%85%B1%E5%89%8D%E7%BC%80/</url>
      
        <content type="html"><![CDATA[<h1>æœ€é•¿å…¬å…±å‰ç¼€_LeetCode08</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥æŸ¥æ‰¾å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„æœ€é•¿å…¬å…±å‰ç¼€ã€‚<br>å¦‚æœä¸å­˜åœ¨å…¬å…±å‰ç¼€ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸² â€œâ€ã€‚</p><ul><li>ç¤ºä¾‹ 1:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: [&quot;flower&quot;,&quot;flow&quot;,&quot;flight&quot;]è¾“å‡º: &quot;fl&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 2:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: [&quot;dog&quot;,&quot;racecar&quot;,&quot;car&quot;]è¾“å‡º: &quot;&quot;è§£é‡Š: è¾“å…¥ä¸å­˜åœ¨å…¬å…±å‰ç¼€ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><b>è¯´æ˜:</b></p><blockquote><p>æ‰€æœ‰è¾“å…¥åªåŒ…å«å°å†™å­—æ¯ a-z ã€‚</p></blockquote><h2 id="è§£é¢˜æ€è·¯"><a class="header-anchor" href="#è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h2><ul><li>æ ¹æ®å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ä¸²ä¾æ¬¡æ¯”è¾ƒå‰ç¼€æ˜¯å¦ç›¸åŒï¼Œä»è€Œå¾—åˆ°æœ€é•¿å…¬å…±å‰ç¼€çš„é•¿åº¦ã€‚</li></ul><h2 id="ä»£ç "><a class="header-anchor" href="#ä»£ç "></a>ä»£ç </h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//1.å…ˆæ‰¾åˆ°æœ€çŸ­å­—ç¬¦ä¸²</span>        <span class="token keyword">int</span> minLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> strs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                minLength <span class="token operator">=</span> strs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>minLength <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> minLength <span class="token operator">></span> strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                minLength <span class="token operator">=</span> strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>minLength <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token comment">//2.æ ¹æ®æœ€çŸ­çš„å­—ç¬¦ä¸²æ¥è¿›è¡Œä¾æ¬¡å¾ªç¯åˆ¤æ–­</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> minLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Character</span> currentChar <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>j <span class="token operator">&lt;</span> strs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>currentChar <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    currentChar <span class="token operator">=</span> strs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>currentChar<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                lastIndex<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>lastIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> strs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®˜æ–¹æ€è·¯"><a class="header-anchor" href="#å®˜æ–¹æ€è·¯"></a>å®˜æ–¹æ€è·¯</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">longestCommonPrefix1</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>strs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> prefix <span class="token operator">=</span> strs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            prefix <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prefix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> prefix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®˜æ–¹è§£é¢˜æ€è·¯æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡Œå±•ç¤ºç¬¬ä¸€ç§æ„Ÿè§‰ååˆ†å·§å¦™ã€‚</p><ol><li>è·å–åˆ°æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²</li><li>ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å’Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²ç›¸äº’æ¯”è¾ƒï¼Œé€šè¿‡<strong>indexOf</strong>å¾—å‡ºç”¨ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‰ç¼€æ˜¯å¦æ»¡è¶³ã€‚ä»è€Œå¾—åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å’Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€å­—ç¬¦ä¸²</li><li>åœ¨å°†ç¬¬ä¸‰ä¸ªå­—ç¬¦ä¸²æ‹¿æ¥å’Œå…¬å…±å­—ç¬¦ä¸²å‰ç¼€ä½œä¸ºå¯¹æ¯”ï¼Œä»è€Œå¾—åˆ°è¿™æ¬¡è®¡ç®—ä»¥åçš„å…¬å…±å­—ç¬¦ä¸²</li></ol><p><img src="https://s1.ax1x.com/2020/06/14/tzNyfx.png" alt="tzNyfx.png"></p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlåŸºç¡€çŸ¥è¯†</title>
      <link href="2020/06/12/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/7.mysql%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>2020/06/12/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/7.mysql%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h1>mysqlåŸºç¡€çŸ¥è¯†</h1><p>æ”¶è—äº<strong>ä¸‰å¤ªå­æ•–ä¸™</strong>çš„<a href="https://mp.weixin.qq.com/s/NDL1Q6nqdPq5oMBWSpq4ug">æ•°æ®åº“åŸºç¡€çŸ¥è¯†</a><br>è¿™ä¸ªå…¬ä¼—å·çš„åŸåˆ›æ–‡ç« éå¸¸ä¸é”™ï¼Œå€¼å¾—æ¨è</p><ul><li>mysqlçš„æ‰§è¡Œæµç¨‹<br><img src="https://s1.ax1x.com/2020/06/11/tHCWtA.md.png" alt="tHCWtA.png"></li></ul><p>ä¸»è¦åˆ†ä¸ºä¸€ä¸‹å‡ ä¸ªæµç¨‹:</p><ul><li>è¿æ¥å™¨</li><li>æŸ¥è¯¢ç¼“å­˜</li><li>åˆ†æå™¨</li><li>ä¼˜åŒ–å™¨</li><li>æ‰§è¡Œå™¨</li><li>æ‰§è¡Œå¼•æ“</li></ul><h2 id="è¿æ¥å™¨"><a class="header-anchor" href="#è¿æ¥å™¨"></a>è¿æ¥å™¨</h2><p>è¿æ¥å™¨æ˜¯è´Ÿè´£å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ç†è¿æ¥çš„ã€‚TCPè¿æ¥æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬çš„è¿æ¥æ˜¯å¤„äºç©ºé—²çŠ¶æ€çš„ï¼Œå¯ä»¥é€šè¿‡æ¥æŸ¥çœ‹è¿æ¥çŠ¶æ€</p><blockquote><p>show processlist<br><img src="https://s1.ax1x.com/2020/06/11/tbZsEV.png" alt="tbZsEV.png"></p></blockquote><p>ä¹Ÿå¯ä»¥æŸ¥çœ‹æœåŠ¡ç«¯è®¾ç½®çš„è¶…æ—¶è¿‡æœŸæ—¶é—´</p><blockquote><p>SHOW VARIABLES LIKE â€˜%timeout%â€™;<br><img src="https://s1.ax1x.com/2020/06/11/tbZbCD.png" alt="tbZbCD.png"></p></blockquote><p><strong>interactive_timeout</strong>ä¸ºè¿æ¥è¶…æ—¶æ—¶é—´,é»˜è®¤æ˜¯28800ç§’ä¹Ÿå°±æ˜¯8ä¸ªå°æ—¶</p><h2 id="æŸ¥è¯¢ç¼“å­˜"><a class="header-anchor" href="#æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h2><p>mysqlä¸­çš„ç¼“å­˜æ˜¯æŒ‰ç…§key-valueçš„å½¢å¼åœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€å—ä¸“é—¨çš„å†…å­˜åŒºåŸŸæ¥ç»´æŠ¤ç¼“å­˜æ•°æ®;æŸ¥è¯¢çš„æ—¶å€™å…ˆç”¨sqlå­—ç¬¦ä¸²å»ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œå¦‚æœèƒ½å‘½ä¸­å°±ç›´æ¥è¿”å›ç»“æœï¼Œå¦‚æœä¸èƒ½å‘½ä¸­å°±æ‰§è¡Œåé¢çš„æ“ä½œã€‚</p><p>mysqlç¼“å­˜åªè¦å…³è”è¡¨çš„ç»“æ„æˆ–æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œéƒ½ä¼šæ¸…ç©ºç¼“å­˜ä¸­çš„æ•°æ®</p><ul><li>é€‚ç”¨åœºæ™¯</li></ul><blockquote><p>é€‚ç”¨äºå†™å°‘è¯»å¤šçš„åœºæ™¯ï¼Œä¾‹å¦‚å­—å…¸è¡¨ç­‰</p></blockquote><p>ps:ç”±äºç¼“å­˜çš„å­˜åœ¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¬¬ä¸€æ¬¡æŸ¥è¯¢åçš„æ‰§è¡Œæ—¶é—´å’Œç¬¬ä¸€æ¬¡ä¸ä¸€æ ·ï¼Œå¯ä»¥ç”¨<strong>SQL_NO_CACHE</strong>æ¥å–æ¶ˆæŸ¥è¯¢ç¼“å­˜</p><blockquote><p>SELECT SQL_NO_CACHE * FROM t_user ORDER BY id DESC;</p></blockquote><h2 id="è¯­æ³•åˆ†æ"><a class="header-anchor" href="#è¯­æ³•åˆ†æ"></a>è¯­æ³•åˆ†æ</h2><p>è¯­æ³•åˆ†æä¸»è¦æ˜¯å°†å®¢æˆ·ç«¯ä¼ å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œsqlè¯­æ³•å±‚é¢çš„è§£æ</p><h2 id="ä¼˜åŒ–å™¨"><a class="header-anchor" href="#ä¼˜åŒ–å™¨"></a>ä¼˜åŒ–å™¨</h2><p>ä¼˜åŒ–å™¨ä¸»è¦æ˜¯åˆ†æåœ¨æŸ¥è¯¢æ—¶ï¼Œé‚£ä¸ªç´¢å¼•ä½œä¸ºæœ€ä¼˜ç´¢å¼•,ç„¶åæŒ‰ç…§ä¸€å®šåŸåˆ™æ¥å¾—åˆ°å®ƒè®¤ä¸ºçš„ç›®æ ‡SQLåœ¨å½“å‰æƒ…å½¢ä¸‹æœ€æœ‰æ•ˆçš„<strong>æ‰§è¡Œè·¯å¾„</strong>,ä¼˜åŒ–å™¨çš„ç›®çš„æ˜¯ä¸ºäº†<strong>å¾—åˆ°</strong>ç›®æ ‡SQLçš„<strong>æ‰§è¡Œè®¡åˆ’</strong>ã€‚</p><ul><li><p><strong>æŒ‡å®šç´¢å¼•å­—æ®µ</strong></p></li><li><p>force index(idx_name)</p></li></ul><blockquote><p>å¼ºåˆ¶æŒ‡å®šç”¨ä¼ å…¥çš„ç´¢å¼•å­—æ®µ</p></blockquote><ul><li>ignore index(idx_name)</li></ul><blockquote><p>å¼ºåˆ¶æŒ‡å®šå¿½ç•¥ä¼ å…¥çš„ç´¢å¼•å­—æ®µ</p></blockquote><ul><li>use index(idx_name)</li></ul><blockquote><p>æ¨èä½¿ç”¨ä¼ å…¥çš„ç´¢å¼•å­—æ®µ,æœ€åç”±mysqlå†³å®šæ˜¯ä¸æ˜¯ç”¨è¯¥ç´¢å¼•</p></blockquote><blockquote><p>use index : æ˜¯å»ºè®®MySQLå»ä½¿ç”¨è¿™ä¸ªç´¢å¼•.æœ€ååˆ°åº•æ˜¯ç”¨ä¸ç”¨, è¿˜æ˜¯ç”±MySQLæ¥å†³å®š.<br> å¦‚æœMySQLè¿˜æ˜¯è§‰å¾—å…¨è¡¨æ‰«ææ¥å¾—å¿«, é‚£å³ä½¿æ˜¯æœ‰ç´¢å¼•, å®ƒè¿˜æ˜¯ä¼šä½¿ç”¨å…¨è¡¨æ‰«æã€‚<br>force index : æ˜¯å¼ºåˆ¶MySQLå»ä½¿ç”¨è¿™ä¸ªç´¢å¼•. å¦‚æœç”¨ä¸ä¸Š, å°±å…¨è¡¨. å¦‚æœèƒ½ç”¨ä¸Š, å°±ä¸€å®šä¼šä½¿ç”¨è¯¥ç´¢å¼•.</p></blockquote><h2 id="æ‰§è¡Œå™¨"><a class="header-anchor" href="#æ‰§è¡Œå™¨"></a>æ‰§è¡Œå™¨</h2><p>æ‰§è¡Œè®¡åˆ’ï¼Œå°±æ˜¯ä¸€æ¡SQLè¯­å¥ï¼Œåœ¨æ•°æ®åº“ä¸­å®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€æ­¥æ­¥çš„åˆ†åˆ«éƒ½åšäº†ä»€ä¹ˆã€‚å¯ä»¥é€šè¿‡<strong>explain</strong>æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’<br>å…·ä½“æ¯ä¸ªå­—æ®µçš„å«ä¹‰å¯ä»¥çœ‹å‚è€ƒæ–‡ç« </p><h2 id="æ‰§è¡Œå¼•æ“"><a class="header-anchor" href="#æ‰§è¡Œå¼•æ“"></a>æ‰§è¡Œå¼•æ“</h2><p>mysqlè½¯ä»¶çš„æ¶æ„è®¾è®¡æ˜¯ä¸Šå±‚æ­¥éª¤ç›¸åŒï¼Œåº•å±‚æ‰§è¡Œå¼•æ“å¯ä»¥æœ‰å¤šä¸ªé€‰æ‹©ï¼Œå¸¸ç”¨çš„æ‰§è¡Œå¼•æ“æœ‰<strong>InnoDB</strong>ã€<strong>MyISAM</strong>ã€‚<br>ä¸åŒçš„æ‰§è¡Œå¼•æ“ä¼šäº§ç”Ÿä¸åŒçš„å­˜å‚¨æ ¼å¼ä»¥åŠæ–‡ä»¶ã€‚</p><p><img src="https://segmentfault.com/img/bVbvl5j?w=1721&amp;h=1056" alt="æ‰§è¡Œå¼•æ“åŒºåˆ«"></p><ul><li>InnoDBä¸MyISAMçš„åŒºåˆ«</li></ul><table><thead><tr><th>-</th><th>ç´¢å¼•æ–¹å¼</th><th>é»˜è®¤å¼•æ“ç‰ˆæœ¬</th><th>ç®€è¿°</th></tr></thead><tbody><tr><td>MyISAMå¼•æ“</td><td>éèšé›†ç´¢å¼•æ–¹å¼</td><td>5.5ç‰ˆæœ¬ä¹‹å‰</td><td>æ€§èƒ½æä½³ï¼Œä½†å´ä¸æ”¯æŒäº‹åŠ¡å¤„ç†ï¼ˆtransactionï¼‰</td></tr><tr><td>INNODBå¼•æ“</td><td>èšé›†ç´¢å¼•æ–¹å¼</td><td>5.5ç‰ˆæœ¬</td><td>å’ŒMyISAMç›¸æ¯”ï¼Œå®ƒæ”¯æŒACIDå…¼å®¹çš„äº‹åŠ¡</td></tr></tbody></table><p><strong>æ‰§è¡Œå¼•æ“</strong>æ˜¯æœ€åå…·ä½“å®æ–½æ‰§è¡Œè®¡åˆ’çš„æ¨¡å—ï¼Œæ ¹æ®ä¸åŒçš„æ•°æ®è¡¨æ‰€éœ€è¦çš„æ•°æ®ç‰¹æ€§ä¸åŒï¼Œå› æ­¤å®é™…è¿›è¡Œå®æ–½æ—¶ä¼šäº§ç”Ÿä¸åŒçš„æ–‡ä»¶ä»¥åŠä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼ŒæŠŠè¿™äº›æ”¾åœ¨ä¸€èµ·å°±æ˜¯ä¸åŒçš„æ‰§è¡Œå¼•æ“ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://stackoverflow.com/questions/20797475/mysql-force-index-vs-use-index">mysql-force-index-vs-use-index</a><br><a href="https://emacsist.github.io/emacsist.github.io/2016/07/15/mysql%E4%B8%ADuse-index-%E5%92%8C-force-index/">MySQLä¸­USE INDEX å’Œ FORCE INDEX</a><br><a href="https://blog.csdn.net/weixin_43740552/article/details/102623930">mysql use indexã€ignore indexã€force indexç”¨æ³•</a><br><a href="http://gxg353.blog.sohu.com/232999339.html">MySQLçš„show global variables like â€œ%timeout%â€</a></p><p><a href="https://blog.csdn.net/weixin_41558728/article/details/81704916">MysqlæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’</a></p>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDKç±»åŠ è½½æœºåˆ¶</title>
      <link href="2020/06/10/12.JVM/3.JDK%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"/>
      <url>2020/06/10/12.JVM/3.JDK%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1>jdkçš„ç±»åŠ è½½æœºåˆ¶</h1><h2 id="ç±»åŠ è½½çš„è¿‡ç¨‹"><a class="header-anchor" href="#ç±»åŠ è½½çš„è¿‡ç¨‹"></a>ç±»åŠ è½½çš„è¿‡ç¨‹</h2><p><a href="https://imgchr.com/i/t7kEid"><img src="https://s1.ax1x.com/2020/06/10/t7kEid.png" alt="t7kEid.png"></a></p><p>ç±»åŠ è½½ä¸»è¦åˆ†ä¸ºï¼š</p><p><strong>åŠ è½½</strong> -&gt; <strong>éªŒè¯</strong> -&gt; <strong>å‡†å¤‡</strong> -&gt; <strong>è§£æ</strong> -&gt; <strong>åˆå§‹åŒ–</strong></p><ul><li>åŠ è½½</li></ul><blockquote><p>åŠ è½½çš„ä¸»è¦ä½œç”¨æ˜¯å°†å¤–éƒ¨çš„ .class æ–‡ä»¶ï¼ŒåŠ è½½åˆ° Java çš„æ–¹æ³•åŒºå†…</p></blockquote><ul><li>éªŒè¯</li></ul><blockquote><p>éªŒè¯classæ–‡ä»¶ï¼Œæ˜¯å¦ç¬¦åˆjvmè™šæ‹Ÿæœºçš„è§„èŒƒ</p></blockquote><ul><li>å‡†å¤‡</li></ul><blockquote><p>ç±»å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼</p></blockquote><p><img src="https://s1.ax1x.com/2020/06/10/t7mcSH.png" alt="t7mcSH.png"></p><p>ç±»å˜é‡åœ¨å‡†å¤‡é˜¶æ®µå°±è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œä½†æ˜¯åœ¨æ–¹æ³•å†…éƒ¨å®šä¹‰çš„å˜é‡ä¸ä¼šåœ¨å‡†å¤‡é˜¶æ®µè¿›è¡Œåˆå§‹åŒ–ï¼Œå› æ­¤ideæç¤ºå±€éƒ¨å˜é‡æœªè¿›è¡Œ</p><ul><li>è§£æ<br>è§£ææ˜¯å°†ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚ç¬¦å·å¼•ç”¨æ˜¯ä¸€ç§å®šä¹‰ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢ä¸Šçš„å«ä¹‰ï¼Œè€Œç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡ã€‚ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</li><li>ç±»æˆ–æ¥å£çš„è§£æ</li><li>ç±»æ–¹æ³•è§£æ</li><li>æ¥å£æ–¹æ³•è§£æ</li><li>å­—æ®µè§£æ</li></ul><p>å‡ ä¸ªç»å¸¸å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå°±ä¸è¿™ä¸ªé˜¶æ®µæœ‰å…³</p><ul><li>java.lang.NoSuchFieldError æ ¹æ®ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šï¼Œæ‰¾ä¸åˆ°ç›¸å…³å­—æ®µæ—¶çš„æŠ¥é”™</li><li>java.lang.IllegalAccessError å­—æ®µæˆ–è€…æ–¹æ³•ï¼Œè®¿é—®æƒé™ä¸å…·å¤‡æ—¶çš„é”™è¯¯</li><li>java.lang.NoSuchMethodError æ‰¾ä¸åˆ°ç›¸å…³æ–¹æ³•æ—¶çš„é”™è¯¯</li></ul><p>è§£æè¿‡ç¨‹ä¿è¯äº†ç›¸äº’å¼•ç”¨çš„å®Œæ•´æ€§ï¼ŒæŠŠç»§æ‰¿ä¸ç»„åˆæ¨è¿›åˆ°è¿è¡Œæ—¶</p><ul><li>åˆå§‹åŒ–<br>å…ˆæ¥çœ‹ä¸€ç«¯ä»£ç </li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        b <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>b = b + 1;ç”±äºb + 1ä¸­bä¸­æ˜¯å˜é‡ï¼Œåœ¨é™æ€ä»£ç å—ä¸­æ— æ³•å¼•ç”¨</p></blockquote><ul><li><p><strong>static è¯­å¥å—ï¼Œåªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨ static è¯­å¥å—ä¹‹å‰çš„å˜é‡</strong></p></li><li><p><strong>JVM ä¼šä¿è¯åœ¨å­ç±»çš„åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œçˆ¶ç±»çš„åˆå§‹åŒ–æ–¹æ³•å·²ç»æ‰§è¡Œå®Œæ¯•</strong></p></li></ul><h2 id="ç±»åŠ è½½å™¨"><a class="header-anchor" href="#ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h2><p>ç±»åŠ è½½å™¨æ‰€åšçš„äº‹æƒ…å°±å°†classæ–‡ä»¶è¿›è¡Œè§£æï¼ŒåŠ è½½åˆ°jvmçš„æ–¹æ³•åŒºï¼›ä¸»è¦åˆ†ä¸º<strong>Bootstrap ClassLoader</strong>ã€<strong>Extention ClassLoader</strong>ã€<strong>App ClassLoader</strong>ã€<strong>Custom ClassLoader</strong></p><ul><li><p>Bootstrap ClassLoader<br>ç”¨äºåŠ è½½<strong>åŠ è½½æ ¸å¿ƒç±»åº“</strong>ä¹Ÿå°±æ˜¯ rt.jarã€resources.jarã€charsets.jarç­‰</p></li><li><p>Extention ClassLoader<br>æ‰©å±•ç±»åŠ è½½å™¨ï¼Œä¸»è¦ç”¨äºåŠ è½½lib/extç›®å½•ä¸‹çš„jaråŒ…å’Œ.classæ–‡ä»¶</p></li><li><p>App ClassLoader<br>è¿™æ˜¯æˆ‘ä»¬å†™çš„ Java ç±»çš„é»˜è®¤åŠ è½½å™¨ï¼Œæœ‰æ—¶å€™ä¹Ÿå«ä½œ System ClassLoaderã€‚ä¸€èˆ¬ç”¨æ¥åŠ è½½ classpath ä¸‹çš„å…¶ä»–æ‰€æœ‰ jar åŒ…å’Œ .class æ–‡ä»¶ï¼Œæˆ‘ä»¬å†™çš„ä»£ç ï¼Œä¼šé¦–å…ˆå°è¯•ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½</p></li><li><p>Custom ClassLoader<br>è‡ªå®šä¹‰åŠ è½½å™¨ï¼Œæ”¯æŒä¸€äº›ä¸ªæ€§åŒ–çš„æ‰©å±•åŠŸèƒ½ã€‚</p></li></ul><h2 id="åŒäº²å§”æ´¾åŠ è½½æœºåˆ¶"><a class="header-anchor" href="#åŒäº²å§”æ´¾åŠ è½½æœºåˆ¶"></a>åŒäº²å§”æ´¾åŠ è½½æœºåˆ¶</h2><p>åŒäº²å§”æ´¾æœºåˆ¶çš„æ„æ€æ˜¯é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä»¥å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨ï¼Œåœ¨åŠ è½½ä¹‹å‰ï¼Œéƒ½ä¼šå§”æ´¾ç»™å®ƒçš„çˆ¶åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚è¿™æ ·ä¸€å±‚å±‚å‘ä¸Šä¼ é€’ï¼Œç›´åˆ°ç¥–å…ˆä»¬éƒ½æ— æ³•èƒœä»»ï¼Œå®ƒæ‰ä¼šçœŸæ­£çš„åŠ è½½ã€‚</p><p>ps:è¿™æ ·åšçš„ç›®çš„ä¸»è¦æ˜¯è§£å†³åŒä¸€ä¸ªjvmä¸­åªèƒ½åŠ è½½åŒä¸€ä¸ªç±»ä¸€æ¬¡</p><h2 id="è‡ªå®šä¹‰åŠ è½½å™¨"><a class="header-anchor" href="#è‡ªå®šä¹‰åŠ è½½å™¨"></a>è‡ªå®šä¹‰åŠ è½½å™¨</h2><ul><li>tomcatçš„ç±»åŠ è½½æœºåˆ¶</li></ul><p><strong>WebAppClassLoader</strong>çš„ç±»åŠ è½½å™¨ä¼˜å…ˆåŠ è½½ã€‚ç­‰å®ƒåŠ è½½ä¸åˆ°çš„æ—¶å€™ï¼Œå†äº¤ç»™ä¸Šå±‚çš„ ClassLoader è¿›è¡ŒåŠ è½½ã€‚è¿™ä¸ªåŠ è½½å™¨ç”¨æ¥éš”ç»ä¸åŒåº”ç”¨çš„ .class æ–‡ä»¶ï¼Œæ¯”å¦‚ä½ çš„ä¸¤ä¸ªåº”ç”¨ï¼Œå¯èƒ½ä¼šä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ä¸åŒç‰ˆæœ¬ï¼Œå®ƒä»¬æ˜¯ç›¸äº’æ²¡æœ‰å½±å“çš„ã€‚</p><ul><li>SPIæœºåˆ¶</li></ul><pre class="line-numbers language-none"><code class="language-none">SPI å®é™…ä¸Šæ˜¯â€œåŸºäºæ¥å£çš„ç¼–ç¨‹ï¼‹ç­–ç•¥æ¨¡å¼ï¼‹é…ç½®æ–‡ä»¶â€ç»„åˆå®ç°çš„åŠ¨æ€åŠ è½½æœºåˆ¶ï¼Œä¸»è¦ä½¿ç”¨ java.util.ServiceLoader ç±»è¿›è¡ŒåŠ¨æ€è£…è½½ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>spiæœºåˆ¶çš„å®ç°æ˜¯åŸºäºè®©çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½ServiceLoaderï¼Œç”±äºå½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯åŸºäºApp ClassLoaderçš„ï¼Œå› æ­¤å¹¶ä¸è¿ååŒäº²åŠ è½½æœºåˆ¶ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> jvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç±»åŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥å­¦ä¹ Javaçº¿ç¨‹æ± </title>
      <link href="2020/06/09/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/6.%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
      <url>2020/06/09/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/6.%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥å­¦ä¹ Javaçº¿ç¨‹æ± </h1><p>è½¬è½½è‡ª:</p><pre class="line-numbers language-none"><code class="language-none">åŸæ–‡é“¾æ¥ï¼š stackify ç¿»è¯‘ï¼š ImportNew.com - ä¸€æ¯å“ˆå¸Œä¸åŠ ç›è¯‘æ–‡é“¾æ¥ï¼š http:&#x2F;&#x2F;www.importnew.com&#x2F;29212.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="å¯¼è¯­"><a class="header-anchor" href="#å¯¼è¯­"></a>å¯¼è¯­</h2><p>çº¿ç¨‹æ± æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ç»„å¯ä»¥æ‰§è¡Œä»»åŠ¡çš„ç©ºé—²çº¿ç¨‹ã€‚<br>é¦–å…ˆï¼Œæˆ‘ä»¬äº†è§£ä¸€ä¸‹å¤šçº¿ç¨‹æ¡†æ¶æ¨¡å‹ï¼Œæ˜ç™½ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ã€‚</p><p>çº¿ç¨‹æ˜¯åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—æŒ‡ä»¤çš„æ‰§è¡Œç¯å¢ƒï¼Œæˆ–ç§°è¿è¡Œç¨‹åºã€‚å¤šçº¿ç¨‹ç¼–ç¨‹æŒ‡çš„æ˜¯ç”¨å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚å½“ç„¶ï¼ŒJVM å¯¹å¤šçº¿ç¨‹æœ‰è‰¯å¥½çš„æ”¯æŒã€‚</p><p><strong>PS:è¿›ç¨‹å¯ä»¥ç®€å•çš„ç†è§£ä¸ºç¨‹åºï¼Œçº¿ç¨‹å¯ä»¥ç†è§£ä¸ºè¿›ç¨‹ä¸‹å®é™…åšäº‹çš„å°å…µç”²ä¹™ä¸™ä¸</strong></p><p>å°½ç®¡è¿™å¸¦æ¥äº†è¯¸å¤šä¼˜åŠ¿ï¼Œé¦–å½“å…¶å†²çš„å°±æ˜¯ç¨‹åºæ€§èƒ½æé«˜ï¼Œä½†å¤šçº¿ç¨‹ç¼–ç¨‹ä¹Ÿæœ‰ç¼ºç‚¹ â€”â€” å¢åŠ äº†ä»£ç å¤æ‚åº¦ã€åŒæ­¥é—®é¢˜ã€éé¢„æœŸç»“æœå’Œå¢åŠ åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ã€‚</p><p><strong>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ Java çº¿ç¨‹æ± æ¥ç¼“è§£è¿™äº›é—®é¢˜ã€‚</strong></p><h2 id="javaçº¿ç¨‹æ± "><a class="header-anchor" href="#javaçº¿ç¨‹æ± "></a>javaçº¿ç¨‹æ± </h2><p>Java é€šè¿‡ executor å¯¹è±¡æ¥å®ç°è‡ªå·±çš„çº¿ç¨‹æ± æ¨¡å‹ã€‚å¯ä»¥ä½¿ç”¨ executor æ¥å£æˆ–å…¶ä»–çº¿ç¨‹æ± çš„å®ç°ï¼Œå®ƒä»¬éƒ½å…è®¸ç»†ç²’åº¦çš„æ§åˆ¶ã€‚</p><p>java.util.concurrent åŒ…ä¸­æœ‰ä»¥ä¸‹æ¥å£ï¼š</p><ul><li>Executor â€”â€” æ‰§è¡Œä»»åŠ¡çš„ç®€å•æ¥å£</li><li>ExecutorService â€”â€” ä¸€ä¸ªè¾ƒå¤æ‚çš„æ¥å£ï¼ŒåŒ…å«é¢å¤–æ–¹æ³•æ¥ç®¡ç†ä»»åŠ¡å’Œ executor æœ¬èº«</li><li>ScheduledExecutorService â€”â€” æ‰©å±•è‡ª ExecutorServiceï¼Œå¢åŠ äº†æ‰§è¡Œä»»åŠ¡çš„è°ƒåº¦æ–¹æ³•</li></ul><p>é™¤äº†è¿™äº›æ¥å£ï¼Œè¿™ä¸ªåŒ…ä¸­ä¹Ÿæä¾›äº† Executors ç±»ç›´æ¥è·å–å®ç°äº†è¿™äº›æ¥å£çš„ executor å®ä¾‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªJavaçº¿ç¨‹æ± åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š</p><ul><li>å·¥ä½œçº¿ç¨‹çš„æ± å­ï¼Œè´Ÿè´£ç®¡ç†çº¿ç¨‹</li><li>çº¿ç¨‹å·¥å‚ï¼Œè´Ÿè´£åˆ›å»ºæ–°çº¿ç¨‹</li><li>ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—</li></ul><p>åœ¨ä¸‹é¢çš„ç« èŠ‚ï¼Œè®©æˆ‘ä»¬ä»”ç»†çœ‹ä¸€çœ‹Javaç±»å’Œæ¥å£å¦‚ä½•ä¸ºçº¿ç¨‹æ± æä¾›æ”¯æŒã€‚</p><h3 id="Executors-ç±»å’Œ-Executor-æ¥å£"><a class="header-anchor" href="#Executors-ç±»å’Œ-Executor-æ¥å£"></a>Executors ç±»å’Œ Executor æ¥å£</h3><p>Executors ç±»åŒ…å«å·¥å‚æ–¹æ³•åˆ›å»ºä¸åŒç±»å‹çš„çº¿ç¨‹æ± ï¼ŒExecutoræ˜¯ä¸ªç®€å•çš„çº¿ç¨‹æ± æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªexecute() æ–¹æ³•ã€‚<br>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç»“åˆä½¿ç”¨è¿™ä¸¤ä¸ªç±»(æ¥å£)ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œç„¶åç”¨å®ƒæ‰§è¡Œä¸€ä¸ªç®€å•çš„è¯­å¥ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Executor</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Single thread pool test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ³¨æ„è¯­å¥å†™æˆäº†lambdaè¡¨è¾¾å¼ï¼Œä¼šè¢«è‡ªåŠ¨æ¨æ–­æˆRunnableç±»å‹ã€‚<br>å¦‚æœæœ‰å·¥ä½œçº¿ç¨‹å¯ç”¨ï¼Œexecute() æ–¹æ³•å°†æ‰§è¡Œè¯­å¥ï¼Œå¦åˆ™å°±æŠŠRunnableä»»åŠ¡æ”¾è¿›é˜Ÿåˆ—ï¼Œç­‰å¾…çº¿ç¨‹å¯ç”¨ã€‚</p><p>åŸºæœ¬ä¸Šï¼Œexecutor ä»£æ›¿äº†æ˜¾å¼åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ã€‚</p><p>Executors ç±»é‡Œçš„å·¥å‚æ–¹æ³•å¯ä»¥åˆ›å»ºå¾ˆå¤šç±»å‹çš„çº¿ç¨‹æ± ï¼š</p><ul><li>newSingleThreadExecutor()ï¼šåŒ…å«å•ä¸ªçº¿ç¨‹å’Œæ— ç•Œé˜Ÿåˆ—çš„çº¿ç¨‹æ± ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡</li><li>newFixedThreadPool()ï¼šåŒ…å«å›ºå®šæ•°é‡çº¿ç¨‹å¹¶å…±äº«æ— ç•Œé˜Ÿåˆ—çš„çº¿ç¨‹æ± ï¼›å½“æ‰€æœ‰çº¿ç¨‹å¤„äºå·¥ä½œçŠ¶æ€ï¼Œæœ‰æ–°ä»»åŠ¡æäº¤æ—¶ï¼Œä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°ä¸€ä¸ªçº¿ç¨‹å˜ä¸ºå¯ç”¨çŠ¶æ€</li><li>newCachedThreadPool()ï¼šåªæœ‰éœ€è¦æ—¶åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± </li><li>newWorkStealingThreadPool()ï¼šåŸºäºå·¥ä½œçªƒå–ï¼ˆwork-stealingï¼‰ç®—æ³•çš„çº¿ç¨‹æ± ï¼Œåé¢ç« èŠ‚è¯¦ç»†è¯´æ˜</li></ul><p>ps:**newWorkStealingThreadPool()**çš„æºä»£ç æ˜¯è¿™æ ·çš„</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newWorkStealingPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span>        <span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>defaultForkJoinWorkerThreadFactory<span class="token punctuation">,</span>            <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Runtime.getRuntime().availableProcessors()è¿”å›çš„æ˜¯æœºå™¨çš„<strong>é€»è¾‘å¤„ç†å™¨æ•°é‡</strong><br>é»˜è®¤çš„<strong>newWorkStealingPool</strong>ä¼šè¿”å›ä¸€ä¸ªæœŸæœ›å¹¶è¡Œåº¦ä¸ºå½“å‰é€»è¾‘å¤„ç†å™¨æ•°é‡çš„Fork/Joinçº¿ç¨‹æ± </p></blockquote><p><strong>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ ExecutorService æ¥å£æä¾›äº†å“ªäº›æ–°åŠŸèƒ½ï¼Ÿ</strong></p><ul><li>ExecutorService</li></ul><p>åˆ›å»º ExecutorService æ–¹å¼ä¹‹ä¸€ä¾¿æ˜¯é€šè¿‡ Excutors ç±»çš„å·¥å‚æ–¹æ³•</p><blockquote><p>ExecutorService executor = Executors.newFixedThreadPool(10);</p></blockquote><p>é™¤äº†execute()æ–¹æ³•ï¼Œæ¥å£ä¹Ÿå®šä¹‰äº†ç›¸ä¼¼çš„submit()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªFutureå¯¹è±¡ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newWorkStealingPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> callableTask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">//ä¸šåŠ¡æ“ä½œ</span>    <span class="token keyword">return</span> <span class="token number">0.02d</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>callableTask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæ¯•</span><span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">double</span> result <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹åˆ°Futureæ¥å£å¯ä»¥è¿”å›Callableç±»å‹ä»»åŠ¡çš„ç»“æœï¼Œè€Œä¸”èƒ½æ˜¾ç¤ºä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚</p><p>å½“æ²¡æœ‰ä»»åŠ¡ç­‰å¾…æ‰§è¡Œæ—¶ï¼ŒExecutorServiceå¹¶ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä½¿ç”¨shutdown()æˆ–shutdownNow()æ¥æ˜¾å¼å…³é—­å®ƒã€‚</p><blockquote><p>executor.shutdown();</p></blockquote><p><strong>ScheduledExecutorService</strong></p><p>è¿™æ˜¯ExecutorServiceçš„ä¸€ä¸ªå­æ¥å£ï¼Œå¢åŠ äº†è°ƒåº¦ä»»åŠ¡çš„æ–¹æ³•</p><blockquote><p>ScheduledExecutorService executor = Executors.newScheduledThreadPool(10);</p></blockquote><p>schedule() æ–¹æ³•çš„å‚æ•°æŒ‡å®šæ‰§è¡Œçš„æ–¹æ³•ã€å»¶æ—¶å’Œ TimeUnit</p><blockquote><p>Future<Double> future = executor.schedule(callableTask, 2, TimeUnit.MILLISECONDS);</p></blockquote><p>å¦å¤–ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰äº†å…¶ä»–ä¸¤ä¸ªæ–¹æ³•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">xecutor<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Fixed Rate Scheduled"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>executor<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Fixed Delay Scheduled"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>scheduleAtFixedRate() æ–¹æ³•å»¶æ—¶ 2 æ¯«ç§’æ‰§è¡Œä»»åŠ¡ï¼Œç„¶åæ¯ 2 ç§’é‡å¤ä¸€æ¬¡ã€‚ç›¸ä¼¼çš„ï¼ŒscheduleWithFixedDelay() æ–¹æ³•å»¶æ—¶ 2æ¯«ç§’åæ‰§è¡Œç¬¬ä¸€æ¬¡ï¼Œç„¶ååœ¨ä¸Šä¸€æ¬¡æ‰§è¡Œå®Œæˆ 2 ç§’åå†æ¬¡é‡å¤æ‰§è¡Œã€‚</p><p>åœ¨ä¸‹é¢çš„ç« èŠ‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ExecutorService æ¥å£çš„ä¸¤ä¸ªå®ç°ï¼šThreadPoolExecutor å’ŒForkJoinPoolã€‚</p><p>ps:ScheduledExecutorServiceå…·æœ‰å»¶è¿ŸåŠŸèƒ½çš„çº¿ç¨‹æ± </p><p><strong>ThreadPoolExecutor</strong><br>è¿™ä¸ªçº¿ç¨‹æ± çš„å®ç°å¢åŠ äº†é…ç½®å‚æ•°çš„èƒ½åŠ›ã€‚åˆ›å»º ThreadPoolExecutor å¯¹è±¡æœ€æ–¹ä¾¿çš„æ–¹å¼å°±æ˜¯é€šè¿‡Executors å·¥å‚æ–¹æ³•ï¼š</p><blockquote><p>ThreadPoolExecutor executor = (ThreadPoolExecutor) Executors.newFixedThreadPool(10);</p></blockquote><p>è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± æŒ‰ç…§é»˜è®¤å€¼é¢„é…ç½®äº†å‚æ•°ã€‚çº¿ç¨‹æ•°é‡ç”±ä»¥ä¸‹å‚æ•°æ§åˆ¶ï¼š</p><ul><li>corePoolSize å’Œ maximumPoolSizeï¼šè¡¨ç¤ºçº¿ç¨‹æ•°é‡çš„èŒƒå›´</li><li>keepAliveTimeï¼šå†³å®šäº†é¢å¤–çº¿ç¨‹å­˜æ´»æ—¶é—´</li></ul><p>æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹è¿™äº›å‚æ•°å¦‚ä½•ä½¿ç”¨ã€‚<br>å½“ä¸€ä¸ªä»»åŠ¡è¢«æäº¤æ—¶ï¼Œå¦‚æœæ‰§è¡Œä¸­çš„çº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œä¸€ä¸ªæ–°çš„çº¿ç¨‹è¢«åˆ›å»ºã€‚å¦‚æœè¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äº corePoolSizeï¼Œä½†å°äº maximumPoolSizeï¼Œå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œä¾ç„¶ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚å¦‚æœå¤šäº corePoolSize çš„çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTimeï¼Œå®ƒä»¬ä¼šè¢«ç»ˆæ­¢ã€‚<br>ä¸Šé¢é‚£ä¸ªä¾‹å­ä¸­ï¼ŒnewFixedThreadPool() æ–¹æ³•åˆ›å»ºçš„çº¿ç¨‹æ± ï¼ŒcorePoolSize=maximumPoolSize=10 å¹¶ä¸” keepAliveTime ä¸º 0 ç§’ã€‚<br>å¦‚æœä½ ä½¿ç”¨ newCachedThreadPool() æ–¹æ³•ï¼Œåˆ›å»ºçš„çº¿ç¨‹æ±  maximumPoolSize ä¸ºInteger.MAX_VALUEï¼Œå¹¶ä¸” keepAliveTime ä¸º 60 ç§’ã€‚</p><blockquote><p>ThreadPoolExecutor cachedPoolExecutor = (ThreadPoolExecutor) Executors.newCachedThreadPool();</p></blockquote><p>The parameters can also be set through a constructor or through setter methods:<br>è¿™äº›å‚æ•°ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æˆ–setteræ–¹æ³•è®¾ç½®ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>executor<span class="token punctuation">.</span><span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ThreadPoolExecutor çš„ä¸€ä¸ªå­ç±»ä¾¿æ˜¯ ScheduledThreadPoolExecutorï¼Œå®ƒå®ç°äº†ScheduledExecutorService æ¥å£ã€‚ä½ å¯ä»¥é€šè¿‡ newScheduledThreadPool() å·¥å‚æ–¹æ³•æ¥åˆ›å»ºè¿™ç§ç±»å‹çš„çº¿ç¨‹æ± ã€‚</p><blockquote><p>ScheduledThreadPoolExecutor executor = (ScheduledThreadPoolExecutor) Executors.newScheduledThreadPool(5);</p></blockquote><p>ä¸Šé¢è¯­å¥åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼ŒcorePoolSize ä¸º 5ï¼ŒmaximumPoolSize æ— é™åˆ¶ï¼ŒkeepAliveTime ä¸º 0 ç§’ã€‚</p><p><strong>ForkJoinPool</strong></p><p>å¦ä¸€ä¸ªçº¿ç¨‹æ± çš„å®ç°æ˜¯ ForkJoinPool ç±»ã€‚å®ƒå®ç°äº† ExecutorService æ¥å£ï¼Œå¹¶ä¸”æ˜¯ Java 7 ä¸­ fork/join æ¡†æ¶çš„é‡è¦ç»„ä»¶ã€‚</p><p><strong>fork/join æ¡†æ¶åŸºäºâ€œå·¥ä½œçªƒå–ç®—æ³•â€ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ„æ€å°±æ˜¯æ‰§è¡Œå®Œä»»åŠ¡çš„çº¿ç¨‹å¯ä»¥ä»å…¶ä»–è¿è¡Œä¸­çš„çº¿ç¨‹â€œçªƒå–â€å·¥ä½œã€‚</strong></p><p><strong>ForkJoinPool é€‚ç”¨äºä»»åŠ¡åˆ›å»ºå­ä»»åŠ¡çš„æƒ…å†µï¼Œæˆ–è€…å¤–éƒ¨å®¢æˆ·ç«¯åˆ›å»ºå¤§é‡å°ä»»åŠ¡åˆ°çº¿ç¨‹æ± ã€‚</strong></p><p>è¿™ç§çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ›å»º ForkJoinTask å­ç±»</li><li>æ ¹æ®æŸç§æ¡ä»¶å°†ä»»åŠ¡åˆ‡åˆ†æˆå­ä»»åŠ¡</li><li>è°ƒç”¨æ‰§è¡Œä»»åŠ¡</li><li>å°†ä»»åŠ¡ç»“æœåˆå¹¶</li><li>å®ä¾‹åŒ–å¯¹è±¡å¹¶æ·»åŠ åˆ°æ± ä¸­</li></ul><p>åˆ›å»ºä¸€ä¸ª<strong>ForkJoinTask</strong>ï¼Œä½ å¯ä»¥é€‰æ‹©<strong>RecursiveAction</strong>æˆ–<strong>RecursiveTask</strong>è¿™ä¸¤ä¸ªå­ç±»ï¼Œåè€…æœ‰è¿”å›å€¼ã€‚<br>æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç»§æ‰¿<strong>RecursiveTask</strong>çš„ç±»ï¼Œè®¡ç®—é˜¶ä¹˜ï¼Œå¹¶æŠŠä»»åŠ¡æ ¹æ®é˜ˆå€¼åˆ’åˆ†æˆå­ä»»åŠ¡ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactorialTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> THRESHOLD <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>     <span class="token comment">// standard constructors</span>     <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token class-name">BigInteger</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">>=</span> THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token function">createSubtasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token operator">::</span><span class="token function">join</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">,</span> <span class="token class-name">BigInteger</span><span class="token operator">::</span><span class="token function">multiply</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">calculate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªç±»éœ€è¦å®ç°çš„ä¸»è¦æ–¹æ³•å°±æ˜¯é‡å†™ compute() æ–¹æ³•ï¼Œç”¨äºåˆå¹¶æ¯ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚</p><p>å…·ä½“åˆ’åˆ†ä»»åŠ¡é€»è¾‘åœ¨ createSubtasks() æ–¹æ³•ä¸­ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FactorialTask</span><span class="token punctuation">></span></span> <span class="token function">createSubtasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FactorialTask</span><span class="token punctuation">></span></span> dividedTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> n<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dividedTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FactorialTask</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dividedTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FactorialTask</span><span class="token punctuation">(</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> dividedTasks<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åï¼Œcalculate() æ–¹æ³•åŒ…å«ä¸€å®šèŒƒå›´å†…çš„ä¹˜æ•°ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">BigInteger</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> n<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">,</span> <span class="token class-name">BigInteger</span><span class="token operator">::</span><span class="token function">multiply</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ï¼Œä»»åŠ¡å¯ä»¥æ·»åŠ åˆ°çº¿ç¨‹æ± ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ForkJoinPool</span> pool <span class="token operator">=</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span><span class="token function">commonPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BigInteger</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FactorialTask</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>ThreadPoolExecutor ä¸ ForkJoinPool å¯¹æ¯”</strong></p><p>åˆçœ‹ä¸Šå»ï¼Œä¼¼ä¹ fork/join æ¡†æ¶å¸¦æ¥æ€§èƒ½æå‡ã€‚ä½†æ˜¯è¿™å–å†³äºä½ æ‰€è§£å†³é—®é¢˜çš„ç±»å‹ã€‚<br>å½“é€‰æ‹©çº¿ç¨‹æ± æ—¶ï¼Œéå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯ç‰¢è®°åˆ›å»ºã€ç®¡ç†çº¿ç¨‹ä»¥åŠçº¿ç¨‹é—´åˆ‡æ¢æ‰§è¡Œä¼šå¸¦æ¥çš„å¼€é”€ã€‚</p><ul><li><p><strong>ThreadPoolExecutorå¯ä»¥æ§åˆ¶çº¿ç¨‹æ•°é‡å’Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡,è¿™å¾ˆé€‚åˆä½ éœ€è¦åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œå°‘é‡å·¨å¤§çš„ä»»åŠ¡</strong></p></li><li><p><strong>ç›¸æ¯”è¾ƒè€Œè¨€ï¼ŒForkJoinPool åŸºäºçº¿ç¨‹ä»å…¶ä»–çº¿ç¨‹â€œçªƒå–â€ä»»åŠ¡ã€‚æ­£å› å¦‚æ­¤ï¼Œå½“ä»»åŠ¡å¯ä»¥åˆ†å‰²æˆå°ä»»åŠ¡æ—¶å¯ä»¥æé«˜æ•ˆç‡ã€‚</strong></p></li></ul><p>ä¸ºäº†å®ç°å·¥ä½œçªƒå–ç®—æ³•ï¼Œfork/join æ¡†æ¶ä½¿ç”¨ä¸¤ç§é˜Ÿåˆ—ï¼š</p><ul><li>åŒ…å«æ‰€æœ‰ä»»åŠ¡çš„ä¸»è¦é˜Ÿåˆ—</li><li>æ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—</li></ul><pre class="line-numbers language-none"><code class="language-none">å½“çº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå®ƒä»¬è¯•å›¾ä»å…¶ä»–é˜Ÿåˆ—è·å–ä»»åŠ¡ã€‚ä¸ºäº†ä½¿è¿™ä¸€è¿‡ç¨‹æ›´åŠ é«˜æ•ˆï¼Œçº¿ç¨‹ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼ˆdouble ended queueï¼‰æ•°æ®ç»“æ„ï¼Œä¸€ç«¯ä¸çº¿ç¨‹äº¤äº’ï¼Œå¦ä¸€ç«¯ç”¨äºâ€œçªƒå–â€ä»»åŠ¡ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥è‡ªThe H Developerçš„å›¾å¾ˆå¥½çš„è¡¨ç°å‡ºäº†è¿™ä¸€è¿‡ç¨‹ï¼š</p><p><img src="https://s1.ax1x.com/2020/06/09/t5ffI0.png" alt="t5ffI0.png"></p><p>å’Œè¿™ç§æ¨¡å‹ç›¸æ¯”ï¼ŒThreadPoolExecutor åªä½¿ç”¨ä¸€ä¸ªä¸»è¦é˜Ÿåˆ—ã€‚<br>æœ€åè¦æ³¨æ„çš„ä¸€ç‚¹ ForkJoinPool åªé€‚ç”¨äºä»»åŠ¡å¯ä»¥åˆ›å»ºå­ä»»åŠ¡ã€‚å¦åˆ™å®ƒå’Œ ThreadPoolExecutoræ²¡åŒºåˆ«ï¼Œç”šè‡³å¼€é”€æ›´å¤§ã€‚</p><p><strong>ps:æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŒç€ä¸€ä¸ªåŒç«¯çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œå®Œæˆå¯¹åº”å·¥ä½œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ—¶ï¼Œä¼šå»å…¶ä»–çº¿ç¨‹å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—å°¾ç«¯å»è·å–å¾…æ‰§è¡Œçš„ä»»åŠ¡æ¥è¿›è¡Œæ‰§è¡Œã€‚</strong></p><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><p>çº¿ç¨‹æ± æœ‰å¾ˆå¤§ä¼˜åŠ¿ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¯ä»¥å°†ä»»åŠ¡çš„æ‰§è¡Œä»çº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ä¸­åˆ†ç¦»ã€‚å¦å¤–ï¼Œå¦‚æœä½¿ç”¨å¾—å½“ï¼Œå®ƒä»¬å¯ä»¥æå¤§æé«˜åº”ç”¨çš„æ€§èƒ½ã€‚<br>å¦‚æœä½ å­¦ä¼šå……åˆ†åˆ©ç”¨çº¿ç¨‹æ± ï¼ŒJava ç”Ÿæ€ç³»ç»Ÿå¥½å¤„ä¾¿æ˜¯å…¶ä¸­æœ‰å¾ˆå¤šæˆç†Ÿç¨³å®šçš„çº¿ç¨‹æ± å®ç°ã€‚</p><h2 id="æ”¶è—ç¬”è®°"><a class="header-anchor" href="#æ”¶è—ç¬”è®°"></a>æ”¶è—ç¬”è®°</h2><p>å±•ç¤ºäº†ç”±<strong>Executors</strong>æä¾›çš„å‡ ç§å¸¸ç”¨çš„çº¿ç¨‹æ± ï¼š</p><ol><li>ScheduledExecutorService</li><li>ThreadPoolExecutor</li><li>ForkJoinPool</li></ol><p>å‰ä¸¤ç§éƒ½æ˜¯åŸºäº<strong>ThreadPoolExecutor</strong>çš„å°è£…ï¼Œæœ€åä¸€ç§æ˜¯åŸºäº<strong>ForkJoinPool</strong>çš„å°è£…ã€‚</p><p><strong>ThreadPoolExecutor</strong>é€‚åˆäºæ‰§è¡Œå°‘é‡è€—æ—¶çš„ä»»åŠ¡ï¼Œçº¿ç¨‹æ•°å¯ä¼°ã€‚</p><p><strong>ForkJoinPool</strong>é€‚åˆäºå¯åˆ†è§£çš„ä»»åŠ¡</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalPush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RecursiveTask æäº¤ä»»åŠ¡æ—¶å¦‚æœæäº¤çº¿ç¨‹æ˜¯ForkJoinWorkerThreadå°±å‘çº¿ç¨‹æ‰€å±äºçš„ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œæäº¤;<br>å¦‚æœä¸æ˜¯å°±è¯´æ˜æ˜¯ä¸šåŠ¡çº¿ç¨‹ç¬¬ä¸€æ¬¡å‘ForkJoinThreadPoolæäº¤ä»»åŠ¡ï¼Œå°±è°ƒç”¨ForkJoinPoolçš„é€šç”¨çº¿ç¨‹æ± è¿›è¡Œä»»åŠ¡çš„æäº¤</p><ul><li>åˆå§‹åŒ–<strong>ForkJoinPool.common</strong><br><img src="https://s1.ax1x.com/2020/06/10/tTxzF0.png" alt="tTxzF0.png"></li></ul><blockquote><p>4ä¸ªé€»è¾‘å¤„ç†å™¨-1ï¼Œå¾—åˆ°forkJoinçš„å¹¶è¡Œåº¦ä¸º3</p></blockquote><p>CPUé€»è¾‘æ ¸æ•°ï¼ˆCPUçº¿ç¨‹æ•°ï¼ŒThreadï¼‰ï¼šé€šè¿‡è¶…çº¿ç¨‹æŠ€æœ¯ï¼Œèƒ½å°†ä¸€ä¸ªç‰©ç†æ ¸åˆ†æˆå¤šä¸ªé€»è¾‘æ ¸<br>ä¸€èˆ¬æƒ…å†µï¼Œä¸€é¢—ç‰©ç†CPUå¯ä»¥æœ‰å¤šä¸ªç‰©ç†å†…æ ¸ï¼ŒåŠ ä¸Šintelçš„è¶…çº¿ç¨‹æŠ€æœ¯ï¼ˆHT,Â Hyper-Threadingï¼‰èƒ½å¤ŸæŠŠä¸€ä¸ªç‰©ç†å¤„ç†å™¨ï¼ˆæ ¸å¿ƒï¼Œå†…æ ¸ï¼‰åœ¨è½¯ä»¶å±‚å˜æˆä¸¤ä¸ªé€»è¾‘å¤„ç†å™¨ï¼Œå¯ä»¥ä½¿å¤„ç†å™¨åœ¨æŸä¸€æ—¶åˆ»ï¼ŒåŒæ­¥å¹¶è¡Œå¤„ç†æ›´å¤šæŒ‡ä»¤å’Œæ•°æ®ï¼ˆå³æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼‰ã€‚</p><p>é€»è¾‘æ ¸å¿ƒæ•°æŒ‡çš„å°±æ˜¯çº¿ç¨‹æ•°</p>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zookeeperçš„ç›¸å…³æ€è€ƒ</title>
      <link href="2020/06/08/1.%E6%9D%82%E8%AE%B0/Zookeeper%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83/"/>
      <url>2020/06/08/1.%E6%9D%82%E8%AE%B0/Zookeeper%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<h1>Zookeeperçš„ç›¸å…³æ€è€ƒ</h1><p>ç›¸ä¿¡å¤§éƒ¨åˆ†åŒå­¦ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°ZooKeeper(åæ–‡ä¸­ç®€ç§°ä¸ºzk)éƒ½æ˜¯å’ŒDubboä¸€èµ·æ¥è§¦åˆ°çš„ï¼Œåœ¨Dubboå¼€æºæ—¶å°†é˜¿é‡Œå†…éƒ¨çš„æ³¨å†Œä¸­å¿ƒè¿›è¡Œå‰¥ç¦»ï¼Œç”¨zkä½œä¸ºæœåŠ¡å‘ç°çš„æ³¨å†Œä¸­å¿ƒè¿›è¡Œä½¿ç”¨çš„ã€‚åœ¨å¤§è§„æ¨¡çš„å¾®æœåŠ¡åŒ–ä¸€æ®µæ—¶é—´åï¼Œæœ‰è¶Šæ¥è¶Šå¤šçš„å£°éŸ³æé†’æˆ‘ä»¬zkå¹¶ä¸é€‚ç”¨äºä½œä¸ºæœåŠ¡å‘ç°çš„æ³¨å†Œä¸­å¿ƒè¿›è¡Œä½¿ç”¨ã€‚ä»ä¸‹é¢ä¸‰ä¸ªé—®é¢˜å‡ºå‘ï¼Œæ¢å¯»ä¸€ä¸‹zkä¸ºä»€ä¹ˆä¸é€‚ç”¨ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚</p><ol><li>zkæ˜¯ä»€ä¹ˆï¼Œä»¥åŠç”±æ¥å’Œæƒ³è¦è§£å†³çš„é—®é¢˜ï¼Ÿ</li><li>zkä¸ºä»€ä¹ˆä¸é€‚ç”¨ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Ÿ</li><li>zkè¿ç§»eurkaçš„æ–¹æ¡ˆ</li></ol><h2 id="zkçš„ç”±æ¥"><a class="header-anchor" href="#zkçš„ç”±æ¥"></a>zkçš„ç”±æ¥</h2><ul><li>ç»´åŸºç™¾ç§‘çš„ç®€ä»‹</li></ul><blockquote><p>Apache ZooKeeperæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€ä¸ªè½¯ä»¶é¡¹ç›®ï¼Œå®ƒä¸ºå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æä¾›å¼€æºçš„åˆ†å¸ƒå¼é…ç½®æœåŠ¡ã€åŒæ­¥æœåŠ¡å’Œå‘½åæ³¨å†Œã€‚ZooKeeperæ›¾ç»æ˜¯Hadoopçš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œä½†ç°åœ¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¶çº§é¡¹ç›®ã€‚</p></blockquote><ul><li>zkçš„ç”±æ¥</li></ul><p>ä¸‹é¢è¿™æ®µå†…å®¹æ‘˜è‡ªã€Šä»Paxosåˆ°Zookeeper ã€‹ ï¼Œæœ¬æ–‡ä¸­å¾ˆå¤šçš„åè¯ä»‹ç»ä¹Ÿæ¥è‡ªæœ¬ä¹¦ã€‚</p><pre class="line-numbers language-none"><code class="language-none">Zookeeper æœ€æ—©èµ·æºäºé›…è™ç ”ç©¶é™¢çš„ä¸€ä¸ªç ”ç©¶å°ç»„ã€‚åœ¨å½“æ—¶ï¼Œç ”ç©¶äººå‘˜å‘ç°ï¼Œåœ¨é›…è™å†…éƒ¨å¾ˆå¤šå¤§å‹ç³»ç»ŸåŸºæœ¬éƒ½éœ€è¦ä¾èµ–ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿæ¥è¿›è¡Œåˆ†å¸ƒå¼åè°ƒï¼Œä½†æ˜¯è¿™äº›ç³»ç»Ÿå¾€å¾€éƒ½å­˜åœ¨åˆ†å¸ƒå¼å•ç‚¹é—®é¢˜ã€‚æ‰€ä»¥ï¼Œé›…è™çš„å¼€å‘äººå‘˜å°±è¯•å›¾å¼€å‘ä¸€ä¸ªé€šç”¨çš„æ— å•ç‚¹é—®é¢˜çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ï¼Œä»¥ä¾¿è®©å¼€å‘äººå‘˜å°†ç²¾åŠ›é›†ä¸­åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚å…³äºâ€œZooKeeperâ€è¿™ä¸ªé¡¹ç›®çš„åå­—ï¼Œå…¶å®ä¹Ÿæœ‰ä¸€æ®µè¶£é—»ã€‚åœ¨ç«‹é¡¹åˆæœŸï¼Œè€ƒè™‘åˆ°ä¹‹å‰å†…éƒ¨å¾ˆå¤šé¡¹ç›®éƒ½æ˜¯ä½¿ç”¨åŠ¨ç‰©çš„åå­—æ¥å‘½åçš„ï¼ˆä¾‹å¦‚è‘—åçš„Pigé¡¹ç›®),é›…è™çš„å·¥ç¨‹å¸ˆå¸Œæœ›ç»™è¿™ä¸ªé¡¹ç›®ä¹Ÿå–ä¸€ä¸ªåŠ¨ç‰©çš„åå­—ã€‚æ—¶ä»»ç ”ç©¶é™¢çš„é¦–å¸­ç§‘å­¦å®¶ RaghuRamakrishnan å¼€ç©ç¬‘åœ°è¯´ï¼šâ€œåœ¨è¿™æ ·ä¸‹å»ï¼Œæˆ‘ä»¬è¿™å„¿å°±å˜æˆåŠ¨ç‰©å›­äº†ï¼â€æ­¤è¯ä¸€å‡ºï¼Œå¤§å®¶çº·çº·è¡¨ç¤ºå°±å«åŠ¨ç‰©å›­ç®¡ç†å‘˜å§ä¸€ä¸€ä¸€å› ä¸ºå„ä¸ªä»¥åŠ¨ç‰©å‘½åçš„åˆ†å¸ƒå¼ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œé›…è™çš„æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä¸Šå»å°±åƒä¸€ä¸ªå¤§å‹çš„åŠ¨ç‰©å›­äº†è€Œ Zookeeper æ­£å¥½è¦ç”¨æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¯å¢ƒçš„åè°ƒä¸€ä¸€äºæ˜¯ï¼ŒZookeeper çš„åå­—ä¹Ÿå°±ç”±æ­¤è¯ç”Ÿäº†ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>zkçš„è¯ç”Ÿæ˜¯ä¸ºäº†è§£å†³åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸åŒç³»ç»Ÿä¹‹é—´è¿›è¡Œåˆ†å¸ƒå¼åè°ƒçš„åœºæ™¯ã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹éœ€è¦å°†åŒä¸€ä¸ªç³»ç»Ÿåˆ†å¸ƒå¼åŒ–åå¯¹å¤–æä¾›å‡ºåƒä¸€ä¸ªç³»ç»Ÿä¸€æ ·çš„æœåŠ¡ï¼Œè¿™æ ·å°±éœ€è¦å¼•å…¥åˆ†å¸ƒå¼åè°ƒå·¥å…·ï¼Œå°†è¿™ç§åŸæ¥æ˜¯ç”±åº”ç”¨ç³»ç»Ÿè§£å†³çš„äº‹æƒ…å‰¥ç¦»å¼€çš„å·¥å…·ã€‚å› æ­¤zkå°±è¯ç”Ÿäº†ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œzkæä¾›äº†ä¸€ä¸ªå¯é çš„åˆ†å¸ƒå¼çš„å·¥å…·ï¼Œå¯ä»¥å¯¹å¤–æä¾›ä¸€ä¸‹å‡ ç§åŠŸèƒ½(APIä¸­çš„æ–¹æ³•):</p><ol><li>åˆ›å»ºèŠ‚ç‚¹</li><li>è¯»èŠ‚ç‚¹æ•°æ®</li><li>æ›´æ–°èŠ‚ç‚¹æ•°æ®</li><li>åˆ é™¤èŠ‚ç‚¹</li><li>ç›‘æ§èŠ‚ç‚¹å˜åŒ–</li></ol><ul><li>zkè§£å†³çš„é—®é¢˜</li></ul><ol><li>å…ƒæ•°æ®é…ç½®ï¼škafkaä¸­å­˜å‚¨å…ƒæ•°æ®</li><li>æ³¨å†Œä¸­å¿ƒï¼šåº”ç”¨äºå……å½“æ³¨å†Œä¸­å¿ƒ</li><li>ä½œä¸ºåˆ†å¸ƒå¼é”ï¼šCuratoråˆ†å¸ƒå¼é”</li></ol><h2 id="zkä¸é€‚ç”¨ä½œä¸ºæ³¨å†Œä¸­å¿ƒ"><a class="header-anchor" href="#zkä¸é€‚ç”¨ä½œä¸ºæ³¨å†Œä¸­å¿ƒ"></a>zkä¸é€‚ç”¨ä½œä¸ºæ³¨å†Œä¸­å¿ƒ</h2><p>ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½åœ¨è¯´zkä¸é€‚åˆä½œä¸ºæ³¨å†Œä¸­å¿ƒå…¶æ ¹æ®ä¸»è¦æ˜¯<a href="https://medium.com/knerd/eureka-why-you-shouldnt-use-zookeeper-for-service-discovery-4932c5c7e764"> Eureka! Why You Shouldnâ€™t Use ZooKeeper for Service Discovery</a>ä¸€æ–‡ï¼Œåˆ†æå…¶åŸå› ä¸»è¦æ˜¯è¯´zkæ˜¯åŸºäºcpçš„ï¼Œè€Œæ³¨å†Œä¸­å¿ƒçš„ä¸šåŠ¡æ›´é€‚ç”¨äºapã€‚</p><p>ä¸‹é¢æ ¹æ®<a href="https://yq.aliyun.com/articles/601745?scm=20140722.184.2.173">é˜¿é‡Œå·´å·´ä¸ºä»€ä¹ˆä¸ç”¨ ZooKeeper åšæœåŠ¡å‘ç°</a>ä¸€æ–‡æ•´ç†è€Œæ¥</p><h3 id="æ•°æ®çš„ä¸€è‡´æ€§éœ€æ±‚åˆ†æ"><a class="header-anchor" href="#æ•°æ®çš„ä¸€è‡´æ€§éœ€æ±‚åˆ†æ"></a>æ•°æ®çš„ä¸€è‡´æ€§éœ€æ±‚åˆ†æ</h3><p>æ³¨å†Œä¸­å¿ƒæœ€æœ¬è´¨çš„åŠŸèƒ½å°±æ˜¯ä¸€ä¸ªQueryå‡½æ•°Si = F(service-name),ä»¥service-nameä½œä¸ºæŸ¥è¯¢å‚æ•°ï¼Œè¿”å›æœåŠ¡å¯¹åº”çš„åœ°å€ï¼›</p><blockquote><p>å¦‚æœæ³¨å†Œä¸­å¿ƒæ»¡è¶³apçš„æƒ…å†µï¼š<br>æ¯æ¬¡è¿”å›çš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸åŒçš„æœåŠ¡æä¾›è€…æ¥æ”¶åˆ°çš„æµé‡éƒ½ä¸ä¸€æ ·ï¼Œåœ¨çŸ­æ—¶é—´å†…æµé‡çš„ä¸ä¸€è‡´ä¼šå› ä¸ºå¤šæ¬¡è°ƒç”¨æ ¹æ®å¤§æ•°ç†è®ºè¿™ç‚¹æµé‡å·®å¼‚ä¼šè¢«æŠ¹æ¶ˆæ‰ã€‚</p></blockquote><blockquote><p>å¦‚æœæ³¨å†Œä¸­å¿ƒæ˜¯åŸºäºcpçš„æƒ…å†µï¼š<br>åœ¨ä¸ä¿è¯å¯ç”¨æ€§çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªzkèŠ‚ç‚¹ä¸leaderèŠ‚ç‚¹å¤±è”çš„æƒ…å†µä¸‹ä¸ºäº†ä¿è¯zkä¸­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¯¥èŠ‚ç‚¹ä¸ä¼šå¯¹å¤–æä¾›æœåŠ¡ã€‚<br>å¯¹äºå’Œè¯¥zkèŠ‚ç‚¹åœ¨åŒä¸€åˆ†åŒºä¸­çš„æœåŠ¡æ¥è¯´ï¼Œç”±äºzkçš„å¼‚å¸¸å¯¼è‡´æœ¬èº«ä¸šåŠ¡ä¹Ÿä¸èƒ½è¿›è¡ŒåŒåŒºè°ƒç”¨æ˜¯ä¸èƒ½æ¥å—çš„ã€‚<strong>å¯ä»¥è¯´åœ¨å®è·µä¸­ï¼Œæ³¨å†Œä¸­å¿ƒä¸èƒ½å› ä¸ºè‡ªèº«çš„ä»»ä½•åŸå› ç ´åæœåŠ¡ä¹‹é—´æœ¬èº«çš„å¯è¿é€šæ€§ï¼Œè¿™æ˜¯æ³¨å†Œä¸­å¿ƒè®¾è®¡åº”è¯¥éµå¾ªçš„é“å¾‹ï¼</strong></p></blockquote><blockquote><p>åœ¨ CAP çš„æƒè¡¡ä¸­ï¼Œæ³¨å†Œä¸­å¿ƒçš„å¯ç”¨æ€§æ¯”æ•°æ®å¼ºä¸€è‡´æ€§æ›´å®è´µï¼Œæ‰€ä»¥æ•´ä½“è®¾è®¡æ›´åº”è¯¥åå‘ APï¼Œè€Œé CPï¼Œæ•°æ®ä¸ä¸€è‡´åœ¨å¯æ¥å—èŒƒå›´ï¼Œè€ŒPä¸‹èˆå¼ƒAå´å®Œå…¨è¿åäº†æ³¨å†Œä¸­å¿ƒä¸èƒ½å› ä¸ºè‡ªèº«çš„ä»»ä½•åŸå› ç ´åæœåŠ¡æœ¬èº«çš„å¯è¿é€šæ€§çš„åŸåˆ™ã€‚</p></blockquote><p>ps:æ€»çš„æ¥è¯´å°±æ˜¯æ³¨å†Œä¸­å¿ƒåœ¨é¢ä¸´CAPçš„é—®é¢˜ä¸Šï¼Œå¯ä»¥æ¥å—æ•°æ®çš„ä¸ä¸€è‡´ï¼Œä½†æ˜¯ä¸èƒ½æ¥å—ä¸šåŠ¡çš„ä¸å¯ç”¨ã€‚</p><h3 id="æœåŠ¡è§„æ¨¡ã€å®¹é‡ã€æœåŠ¡è”é€šæ€§"><a class="header-anchor" href="#æœåŠ¡è§„æ¨¡ã€å®¹é‡ã€æœåŠ¡è”é€šæ€§"></a>æœåŠ¡è§„æ¨¡ã€å®¹é‡ã€æœåŠ¡è”é€šæ€§</h3><p>ä»æœåŠ¡çš„è§„æ¨¡ã€å®¹é‡ã€æœåŠ¡è”é€šæ€§æ¥åˆ†æ</p><p>ç”±äºzkä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå› æ­¤åœ¨è¿›è¡Œå†™å…¥çš„æ—¶å€™å¿…é¡»åˆLeaderå‘èµ·ï¼Œåœ¨å‘å…¶ä»–èŠ‚ç‚¹åˆ†å‘å†™å…¥æ“ä½œï¼Œå› æ­¤å†™å…¥æ“ä½œä¸èƒ½è¿›è¡Œæ¨ªå‘æ‰©å±•ã€‚è¿™æ ·å°±æ— æ³•è§£å†³zkçš„æœåŠ¡è§„æ¨¡å¢é•¿é—®é¢˜ï¼Œæˆ–è€…å°†æ³¨å†ŒèŠ‚ç‚¹æ ¹æ®ä¸šåŠ¡è¿›è¡Œåˆ’åˆ†ï¼Œä¸åŒçš„ä¸šåŠ¡æ³¨å†Œåˆ°ä¸åŒçš„zkä¸Šå»ï¼Œä½†æ˜¯æ³¨å†Œä¸­å¿ƒä½œä¸ºåŸºç¡€æœåŠ¡ï¼Œä¸èƒ½ç”±äºè‡ªèº«çš„é™åˆ¶å»å½±å“ä¸šåŠ¡ï¼Œè®©ä¸šåŠ¡æŒ‰ç…§ä¸šåŠ¡æœåŠ¡è¿›è¡Œåˆ’åˆ†ã€‚</p><h3 id="æ³¨å†Œä¸­å¿ƒéœ€è¦æŒä¹…å­˜å‚¨å’Œäº‹åŠ¡æ—¥å¿—"><a class="header-anchor" href="#æ³¨å†Œä¸­å¿ƒéœ€è¦æŒä¹…å­˜å‚¨å’Œäº‹åŠ¡æ—¥å¿—"></a>æ³¨å†Œä¸­å¿ƒéœ€è¦æŒä¹…å­˜å‚¨å’Œäº‹åŠ¡æ—¥å¿—</h3><p>æ³¨å†Œä¸­å¿ƒéœ€è¦è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨å’Œäº‹åŠ¡æ—¥å¿—å˜›ï¼Ÿæˆ‘è®¤ä¸ºæ˜¯éœ€è¦çš„ï¼Œä½†æ˜¯ä¸ç”¨åƒzkä¸€æ ·æŠŠæ¯ä¸€æ¬¡å˜æ›´çš„æ—¥å¿—è®°å½•ä¸‹æ¥ã€‚<br>ä¾‹å¦‚ï¼š</p><ol><li><p>serviceA=ã€‹{ip1:0001,ip1:0002}</p></li><li><p>serviceA=ã€‹{ip1:0001}</p></li><li><p>serviceA=ã€‹{ip1:0001,ip1:0002}</p></li></ol><p>è¿™æ ·çš„ABAçš„æŒä¹…åŒ–è¿ç»­è®°å½•ï¼Œå¯¹äºæœåŠ¡çš„è°ƒç”¨æ–¹æ¥è¯´å¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼ŒæœåŠ¡è°ƒç”¨å‘èµ·æ–¹æ›´å…³æ³¨çš„æ˜¯å…¶è¦è°ƒç”¨çš„æœåŠ¡çš„å®æ—¶çš„åœ°å€åˆ—è¡¨å’Œå®æ—¶å¥åº·çŠ¶æ€ï¼Œæ¯æ¬¡å‘èµ·è°ƒç”¨æ—¶ï¼Œå¹¶ä¸å…³å¿ƒè¦è°ƒç”¨çš„æœåŠ¡çš„å†å²æœåŠ¡åœ°å€åˆ—è¡¨ã€è¿‡å»çš„å¥åº·çŠ¶æ€ã€‚</p><p>éœ€è¦è¿›è¡ŒæŒä¹…åŒ–è®°å½•çš„åº”è¯¥æ˜¯æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼šæœåŠ¡çš„ç‰ˆæœ¬ï¼Œåˆ†ç»„ï¼Œæ‰€åœ¨çš„æ•°æ®ä¸­å¿ƒï¼Œæƒé‡ï¼Œé‰´æƒç­–ç•¥ä¿¡æ¯ï¼Œservice labelç­‰</p><h3 id="Service-Health-Check"><a class="header-anchor" href="#Service-Health-Check"></a>Service Health Check</h3><p>ä½¿ç”¨zkä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ—¶ï¼ŒæœåŠ¡çš„å¥åº·ç›‘æµ‹æ˜¯ç”¨Zookeeperçš„Seesionæœºåˆ¶å¯ä»¥ç†è§£ä¸ºç»‘å®šTCPé•¿è¿æ¥çš„ç›‘æµ‹ã€‚è¿™ç§ç›‘æµ‹åªæ˜¯èƒ½è¯æ˜clientçš„ç½‘ç»œé€šè·¯æ˜¯ç•…é€šçš„ï¼Œå¹¶ä¸èƒ½ä»£å˜æœåŠ¡æ˜¯å¯ç”¨ã€‚</p><p>å¥åº·æ£€æµ‹çš„ä¸€å¤§åŸºæœ¬è®¾è®¡åŸåˆ™å°±æ˜¯å°½å¯èƒ½çœŸå®çš„åé¦ˆæœåŠ¡æœ¬èº«çš„çœŸå®å¥åº·çŠ¶æ€ï¼Œå¦åˆ™ä¸€ä¸ªä¸æ•¢è¢«æœåŠ¡è°ƒç”¨è€…ç›¸ä¿¡çš„å¥åº·çŠ¶æ€åˆ¤å®šç»“æœè¿˜ä¸å¦‚æ²¡æœ‰å¥åº·æ£€æµ‹ã€‚</p><h3 id="æ³¨å†Œä¸­å¿ƒçš„å®¹ç¾è€ƒè™‘"><a class="header-anchor" href="#æ³¨å†Œä¸­å¿ƒçš„å®¹ç¾è€ƒè™‘"></a>æ³¨å†Œä¸­å¿ƒçš„å®¹ç¾è€ƒè™‘</h3><p><strong>åœ¨å®è·µä¸­ï¼Œæ³¨å†Œä¸­å¿ƒä¸èƒ½å› ä¸ºè‡ªèº«çš„ä»»ä½•åŸå› ç ´åæœåŠ¡ä¹‹é—´æœ¬èº«çš„å¯è¿é€šæ€§</strong>ï¼Œè¿™å¥è¯è¯´çš„æ˜¯å°±ç®—zkæœåŠ¡å®•æœºçš„æƒ…å†µä¸‹ä¹Ÿä¸èƒ½å½±å“å·²æœ‰æœåŠ¡çš„åŠŸèƒ½ã€‚zkçš„clientç«¯å¹¶æ²¡æœ‰æä¾›è¿™æ ·çš„åŠŸèƒ½ï¼Œdubboä½¿ç”¨zkä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶å€™çš„æ—¶å€™ï¼Œæ˜¯åœ¨dubboæ¶ˆè´¹è€…ç¼“å­˜äº†ç”Ÿäº§è€…çš„åœ°å€ã€‚</p><h3 id="é˜¿é‡Œå¯¹äºzkçš„æ€»ç»“"><a class="header-anchor" href="#é˜¿é‡Œå¯¹äºzkçš„æ€»ç»“"></a>é˜¿é‡Œå¯¹äºzkçš„æ€»ç»“</h3><p><strong>The King Of Coordination for Big Data!</strong></p><pre class="line-numbers language-none"><code class="language-none">åœ¨ç²—ç²’åº¦åˆ†å¸ƒå¼é”ï¼Œåˆ†å¸ƒå¼é€‰ä¸»ï¼Œä¸»å¤‡é«˜å¯ç”¨åˆ‡æ¢ç­‰ä¸éœ€è¦é«˜TPS æ”¯æŒçš„åœºæ™¯ä¸‹æœ‰ä¸å¯æ›¿ä»£çš„ä½œç”¨ï¼Œè€Œè¿™äº›éœ€æ±‚å¾€å¾€å¤šé›†ä¸­åœ¨å¤§æ•°æ®ã€ç¦»çº¿ä»»åŠ¡ç­‰ç›¸å…³çš„ä¸šåŠ¡é¢†åŸŸï¼Œå› ä¸ºå¤§æ•°æ®é¢†åŸŸï¼Œè®²ç©¶åˆ†å‰²æ•°æ®é›†ï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†æ—¶é—´åˆ†ä»»åŠ¡å¤šè¿›ç¨‹&#x2F;çº¿ç¨‹å¹¶è¡Œå¤„ç†è¿™äº›æ•°æ®é›†ï¼Œä½†æ˜¯æ€»æ˜¯æœ‰ä¸€äº›ç‚¹ä¸Šéœ€è¦å°†è¿™äº›ä»»åŠ¡å’Œè¿›ç¨‹ç»Ÿä¸€åè°ƒï¼Œè¿™æ—¶å€™å°±æ˜¯ ZooKeeper å‘æŒ¥å·¨å¤§ä½œç”¨çš„ç”¨æ­¦ä¹‹åœ°ã€‚ä½†æ˜¯åœ¨äº¤æ˜“åœºæ™¯äº¤æ˜“é“¾è·¯ä¸Šï¼Œåœ¨ä¸»ä¸šåŠ¡æ•°æ®å­˜å–ï¼Œå¤§è§„æ¨¡æœåŠ¡å‘ç°ã€å¤§è§„æ¨¡å¥åº·ç›‘æµ‹ç­‰æ–¹é¢æœ‰å¤©ç„¶çš„çŸ­æ¿ï¼Œåº”è¯¥ç«­åŠ›é¿å…åœ¨è¿™äº›åœºæ™¯ä¸‹å¼•å…¥ ZooKeeperï¼Œåœ¨é˜¿é‡Œå·´å·´çš„ç”Ÿäº§å®è·µä¸­ï¼Œåº”ç”¨å¯¹ZooKeeperç”³è¯·ä½¿ç”¨çš„æ—¶å€™è¦è¿›è¡Œä¸¥æ ¼çš„åœºæ™¯ã€å®¹é‡ã€SLAéœ€æ±‚çš„è¯„ä¼°ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ ZooKeeperï¼Œä½†æ˜¯å¤§æ•°æ®è¯·å‘å·¦ï¼Œè€Œäº¤æ˜“åˆ™å‘å³ï¼Œåˆ†å¸ƒå¼åè°ƒå‘å·¦ï¼ŒæœåŠ¡å‘ç°å‘å³ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><p>zkåœ¨ä¸šåŠ¡é¢†åŸŸä½œä¸ºæœåŠ¡å‘ç°çš„æ³¨å†Œä¸­å¿ƒæ˜¯è¶Šæ¥è¶Šä¸é€‚ç”¨äº†ï¼Œåœ¨ä»¥å‰æ²¡æœ‰ä¸“é—¨çš„å·¥å…·çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¯é ã€æ˜“ç”¨çš„å·¥å…·å°±æ˜¯ä½œä¸ºæœåŠ¡å‘ç°çš„æœ€å¥½é€‰æ‹©ï¼Œä½†æ˜¯åœ¨å½“ä¸‹zkä½œä¸ºæ³¨å†Œä¸­å¿ƒç¡®æ˜¾å¾—ä¸åˆé€‚å®œã€‚ç›®å‰æ³¨å†Œä¸­å¿ƒçš„é€‰æ‹©æœ‰å¾ˆå¤š</p><ul><li><a href="http://www.heartthinkdo.com/?p=1933">Eureka</a></li><li><a href="https://nacos.io/zh-cn/index.html">Nacos</a></li><li><a href="https://github.com/etcd-io/etcd">etcd</a></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.cnblogs.com/ailiuzhe/p/11678043.html">ZooKeeperçš„è¯¦ç»†ä»‹ç»ä»¥åŠåº•å±‚åŸç†</a><br><a href="https://zhuanlan.zhihu.com/p/69114539?utm_source=wechat_session">ä¸ºä»€ä¹ˆéœ€è¦ Zookeeper</a><br><a href="https://zhuanlan.zhihu.com/p/134549250">è…¾è®¯ ZooKeeper æºç å’Œå®è·µæ­ç§˜</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½—é©¬æ•°å­—è½¬æ•´æ•°_LeetCode07</title>
      <link href="2020/06/03/13.LeetCode/7.%E7%BD%97%E9%A9%AC%E6%95%B0%E5%AD%97%E8%BD%AC%E6%95%B4%E6%95%B0-LeetCode07/"/>
      <url>2020/06/03/13.LeetCode/7.%E7%BD%97%E9%A9%AC%E6%95%B0%E5%AD%97%E8%BD%AC%E6%95%B4%E6%95%B0-LeetCode07/</url>
      
        <content type="html"><![CDATA[<h1>ç½—é©¬æ•°å­—è½¬æ•´æ•°</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><pre class="line-numbers language-none"><code class="language-none">ç½—é©¬æ•°å­—åŒ…å«ä»¥ä¸‹ä¸ƒç§å­—ç¬¦: Iï¼Œ Vï¼Œ Xï¼Œ Lï¼ŒCï¼ŒD å’Œ Mã€‚å­—ç¬¦          æ•°å€¼I             1V             5X             10L             50C             100D             500M             1000ä¾‹å¦‚ï¼Œ ç½—é©¬æ•°å­— 2 å†™åšÂ IIÂ ï¼Œå³ä¸ºä¸¤ä¸ªå¹¶åˆ—çš„ 1ã€‚12 å†™åšÂ XIIÂ ï¼Œå³ä¸ºÂ XÂ +Â IIÂ ã€‚ 27 å†™åšÂ Â XXVII, å³ä¸ºÂ XXÂ +Â VÂ +Â IIÂ ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç½—é©¬æ•°å­—ä¸­å°çš„æ•°å­—åœ¨å¤§çš„æ•°å­—çš„å³è¾¹ã€‚ä½†ä¹Ÿå­˜åœ¨ç‰¹ä¾‹ï¼Œä¾‹å¦‚ 4 ä¸å†™åšÂ IIIIï¼Œè€Œæ˜¯Â IVã€‚æ•°å­— 1 åœ¨æ•°å­— 5 çš„å·¦è¾¹ï¼Œæ‰€è¡¨ç¤ºçš„æ•°ç­‰äºå¤§æ•° 5 å‡å°æ•° 1 å¾—åˆ°çš„æ•°å€¼ 4 ã€‚åŒæ ·åœ°ï¼Œæ•°å­— 9 è¡¨ç¤ºä¸ºÂ IXã€‚è¿™ä¸ªç‰¹æ®Šçš„è§„åˆ™åªé€‚ç”¨äºä»¥ä¸‹å…­ç§æƒ…å†µï¼šIÂ å¯ä»¥æ”¾åœ¨Â VÂ (5) å’ŒÂ XÂ (10) çš„å·¦è¾¹ï¼Œæ¥è¡¨ç¤º 4 å’Œ 9ã€‚XÂ å¯ä»¥æ”¾åœ¨Â LÂ (50) å’ŒÂ CÂ (100) çš„å·¦è¾¹ï¼Œæ¥è¡¨ç¤º 40 å’ŒÂ 90ã€‚Â CÂ å¯ä»¥æ”¾åœ¨Â DÂ (500) å’ŒÂ MÂ (1000) çš„å·¦è¾¹ï¼Œæ¥è¡¨ç¤ºÂ 400 å’ŒÂ 900ã€‚ç»™å®šä¸€ä¸ªç½—é©¬æ•°å­—ï¼Œå°†å…¶è½¬æ¢æˆæ•´æ•°ã€‚è¾“å…¥ç¡®ä¿åœ¨ 1Â åˆ° 3999 çš„èŒƒå›´å†…ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 1:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;III&quot;è¾“å‡º: 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 2:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;IV&quot;è¾“å‡º: 4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 3:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;IX&quot;è¾“å‡º: 9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 4:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;LVIII&quot;è¾“å‡º: 58è§£é‡Š: L &#x3D; 50, V&#x3D; 5, III &#x3D; 3.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 5:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;MCMXCIV&quot;è¾“å‡º: 1994è§£é‡Š: M &#x3D; 1000, CM &#x3D; 900, XC &#x3D; 90, IV &#x3D; 4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="è§£é¢˜æ€è·¯"><a class="header-anchor" href="#è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h2><blockquote><p>è¿™é“é¢˜ç›®ç±»ä¼¼äºç”¨keyå»æŸ¥è¯¢å¯¹åº”çš„valueçš„è¿‡ç¨‹ï¼ŒæŒ‰ç…§æ—¢å®šçš„è§„åˆ™å»åˆ¤æ–­</p></blockquote><h2 id="ä»£ç å®ç°"><a class="header-anchor" href="#ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution_07</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tempMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tempMap1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"I"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"V"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"X"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"L"</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"M"</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"IV"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"IX"</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"XL"</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"XC"</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"CD"</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tempMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"CM"</span><span class="token punctuation">,</span><span class="token number">900</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">doSolution</span><span class="token punctuation">(</span><span class="token string">"III"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">doSolution</span><span class="token punctuation">(</span><span class="token string">"IV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">doSolution</span><span class="token punctuation">(</span><span class="token string">"IX"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">doSolution</span><span class="token punctuation">(</span><span class="token string">"LVIII"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">doSolution</span><span class="token punctuation">(</span><span class="token string">"MCMXCIV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Solution_07</span><span class="token punctuation">.</span><span class="token function">doSolution</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">doSolution</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> tempMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> tempMap1<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> tempMap1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">String</span> tempStr <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>tempMap1<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>tempStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> tempMap1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tempStr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">doSolution</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> tempMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">doSolution</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="https://s1.ax1x.com/2020/06/04/tDFSu4.png" alt="tDFSu4.png"></p><h2 id="å®˜æ–¹è§£é¢˜"><a class="header-anchor" href="#å®˜æ–¹è§£é¢˜"></a>å®˜æ–¹è§£é¢˜</h2><p>åœ¨å®˜æ–¹è§£é¢˜æ€è·¯ä¸­è¿˜çœ‹åˆ°ä¸€ç§è§£æ³•ï¼Œå¾ˆå¥½ã€‚å› æ­¤è®°å½•ä¸‹æ¥</p><p><img src="https://s1.ax1x.com/2020/06/04/tDFdVs.png" alt="tDFdVs.png"></p><ul><li>ä»£ç å®ç°</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution_07_01</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token string">"III"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token string">"IV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token string">"IX"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token string">"LVIII"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token string">"MCMXCIV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">romanToInt</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> tempInt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">transform</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">transform</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                tempInt <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                tempInt <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">*</span><span class="token function">transform</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> tempInt <span class="token operator">+</span> <span class="token function">romanToInt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token function">transform</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> <span class="token string">'I'</span> <span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">'V'</span> <span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">5</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">'X'</span> <span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">'L'</span> <span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">50</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">'C'</span> <span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">'D'</span> <span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">500</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œè€—æ—¶è™½ç„¶æœ‰æ‰€æé«˜ä½†æ˜¯å†…å­˜å ç”¨ä¾æ—§å¾ˆé«˜ï¼Œçœ‹æ¥é€’å½’çš„æ–¹æ³•å¤„ç†é—®é¢˜ä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JUCä¹‹AQSåˆ†æ</title>
      <link href="2020/06/03/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/5.JUC%E4%B9%8BAQS%E5%88%86%E6%9E%90/"/>
      <url>2020/06/03/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/5.JUC%E4%B9%8BAQS%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>JUCä¹‹AQSåˆ†æ</h1><p>è½¬è½½è‡ª:<a href="https://mp.weixin.qq.com/s/-swOI_4_cxP5BBSD9wd0lA">ã€æ­»ç£•Javaå¹¶å‘ã€‘â€”â€“J.U.Cä¹‹AQS</a></p><blockquote><p>è®²è¿°AQS(<strong>AbstractQueuedSynchronizer</strong>)çš„æ ¸å¿ƒä»£ç çš„æ–‡ç« ï¼ŒAQSçš„æ–‡ç« å¯å‚è€ƒ<B><a href="%5C2020%5C05%5C22%5C2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86%5C13.%E5%AF%B9AQS%E7%9A%84%E5%88%86%E6%9E%90">å¯¹AQSçš„åˆ†æ</a></B>ä¸€æ–‡</p></blockquote><h2 id="AQSç®€ä»‹"><a class="header-anchor" href="#AQSç®€ä»‹"></a>AQSç®€ä»‹</h2><p>javaçš„å†…ç½®é”ä¸€ç›´éƒ½æ˜¯å¤‡å—äº‰è®®çš„ï¼Œåœ¨JDK 1.6ä¹‹å‰ï¼Œsynchronizedè¿™ä¸ªé‡é‡çº§é”å…¶æ€§èƒ½ä¸€ç›´éƒ½æ˜¯è¾ƒä¸ºä½ä¸‹ï¼Œè™½ç„¶åœ¨1.6åï¼Œè¿›è¡Œå¤§é‡çš„é”ä¼˜åŒ–ç­–ç•¥,ä½†æ˜¯ä¸Lockç›¸æ¯”synchronizedè¿˜æ˜¯å­˜åœ¨ä¸€äº›ç¼ºé™·çš„ï¼šè™½ç„¶synchronizedæä¾›äº†ä¾¿æ·æ€§çš„éšå¼è·å–é”é‡Šæ”¾é”æœºåˆ¶ï¼ˆåŸºäºJVMæœºåˆ¶ï¼‰ï¼Œä½†æ˜¯å®ƒå´ç¼ºå°‘äº†è·å–é”ä¸é‡Šæ”¾é”çš„å¯æ“ä½œæ€§ï¼Œå¯ä¸­æ–­ã€è¶…æ—¶è·å–é”ï¼Œä¸”å®ƒä¸ºç‹¬å å¼åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½å¤§æ‰“æŠ˜æ‰£ã€‚</p><p>åœ¨ä»‹ç»Lockä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†Ÿæ‚‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼ŒæŒæ¡äº†è¯¥ç»„ä»¶JUCåŒ…ä¸‹é¢å¾ˆå¤šé—®é¢˜éƒ½ä¸åœ¨æ˜¯é—®é¢˜äº†ã€‚è¯¥ç»„ä»¶å°±æ˜¯AQSã€‚</p><p>AQSï¼š<strong>AbstractQueuedSynchronizer</strong>ï¼Œå³<strong>é˜Ÿåˆ—åŒæ­¥å™¨</strong>ã€‚å®ƒæ˜¯æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼ˆå¦‚ReentrantLockã€ReentrantReadWriteLockã€Semaphoreç­‰ï¼‰ï¼ŒJUCå¹¶å‘åŒ…çš„ä½œè€…ï¼ˆDoug Leaï¼‰æœŸæœ›å®ƒèƒ½å¤Ÿæˆä¸ºå®ç°å¤§éƒ¨åˆ†åŒæ­¥éœ€æ±‚çš„åŸºç¡€ã€‚å®ƒæ˜¯JUCå¹¶å‘åŒ…ä¸­çš„æ ¸å¿ƒåŸºç¡€ç»„ä»¶ã€‚</p><p>AQSè§£å†³äº†å­ç±»å®ç°åŒæ­¥å™¨æ—¶æ¶‰åŠå½“çš„å¤§é‡ç»†èŠ‚é—®é¢˜ï¼Œä¾‹å¦‚è·å–åŒæ­¥çŠ¶æ€ã€FIFOåŒæ­¥é˜Ÿåˆ—ã€‚åŸºäºAQSæ¥æ„å»ºåŒæ­¥å™¨å¯ä»¥å¸¦æ¥å¾ˆå¤šå¥½å¤„ã€‚å®ƒä¸ä»…èƒ½å¤Ÿæå¤§åœ°å‡å°‘å®ç°å·¥ä½œï¼Œè€Œä¸”ä¹Ÿä¸å¿…å¤„ç†åœ¨å¤šä¸ªä½ç½®ä¸Šå‘ç”Ÿçš„ç«äº‰é—®é¢˜ã€‚</p><p>åœ¨åŸºäºAQSæ„å»ºçš„åŒæ­¥å™¨ä¸­ï¼Œåªèƒ½åœ¨ä¸€ä¸ªæ—¶åˆ»å‘ç”Ÿé˜»å¡ï¼Œä»è€Œé™ä½ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæé«˜äº†ååé‡ã€‚åŒæ—¶åœ¨è®¾è®¡AQSæ—¶å……åˆ†è€ƒè™‘äº†å¯ä¼¸ç¼©è¡Œï¼Œå› æ­¤J.U.Cä¸­æ‰€æœ‰åŸºäºAQSæ„å»ºçš„åŒæ­¥å™¨å‡å¯ä»¥è·å¾—è¿™ä¸ªä¼˜åŠ¿ã€‚</p><p>AQSçš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯ç»§æ‰¿ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿åŒæ­¥å™¨å¹¶å®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ã€‚</p><p>AQSä½¿ç”¨ä¸€ä¸ªintç±»å‹çš„æˆå‘˜å˜é‡stateæ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œå½“state&gt;0æ—¶è¡¨ç¤ºå·²ç»è·å–äº†é”ï¼Œå½“state = 0æ—¶è¡¨ç¤ºé‡Šæ”¾äº†é”ã€‚å®ƒæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼ˆgetState()ã€setState(int newState)ã€compareAndSetState(int expect,int update)ï¼‰æ¥å¯¹åŒæ­¥çŠ¶æ€stateè¿›è¡Œæ“ä½œï¼Œå½“ç„¶AQSå¯ä»¥ç¡®ä¿å¯¹stateçš„æ“ä½œæ˜¯å®‰å…¨çš„ã€‚</p><p>ï¼ˆPS:<strong>state</strong>åœ¨ä¸åŒçš„å·¥å…·ä¸­ä»£å˜ç€ä¸åŒçš„è¯­ä¹‰ï¼Œå¯ä»¥æ˜¯ä»£å˜è·å–é”ã€åˆ°è¾¾çš„çº¿ç¨‹æ•°ã€ä¿¡å·é‡ç­‰ï¼‰</p><p>AQSé€šè¿‡å†…ç½®çš„FIFOåŒæ­¥é˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼ˆé”ï¼‰æ—¶ï¼ŒAQSåˆ™ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œåˆ™ä¼šæŠŠèŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚</p><p>ï¼ˆPS:AQSå†…éƒ¨çš„é˜Ÿåˆ—å®ç°äº†çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ï¼Œç›¸å½“äºå¸®åŠ©ä½¿ç”¨è€…å±è”½äº†çº¿ç¨‹æ“ä½œçš„å·¥ä½œï¼‰</p><h2 id="AQSæä¾›çš„æ–¹æ³•"><a class="header-anchor" href="#AQSæä¾›çš„æ–¹æ³•"></a>AQSæä¾›çš„æ–¹æ³•</h2><ul><li>getState()ï¼šè¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼ï¼›</li><li>setState(int newState)ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ï¼›</li><li>compareAndSetState(int expect, int update)ï¼šä½¿ç”¨CASè®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§ï¼›</li><li>tryAcquire(int arg)ï¼šç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–åŒæ­¥çŠ¶æ€æˆåŠŸåï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…è¯¥çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€æ‰èƒ½è·å–åŒæ­¥çŠ¶æ€</li><li>tryRelease(int arg)ï¼šç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼›</li><li>tryAcquireShared(int arg)ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›å€¼å¤§äºç­‰äº0åˆ™è¡¨ç¤ºè·å–æˆåŠŸï¼Œå¦åˆ™è·å–å¤±è´¥ï¼›</li><li>tryReleaseShared(int arg)ï¼šå…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼›</li><li>isHeldExclusively()ï¼šå½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å å¼æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ï¼Œä¸€èˆ¬è¯¥æ–¹æ³•è¡¨ç¤ºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹æ‰€ç‹¬å ï¼›</li><li>acquire(int arg)ï¼šç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç”±è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå°†ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¯¥æ–¹æ³•å°†ä¼šè°ƒç”¨å¯é‡å†™çš„tryAcquire(int arg)æ–¹æ³•ï¼›</li><li>acquireInterruptibly(int arg)ï¼šä¸acquire(int arg)ç›¸åŒï¼Œä½†æ˜¯è¯¥æ–¹æ³•å“åº”ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹ä¸ºè·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸å¹¶è¿”å›ï¼›</li><li>tryAcquireNanos(int arg,long nanos)ï¼šè¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨nanosæ—¶é—´å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œé‚£ä¹ˆå°†ä¼šè¿”å›falseï¼Œå·²ç»è·å–åˆ™è¿”å›true</li><li>acquireShared(int arg)ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œå°†ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œä¸ç‹¬å å¼çš„ä¸»è¦åŒºåˆ«æ˜¯åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼›</li><li>acquireSharedInterruptibly(int arg)ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå“åº”ä¸­æ–­ï¼›</li><li>tryAcquireSharedNanos(int arg, long nanosTimeout)ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¢åŠ è¶…æ—¶é™åˆ¶ï¼›</li><li>release(int arg)ï¼šç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹å”¤é†’ï¼›</li><li>releaseShared(int arg)ï¼šå…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼›</li></ul><h3 id="CLHåŒæ­¥é˜Ÿåˆ—"><a class="header-anchor" href="#CLHåŒæ­¥é˜Ÿåˆ—"></a>CLHåŒæ­¥é˜Ÿåˆ—</h3><p>CLHåŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ª<strong>FIFOåŒå‘é˜Ÿåˆ—</strong>ï¼ŒAQSä¾èµ–å®ƒæ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼Œå½“å‰çº¿ç¨‹å¦‚æœè·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒAQSåˆ™ä¼šå°†å½“å‰çº¿ç¨‹å·²ç»ç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼š<strong>é˜»å¡å½“å‰çº¿ç¨‹</strong>ï¼Œå½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹å”¤é†’ï¼ˆå…¬å¹³é”ï¼‰ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚</p><p>åœ¨CLHåŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆthreadï¼‰ã€çŠ¶æ€ï¼ˆwaitStatusï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆprevï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** å…±äº« */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> SHARED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/** ç‹¬å  */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> EXCLUSIVE <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">/**     * å› ä¸ºè¶…æ—¶æˆ–è€…ä¸­æ–­ï¼ŒèŠ‚ç‚¹ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œè¢«å–æ¶ˆçš„èŠ‚ç‚¹æ—¶ä¸ä¼šå‚ä¸åˆ°ç«äº‰ä¸­çš„ï¼Œä»–ä¼šä¸€ç›´ä¿æŒå–æ¶ˆçŠ¶æ€ä¸ä¼šè½¬å˜ä¸ºå…¶ä»–çŠ¶æ€ï¼›     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CANCELLED <span class="token operator">=</span>  <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/**     * åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œå½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹å¦‚æœé‡Šæ”¾äº†åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆï¼Œå°†ä¼šé€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œä½¿åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¾—ä»¥è¿è¡Œ     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIGNAL    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/**     * èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨äº†signal()åï¼Œæ”¹èŠ‚ç‚¹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°åŒæ­¥çŠ¶æ€çš„è·å–ä¸­     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CONDITION <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">/**     * è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–å°†ä¼šæ— æ¡ä»¶åœ°ä¼ æ’­ä¸‹å»     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PROPAGATE <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>    <span class="token comment">/** ç­‰å¾…çŠ¶æ€ */</span>    <span class="token keyword">volatile</span> <span class="token keyword">int</span> waitStatus<span class="token punctuation">;</span>    <span class="token comment">/** å‰é©±èŠ‚ç‚¹ */</span>    <span class="token keyword">volatile</span> <span class="token class-name">Node</span> prev<span class="token punctuation">;</span>    <span class="token comment">/** åç»§èŠ‚ç‚¹ */</span>    <span class="token keyword">volatile</span> <span class="token class-name">Node</span> next<span class="token punctuation">;</span>    <span class="token comment">/** è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ */</span>    <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>    <span class="token class-name">Node</span> nextWaiter<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> nextWaiter <span class="token operator">==</span> SHARED<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">final</span> <span class="token class-name">Node</span> <span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NullPointerException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> p <span class="token operator">=</span> prev<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token keyword">return</span> p<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">,</span> <span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>nextWaiter <span class="token operator">=</span> mode<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> thread<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">,</span> <span class="token keyword">int</span> waitStatus<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>waitStatus <span class="token operator">=</span> waitStatus<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> thread<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CLHåŒæ­¥é˜Ÿåˆ—ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://s1.ax1x.com/2020/06/03/tdb0ds.png" alt="tdb0ds.png"></p><h3 id="å…¥åˆ—"><a class="header-anchor" href="#å…¥åˆ—"></a>å…¥åˆ—</h3><p>å­¦äº†æ•°æ®ç»“æ„çš„æˆ‘ä»¬ï¼ŒCLHé˜Ÿåˆ—å…¥åˆ—æ˜¯å†ç®€å•ä¸è¿‡äº†ï¼Œæ— éå°±æ˜¯</p><ol><li>tailæŒ‡å‘æ–°èŠ‚ç‚¹ã€</li><li>æ–°èŠ‚ç‚¹çš„prevæŒ‡å‘å½“å‰æœ€åçš„èŠ‚ç‚¹ï¼Œ</li><li>å½“å‰æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„nextæŒ‡å‘æ–°èŠ‚ç‚¹ã€‚<br>ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹çœ‹addWaiter(Node node)æ–¹æ³•ï¼š</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">//æ–°å»ºNode</span>     <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//å¿«é€Ÿå°è¯•æ·»åŠ å°¾èŠ‚ç‚¹</span>     <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>         <span class="token comment">//CASè®¾ç½®å°¾èŠ‚ç‚¹</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>             pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>             <span class="token keyword">return</span> node<span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span>     <span class="token comment">//å¤šæ¬¡å°è¯•</span>     <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> node<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>addWaiter(Node node)å…ˆé€šè¿‡å¿«é€Ÿå°è¯•è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è°ƒç”¨enq(Node node)æ–¹æ³•è®¾ç½®å°¾èŠ‚ç‚¹<br>(PS: å¦‚æœå½“å‰å°¾èŠ‚ç‚¹å­˜åœ¨å°±é€šè¿‡CASæœºåˆ¶è®¾ç½®å½“å‰å°¾èŠ‚ç‚¹çš„nextèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹)</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//å¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>        <span class="token comment">//tailä¸å­˜åœ¨ï¼Œè®¾ç½®ä¸ºé¦–èŠ‚ç‚¹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                tail <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹</span>            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>                <span class="token keyword">return</span> t<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªCASæ–¹æ³•compareAndSetTail(Node expect, Node update)æ¥è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•å¯ä»¥ç¡®ä¿èŠ‚ç‚¹æ˜¯çº¿ç¨‹å®‰å…¨æ·»åŠ çš„ã€‚åœ¨enq(Node node)æ–¹æ³•ä¸­ï¼ŒAQSé€šè¿‡â€œæ­»å¾ªç¯â€çš„æ–¹å¼æ¥ä¿è¯èŠ‚ç‚¹å¯ä»¥æ­£ç¡®æ·»åŠ ï¼Œåªæœ‰æˆåŠŸæ·»åŠ åï¼Œå½“å‰çº¿ç¨‹æ‰ä¼šä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚<br>(PSï¼šé€šè¿‡â€œè‡ªæ—‹â€çš„æ–¹å¼è®¾ç½®å°¾èŠ‚ç‚¹)</p><h3 id="å‡ºåˆ—"><a class="header-anchor" href="#å‡ºåˆ—"></a>å‡ºåˆ—</h3><p>CLHåŒæ­¥é˜Ÿåˆ—éµå¾ªFIFOï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†ä¼šå”¤é†’å®ƒçš„åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ï¼Œè€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹éå¸¸ç®€å•ï¼Œheadæ‰§è¡Œè¯¥èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„nextå’Œå½“å‰èŠ‚ç‚¹çš„prevå³å¯ï¼Œæ³¨æ„åœ¨è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯çš„ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚</p><h2 id="åŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾"><a class="header-anchor" href="#åŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾"></a>åŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾</h2><p>åœ¨å‰é¢æåˆ°è¿‡ï¼ŒAQSæ˜¯æ„å»ºJavaåŒæ­¥ç»„ä»¶çš„åŸºç¡€ï¼Œæˆ‘ä»¬æœŸå¾…å®ƒèƒ½å¤Ÿæˆä¸ºå®ç°å¤§éƒ¨åˆ†åŒæ­¥éœ€æ±‚çš„åŸºç¡€ã€‚<strong>AQSçš„è®¾è®¡æ¨¡å¼</strong>é‡‡ç”¨çš„<strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿çš„æ–¹å¼ï¼Œå®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œå¯¹äºå­ç±»è€Œè¨€å®ƒå¹¶æ²¡æœ‰å¤ªå¤šçš„æ´»è¦åšï¼ŒAQSæä¾›äº†å¤§é‡çš„æ¨¡æ¿æ–¹æ³•æ¥å®ç°åŒæ­¥ï¼Œä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ç±»ï¼š<strong>ç‹¬å å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€<strong>å…±äº«å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€<strong>æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µ</strong>ã€‚è‡ªå®šä¹‰å­ç±»ä½¿ç”¨AQSæä¾›çš„æ¨¡æ¿æ–¹æ³•å°±å¯ä»¥å®ç°è‡ªå·±çš„åŒæ­¥è¯­ä¹‰ã€‚</p><h3 id="ç‹¬å å¼"><a class="header-anchor" href="#ç‹¬å å¼"></a>ç‹¬å å¼</h3><blockquote><p>ç‹¬å å¼ï¼ŒåŒä¸€æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰åŒæ­¥çŠ¶æ€ã€‚</p></blockquote><p><strong>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–</strong><br>acquire(int arg)æ–¹æ³•ä¸ºAQSæä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯è¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ç”±äºçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåç»­å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸ä¼šä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å„ä¸ªæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><ul><li>tryAcquireï¼š</li></ul><blockquote><p>å»å°è¯•è·å–é”ï¼Œè·å–æˆåŠŸåˆ™è®¾ç½®é”çŠ¶æ€å¹¶è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚è¯¥æ–¹æ³•è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶è‡ªå·±å®ç°ï¼Œè¯¥æ–¹æ³•å¿…é¡»è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€ã€‚</p></blockquote><ul><li>addWaiter</li></ul><blockquote><p>å¦‚æœtryAcquireè¿”å›FALSEï¼ˆè·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼‰ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ã€‚</p></blockquote><ul><li>acquireQueued</li></ul><blockquote><p>å½“å‰çº¿ç¨‹ä¼šæ ¹æ®å…¬å¹³æ€§åŸåˆ™æ¥è¿›è¡Œé˜»å¡ç­‰å¾…ï¼ˆè‡ªæ—‹ï¼‰,ç›´åˆ°è·å–é”ä¸ºæ­¢ï¼›å¹¶ä¸”è¿”å›å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰ä¸­æ–­è¿‡ã€‚</p></blockquote><ul><li>selfInterrupt</li></ul><blockquote><p>äº§ç”Ÿä¸€ä¸ªä¸­æ–­ã€‚</p></blockquote><p><strong>acquireQueuedæ–¹æ³•</strong>ä¸ºä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹ï¼ˆNodeï¼‰è¿›å…¥åŒæ­¥é˜Ÿåˆ—åï¼Œå°±ä¼šè¿›å…¥ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè‡ªçœåœ°è§‚å¯Ÿï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°åŒæ­¥çŠ¶æ€åï¼Œå°±å¯ä»¥ä»è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºï¼Œå¦åˆ™ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚</p><p>å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸­æ–­æ ‡å¿—</span>            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment">/*             * è‡ªæ—‹è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯è€Œå·²             */</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹</span>                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ï¼Œä¸”åŒæ­¥çŠ¶æ€æˆåŠŸ</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//è·å–å¤±è´¥ï¼Œçº¿ç¨‹ç­‰å¾…--å…·ä½“åé¢ä»‹ç»</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                        <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰çº¿ç¨‹ä¼šä¸€ç›´å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå½“ç„¶å‰ææ˜¯åªæœ‰å…¶å‰é©±èŠ‚ç‚¹ä¸ºå¤´ç»“ç‚¹æ‰èƒ½å¤Ÿå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œç†ç”±ï¼š</p><ul><li><p>ä¿æŒFIFOåŒæ­¥é˜Ÿåˆ—åŸåˆ™ã€‚</p></li><li><p>å¤´èŠ‚ç‚¹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†ä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹è¢«å”¤é†’åéœ€è¦æ£€æŸ¥è‡ªå·±æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ã€‚</p></li></ul><p>(PSï¼šåªæœ‰åœ¨å‰ç½®èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ£€æŸ¥åŒæ­¥çŠ¶æ€)</p><p>acquire(int arg)æ–¹æ³•æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://s1.ax1x.com/2020/06/03/tdxrB8.jpg" alt="tdxrB8.jpg"></p><h3 id="ç‹¬å å¼è·å–å“åº”ä¸­æ–­"><a class="header-anchor" href="#ç‹¬å å¼è·å–å“åº”ä¸­æ–­"></a>ç‹¬å å¼è·å–å“åº”ä¸­æ–­</h3><p>AQSæä¾›äº†acquire(int arg)æ–¹æ³•ä»¥ä¾›ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯è¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸å“åº”ï¼Œå¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œåï¼Œè¯¥çº¿ç¨‹ä¼šä¾ç„¶ä½äºCLHåŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ç€è·å–åŒæ­¥çŠ¶æ€ã€‚ä¸ºäº†å“åº”ä¸­æ–­ï¼ŒAQSæä¾›äº†acquireInterruptibly(int arg)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ç­‰å¾…è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œä¼šç«‹åˆ»å“åº”ä¸­æ–­æŠ›å‡ºå¼‚å¸¸InterruptedExceptionã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆæ ¡éªŒè¯¥çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­äº†ï¼Œå¦‚æœæ˜¯åˆ™æŠ›å‡ºInterruptedExceptionï¼Œå¦åˆ™æ‰§è¡ŒtryAcquire(int arg)æ–¹æ³•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡ŒdoAcquireInterruptibly(int arg)ã€‚doAcquireInterruptibly(int arg)å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>doAcquireInterruptibly(int arg)æ–¹æ³•ä¸acquire(int arg)æ–¹æ³•ä»…æœ‰ä¸¤ä¸ªå·®åˆ«ã€‚</p><p>1.æ–¹æ³•å£°æ˜æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚</p><p>2.åœ¨ä¸­æ–­æ–¹æ³•å¤„ä¸å†æ˜¯ä½¿ç”¨interruptedæ ‡å¿—ï¼Œè€Œæ˜¯ç›´æ¥æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚</p><h3 id="ç‹¬å å¼è¶…æ—¶è·å–"><a class="header-anchor" href="#ç‹¬å å¼è¶…æ—¶è·å–"></a>ç‹¬å å¼è¶…æ—¶è·å–</h3><p>AQSé™¤äº†æä¾›ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¤–ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªå¢å¼ºç‰ˆçš„æ–¹æ³•ï¼štryAcquireNanos(int arg,long nanos)ã€‚è¯¥æ–¹æ³•ä¸ºacquireInterruptiblyæ–¹æ³•çš„è¿›ä¸€æ­¥å¢å¼ºï¼Œå®ƒé™¤äº†å“åº”ä¸­æ–­å¤–ï¼Œè¿˜æœ‰è¶…æ—¶æ§åˆ¶ã€‚å³å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰åœ¨æŒ‡å®šæ—¶é—´å†…è·å–åŒæ­¥çŠ¶æ€ï¼Œåˆ™ä¼šè¿”å›falseï¼Œå¦åˆ™è¿”å›trueã€‚å¦‚ä¸‹ï¼š</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">,</span> <span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">||</span>        <span class="token function">doAcquireNanos</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> nanosTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tryAcquireNanos(int arg, long nanosTimeout)æ–¹æ³•è¶…æ—¶è·å–æœ€ç»ˆæ˜¯åœ¨doAcquireNanos(int arg, long nanosTimeout)ä¸­å®ç°çš„ï¼Œå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">doAcquireNanos</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">,</span> <span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//nanosTimeout &lt;= 0</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nanosTimeout <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment">//è¶…æ—¶æ—¶é—´</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> nanosTimeout<span class="token punctuation">;</span>        <span class="token comment">//æ–°å¢NodeèŠ‚ç‚¹</span>        <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è‡ªæ—‹</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//è·å–åŒæ­¥çŠ¶æ€æˆåŠŸ</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">/*                 * è·å–å¤±è´¥ï¼Œåšè¶…æ—¶ã€ä¸­æ–­åˆ¤æ–­                 */</span>                <span class="token comment">//é‡æ–°è®¡ç®—éœ€è¦ä¼‘çœ çš„æ—¶é—´</span>                nanosTimeout <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å·²ç»è¶…æ—¶ï¼Œè¿”å›false</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>nanosTimeout <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token comment">//å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œåˆ™ç­‰å¾…nanosTimeoutçº³ç§’</span>                <span class="token comment">//æ³¨ï¼šè¯¥çº¿ç¨‹ä¼šç›´æ¥ä»LockSupport.parkNanosä¸­è¿”å›ï¼Œ</span>                <span class="token comment">//LockSupportä¸ºJUCæä¾›çš„ä¸€ä¸ªé˜»å¡å’Œå”¤é†’çš„å·¥å…·ç±»ï¼Œåé¢åšè¯¦ç»†ä»‹ç»</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                        nanosTimeout <span class="token operator">></span> spinForTimeoutThreshold<span class="token punctuation">)</span>                    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nanosTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­äº†</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é’ˆå¯¹è¶…æ—¶æ§åˆ¶ï¼Œç¨‹åºé¦–å…ˆè®°å½•å”¤é†’æ—¶é—´deadline ï¼Œdeadline = System.nanoTime() + nanosTimeoutï¼ˆæ—¶é—´é—´éš”ï¼‰ã€‚å¦‚æœè·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼Œåˆ™éœ€è¦è®¡ç®—å‡ºéœ€è¦ä¼‘çœ çš„æ—¶é—´é—´éš”nanosTimeoutï¼ˆ= deadline - System.nanoTime()ï¼‰ï¼Œå¦‚æœnanosTimeout &lt;= 0 è¡¨ç¤ºå·²ç»è¶…æ—¶äº†ï¼Œè¿”å›falseï¼Œå¦‚æœå¤§äºspinForTimeoutThresholdï¼ˆ1000Lï¼‰åˆ™éœ€è¦ä¼‘çœ nanosTimeout ï¼Œå¦‚æœnanosTimeout &lt;= spinForTimeoutThreshold ï¼Œå°±ä¸éœ€è¦ä¼‘çœ äº†ï¼Œç›´æ¥è¿›å…¥å¿«é€Ÿè‡ªæ—‹çš„è¿‡ç¨‹ã€‚åŸå› åœ¨äº spinForTimeoutThreshold å·²ç»éå¸¸å°äº†ï¼Œéå¸¸çŸ­çš„æ—¶é—´ç­‰å¾…æ— æ³•åšåˆ°ååˆ†ç²¾ç¡®ï¼Œå¦‚æœè¿™æ—¶å†æ¬¡è¿›è¡Œè¶…æ—¶ç­‰å¾…ï¼Œç›¸åä¼šè®©nanosTimeout çš„è¶…æ—¶ä»æ•´ä½“ä¸Šé¢è¡¨ç°å¾—ä¸æ˜¯é‚£ä¹ˆç²¾ç¡®ï¼Œæ‰€ä»¥åœ¨è¶…æ—¶éå¸¸çŸ­çš„åœºæ™¯ä¸­ï¼ŒAQSä¼šè¿›è¡Œæ— æ¡ä»¶çš„å¿«é€Ÿè‡ªæ—‹ã€‚</p><p>(PS:è‡ªæ—‹çš„è®¾è®¡æŠ€å·§åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…é‡‡ç”¨è‡ªæ—‹ï¼Œåœ¨è¿˜å‰©è¾ƒé•¿çš„æ—¶é—´å†…é‡‡ç”¨ä¼‘çœ çš„æ–¹å¼)</p><p><img src="https://s1.ax1x.com/2020/06/03/twptNF.png" alt="twptNF.png"></p><h3 id="ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"><a class="header-anchor" href="#ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"></a>ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾</h3><p>å½“çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€åï¼Œæ‰§è¡Œå®Œç›¸åº”é€»è¾‘åå°±éœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚AQSæä¾›äº†<strong>release(int arg)æ–¹æ³•</strong>é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼š</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥æ–¹æ³•åŒæ ·æ˜¯å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨è‡ªå®šä¹‰çš„tryRelease(int arg)æ–¹æ³•æ¥é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé‡Šæ”¾æˆåŠŸåï¼Œä¼šè°ƒç”¨unparkSuccessor(Node node)æ–¹æ³•å”¤é†’åç»§èŠ‚ç‚¹ï¼ˆå¦‚ä½•å”¤é†’LZåé¢ä»‹ç»ï¼‰ã€‚</p><p>è¿™é‡Œç¨å¾®æ€»ç»“ä¸‹ï¼š</p> <pre class="line-numbers language-none"><code class="language-none">åœ¨AQSä¸­ç»´æŠ¤ç€ä¸€ä¸ªFIFOçš„åŒæ­¥é˜Ÿåˆ—ï¼Œå½“çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åï¼Œåˆ™ä¼šåŠ å…¥åˆ°è¿™ä¸ªCLHåŒæ­¥é˜Ÿåˆ—çš„å¯¹å°¾å¹¶ä¸€ç›´ä¿æŒç€è‡ªæ—‹ã€‚åœ¨CLHåŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹åœ¨è‡ªæ—‹æ—¶ä¼šåˆ¤æ–­å…¶å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºé¦–èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºé¦–èŠ‚ç‚¹åˆ™ä¸æ–­å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–æˆåŠŸåˆ™é€€å‡ºCLHåŒæ­¥é˜Ÿåˆ—ã€‚å½“çº¿ç¨‹æ‰§è¡Œå®Œé€»è¾‘åï¼Œä¼šé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé‡Šæ”¾åä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å…±äº«å¼"><a class="header-anchor" href="#å…±äº«å¼"></a>å…±äº«å¼</h3><p>å…±äº«å¼ä¸ç‹¬å å¼çš„æœ€ä¸»è¦åŒºåˆ«åœ¨äºåŒä¸€æ—¶åˆ»ç‹¬å å¼åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ï¼Œè€Œå…±äº«å¼åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ã€‚ä¾‹å¦‚è¯»æ“ä½œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œï¼Œè€Œå†™æ“ä½œåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå†™æ“ä½œï¼Œå…¶ä»–æ“ä½œéƒ½ä¼šè¢«é˜»å¡ã€‚</p><h4 id="å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–"><a class="header-anchor" href="#å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–"></a>å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–</h4><p>AQSæä¾›acquireShared(int arg)æ–¹æ³•å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼š</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment">//è·å–å¤±è´¥ï¼Œè‡ªæ—‹è·å–åŒæ­¥çŠ¶æ€</span>        <span class="token function">doAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢ç¨‹åºå¯ä»¥çœ‹å‡ºï¼Œæ–¹æ³•é¦–å…ˆæ˜¯è°ƒç”¨tryAcquireShared(int arg)æ–¹æ³•å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–å¤±è´¥åˆ™è°ƒç”¨doAcquireShared(int arg)è‡ªæ—‹æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€çš„æ ‡å¿—æ˜¯è¿”å› &gt;= 0 çš„å€¼è¡¨ç¤ºè·å–æˆåŠŸã€‚è‡ªé€‰å¼è·å–åŒæ­¥çŠ¶æ€å¦‚ä¸‹ï¼š</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">/</span>å…±äº«å¼èŠ‚ç‚¹    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>SHARED<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å‰é©±èŠ‚ç‚¹</span>            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å¦‚æœå…¶å‰é©±èŠ‚ç‚¹ï¼Œè·å–åŒæ­¥çŠ¶æ€</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å°è¯•è·å–åŒæ­¥</span>                <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>                        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tryAcquireShared(int arg)æ–¹æ³•å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›å€¼ä¸ºintï¼Œå½“å…¶ &gt;= 0 æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä»è‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºã€‚</p><p>acquireShared(int arg)æ–¹æ³•ä¸å“åº”ä¸­æ–­ï¼Œä¸ç‹¬å å¼ç›¸ä¼¼ï¼ŒAQSä¹Ÿæä¾›äº†å“åº”ä¸­æ–­ã€è¶…æ—¶çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼šacquireSharedInterruptibly(int arg)ã€tryAcquireSharedNanos(int arg,long nanos)ï¼Œè¿™é‡Œå°±ä¸åšè§£é‡Šäº†ã€‚</p><h4 id="å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"><a class="header-anchor" href="#å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"></a>å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾</h4><p>è·å–åŒæ­¥çŠ¶æ€åï¼Œéœ€è¦è°ƒç”¨release(int arg)æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºå¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œé‡Šæ”¾åŒæ­¥çŠ¶æ€èµ„æºï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿åŒæ­¥çŠ¶æ€å®‰å…¨åœ°æˆåŠŸé‡Šæ”¾ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡<strong>CAS</strong>å’Œ<strong>å¾ªç¯</strong>æ¥å®Œæˆçš„ã€‚</p><h3 id="é˜»å¡å’Œå”¤é†’çº¿ç¨‹"><a class="header-anchor" href="#é˜»å¡å’Œå”¤é†’çº¿ç¨‹"></a>é˜»å¡å’Œå”¤é†’çº¿ç¨‹</h3><p>åœ¨çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æ—¶å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™åŠ å…¥CLHåŒæ­¥é˜Ÿåˆ—ï¼Œé€šè¿‡é€šè¿‡è‡ªæ—‹çš„æ–¹å¼ä¸æ–­è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­åˆ™éœ€è¦åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡ï¼Œå…¶ä¸»è¦æ–¹æ³•åœ¨acquireQueued()ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é€šè¿‡è¿™æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯ç«‹é©¬è¿›è¡Œé˜»å¡ï¼Œéœ€è¦æ£€æŸ¥è¯¥çº¿ç¨‹çš„çŠ¶æ€ï¼Œæ£€æŸ¥çŠ¶æ€çš„æ–¹æ³•ä¸º shouldParkAfterFailedAcquire(Node pred, Node node) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦é å‰é©±èŠ‚ç‚¹åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//å‰é©±èŠ‚ç‚¹</span>    <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>    <span class="token comment">//çŠ¶æ€ä¸ºsignalï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´æ¥æ”¾å›true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">//å‰é©±èŠ‚ç‚¹çŠ¶æ€ > 0 ï¼Œåˆ™ä¸ºCancelled,è¡¨æ˜è¯¥èŠ‚ç‚¹å·²ç»è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­äº†ï¼Œéœ€è¦ä»åŒæ­¥é˜Ÿåˆ—ä¸­å–æ¶ˆ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">//å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºConditionã€propagate</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç ä¸»è¦æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœå½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSINNALï¼Œåˆ™è¡¨æ˜å½“å‰çº¿ç¨‹éœ€è¦è¢«é˜»å¡ï¼Œè°ƒç”¨unpark()æ–¹æ³•å”¤é†’ï¼Œç›´æ¥è¿”å›trueï¼Œå½“å‰çº¿ç¨‹é˜»å¡</li><li>å¦‚æœå½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºCANCELLEDï¼ˆws &gt; 0ï¼‰ï¼Œåˆ™è¡¨æ˜è¯¥çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹å·²ç»ç­‰å¾…è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­äº†ï¼Œåˆ™éœ€è¦ä»CLHé˜Ÿåˆ—ä¸­å°†è¯¥å‰é©±èŠ‚ç‚¹åˆ é™¤æ‰ï¼Œç›´åˆ°å›æº¯åˆ°å‰é©±èŠ‚ç‚¹çŠ¶æ€ &lt;= 0 ï¼Œè¿”å›false</li><li>å¦‚æœå‰é©±èŠ‚ç‚¹éSINNALï¼ŒéCANCELLEDï¼Œåˆ™é€šè¿‡CASçš„æ–¹å¼å°†å…¶å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºSINNALï¼Œè¿”å›false<br>å¦‚æœ shouldParkAfterFailedAcquire(Node pred, Node node) æ–¹æ³•è¿”å›trueï¼Œåˆ™è°ƒç”¨parkAndCheckInterrupt()æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ï¼š</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>parkAndCheckInterrupt() æ–¹æ³•ä¸»è¦æ˜¯æŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œä»è€Œé˜»å¡ä½çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼ŒåŒæ—¶è¿”å›å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚å…¶å†…éƒ¨åˆ™æ˜¯è°ƒç”¨LockSupportå·¥å…·ç±»çš„park()æ–¹æ³•æ¥é˜»å¡è¯¥æ–¹æ³•ã€‚</p><p>å½“çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œåˆ™éœ€è¦å”¤é†’è¯¥çº¿ç¨‹çš„åç»§èŠ‚ç‚¹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token comment">//å”¤é†’åç»§èŠ‚ç‚¹</span>            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨unparkSuccessor(Node node)å”¤é†’åç»§èŠ‚ç‚¹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//å½“å‰èŠ‚ç‚¹çŠ¶æ€</span>    <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>    <span class="token comment">//å½“å‰çŠ¶æ€ &lt; 0 åˆ™è®¾ç½®ä¸º 0</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>    <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token comment">//åç»§èŠ‚ç‚¹ä¸ºnullæˆ–è€…å…¶çŠ¶æ€ > 0 (è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­äº†)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">//ä»tailèŠ‚ç‚¹æ¥æ‰¾å¯ç”¨èŠ‚ç‚¹</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>                s <span class="token operator">=</span> t<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å”¤é†’åç»§èŠ‚ç‚¹</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯èƒ½ä¼šå­˜åœ¨å½“å‰çº¿ç¨‹çš„åç»§èŠ‚ç‚¹ä¸ºnullï¼Œè¶…æ—¶ã€è¢«ä¸­æ–­çš„æƒ…å†µï¼Œå¦‚æœé‡åˆ°è¿™ç§æƒ…å†µäº†ï¼Œåˆ™éœ€è¦è·³è¿‡è¯¥èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸ºä½•æ˜¯ä»tailå°¾èŠ‚ç‚¹å¼€å§‹ï¼Œè€Œä¸æ˜¯ä»node.nextå¼€å§‹å‘¢ï¼ŸåŸå› åœ¨äºnode.nextä»ç„¶å¯èƒ½ä¼šå­˜åœ¨nullæˆ–è€…å–æ¶ˆäº†ï¼Œæ‰€ä»¥é‡‡ç”¨tailå›æº¯åŠæ³•æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨çš„çº¿ç¨‹ã€‚æœ€åè°ƒç”¨LockSupportçš„unpark(Thread thread)æ–¹æ³•å”¤é†’è¯¥çº¿ç¨‹ã€‚</p><h2 id="LockSupport"><a class="header-anchor" href="#LockSupport"></a>LockSupport</h2><p>ä»ä¸Šé¢æˆ‘å¯ä»¥çœ‹åˆ°ï¼Œå½“éœ€è¦é˜»å¡æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼ŒAQSéƒ½æ˜¯ä½¿ç”¨LockSupportè¿™ä¸ªå·¥å…·ç±»æ¥å®Œæˆçš„ã€‚</p><blockquote><p>LockSupportæ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­</p></blockquote><p>æ¯ä¸ªä½¿ç”¨LockSupportçš„çº¿ç¨‹éƒ½ä¼šä¸ä¸€ä¸ªè®¸å¯å…³è”ï¼Œå¦‚æœè¯¥è®¸å¯å¯ç”¨ï¼Œå¹¶ä¸”å¯åœ¨è¿›ç¨‹ä¸­ä½¿ç”¨ï¼Œåˆ™è°ƒç”¨park()å°†ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™å¯èƒ½é˜»å¡ã€‚å¦‚æœè®¸å¯å°šä¸å¯ç”¨ï¼Œåˆ™å¯ä»¥è°ƒç”¨ unpark ä½¿å…¶å¯ç”¨ã€‚ä½†æ˜¯æ³¨æ„è®¸å¯ä¸å¯é‡å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½è°ƒç”¨ä¸€æ¬¡park()æ–¹æ³•ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ã€‚</p><p>LockSupportå®šä¹‰äº†ä¸€ç³»åˆ—ä»¥parkå¼€å¤´çš„æ–¹æ³•æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œunpark(Thread thread)æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ–¹æ³•åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>park()</td><td>é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœè°ƒç”¨unpark(Thread thread)æ–¹æ³•æˆ–è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼Œæ‰ä¼šä»park()æ–¹æ³•ä¸­è¿”å›</td></tr><tr><td>park(Object blocker)</td><td>ä¸ºäº†çº¿ç¨‹è°ƒåº¦ï¼Œåœ¨è®¸å¯å¯ç”¨ä¹‹å‰ç¦ç”¨å½“å‰çº¿ç¨‹</td></tr><tr><td>parkNanos(long nanos)</td><td>ä¸ºäº†çº¿ç¨‹è°ƒåº¦ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œæœ€å¤šç­‰å¾…æŒ‡å®šçš„æ—¶é—´ï¼Œé™¤éè®¸å¯å¯ç”¨</td></tr><tr><td>parkNanos(Object blocker,long nanos)</td><td>ä¸ºäº†çº¿ç¨‹è°ƒåº¦ï¼Œåœ¨è®¸å¯å¯ç”¨ä¹‹å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œæœ€å¤šç­‰å¾…nanosç§’</td></tr><tr><td>parkUntil(long deadline)</td><td>ä¸ºäº†çº¿ç¨‹è°ƒåº¦ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œé™¤éè®¸å¯å¯ç”¨</td></tr><tr><td>parkUntil(Object blocker,long deadline)</td><td>ä¸ºäº†çº¿ç¨‹è°ƒåº¦ï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œé™¤éè®¸å¯å¯ç”¨</td></tr><tr><td>unpark(Thread thread)</td><td>å¦‚æœç»™å®šçš„çº¿ç¨‹çš„è®¸å¯å°šä¸å¯ç”¨ï¼Œåˆ™ä½¿å…¶å¯ç”¨</td></tr></tbody></table><p>park(Object blocker)æ–¹æ³•çš„blockerå‚æ•°ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸»è¦ç”¨äºé—®é¢˜æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§ã€‚</p><p>parkæ–¹æ³•å’Œunpark(Thread thread)éƒ½æ˜¯æˆå¯¹å‡ºç°çš„ï¼ŒåŒæ—¶unparkå¿…é¡»è¦åœ¨parkæ‰§è¡Œä¹‹åæ‰§è¡Œï¼Œå½“ç„¶å¹¶ä¸æ˜¯è¯´æ²¡æœ‰ä¸è°ƒç”¨unparkçº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ï¼Œparkæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒå¸¦äº†æ—¶é—´æˆ³ï¼ˆparkNanos(long nanos)ï¼šä¸ºäº†çº¿ç¨‹è°ƒåº¦ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œæœ€å¤šç­‰å¾…æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œé™¤éè®¸å¯å¯ç”¨ï¼‰ã€‚</p><p>park()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     UNSAFE<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>unpark(Thread thread)æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">unpark</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>         UNSAFE<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå…¶å†…éƒ¨çš„å®ç°éƒ½æ˜¯é€šè¿‡UNSAFEï¼ˆsun.misc.Unsafe UNSAFEï¼‰æ¥å®ç°çš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">unpark</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¸¤ä¸ªéƒ½æ˜¯nativeæœ¬åœ°æ–¹æ³•ã€‚Unsafe æ˜¯ä¸€ä¸ªæ¯”è¾ƒå±é™©çš„ç±»ï¼Œä¸»è¦æ˜¯ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨çš„æ–¹æ³•é›†åˆã€‚å°½ç®¡è¿™ä¸ªç±»å’Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å…¬å¼€çš„ï¼ˆpublicï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„ä½¿ç”¨ä»ç„¶å—é™ï¼Œä½ æ— æ³•åœ¨è‡ªå·±çš„javaç¨‹åºä¸­ç›´æ¥ä½¿ç”¨è¯¥ç±»ï¼Œå› ä¸ºåªæœ‰æˆä¿¡çš„ä»£ç æ‰èƒ½è·å¾—è¯¥ç±»çš„å®ä¾‹ã€‚</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p><strong>AQS</strong>ä½œä¸ºå…¶ä»–JUCå·¥å…·ç±»çš„åº•å±‚å·¥å…·ç±»ï¼Œç”¨<strong>state</strong>å’Œ<strong>åŒå‘é˜Ÿåˆ—</strong>çš„æ•°æ®ç»“æ„æ¥åˆ†åˆ«è¡¨ç¤ºèµ„æºçš„çŠ¶æ€å’Œçº¿ç¨‹çš„æ“ä½œã€‚æä¾›å¸¸ç”¨çš„æ‰©å±•æ–¹æ³•<strong>ç‹¬å å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€<strong>å…±äº«å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€<strong>æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µ</strong></p>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> J.U.C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä¸­çš„å¼‚å¸¸ä¼ æ’­æœºåˆ¶</title>
      <link href="2020/06/02/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/4.Java%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6/"/>
      <url>2020/06/02/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/4.Java%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1>Javaä¸­çš„å¼‚å¸¸ä¼ æ’­æœºåˆ¶</h1><p>è½¬è½½è‡ª:<a href="https://mp.weixin.qq.com/s/0NS5Iy1FL-9o1MiJIGI9RQ">Javaä¸­çš„å¼‚å¸¸ä¼ æ’­</a></p><blockquote><p>è®²è¿°javaä¸­åº•å±‚å¼‚å¸¸çš„ç±»å‹ä»¥åŠå¦‚ä½•è¿›è¡Œå¤„ç†</p></blockquote><p>ä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œè¿™é‡Œæˆ‘å‡†å¤‡äº†ä¸€å°æ®µå¼‚å¸¸ç¤ºä¾‹ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">remainder</span><span class="token punctuation">(</span><span class="token keyword">int</span> dividend<span class="token punctuation">,</span> <span class="token keyword">int</span> divisor<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DiviByZeroException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> dividend <span class="token operator">%</span> divisor<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DiviByZeroException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DiviByZeroException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">remainder</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiviByZeroException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªremainderå‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸¤ä¸ªintç±»å‹å‚æ•°ï¼Œdividendå‚æ•°è¡¨ç¤ºè¢«é™¤æ•°ï¼Œdivisorå‚æ•°è¡¨ç¤ºé™¤æ•°ï¼Œå‡½æ•°é‡Œé¢è¿”å›dividend/divisorçš„è®¡ç®—ç»“æœï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ±‚ä½™æ•°çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“è¿™é‡Œå¯èƒ½ä¼šæŠ›å‡ºé™¤ä»¥é›¶çš„å¼‚å¸¸ï¼Œè¿™é‡Œæˆ‘ä»¬æ•è·äº†ArithmeticExceptionå¼‚å¸¸ï¼Œç„¶åå°†ArithmeticExceptionè¿™ä¸ªè¿è¡Œæ—¶å¼‚å¸¸è½¬åŒ–æˆDivideByZeroExceptionæ£€æŸ¥æ€§å¼‚å¸¸ï¼Œæœ€åæŠ›å‡ºè¿™ä¸ªæ£€æŸ¥æ€§å¼‚å¸¸ã€‚è¿™é‡ŒDivideByZeroExceptionæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼‚å¸¸ï¼Œå®ƒç»§æ‰¿è‡ªExceptionï¼Œæ•…å®ƒæ˜¯ä¸€ä¸ªæ£€æŸ¥æ€§å¼‚å¸¸ã€‚</p><p>ç„¶åæˆ‘ä»¬éœ€è¦é€šè¿‡javacå‘½ä»¤å¯¹è¿™ä¸ªExceptionTestæµ‹è¯•ç±»è¿›è¡Œç¼–è¯‘ä»¥è·å–åˆ°å®ƒçš„classå­—èŠ‚ç æ–‡ä»¶ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ï¼Œæˆ‘æƒ³å¤§å®¶éƒ½ä¼šã€‚æœ‰äº†å­—èŠ‚ç æ–‡ä»¶ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬éœ€è¦æŸ¥çœ‹å®ƒçš„å­—èŠ‚ç å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡javapå‘½ä»¤æ¥æŸ¥çœ‹ï¼Œå…·ä½“æ“ä½œå‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p>javap -c -v -l ExceptionTest.class</p></blockquote><p>ç„¶ååœ¨å‘½ä»¤è¡Œçª—å£é‡Œå°±ä¼šè¿”å›æˆ‘ä»¬æƒ³è¦çš„å­—èŠ‚ç å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s1.ax1x.com/2020/06/03/td0Rbj.png" alt="td0Rbj.png"></p><p>ä¸è¿‡ï¼Œè¿™é‡Œæˆ‘æ¨èä½ ä½¿ç”¨JBE(Java Bytecode Editorå³Javaå­—èŠ‚ç ç¼–è¾‘å™¨)å·¥å…·ï¼Œå› ä¸ºå®ƒä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚JBEçš„ä¸‹è½½åœ°å€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>(PSï¼šæˆ‘ç”¨çš„æ˜¯Ideaä¸­çš„<strong>Show Bytecode</strong>)</p>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Exception </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å›æ–‡æ•°_LeetCode06</title>
      <link href="2020/06/01/13.LeetCode/6.%E5%9B%9E%E6%96%87%E6%95%B0-LeetCode06/"/>
      <url>2020/06/01/13.LeetCode/6.%E5%9B%9E%E6%96%87%E6%95%B0-LeetCode06/</url>
      
        <content type="html"><![CDATA[<h1>å›æ–‡æ•°</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>åˆ¤æ–­ä¸€ä¸ªæ•´æ•°æ˜¯å¦æ˜¯å›æ–‡æ•°ã€‚å›æ–‡æ•°æ˜¯æŒ‡æ­£åºï¼ˆä»å·¦å‘å³ï¼‰å’Œå€’åºï¼ˆä»å³å‘å·¦ï¼‰è¯»éƒ½æ˜¯ä¸€æ ·çš„æ•´æ•°ã€‚</p><ul><li>ç¤ºä¾‹ 1:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: 121è¾“å‡º: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 2:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: -121è¾“å‡º: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 3:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: 10è¾“å‡º: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="æ€è·¯"><a class="header-anchor" href="#æ€è·¯"></a>æ€è·¯</h2><p>è®¾è®¡ä¸€ä¸ªheadç´¢å¼•å’Œä¸€ä¸ªå°¾ç´¢å¼•ï¼Œéå†æ•´ä¸ªæ•°ç»„å¦‚æœå¼€å§‹å¼€å§‹ç´¢å¼•å¤§äºç­‰äºå°¾ç´¢å¼•è¯´æ˜æ˜¯å›æ–‡ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> firstIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> lastIndex <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>firstIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>firstIndex<span class="token punctuation">)</span> <span class="token operator">==</span> str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                firstIndex<span class="token operator">++</span><span class="token punctuation">;</span>                lastIndex<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>firstIndex <span class="token operator">==</span> lastIndex <span class="token operator">||</span> firstIndex <span class="token operator">></span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>å›æ–‡ä¸²çš„è§£æ³•å¯ä»¥é‡‡ç”¨é¢å¤–çš„ç©ºé—´è¿›è¡Œåˆ¤æ–­</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxè¿ç»´äººå‘˜æœ€å¸¸ç”¨150ä¸ªå‘½ä»¤æ±‡æ€»</title>
      <link href="2020/06/01/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/3.Linux%E8%BF%90%E7%BB%B4%E4%BA%BA%E5%91%98%E6%9C%80%E5%B8%B8%E7%94%A8150%E4%B8%AA%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB/"/>
      <url>2020/06/01/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/3.Linux%E8%BF%90%E7%BB%B4%E4%BA%BA%E5%91%98%E6%9C%80%E5%B8%B8%E7%94%A8150%E4%B8%AA%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB/</url>
      
        <content type="html"><![CDATA[<h1>Linuxè¿ç»´äººå‘˜æœ€å¸¸ç”¨150ä¸ªå‘½ä»¤æ±‡æ€»</h1><p>è½¬è½½è‡ª:<a href="https://www.cnblogs.com/bananaaa/p/7774467.html">Linuxè¿ç»´äººå‘˜æœ€å¸¸ç”¨150ä¸ªå‘½ä»¤æ±‡æ€»</a></p><blockquote><p>linuxä¸‹æœ€å¸¸ç”¨çš„150ä¸ªå‘½ä»¤ï¼Œæ„Ÿè§‰æœ‰ç‚¹å¤šå•Šï¼</p></blockquote><h2 id="çº¿ä¸ŠæŸ¥è¯¢åŠå¸®åŠ©å‘½ä»¤"><a class="header-anchor" href="#çº¿ä¸ŠæŸ¥è¯¢åŠå¸®åŠ©å‘½ä»¤"></a>çº¿ä¸ŠæŸ¥è¯¢åŠå¸®åŠ©å‘½ä»¤</h2><table><tr><td>å‘½ä»¤</td><td>åŠŸèƒ½è¯´æ˜</td></tr><tr><td>man</td><td>Debian/Ubuntu ä¸‹å®‰è£…manä¸­æ–‡ç‰ˆ<br> sudo apt install manpages-zh</td></tr>    <tr><td>help</td><td>æŸ¥çœ‹Linuxå†…ç½®å‘½ä»¤çš„å¸®åŠ©ï¼Œæ¯”å¦‚'cd'å‘½ä»¤</td></tr></table><h2 id="æ–‡ä»¶å’Œç›®å½•æ“ä½œå‘½ä»¤"><a class="header-anchor" href="#æ–‡ä»¶å’Œç›®å½•æ“ä½œå‘½ä»¤"></a>æ–‡ä»¶å’Œç›®å½•æ“ä½œå‘½ä»¤</h2><table><tr><td>å‘½ä»¤</td><td>åŠŸèƒ½è¯´æ˜</td></tr>    <tr><td>ls</td><td>å…¨æ‹¼listï¼ŒåŠŸèƒ½æ˜¯åˆ—å‡ºç›®å½•çš„å†…å®¹åŠå…¶å†…å®¹å±æ€§ä¿¡æ¯</td></tr>    <tr><td>cd</td><td>å…¨æ‹¼change directoryï¼ŒåŠŸèƒ½æ˜¯ä»å½“å‰å·¥ä½œç›®å½•åˆ‡æ¢åˆ°æŒ‡å®šçš„å·¥ä½œç›®å½•</td></tr>    <tr><td>cp</td><td>å…¨æ‹¼copyï¼Œå…¶åŠŸèƒ½ä¸ºå¤åˆ¶æ–‡ä»¶æˆ–ç›®å½•</td></tr>    <tr><td>find</td><td>æŸ¥æ‰¾çš„æ„æ€ï¼Œç”¨äºæŸ¥æ‰¾ç›®å½•åŠç›®å½•ä¸‹çš„æ–‡ä»¶</td></tr>    <tr><td>mkdir</td><td>å…¨æ‹¼ make directoriesï¼Œå…¶åŠŸèƒ½æ˜¯åˆ›å»ºç›®å½•</td></tr>    <tr><td>mv</td><td>å…¨æ‹¼ moveï¼Œå…¶åŠŸèƒ½æ˜¯ç§»åŠ¨æˆ–é‡å‘½åæ–‡ä»¶</td></tr>    <tr><td>pwd</td><td>å…¨æ‹¼ print working directoryï¼Œå…¶åŠŸèƒ½æ˜¯æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•çš„ç»å¯¹è·¯å¾„</td></tr>    <tr><td>rename</td><td>ç”¨äºé‡å‘½åæ–‡ä»¶</td></tr>    <tr><td>rm</td><td>å…¨æ‹¼removeï¼Œå…¶åŠŸèƒ½æ˜¯åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•</td></tr>    <tr><td>rmdir</td><td>å…¨æ‹¼remove empty directoriesï¼ŒåŠŸèƒ½æ˜¯åˆ é™¤ç©ºç›®å½•</td></tr>    <tr><td>touch</td><td>åˆ›å»ºæ–°çš„ç©ºæ–‡ä»¶æˆ–æ”¹å˜å·²æœ‰æ–‡ä»¶çš„æ—¶é—´æˆ³å±æ€§</td></tr>    <tr><td>tree</td><td>åŠŸèƒ½æ˜¯ä»¥æ ‘å½¢ç»“æ„æ˜¾ç¤ºç›®å½•ä¸‹çš„å†…å®¹</td></tr>    <tr><td>basename</td><td>æ˜¾ç¤ºæ–‡ä»¶åæˆ–ç›®å½•å</td></tr>    <tr><td>dirname</td><td>æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•è·¯å¾„</td></tr>    <tr><td>chattr</td><td>æ”¹å˜æ–‡ä»¶çš„æ‰©å±•å±æ€§</td></tr>    <tr><td>lsattr</td><td>æŸ¥çœ‹æ–‡ä»¶æ‰©å±•å±æ€§</td></tr>    <tr><td>file</td><td>æ˜¾ç¤ºæ–‡ä»¶çš„ç±»å‹</td></tr>    <tr><td>md5sum</td><td>è®¡ç®—å’Œæ ¡éªŒæ–‡ä»¶çš„ MD5 å€¼</td></tr></table><h2 id="æŸ¥çœ‹æ–‡ä»¶åŠå†…å®¹å¤„ç†å‘½ä»¤"><a class="header-anchor" href="#æŸ¥çœ‹æ–‡ä»¶åŠå†…å®¹å¤„ç†å‘½ä»¤"></a>æŸ¥çœ‹æ–‡ä»¶åŠå†…å®¹å¤„ç†å‘½ä»¤</h2><table><tr><td>å‘½ä»¤</td><td>åŠŸèƒ½è¯´æ˜</td></tr>    <tr><td>cat</td><td>å…¨æ‹¼ concatenateï¼ŒåŠŸèƒ½æ˜¯ç”¨äºè¿æ¥å¤šä¸ªæ–‡ä»¶å¹¶ä¸”æ‰“å°åˆ°å±å¹•è¾“å‡ºæˆ–é‡å®šå‘åˆ°æŒ‡å®šæ–‡ä»¶ä¸­</td></tr>    <tr><td>tac</td><td>tac æ˜¯ cat çš„åå‘æ‹¼å†™ï¼Œå› æ­¤å‘½ä»¤çš„åŠŸèƒ½ä¸ºåå‘æ˜¾ç¤ºæ–‡ä»¶å†…å®¹</td></tr>    <tr><td>more</td><td>åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶å†…å®¹</td></tr>    <tr><td>less</td><td>åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶å†…å®¹</td></tr>    <tr><td>head</td><td>æ˜¾ç¤ºæ–‡ä»¶å†…å®¹çš„å¤´éƒ¨</td></tr>    <tr><td>tail</td><td>æ˜¾ç¤ºæ–‡ä»¶å†…å®¹çš„å¤´éƒ¨</td></tr>    <tr><td>cut</td><td>å°†æ–‡ä»¶çš„æ¯ä¸€è¡ŒæŒ‰æŒ‡å®šåˆ†éš”ç¬¦åˆ†å‰²å¹¶è¾“å‡º</td></tr>    <tr><td>split</td><td>åˆ†å‰²æ–‡ä»¶ä¸ºä¸åŒçš„å°ç‰‡æ®µ</td></tr>    <tr><td>paste</td><td>æŒ‰è¡Œåˆå¹¶æ–‡ä»¶å†…å®¹</td></tr>    <tr><td>sort</td><td>å¯¹æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹æ’åº</td></tr>    <tr><td>uniq</td><td>å»é™¤é‡å¤è¡Œã€‚oldboy</td></tr>    <tr><td>wc</td><td>ç»Ÿè®¡æ–‡ä»¶çš„è¡Œæ•°ã€å•è¯æ•°æˆ–å­—èŠ‚æ•°</td></tr>    <tr><td>iconv</td><td>è½¬æ¢æ–‡ä»¶çš„ç¼–ç æ ¼å¼</td></tr>    <tr><td>dos2unix</td><td>å°† DOS æ ¼å¼æ–‡ä»¶è½¬æ¢æˆ UNIX æ ¼å¼</td></tr>    <tr><td>diff</td><td>å…¨æ‹¼differenceï¼Œæ¯”è¾ƒæ–‡ä»¶çš„å·®å¼‚ï¼Œå¸¸ç”¨äºæ–‡æœ¬æ–‡ä»¶</td></tr>    <tr><td>vimdiff</td><td>å‘½ä»¤è¡Œå¯è§†åŒ–æ–‡ä»¶æ¯”è¾ƒå·¥å…·ï¼Œå¸¸ç”¨äºæ–‡æœ¬æ–‡ä»¶</td></tr>    <tr><td>rev</td><td>åå‘è¾“å‡ºæ–‡ä»¶å†…å®¹</td></tr>    <tr><td>grep/egrep</td><td>è¿‡æ»¤å­—ç¬¦ä¸²</td></tr>    <tr><td>join</td><td>æŒ‰ä¸¤ä¸ªæ–‡ä»¶çš„ç›¸åŒå­—æ®µåˆå¹¶</td></tr>    <tr><td>tr</td><td>æ›¿æ¢æˆ–åˆ é™¤å­—ç¬¦</td></tr>    <tr><td>vi/vim</td><td>å‘½ä»¤è¡Œæ–‡æœ¬ç¼–è¾‘å™¨</td></tr></table><h2 id="æ–‡ä»¶å‹ç¼©åŠè§£å‹ç¼©å‘½ä»¤"><a class="header-anchor" href="#æ–‡ä»¶å‹ç¼©åŠè§£å‹ç¼©å‘½ä»¤"></a>æ–‡ä»¶å‹ç¼©åŠè§£å‹ç¼©å‘½ä»¤</h2><table><tr><td>å‘½ä»¤</td><td>åŠŸèƒ½è¯´æ˜</td></tr>    <tr><td>tar</td><td>æ‰“åŒ…å‹ç¼©</td></tr>    <tr><td>unzip</td><td>è§£å‹æ–‡ä»¶</td></tr>    <tr><td>gzip</td><td>gzip å‹ç¼©å·¥å…·</td></tr>    <tr><td>zip</td><td>zip å‹ç¼©å·¥å…·</td></tr></table>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•´æ•°åè½¬_LeetCode05</title>
      <link href="2020/05/31/13.LeetCode/5.%E6%95%B4%E6%95%B0%E5%8F%8D%E8%BD%AC-LeetCode05/"/>
      <url>2020/05/31/13.LeetCode/5.%E6%95%B4%E6%95%B0%E5%8F%8D%E8%BD%AC-LeetCode05/</url>
      
        <content type="html"><![CDATA[<h1>æ•´æ•°åè½¬</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>ç»™å‡ºä¸€ä¸ª 32 ä½çš„æœ‰ç¬¦å·æ•´æ•°ï¼Œä½ éœ€è¦å°†è¿™ä¸ªæ•´æ•°ä¸­æ¯ä½ä¸Šçš„æ•°å­—è¿›è¡Œåè½¬ã€‚</p><ul><li>ç¤ºä¾‹1:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: 123è¾“å‡º: 321<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹2:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: -123è¾“å‡º: -321<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹3:</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: 120è¾“å‡º: 21<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="è§£é¢˜æ€è·¯"><a class="header-anchor" href="#è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h2><blockquote><p><strong>%10</strong>æ¨¡é™¤å¯ä»¥å¾—åˆ°æ•°å­—çš„æœ€åä¸€ä½;<strong>/10</strong>å¯ä»¥å¾—åˆ°æ•°å­—çš„å‰nä½</p></blockquote><p>æ ¹æ®å‰é¢ä¸¤ä¸ªåŸç†ï¼Œå¯ä»¥å°†ç»™å®šçš„æ•°å­—ä¾æ¬¡è¿›è¡Œæ¨¡é™¤è¿ç®—å¾—åˆ°æœ€åä¸€ä½ï¼Œç„¶åæ ¹æ®ä¸Šä¸€æ¬¡çš„ç»“æœåœ¨è¿›è¡Œ<strong>ä¹˜</strong>10æ“ä½œåç›¸åŠ å¾—åˆ°æ–°çš„ç»“æœ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> rev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>x<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> lastNum <span class="token operator">=</span> x<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>rev<span class="token operator">></span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">||</span>rev<span class="token operator">==</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">&amp;&amp;</span> lastNum <span class="token operator">></span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>rev<span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">||</span>rev<span class="token operator">==</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">&amp;&amp;</span> lastNum <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        rev <span class="token operator">=</span> rev<span class="token operator">*</span><span class="token number">10</span> <span class="token operator">+</span> lastNum<span class="token punctuation">;</span>        x <span class="token operator">=</span> x<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> rev<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8 ä¸­çš„Streams APIè¯¦è§£</title>
      <link href="2020/05/30/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/2.Java8%20%E4%B8%AD%E7%9A%84Streams%20API%E8%AF%A6%E8%A7%A3/"/>
      <url>2020/05/30/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/2.Java8%20%E4%B8%AD%E7%9A%84Streams%20API%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1>Java8 ä¸­çš„Streams APIè¯¦è§£</h1><p>è½¬è½½è‡ª:<a href="https://www.ibm.com/developerworks/cn/java/j-lo-java8streamapi/?from=timeline">Java8 ä¸­çš„Streams APIè¯¦è§£</a></p><blockquote><p>Streams çš„èƒŒæ™¯ï¼Œä»¥åŠ Java 8 ä¸­çš„ä½¿ç”¨è¯¦è§£</p></blockquote><h2 id="ä¸ºä»€ä¹ˆéœ€è¦-Stream"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦-Stream"></a>ä¸ºä»€ä¹ˆéœ€è¦ Stream</h2><p>Stream ä½œä¸º Java 8 çš„ä¸€å¤§äº®ç‚¹ï¼Œå®ƒä¸ <a href="http://java.io">java.io</a> åŒ…é‡Œçš„ InputStream å’Œ OutputStream æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚å®ƒä¹Ÿä¸åŒäº StAX å¯¹ XML è§£æçš„ Streamï¼Œä¹Ÿä¸æ˜¯ Amazon Kinesis å¯¹å¤§æ•°æ®å®æ—¶å¤„ç†çš„ Streamã€‚Java 8 ä¸­çš„ Stream æ˜¯å¯¹<strong>é›†åˆï¼ˆCollectionï¼‰å¯¹è±¡åŠŸèƒ½çš„å¢å¼º</strong>ï¼Œå®ƒä¸“æ³¨äºå¯¹é›†åˆå¯¹è±¡è¿›è¡Œå„ç§éå¸¸ä¾¿åˆ©ã€é«˜æ•ˆçš„èšåˆæ“ä½œï¼ˆaggregate operationï¼‰ï¼Œæˆ–è€…å¤§æ‰¹é‡æ•°æ®æ“ä½œ (bulk data operation)ã€‚Stream API å€ŸåŠ©äºåŒæ ·æ–°å‡ºç°çš„ Lambda è¡¨è¾¾å¼ï¼Œæå¤§çš„æé«˜ç¼–ç¨‹æ•ˆç‡å’Œç¨‹åºå¯è¯»æ€§ã€‚åŒæ—¶å®ƒæä¾›<strong>ä¸²è¡Œ</strong>å’Œ<strong>å¹¶è¡Œ</strong>ä¸¤ç§æ¨¡å¼è¿›è¡Œæ±‡èšæ“ä½œï¼Œå¹¶å‘æ¨¡å¼èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ï¼Œä½¿ç”¨ fork/join å¹¶è¡Œæ–¹å¼æ¥æ‹†åˆ†ä»»åŠ¡å’ŒåŠ é€Ÿå¤„ç†è¿‡ç¨‹ã€‚é€šå¸¸ç¼–å†™å¹¶è¡Œä»£ç å¾ˆéš¾è€Œä¸”å®¹æ˜“å‡ºé”™, ä½†ä½¿ç”¨ Stream API æ— éœ€ç¼–å†™ä¸€è¡Œå¤šçº¿ç¨‹çš„ä»£ç ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å†™å‡ºé«˜æ€§èƒ½çš„å¹¶å‘ç¨‹åºã€‚æ‰€ä»¥è¯´ï¼ŒJava 8 ä¸­é¦–æ¬¡å‡ºç°çš„ java.util.stream æ˜¯ä¸€ä¸ªå‡½æ•°å¼è¯­è¨€+å¤šæ ¸æ—¶ä»£ç»¼åˆå½±å“çš„äº§ç‰©ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯èšåˆæ“ä½œ"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯èšåˆæ“ä½œ"></a>ä»€ä¹ˆæ˜¯èšåˆæ“ä½œ</h3><p>åœ¨ä¼ ç»Ÿçš„ J2EE åº”ç”¨ä¸­ï¼ŒJava ä»£ç ç»å¸¸ä¸å¾—ä¸ä¾èµ–äºå…³ç³»å‹æ•°æ®åº“çš„èšåˆæ“ä½œæ¥å®Œæˆè¯¸å¦‚ï¼š</p><ul><li>å®¢æˆ·æ¯æœˆå¹³å‡æ¶ˆè´¹é‡‘é¢</li><li>æœ€æ˜‚è´µçš„åœ¨å”®å•†å“</li><li>æœ¬å‘¨å®Œæˆçš„æœ‰æ•ˆè®¢å•ï¼ˆæ’é™¤äº†æ— æ•ˆçš„ï¼‰</li><li>å–åä¸ªæ•°æ®æ ·æœ¬ä½œä¸ºé¦–é¡µæ¨è<br>è¿™ç±»çš„æ“ä½œã€‚<br>ä½†åœ¨å½“ä»Šè¿™ä¸ªæ•°æ®å¤§çˆ†ç‚¸çš„æ—¶ä»£ï¼Œåœ¨æ•°æ®æ¥æºå¤šæ ·åŒ–ã€æ•°æ®æµ·é‡åŒ–çš„ä»Šå¤©ï¼Œå¾ˆå¤šæ—¶å€™ä¸å¾—ä¸è„±ç¦» RDBMSï¼Œæˆ–è€…ä»¥åº•å±‚è¿”å›çš„æ•°æ®ä¸ºåŸºç¡€è¿›è¡Œæ›´ä¸Šå±‚çš„æ•°æ®ç»Ÿè®¡ã€‚è€Œ Java çš„é›†åˆ API ä¸­ï¼Œä»…ä»…æœ‰æå°‘é‡çš„è¾…åŠ©å‹æ–¹æ³•ï¼Œæ›´å¤šçš„æ—¶å€™æ˜¯ç¨‹åºå‘˜éœ€è¦ç”¨ Iterator æ¥éå†é›†åˆï¼Œå®Œæˆç›¸å…³çš„èšåˆåº”ç”¨é€»è¾‘ã€‚è¿™æ˜¯ä¸€ç§è¿œä¸å¤Ÿé«˜æ•ˆã€ç¬¨æ‹™çš„æ–¹æ³•ã€‚åœ¨ Java 7 ä¸­ï¼Œå¦‚æœè¦å‘ç° type ä¸º grocery çš„æ‰€æœ‰äº¤æ˜“ï¼Œç„¶åè¿”å›ä»¥äº¤æ˜“å€¼é™åºæ’åºå¥½çš„äº¤æ˜“ ID é›†åˆï¼Œæˆ‘ä»¬éœ€è¦è¿™æ ·å†™ï¼š</li></ul><p>æ¸…å• 1. Java 7 çš„æ’åºã€å–å€¼å®ç°</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Transaction</span><span class="token punctuation">></span></span> groceryTransactions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Arraylist</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> t<span class="token operator">:</span> transactions<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Transaction</span><span class="token punctuation">.</span>GROCERY<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    groceryTransactions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>groceryTransactions<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> t1<span class="token punctuation">,</span> <span class="token class-name">Transaction</span> t2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> t2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> transactionIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> t<span class="token operator">:</span> groceryTransactions<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    transactionsIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåœ¨ Java8 ä½¿ç”¨ Streamï¼Œä»£ç æ›´åŠ ç®€æ´æ˜“è¯»ï¼›è€Œä¸”ä½¿ç”¨å¹¶å‘æ¨¡å¼ï¼Œç¨‹åºæ‰§è¡Œé€Ÿåº¦æ›´å¿«ã€‚</p><p>æ¸…å•2. Java8çš„æ’åºã€å–å€¼å®ç°</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> transactionsIds <span class="token operator">=</span> transactions<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">filter</span><span class="token punctuation">(</span>t <span class="token operator">-></span> t<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Transaction</span><span class="token punctuation">.</span>GROCERY<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">sorted</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span><span class="token operator">::</span><span class="token function">getValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Stream-æ€»è§ˆ"><a class="header-anchor" href="#Stream-æ€»è§ˆ"></a>Stream æ€»è§ˆ</h2><h3 id="ä»€ä¹ˆæ˜¯æµ"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ"></a>ä»€ä¹ˆæ˜¯æµ</h3><p>Stream ä¸æ˜¯é›†åˆå…ƒç´ ï¼Œå®ƒä¸æ˜¯æ•°æ®ç»“æ„å¹¶ä¸ä¿å­˜æ•°æ®ï¼Œå®ƒæ˜¯æœ‰å…³ç®—æ³•å’Œè®¡ç®—çš„ï¼Œå®ƒæ›´åƒä¸€ä¸ªé«˜çº§ç‰ˆæœ¬çš„ Iteratorã€‚åŸå§‹ç‰ˆæœ¬çš„ Iteratorï¼Œç”¨æˆ·åªèƒ½æ˜¾å¼åœ°ä¸€ä¸ªä¸€ä¸ªéå†å…ƒç´ å¹¶å¯¹å…¶æ‰§è¡ŒæŸäº›æ“ä½œï¼›é«˜çº§ç‰ˆæœ¬çš„ Streamï¼Œç”¨æˆ·åªè¦ç»™å‡ºéœ€è¦å¯¹å…¶åŒ…å«çš„å…ƒç´ æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Œæ¯”å¦‚ â€œè¿‡æ»¤æ‰é•¿åº¦å¤§äº 10 çš„å­—ç¬¦ä¸²â€ã€â€œè·å–æ¯ä¸ªå­—ç¬¦ä¸²çš„é¦–å­—æ¯â€ç­‰ï¼ŒStream ä¼šéšå¼åœ°åœ¨å†…éƒ¨è¿›è¡Œéå†ï¼Œåšå‡ºç›¸åº”çš„æ•°æ®è½¬æ¢ã€‚</p><p>Stream å°±å¦‚åŒä¸€ä¸ªè¿­ä»£å™¨ï¼ˆIteratorï¼‰ï¼Œå•å‘ï¼Œä¸å¯å¾€å¤ï¼Œæ•°æ®åªèƒ½éå†ä¸€æ¬¡ï¼Œéå†è¿‡ä¸€æ¬¡åå³ç”¨å°½äº†ï¼Œå°±å¥½æ¯”æµæ°´ä»é¢å‰æµè¿‡ï¼Œä¸€å»ä¸å¤è¿”ã€‚</p><p>è€Œå’Œè¿­ä»£å™¨åˆä¸åŒçš„æ˜¯ï¼ŒStream å¯ä»¥å¹¶è¡ŒåŒ–æ“ä½œï¼Œ<strong>è¿­ä»£å™¨</strong>åªèƒ½<strong>å‘½ä»¤å¼åœ°</strong>ã€<strong>ä¸²è¡ŒåŒ–æ“ä½œ</strong>ã€‚é¡¾åæ€ä¹‰ï¼Œå½“ä½¿ç”¨ä¸²è¡Œæ–¹å¼å»éå†æ—¶ï¼Œæ¯ä¸ªitemè¯»å®Œåå†è¯»ä¸‹ä¸€ä¸ªitemã€‚è€Œä½¿ç”¨å¹¶è¡Œå»éå†æ—¶ï¼Œæ•°æ®ä¼šè¢«åˆ†æˆå¤šä¸ªæ®µï¼Œå…¶ä¸­æ¯ä¸€ä¸ªéƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¤„ç†ï¼Œç„¶åå°†ç»“æœä¸€èµ·è¾“å‡ºã€‚Stream çš„å¹¶è¡Œæ“ä½œä¾èµ–äº Java7 ä¸­å¼•å…¥çš„ Fork/Join æ¡†æ¶ï¼ˆJSR166yï¼‰æ¥æ‹†åˆ†ä»»åŠ¡å’ŒåŠ é€Ÿå¤„ç†è¿‡ç¨‹ã€‚Java çš„å¹¶è¡Œ API æ¼”å˜å†ç¨‹åŸºæœ¬å¦‚ä¸‹ï¼š</p><ol><li>1.0-1.4 ä¸­çš„ java.lang.Thread</li><li>5.0 ä¸­çš„ java.util.concurrent</li><li>6.0 ä¸­çš„ Phasers ç­‰</li><li>7.0 ä¸­çš„ Fork/Join æ¡†æ¶</li><li>8.0 ä¸­çš„ Lambda</li></ol><p>Stream çš„å¦å¤–ä¸€å¤§ç‰¹ç‚¹æ˜¯ï¼Œæ•°æ®æºæœ¬èº«å¯ä»¥æ˜¯æ— é™çš„ã€‚</p><h3 id="æµçš„æ„æˆ"><a class="header-anchor" href="#æµçš„æ„æˆ"></a>æµçš„æ„æˆ</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæµçš„æ—¶å€™ï¼Œé€šå¸¸åŒ…æ‹¬ä¸‰ä¸ªåŸºæœ¬æ­¥éª¤ï¼š</p><p>è·å–ä¸€ä¸ªæ•°æ®æºï¼ˆsourceï¼‰â†’ æ•°æ®è½¬æ¢â†’æ‰§è¡Œæ“ä½œè·å–æƒ³è¦çš„ç»“æœï¼Œ<strong>æ¯æ¬¡è½¬æ¢åŸæœ‰ Stream å¯¹è±¡ä¸æ”¹å˜ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Stream å¯¹è±¡</strong>ï¼ˆå¯ä»¥æœ‰å¤šæ¬¡è½¬æ¢ï¼‰ï¼Œè¿™å°±å…è®¸å¯¹å…¶æ“ä½œå¯ä»¥åƒé“¾æ¡ä¸€æ ·æ’åˆ—ï¼Œå˜æˆä¸€ä¸ªç®¡é“ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br>å›¾ 1. æµç®¡é“ (Stream Pipeline) çš„æ„æˆ</p><p><img src="https://www.ibm.com/developerworks/cn/java/j-lo-java8streamapi/img001.png" alt="Stream"></p><p>æœ‰å¤šç§æ–¹å¼ç”Ÿæˆ Stream Sourceï¼š</p><ul><li>ä» Collection å’Œæ•°ç»„<ul><li>Collection.stream()</li><li>Collection.parallelStream()</li><li>Arrays.stream(T array) or Stream.of()</li></ul></li><li>ä»BufferedReader<ul><li>java.io.BufferedReader.lines()</li></ul></li><li>é™æ€å·¥å‚<ul><li>java.util.stream.IntStream.range()</li><li>java.nio.file.Files.walk()</li></ul></li><li>è‡ªå·±æ„å»º<ul><li>java.util.Spliterator</li></ul></li><li>å…¶å®ƒ<ul><li>Random.ints()</li><li>BitSet.stream()</li><li>Pattern.splitAsStream(java.lang.CharSequence)</li><li>JarFile.stream()</li></ul></li></ul><p>æµçš„æ“ä½œç±»å‹åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li><strong>Intermediate</strong>ï¼šä¸€ä¸ªæµå¯ä»¥åé¢è·Ÿéšé›¶ä¸ªæˆ–å¤šä¸ª intermediate æ“ä½œã€‚å…¶ç›®çš„ä¸»è¦æ˜¯<strong>æ‰“å¼€æµ</strong>ï¼Œåšå‡ºæŸç§ç¨‹åº¦çš„æ•°æ®æ˜ å°„/è¿‡æ»¤ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„æµï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªæ“ä½œä½¿ç”¨ã€‚è¿™ç±»æ“ä½œéƒ½æ˜¯æƒ°æ€§åŒ–çš„ï¼ˆlazyï¼‰ï¼Œå°±æ˜¯è¯´ï¼Œä»…ä»…è°ƒç”¨åˆ°è¿™ç±»æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰çœŸæ­£å¼€å§‹æµçš„éå†ã€‚</li><li><strong>Terminal</strong>ï¼šä¸€ä¸ªæµåªèƒ½æœ‰ä¸€ä¸ª terminal æ“ä½œï¼Œå½“è¿™ä¸ªæ“ä½œæ‰§è¡Œåï¼Œæµå°±è¢«ä½¿ç”¨â€œå…‰â€äº†ï¼Œæ— æ³•å†è¢«æ“ä½œã€‚æ‰€ä»¥è¿™å¿…å®šæ˜¯æµçš„æœ€åä¸€ä¸ªæ“ä½œã€‚Terminal æ“ä½œçš„æ‰§è¡Œï¼Œæ‰ä¼šçœŸæ­£å¼€å§‹æµçš„éå†ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆä¸€ä¸ªç»“æœï¼Œæˆ–è€…ä¸€ä¸ª side effectã€‚</li></ul><p>åœ¨å¯¹äºä¸€ä¸ª Stream è¿›è¡Œå¤šæ¬¡è½¬æ¢æ“ä½œ (Intermediate æ“ä½œ)ï¼Œæ¯æ¬¡éƒ½å¯¹ Stream çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œè½¬æ¢ï¼Œè€Œä¸”æ˜¯æ‰§è¡Œå¤šæ¬¡ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦å°±æ˜¯ Nï¼ˆè½¬æ¢æ¬¡æ•°ï¼‰ä¸ª for å¾ªç¯é‡ŒæŠŠæ‰€æœ‰æ“ä½œéƒ½åšæ‰çš„æ€»å’Œå—ï¼Ÿå…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œè½¬æ¢æ“ä½œéƒ½æ˜¯ lazy çš„ï¼Œå¤šä¸ªè½¬æ¢æ“ä½œåªä¼šåœ¨ Terminal æ“ä½œçš„æ—¶å€™èåˆèµ·æ¥ï¼Œä¸€æ¬¡å¾ªç¯å®Œæˆã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ç®€å•çš„ç†è§£ï¼Œ<strong>Stream é‡Œæœ‰ä¸ªæ“ä½œå‡½æ•°çš„é›†åˆï¼Œæ¯æ¬¡è½¬æ¢æ“ä½œå°±æ˜¯æŠŠè½¬æ¢å‡½æ•°æ”¾å…¥è¿™ä¸ªé›†åˆä¸­ï¼Œåœ¨ Terminal æ“ä½œçš„æ—¶å€™å¾ªç¯ Stream å¯¹åº”çš„é›†åˆï¼Œç„¶åå¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œæ‰€æœ‰çš„å‡½æ•°ã€‚</strong></p><blockquote><p>ps: åªä¼šå¾ªç¯ä¸€æ¬¡ï¼Œç„¶åæ¯ä¸ªå…ƒç´ æ‰§è¡Œæ‰€æœ‰çš„å‡½æ•°</p></blockquote><p>è¿˜æœ‰ä¸€ç§æ“ä½œè¢«ç§°ä¸º<strong>short-circuiting</strong>ç”¨ä»¥æŒ‡ï¼š</p><ul><li>å¯¹äºä¸€ä¸ª intermediate æ“ä½œï¼Œå¦‚æœå®ƒæ¥å—çš„æ˜¯ä¸€ä¸ªæ— é™å¤§ï¼ˆinfinite/unboundedï¼‰çš„ Streamï¼Œä½†è¿”å›ä¸€ä¸ªæœ‰é™çš„æ–° Streamã€‚</li><li>å¯¹äºä¸€ä¸ª terminal æ“ä½œï¼Œå¦‚æœå®ƒæ¥å—çš„æ˜¯ä¸€ä¸ªæ— é™å¤§çš„ Streamï¼Œä½†èƒ½åœ¨æœ‰é™çš„æ—¶é—´è®¡ç®—å‡ºç»“æœã€‚</li></ul><p>å½“æ“ä½œä¸€ä¸ªæ— é™å¤§çš„ Streamï¼Œè€Œåˆå¸Œæœ›åœ¨æœ‰é™æ—¶é—´å†…å®Œæˆæ“ä½œï¼Œåˆ™åœ¨ç®¡é“å†…æ‹¥æœ‰ä¸€ä¸ª short-circuiting æ“ä½œæ˜¯å¿…è¦éå……åˆ†æ¡ä»¶ã€‚<br>æ¸…å• 3. ä¸€ä¸ªæµæ“ä½œçš„ç¤ºä¾‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> sum <span class="token operator">=</span> widgets<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>w <span class="token operator">-></span> w<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RED<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>w <span class="token operator">-></span> w<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>stream() è·å–å½“å‰å°ç‰©ä»¶çš„ sourceï¼Œfilter å’Œ mapToInt ä¸º intermediate æ“ä½œï¼Œè¿›è¡Œæ•°æ®ç­›é€‰å’Œè½¬æ¢ï¼Œæœ€åä¸€ä¸ª sum() ä¸º terminal æ“ä½œï¼Œå¯¹ç¬¦åˆæ¡ä»¶çš„å…¨éƒ¨å°ç‰©ä»¶ä½œé‡é‡æ±‚å’Œã€‚</p><h2 id="æµçš„ä½¿ç”¨è¯¦è§£"><a class="header-anchor" href="#æµçš„ä½¿ç”¨è¯¦è§£"></a>æµçš„ä½¿ç”¨è¯¦è§£</h2><p>ç®€å•è¯´ï¼Œå¯¹Streamçš„ä½¿ç”¨å°±æ˜¯å®ç°ä¸€ä¸ªfilter-map-reduceè¿‡ç¨‹ï¼Œäº§ç”Ÿä¸€ä¸ªæœ€ç»ˆç»“æœï¼Œæˆ–è€…å¯¼è‡´ä¸€ä¸ªå‰¯ä½œç”¨ï¼ˆside effectï¼‰ã€‚</p><h3 id="æµçš„æ„é€ ä¸è½¬æ¢"><a class="header-anchor" href="#æµçš„æ„é€ ä¸è½¬æ¢"></a>æµçš„æ„é€ ä¸è½¬æ¢</h3><p>ä¸‹é¢æä¾›æœ€å¸¸è§çš„å‡ ç§æ„é€  Stream çš„æ ·ä¾‹ã€‚<br>æ¸…å• 4. æ„é€ æµçš„å‡ ç§å¸¸è§æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1. Individual values</span><span class="token class-name">Stream</span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2. Arrays</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> strArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>strArray<span class="token punctuation">)</span><span class="token punctuation">;</span>stream <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>strArray<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 3. Collections</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>strArray<span class="token punctuation">)</span><span class="token punctuation">;</span>stream <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºåŸºæœ¬æ•°å€¼å‹ï¼Œç›®å‰æœ‰ä¸‰ç§å¯¹åº”çš„åŒ…è£…ç±»å‹ Streamï¼š<br>IntStreamã€LongStreamã€DoubleStreamã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ Stream<Integer>ã€Stream<Long> &gt;ã€Stream<Double>ï¼Œä½†æ˜¯ boxing å’Œ unboxing ä¼šå¾ˆè€—æ—¶ï¼Œæ‰€ä»¥ç‰¹åˆ«ä¸ºè¿™ä¸‰ç§åŸºæœ¬æ•°å€¼å‹æä¾›äº†å¯¹åº”çš„ Streamã€‚</p><p>Java 8 ä¸­è¿˜æ²¡æœ‰æä¾›å…¶å®ƒæ•°å€¼å‹ Streamï¼Œå› ä¸ºè¿™å°†å¯¼è‡´æ‰©å¢çš„å†…å®¹è¾ƒå¤šã€‚è€Œå¸¸è§„çš„æ•°å€¼å‹èšåˆè¿ç®—å¯ä»¥é€šè¿‡ä¸Šé¢ä¸‰ç§ Stream è¿›è¡Œã€‚</p><p>æ¸…å•5. æ•°å€¼æµçš„æ„é€ </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ¸…å•6. æµè½¬æ¢ä¸ºå…¶å®ƒæ•°æ®ç»“æ„</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1. Array</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strArray1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2. Collection</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list2 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span> set1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Stack</span> stack1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">Stack</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 3. String</span><span class="token class-name">String</span> str <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€ä¸ª Stream åªå¯ä»¥ä½¿ç”¨ä¸€æ¬¡ï¼Œä¸Šé¢çš„ä»£ç ä¸ºäº†ç®€æ´è€Œé‡å¤ä½¿ç”¨äº†æ•°æ¬¡ã€‚</p><h3 id="æµçš„æ“ä½œ"><a class="header-anchor" href="#æµçš„æ“ä½œ"></a>æµçš„æ“ä½œ</h3><p>æ¥ä¸‹æ¥ï¼Œå½“æŠŠä¸€ä¸ªæ•°æ®ç»“æ„åŒ…è£…æˆ Stream åï¼Œå°±è¦å¼€å§‹å¯¹é‡Œé¢çš„å…ƒç´ è¿›è¡Œå„ç±»æ“ä½œäº†ã€‚å¸¸è§çš„æ“ä½œå¯ä»¥å½’ç±»å¦‚ä¸‹ã€‚</p><ul><li><p>Intermediateï¼š(ä¸­é—´)<br>map (mapToInt, flatMap ç­‰)ã€ filterã€ distinctã€ sortedã€ peekã€ limitã€ skipã€ parallelã€ sequentialã€ unordered</p></li><li><p>Terminal: (ç»ˆç‚¹)<br>forEachã€ forEachOrderedã€ toArrayã€ reduceã€ collectã€ minã€ maxã€ countã€ anyMatchã€ allMatchã€ noneMatchã€ findFirstã€ findAnyã€ iterator</p></li><li><p>Short-circuitingï¼š<br>anyMatchã€ allMatchã€ noneMatchã€ findFirstã€ findAnyã€ limit</p></li></ul><p>æˆ‘ä»¬ä¸‹é¢çœ‹ä¸€ä¸‹ Stream çš„æ¯”è¾ƒå…¸å‹ç”¨æ³•ã€‚</p><h4 id="map-flatMap"><a class="header-anchor" href="#map-flatMap"></a>map/flatMap</h4><p>æˆ‘ä»¬å…ˆæ¥çœ‹ mapã€‚å¦‚æœä½ ç†Ÿæ‚‰ scala è¿™ç±»å‡½æ•°å¼è¯­è¨€ï¼Œå¯¹è¿™ä¸ªæ–¹æ³•åº”è¯¥å¾ˆäº†è§£ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠ input Stream çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œæ˜ å°„æˆ output Stream çš„å¦å¤–ä¸€ä¸ªå…ƒç´ ã€‚</p><ul><li>æ¸…å•7. è½¬æ¢å¤§å†™</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> output <span class="token operator">=</span> wordList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>æ¸…å•8. å¹³æ–¹æ•°</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> nums <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> squareNums <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">-></span> n <span class="token operator">*</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç ç”Ÿæˆä¸€ä¸ªæ•´æ•° list çš„å¹³æ–¹æ•° {1, 4, 9, 16}ã€‚</p><p>ä»ä¸Šé¢ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œmap ç”Ÿæˆçš„æ˜¯ä¸ª 1:1 æ˜ å°„ï¼Œæ¯ä¸ªè¾“å…¥å…ƒç´ ï¼Œéƒ½æŒ‰ç…§è§„åˆ™è½¬æ¢æˆä¸ºå¦å¤–ä¸€ä¸ªå…ƒç´ ã€‚è¿˜æœ‰ä¸€äº›åœºæ™¯ï¼Œæ˜¯ä¸€å¯¹å¤šæ˜ å°„å…³ç³»çš„ï¼Œè¿™æ—¶éœ€è¦ flatMapã€‚</p><ul><li>æ¸…å•9. ä¸€å¯¹å¤š</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputStream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> outputStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>childList<span class="token punctuation">)</span> <span class="token operator">-></span> childList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flatMap æŠŠ input Stream ä¸­çš„å±‚çº§ç»“æ„æ‰å¹³åŒ–ï¼Œå°±æ˜¯å°†æœ€åº•å±‚å…ƒç´ æŠ½å‡ºæ¥æ”¾åˆ°ä¸€èµ·ï¼Œæœ€ç»ˆ output çš„æ–° Stream é‡Œé¢å·²ç»æ²¡æœ‰ List äº†ï¼Œéƒ½æ˜¯ç›´æ¥çš„æ•°å­—ã€‚</p><h4 id="filter"><a class="header-anchor" href="#filter"></a>filter</h4><p>filterå¯¹åŸå§‹Streamè¿›è¡ŒæŸé¡¹æµ‹è¯•ï¼Œé€šè¿‡æµ‹è¯•çš„å…ƒç´ è¢«ç•™ä¸‹æ¥ç”Ÿæˆä¸€ä¸ªæ–° Streamã€‚</p><ul><li>æ¸…å•10. ç•™ä¸‹å¶æ•°</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sixNums <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> evens <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>sixNums<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>n <span class="token operator">-></span> n<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç»è¿‡æ¡ä»¶â€œè¢« 2 æ•´é™¤â€çš„ filterï¼Œå‰©ä¸‹çš„æ•°å­—ä¸º {2, 4, 6}ã€‚</p><ul><li>æ¸…å•11. æŠŠå•è¯æŒ‘å‡ºæ¥</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> output <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>line <span class="token operator">-></span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>REGEXP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>word <span class="token operator">-></span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç é¦–å…ˆæŠŠæ¯è¡Œçš„å•è¯ç”¨ flatMap æ•´ç†åˆ°æ–°çš„ Streamï¼Œç„¶åä¿ç•™é•¿åº¦ä¸ä¸º 0 çš„ï¼Œå°±æ˜¯æ•´ç¯‡æ–‡ç« ä¸­çš„å…¨éƒ¨å•è¯äº†ã€‚</p><h4 id="forEach"><a class="header-anchor" href="#forEach"></a>forEach</h4><p>forEach æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Lambda è¡¨è¾¾å¼ï¼Œç„¶ååœ¨ Stream çš„æ¯ä¸€ä¸ªå…ƒç´ ä¸Šæ‰§è¡Œè¯¥è¡¨è¾¾å¼ã€‚</p><ul><li>æ¸…å• 12. æ‰“å°å§“åï¼ˆforEach å’Œ pre-java8 çš„å¯¹æ¯”ï¼‰</li></ul><p>// Java 8</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">roster <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span><span class="token function">getGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Person<span class="token punctuation">.</span>Sex</span><span class="token punctuation">.</span>MALE<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>p <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Pre-Java 8</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Person</span> p <span class="token operator">:</span> roster<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Person<span class="token punctuation">.</span>Sex</span><span class="token punctuation">.</span>MALE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹ä¸€ä¸ªäººå‘˜é›†åˆéå†ï¼Œæ‰¾å‡ºç”·æ€§å¹¶æ‰“å°å§“åã€‚å¯ä»¥çœ‹å‡ºæ¥ï¼ŒforEach æ˜¯ä¸º Lambda è€Œè®¾è®¡çš„ï¼Œä¿æŒäº†æœ€ç´§å‡‘çš„é£æ ¼ã€‚è€Œä¸” Lambda è¡¨è¾¾å¼æœ¬èº«æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œéå¸¸æ–¹ä¾¿ã€‚å½“éœ€è¦ä¸ºå¤šæ ¸ç³»ç»Ÿä¼˜åŒ–æ—¶ï¼Œå¯ä»¥ parallelStream().forEach()ï¼Œåªæ˜¯æ­¤æ—¶åŸæœ‰å…ƒç´ çš„æ¬¡åºæ²¡æ³•ä¿è¯ï¼Œå¹¶è¡Œçš„æƒ…å†µä¸‹å°†æ”¹å˜ä¸²è¡Œæ—¶æ“ä½œçš„è¡Œä¸ºï¼Œæ­¤æ—¶ forEach æœ¬èº«çš„å®ç°ä¸éœ€è¦è°ƒæ•´ï¼Œè€Œ Java8 ä»¥å‰çš„ for å¾ªç¯ code å¯èƒ½éœ€è¦åŠ å…¥é¢å¤–çš„å¤šçº¿ç¨‹é€»è¾‘ã€‚</p><p>ä½†ä¸€èˆ¬è®¤ä¸ºï¼ŒforEach å’Œå¸¸è§„ for å¾ªç¯çš„å·®å¼‚ä¸æ¶‰åŠåˆ°æ€§èƒ½ï¼Œå®ƒä»¬ä»…ä»…æ˜¯å‡½æ•°å¼é£æ ¼ä¸ä¼ ç»Ÿ Java é£æ ¼çš„å·®åˆ«ã€‚</p><p>å¦å¤–ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒforEach æ˜¯ terminal æ“ä½œï¼Œå› æ­¤å®ƒæ‰§è¡Œåï¼ŒStream çš„å…ƒç´ å°±è¢«â€œæ¶ˆè´¹â€æ‰äº†ï¼Œä½ æ— æ³•å¯¹ä¸€ä¸ª Stream è¿›è¡Œä¸¤æ¬¡ terminal è¿ç®—ã€‚ä¸‹é¢çš„ä»£ç æ˜¯é”™è¯¯çš„ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">stream<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>element <span class="token operator">-></span> <span class="token function">doOneThing</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stream<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>element <span class="token operator">-></span> <span class="token function">doAnotherThing</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç›¸åï¼Œå…·æœ‰ç›¸ä¼¼åŠŸèƒ½çš„ intermediate æ“ä½œ<strong>peek</strong>å¯ä»¥è¾¾åˆ°ä¸Šè¿°ç›®çš„ã€‚å¦‚ä¸‹æ˜¯å‡ºç°åœ¨è¯¥ api javadoc ä¸Šçš„ä¸€ä¸ªç¤ºä¾‹ã€‚</p><ul><li>æ¸…å•13. peek å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œæ“ä½œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Stream</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token string">"four"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">-></span> e<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>e <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filtered value: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>e <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Mapped value: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="findFirst"><a class="header-anchor" href="#findFirst"></a>findFirst</h4><p>è¿™æ˜¯ä¸€ä¸ª termimal å…¼ short-circuiting æ“ä½œï¼Œå®ƒæ€»æ˜¯è¿”å› Stream çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…ç©ºã€‚</p><p>è¿™é‡Œæ¯”è¾ƒé‡ç‚¹çš„æ˜¯å®ƒçš„è¿”å›å€¼ç±»å‹ï¼šOptionalã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡ä»¿ Scala è¯­è¨€ä¸­çš„æ¦‚å¿µï¼Œä½œä¸ºä¸€ä¸ªå®¹å™¨ï¼Œå®ƒå¯èƒ½å«æœ‰æŸå€¼ï¼Œæˆ–è€…ä¸åŒ…å«ã€‚ä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å°½å¯èƒ½é¿å… NullPointerExceptionã€‚</p><ul><li>æ¸…å•14. Optional çš„ä¸¤ä¸ªç”¨ä¾‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> strA <span class="token operator">=</span> <span class="token string">" abcd "</span><span class="token punctuation">,</span> strB <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>strA<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>strB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getLength</span><span class="token punctuation">(</span>strA<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getLength</span><span class="token punctuation">(</span>strB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Java 8</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Pre-Java 8</span><span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getLength</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Java 8</span><span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Pre-Java 8</span><span class="token comment">// return if (text != null) ? text.length() : -1;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ›´å¤æ‚çš„ if (xx != null) çš„æƒ…å†µä¸­ï¼Œä½¿ç”¨ Optional ä»£ç çš„å¯è¯»æ€§æ›´å¥½ï¼Œè€Œä¸”å®ƒæä¾›çš„æ˜¯ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œèƒ½æå¤§çš„é™ä½ NPE è¿™ç§ Runtime Exception å¯¹ç¨‹åºçš„å½±å“ï¼Œæˆ–è€…è¿«ä½¿ç¨‹åºå‘˜æ›´æ—©çš„åœ¨ç¼–ç é˜¶æ®µå¤„ç†ç©ºå€¼é—®é¢˜ï¼Œè€Œä¸æ˜¯ç•™åˆ°è¿è¡Œæ—¶å†å‘ç°å’Œè°ƒè¯•ã€‚</p><p>Stream ä¸­çš„ <strong>findAny</strong>ã€<strong>max/min</strong>ã€<strong>reduce</strong>ç­‰æ–¹æ³•ç­‰è¿”å› Optional å€¼ã€‚è¿˜æœ‰ä¾‹å¦‚ **IntStream.average()**è¿”å› OptionalDouble ç­‰ç­‰ã€‚</p><h4 id="reduce"><a class="header-anchor" href="#reduce"></a>reduce</h4><p>è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯æŠŠ Stream å…ƒç´ ç»„åˆèµ·æ¥ã€‚å®ƒæä¾›ä¸€ä¸ªèµ·å§‹å€¼ï¼ˆç§å­ï¼‰ï¼Œç„¶åä¾ç…§è¿ç®—è§„åˆ™ï¼ˆBinaryOperatorï¼‰ï¼Œå’Œå‰é¢ Stream çš„ç¬¬ä¸€ä¸ªã€ç¬¬äºŒä¸ªã€ç¬¬ n ä¸ªå…ƒç´ ç»„åˆã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥ã€æ•°å€¼çš„ sumã€minã€maxã€average éƒ½æ˜¯ç‰¹æ®Šçš„ reduceã€‚ä¾‹å¦‚ Stream çš„ sum å°±ç›¸å½“äº<br>Integer sum = integers.reduce(0, (a, b) -&gt; a+b); æˆ– Integer sum = integers.reduce(0, Integer::sum);</p><p>ä¹Ÿæœ‰æ²¡æœ‰èµ·å§‹å€¼çš„æƒ…å†µï¼Œè¿™æ—¶ä¼šæŠŠ Stream çš„å‰é¢ä¸¤ä¸ªå…ƒç´ ç»„åˆèµ·æ¥ï¼Œè¿”å›çš„æ˜¯ Optionalã€‚</p><ul><li>æ¸…å•15. reduce çš„ç”¨ä¾‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// å­—ç¬¦ä¸²è¿æ¥ï¼Œconcat = "ABCD"</span><span class="token class-name">String</span> concat <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">concat</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ±‚æœ€å°å€¼ï¼ŒminValue = -3.0</span><span class="token keyword">double</span> minValue <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ±‚å’Œï¼ŒsumValue = 10, æœ‰èµ·å§‹å€¼</span><span class="token keyword">int</span> sumValue <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ±‚å’Œï¼ŒsumValue = 10, æ— èµ·å§‹å€¼</span>sumValue <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¿‡æ»¤ï¼Œå­—ç¬¦ä¸²è¿æ¥ï¼Œconcat = "ace"</span>concat <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">-></span> x<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token string">"Z"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">concat</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ä»£ç ä¾‹å¦‚ç¬¬ä¸€ä¸ªç¤ºä¾‹çš„ reduce()ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆç©ºç™½å­—ç¬¦ï¼‰å³ä¸ºèµ·å§‹å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼ˆString::concatï¼‰ä¸º BinaryOperatorã€‚è¿™ç±»æœ‰èµ·å§‹å€¼çš„ reduce() éƒ½è¿”å›å…·ä½“çš„å¯¹è±¡ã€‚è€Œå¯¹äºç¬¬å››ä¸ªç¤ºä¾‹æ²¡æœ‰èµ·å§‹å€¼çš„ reduce()ï¼Œç”±äºå¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„å…ƒç´ ï¼Œè¿”å›çš„æ˜¯ Optionalï¼Œè¯·ç•™æ„è¿™ä¸ªåŒºåˆ«ã€‚</p><h4 id="limit-skip"><a class="header-anchor" href="#limit-skip"></a>limit/skip</h4><p>limit è¿”å› Stream çš„å‰é¢ n ä¸ªå…ƒç´ ï¼›skip åˆ™æ˜¯æ‰”æ‰å‰ n ä¸ªå…ƒç´ ï¼ˆå®ƒæ˜¯ç”±ä¸€ä¸ªå« subStream çš„æ–¹æ³•æ”¹åè€Œæ¥ï¼‰ã€‚</p><ul><li>æ¸…å•16. limit å’Œ skip å¯¹è¿è¡Œæ¬¡æ•°çš„å½±å“</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testLimitAndSkip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> persons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> personList2 <span class="token operator">=</span> persons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>personList2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span> <span class="token keyword">int</span> no<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token punctuation">(</span><span class="token keyword">int</span> no<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>no <span class="token operator">=</span> no<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> name<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœä¸ºï¼š</p><pre class="line-numbers language-none"><code class="language-none">name1name2name3name4name5name6name7name8name9name10[name4, name5, name6, name7, name8, name9, name10]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯ä¸€ä¸ªæœ‰ 10ï¼Œ000 ä¸ªå…ƒç´ çš„ Streamï¼Œä½†åœ¨ short-circuiting æ“ä½œ limit å’Œ skip çš„ä½œç”¨ä¸‹ï¼Œç®¡é“ä¸­ map æ“ä½œæŒ‡å®šçš„ getName() æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°ä¸º limit æ‰€é™å®šçš„ 10 æ¬¡ï¼Œè€Œæœ€ç»ˆè¿”å›ç»“æœåœ¨è·³è¿‡å‰ 3 ä¸ªå…ƒç´ ååªæœ‰åé¢ 7 ä¸ªè¿”å›ã€‚</p><p>æœ‰ä¸€ç§æƒ…å†µæ˜¯ limit/skip æ— æ³•è¾¾åˆ° short-circuiting ç›®çš„çš„ï¼Œå°±æ˜¯æŠŠå®ƒä»¬æ”¾åœ¨ Stream çš„æ’åºæ“ä½œåï¼ŒåŸå› è·Ÿ sorted è¿™ä¸ª intermediate æ“ä½œæœ‰å…³ï¼šæ­¤æ—¶ç³»ç»Ÿå¹¶ä¸çŸ¥é“ Stream æ’åºåçš„æ¬¡åºå¦‚ä½•ï¼Œæ‰€ä»¥ sorted ä¸­çš„æ“ä½œçœ‹ä¸Šå»å°±åƒå®Œå…¨æ²¡æœ‰è¢« limit æˆ–è€… skip ä¸€æ ·ã€‚</p><ul><li>æ¸…å•17. limit å’Œ skip å¯¹ sorted åçš„è¿è¡Œæ¬¡æ•°æ— å½±å“</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> persons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> personList2 <span class="token operator">=</span> persons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-></span> p1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>personList2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ç¤ºä¾‹å¯¹æ¸…å• 13 åšäº†å¾®è°ƒï¼Œé¦–å…ˆå¯¹ 5 ä¸ªå…ƒç´ çš„ Stream æ’åºï¼Œç„¶åè¿›è¡Œ limit æ“ä½œã€‚è¾“å‡ºç»“æœä¸ºï¼š</p><pre class="line-numbers language-none"><code class="language-none">name2name1name3name2name4name3name5name4[stream.StreamDW$Person@816f27d, stream.StreamDW$Person@87aac27]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å³è™½ç„¶æœ€åçš„è¿”å›å…ƒç´ æ•°é‡æ˜¯ 2ï¼Œä½†æ•´ä¸ªç®¡é“ä¸­çš„ sorted è¡¨è¾¾å¼æ‰§è¡Œæ¬¡æ•°æ²¡æœ‰åƒå‰é¢ä¾‹å­ç›¸åº”å‡å°‘ã€‚</p><p>æœ€åæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹ä¸€ä¸ª parallel çš„ Steam ç®¡é“æ¥è¯´ï¼Œå¦‚æœå…¶å…ƒç´ æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆ limit æ“ä½œçš„æˆæœ¬ä¼šæ¯”è¾ƒå¤§ï¼Œå› ä¸ºå®ƒçš„è¿”å›å¯¹è±¡å¿…é¡»æ˜¯å‰ n ä¸ªä¹Ÿæœ‰ä¸€æ ·æ¬¡åºçš„å…ƒç´ ã€‚å–è€Œä»£ä¹‹çš„ç­–ç•¥æ˜¯å–æ¶ˆå…ƒç´ é—´çš„æ¬¡åºï¼Œæˆ–è€…ä¸è¦ç”¨ parallel Streamã€‚</p><h4 id="sorted"><a class="header-anchor" href="#sorted"></a>sorted</h4><p>å¯¹ Stream çš„æ’åºé€šè¿‡ sorted è¿›è¡Œï¼Œå®ƒæ¯”æ•°ç»„çš„æ’åºæ›´å¼ºä¹‹å¤„åœ¨äºä½ å¯ä»¥é¦–å…ˆå¯¹ Stream è¿›è¡Œå„ç±» mapã€filterã€limitã€skip ç”šè‡³ distinct æ¥å‡å°‘å…ƒç´ æ•°é‡åï¼Œå†æ’åºï¼Œè¿™èƒ½å¸®åŠ©ç¨‹åºæ˜æ˜¾ç¼©çŸ­æ‰§è¡Œæ—¶é—´ã€‚æˆ‘ä»¬å¯¹æ¸…å• 14 è¿›è¡Œä¼˜åŒ–ï¼š</p><ul><li>æ¸…å•18. ä¼˜åŒ–ï¼šæ’åºå‰è¿›è¡Œ limit å’Œ skip</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> persons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> personList2 <span class="token operator">=</span> persons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-></span> p1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>personList2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœä¼šç®€å•å¾ˆå¤šï¼š</p><pre class="line-numbers language-none"><code class="language-none">name2name1[stream.StreamDW$Person@6ce253f1, stream.StreamDW$Person@53d8d10a]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶ï¼Œè¿™ç§ä¼˜åŒ–æ˜¯æœ‰ business logic ä¸Šçš„å±€é™æ€§çš„ï¼šå³ä¸è¦æ±‚æ’åºåå†å–å€¼ã€‚</p><h4 id="min-max-distinc"><a class="header-anchor" href="#min-max-distinc"></a>min/max/distinc</h4><p>min å’Œ max çš„åŠŸèƒ½ä¹Ÿå¯ä»¥é€šè¿‡å¯¹ Stream å…ƒç´ å…ˆæ’åºï¼Œå† findFirst æ¥å®ç°ï¼Œä½†å‰è€…çš„æ€§èƒ½ä¼šæ›´å¥½ï¼Œä¸º O(n)ï¼Œè€Œ sorted çš„æˆæœ¬æ˜¯ O(n log n)ã€‚åŒæ—¶å®ƒä»¬ä½œä¸ºç‰¹æ®Šçš„ reduce æ–¹æ³•è¢«ç‹¬ç«‹å‡ºæ¥ä¹Ÿæ˜¯å› ä¸ºæ±‚æœ€å¤§æœ€å°å€¼æ˜¯å¾ˆå¸¸è§çš„æ“ä½œã€‚</p><ul><li>æ¸…å•19. æ‰¾å‡ºæœ€é•¿ä¸€è¡Œçš„é•¿åº¦</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token string">"c:\\SUService.log"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> longest <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAsInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>longest<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢çš„ä¾‹å­åˆ™ä½¿ç”¨ distinct æ¥æ‰¾å‡ºä¸é‡å¤çš„å•è¯ã€‚</p><ul><li>æ¸…å•20. æ‰¾å‡ºå…¨æ–‡çš„å•è¯ï¼Œè½¬å°å†™ï¼Œå¹¶æ’åº</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> words <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">flatMap</span><span class="token punctuation">(</span>line <span class="token operator">-></span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">filter</span><span class="token punctuation">(</span>word <span class="token operator">-></span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toLowerCase</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>words<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Match"><a class="header-anchor" href="#Match"></a>Match</h4><p>Stream æœ‰ä¸‰ä¸ª match æ–¹æ³•ï¼Œä»è¯­ä¹‰ä¸Šè¯´ï¼š</p><ul><li>allMatchï¼šStream ä¸­å…¨éƒ¨å…ƒç´ ç¬¦åˆä¼ å…¥çš„ predicateï¼Œè¿”å› true</li><li>anyMatchï¼šStream ä¸­åªè¦æœ‰ä¸€ä¸ªå…ƒç´ ç¬¦åˆä¼ å…¥çš„ predicateï¼Œè¿”å› true</li><li>noneMatchï¼šStream ä¸­æ²¡æœ‰ä¸€ä¸ªå…ƒç´ ç¬¦åˆä¼ å…¥çš„ predicateï¼Œè¿”å› true</li></ul><p>å®ƒä»¬éƒ½ä¸æ˜¯è¦éå†å…¨éƒ¨å…ƒç´ æ‰èƒ½è¿”å›ç»“æœã€‚ä¾‹å¦‚ allMatch åªè¦ä¸€ä¸ªå…ƒç´ ä¸æ»¡è¶³æ¡ä»¶ï¼Œå°± skip å‰©ä¸‹çš„æ‰€æœ‰å…ƒç´ ï¼Œè¿”å› falseã€‚å¯¹æ¸…å• 13 ä¸­çš„ Person ç±»ç¨åšä¿®æ”¹ï¼ŒåŠ å…¥ä¸€ä¸ª age å±æ€§å’Œ getAge æ–¹æ³•ã€‚</p><ul><li>æ¸…å•21. ä½¿ç”¨ Match</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> persons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>persons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> isAllAdult <span class="token operator">=</span> persons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">allMatch</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"All are adult? "</span> <span class="token operator">+</span> isAllAdult<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> isThereAnyChild <span class="token operator">=</span> persons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">anyMatch</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Any child? "</span> <span class="token operator">+</span> isThereAnyChild<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">All are adult? falseAny child? true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="è¿›é˜¶ï¼šè‡ªå·±ç”Ÿæˆæµ"><a class="header-anchor" href="#è¿›é˜¶ï¼šè‡ªå·±ç”Ÿæˆæµ"></a>è¿›é˜¶ï¼šè‡ªå·±ç”Ÿæˆæµ</h3><h4 id="Stream-generate"><a class="header-anchor" href="#Stream-generate"></a>Stream.generate</h4><p>é€šè¿‡å®ç° Supplier æ¥å£ï¼Œä½ å¯ä»¥è‡ªå·±æ¥æ§åˆ¶æµçš„ç”Ÿæˆã€‚è¿™ç§æƒ…å½¢é€šå¸¸ç”¨äºéšæœºæ•°ã€å¸¸é‡çš„ Streamï¼Œæˆ–è€…éœ€è¦å‰åå…ƒç´ é—´ç»´æŒç€æŸç§çŠ¶æ€ä¿¡æ¯çš„ Streamã€‚æŠŠ Supplier å®ä¾‹ä¼ é€’ç»™ Stream.generate() ç”Ÿæˆçš„ Streamï¼Œé»˜è®¤æ˜¯ä¸²è¡Œï¼ˆç›¸å¯¹ parallel è€Œè¨€ï¼‰ä½†æ— åºçš„ï¼ˆç›¸å¯¹ ordered è€Œè¨€ï¼‰ã€‚ç”±äºå®ƒæ˜¯æ— é™çš„ï¼Œåœ¨ç®¡é“ä¸­ï¼Œå¿…é¡»åˆ©ç”¨ limit ä¹‹ç±»çš„æ“ä½œé™åˆ¶ Stream å¤§å°ã€‚</p><ul><li>æ¸…å•22. ç”Ÿæˆ 10 ä¸ªéšæœºæ•´æ•°</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Random</span> seed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> random <span class="token operator">=</span> seed<span class="token operator">::</span><span class="token function">nextInt</span><span class="token punctuation">;</span><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Another way</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Stream.generate() è¿˜æ¥å—è‡ªå·±å®ç°çš„ Supplierã€‚ä¾‹å¦‚åœ¨æ„é€ æµ·é‡æµ‹è¯•æ•°æ®çš„æ—¶å€™ï¼Œç”¨æŸç§è‡ªåŠ¨çš„è§„åˆ™ç»™æ¯ä¸€ä¸ªå˜é‡èµ‹å€¼ï¼›æˆ–è€…ä¾æ®å…¬å¼è®¡ç®— Stream çš„æ¯ä¸ªå…ƒç´ å€¼ã€‚è¿™äº›éƒ½æ˜¯ç»´æŒçŠ¶æ€ä¿¡æ¯çš„æƒ…å½¢ã€‚</p><ul><li>æ¸…å•23. è‡ªå®ç° Supplier</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>p <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> p<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">PersonSupplier</span> <span class="token keyword">implements</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token string">"StormTestUser"</span> <span class="token operator">+</span> index<span class="token punctuation">,</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">StormTestUser1, 9StormTestUser2, 12StormTestUser3, 88StormTestUser4, 51StormTestUser5, 22StormTestUser6, 28StormTestUser7, 81StormTestUser8, 51StormTestUser9, 4StormTestUser10, 76<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Stream-iterate"><a class="header-anchor" href="#Stream-iterate"></a>Stream.iterate</h4><p>iterate è·Ÿ reduce æ“ä½œå¾ˆåƒï¼Œæ¥å—ä¸€ä¸ªç§å­å€¼ï¼Œå’Œä¸€ä¸ª UnaryOperatorï¼ˆä¾‹å¦‚ fï¼‰ã€‚ç„¶åç§å­å€¼æˆä¸º Stream çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œf(seed) ä¸ºç¬¬äºŒä¸ªï¼Œf(f(seed)) ç¬¬ä¸‰ä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><ul><li>æ¸…å•24. ç”Ÿæˆä¸€ä¸ªç­‰å·®æ•°åˆ—</li></ul><blockquote><p>Stream.iterate(0, n -&gt; n + 3).limit(10). forEach(x -&gt; System.out.print(x + &quot; &quot;));</p></blockquote><p>è¾“å‡ºç»“æœï¼š</p><blockquote><p>0 3 6 9 12 15 18 21 24 27</p></blockquote><p>ä¸ Stream.generate ç›¸ä»¿ï¼Œåœ¨ iterate æ—¶å€™ç®¡é“å¿…é¡»æœ‰ limit è¿™æ ·çš„æ“ä½œæ¥é™åˆ¶ Stream å¤§å°ã€‚</p><h3 id="è¿›é˜¶ï¼šç”¨-Collectors-æ¥è¿›è¡Œ-reduction-æ“ä½œ"><a class="header-anchor" href="#è¿›é˜¶ï¼šç”¨-Collectors-æ¥è¿›è¡Œ-reduction-æ“ä½œ"></a>è¿›é˜¶ï¼šç”¨ Collectors æ¥è¿›è¡Œ reduction æ“ä½œ</h3><p>java.util.stream.Collectors ç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯è¾…åŠ©è¿›è¡Œå„ç±»æœ‰ç”¨çš„ reduction æ“ä½œï¼Œä¾‹å¦‚è½¬å˜è¾“å‡ºä¸º Collectionï¼ŒæŠŠ Stream å…ƒç´ è¿›è¡Œå½’ç»„ã€‚</p><h4 id="groupingBy-partitioningBy"><a class="header-anchor" href="#groupingBy-partitioningBy"></a>groupingBy/partitioningBy</h4><ul><li>æ¸…å•25. æŒ‰ç…§å¹´é¾„å½’ç»„</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span><span class="token punctuation">></span></span> personGroups <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Iterator</span> it <span class="token operator">=</span> personGroups<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span><span class="token punctuation">></span></span> persons <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Age "</span> <span class="token operator">+</span> persons<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> persons<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ codeï¼Œé¦–å…ˆç”Ÿæˆ 100 äººçš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§å¹´é¾„å½’ç»„ï¼Œç›¸åŒå¹´é¾„çš„äººæ”¾åˆ°åŒä¸€ä¸ª list ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡º</p><pre class="line-numbers language-none"><code class="language-none">Age 0 &#x3D; 2Age 1 &#x3D; 2Age 5 &#x3D; 2Age 8 &#x3D; 1Age 9 &#x3D; 1Age 11 &#x3D; 2â€¦â€¦<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¸…å•26. æŒ‰ç…§æœªæˆå¹´äººå’Œæˆå¹´äººå½’ç»„</li></ul><pre class="line-numbers language-none"><code class="language-none">Map&lt;Boolean, List&lt;Person&gt;&gt; children &#x3D; Stream.generate(new PersonSupplier()). limit(100). collect(Collectors.partitioningBy(p -&gt; p.getAge() &lt; 18));System.out.println(&quot;Children number: &quot; + children.get(true).size());System.out.println(&quot;Adult number: &quot; + children.get(false).size());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">Children number: 23 Adult number: 77<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åœ¨ä½¿ç”¨æ¡ä»¶â€œå¹´é¾„å°äº 18â€è¿›è¡Œåˆ†ç»„åå¯ä»¥çœ‹åˆ°ï¼Œä¸åˆ° 18 å²çš„æœªæˆå¹´äººæ˜¯ä¸€ç»„ï¼Œæˆå¹´äººæ˜¯å¦å¤–ä¸€ç»„ã€‚partitioningBy å…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„ groupingByï¼Œå®ƒä¾ç…§æ¡ä»¶æµ‹è¯•çš„æ˜¯å¦ä¸¤ç§ç»“æœæ¥æ„é€ è¿”å›çš„æ•°æ®ç»“æ„ï¼Œget(true) å’Œ get(false) èƒ½å³ä¸ºå…¨éƒ¨çš„å…ƒç´ å¯¹è±¡ã€‚</p><h2 id="ç»“æŸè¯­"><a class="header-anchor" href="#ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>æ€»ä¹‹ï¼ŒStream çš„ç‰¹æ€§å¯ä»¥å½’çº³ä¸ºï¼š</p><ul><li>ä¸æ˜¯æ•°æ®ç»“æ„</li><li>å®ƒæ²¡æœ‰å†…éƒ¨å­˜å‚¨ï¼Œå®ƒåªæ˜¯ç”¨æ“ä½œç®¡é“ä» sourceï¼ˆæ•°æ®ç»“æ„ã€æ•°ç»„ã€generator functionã€IO channelï¼‰æŠ“å–æ•°æ®ã€‚</li><li>å®ƒä¹Ÿç»ä¸ä¿®æ”¹è‡ªå·±æ‰€å°è£…çš„åº•å±‚æ•°æ®ç»“æ„çš„æ•°æ®ã€‚ä¾‹å¦‚ Stream çš„ filter æ“ä½œä¼šäº§ç”Ÿä¸€ä¸ªä¸åŒ…å«è¢«è¿‡æ»¤å…ƒç´ çš„æ–° Streamï¼Œè€Œä¸æ˜¯ä» source åˆ é™¤é‚£äº›å…ƒç´ ã€‚</li><li>æ‰€æœ‰ Stream çš„æ“ä½œå¿…é¡»ä»¥ lambda è¡¨è¾¾å¼ä¸ºå‚æ•°</li><li>ä¸æ”¯æŒç´¢å¼•è®¿é—®</li><li>ä½ å¯ä»¥è¯·æ±‚ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä½†æ— æ³•è¯·æ±‚ç¬¬äºŒä¸ªï¼Œç¬¬ä¸‰ä¸ªï¼Œæˆ–æœ€åä¸€ä¸ªã€‚ä¸è¿‡è¯·å‚é˜…ä¸‹ä¸€é¡¹ã€‚</li><li>å¾ˆå®¹æ˜“ç”Ÿæˆæ•°ç»„æˆ–è€… List</li><li>æƒ°æ€§åŒ–</li><li>å¾ˆå¤š Stream æ“ä½œæ˜¯å‘åå»¶è¿Ÿçš„ï¼Œä¸€ç›´åˆ°å®ƒå¼„æ¸…æ¥šäº†æœ€åéœ€è¦å¤šå°‘æ•°æ®æ‰ä¼šå¼€å§‹ã€‚</li><li>Intermediate æ“ä½œæ°¸è¿œæ˜¯æƒ°æ€§åŒ–çš„ã€‚</li><li>å¹¶è¡Œèƒ½åŠ›</li><li>å½“ä¸€ä¸ª Stream æ˜¯å¹¶è¡ŒåŒ–çš„ï¼Œå°±ä¸éœ€è¦å†å†™å¤šçº¿ç¨‹ä»£ç ï¼Œæ‰€æœ‰å¯¹å®ƒçš„æ“ä½œä¼šè‡ªåŠ¨å¹¶è¡Œè¿›è¡Œçš„ã€‚</li><li>å¯ä»¥æ˜¯æ— é™çš„<ul><li>é›†åˆæœ‰å›ºå®šå¤§å°ï¼ŒStream åˆ™ä¸å¿…ã€‚limit(n) å’Œ findFirst() è¿™ç±»çš„ short-circuiting æ“ä½œå¯ä»¥å¯¹æ— é™çš„ Stream è¿›è¡Œè¿ç®—å¹¶å¾ˆå¿«å®Œæˆã€‚</li></ul></li></ul><h2 id="æ”¶è—ç¬”è®°"><a class="header-anchor" href="#æ”¶è—ç¬”è®°"></a>æ”¶è—ç¬”è®°</h2><p>streamæµåœ¨å¼€å‘ä¸­å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œè¿™ç¯‡æ–‡ç« å°†streamä»ä½•è€Œæ¥åˆ°å¦‚ä½•ä½¿ç”¨éƒ½è®²è§£çš„å¾ˆæ¸…æ¥šã€‚æ€»ç»“ä¸€ä¸‹streamçš„ç”¨æ³•</p><h3 id="æ„é€ Stream"><a class="header-anchor" href="#æ„é€ Stream"></a>æ„é€ Stream</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Stream</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Arrays</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream1 <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Collections</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream2 <span class="token operator">=</span> ls<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®é™…å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬æ˜¯<strong>Collections</strong>çš„æ–¹å¼ä½¿ç”¨çš„æ¯”è¾ƒå¤š</p><h3 id="æ“ä½œæµ"><a class="header-anchor" href="#æ“ä½œæµ"></a>æ“ä½œæµ</h3><ul><li><strong>map/flapMap</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Stream</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>map</strong>æ“ä½œå¯¹æ¯ä¸€ä¸ªå…ƒç´ è¿›è¡Œæ“ä½œç„¶åè¿”å›ä¸€ä¸ªç±»å‹</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//flapMap</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> stream2 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream3 <span class="token operator">=</span> stream2<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>flatMap</strong>æ“ä½œå¯¹ä¸€ä¸ªé›†åˆå…ƒç´ è¿›è¡Œæ“ä½œï¼Œç„¶åè¿”å›æ“ä½œç»“æœã€‚</p></blockquote><ul><li><strong>filter</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//filter è¿‡æ»¤æ“ä½œ</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream4 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stream4<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-></span> item <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯¹æ¯ä¸€ä¸ªå…ƒç´ è¿›è¡Œè¿‡æ»¤ï¼Œè¿‡æ»¤æˆåŠŸçš„æ‰è¿”å›Streamæµä¸­</p></blockquote><ul><li><strong>forEach</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//forEach</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream5 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stream5<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>forEach</strong>éå†å¾ªç¯åstreamæµå°±è¢«&quot;æ¶ˆè´¹&quot;æ‰äº†ï¼Œä¸ä¼šåœ¨è¿”å›åˆ°Straem</p></blockquote><ul><li><strong>peek</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//peek</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream6 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream7 <span class="token operator">=</span>stream6<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>peek</strong>éå†å¾ªç¯åï¼Œå…ƒç´ ä¼šè¿”å›streamä¸­</p></blockquote><ul><li><strong>findFirst</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//findFirst</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream8 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> optionalInteger <span class="token operator">=</span> stream8<span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>optionalInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>findFirst</strong>è·å–Streamæµä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›çš„æ˜¯<strong>Optional<T></strong></p></blockquote><ul><li><strong>reduce</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å…ƒç´ åˆå¹¶</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> optional <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">concat</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®åˆå§‹å€¼æ¥è¿›è¡Œåˆå¹¶</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream1 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Integer</span> minNum <span class="token operator">=</span> stream1<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>Reduce åŸæ„ï¼šå‡å°‘ï¼Œç¼©å°</p></li><li><p>æ ¹æ®æŒ‡å®šçš„è®¡ç®—æ¨¡å‹å°†Streamä¸­çš„å€¼è®¡ç®—å¾—åˆ°ä¸€ä¸ªæœ€ç»ˆç»“æœ</p></li><li><p><strong>limit/skip</strong></p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stream<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p><strong>limit</strong>è¿”å›Streamçš„å‰é¢nä¸ªå…ƒç´ ï¼›<strong>skip</strong>åˆ™æ˜¯æ‰”æ‰å‰ n ä¸ªå…ƒç´ ï¼ˆå®ƒæ˜¯ç”±ä¸€ä¸ªå«subStreamçš„æ–¹æ³•æ”¹åè€Œæ¥ï¼‰ã€‚</p></blockquote><ul><li><strong>sorted</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stream<span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p><strong>sorted</strong>å¯¹æµè¿›è¡Œæ’åº</p></blockquote><ul><li><strong>min/max/distinct</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//min</span>    <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> optionalMin <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>optionalMin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//max</span>    <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream1 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> optionalMax <span class="token operator">=</span> stream1<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>optionalMax<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//distinct</span>    <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream2 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stream2<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">print</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">minè·å–streamæµä¸­æœ€å°çš„å…ƒç´ maxè·å–streamæµä¸­æœ€å¤§çš„å…ƒç´ distinctå¯¹å…ƒç´ è¿›è¡Œå»é‡<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><strong>Match</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//allMatchå…¨éƒ¨å…ƒç´ ç¬¦åˆä¼ å…¥çš„å‡½æ•°å°±è¿”å›true</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Boolean</span> allMatchFlag <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>allMatchFlag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//anyMatchåªè¦æœ‰ä¸€ä¸ªå…ƒç´ ç¬¦åˆä¼ å…¥çš„å‡½æ•°å°±è¿”å›true</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream1 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Boolean</span> anyMatchFlag <span class="token operator">=</span> stream1<span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>anyMatchFlag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//noneMatchæ²¡æœ‰å…ƒç´ ç¬¦åˆä¼ å…¥çš„å‡½æ•°å°±è¿”å›true</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> stream2 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Boolean</span> noneMatchFlag <span class="token operator">=</span> stream2<span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item <span class="token operator">></span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>noneMatchFlag<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> stream </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxæ—¥å¿—åˆ†æåŠæ€§èƒ½æ’æŸ¥</title>
      <link href="2020/05/30/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/1.Nginx%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%A7%E8%83%BD%E6%8E%92%E6%9F%A5/"/>
      <url>2020/05/30/14.%E6%94%B6%E8%97%8F%E6%96%87%E7%AB%A0/1.Nginx%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%A7%E8%83%BD%E6%8E%92%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<h1>Nginx æ—¥å¿—åˆ†æåŠæ€§èƒ½æ’æŸ¥</h1><p>è½¬è½½è‡ª:<a href="https://mp.weixin.qq.com/s/A1ufVgi3VFuSGRh4Ju5puA">Nginx æ—¥å¿—åˆ†æåŠæ€§èƒ½æ’æŸ¥</a></p><blockquote><p>ä½œè€…ï¼š-å¤–æ˜Ÿäºº-<br><br><a href="http://my.oschina.net/362228416/blog/844713">my.oschina.net/362228416/blog/844713</a></p></blockquote><p>æœ€è¿‘ä¸€ç›´åœ¨åšæ€§èƒ½æ’æŸ¥ï¼Œæ€è·¯å°±æ˜¯æ ¹æ®åˆ†æNginxæ—¥å¿—ï¼Œå¾—åˆ°å“åº”è€—æ—¶çš„urlã€ä»¥åŠè¯·æ±‚æ—¶é—´ï¼Œå†å¾—åˆ°è¿™æ®µæ—¶é—´çš„è¯·æ±‚é‡ï¼Œå¹¶å‘é‡ï¼Œåˆ†ææ˜¯å¹¶å‘çš„åŸå› ï¼Œè¿˜æ˜¯æœ¬èº«å°±æ¯”è¾ƒæ…¢ï¼Œå¦‚æœæ˜¯åº”ç”¨æœ¬èº«çš„åŸå› ï¼Œåªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ä»£ç ï¼Œç„¶åè¿›è¡Œä¼˜åŒ–å°±å¥½äº†<br>æˆ‘æ‰¾åˆ°çš„å‡ ä¸ªåŸå› ï¼ŒåŸºæœ¬å°±æ˜¯åç«¯sqlè¿è¡Œçš„æ¯”è¾ƒå¤šï¼Œå•æ¬¡è®¿é—®çœ‹ä¸å‡ºæ¥ï¼Œä½†æ˜¯äººæ¯”è¾ƒå¤šçš„æ—¶å€™å°±æ¯”è¾ƒæ…¢äº†ï¼Œäººå°‘çš„æ—¶å€™20-200æ¯«ç§’ï¼Œäººå¤šçš„æ—¶å€™ï¼Œ200-6000æ¯«ç§’ï¼Œä¼˜åŒ–ä¹‹ååŸºæœ¬ä¿æŒåœ¨å‡ åæ¯«ç§’ï¼Œä¼˜åŒ–ç­–ç•¥å°±æ˜¯å‡å°‘ä¸å¿…è¦çš„sqlï¼ŒåŠ ä¸Šç¼“å­˜ï¼ŒåŸºæœ¬è§£å†³äº†å¡é¡¿çš„é—®é¢˜ï¼Œé¡ºä¾¿æŠŠè¿™æ¬¡ç”¨çš„ä¸€ç³»åˆ—å‘½ä»¤è®°å½•ä¸‹æ¥ï¼Œå½“ä¸ªæ€»ç»“å§<br>å¦‚æœéœ€è¦å¾—åˆ°è¯·æ±‚å¤„ç†çš„æ—¶é—´ï¼Œéœ€è¦åœ¨nginx log é‡Œé¢åŠ ä¸Š$request_timeï¼Œä¸‹é¢æ˜¯æˆ‘çš„log_format<br>nginx.conf</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '            '$status $body_bytes_sent $request_body "$http_referer" '            '"$http_user_agent" "$http_x_forwarded_for" "$request_time"';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¿®æ”¹ä¹‹åé‡å¯nginxï¼ŒæŸ¥çœ‹nginx logçš„æ—¶å€™ï¼Œå°±èƒ½çœ‹åˆ°nginxå¤„ç†è¯·æ±‚æ‰€èŠ±çš„æ—¶é—´äº†ï¼Œè¿™ä¸ªæ—¶é—´åŸºæœ¬å°±æ˜¯åç«¯æ‰€èŠ±çš„æ—¶é—´ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®è¿™ä¸ªå­—æ®µæ¥å¾—åˆ°å“åº”æ…¢çš„è¯·æ±‚</p><p>ä»¥ä¸‹æ˜¯å°±æ˜¯æˆ‘ç”¨åˆ°çš„ä¸€äº›å‘½ä»¤äº†</p><ul><li>è·å–pvæ•°</li></ul><blockquote><p>$ cat /usr/local/nginx/logs/access.log | wc -l</p></blockquote><ul><li>è·å–ipæ•°</li></ul><blockquote><p>$ cat /usr/local/nginx/logs/access.log | awk â€˜{print $1}â€™ | sort -k1 -r | uniq | wc -l</p></blockquote><ul><li>è·å–æœ€è€—æ—¶çš„è¯·æ±‚æ—¶é—´ã€urlã€è€—æ—¶ï¼Œå‰10å, å¯ä»¥ä¿®æ”¹åé¢çš„æ•°å­—è·å–æ›´å¤šï¼Œä¸åŠ åˆ™è·å–å…¨éƒ¨</li></ul><blockquote><p>$ cat /usr/local/class/logs/access.log | awk â€˜{print $4,$7,$NF}â€™ | awk -F â€˜&quot;â€™ â€˜{print $1,$2,$3}â€™ | sort -k3 -rn | head -10</p></blockquote><ul><li>è·å–æŸä¸€æ—¶åˆ»çš„è¯·æ±‚æ•°é‡ï¼Œå¯ä»¥æŠŠç§’å»æ‰å¾—åˆ°åˆ†é’Ÿçš„æ•°æ®ï¼ŒæŠŠåˆ†é’Ÿå»æ‰å¾—åˆ°å°æ—¶çš„æ•°æ®ï¼Œä»¥æ­¤ç±»æ¨</li></ul><blockquote><p>$ cat /usr/local/class/logs/access.log | grep 2017:13:28:55 | wc -l</p></blockquote><ul><li>è·å–æ¯åˆ†é’Ÿçš„è¯·æ±‚æ•°é‡ï¼Œè¾“å‡ºæˆcsvæ–‡ä»¶ï¼Œç„¶åç”¨excelæ‰“å¼€ï¼Œå¯ä»¥ç”ŸæˆæŸ±çŠ¶å›¾</li></ul><blockquote><p>$ cat /usr/local/class/logs/access.log  | awk â€˜{print substr($4,14,5)}â€™ | uniq -c | awk â€˜{print $2&quot;,&quot;$1}â€™ &gt; access.csv</p></blockquote><p>ä¸Šé¢çš„å›¾æ˜¯ç”¨excelç”Ÿæˆçš„ï¼Œä¹Ÿå¯ä»¥ç”¨å‘½ä»¤è¡Œå·¥å…·gnuplotç”Ÿæˆpngï¼Œæˆ‘ä¹Ÿè¯•äº†ä¸€ä¸‹ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œç›´æ¥ä»¥ç¼–ç¨‹çš„å½¢å¼å¾—åˆ°æŠ¥è¡¨ï¼Œå»æ‰äººå·¥æ“ä½œéƒ¨åˆ†ï¼Œå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹å°±æ˜¯xè½´æ•°æ®æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œä¸èƒ½åƒexcelä¸€æ ·è‡ªåŠ¨ç¨€é‡Šæ•°æ®ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯å–œæ¬¢ç”¨excelæ¥ç”Ÿæˆ</p><p>å…¶å®ç”¨æ¥ç”¨å»ä¹Ÿå°±æ˜¯é‚£ä¹ˆå‡ ä¸ªå‘½ä»¤:</p><p>catï¼šè¾“å…¥æ–‡ä»¶å†…å®¹</p><p>grepï¼šè¿‡æ»¤æ–‡æœ¬</p><p>â€˜sortâ€™ï¼šæ’åº</p><p>â€˜uniqâ€™ï¼šå»é‡</p><p>â€˜awkâ€™ï¼šæ–‡æœ¬å¤„ç†</p><p>å‘½ä»¤ç»„åˆä½¿ç”¨ï¼Œå•ä¸ªå‘½ä»¤å¯ä»¥ä½¿ç”¨å¤šæ¬¡ï¼Œæ¥è¾¾åˆ°å¤šé‡è¿‡æ»¤çš„æ•ˆæœï¼Œå‰é¢ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºå°±æ˜¯åä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥ï¼Œæµå¼å¤„ç†ï¼Œåªè¦å­¦ä¼šè¿™ä¸ªå‘½ä»¤ï¼Œæœ‰å¤šçœ‹ä¼¼å¤æ‚çš„ä¸œè¥¿ï¼Œéƒ½å˜å¾—å¼‚å¸¸ç®€å•ã€‚</p><p>ä¸Šé¢ä»‹ç»çš„éƒ½æ˜¯å‘½ä»¤ï¼Œä¸‹é¢å†ä»‹ç»ä¸€ä¸ªç›´æ¥è¾“å‡ºhtmlçš„ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨go-accessæ¥åˆ†ænginxæ—¥å¿—</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /usr/local/nginx/logs/access.log <span class="token operator">|</span> docker run --rm -i diyan/goaccess   --time-format<span class="token operator">=</span><span class="token string">'%H:%M:%S'</span>   --date-format<span class="token operator">=</span><span class="token string">'%d/%b/%Y'</span>   --log-format<span class="token operator">=</span><span class="token string">'%h %^[%d:%t %^] "%r" %s %b "%R" "%u"'</span> <span class="token operator">></span> index.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>go-accessæ˜¯ä»¥dockerå®¹å™¨çš„å½¢å¼è¿è¡Œçš„ï¼Œåªè¦ä½ å®‰è£…äº†dockerï¼Œå°±èƒ½ç›´æ¥è¿è¡Œï¼Œå…å®‰è£…å¾ˆæ–¹ä¾¿</p><p>ä»¥ä¸Šè„šæœ¬ï¼Œé…åˆæ—¥å¿—æ¯å¤©çš„æ—¥å¿—åˆ†å‰²ï¼Œç„¶ååœ¨crontabé‡Œé¢é…ç½®ä¸€ä¸‹è‡ªåŠ¨è¿è¡Œè„šæœ¬ï¼Œå¯ç”Ÿæˆæ¯ä¸€å¤©çš„nginxæŠ¥è¡¨ï¼Œç½‘ç«™æƒ…å†µä¸€å¹•äº†ç„¶ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå› ä¸ºä¸å®æ—¶</p><p>æƒ³è¦ç»Ÿè®¡å®æ—¶æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ngxtop æ¥æŸ¥çœ‹ï¼Œå®‰è£…èµ·æ¥ä¹Ÿå¾ˆç®€å•</p><blockquote><p>$ pip install ngxtop</p></blockquote><p>è¿è¡Œçš„è¯ï¼Œå…ˆè¿›åˆ°nginxç›®å½•ï¼Œç„¶åå†è¿è¡Œï¼Œ-c æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œ-t åˆ·æ–°é¢‘ç‡ï¼Œå•ä½ä¸ºç§’</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span> /usr/local/nginx$ ngxtop -c conf/nginx.conf -t <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½†æ˜¯è¿™ç§å®æ—¶çš„æ–¹å¼ï¼Œè¿˜éœ€è¦sshè¿œç¨‹ç™»å½•ï¼Œä¸å¤ªæ–¹ä¾¿ï¼Œè¿˜å¯ä»¥ä½¿ç”¨luaæ¥è¿›è¡Œå®æ—¶ç»Ÿè®¡ï¼Œç„¶åå†™ä¸€ä¸ªç•Œé¢æŠŠæ•°æ®å±•ç¤ºå‡ºæ¥ï¼Œé€šè¿‡lua-nginx-moduleï¼Œnginx/tengine éƒ½å¯ä»¥ç”¨ï¼Œå¦‚æœç›´æ¥å®‰è£…openrestyçš„è¯ï¼Œå°±æ–¹ä¾¿äº†ï¼Œå†…åµŒäº†luaï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘nginxäº†</p><h2 id="æ”¶è—ç¬”è®°"><a class="header-anchor" href="#æ”¶è—ç¬”è®°"></a>æ”¶è—ç¬”è®°</h2><p>æ—¥å¿—åˆ†æç°åœ¨ä¸»æµçš„æ–¹æ¡ˆæ˜¯é‡‡ç”¨ELK,ä½†æ˜¯è¿™ç¯‡æ–‡ç« ä½¿ç”¨<strong>awk</strong>è¿›è¡Œæ—¥å¿—åˆ†å‰²ä»¥åŠä¸€äº›å…¶ä»–çš„æ–‡æœ¬å¤„ç†æŠ€å·§ã€‚</p><ul><li>æ˜¾ç¤ºè¡Œå·</li></ul><blockquote><p>$ cat /usr/local/nginx/logs/access.log | wc -l</p></blockquote><ul><li><p>wc -l æ˜¾ç¤ºè¡Œå·<br><img src="https://s1.ax1x.com/2020/05/30/tQU9G8.png" alt="tQU9G8.png"></p></li><li><p>è·å–ç¬¬ä¸€åˆ—-æ’åº-å»é‡-è®¡æ•°<br>$ cat /usr/local/nginx/logs/access.log | awk â€˜{print $1}â€™ | sort -k1 -r | uniq | wc -l</p></li><li><p>awk â€˜{print $1}â€™ è¾“å‡ºç¬¬ä¸€åˆ—<br><img src="https://s1.ax1x.com/2020/05/30/tQwGZj.png" alt="tQwGZj.png"></p></li><li><p>sort -k1 -r<br><img src="https://s1.ax1x.com/2020/05/30/tQwRW6.png" alt="tQwRW6.png"></p></li></ul><blockquote><p>k 1è¡¨ç¤ºä»¥ç¬¬ä¸€åˆ—ä½œä¸ºæ’åº<br>r è¡¨ç¤ºå€’åº</p></blockquote><ul><li><p>uniq å»é‡<br><img src="https://s1.ax1x.com/2020/05/30/tQ0JXD.png" alt="tQ0JXD.png"></p></li><li><p>awk â€˜{print $1,$2,$NF}â€™<br><img src="https://s1.ax1x.com/2020/05/30/tQ0j41.png" alt="tQ0j41.png"><br>è¡¨ç¤ºæ‰“å°ç¬¬ä¸€åˆ—å’Œç¬¬äºŒåˆ—ä»¥åŠæœ€åä¸€åˆ—(<strong>$NF</strong>)</p></li><li><p>head -5<br>è¡¨ç¤ºå–å‰äº”æ¡</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ–‡ç« æ”¶è— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> awk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°</title>
      <link href="2020/05/29/13.LeetCode/4.%E5%AF%BB%E6%89%BE%E4%B8%A4%E4%B8%AA%E6%AD%A3%E5%BA%8F%E6%95%B0%E7%BB%84%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0_LeetCode05/"/>
      <url>2020/05/29/13.LeetCode/4.%E5%AF%BB%E6%89%BE%E4%B8%A4%E4%B8%AA%E6%AD%A3%E5%BA%8F%E6%95%B0%E7%BB%84%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0_LeetCode05/</url>
      
        <content type="html"><![CDATA[<h1>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>ç»™å®šä¸¤ä¸ªå¤§å°ä¸º m å’Œ n çš„æ­£åºï¼ˆä»å°åˆ°å¤§ï¼‰æ•°ç»„Â nums1 å’ŒÂ nums2ã€‚<br>è¯·ä½ æ‰¾å‡ºè¿™ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°ï¼Œå¹¶ä¸”è¦æ±‚ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºÂ O(log(m + n))ã€‚</p><ul><li>ç¤ºä¾‹ 1:</li></ul><pre class="line-numbers language-none"><code class="language-none">nums1 &#x3D; [1, 3]nums2 &#x3D; [2]åˆ™ä¸­ä½æ•°æ˜¯ 2.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>ç¤ºä¾‹ 2:</li></ul><pre class="line-numbers language-none"><code class="language-none">nums1 &#x3D; [1, 2]nums2 &#x3D; [3, 4]åˆ™ä¸­ä½æ•°æ˜¯ (2 + 3)&#x2F;2 &#x3D; 2.5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ"></a>åˆ†æ</h2><p>æœ€å¼€å§‹æˆ‘çš„æƒ³æ³•æ˜¯åˆ©ç”¨TreeMapæ¥å®ç°æ•°ç»„æœ‰åºï¼Œå¾—åˆ°æœ‰åºæ•°ç»„ä¹‹åå¯ä»¥è·å–åˆ°ä¸­ä½æ•°ã€‚ä½†æ˜¯TreeMapçš„åº•å±‚æ˜¯k-vç»“æ„å¯¼è‡´ä¸èƒ½ä¿å­˜é‡å¤çš„å…ƒç´ ã€‚</p><p>æ ¹æ®å®˜æ–¹çš„è§£é¢˜æ€è·¯é‡‡ç”¨çš„æ˜¯å…ˆç®—å‡ºä¸¤ä¸ªæ•°ç»„çš„é•¿åº¦ç„¶åå¾—åˆ°åˆå¹¶åçš„æ•°ç»„é•¿åº¦ï¼Œç„¶åæ ¹æ®åˆå¹¶åæ•°ç»„çš„é•¿åº¦å¯ä»¥å¾—åˆ°ä¸­ä½æ•°çš„ä½ç½®indexã€‚ç„¶åéå†ä¸¤ä¸ªæ•°ç»„å¾—åˆ°ä¸­ä½æ•°çš„å€¼ã€‚</p><h2 id="ä»£ç "><a class="header-anchor" href="#ä»£ç "></a>ä»£ç </h2>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¢†åŸŸé©±åŠ¨è®¾è®¡_2</title>
      <link href="2020/05/28/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1-2/"/>
      <url>2020/05/28/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1-2/</url>
      
        <content type="html"><![CDATA[<h1>é¢†åŸŸé©±åŠ¨è®¾è®¡å…¥é—¨æµç¨‹</h1><p>ä¸»è¦æ˜¯ä»å›´ç»•ç»„ç»‡çš„ä¸šåŠ¡æ¨¡å‹å®šä½åˆ°ç¼–ç åŸŸæ¨¡å‹çš„è¿‡ç¨‹ã€‚</p><h2 id="åŸºç¡€æµç¨‹"><a class="header-anchor" href="#åŸºç¡€æµç¨‹"></a>åŸºç¡€æµç¨‹</h2><ul><li>å¯¹é½ï¼šä¸šåŠ¡æ¨¡å‹å¯¹é½éœ€æ±‚</li><li>å‘ç°ï¼šå¯¹é¢†åŸŸå®ç°å¯è§†åŒ–å’Œåä½œ</li><li>è§£è€¦ï¼šå°†é¢†åŸŸåˆ†ä¸ºå­åŸŸ</li><li>è¿æ¥ï¼šå°†å­åŸŸå½¢æˆä¸ºä¸€ç§æ¾è€¦åˆæ¶æ„</li><li>æˆ˜ç•¥ï¼šä¸“æ”»ä¸šåŠ¡å·®å¼‚åŒ–çš„æ ¸å¿ƒå­åŸŸ</li><li>ç»„ç»‡ï¼šæŒ‰ç…§æœ‰ç•Œä¸Šä¸‹æ–‡ç»„ç»‡å›¢é˜Ÿ</li><li>å®šä¹‰ï¼šå®šä¹‰æ¯ä¸ªæœ‰ç•Œä¸Šä¸‹æ–‡çš„è§’è‰²å’ŒèŒè´£</li><li>ç¼–ç ï¼šä½¿ç”¨æˆ˜æœ¯æ¨¡å¼å®ç°æœ‰ç•Œä¸Šä¸‹æ–‡</li></ul><h2 id="åŸºç¡€åˆ’åˆ†"><a class="header-anchor" href="#åŸºç¡€åˆ’åˆ†"></a>åŸºç¡€åˆ’åˆ†</h2><p>é¢†åŸŸé©±åŠ¨è®¾è®¡å°†è½¯ä»¶ç³»ç»Ÿçš„è®¾è®¡åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæˆ˜ç•¥è®¾è®¡å’Œæˆ˜æœ¯è®¾è®¡ã€‚åœ¨æˆ˜ç•¥è®¾è®¡å±‚é¢æå‡ºåŸŸã€å­åŸŸã€é™ç•Œä¸Šä¸‹æ–‡ç­‰æ¦‚å¿µ;åœ¨æˆ˜æœ¯è®¾è®¡å±‚<br>é¢æå‡ºäº†å®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡ã€é¢†åŸŸäº‹ä»¶ã€èšåˆã€å·¥å‚ã€èµ„æºç­‰é‡è¦æ¦‚å¿µ</p><p>æˆ˜ç•¥è®¾è®¡éƒ¨åˆ†æŒ‡å¯¼æˆ‘ä»¬å¦‚ä½•æŒ‰ç…§é¢†åŸŸé©±åŠ¨çš„æ¨¡å‹å°†ä¸€ä¸ªå¤æ‚ç³»ç»Ÿè¿›è¡Œæ‹†åˆ†ï¼›æˆ˜æœ¯è®¾è®¡éƒ¨åˆ†æŒ‡å¯¼æˆ‘ä»¬å°†æ‹†åˆ†å‡ºæ¥çš„æ¨¡å—è½åœ°ä»¥åŠè½åœ°è¿‡ç¨‹<br>ä¸­åº”éµå¾ªçš„åŸåˆ™ã€‚</p><p>é¢†åŸŸé©±åŠ¨è®¾è®¡åœ¨å¾®æœåŠ¡æ—¶ä»£å¤§è¡Œå…¶é“çš„ä¸»è¦åŸå› æ˜¯å› ä¸ºé¢†åŸŸè®¾è®¡çš„æˆ˜ç•¥éƒ¨åˆ†å°†å°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸åŒçš„â€™åŸŸâ€™ï¼Œè¿™ä¸å¾®æœåŠ¡æ¶æ„ä½“ç³»ä¸­å°†ä¸€ä¸ª<br>å•ä½“åº”ç”¨æ‹†åˆ†ä¸ºä¸åŒçš„å¾®æœåŠ¡è§£å†³çš„æ˜¯åŒä¸€ä¸ªé—®é¢˜ã€‚<br>'åŸŸâ€™è§£å†³çš„æ˜¯ç©ºé—´é—®é¢˜;é™å®šä¸Šä¸‹æ–‡è§£å†³çš„æ˜¯è§£å†³ç©ºé—´æ–¹æ¡ˆ(ps:å¯ä»¥å°†åŸŸç†è§£æˆä¸ºä¸€ä¸ªå…·ä½“çš„è½¦é—´ï¼Œé™å®šä¸Šä¸‹æ–‡å¯ä»¥ç†è§£ä¸ºè½¦é—´ä¸­è¿›è¡ŒæŸ<br>ä¸€æ­¥ç”Ÿäº§æ´»åŠ¨çš„ç”Ÿäº§èµ„æ–™)</p><h2 id="ä¼ ç»Ÿçš„åˆ†å±‚æ¶æ„"><a class="header-anchor" href="#ä¼ ç»Ÿçš„åˆ†å±‚æ¶æ„"></a>ä¼ ç»Ÿçš„åˆ†å±‚æ¶æ„</h2><hr><h2 id="ç»ˆç«¯æ˜¾ç¤ºå±‚-å¼€æ”¾æ¥å£"><a class="header-anchor" href="#ç»ˆç«¯æ˜¾ç¤ºå±‚-å¼€æ”¾æ¥å£"></a>|  ç»ˆç«¯æ˜¾ç¤ºå±‚  | å¼€æ”¾æ¥å£ |</h2><table><thead><tr><th>webå±‚</th></tr></thead><tbody><tr><td>service</td></tr></tbody></table><hr><pre><code>           |  managerå±‚</code></pre><hr><table><thead><tr><th>DAOå±‚</th></tr></thead><tbody><tr><td>DB</td></tr></tbody></table><p>åœ¨ä¼ ç»Ÿåˆ†å±‚æ¶æ„ä¸­</p><ul><li><p>serviceå±‚<br>ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚:æ‰¿æ‹…çš„æ˜¯å…·ä½“çš„ä¸šåŠ¡é€»è¾‘æœåŠ¡</p></li><li><p>managerå±‚<br>é€šç”¨ä¸šåŠ¡å¤„ç†å±‚,æ‰¿æ‹…çš„æ˜¯</p></li><li><p>å¯¹ç¬¬ä¸‰æ–¹æ¥å£è¿›è¡Œå°è£…,é¢„å¤„ç†è¿”å›ç»“æœåŠè½¬æ¢å¼‚å¸¸ä¿¡æ¯</p></li><li><p>å¯¹serviceå±‚ä¸­çš„é€šç”¨èƒ½åŠ›çš„ä¸‹æ²‰(ps:ä¹Ÿå°±æ˜¯è¯´å°†é€šç”¨çš„serviceä¸­çš„èƒ½åŠ›ä¸‹æ²‰åˆ°managerå±‚)</p></li><li><p>ä¸DAOå±‚çš„å°è£…,å¯¹DAOå±‚çš„ç»„åˆå¤ç”¨(ps:å¯ä»¥å°†äº‹åŠ¡æ”¾åˆ°managerå±‚æ¥æ§åˆ¶)</p></li></ul><p>ç¼ºé™·æˆ–ä¸è¶³ï¼š</p><ol><li>serviceå±‚å’Œmanagerå±‚åœ¨å®é™…å¼€å‘ä¸­æ²¡æœ‰æ˜æ˜¾çš„ç‰¹å¾ï¼Œå®¹æ˜“å°†managerå±‚æ¼”åŒ–æˆä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¸šåŠ¡å±æ€§æ·¡åŒ–çš„serviceå±‚</li></ol><p>æ ¹æ®å…­è¾¹å½¢æ¶æ„çš„æŒ‡å¯¼æ€æƒ³ï¼Œå°†ä¸€ä¸ªå®é™…çš„åº”ç”¨åˆ’åˆ†ä¸ºå››å±‚ï¼š<br>1.ç”¨æˆ·æ¥å£å±‚ï¼šè´Ÿè´£ç”¨æˆ·å±•ç°ç›¸å…³çš„é€»è¾‘<br>2.åº”ç”¨å±‚ï¼šå°†ä¸€ä¸ªç”¨ä¾‹è¿›è¡Œæµç¨‹ç¼–æ’(å°†æ¥å£ç”¨ä¾‹åˆ†æˆè‹¥å¹²æ­¥éª¤ï¼Œä½†æ˜¯ä¸è´Ÿè´£æ¯æ­¥çš„å…·ä½“å®æ–½)(ps:å®šä¹‰æµç¨‹æ¥å£)<br>3.é¢†åŸŸå±‚ï¼šè´Ÿè´£å®ç°æ ¸å¿ƒçš„é¢†åŸŸé€»è¾‘(ä¸šåŠ¡é€»è¾‘)<br>4.åŸºç¡€è®¾æ–½å±‚ï¼šæ‰€ä»¥ä¾èµ–çš„å…·ä½“å®ç°</p><p>å€’ç½®çš„åˆ†å±‚æ¶æ„</p><h2 id="é¢†åŸŸæ¨¡å‹çš„ç‰¹å®š"><a class="header-anchor" href="#é¢†åŸŸæ¨¡å‹çš„ç‰¹å®š"></a>é¢†åŸŸæ¨¡å‹çš„ç‰¹å®š</h2><ol><li>å¯¹ä¸šåŠ¡é¢†åŸŸè¿›è¡Œå»ºæ¨¡</li></ol><ul><li>ç»†ç²’åº¦çš„ç±»ï¼Œæ˜“äºæ‰©å±•å’Œå¤ç”¨</li><li>å¯åº”å¯¹å¤æ‚çš„ä¸šåŠ¡é€»è¾‘</li><li>éœ€è¦ç»éªŒæ‰èƒ½æŒæ¡</li></ul><ol start="2"><li>ç®€å•é¢†åŸŸæ¨¡å‹<ul><li>å‡ ä¹å’Œæ•°æ®åº“å®ä½“ä¸€ä¸€å¯¹åº”</li></ul></li><li>å¤æ‚é¢†åŸŸæ¨¡å‹</li></ol><ul><li>ä½¿ç”¨ç»§æ‰¿ã€ç»„åˆã€è®¾è®¡æ¨¡å¼å„ç§æ‰‹æ®µ</li></ul><blockquote><p>åœ¨æ•´ä¸ªè½¯ä»¶å¼€å‘çš„å‘¨æœŸä¸­å°½é‡ä½¿ç”¨é¢†åŸŸåç§°æ¥è¿›è¡Œæ²Ÿé€šã€åœ¨ä»£ç ä¸­å°½é‡è®©å‘½åè´´è¿‘äºé¢†åŸŸå¯¹è±¡ã€‚</p></blockquote><h2 id="DDDåˆ†å±‚æ¶æ„"><a class="header-anchor" href="#DDDåˆ†å±‚æ¶æ„"></a>DDDåˆ†å±‚æ¶æ„</h2><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>ç”¨æˆ·ç•Œé¢/å±•ç¤ºå±‚</td><td>è´Ÿè´£å‘ç”¨æˆ·å±•ç°ä¿¡æ¯ä»¥åŠè§£é‡Šç”¨æˆ·å‘½ä»¤</td></tr><tr><td>åº”ç”¨å±‚</td><td>å¾ˆè–„çš„ä¸€å±‚ï¼Œç”¨æ¥åè°ƒåº”ç”¨çš„æ´»åŠ¨ã€‚ä¸åŒ…å«ä¸šåŠ¡ä»£ç é€»è¾‘ï¼Œä¸ä¿ç•™ä¸šåŠ¡å¯¹è±¡çŠ¶æ€ï¼Œä½†åº”ä¿ç•™åº”ç”¨ä»»åŠ¡è¿›åº¦çŠ¶æ€</td></tr><tr><td>é¢†åŸŸå±‚</td><td>æœ¬å±‚åŒ…å«å…³äºé¢†åŸŸçš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ˜¯ä¸šåŠ¡è½¯ä»¶çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œåœ¨è¿™é‡Œä¿ç•™ä¸šåŠ¡å¯¹è±¡çš„çŠ¶æ€å’Œè¡Œä¸ºã€‚</td></tr><tr><td>åŸºç¡€è®¾æ–½å±‚</td><td>ä½œä¸ºåº•å±‚åŸºç¡€å±‚ï¼Œæä¾›å…¶ä»–å±‚çš„åŸºç¡€åŠŸèƒ½ï¼Œä¾‹å¦‚æŒä¹…åŒ–ã€é€šç”¨åŠŸèƒ½ç­‰</td></tr></tbody></table><h3 id="é¢†åŸŸå±‚"><a class="header-anchor" href="#é¢†åŸŸå±‚"></a>é¢†åŸŸå±‚</h3><ul><li><p>å®ä½“</p><ol><li>å¯¹è±¡ä¸æ˜¯ç”±å±æ€§å®šä¹‰çš„ï¼Œè€Œå€¼æ ‡è¯†å®šä¹‰çš„</li><li>å¯¹è±¡å†…å®¹çš„å˜åŒ–ä¸ä¼šå½±å“æ ‡å¿—ç¬¦(ps:å¯ä»¥ç†è§£ä¸ºå¯¹è±¡å†…å®¹çš„å˜åŒ–æœ¬èº«å°±æ˜¯å¯¹è±¡çš„ä¸€ç§åˆç†è¡Œä¸º)</li><li>æŒä¹…åŒ–ä¸ä¼šå½±å“æ ‡å¿—</li><li>å®ä½“å±æ€§çš„é€‰æ‹©</li></ol><blockquote><p>å®ä½“å¯¹è±¡å±æ€§åº”æ˜¯æ ‡è¯†ã€æŸ¥æ‰¾ã€åŒ¹é…å¯¹è±¡çš„æœ€åŸºæœ¬ç‰¹å¾;åªæ·»åŠ å“ªäº›å¯¹å®ä½“è¿™ä¸ªæ¦‚å¿µè‡³å…³é‡è¦çš„__è¡Œä¸º__å’Œ__å±æ€§__</p></blockquote></li><li><p>å€¼æ ‡è¯†(å¯ä»¥ç†è§£ä¸ºid)</p><ol><li>å¯¹è±¡æ˜¯æ ¹æ®å€¼æ¥ç¡®å®šçš„</li><li>å¯ä»¥åœ¨ä¸åŒçš„å®ä½“ä¸­ä½¿ç”¨</li><li>å€¼å¯¹è±¡é€šå¸¸æ˜¯ä¸å¯å˜çš„</li></ol></li><li><p>é¢†åŸŸæœåŠ¡</p><ol><li>é¢†åŸŸæœåŠ¡æŒ‡çš„æ˜¯å°±æ˜¯å®ä½“çš„æŸç§è¡Œä¸º</li></ol></li><li><p>ç‰¹å¾</p><ol><li>æœåŠ¡æ‰§è¡Œçš„æ“ä½œæ¶‰åŠä¸€ä¸ªé¢†åŸŸæ¦‚å¿µï¼Œè¿™ä¸ªæ¦‚å¿µé€šå¸¸ä¸å±äºä¸€ä¸ªå®ä½“æˆ–å¯¹è±¡</li><li>è¢«æ‰§è¡Œçš„æ“ä½œæ¶‰åŠåˆ°é¢†åŸŸä¸­çš„å…¶ä»–å¯¹è±¡</li><li>æ“ä½œæ˜¯æ— çŠ¶æ€çš„</li></ol></li><li><p>èšåˆçš„ç‰¹å®š</p><ol><li>æ ¹å¯¹è±¡å…·æœ‰å€¼æ ‡è¯†</li><li>å¤–éƒ¨å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨æ ¹å¯¹è±¡çš„å†…éƒ¨å¼•ç”¨å¯¹è±¡</li></ol><blockquote><p>èšåˆçš„å®šä¹‰æœ‰ç‚¹åƒæ˜¯é—¨é¢æ¨¡å¼ï¼Œå°†å†…éƒ¨åŠŸèƒ½å°è£…èµ·æ¥</p></blockquote></li></ul><h2 id="é¢†åŸŸå¯¹è±¡çš„ç®¡ç†"><a class="header-anchor" href="#é¢†åŸŸå¯¹è±¡çš„ç®¡ç†"></a>é¢†åŸŸå¯¹è±¡çš„ç®¡ç†</h2><blockquote><p>åˆ›å»ºç®¡ç†é¢†åŸŸå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€ä¸ªå¤æ‚ä¸”æ•æ„Ÿçš„åŠŸèƒ½ï¼Œä»‹ç»3ä¸ªæ¨¡å¼æ¥è¿›è¡Œåˆ†è§£</p></blockquote><p><strong>èšåˆæ¨¡å¼</strong></p><ul><li>èšåˆæ˜¯ä¸€ä¸ªç”¨æ¥å®šä¹‰å¯¹è±¡__æ‰€æœ‰æƒ__å’Œ__è¾¹ç•Œ__çš„é¢†åŸŸæ¨¡å¼ã€‚å·¥å‚å’Œèµ„æºåº“æ˜¯å¦å¤–çš„ä¸¤ä¸ªè®¾è®¡æ¨¡å¼ï¼Œç”¨æ¥å¸®åŠ©æˆ‘ä»¬å¤„ç†å¯¹è±¡çš„åˆ›å»ºå’Œå­˜å‚¨é—®é¢˜</li></ul><p>ç”±äºæ¨¡å‹é—´çš„ç›¸äº’å…³ç³»ä¾èµ–ï¼Œå¯¼è‡´å®ä¾‹ä¸å®ä¾‹å­˜åœ¨ç›¸äº’å¼•ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¾ˆéš¾æ¢³ç†æ¸…æ¥šä¸€ä¸ªé¢†åŸŸå¯¹è±¡çš„å…³ç³»ã€‚<br>ä»€ä¹ˆæ˜¯èšåˆæ¨¡å¼ï¼Ÿ</p><blockquote><p>é€šè¿‡ä¸€ä¸ªå®ä½“æ ¹å¯¹è±¡æŒæœ‰èšåˆå¯¹è±¡çš„å¼•ç”¨ï¼Œèšåˆå¯¹è±¡ä¹‹é—´å¯ä»¥ç›¸äº’ä¾èµ–ã€‚å¯¹å¤–åªæš´éœ²å®ä½“æ ¹å¯¹è±¡ï¼Œå½¢æˆä»¥å®ä½“æ ¹å¯¹è±¡ä¸ºæ ¸å¿ƒå†…èšçš„é¢†åŸŸå¯¹è±¡</p></blockquote><p>èšåˆæ˜¯å¦‚ä½•ä¿æŒæ•°æ®ä¸€è‡´æ€§å’Œå¼ºåŒ–ä¸å˜é‡çš„å‘¢ï¼Ÿ</p><blockquote><p>å› ä¸ºå…¶ä»–å¯¹è±¡åªèƒ½æŒæœ‰å¯¹æ ¹å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸èƒ½ç›´æ¥å˜æ›´èšåˆå†…çš„å…¶ä»–çš„å¯¹è±¡ã€‚å®ƒä»¬æ‰€èƒ½åšçš„å°±æ˜¯å¯¹æ ¹åšå˜æ›´ï¼Œæˆ–è€…è®©è¯·æ±‚æ ¹æ¥æ‰§è¡ŒæŸäº›åŠ¨ä½œ</p></blockquote><p><strong>å·¥å‚æ¨¡å¼</strong></p><blockquote><p>é¢†åŸŸæ¨¡å¼ä¸­é‡ç‚¹å¼ºè°ƒä½¿ç”¨å·¥å‚æ¨¡å¼æ¥åˆ›å»ºå¤æ‚å¯¹è±¡</p></blockquote><ul><li>å·¥å‚è¢«ç”¨æ¥å°è£…å¯¹è±¡åˆ›å»ºæ‰€å¿…éœ€çš„çŸ¥è¯†ï¼Œå®ƒä»¬å¯¹åˆ›å»ºèšåˆç‰¹åˆ«æœ‰ç”¨ã€‚å½“èšåˆçš„æ ¹è¢«åˆ›å»ºåï¼Œæ‰€æœ‰èšåˆåŒ…å«çš„å¯¹è±¡å°†éšä¹‹åˆ›å»ºï¼Œæ‰€æœ‰çš„ä¸å˜é‡å¾—åˆ°äº†å¼ºåŒ–ã€‚</li></ul><p>å› æ­¤ï¼Œä¸ºå¤æ‚å¯¹è±¡å’Œèšåˆåˆ›å»ºå®ä¾‹çš„èŒè´£ï¼Œåº”è¯¥è½¬äº¤ç»™ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ã€‚è™½ç„¶è¿™ä¸ªå¯¹è±¡æœ¬èº«åœ¨é¢†åŸŸæ¨¡å‹ä¸­æ²¡æœ‰èŒè´£ï¼Œä½†å®ƒä»æ˜¯é¢†åŸŸè®¾è®¡çš„ä¸€éƒ¨åˆ†ã€‚æä¾›ä¸€ä¸ªæ¥å£æ¥å°è£…æ‰€æœ‰å¤æ‚çš„ç»„è£…è¿‡ç¨‹ï¼Œå®¢æˆ·ä¸éœ€è¦å¼•ç”¨æ­£åœ¨åˆå§‹åŒ–çš„å¯¹è±¡æ‰€å¯¹åº”çš„å…·ä½“ç±»ã€‚å°†æ•´ä¸ªèšåˆå½“ä½œä¸€ä¸ªå•å…ƒæ¥åˆ›å»ºï¼Œå¼ºåŒ–å®ƒä»¬çš„ä¸å˜é‡ã€‚</p><p>ä¸€ä¸ªèšåˆåŒ…å«äº†ä¸€ç³»åˆ—å¯†åˆ‡ç›¸å…³çš„å¯¹è±¡ã€‚æ ¹çš„æ„å»ºä¸èšåˆå†…çš„å…¶ä»–å¯¹è±¡çš„åˆ›å»ºæ˜¯ç›¸å…³çš„ã€‚ä¼šæœ‰ä¸€äº›é€»è¾‘ä¸€åŒæ”¾åˆ°èšåˆä¸­ï¼Œè¿™äº›é€»è¾‘å¹¶ä¸å¤©ç„¶å±äºä»»ä½•ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºå®ƒæ€»æ˜¯è·Ÿå…¶ä»–å¯¹è±¡çš„æ„å»ºæœ‰å…³ã€‚çœ‹èµ·æ¥æ¯”è¾ƒåˆé€‚çš„åšæ³•æ˜¯ï¼Œä½¿ç”¨ä¸€ä¸ªä¸“ç”¨çš„å·¥å‚ç±»æ¥è´Ÿè´£åˆ›å»ºæ•´ä¸ªèšåˆï¼Œåœ¨è¿™ä¸ªå·¥å‚ç±»ä¸­å°†åŒ…å«åº”è¯¥ä¸ºèšåˆå¼ºåŒ–çš„è§„åˆ™ã€çº¦æŸå’Œä¸å˜é‡ã€‚è¿™ä¸ªå¯¹è±¡ä¼šä¿æŒç®€å•ï¼Œå¹¶å°†å®Œæˆç‰¹å®šçš„ç›®çš„ï¼Œä¸ä¼šä½¿å¤æ‚çš„æ„å»ºé€»è¾‘æ··ä¹±ä¸å ªã€‚</p><p>ps:ä¹Ÿå°±æ˜¯æœ‰å¯¹è±¡åˆ›å»ºå·¥å‚æ¥ä¸“é—¨è´Ÿè´£èšåˆå¯¹è±¡çš„åˆ›å»ºå·¥ä½œï¼Œå°†å¯¹è±¡çš„èšåˆå…³ç³»çš„åˆ›å»ºå…¨éƒ¨æ”¾åˆ°å¯¹è±¡åˆ›å»ºå·¥å‚ä¸­å»</p><p>ä¸ä½¿ç”¨å·¥å‚ä½¿ç”¨å®ä½“æ„é€ å™¨çš„æ¡ä»¶</p><ol><li>æ„é€ è¿‡ç¨‹å¹¶ä¸å¤æ‚ã€‚</li><li>ä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºä¸æ¶‰åŠåˆ°å…¶ä»–å¯¹è±¡çš„åˆ›å»ºï¼Œå¯ä»¥å°†æ‰€æœ‰éœ€è¦çš„å±æ€§ä¼ é€’ç»™æ„<br>é€ å™¨</li><li>å®¢æˆ·å¯¹å®ç°å¾ˆæ„Ÿå…´è¶£ï¼Œå¯èƒ½å¸Œæœ›é€‰æ‹©ä½¿ç”¨ç­–ç•¥ï¼ˆStrategyï¼‰æ¨¡å¼ã€‚</li><li>ç±»æ˜¯ç‰¹å®šçš„ç±»å‹ï¼Œä¸å­˜åœ¨åˆ°å±‚çº§ï¼Œæ‰€ä»¥ä¸ç”¨åœ¨ä¸€ç³»åˆ—çš„å…·ä½“å®ç°ä¸­è¿›è¡Œé€‰<br>æ‹©ã€‚</li></ol><p>ç¬¬ä¸‰ç‚¹ï¼Œå®¢æˆ·ç«¯å¯¹å®ä½“çš„åˆ›å»ºå¾ˆæ„Ÿå…´è¶£ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹è±¡çš„åˆ›å»ºéå¸¸ä¾èµ–äºå®¢æˆ·ç«¯çš„è¡Œä¸ºï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€‚å·¥å‚ä¹Ÿå¯ä»¥è¾¾åˆ°è¿™æ ·çš„æ•ˆæœï¼Œä½†æ˜¯éœ€è¦æœ‰æ ‡è¯†ç¬¦ä¼ å…¥</p><p><strong>èµ„æºåº“</strong></p><blockquote><p>èµ„æºåº“ï¼šè®¿é—®å®ä½“çš„å·¥å…·ï¼Œä½äºé¢†åŸŸå±‚å’ŒåŸºç¡€å®æ–½å±‚ä¹‹é—´ã€‚ä½œç”¨æ˜¯é€šè¿‡åŸºç¡€è®¾æ–½å±‚çš„å·¥å…·å…ˆé¢†åŸŸå±‚è¾“å‡ºå®ä½“å¯¹è±¡ã€‚</p></blockquote><p>èµ„æºåº“ä¸å·¥å‚çš„åŒºåˆ«ï¼šèµ„æºåº“å…³æ³¨çš„æ˜¯å¦‚ä½•å°†å·²å­˜åœ¨çš„å®ä½“é‡æ–°è½½å…¥åˆ°é¢†åŸŸå±‚ä¸­ï¼›å·¥å‚å…³å¿ƒçš„æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä½“å¯¹è±¡ã€‚ä¸¤è€…ä¸€ä¸ªå…³æ³¨çš„æ˜¯å·²æœ‰å¯¹è±¡ä¸€ä¸ªå…³æ³¨çš„æ˜¯å¦‚ä½•åˆ›å»ºæ–°å¯¹è±¡ã€‚</p><h3 id="é¢å‘æ·±å±‚ç†è§£çš„é‡æ„"><a class="header-anchor" href="#é¢å‘æ·±å±‚ç†è§£çš„é‡æ„"></a>é¢å‘æ·±å±‚ç†è§£çš„é‡æ„</h3><ol><li>æŒç»­é‡æ„</li><li>å…³æ³¨æ ¸å¿ƒæ¨¡å‹</li></ol><h3 id="æ¨¡å‹çš„ä¸€è‡´æ€§"><a class="header-anchor" href="#æ¨¡å‹çš„ä¸€è‡´æ€§"></a>æ¨¡å‹çš„ä¸€è‡´æ€§</h3><ol><li>è¾¹ç•Œä¸Šä¸‹æ–‡</li><li>æŒç»­é›†æˆ</li><li>ä¸Šä¸‹æ–‡æ˜ å°„</li><li>å…±äº«å†…æ ¸</li><li>å®¢æˆ·-ä¾›åº”å•†</li><li>é¡ºä»è€…</li><li>é˜²å´©æºƒå±‚</li><li>éš”ç¦»é€šé“</li><li>å¼€å‘ä¸»æœºæœåŠ¡</li><li>æç‚¼</li></ol>]]></content>
      
      
      <categories>
          
          <category> é¢†åŸŸé©±åŠ¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¢†åŸŸé©±åŠ¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¢†åŸŸé©±åŠ¨è®¾è®¡(ç®€ä»‹)</title>
      <link href="2020/05/28/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1-1/"/>
      <url>2020/05/28/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1-1/</url>
      
        <content type="html"><![CDATA[<h1>é¢†åŸŸé©±åŠ¨è®¾è®¡(ç®€ä»‹)</h1><p>åœ¨å¾®æœåŠ¡ä¸‹æ ¹æ®ä¸åŒä¸šåŠ¡è¿›è¡Œåˆ’åˆ†ä»è€Œäº§ç”Ÿä¸“æ³¨æœåŠ¡äºç‰¹å®šä¸šåŠ¡çš„ä¸åŒç³»ç»Ÿã€‚ä¸åŒç³»ç»Ÿä¹‹é—´ç›¸äº’é…åˆä»è€Œå®Œæˆæ•´ä½“ä¸šåŠ¡åŠŸèƒ½ã€‚åœ¨æ ¹æ®ä¸šåŠ¡è¿›è¡Œåˆ’åˆ†æ—¶å€™ï¼Œç›®å‰æˆ‘ä»¬å¤§éƒ¨åˆ†äººé‡‡ç”¨çš„æ˜¯æ•°æ®æ¨¡å‹é©±åŠ¨å¼€å‘çš„æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ä¸šåŠ¡å’Œæ•°æ®ä¹‹é—´çš„æµè½¬å…¶å®æ˜¯é€šè¿‡bizå±‚å¤„ç†çš„ã€‚è¿™æ ·çš„æ¨¡å‹ç»“æ„å°†ä¸šåŠ¡çš„æµè½¬æ”¾åˆ°äº†bizå±‚ä¸­å’Œç³»ç»Ÿè¿›è¡Œå¼ºè€¦åˆï¼Œç„¶è€Œåœ¨ç°å®ç”Ÿæ´»ä¸­ä¸šåŠ¡çš„ä¸ç¡®å®šæ€§å’Œæ˜“å˜æ€§å¯¼è‡´æˆ‘ä»¬éœ€è¦ä¸æ–­çš„ä¿®æ”¹æ•°æ®æ¨¡å‹å’Œbizå±‚ã€‚ä¸€æ®µæ—¶é—´è¿­ä»£åbizå±‚å’Œæ•°æ®æ¨¡å‹é€šè¿‡ä¸åŒçš„éœ€æ±‚è¿­ä»£å¯¼è‡´å¿…é¡»è¦é€šè¿‡åŠŸèƒ½å»æŸ¥çœ‹ä»£ç ä»è€Œè¿˜åŸä¸šåŠ¡ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œé¢†åŸŸé©±åŠ¨è¿™ç§æ–¹å¼å°±å¾ˆé€‚åˆç°åœ¨çš„å¼€å‘æµç¨‹ã€‚ä»¥ä¸‹å¤§éƒ¨åˆ†æ˜¯æ ¹æ®www.jdon.comä¸­çš„ä¸€ç³»åˆ—é¢†åŸŸé©±åŠ¨è®¾è®¡çš„æ–‡ç« æ²‰æ·€ä¸‹æ¥ã€‚<a href="http://xn--jdon-u74hg61t.com">æ„Ÿè°¢jdon.com</a></p><h2 id="é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>é¢†åŸŸé©±åŠ¨è®¾è®¡æ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote><p>é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆè‹±è¯­ï¼šDomain-driven designï¼Œç¼©å†™ DDDï¼‰æ˜¯ä¸€ç§é€šè¿‡å°†å®ç°è¿æ¥åˆ°æŒç»­è¿›åŒ–çš„æ¨¡å‹æ¥æ»¡è¶³å¤æ‚éœ€æ±‚çš„è½¯ä»¶å¼€å‘æ–¹æ³•ã€‚</p></blockquote><p>é¢†åŸŸé©±åŠ¨è®¾è®¡çš„å‰ææ˜¯ï¼š</p><ol><li>æŠŠé¡¹ç›®çš„ä¸»è¦é‡ç‚¹æ”¾åœ¨æ ¸å¿ƒé¢†åŸŸï¼ˆcore domainï¼‰å’ŒåŸŸé€»è¾‘;</li><li>æŠŠå¤æ‚çš„è®¾è®¡æ”¾åœ¨æœ‰ç•ŒåŸŸï¼ˆbounded contextï¼‰çš„æ¨¡å‹ä¸Š;</li><li>å‘èµ·ä¸€ä¸ªåˆ›é€ æ€§çš„åˆä½œä¹‹é—´çš„æŠ€æœ¯å’ŒåŸŸç•Œä¸“å®¶ä»¥è¿­ä»£åœ°å®Œå–„çš„æ¦‚å¿µæ¨¡å¼ï¼Œè§£å†³ç‰¹å®šé¢†åŸŸçš„é—®é¢˜</li></ol><h2 id="é¢†åŸŸé©±åŠ¨è®¾è®¡çš„ç”±æ¥"><a class="header-anchor" href="#é¢†åŸŸé©±åŠ¨è®¾è®¡çš„ç”±æ¥"></a>é¢†åŸŸé©±åŠ¨è®¾è®¡çš„ç”±æ¥</h2><p>æœåŠ¡å™¨åç«¯æ¶æ„å‘å±•ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>UI+DataBaseçš„ä¸¤å±‚æ¶æ„</li><li>UI+Service+DataBaseçš„å¤šå±‚SOAæ¶æ„</li><li>DDD+SOAæœåŠ¡çš„äº‹ä»¶é©±åŠ¨æ¶æ„<br>æ¶æ„çš„å‡çº§æ˜¯ç”±äºå¯¹åç«¯æŠ€æœ¯çš„éœ€æ±‚å€’é€¼å¯¼è‡´çš„ï¼Œä»æœ€å¼€å§‹çš„é™æ€ç½‘ç«™åˆ°AjaxæŠ€æœ¯ä¸ºä»£å˜çš„åŠ¨æ€ç½‘ç«™ï¼Œå†åˆ°ç°åœ¨çš„å¾®æœåŠ¡æ¶æ„ã€‚ä¸æ–­çš„è¿­ä»£çš„éœ€æ±‚å¼•é¢†è¿™å·¥ç¨‹å®è·µå‘DDDçš„æ¨¡å¼ã€‚</li></ol><h3 id="é¢†åŸŸå–å±è®¾è®¡èƒ½åšä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#é¢†åŸŸå–å±è®¾è®¡èƒ½åšä»€ä¹ˆï¼Ÿ"></a>é¢†åŸŸå–å±è®¾è®¡èƒ½åšä»€ä¹ˆï¼Ÿ</h3><p>é¢†åŸŸé©±åŠ¨è®¾è®¡ä¸»è¦æ˜¯ç”¨<strong>é¢†åŸŸæ¨¡å‹</strong>å»æè¿°ä¸šåŠ¡ï¼Œä¼ ç»Ÿçš„J2EEå’ŒSpring+æŒä¹…åŒ–å±‚ç­‰äº‹åŠ¡æ€§ç¼–ç¨‹æ¨¡å‹æ˜¯åŸºäºæ•°æ®å»å®ç°çš„ä¹Ÿå°±åªä¼šå…³å¿ƒæ•°æ®çš„ç»“æ„ï¼Œä»è€Œå¯¼è‡´ä¸šåŠ¡å¯¹è±¡(DTO/BO)ç­‰åªå­˜åœ¨get/setæ–¹æ³•ã€‚</p><p>ä»¥ä¸‹æ˜¯jdonçš„ç»å…¸æ¯”å–»ï¼š</p><blockquote><p>ä»¥æ¯”èµ›Matchä¸ºæ¡ˆä¾‹ï¼Œæ¯”èµ›æœ‰â€œå¼€å§‹â€å’Œâ€œç»“æŸâ€ç­‰ä¸šåŠ¡è¡Œä¸ºï¼Œä½†æ˜¯ä¼ ç»Ÿç»å…¸çš„æ–¹å¼æ˜¯å°†â€œå¼€å§‹â€å’Œâ€œç»“æŸâ€è¡Œä¸ºæ”¾åœ¨æ¯”èµ›çš„æœåŠ¡Serviceä¸­ï¼Œè€Œä¸æ˜¯æ”¾åœ¨æ¯”èµ›å¯¹è±¡æœ¬èº«ä¹‹ä¸­ã€‚æˆ‘ä»¬ä¸èƒ½å› ä¸ºç”¨äº†è®¡ç®—æœºï¼Œç”¨äº†æ•°æ®åº“ï¼Œç”¨äº†æ¡†æ¶ï¼Œä¸šåŠ¡æ¨¡å‹åè€Œè¢«æŠ€æœ¯æ¡†æ¶ç»™ç»‘æ¶;</p></blockquote><blockquote><p>æå€¡å……è¡€æ¨¡å‹ï¼Œå®é™…å°±æ˜¯è®©è¿‡å»è¢«è‚¢è§£è¢«é»‘crackçš„ä¸šåŠ¡æ¨¡å‹å›å½’æ­£å¸¸ï¼Œå½“ç„¶è¿™ä¹Ÿä¼šè¢«ä¸€äº›å…ˆå…¥ä¸ºä¸»æˆ–è¢«æ´—è¿‡è„‘çš„ç¨‹åºå‘˜çœ‹æˆåè€Œä¸æ­£å¸¸ï¼Œè¿™æ›´æ˜¯æå¤§å¯æ‚²ä¹‹å¤„ã€‚çœ‹åˆ°é¢†åŸŸæ¨¡å‹ä»£ç ï¼Œå°±çœ‹åˆ°ä¸šåŠ¡éœ€æ±‚ï¼Œæ²¡æœ‰ç¿»è¯‘æ²¡æœ‰è½¬æ¢ï¼Œä¿è¯è½¯ä»¶çœŸæ­£å®ç°â€œæ‹·è´ä¸èµ°æ ·â€ã€‚</p></blockquote><blockquote><p>DDDæœ€å¤§çš„å¥½å¤„æ˜¯ï¼šæ¥è§¦åˆ°éœ€æ±‚ç¬¬ä¸€æ­¥å°±æ˜¯è€ƒè™‘é¢†åŸŸæ¨¡å‹ï¼Œè€Œä¸æ˜¯å°†å…¶åˆ‡å‰²æˆæ•°æ®å’Œè¡Œä¸ºï¼Œç„¶åæ•°æ®ç”¨æ•°æ®åº“å®ç°ï¼Œè¡Œä¸ºä½¿ç”¨æœåŠ¡å®ç°ï¼Œæœ€åé€ æˆéœ€æ±‚çš„é¦–è‚¢åˆ†ç¦»ã€‚DDDè®©ä½ é¦–å…ˆè€ƒè™‘çš„æ˜¯ä¸šåŠ¡è¯­è¨€ï¼Œè€Œä¸æ˜¯æ•°æ®ã€‚é‡ç‚¹ä¸åŒå¯¼è‡´ç¼–ç¨‹ä¸–ç•Œè§‚ä¸åŒã€‚</p></blockquote><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ç†è§£çš„æ„æ€æ˜¯é¢†åŸŸé©±åŠ¨æ¨¡å‹æ˜¯å‘è®©æˆ‘ä»¬æŒ‰ç…§ä¸šåŠ¡æ¥è¿›è¡Œå»ºæ¨¡ï¼Œè€Œä¸æ˜¯ä¸šåŠ¡æœ€åäº§ç”Ÿçš„æ•°æ®æ¥è¿›è¡Œæ•°æ®å»ºæ¨¡ã€‚æ•°æ®å»ºæ¨¡ä¼šè®©æˆ‘ä»¬çš„ä¸šåŠ¡è¢«éšè—åœ¨serviceä¸­ï¼Œä¸šåŠ¡äº§ç”Ÿçš„ç»“æœæ˜¯æˆ‘ä»¬å¾—åˆ°çš„æ•°æ®ã€‚ç”¨é¢†åŸŸæ¨¡å‹è¾¾åˆ°çš„æ•ˆæœå°±æ˜¯æ¨¡å‹å³ä»£è¡¨ä¸šåŠ¡ï¼Œä¹Ÿå°±æ˜¯çœ‹åˆ°æ¨¡å‹å°±èƒ½çŸ¥é“ä¸šåŠ¡ï¼Œä»ä¸šåŠ¡å‡ºå‘ï¼Œç„¶åç”¨è¡Œä¸ºå’Œæ•°æ®å»å®Œæˆä¸šåŠ¡çš„æ–¹æ³•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é¢†åŸŸé©±åŠ¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¢†åŸŸé©±åŠ¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²â€”LeetCode03</title>
      <link href="2020/05/27/13.LeetCode/3.%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E4%B8%B2%E2%80%94LeetCode03/"/>
      <url>2020/05/27/13.LeetCode/3.%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E4%B8%B2%E2%80%94LeetCode03/</url>
      
        <content type="html"><![CDATA[<h1>æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²çš„é•¿åº¦</p><blockquote><p>ç¤ºä¾‹ 1:</p></blockquote><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;abcabcbb&quot;è¾“å‡º: 3 è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;abc&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>ç¤ºä¾‹ 2:</p></blockquote><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;bbbbb&quot;è¾“å‡º: 1è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯&quot;b&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>ç¤ºä¾‹ 3:</p></blockquote><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥: &quot;pwwkew&quot;è¾“å‡º: 3è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯Â &quot;wke&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚Â    è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯å­ä¸²çš„é•¿åº¦ï¼Œ&quot;pwke&quot;Â æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ"></a>åˆ†æ</h2><p>æœ€å¼€å§‹æƒ³åˆ°çš„è§£æ³•å°±æ˜¯ç”¨str.substring(0,str.length-2)å’Œstr.substring(str.length-2,str.length-2)å»åˆ¤æ–­å‰ä¸€ä¸ªæ˜¯å¦å­˜åœ¨åä¸€ä¸ªå…ƒç´ ä¸­çš„å€¼ã€‚å¦‚æœå­˜åœ¨é€’å½’ï¼Œè¯´æ˜åä¸€ä¸ªå…ƒç´ é‡å¤ã€‚åä¸€ä¸ªå…ƒç´ é‡å¤ä¹Ÿä¸èƒ½è¯æ˜å‡ºä»€ä¹ˆç»“è®ºï¼Œå¹¶ä¸”é€’å½’çš„å»åˆ¤æ–­å¹¶ä¸èƒ½æ¨å¯¼å‡ºæœ€é•¿çš„å­ä¸²ã€‚<br><img src="https://s1.ax1x.com/2020/05/27/tE2Qv4.jpg" alt="tE2Qv4.jpg"></p><h2 id="å®˜æ–¹æ€è·¯"><a class="header-anchor" href="#å®˜æ–¹æ€è·¯"></a>å®˜æ–¹æ€è·¯</h2><blockquote><p>å¦‚æœæˆ‘ä»¬ä¾æ¬¡é€’å¢åœ°æšä¸¾å­ä¸²çš„èµ·å§‹ä½ç½®ï¼Œé‚£ä¹ˆå­ä¸²çš„ç»“æŸä½ç½®ä¹Ÿæ˜¯é€’å¢çš„ï¼è¿™é‡Œçš„åŸå› åœ¨äºï¼Œå‡è®¾æˆ‘ä»¬é€‰æ‹©å­—ç¬¦ä¸²ä¸­çš„ç¬¬ kä¸ªå­—ç¬¦ä½œä¸ºèµ·å§‹ä½ç½®ï¼Œå¹¶ä¸”å¾—åˆ°äº†ä¸åŒ…å«é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²çš„ç»“æŸä½ç½®ä¸º krã€‚é‚£ä¹ˆå½“æˆ‘ä»¬é€‰æ‹©ç¬¬ k+1 ä¸ªå­—ç¬¦ä½œä¸ºèµ·å§‹ä½ç½®æ—¶ï¼Œé¦–å…ˆä»k+1åˆ° r_krçš„å­—ç¬¦æ˜¾ç„¶æ˜¯ä¸é‡å¤çš„ï¼Œå¹¶ä¸”ç”±äºå°‘äº†åŸæœ¬çš„ç¬¬ kk ä¸ªå­—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç»§ç»­å¢å¤§ r_krï¼Œç›´åˆ°å³ä¾§å‡ºç°äº†é‡å¤å­—ç¬¦ä¸ºæ­¢ã€‚</p></blockquote><p>ç”¨å›¾æ¥è¡¨ç¤ºå°±æ˜¯ï¼š</p><p><img src="https://s1.ax1x.com/2020/05/27/tEWggS.jpg" alt="tEWggS.jpg"></p><h2 id="ä»£ç ç¤ºä¾‹"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lengthOfLongestSubstring</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è¡¨ç¤ºæœ€é•¿å­ä¸²çš„é•¿åº¦</span>        <span class="token keyword">int</span> maxLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">//ç´¢å¼•</span>        <span class="token keyword">int</span> firstIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//firstIndexã€lastIndexéƒ½å¿…é¡»å°äºå­—ç¬¦ä¸²é•¿åº¦</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>firstIndex <span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastIndex<span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//è·å–lastIndexæŒ‡å‘çš„å­—ç¬¦</span>            <span class="token class-name">Character</span> key <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åˆ¤æ–­å­—ç¬¦æ˜¯å¦å­˜åœ¨mapä¸­</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å­˜åœ¨mapä¸­è¡¨æ˜keyå…ƒç´ å·²ç»å’Œå‰é¢çš„å­—ç¬¦ä¸²é‡å¤</span>                <span class="token class-name">Character</span> rKey <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>firstIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//ç§»é™¤å½“å‰å­—ç¬¦ä¸²ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span>                map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>rKey<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//èµ·å§‹ç‚¹+1</span>                firstIndex<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å¦‚æœä¸å­˜åœ¨å°±å°†å…ƒç´ æ”¾åˆ°mapä¸­</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//lastIndexç»§ç»­å‘å‰</span>                lastIndex<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//æœ€åå¦‚æœæœ¬æ¬¡å¾—åˆ°çš„å­ä¸²é•¿åº¦å¤§äºmaxLengthå°±è¿›è¡Œæ›¿ä»£</span>            maxLength <span class="token operator">=</span> lastIndex <span class="token operator">-</span>firstIndex<span class="token operator">></span>maxLength<span class="token operator">?</span>lastIndex<span class="token operator">-</span>firstIndex<span class="token operator">:</span>maxLength<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> maxLength<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>æ— é‡å¤å­—ç¬¦çš„æœ€å¤§å­ä¸²é—®é¢˜ä¸»è¦ç”¨åˆ°äº†ä¸€ä¸ªæŸ¥æ‰¾èŒƒå›´ä¸­çš„æŠ€å·§<strong>æ»‘åŠ¨çª—å£</strong>çš„æ¦‚å¿µï¼Œå°†ä¸€ä¸ªèŒƒå›´ä½œä¸ºä¸€ä¸ªçª—å£ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ ä¸å­˜åœ¨ä¸è¿™ä¸ªèŒƒå›´ä¸­å°±åŠ å…¥è¿™ä¸ªçª—å£ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ å­˜åœ¨è¿™ä¸ªèŒƒå›´ä¸­å°±å°†è¿™ä¸ªçª—å£çš„èŒƒå›´ä»å‰é€’å‡çš„å‡å°‘ç›´åˆ°æ’é™¤äº†è¿™ä¸ªå…ƒç´ ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸¤æ•°ç›¸åŠ --LeetCode02</title>
      <link href="2020/05/27/13.LeetCode/2.%E4%B8%A4%E6%95%B0%E7%9B%B8%E5%8A%A0-LeetCode02/"/>
      <url>2020/05/27/13.LeetCode/2.%E4%B8%A4%E6%95%B0%E7%9B%B8%E5%8A%A0-LeetCode02/</url>
      
        <content type="html"><![CDATA[<h1>ä¸¤æ•°å‘åŠ </h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>ç»™å‡ºä¸¤ä¸ªÂ éç©º çš„é“¾è¡¨ç”¨æ¥è¡¨ç¤ºä¸¤ä¸ªéè´Ÿçš„æ•´æ•°ã€‚å…¶ä¸­å®ƒä»¬å„è‡ªçš„ä½æ•°æ˜¯æŒ‰ç…§é€†åºçš„æ–¹å¼å­˜å‚¨çš„ï¼Œå¹¶ä¸”å®ƒä»¬çš„æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ä¸€ä½æ•°å­—ã€‚<br>å¦‚æœï¼Œæˆ‘ä»¬å°†è¿™ä¸¤ä¸ªæ•°ç›¸åŠ èµ·æ¥ï¼Œåˆ™ä¼šè¿”å›ä¸€ä¸ªæ–°çš„é“¾è¡¨æ¥è¡¨ç¤ºå®ƒä»¬çš„å’Œã€‚<br>æ‚¨å¯ä»¥å‡è®¾é™¤äº†æ•°å­— 0 ä¹‹å¤–ï¼Œè¿™ä¸¤ä¸ªæ•°éƒ½ä¸ä¼šä»¥ 0Â å¼€å¤´ã€‚</p><ul><li>ç¤ºä¾‹ï¼š</li></ul><pre class="line-numbers language-none"><code class="language-none">è¾“å…¥ï¼š(2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)è¾“å‡ºï¼š7 -&gt; 0 -&gt; 8åŸå› ï¼š342 + 465 &#x3D; 807<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ"></a>åˆ†æ</h2><p>æœ€å¼€å§‹æŒ‰ç…§é¢˜ç›®è¦æ±‚æˆ‘è‡ªå·±æ€è€ƒçš„æƒ³æ³•æ˜¯<br>ç¬¬ä¸€æ­¥ï¼šå…ˆå¾—åˆ°æ•°å­—<br>ç¬¬äºŒæ­¥ï¼šæ•°å­—ç›¸åŠ <br>ç¬¬ä¸‰æ­¥ï¼šå°†å’Œè½¬åŒ–æˆListNodeçš„æ•°æ®ç»“æ„</p><h3 id="é€’å½’æ•°å­—è§£æ³•"><a class="header-anchor" href="#é€’å½’æ•°å­—è§£æ³•"></a>é€’å½’æ•°å­—è§£æ³•</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//clientæ–¹æ³•</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ListNode</span> <span class="token function">addTwoNumbers</span><span class="token punctuation">(</span><span class="token class-name">ListNode</span> l1<span class="token punctuation">,</span> <span class="token class-name">ListNode</span> l2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">BigInteger</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token function">buildNum</span><span class="token punctuation">(</span>l1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token function">buildNum</span><span class="token punctuation">(</span>l2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">buildNote</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * å°†é“¾è¡¨è½¬åŒ–æˆæ•°å­— */</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">buildNum</span><span class="token punctuation">(</span><span class="token class-name">ListNode</span> l1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l1<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">buildNum</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span> <span class="token operator">+</span> l1<span class="token punctuation">.</span>val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*** å°†æ•°å­—è½¬åŒ–æˆåˆ—è¡¨**/</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ListNode</span> <span class="token function">buildNote</span><span class="token punctuation">(</span><span class="token class-name">String</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ListNode</span> currentNode<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> i <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        currentNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        currentNode<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">buildNote</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        currentNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> currentNode<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å®éªŒç»“æœ</li></ul><p>æŠ›å‡º<strong>BigInteger</strong>ä¸èƒ½è¯†åˆ«å¼‚å¸¸ï¼Œåº”è¯¥æ˜¯è¯„æµ‹ç¨‹åºä¸èƒ½ä½¿ç”¨ç›¸å…³çš„å¼•ç”¨ç±»ã€‚å°±ä»£è¡¨ç€ä¸èƒ½ä½¿ç”¨æ•°å€¼ä¹‹å’Œçš„è§£æ³•ã€‚</p><h3 id="ç§»ä½ç›¸åŠ è§£æ³•"><a class="header-anchor" href="#ç§»ä½ç›¸åŠ è§£æ³•"></a>ç§»ä½ç›¸åŠ è§£æ³•</h3><ul><li>ä»£ç </li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ListNode</span> <span class="token function">addTwoNumbers</span><span class="token punctuation">(</span><span class="token class-name">ListNode</span> l1<span class="token punctuation">,</span> <span class="token class-name">ListNode</span> l2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„é“¾è¡¨</span>        <span class="token class-name">ListNode</span> rsNote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹åŒ–æ—¶å°†å½“å‰èŠ‚ç‚¹è®¾ç½®æˆä¸ºrsNode</span>        <span class="token class-name">ListNode</span> currNode <span class="token operator">=</span> rsNote<span class="token punctuation">;</span>        <span class="token class-name">ListNode</span> pNode <span class="token operator">=</span> l1<span class="token punctuation">;</span>        <span class="token class-name">ListNode</span> qNode <span class="token operator">=</span> l2<span class="token punctuation">;</span>        <span class="token comment">//è¡¨ç¤ºæ˜¯å¦æœ‰è¿›ä½</span>        <span class="token keyword">int</span> carry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>pNode <span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">||</span> qNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å½“å‰å¾ªç¯ä¸­çš„node</span>            <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>pNode<span class="token operator">?</span>pNode<span class="token punctuation">.</span>val<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>qNode<span class="token operator">?</span>qNode<span class="token punctuation">.</span>val<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>carry<span class="token punctuation">;</span>            <span class="token comment">//å½“å‰è¿›ä½</span>            carry <span class="token operator">=</span> sum<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>            <span class="token comment">//æ„å»ºå‡ºå½“å‰nodeèŠ‚ç‚¹</span>            currNode<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span>sum <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å°†ä¸‹ä¸€æ¬¡ä½¿ç”¨åˆ°çš„å½“å‰èŠ‚ç‚¹è®¾ç½®æˆä¸ºæ­¤æ¬¡å¾ªç¯å¾—åˆ°çš„çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>            currNode <span class="token operator">=</span> currNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token comment">//éå†åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ </span>            pNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token operator">!=</span>pNode<span class="token operator">?</span>pNode<span class="token punctuation">.</span>next<span class="token operator">:</span>pNode<span class="token punctuation">;</span>            qNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token operator">!=</span>qNode<span class="token operator">?</span>qNode<span class="token punctuation">.</span>next<span class="token operator">:</span>qNode<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//æœ€åå¤„ç†æœ€åä¸€ä¸ªè¿›ä½æ•°å€¼</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>carry <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            currNode<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span>carry<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> rsNote<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä½¿ç”¨åˆ°çš„æ•°å­¦åŸç†å°±åªæ˜¯é€¢åè¿›ä½ã€‚å…ˆè®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½<strong>carry</strong>ï¼Œç„¶åè®¡ç®—å½“å‰ä½ç½®çš„å€¼æ¨¡é™¤10ä»è€Œå¾—åˆ°å½“å‰ä½ç½®çš„å€¼ã€‚<br>è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæŠ€å·§ï¼Œåœ¨å¯¹è¿™ç§å°¾èŠ‚ç‚¹è¿›è¡Œé€’å¢æ—¶ä½¿ç”¨äº†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">currNode<span class="token punctuation">.</span>next<span class="token operator">=</span>node<span class="token punctuation">;</span>currNode <span class="token operator">=</span> currNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç”¨å›¾æ¥è¡¨ç¤º<br><img src="https://s1.ax1x.com/2020/05/27/tkiMSU.png" alt="tkiMSU.png"></p><p>ä¸æ–­çš„å°†å½“å‰èŠ‚ç‚¹é¡ºç€é“¾è¡¨å‘ä¸‹ç§»åŠ¨ï¼Œå¹¶ä¸”ç»™æ¯ä¸€ä¸ªnextèŠ‚ç‚¹è¿›è¡Œèµ‹å€¼ã€‚è¿™ç§æ–¹æ³•æ¯”é€’å½’æ‰€å ç”¨çš„ç©ºé—´è¾ƒå°ã€‚</p><h2 id="æ€»ç»“ï¼š"><a class="header-anchor" href="#æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>ä¸¤æ•°å‘åŠ é—®é¢˜æœ¬è´¨ä¸Šè¿˜æ˜¯è¦å»è§£å†³è¿›ä½é—®é¢˜è€Œä¸æ˜¯è¿›è¡Œæ•°å€¼è®¡ç®—ï¼Œè¿™ç§è¿›ä½é—®é¢˜åº”è¯¥è¿˜å¯ä»¥ç»§ç»­è¿›è¡Œä¼˜åŒ–ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸¤æ•°ä¹‹å’Œ_LeetCode01</title>
      <link href="2020/05/26/13.LeetCode/1.%E4%B8%A4%E6%95%B0%E4%B9%8B%E5%92%8C-LeetCode01/"/>
      <url>2020/05/26/13.LeetCode/1.%E4%B8%A4%E6%95%B0%E4%B9%8B%E5%92%8C-LeetCode01/</url>
      
        <content type="html"><![CDATA[<h1>ä¸¤æ•°ä¹‹å’Œ_LeetCode01</h1><h2 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®"></a>é¢˜ç›®</h2><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ numsÂ å’Œä¸€ä¸ªç›®æ ‡å€¼ targetï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡ºå’Œä¸ºç›®æ ‡å€¼çš„é‚£Â ä¸¤ä¸ªÂ æ•´æ•°ï¼Œå¹¶è¿”å›ä»–ä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚<br>ä½ å¯ä»¥å‡è®¾æ¯ç§è¾“å…¥åªä¼šå¯¹åº”ä¸€ä¸ªç­”æ¡ˆã€‚ä½†æ˜¯ï¼Œæ•°ç»„ä¸­åŒä¸€ä¸ªå…ƒç´ ä¸èƒ½ä½¿ç”¨ä¸¤éã€‚</p><p>ç¤ºä¾‹:<br>ç»™å®š nums = [2, 7, 11, 15], target = 9<br>å› ä¸º nums[0] + nums[1] = 2 + 7 = 9<br>æ‰€ä»¥è¿”å› [0, 1]</p><h2 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ"></a>åˆ†æ</h2><p>ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­æˆ‘åªæ˜¯ç”¨åˆ°äº†ä¸€ä¸ªæœ€åŸºæœ¬çš„å†’æ³¡çš„æ–¹å¼éå†äº†æ•°ç»„è¿›è¡Œçš„æŸ¥è¯¢ï¼Œç›®å‰ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">twoSum</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>target <span class="token operator">-</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>                    array<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> array<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œç»“æœ<br><img src="https://s1.ax1x.com/2020/05/26/tPS9bT.png" alt="tPS9bT.png"></li></ul><p>ç¬¬äºŒä¸ªç‰ˆæœ¬æ€è·¯æœ¬æ¥æ˜¯æƒ³å…ˆå°†ä¸å¯èƒ½çš„æ•°è¿›è¡Œä¸€æ¬¡æ’é™¤åå†è¿›è¡Œæ±‚å’Œï¼Œåæ¥å‘ç°å­˜åœ¨å¯ä¸ºè´Ÿæ•°çš„æƒ…å†µã€‚å› æ­¤è¿™ç§æ–¹æ¡ˆå¤±è´¥ã€‚æœ€åæ¨èä¸€ç§å®˜æ–¹ç»™å‡ºçš„è§£é¢˜æ€è·¯<strong>ä¸€æ¬¡Hashæ³•</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">twoSum1</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> difference <span class="token operator">=</span> target <span class="token operator">-</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>difference<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>difference<span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"No two sum solution"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œç»“æœ<br><img src="https://s1.ax1x.com/2020/05/26/tPPwXn.png" alt="tPPwXn.png"></li></ul><p>è¿™ç§æ–¹æ³•æœ€æœ€ä¸»è¦çš„ç‰¹å®šæ˜¯åˆ©ç”¨äº†HashMapä¸­çš„keyåªèƒ½æ˜ å°„ä¸€ä¸ªå…ƒç´ ã€‚é€šè¿‡è¿™æ ·çš„ç‰¹æ€§ä½¿å¾—åœ¨ä¸€æ¬¡éå†ä¸­å¯ä»¥å»mapä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨å·®å€¼ã€‚è¿™æ˜¯ä¸€ç§ç©ºé—´åŠ hashæ¥æ¢å–æ—¶é—´çš„æ–¹æ³•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹çš„å–æ¶ˆä¸å…³é—­</title>
      <link href="2020/05/24/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/14.%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8F%96%E6%B6%88%E4%B8%8E%E5%85%B3%E9%97%AD/"/>
      <url>2020/05/24/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/14.%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8F%96%E6%B6%88%E4%B8%8E%E5%85%B3%E9%97%AD/</url>
      
        <content type="html"><![CDATA[<h1>çº¿ç¨‹çš„å–æ¶ˆä¸å…³é—­</h1><p>åœ¨çœ‹ã€Šjavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­çš„çº¿ç¨‹çš„å–æ¶ˆå’Œå…³é—­ä¸­çœ‹åˆ°ä¸¤ä¸ªä¾‹å­æ¯”è¾ƒæœ‰è¶£ï¼Œå› æ­¤è®°å½•ä¸‹æ¥ã€‚</p><h2 id="ç¨‹åºç›®çš„"><a class="header-anchor" href="#ç¨‹åºç›®çš„"></a>ç¨‹åºç›®çš„</h2><blockquote><p>æƒ³é€šè¿‡æŸç§åŠ¨ä½œæ¥è¾¾åˆ°å–æ¶ˆæŸä¸ªç‰¹å®šçº¿ç¨‹çš„æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°ä¸­æ–­æ”¹çº¿ç¨‹çš„ç›®çš„</p></blockquote><h2 id="è‡ªå®šä¹‰æ ‡å¿—ä½æ¥æ§åˆ¶çº¿ç¨‹çš„ä¸­æ–­"><a class="header-anchor" href="#è‡ªå®šä¹‰æ ‡å¿—ä½æ¥æ§åˆ¶çº¿ç¨‹çš„ä¸­æ–­"></a>è‡ªå®šä¹‰æ ‡å¿—ä½æ¥æ§åˆ¶çº¿ç¨‹çš„ä¸­æ–­</h2><p>ä¹¦ä¸­å…ˆå±•ç¤ºäº†ä¸€ç§åä¾‹ï¼Œé€šè¿‡è‡ªå®šä¹‰æ ‡å¿—ä½æ¥æ§åˆ¶çº¿ç¨‹çš„ä¸­æ–­</p><ul><li>product</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token punctuation">&#123;</span>    <span class="token comment">/**     * flagæ ‡å¿—æ˜¯å¦æš‚åœç”Ÿäº§     */</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">/**     * å¯é˜»å¡çš„é˜Ÿåˆ—     */</span>    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span> queue<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * å¯åŠ¨ç”Ÿäº§è€…     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token class-name">BigInteger</span> p <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p  <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">nextProbablePrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":ç”Ÿäº§->"</span> <span class="token operator">+</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":ç”Ÿäº§åœæ­¢"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">":å‘ç”Ÿä¸­æ–­å¼‚å¸¸..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * å–æ¶ˆç”Ÿäº§     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":æš‚åœ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡volatileä¿®é¥°flagæ ‡å¿—ä½æ¥æ§åˆ¶ç”Ÿäº§è€…çº¿ç¨‹çš„å–æ¶ˆ</p><ul><li>main</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Producer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>    producer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"ç”Ÿäº§è€…çº¿ç¨‹"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>producer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="https://s1.ax1x.com/2020/05/24/tSHM5T.png" alt="tSHM5T.png"></p><blockquote><p>thread threadId</p></blockquote><p><img src="https://s1.ax1x.com/2020/05/24/tSvZfP.png" alt="tSvZfP.png"></p><p>é€šè¿‡Arthasè§‚å¯Ÿçº¿ç¨‹çš„æ‰§è¡Œæƒ…å†µ,<strong>ç”Ÿäº§è€…çº¿ç¨‹</strong>çŠ¶æ€ä¸ºwaiting,å¯ä»¥çœ‹åˆ°ç”Ÿäº§è€…çº¿ç¨‹åœ¨ç­‰å¾…é˜»å¡é˜Ÿåˆ—é‡Šæ”¾ç©ºé—´ã€‚ç”±äºç”Ÿäº§è€…çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…é˜»å¡é˜Ÿåˆ—çš„é‡Šæ”¾ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½è¾¾åˆ°ä¸­æ–­ç”Ÿäº§è€…çº¿ç¨‹çš„æ•ˆæœã€‚</p><h2 id="ä½¿ç”¨ä¸­æ–­æ¥è¿›è¡Œå–æ¶ˆ"><a class="header-anchor" href="#ä½¿ç”¨ä¸­æ–­æ¥è¿›è¡Œå–æ¶ˆ"></a>ä½¿ç”¨ä¸­æ–­æ¥è¿›è¡Œå–æ¶ˆ</h2><ul><li>product</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ProducerInterrupt</span><span class="token punctuation">&#123;</span>    <span class="token comment">/**     * å¯é˜»å¡çš„é˜Ÿåˆ—     */</span>    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span> queue<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">ProducerInterrupt</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * å¯åŠ¨ç”Ÿäº§è€…     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token class-name">BigInteger</span> p <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p  <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">nextProbablePrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":ç”Ÿäº§->"</span> <span class="token operator">+</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":ç”Ÿäº§åœæ­¢"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">":å‘ç”Ÿä¸­æ–­å¼‚å¸¸..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>main</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ProducerInterrupt</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerInterrupt</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span> t1 <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>    producer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"ç”Ÿäº§è€…çº¿ç¨‹"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>t1<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœï¼š<br><img src="https://s1.ax1x.com/2020/05/24/tpS00g.png" alt="tpS00g.png"></p><p>æ€»ç»“ï¼š<br>åœ¨ä½¿ç”¨è‡ªå®šä¹‰çš„æ ‡å¿—ä½æ¥è¿›è¡Œçº¿ç¨‹çš„å–æ¶ˆæ“ä½œæ—¶ï¼Œè¦æ ¼å¤–æ³¨æ„æ˜¯å¦æœ‰ä¼šé˜»å¡è¿è¡Œçº¿ç¨‹çš„æ“ä½œã€‚å½“å­˜åœ¨æœ‰é˜»å¡è¿è¡Œçº¿ç¨‹çš„æ“ä½œæ—¶ï¼Œä¼šé˜»å¡åˆ¤æ–­æ ‡å¿—ä½çš„æ“ä½œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> final </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AbstractQueuedSynchronizerçš„æºç åˆ†æ</title>
      <link href="2020/05/22/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/13.AbstractQueuedSynchronizer%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>2020/05/22/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/13.AbstractQueuedSynchronizer%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>AbstractQueuedSynchronizerçš„æºç åˆ†æ</h1><p><strong>AQS</strong>çš„å…¨ç§°æ˜¯<strong>AbstractQueuedSynchronizer</strong>ï¼ŒAQSæä¾›äº†ä¸€ä¸ªä»¥FIFOçš„é˜Ÿåˆ—ï¼Œé€šè¿‡å®šä¹‰ä¸€ç³»åˆ—é˜»å¡çº¿ç¨‹çš„æ“ä½œä¸º<strong>ReentrantLock</strong>ã€<strong>ReentrantReadWriteLock</strong>ã€<strong>Semaphore</strong>ã€<strong>CountDownLatch</strong>æä¾›äº†åº•å±‚æ¡†æ¶æ”¯æŒã€‚</p><h2 id=""><a class="header-anchor" href="#"></a></h2><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“:</h2>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AbstractQueuedSynchronizer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Guavaçš„ä½¿ç”¨</title>
      <link href="2020/05/20/1.%E6%9D%82%E8%AE%B0/Guava%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>2020/05/20/1.%E6%9D%82%E8%AE%B0/Guava%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1>Guavaçš„ä½¿ç”¨</h1><h2 id="çº¿ç¨‹æ± çš„ä½¿ç”¨"><a class="header-anchor" href="#çº¿ç¨‹æ± çš„ä½¿ç”¨"></a>çº¿ç¨‹æ± çš„ä½¿ç”¨</h2><blockquote><p>ListenableFutureæ˜¯åŸºäºè£…é¥°å™¨æ¨¡å¼å®ç°çš„</p></blockquote><ul><li>ç¤ºä¾‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> nameFormat <span class="token operator">=</span> <span class="token string">"thread_factory_%d"</span><span class="token punctuation">;</span>        <span class="token class-name">ThreadFactory</span> shardingThreadFactory <span class="token operator">=</span> <span class="token class-name">ShardingThreadFactoryBuilder</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>nameFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ExecutorService</span> delegate <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span>shardingThreadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¾—åˆ°è£…é¥°å™¨çš„çº¿ç¨‹æ± </span>        <span class="token class-name">ListeningExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">MoreExecutors</span><span class="token punctuation">.</span><span class="token function">listeningDecorator</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span><span class="token punctuation">&#123;</span>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"çº¿ç¨‹:"</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">",ä¼‘çœ 3s"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ³¨å†Œå›è°ƒå‡½æ•°</span>        future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹:"</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"æ‰§è¡Œå›è°ƒå‡½æ•°å¾—åˆ°è¿”å›å€¼ä¸º:"</span> <span class="token operator">+</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span>shardingThreadFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> guava </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sharding-jdbcçš„æŸ¥è¯¢è¿‡ç¨‹åˆ†æ</title>
      <link href="2020/05/18/11.orm%E6%A1%86%E6%9E%B6/22.sharding-jdbc%E7%9A%84%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/"/>
      <url>2020/05/18/11.orm%E6%A1%86%E6%9E%B6/22.sharding-jdbc%E7%9A%84%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>sharding-jdbcçš„æŸ¥è¯¢è¿‡ç¨‹åˆ†æ</h1><p>ä¸Šä¸€ç« ç®€å•çš„è¯´äº†ä¸€ä¸‹sharding-jdbcçš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™ä¸€ç« åˆ†æä¸€ä¸‹sharding-jdbcè¿›è¡Œæ•°æ®åˆ†ç‰‡çš„åŸç†</p><h2 id="æ¦‚å¿µ"><a class="header-anchor" href="#æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><strong>æ•°æ®åˆ†ç‰‡</strong>æŒ‡çš„æ˜¯æ•°æ®æŒ‰ç…§æŸä¸ªç»´åº¦å°†å•ä¸€æ•°æ®åº“çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“æˆ–å¤šä¸ªæ•°æ®è¡¨ä¸­è¾¾åˆ°å·²æå‡æ€§èƒ½ç“¶é¢ˆå·²ç»å¯ç”¨æ€§çš„æ•ˆæœã€‚æ•°æ®åˆ†ç‰‡ä¸»è¦åˆ†ä¸º<strong>æ°´å¹³åˆ†ç‰‡</strong>ã€<strong>å‚ç›´åˆ†ç‰‡</strong>ã€‚</p><h3 id="æ°´å¹³åˆ†ç‰‡"><a class="header-anchor" href="#æ°´å¹³åˆ†ç‰‡"></a>æ°´å¹³åˆ†ç‰‡</h3><p><strong>æ°´å¹³åˆ†ç‰‡</strong>æŒ‡çš„æ˜¯æ ¹æ®æŸç§è§„åˆ™å°†æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªåº“æˆ–å¤šä¸ªè¡¨ä¸­ï¼Œæ¯ä¸ªåˆ†ç‰‡åŒ…å«æ•°æ®çš„ä¸€éƒ¨åˆ†</p><h3 id="å‚ç›´åˆ†ç‰‡"><a class="header-anchor" href="#å‚ç›´åˆ†ç‰‡"></a>å‚ç›´åˆ†ç‰‡</h3><p><strong>å‚ç›´åˆ†ç‰‡</strong>æŒ‡çš„æ˜¯æŒ‰ç…§ä¸šåŠ¡æ¥è¿›è¡Œåˆ’åˆ†ä¸“åº“ä¸“ç”¨ï¼Œæ¯ä¸ªè¡¨éƒ½æ”¾åˆ°ä¸“é—¨çš„åº“ä¸­</p><h2 id="å†…æ ¸å‰–æ"><a class="header-anchor" href="#å†…æ ¸å‰–æ"></a>å†…æ ¸å‰–æ</h2><ul><li>æ ¸å¿ƒæµç¨‹</li></ul><blockquote><p>SQLè§£æ =&gt; æ‰§è¡Œå™¨ä¼˜åŒ– =&gt; SQLè·¯ç”± =&gt; SQLæ”¹å†™ =&gt; SQLæ‰§è¡Œ =&gt; ç»“æœå½’å¹¶</p></blockquote><p><img src="https://s1.ax1x.com/2020/05/19/Y49lon.png" alt="Y49lon.png"></p><ol><li><strong>SQLè§£æ</strong>ä¸»è¦æ˜¯é€šè¿‡sqlè§£æå™¨å¯¹sqlè¿›è¡Œç†è§£</li><li><strong>æ‰§è¡Œå™¨ä¼˜åŒ–</strong>ä¸»è¦æ˜¯åˆå¹¶å’Œä¼˜åŒ–åˆ†ç‰‡æ¡ä»¶</li><li><strong>SQLè·¯ç”±</strong>æ ¹æ®è·¯ç”±ç­–ç•¥ç”Ÿæˆè·¯ç”±è·¯å¾„</li><li><strong>SQLæ”¹å†™</strong>å°†sqlæ”¹å†™ä¸ºçœŸå®æ•°æ®åº“å¯ä»¥æ‰§è¡Œçš„è¯­å¥</li><li><strong>SQLæ‰§è¡Œ</strong>é€šè¿‡å¤šçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ</li><li><strong>ç»“æœå¹¶å½’</strong>å°†å¤šä¸ªç»“æœé›†è¿›è¡Œåˆå¹¶è¿”å›</li></ol><h2 id="ä»£ç åˆ†æ"><a class="header-anchor" href="#ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h2><h3 id="ShardingRouteræ ¸å¿ƒåˆ†æ"><a class="header-anchor" href="#ShardingRouteræ ¸å¿ƒåˆ†æ"></a>ShardingRouteræ ¸å¿ƒåˆ†æ</h3><p>ShardingRouter.<strong>route()<strong>æ–¹æ³•ä½œä¸ºè·¯ç”±çš„æ ¸å¿ƒï¼Œä¸»è¦æ˜¯è¿”å›è·¯ç”±å¯¹è±¡</strong>SQLRouteResult</strong>ï¼Œè¿™ä¸ªå¯¹è±¡ä¿å­˜è·¯ç”±ä¿¡æ¯ã€‚<br><img src="https://s1.ax1x.com/2020/05/19/Y4Fupq.png" alt="Y4Fupq.png"></p><p><strong>RouteResult</strong>å¯¹è±¡æœ€ç»ˆè¢«è¿”å›åˆ°<strong>ShardingPreparedStatement</strong>ã€‚è¿™ä¸ªç±»ç»§æ‰¿äº<strong>java.sql.Statement</strong>,Statementå®šä¹‰äº†ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’å¹¶è¿”å›ç»“æœçš„æ¥å£ã€‚</p><ul><li>ShardingPreparedStatement</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ShardingPreparedStatement</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractShardingPreparedStatementAdapter</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ†ç‰‡è¿æ¥</span>    <span class="token annotation punctuation">@Getter</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ShardingConnection</span> connection<span class="token punctuation">;</span>        <span class="token comment">//æ‰§è¡Œsql</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> sql<span class="token punctuation">;</span>        <span class="token comment">//åˆ†ç‰‡å¼•æ“</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PreparedQueryShardingEngine</span> shardingEngine<span class="token punctuation">;</span>        <span class="token comment">//æ‰§è¡Œå™¨</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PreparedStatementExecutor</span> preparedStatementExecutor<span class="token punctuation">;</span>        <span class="token comment">//æ‰¹å¤„ç†æ‰§è¡Œå™¨</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BatchPreparedStatementExecutor</span> batchPreparedStatementExecutor<span class="token punctuation">;</span>        <span class="token comment">//sqlè·¯ç”±å™¨</span>    <span class="token keyword">private</span> <span class="token class-name">SQLRouteResult</span> sqlRouteResult<span class="token punctuation">;</span>        <span class="token comment">//ç»“æœé›†</span>    <span class="token keyword">private</span> <span class="token class-name">ResultSet</span> currentResultSet<span class="token punctuation">;</span>    <span class="token comment">//å®ç°executeQueryã€executeUpdateã€executeã€getGeneratedKeysç­‰æ–¹æ³•</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="execute-æ–¹æ³•"><a class="header-anchor" href="#execute-æ–¹æ³•"></a>execute()æ–¹æ³•</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ¸…é™¤ç¯å¢ƒ</span>        <span class="token function">clearPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è¿›è¡Œåˆ†ç‰‡ç¯å¢ƒè®¾ç½®</span>        <span class="token function">shard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹åŒ–é¢„å¤„ç†æ‰§è¡Œå™¨</span>        <span class="token function">initPreparedStatementExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ‰§è¡Œ</span>        <span class="token keyword">return</span> preparedStatementExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token function">clearBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>shard()<strong>æ–¹æ³•å·²ç»åœ¨ä¸Šé¢è¿›è¡Œäº†åˆ†æï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æä¸€ä¸‹</strong>initPreparedStatementExecutor</strong>æ–¹æ³•</p><ul><li>initPreparedStatementExecutor</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initPreparedStatementExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–æ‰§è¡Œå™¨</span>    preparedStatementExecutor<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>sqlRouteResult<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è®¾ç½®è¯­å¥å‚æ•°</span>    <span class="token function">setParametersForStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">replayMethodForStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>**preparedStatementExecutor.execute()**æ–¹æ³•æ˜¯å…·ä½“æ‰§è¡Œçš„æ–¹æ³•</p><p><img src="https://s1.ax1x.com/2020/05/20/Y7XsIA.png" alt="Y7XsIA.png"></p><p>1å¤„å°†å¾…æ‰§è¡Œsqlå°è£…æˆä¸ºå›è°ƒå¯¹è±¡ï¼Œ2å¤„**executeCallback(executeCallback)**æ‰§è¡Œå›è°ƒå¯¹è±¡</p><ul><li>executeCallbackåœ¨å›è°ƒä¸­æ‰§è¡Œsql</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token class-name">Boolean</span> <span class="token function">executeSQL</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ConnectionMode</span> connectionMode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>executeCallback()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> sqlExecuteTemplate<span class="token punctuation">.</span><span class="token function">executeGroup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> executeGroups<span class="token punctuation">,</span> executeCallback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">refreshMetaDataIfNeeded</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sqlStatementContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡<strong>sqlExecuteTemplate.executeGroup</strong>æ‰§è¡Œæ–¹æ³•ï¼Œä¼šå°†æ‰§è¡ŒåŠ¨ä½œä¼ é€’åˆ°æ‰§è¡Œå¼•æ“<strong>ShardingExecuteEngine</strong>çš„<strong>groupExecute</strong>æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token function">groupExecute</span><span class="token punctuation">(</span>    <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingExecuteGroup</span><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputGroups<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> firstCallback<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> callback<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> serial<span class="token punctuation">)</span>    <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputGroups<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> serial <span class="token operator">?</span> <span class="token function">serialExecute</span><span class="token punctuation">(</span>inputGroups<span class="token punctuation">,</span> firstCallback<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">parallelExecute</span><span class="token punctuation">(</span>inputGroups<span class="token punctuation">,</span> firstCallback<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™é‡Œ<strong>åŒæ­¥æ‰§è¡Œæ–¹æ³•</strong>å’Œ<strong>å¼‚æ­¥æ‰§è¡Œæ–¹æ³•</strong>ï¼Œå¹¶ä¸”å°†ç¬¬ä¸€ä¸ªä»»åŠ¡äº¤ç»™å½“å‰çº¿ç¨‹è¿›è¡Œå¤„ç†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">></span></span> <span class="token function">parallelExecute</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingExecuteGroup</span><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputGroups<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> firstCallback<span class="token punctuation">,</span>                                       <span class="token keyword">final</span> <span class="token class-name">ShardingGroupExecuteCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">></span></span> callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShardingExecuteGroup</span><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span><span class="token punctuation">></span></span> inputGroupsIterator <span class="token operator">=</span> inputGroups<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ShardingExecuteGroup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">></span></span> firstInputs <span class="token operator">=</span> inputGroupsIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListenableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> restResultFutures <span class="token operator">=</span> <span class="token function">asyncGroupExecute</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>inputGroupsIterator<span class="token punctuation">)</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœfirstCallbackæœ‰å€¼å°±è®©å½“å‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œå¦‚æœæ²¡å€¼å°±è¿”å›çº¿ç¨‹æ± æ‰§è¡Œç»“æœ</span>    <span class="token keyword">return</span> <span class="token function">getGroupResults</span><span class="token punctuation">(</span><span class="token function">syncGroupExecute</span><span class="token punctuation">(</span>firstInputs<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token operator">==</span> firstCallback <span class="token operator">?</span> callback <span class="token operator">:</span> firstCallback<span class="token punctuation">)</span><span class="token punctuation">,</span> restResultFutures<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç å¾ˆç»†å¿ƒï¼Œä¸ä½†ä½¿ç”¨åˆ°äº†å½“å‰çº¿ç¨‹æ¥æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¹Ÿä½¿ç”¨çš„æ˜¯Guavaæä¾›çš„å¯å›è°ƒçš„çº¿ç¨‹æ± <strong>ListeningExecutorService</strong>,å¯å‚è€ƒ<a href="/2020/05/20/1.%E6%9D%82%E8%AE%B0/Guava%E7%9A%84%E4%BD%BF%E7%94%A8/#more">Guavaçš„ä½¿ç”¨</a></p><p>åœ¨æ‰§è¡Œsqlæ—¶å€™åˆä¼šå›åˆ°å½“åˆåˆ›å»ºå›è°ƒå‡½æ•°çš„åœ°æ–¹è¿›è¡Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚</p><p>æ€»ç»“ï¼š<br>sharding-jdbcåœ¨æ‰§è¡Œsqlçš„æ—¶å€™é¦–å…ˆè¦è·å–åˆ†åº“çš„é…ç½®ç”Ÿæˆ<strong>statement</strong>,ç„¶åæ„é€ å›è°ƒå‡½æ•°ï¼Œå°†å›è°ƒå‡½æ•°æ”¾åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œå¾—åˆ°ç»“æœå¹¶æ‰§è¡Œå›è°ƒå‡½æ•°åˆå¹¶ç»“æœè¿”å›ï¼Œæ¥ä¸‹æ¥é‡ç‚¹ä»‹ç»ä¸€ä¸‹sharding-jdbcçš„è¯¦ç»†ç”¨æ³•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ShardingSphere </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShardingSphere </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¾®æœåŠ¡æ¶æ„ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€è€ƒ</title>
      <link href="2020/05/14/1.%E6%9D%82%E8%AE%B0/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%8B%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%80%9D%E8%80%83/"/>
      <url>2020/05/14/1.%E6%9D%82%E8%AE%B0/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%8B%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<h1>å¾®æœåŠ¡æ¶æ„ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€è€ƒ</h1><h2 id="ä»æœ¬åœ°äº‹åŠ¡åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¼”å˜"><a class="header-anchor" href="#ä»æœ¬åœ°äº‹åŠ¡åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¼”å˜"></a>ä»æœ¬åœ°äº‹åŠ¡åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¼”å˜</h2><h3 id="åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</p><h3 id="äºŒé˜¶æ®µæäº¤"><a class="header-anchor" href="#äºŒé˜¶æ®µæäº¤"></a>äºŒé˜¶æ®µæäº¤</h3><p>æœ‰ä¸€ä¸ªåè°ƒè€…åˆ†åˆ«åœ¨å‡†å¤‡å’Œæ‰§è¡Œé˜¶æ®µå¯¹å‚ä¸è€…å‘é€å‘½ä»¤å’Œè¿›è¡Œäº‹åŠ¡å¤„ç†çš„é€»è¾‘</p><h3 id="ä¸‰é˜¶æ®µ"><a class="header-anchor" href="#ä¸‰é˜¶æ®µ"></a>ä¸‰é˜¶æ®µ</h3><p>ä¸‰é˜¶æ®µæ˜¯ä½œä¸ºäºŒé˜¶æ®µçš„ä¸€ç§æ”¹è‰¯ç­–ç•¥ï¼Œä¼˜åŒ–æ”¹è‰¯äº†è¶…æ—¶ç­‰å¾…çš„é—®é¢˜å’Œé¢„å¤„ç†é˜¶æ®µï¼Œé€šè¿‡åè°ƒè€…åœ¨ä¸åŒçš„é˜¶æ®µä¸­åˆ¤æ–­ç›¸åº”çš„å‘½ä»¤<br>ä¸‰é˜¶æ®µåˆ†ä¸ºï¼šé¢„å¤„ç†ã€å‡†å¤‡ã€æ‰§è¡Œã€‚é¢„å¤„ç†é˜¶æ®µä¸»è¦æ˜¯è§£å†³ï¼ŒäºŒé˜¶æ®µåœ¨å‡†å¤‡é˜¶æ®µä¹‹å‰æ²¡æœ‰ç­›é€‰è¿‡å‚ä¸è€…çš„é—®é¢˜ï¼Œå°½é‡ä¿è¯äº†å‡†å¤‡é˜¶æ®µçš„å‚ä¸è€…éƒ½æ˜¯å­˜åœ¨çš„æˆ–æœ‰æ„ä¹‰çš„ã€‚</p><h2 id="æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ"><a class="header-anchor" href="#æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ"></a>æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ</h2><h3 id="CAP"><a class="header-anchor" href="#CAP"></a>CAP</h3><blockquote><p>å¯å‚è€ƒåˆ†å¸ƒå¼æ€è€ƒä¸€æ–‡</p></blockquote><p>CAPç†è®ºè¡¥å……ï¼Œcapç†è®ºæ˜¯å»ºç«‹åœ¨</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼äº‹åŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‰«ç ç™»å½•çš„åŸç†</title>
      <link href="2020/05/10/1.%E6%9D%82%E8%AE%B0/%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E7%9A%84%E5%8E%9F%E7%90%86/"/>
      <url>2020/05/10/1.%E6%9D%82%E8%AE%B0/%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E7%9A%84%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>sharding-jdbcåˆ†åº“åˆ†è¡¨å®è·µ</title>
      <link href="2020/05/06/11.orm%E6%A1%86%E6%9E%B6/21.sharding-jdbc%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E8%B7%B5/"/>
      <url>2020/05/06/11.orm%E6%A1%86%E6%9E%B6/21.sharding-jdbc%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>sharding-jdbcåˆ†åº“åˆ†è¡¨å®è·µ</h1><p>åœ¨é¡¹ç›®ä¸­å¤§é‡çš„ä½¿ç”¨åˆ°sharding-jdbcï¼Œä»Šå¤©å°†å®ƒçš„å®è·µç”¨æ³•åšä¸€ä¸ªæ€»ç»“ã€‚<br>æ€»ç»“å‰å…ˆæå‡ ä¸ªé—®é¢˜:</p><ol><li>ä¸ºä»€ä¹ˆè¦ç”¨sharding-jdbcï¼Ÿ</li><li>å¦‚ä½•ä½¿ç”¨ï¼Ÿ</li><li>æœ‰ä»€ä¹ˆæ³¨æ„äº‹é¡¹ï¼Ÿ</li><li>åŒç±»å‹çš„æ¡†æ¶å¯¹æ¯”ï¼Ÿ<br>è®©æˆ‘ä»¬å¸¦ç€é—®é¢˜å»å¼€å§‹äº†è§£sharding-jdbcã€‚</li></ol><h2 id="åŸºç¡€çŸ¥è¯†"><a class="header-anchor" href="#åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p><strong>sharding-jdbc</strong>æ˜¯å®šä½ä¸ºè½»é‡çº§Javaæ¡†æ¶ï¼Œåœ¨Javaçš„JDBCå±‚æä¾›çš„é¢å¤–æœåŠ¡ã€‚ å®ƒä½¿ç”¨å®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“ï¼Œä»¥jaråŒ…å½¢å¼æä¾›æœåŠ¡ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²å’Œä¾èµ–ï¼Œå¯ç†è§£ä¸ºå¢å¼ºç‰ˆçš„JDBCé©±åŠ¨ï¼Œå®Œå…¨å…¼å®¹JDBCå’Œå„ç§ORMæ¡†æ¶ã€‚</p><ul><li>Sharding-Proxy</li></ul><p><img src="https://shardingsphere.apache.org/document/current/img/sharding-jdbc-brief.png" alt="Sharding-Proxy"></p><ul><li>æ”¯æŒçš„åŠŸèƒ½</li></ul><p><img src="https://s1.ax1x.com/2020/05/06/YVJ5PH.png" alt="YVJ5PH.png"></p><h2 id="å¿«é€Ÿå…¥é—¨"><a class="header-anchor" href="#å¿«é€Ÿå…¥é—¨"></a>å¿«é€Ÿå…¥é—¨</h2><h3 id="mavenä¾èµ–"><a class="header-anchor" href="#mavenä¾èµ–"></a>mavenä¾èµ–</h3><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;latest.release.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è§„åˆ™é…ç½®"><a class="header-anchor" href="#è§„åˆ™é…ç½®"></a>è§„åˆ™é…ç½®</h3><blockquote><p>Sharding-JDBCå¯ä»¥é€šè¿‡Javaï¼ŒYAMLï¼ŒSpringå‘½åç©ºé—´å’ŒSpring Boot Starterå››ç§æ–¹å¼é…ç½®ï¼Œå¼€å‘è€…å¯æ ¹æ®åœºæ™¯é€‰æ‹©é€‚åˆçš„é…ç½®æ–¹å¼ã€‚è¯¦æƒ…è¯·å‚è§é…ç½®æ‰‹å†Œã€‚</p></blockquote><h3 id="åˆ›å»ºDataSource"><a class="header-anchor" href="#åˆ›å»ºDataSource"></a>åˆ›å»ºDataSource</h3><blockquote><p>é€šè¿‡ShardingDataSourceFactoryå·¥å‚å’Œè§„åˆ™é…ç½®å¯¹è±¡è·å–ShardingDataSourceï¼ŒShardingDataSourceå®ç°è‡ªJDBCçš„æ ‡å‡†æ¥å£DataSourceã€‚ç„¶åå³å¯é€šè¿‡DataSourceé€‰æ‹©ä½¿ç”¨åŸç”ŸJDBCå¼€å‘ï¼Œæˆ–è€…ä½¿ç”¨JPA, MyBatisç­‰ORMå·¥å…·ã€‚</p></blockquote><h3 id="æ¼”ç¤ºå®ä¾‹"><a class="header-anchor" href="#æ¼”ç¤ºå®ä¾‹"></a>æ¼”ç¤ºå®ä¾‹</h3><ul><li>ç”¨springBoot Starter+mysqlæ–¹å¼æ¼”ç¤º</li></ul><ol><li>pomæ–‡ä»¶</li></ol><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sharding.jdbc.version</span><span class="token punctuation">></span></span>4.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sharding.jdbc.version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-jdbc-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;sharding.jdbc.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- for spring namespace --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-jdbc-spring-namespace<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;sharding.jdbc.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>åˆ†åº“åˆ†è¡¨é…ç½®è§„åˆ™(åŸºäºymlæ–‡ä»¶)</li></ol><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">spring:  shardingsphere:    datasource:      names: ds0,ds1      # æ•°æ®æºds0      ds0:        type: com.alibaba.druid.pool.DruidDataSource        driver-class-name: com.mysql.jdbc.Driver        url: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;ds0?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;GMT        username: root        password: 111111      # æ•°æ®æºds1      ds1:        type: com.alibaba.druid.pool.DruidDataSource        driver-class-name: com.mysql.jdbc.Driver        url: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;ds1?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;GMT        username: root        password: 111111    sharding:      default-database-strategy: # åˆ†åº“è§„åˆ™        inline:          sharding-column: vender_id          algorithm-expression: ds$&#123;vender_id % 2&#125;      tables:        t_user:  #t_userè¡¨          key-generator-column-name: id  #ä¸»é”®          actual-data-nodes: ds$&#123;0..1&#125;.t_user    #çœŸå®æ•°æ®èŠ‚ç‚¹          database-strategy: # åˆ†åº“ç­–ç•¥            inline:              sharding-column: vender_id # åˆ†åº“é”®              algorithm-expression: ds$&#123;vender_id % 2&#125;#          tableStrategy: #åˆ†è¡¨ç­–ç•¥#            inline: #è¡Œè¡¨è¾¾å¼#              shardingColumn: vender_id#              algorithmExpression: t_user$&#123;vender_id % 2&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>åˆ›å»ºDataSource</li></ol><blockquote><p>ç”±äºå¼•å…¥ä½¿ç”¨äº†<strong>SpringBoot Mybatis</strong>å› æ­¤ä¼šè‡ªåŠ¨è£…é…ç›¸åº”çš„<strong>DataSource</strong></p></blockquote><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- SpringBoot Mybatis ä¾èµ– --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¦‚æœåœ¨ä¸åŒçš„åº“ä¸­æœ‰ç›¸åŒçš„è¡¨ï¼Œä½†æ˜¯æœªè®¾ç½®åˆ†åº“ç­–ç•¥çš„è¯ä¼šéšæœºä½¿ç”¨ä¸€ä¸ªè¿æ¥è¿›è¡ŒæŸ¥è¯¢(è¿™ä¸€ç‚¹å¯ä»¥åœ¨ä¸‹ä¸€ç« ä¸­åˆ†æåŸå› )</p></blockquote><h2 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>sharding-jdbcå®˜ç½‘ä¸Šçš„ç¤ºä¾‹åœ°å€å·²ç»ä¸æ˜¯è·³è½¬çš„é‚£ä¸ªå•ç‹¬çš„æ¼”ç¤ºé¡¹ç›®åœ°å€äº†ï¼Œå·²ç»è¢«åˆå¹¶åˆ°ä¸»é¡¹ç›®ä¸­ã€‚ç›´æ¥ä¸‹è½½ä¸»é¡¹ç›®æ—¶å€™å¦‚æœæ˜¯windowä¼šæç¤ºæ–‡ä»¶åç§°å¤ªé•¿ï¼Œå®˜ç½‘å·²ç»ç»™äº†è§£å†³æ–¹æ¡ˆ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config --global core.longpaths <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šåªæ˜¯ç²—ç•¥çš„å°†<strong>sharding-jdbc</strong>ä»‹ç»äº†ä¸€ä¸‹ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹<strong>sharding-jdbc</strong>çš„åŸç†ã€‚</p><ul><li>å‚è€ƒèµ„æ–™</li></ul><p><img src="https://dbaplus.cn/news-11-1854-1.html" alt="æ–¹æ¡ˆè™½å¥½ï¼Œæˆæœ¬å…ˆè¡Œï¼šæ•°æ®åº“Sharding+Proxyå®è·µè§£æ"></p>]]></content>
      
      
      <categories>
          
          <category> ShardingSphere </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShardingSphere </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§‚å¯Ÿè€…æ¨¡å¼</title>
      <link href="2020/05/06/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
      <url>2020/05/06/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1>è®¾è®¡æ¨¡å¼ä¹‹è§‚å¯Ÿè€…æ¨¡å¼</h1><blockquote><p>è§‚å¯Ÿè€…æ¨¡å¼çš„å®šä¹‰æ˜¯ä¸€ä¸ªä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©ä¸€ä¸ªæˆ–å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡ç›‘æ§ä¸€ä¸ªä¸»é¢˜å¯¹è±¡ã€‚å½“ä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€ä¸Šå‘ç”Ÿå˜åŒ–æ—¶ï¼Œèƒ½å¤Ÿé€šçŸ¥æ‰€æœ‰ä¾èµ–æ­¤ä¸»é¢˜çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿è¿™äº›è§‚å¯Ÿè€…å¯¹è±¡èƒ½å¤Ÿå¤„ç†æ­¤æ¬¡æ›´æ–°</p></blockquote><h2 id="å‚ä¸å¯¹è±¡"><a class="header-anchor" href="#å‚ä¸å¯¹è±¡"></a>å‚ä¸å¯¹è±¡</h2><ul><li>Subject</li><li>Observer</li><li>Client</li></ul><h3 id="Subject"><a class="header-anchor" href="#Subject"></a>Subject</h3><blockquote><p>ä¸»é¢˜å¯¹è±¡ä¸»ä½“æ˜¯åŸºäºè¢«è§‚å¯Ÿè€…ï¼Œå¹¶ä¸”åœ¨å†…éƒ¨ä¿å­˜ä¸€ä¸ªæˆ–å¤šä¸ªè¢«è§‚å¯Ÿè€…çš„å¤„ç†å¯¹è±¡</p></blockquote><h3 id="Observer"><a class="header-anchor" href="#Observer"></a>Observer</h3><blockquote><p>Observerå¯¹è±¡æ˜¯æŠ½è±¡å‡ºæ¥å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†çš„å¯¹è±¡</p></blockquote><h3 id="client"><a class="header-anchor" href="#client"></a>client</h3><blockquote><p>å®¢æˆ·ç«¯å¯¹è±¡çš„ä½œç”¨æ˜¯è§¦å‘äº‹ä»¶çš„å‘ç”Ÿï¼Œå¹¶ä¸”å°†è§‚å¯Ÿè€…æ³¨å†Œåˆ°è¢«è§‚å¯Ÿè€…ä¸­</p></blockquote><h2 id="ä½¿ç”¨åœºæ™¯"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><ul><li>ä¸€ä¸ªæŠ½è±¡æ¨¡å‹æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œå…¶ä¸­ä¸€ä¸ªæ–¹é¢ä¾èµ–äºå¦ä¸€ä¸ªæ–¹é¢ã€‚å°†è¿™äº›æ–¹é¢å°è£…åœ¨ç‹¬ç«‹çš„å¯¹è±¡ä¸­ä½¿å®ƒä»¬å¯ä»¥å„è‡ªç‹¬ç«‹åœ°æ”¹å˜å’Œå¤ç”¨ã€‚</li><li>ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜å°†å¯¼è‡´å…¶ä»–ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ä¹Ÿå‘ç”Ÿæ”¹å˜ï¼Œè€Œä¸çŸ¥é“å…·ä½“æœ‰å¤šå°‘å¯¹è±¡å°†å‘ç”Ÿæ”¹å˜ï¼Œå¯ä»¥é™ä½å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚</li><li>ä¸€ä¸ªå¯¹è±¡å¿…é¡»é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œè€Œå¹¶ä¸çŸ¥é“è¿™äº›å¯¹è±¡æ˜¯è°ã€‚</li></ul><h2 id="åŸºæœ¬çš„è§‚å¯Ÿè€…æ¨¡å¼"><a class="header-anchor" href="#åŸºæœ¬çš„è§‚å¯Ÿè€…æ¨¡å¼"></a>åŸºæœ¬çš„è§‚å¯Ÿè€…æ¨¡å¼</h2><ul><li>Subject</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Observer</span><span class="token punctuation">></span></span> observerList <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> state<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAllObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Observer</span> observer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        observerList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyAllObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Observer</span> observer <span class="token operator">:</span> observerList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            observer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Observer</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">default</span> <span class="token keyword">void</span>  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":å¼€å§‹æ‰§è¡Œ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObserverImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":å¼€å§‹æ‰§è¡ŒObserverImpl..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObserverImpl2</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":å¼€å§‹æ‰§è¡ŒObserverImpl2..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>client</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObserverClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Observer</span> observer1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObserverImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Observer</span> observer2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObserverImpl2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        subject<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>observer1<span class="token punctuation">)</span><span class="token punctuation">;</span>        subject<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>observer2<span class="token punctuation">)</span><span class="token punctuation">;</span>        subject<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Guavaä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼-EventBus"><a class="header-anchor" href="#Guavaä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼-EventBus"></a>Guavaä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼(EventBus)</h2><ul><li>Observer</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ‰§è¡Œäº‹ä»¶..."</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Subject</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EventListener</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Subscribe</span>    <span class="token annotation punctuation">@AllowConcurrentEvents</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">Event1</span> event1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"->å¼‚æ­¥æ¶ˆè´¹è®¢é˜…äº‹ä»¶,æ¥æ”¶åˆ°:"</span> <span class="token operator">+</span> event1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Subscribe</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">Event2</span> event2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"->åŒæ­¥æ¶ˆè´¹è®¢é˜…äº‹ä»¶,æ¥æ”¶åˆ°:"</span> <span class="token operator">+</span> event2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Subscribe</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">DeadEvent</span> deadEvent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"->è®¢é˜…é”™è¯¯çš„äº‹ä»¶,æ¥æ”¶åˆ°:"</span> <span class="token operator">+</span> deadEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>client</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">EventBus</span> ebSyc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ³¨å†Œç›‘å¬å™¨</span>ebSyc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ‰§è¡Œç›¸åº”äº‹ä»¶</span>ebSyc<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>è§‚å¯Ÿè€…æ¨¡å¼é€‚ç”¨äºä¸€ä¸ªäº‹ä»¶çš„å‘ç”Ÿä¼šå¯åŠ¨å¤šä¸ªäº‹ä»¶çš„å“åº”ã€‚å¦‚æœåœ¨æºäº‹ä»¶ä¸­ä¾æ¬¡è°ƒç”¨å¯åŠ¨å…³è”äº‹ä»¶çš„ï¼Œè¿™æ ·æ¯æ¬¡å¢åŠ å…³è”äº‹ä»¶éƒ½ä¼šåœ¨æºäº‹ä»¶ä¸­è¿›è¡ŒåŒæ­¥ä¿®æ”¹ã€‚ä¸€ä¸ªåŠ¨ä½œå¯èƒ½ä¼šå½±å“å¤šä¸ªå…³è”åŠ¨ä½œçš„åœºæ™¯é€‚ç”¨äºè§‚å¯Ÿè€…æ¨¡å¼ï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•åä¼šè§¦å‘ä¸‹æ¸¸å¤šä¸ªä¸šåŠ¡çš„åœºæ™¯(ç”µå•†ä¸­çš„è®¢å•ä»˜æ¬¾æˆåŠŸå°±ä¼šè§¦å‘ä¸‹æ¸¸ç‰©æµã€å•†å“ã€è´¢åŠ¡ç­‰å¤šä¸ªç³»ç»Ÿ)</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è§‚å¯Ÿè€…æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åƒåœ¾å›æ”¶</title>
      <link href="2020/05/05/12.JVM/2.%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
      <url>2020/05/05/12.JVM/2.%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
      
        <content type="html"><![CDATA[<h1>jvmçš„åƒåœ¾å›æ”¶æœºåˆ¶</h1><p>ç”±äºjvmå°†æ‰€æœ‰å¯¹è±¡éƒ½ä¿å­˜åœ¨<strong>å †</strong>å†…å­˜ä¸­ï¼Œå› æ­¤åŠæ—¶è…¾å‡ºå †å†…å­˜ä¸­æ— ç”¨çš„ç©ºé—´å°±è‡³å…³é‡è¦äº†ï¼Œjvmé€šè¿‡å†…å­˜å›æ”¶çš„æ–¹å¼å¯¹å †å†…å­˜è¿›è¡Œ<strong>å›æ”¶</strong>å’Œ<strong>æ•´ç†</strong><br>å›æƒ³å’±ä»¬æ‰“æ‰«å®¶åŠ¡çš„æ­¥éª¤æ˜¯ä¸æ˜¯ç¬¬ä¸€æ­¥è¦å°†è„ä¸œè¥¿æ‰¾å‡ºæ¥ä¸¢æ‰ï¼Œç¬¬äºŒæ­¥å°†å‰©ä½™æœ‰ç”¨çš„ä¸œè¥¿æ•´ç†ç æ”¾å¥½ã€‚jvmä¸­è¿›è¡Œå†…å­˜å›æ”¶çš„æ­¥éª¤ä¹Ÿå·®ä¸å¤šåˆ†ä¸º<strong>æ ‡è®°</strong>ã€<strong>æ¸…é™¤</strong>ã€<strong>æ•´ç†</strong>ã€‚æ ¹æ®ä¸åŒçš„ç‰¹ç‚¹è®¾è®¡å‡ºä¸åŒçš„å›æ”¶ç®—æ³•ã€‚</p><h2 id="GCå›æ”¶ç®—æ³•"><a class="header-anchor" href="#GCå›æ”¶ç®—æ³•"></a>GCå›æ”¶ç®—æ³•</h2><ul><li>å¤åˆ¶ç®—æ³•</li></ul><blockquote><p>é€šè¿‡å¤åˆ¶ä¸€ä¸ªé•œåƒå†…å­˜ç©ºé—´ï¼Œæ¯æ¬¡è¿›è¡Œå›æ”¶æ—¶å°±å°†æœ‰ç”¨çš„å¯¹è±¡å¤åˆ¶åˆ°é•œåƒå†…å­˜ç©ºé—´ä¸­ã€‚</p></blockquote><ul><li>æ ‡è®°-æ¸…é™¤</li></ul><blockquote><p>å°†åƒåœ¾å¯¹è±¡ç›´æ¥é•œåƒåˆ é™¤</p></blockquote><ul><li>æ ‡è®°-æ•´ç†</li></ul><blockquote><p>åœ¨æ ‡è®°-æ¸…é™¤åå¢åŠ ä¸€ä¸ªæ­¥éª¤<strong>æ•´ç†</strong></p></blockquote><h2 id="åˆ†ä»£æœºåˆ¶"><a class="header-anchor" href="#åˆ†ä»£æœºåˆ¶"></a>åˆ†ä»£æœºåˆ¶</h2><p>ç”±äºå †ä¸­çš„å¯¹è±¡å¤§éƒ¨åˆ†æ˜¯æœç”Ÿå¤•ç­çš„ï¼Œå› æ­¤å°†å †å†…å­˜ä»é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºä¸åŒçš„åŒºåŸŸã€‚åœ¨æ ¹æ®ä¸åŒçš„åŒºåŸŸç”¨ä¸åŒçš„GCç®—æ³•ã€‚</p><ul><li>å¹´è½»ä»£</li></ul><blockquote><p>å¹´è½»ä»£çš„ç‰¹ç‚¹æ˜¯å­˜å‚¨çš„å¯¹è±¡å¤§éƒ¨åˆ†éƒ½æ˜¯æœç”Ÿå¤•ç­ï¼Œå› æ­¤å°†å¹´è½»ä»£ä¸­çš„æ•°æ®æŒ‰ç…§1ï¼š1ï¼š8 = survivor:survivor:Edençš„æ¯”ä¾‹è¿›è¡Œåˆ’åˆ†</p></blockquote><ul><li>è€å¹´ä»£</li></ul><h2 id="GCå›æ”¶å™¨"><a class="header-anchor" href="#GCå›æ”¶å™¨"></a>GCå›æ”¶å™¨</h2><h3 id="å¹´è½»ä»£çš„å›æ”¶å™¨"><a class="header-anchor" href="#å¹´è½»ä»£çš„å›æ”¶å™¨"></a>å¹´è½»ä»£çš„å›æ”¶å™¨</h3><ol><li>Serialåƒåœ¾å›æ”¶å™¨</li></ol><blockquote><p>å•çº¿ç¨‹çš„GCå›æ”¶å™¨</p></blockquote><ol start="2"><li>PerNewåƒåœ¾å›æ”¶å™¨</li></ol><blockquote><p>å¤šçº¿ç¨‹çš„GCå›æ”¶å™¨ï¼Œæ³¨é‡äºå‡å°‘åœé¡¿æ—¶é—´</p></blockquote><ol start="3"><li>Parallel Scavengeåƒåœ¾å›æ”¶å™¨</li></ol><blockquote><p>å¤šçº¿ç¨‹ç‰ˆæœ¬çš„åƒåœ¾å›æ”¶å™¨ï¼Œæ³¨é‡äºCPUçš„ååé‡</p></blockquote><h3 id="è€å¹´ä»£åƒåœ¾å›æ”¶å™¨"><a class="header-anchor" href="#è€å¹´ä»£åƒåœ¾å›æ”¶å™¨"></a>è€å¹´ä»£åƒåœ¾å›æ”¶å™¨</h3><ol><li><p>Serial Oldåƒåœ¾å›æ”¶å™¨</p></li><li><p>Parallel Old</p></li><li><p>CMS</p></li></ol><h2 id="CMSåƒåœ¾å›æ”¶å™¨"><a class="header-anchor" href="#CMSåƒåœ¾å›æ”¶å™¨"></a>CMSåƒåœ¾å›æ”¶å™¨</h2><p>CMSåƒåœ¾å›æ”¶å™¨æ¯”å…¶ä»–åƒåœ¾å›æ”¶å™¨ä¼˜åŒ–çš„åœ°æ–¹åœ¨äºå¹¶å‘ï¼Œå¯ä»¥å¹¶å‘çš„å’Œåº”ç”¨ç¨‹åºçš„çº¿ç¨‹åŒæ—¶è¿›è¡Œã€‚</p><h3 id="æ‰§è¡Œæ­¥éª¤"><a class="header-anchor" href="#æ‰§è¡Œæ­¥éª¤"></a>æ‰§è¡Œæ­¥éª¤</h3><ul><li>åˆå§‹é˜¶æ®µ(STW)</li><li>å¹¶å‘æ ‡è®°(å¹¶å‘)</li><li>é‡æ–°æ ‡è®°(STW)</li><li>å¹¶å‘æ¸…ç†(å¹¶å‘)</li></ul><blockquote><p>ç”±äºCMSåƒåœ¾å›æ”¶æ–¹å¼æ²¡æœ‰å†…å­˜æ•´ç†è¿™ä¸€æ­¥éª¤ï¼Œå› æ­¤åœ¨è€å¹´ä»£åˆ°è¾¾é˜€å€¼çš„æ—¶å€™ä¼šè¿›è¡Œfull GCï¼Œæ­¤æ—¶ä¼šé‡æ–°æ•´ç†å†…å­˜</p></blockquote><h2 id="G1åƒåœ¾å›æ”¶å™¨"><a class="header-anchor" href="#G1åƒåœ¾å›æ”¶å™¨"></a>G1åƒåœ¾å›æ”¶å™¨</h2><p>G1åƒåœ¾å›æ”¶å™¨æ˜¯æŒ‡å®šæœ€å°åœé¡¿æ—¶é—´ï¼Œé€šè¿‡å°½å¯èƒ½çš„åˆ°è¾¾åœé¡¿æ—¶é—´æ¥å®ŒæˆGCçš„ä¸€ç§åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> jvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åƒåœ¾å›æ”¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>finalçš„ä¸å˜æ€§è®¾è®¡</title>
      <link href="2020/05/04/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/12.final%E7%9A%84%E4%B8%8D%E5%8F%98%E6%80%A7%E8%AE%BE%E8%AE%A1/"/>
      <url>2020/05/04/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/12.final%E7%9A%84%E4%B8%8D%E5%8F%98%E6%80%A7%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>finalçš„ä¸å˜æ€§è®¾è®¡</h1><h2 id="finalçš„ä½œç”¨"><a class="header-anchor" href="#finalçš„ä½œç”¨"></a>finalçš„ä½œç”¨</h2><p>finalæ˜¯ç”¨æ¥ä¿®é¥°ä¸å˜æ€§å…³ç³»çš„ï¼Œè¡¨ç¤ºä¸€ç§ä¸å¯æ”¹å˜çš„å…³ç³»ã€‚å¯ä»¥ç”¨æ¥ä¿®é¥°<strong>å˜é‡</strong>ã€<strong>æ–¹æ³•</strong>ã€<strong>ç±»</strong></p><h2 id="ä¿®é¥°å˜é‡"><a class="header-anchor" href="#ä¿®é¥°å˜é‡"></a>ä¿®é¥°å˜é‡</h2><p>fianlä¿®é¥°å˜é‡è¡¨ç¤ºä¸€æ—¦èµ‹å€¼å…³ç³»è¢«åˆå§‹åŒ–å°±ä¸èƒ½è¢«ä¿®æ”¹äº†ï¼›finalåªä¼šä¿è¯è¿™ä¸ªå˜é‡çš„å¼•ç”¨ä¸å¯å˜ï¼Œè€Œå¯¹è±¡æœ¬èº«çš„å†…å®¹ä¾ç„¶æ˜¯å¯å˜çš„ã€‚</p><p>è¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ï¼š</p><ul><li>è®¾è®¡çš„è§’åº¦</li></ul><blockquote><p>æ˜¯å¯¹äºä¸èƒ½ä¿®æ”¹å˜é‡çš„å€¼éœ€è¦è¿›è¡Œfinalè¿›è¡Œä¿®é¥°</p></blockquote><ul><li>çº¿ç¨‹çš„è§’åº¦</li></ul><blockquote><p>finalä¿®é¥°çš„å˜é‡åœ¨è¯­æ„å°±æ˜¯ä¸å˜çš„ï¼Œå› æ­¤å°±æ˜¯å¤©ç”Ÿçº¿ç¨‹å®‰å…¨çš„</p></blockquote><h2 id="ç©ºç™½final"><a class="header-anchor" href="#ç©ºç™½final"></a>ç©ºç™½final</h2><p><strong>ç©ºç™½final</strong>å°†å¯¹finalçš„èµ‹å€¼å»¶è¿Ÿäº†ï¼Œä»è€Œå¢åŠ äº†ç¨‹åºçš„çµæ´»æ€§</p><h2 id="finalä¿®é¥°æ–¹æ³•"><a class="header-anchor" href="#finalä¿®é¥°æ–¹æ³•"></a>finalä¿®é¥°æ–¹æ³•</h2><p><strong>final</strong>ä¿®é¥°æ–¹æ³•è¡¨ç¤ºæ–¹æ³•ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå…¶ä¸­æ„é€ æ–¹æ³•ä¸èƒ½è¢«finalä¿®é¥°</p><h2 id="finalä¿®é¥°ç±»"><a class="header-anchor" href="#finalä¿®é¥°ç±»"></a>finalä¿®é¥°ç±»</h2><p>finalä¿®é¥°ç±»è¡¨ç¤ºè¿™ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œåœ¨ä½¿ç”¨finalæ—¶ï¼Œä¸€å®šè¦å†™ä¸ºä»€ä¹ˆè¯¥ç±»ä¸€å®šè¦è¢«finalè¿›è¡Œä¿®é¥°çš„åŸå› ã€‚</p><h2 id="stringä¸ºä»€ä¹ˆè¢«è®¾è®¡æˆfinalç±»å‹çš„ï¼Ÿ"><a class="header-anchor" href="#stringä¸ºä»€ä¹ˆè¢«è®¾è®¡æˆfinalç±»å‹çš„ï¼Ÿ"></a>stringä¸ºä»€ä¹ˆè¢«è®¾è®¡æˆfinalç±»å‹çš„ï¼Ÿ</h2><h3 id="å¦‚ä½•å®ç°çš„ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å®ç°çš„ï¼Ÿ"></a>å¦‚ä½•å®ç°çš„ï¼Ÿ</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span><span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Stable</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>é€šè¿‡<strong>finalä¿®é¥°ç±»</strong>å’Œ<strong>finalä¿®é¥°byte[]</strong> æ¥ä¿è¯çš„</p></blockquote><h4 id="finalå¸¦æ¥çš„å¥½å¤„ï¼Ÿ"><a class="header-anchor" href="#finalå¸¦æ¥çš„å¥½å¤„ï¼Ÿ"></a>finalå¸¦æ¥çš„å¥½å¤„ï¼Ÿ</h4><blockquote><p>ç”±äºå­—ç¬¦ä¸²åœ¨ç¨‹åºä¸­æ˜¯æœ€å¸¸å‡ºç°çš„ï¼Œå› æ­¤åœ¨jvmçš„è§„èŒƒä¸­åˆ’å®šæ¥ä¸€ç‰‡åŒºåŸŸä½œä¸ºå­—ç¬¦ä¸²ç¼“å†²åŒº<strong>å¸¸é‡æ± </strong>ï¼Œä¹Ÿæ˜¯ç”±äºè¿™ä¸ªç‰¹ç‚¹ï¼Œåœ¨å­—ç¬¦ä¸²ç¼“å†²åŒºå†…çš„å¼•ç”¨å…³ç³»è¢«è®¾è®¡æˆä¸å¯å˜çš„ã€‚</p></blockquote><blockquote><p>å¯ä»¥ä¼˜å…ˆä½œä¸ºMapçš„keyè¿›è¡Œä½¿ç”¨ï¼Œå› ä¸ºmapçš„keyéœ€è¦è¿›è¡Œhashè¿ç®—ï¼Œå¦‚æœå¯å˜å°±ä¼šå¯¼è‡´å°†valueæ”¾åˆ°å…¶ä»–ä½ç½®ä¸Šã€‚</p></blockquote><p><img src="https://s1.ax1x.com/2020/05/02/JjJ4hj.png" alt="JjJ4hj.png"></p><blockquote><p>çº¿ç¨‹å®‰å…¨ï¼Œç”±äºå­—ç¬¦ä¸²çš„ç‰¹ç‚¹æ˜¯å…¬ç”¨çš„ï¼Œå› æ­¤åœ¨å¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ°ï¼Œå› æ­¤é‡‡ç”¨finalè®¾è®¡æˆä¸ºä¸å¯å˜çš„ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> final </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMåŸºç¡€åŸç†</title>
      <link href="2020/05/04/12.JVM/1.JVM%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"/>
      <url>2020/05/04/12.JVM/1.JVM%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>JVMåŸºç¡€åŸç†</h1><h2 id="jvmåŸºç¡€"><a class="header-anchor" href="#jvmåŸºç¡€"></a>jvmåŸºç¡€</h2><h3 id="jvmæ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#jvmæ˜¯ä»€ä¹ˆï¼Ÿ"></a>jvmæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>jvmæ˜¯è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¸Šçš„æ‰§è¡Œ.classæ–‡ä»¶çš„è™šæ‹Ÿæœº</p><h3 id="jvmä¸æ“ä½œç³»ç»Ÿçš„å…³ç³»ï¼Ÿ"><a class="header-anchor" href="#jvmä¸æ“ä½œç³»ç»Ÿçš„å…³ç³»ï¼Ÿ"></a>jvmä¸æ“ä½œç³»ç»Ÿçš„å…³ç³»ï¼Ÿ</h3><p>ç›¸åŒç‚¹éƒ½æ˜¯å¯ä»¥æ‰§è¡Œå¯¹åº”çš„ç¨‹åº<br>ä¸åŒç‚¹æ˜¯jvmæ˜¯å¯æ‰§è¡Œclassæ–‡ä»¶ä¸æ“ä½œç³»ç»Ÿä¸­é—´çš„ä¸€å±‚ï¼ˆpsï¼šæŸäººè¯´è¿‡è®¡ç®—æœºä¸–ç•Œä¸­çš„é—®é¢˜å¦‚æœä¸€ä¸ªä¸­é—´å±‚ä¸èƒ½è§£å†³å°±å†åŠ ä¸€ä¸ªâ˜ºï¸ï¼‰</p><h3 id="jvmã€jdkã€jreä¹‹é—´çš„å…³ç³»ï¼Ÿ"><a class="header-anchor" href="#jvmã€jdkã€jreä¹‹é—´çš„å…³ç³»ï¼Ÿ"></a>jvmã€jdkã€jreä¹‹é—´çš„å…³ç³»ï¼Ÿ</h3><ul><li>jdk&gt;jre&gt;jvm&gt;æ“ä½œç³»ç»Ÿ</li></ul><p><img src="https://s1.ax1x.com/2020/05/02/JjvW4I.png" alt="JjvW4I.png"></p><h3 id="javaè™šæ‹Ÿæœºè§„èŒƒä¸Javaè¯­è¨€è§„èŒƒä¹‹é—´çš„å…³ç³»ï¼Ÿ"><a class="header-anchor" href="#javaè™šæ‹Ÿæœºè§„èŒƒä¸Javaè¯­è¨€è§„èŒƒä¹‹é—´çš„å…³ç³»ï¼Ÿ"></a>javaè™šæ‹Ÿæœºè§„èŒƒä¸Javaè¯­è¨€è§„èŒƒä¹‹é—´çš„å…³ç³»ï¼Ÿ</h3><p>javaè™šæ‹Ÿæœºè§„èŒƒæ˜¯å®šä¹‰æ‰§è¡Œ.classæ–‡ä»¶çš„è™šæ‹Ÿæœºçš„è§„èŒƒï¼›<br>javaè¯­è¨€è§„èŒƒæ˜¯å®šä¹‰javaæ–‡ä»¶çš„è§„èŒƒ</p><h2 id="jvmä¸­çš„å†…å­˜åˆ’åˆ†"><a class="header-anchor" href="#jvmä¸­çš„å†…å­˜åˆ’åˆ†"></a>jvmä¸­çš„å†…å­˜åˆ’åˆ†</h2><p>javaæ¯”cç­‰ç³»åˆ—çš„è¯­è¨€å¼•ä»¥ä¸ºè±ªçš„å°±æ˜¯å¼•å…¥æ¥è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä¸è®©ä½¿ç”¨è€…åœ¨å…³å¿ƒå†…å­˜çš„ç®¡ç†ã€‚</p><ul><li>å†…å­˜åˆ’åˆ†</li></ul><p><img src="https://s1.ax1x.com/2020/05/02/Jvwl01.png" alt="Jvwl01.png"></p><ol><li>å †åŒº</li><li>æ ˆåŒºï¼ˆæœ¬åœ°æ–¹æ³•æ ˆã€javaè™šæ‹Ÿæœºæ ˆï¼‰</li><li>ç¨‹åºè®¡æ•°å™¨</li><li>æœ¬åœ°å†…å­˜ï¼ˆå…ƒç©ºé—´ã€ç›´æ¥å†…å­˜ï¼‰</li></ol><h2 id="å †åŒº"><a class="header-anchor" href="#å †åŒº"></a>å †åŒº</h2><p>å †æ˜¯ä¸€ä¸ªç”±çº¿ç¨‹ä¹‹é—´å…±äº«çš„å†…å­˜åŒºåŸŸã€‚åŸºæœ¬ç±»å‹çš„å¯¹è±¡ä¼šä¸­æ ˆä¸Šè¿›è¡Œåˆ†é…ï¼Œè€Œæ™®é€šç±»å‹çš„å¯¹è±¡ä¼šæ ˆå †ä¸Šè¿›è¡Œåˆ†é…ã€‚ç”±äºæ ˆæ˜¯çº¿ç¨‹ç‹¬ç«‹çš„ï¼Œå› æ­¤å°±ä¸å­˜åœ¨å¹¶å‘é—®é¢˜</p><h2 id="æ ˆåŒº"><a class="header-anchor" href="#æ ˆåŒº"></a>æ ˆåŒº</h2><ul><li>è™šæ‹Ÿæœºæ ˆ</li></ul><p>Javaè™šæ‹Ÿæœºæ ˆæ˜¯åŸºäº<strong>çº¿ç¨‹</strong>çº§åˆ«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰<strong>ç‹¬ç«‹</strong>éƒ½è™šæ‹Ÿæœºæ ˆã€‚è™šæ‹Ÿæœºæ ˆçš„ä½œç”¨æ˜¯å­˜å‚¨<strong>æ ˆå¸§</strong>ï¼Œ<strong>æ ˆå¸§</strong>çš„ä½œç”¨æ˜¯æ˜¯ä¿å­˜æ¯ä¸ªçº¿ç¨‹å½“å‰è¿è¡Œæ–¹æ³•çš„çŠ¶æ€æˆ–å€¼ã€‚</p><p>æ ˆå€¼ä¸­åˆ†ä¸ºï¼š</p><ul><li>å±€éƒ¨å˜é‡è¡¨ï¼ˆç”¨äºå­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…å®šä¹‰çš„å±€éƒ¨å˜é‡ï¼‰</li><li>æ“ä½œæ•°æ ˆï¼ˆå­˜æ”¾æ–¹æ³•è¿è¡ŒæœŸé—´çš„æ“ä½œæ•°æˆ–ç»“æœï¼‰</li><li>åŠ¨æ€è¿æ¥ï¼ˆæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­çš„åŠ¨æ€è¿æ¥ï¼‰</li><li>æ–¹æ³•è¿”å›åœ°å€</li></ul><h2 id="ç¨‹åºè®¡æ•°å™¨"><a class="header-anchor" href="#ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h2><p>ç¨‹åºè®¡æ•°å™¨æ˜¯ç”¨æ¥æ ‡è®°å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºè¿è¡Œåˆ°å“ªäº†ä¸€è¡Œã€‚</p><h2 id="å…ƒæ•°æ®ç©ºé—´"><a class="header-anchor" href="#å…ƒæ•°æ®ç©ºé—´"></a>å…ƒæ•°æ®ç©ºé—´</h2><p><strong>å…ƒæ•°æ®ç©ºé—´</strong>æ˜¯JDK8ä¸­åˆ’åˆ†å‡ºæ¥çš„ï¼Œç”¨äºæ›¿ä»£JDK7å·²ç»ä¹‹å‰çš„<strong>PermåŒº(æ°¸ä¹…ä»£)</strong>ã€‚<br><strong>å…ƒæ•°æ®ç©ºé—´</strong>å­˜å‚¨<strong>classä¿¡æ¯</strong>ã€<strong>å¸¸é‡æ± </strong>ã€<strong>æ–¹æ³•æ•°æ®</strong>ã€<strong>æ–¹æ³•ä»£ç </strong>ç­‰ç­‰</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>jvmä¸­è¿è¡Œçš„å‚æ•°æ˜¯åœ¨<strong>æ ˆ</strong>ä¸Šçš„ä¿¡æ¯ï¼Œæ ˆä¸Šä¿å­˜çš„å¼•ç”¨æŒ‡å‘çš„æ˜¯<strong>å †</strong>ä¸­çš„å¯¹è±¡ï¼Œ<strong>ç±»ä¿¡æ¯</strong>ã€<strong>å¸¸é‡</strong>ç­‰ä¿¡æ¯åˆ™æ˜¯æ”¾åœ¨å…ƒæ•°æ®ç©ºé—´ä¸­ã€‚</p><h1>ç±»çš„åŠ è½½æœºåˆ¶</h1><h2 id="æµç¨‹"><a class="header-anchor" href="#æµç¨‹"></a>æµç¨‹</h2><blockquote><p>åŠ è½½ &gt; éªŒè¯ &gt; å‡†å¤‡ &gt; è§£æ &gt; åˆå§‹åŒ–</p></blockquote><p><cint>æ‰§è¡Œæ—¶æœºæ—©äº<int>,å› ä¸º<cint>åœ¨è£…è½½åˆ°å…ƒæ•°æ®åŒºæ—¶å°±è¿›è¡Œæ‰§è¡Œã€‚</p><h2 id="ç±»åŠ è½½å™¨"><a class="header-anchor" href="#ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h2><ul><li>Bootstrap ClassLoader</li></ul><blockquote><p>æœ€åº•å±‚çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½javaåº•å±‚ç±»çš„ç±»åŠ è½½å™¨</p></blockquote><ul><li>Extention ClassLoader</li></ul><blockquote><p>æ‰©å±•ç±»çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½lib/extä¸‹çš„æ–‡ä»¶</p></blockquote><ul><li>App ClassLoader</li></ul><blockquote><p>åº”ç”¨åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½<strong>classPath</strong>ä¸‹çš„æ–‡ä»¶</p></blockquote><ul><li>Custom ClassLoader</li></ul><blockquote><p>è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> jvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dubboå¸¸è§é—®é¢˜å½’çº³</title>
      <link href="2020/04/24/8.duboo%E7%AC%94%E8%AE%B0/99.dubbo%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%BD%92%E7%BA%B3/"/>
      <url>2020/04/24/8.duboo%E7%AC%94%E8%AE%B0/99.dubbo%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%BD%92%E7%BA%B3/</url>
      
        <content type="html"><![CDATA[<h1>dubboå¸¸è§é—®é¢˜å½’çº³</h1><ol><li>dubboçš„å¯é€‰çš„é…ç½®æ–¹å¼ï¼Ÿ<br>å®˜ç½‘ä¸Šç»™å‡ºäº†å››ç§æ–¹å¼åˆ†åˆ«æ˜¯<strong>xmlé…ç½®</strong>ã€<strong>å±æ€§é…ç½®</strong>ã€<strong>æ³¨è§£é…ç½®</strong>ã€<strong>APIé…ç½®</strong></li></ol><blockquote><p>xmlé…ç½®:é€šè¿‡ä½¿ç”¨xmlé…ç½®æ–‡ä»¶çš„æ–¹å¼<br>é€šè¿‡åŠ è½½classPathè·¯å¾„ä¸‹çš„dubbo.propertiesæ–‡ä»¶<br>ä½¿ç”¨æ³¨è§£çš„é…ç½®æ–¹å¼<br>apiçš„æ–¹å¼ï¼ˆé€šè¿‡@PropertySourceåŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰</p></blockquote><ol start="2"><li>é…ç½®æ–‡ä»¶çš„è¦†ç›–å…³ç³»</li></ol><ul><li>ç»†å¤§äºç²—</li><li>æ¶ˆå¤§äºæ</li></ul><blockquote><p>ç»†ç²’åº¦çš„é…ç½®ä¼˜å…ˆçº§å¤§äºç²—ç²’åº¦çš„ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚æ–¹æ³•çº§ä¼˜å…ˆçº§å¤§äºæ¥å£çº§ï¼Œæ¥å£çº§å¤§äºå…¨å±€é…ç½®<br>æ¶ˆè´¹è€…ç«¯çš„é…ç½®ä¼˜å…ˆçº§å¤§äºç”Ÿäº§è€…</p></blockquote><ol start="3"><li>dubboçš„åˆ†å±‚è®¾è®¡<br>å¤§ä½“ä¸Šåˆ†ä¸ºä¸‰ä¸ªå¤§å±‚ï¼š</li><li>Bussiness</li><li>RPC</li><li>Remoting</li></ol><p>3.1 Bussiness</p><ul><li>service ä¸šåŠ¡å±‚</li></ul><blockquote><p>serviceæ¥å£å±‚ï¼Œæä¾›ç»™æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…è¿›è¡Œå®ç°</p></blockquote><p>3.2 RPC</p><blockquote><p>configé…ç½®å±‚,åŠ è½½dubboçš„é…ç½®ä¿¡æ¯<br>proxyä»£ç†å±‚ï¼Œå¯¹bussinesså±‚ç”Ÿæˆä»£ç†å¯¹è±¡<br>registryæ³¨å†Œå±‚ï¼Œè´Ÿè´£æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°<br>clusterè·¯ç”±å±‚ï¼Œå¯¹åŒä¸€ä¸ªæœåŠ¡å¤šä¸ªå®ä¾‹è¿›è¡Œè·¯ç”±<br>monitorç›‘æ§å±‚ï¼Œå¯ä»¥å¯¹rpcæ¥å£çš„è°ƒç”¨æ¬¡æ•°å’Œæ—¶é—´è¿›è¡Œç›‘æ§<br>protocolè¿œç¨‹è°ƒç”¨å±‚ï¼Œç”¨äºå°è£…RPCè°ƒç”¨</p></blockquote><p>3.3 Remoting</p><blockquote><p>exchangeä¿¡æ¯äº¤æ¢å±‚ï¼Œå°è£…è¯·æ±‚çš„å“åº”æ¨¡å¼ï¼Œå¼‚æ­¥è½¬åŒæ­¥<br>transportç½‘ç»œä¼ è¾“å±‚,æŠ½è±¡å‡ºç½‘ç»œé€šä¿¡æ–¹æ¡ˆ<br>seriallzeåºåˆ—åŒ–å±‚</p></blockquote><ol start="4"><li>dubboçš„è°ƒç”¨æµç¨‹</li></ol><ul><li>Provider</li><li>ç¬¬0æ­¥ï¼š å¯åŠ¨serviceæœåŠ¡</li><li>ç¬¬1æ­¥ï¼š å°†æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ</li><li>Consumer</li><li>ç¬¬2æ­¥ï¼š å‘æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨å¹¶ä¿æŒè¿æ¥ä»¥è·å–æœ€æ–°çš„æœåŠ¡åˆ—è¡¨ï¼ˆè¿˜ä¼šå°†æœåŠ¡åˆ—è¡¨ä¿å­˜åœ¨æœ¬åœ°ï¼‰</li><li>invoke</li><li>ç¬¬3æ­¥: Consumeré€šè¿‡æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡åå‘Providerå‘èµ·è¿œç¨‹å¼‚æ­¥è°ƒç”¨</li><li>ç¬¬4æ­¥: provideæ¥å—åˆ°è¯·æ±‚åæ‰§è¡Œï¼Œå¹¶ä¸”å°†æ‰§è¡Œç»“æœè¿”å›</li><li>monitor</li><li>ç¬¬5æ­¥: provide/consumerä¼šå°†è°ƒç”¨ä¿¡æ¯å‘é€ç»™monitorè¿›è¡Œç»Ÿè®¡</li></ul><ol start="5"><li>dubboè°ƒç”¨é“¾ï¼Ÿ</li></ol>]]></content>
      
      
      <categories>
          
          <category> dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLæ•°æ®åº“äº‹åŠ¡æµ…æ</title>
      <link href="2020/02/29/6.mysql/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E6%B5%85%E6%9E%90/"/>
      <url>2020/02/29/6.mysql/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E6%B5%85%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>æ•°æ®åº“äº‹åŠ¡ç†è§£</h1><p>æ•°æ®åº“äº‹åŠ¡æ˜¯ä¸€ç§æœ¬åœ°çš„åˆšæ€§äº‹åŠ¡ï¼Œç‰¹ç‚¹æ˜¯å¿…é¡»æ”¯æŒâ€™ACIDâ€™å››ä¸ªç‰¹æ€§</p><h2 id="ACIDç†è®º"><a class="header-anchor" href="#ACIDç†è®º"></a><strong>ACID</strong>ç†è®º</h2><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>åŸå­æ€§(Atomicity)</td><td>æŒ‡çš„æ˜¯åœ¨äº‹åŠ¡æ˜¯æœ€å°çš„ä¸å¯åˆ†å‰²çš„æ‰§è¡Œå•å…ƒï¼Œäº‹åŠ¡å†…çš„æ“ä½œè¦ä¹ˆéƒ½<B>æˆåŠŸ</B>ï¼Œè¦ä¹ˆéƒ½<B>å¤±è´¥</B></td></tr><tr><td>ä¸€è‡´æ€§(Consistency)</td><td>æŒ‡çš„æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œå‰åæ•°æ®ä¸Šçš„å®Œæ•´æ€§ä¿å­˜ä¸€è‡´ï¼Œä¸ä¼šå› ä¸ºæ•°æ®åº“äº‹åŠ¡çš„æ‰§è¡Œç»“æœ(æˆåŠŸ/å¤±è´¥)è€Œæ”¹å˜æ•°æ®åœ¨ä¸šåŠ¡æ¨¡å‹ä¸Šçš„å®Œæ•´æ€§</td></tr><tr><td>éš”ç¦»æ€§(isolation)</td><td>æŒ‡çš„æ˜¯æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰å•ç‹¬çš„æ“ä½œç©ºé—´ï¼Œä¸èƒ½åœ¨äº‹åŠ¡æœŸé—´ç›¸äº’å½±å“</td></tr><tr><td>æŒä¹…æ€§(Durability)</td><td>æŒ‡çš„æ˜¯äº‹åŠ¡å®Œæˆåå¯¹æ•°æ®åº“çš„æ”¹å˜æ˜¯ä»¥è½ç›˜ç»“æŸçš„</td></tr></tbody></table><h2 id="æ•°æ®åº“çš„éš”ç¦»çº§åˆ«"><a class="header-anchor" href="#æ•°æ®åº“çš„éš”ç¦»çº§åˆ«"></a>æ•°æ®åº“çš„éš”ç¦»çº§åˆ«</h2><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>æè¿°</th></tr></thead><tbody><tr><td>Read Uncommitted(æœªæäº¤è¯»)</td><td>èƒ½å¤Ÿè¯»å–åˆ°å…¶ä»–äº‹åŠ¡å°šæœªæäº¤çš„æ•°æ®</td></tr><tr><td>Read committed(è¯»å–å·²æäº¤å†…å®¹)</td><td>åªèƒ½è¯»å–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ï¼Œ</td></tr><tr><td>Repeatable Read(å¯é‡è¯»)</td><td>æŒ‡çš„æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ä»»æ„æ—¶é—´èŠ‚ç‚¹è¯»å–åˆ°çš„å†…å®¹ä¸€è‡´</td></tr><tr><td>Serializable(ä¸²è¡ŒåŒ–)</td><td>æŒ‡çš„æ˜¯äº‹åŠ¡æ˜¯ä»¥ä¸²è¡ŒåŒ–æ‰§è¡Œ</td></tr></tbody></table><h2 id="äº‹åŠ¡å¼‚å¸¸"><a class="header-anchor" href="#äº‹åŠ¡å¼‚å¸¸"></a>äº‹åŠ¡å¼‚å¸¸</h2><table><thead><tr><th>å¼‚å¸¸</th><th>æè¿°</th></tr></thead><tbody><tr><td>è„è¯»ï¼ˆDirty Readï¼‰</td><td>æŒ‡çš„æ˜¯è¯»åˆ°äº†æœªæäº¤çš„æ•°æ®</td></tr><tr><td>ä¸å¯é‡å¤è¯»ï¼ˆNot Repeatable Readï¼‰</td><td>æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå‰åè¯»å–åˆ°çš„æ•°æ®è¡Œä¸ä¸€è‡´</td></tr><tr><td>å¹»è¯»</td><td>æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è¯»å–åˆ°çš„æ•°æ®è¡Œä¸ä¸€è‡´</td></tr></tbody></table><ul><li>ä¸å¯é‡å¤è¯»æŒ‡çš„æ˜¯å¯¹æ•°æ®çš„<strong>åˆ é™¤</strong>ã€<strong>æ›´æ–°</strong>æ“ä½œ</li><li>å¹»è¯»æŒ‡çš„æ˜¯å¯¹æ•°æ®çš„<strong>inster</strong>æ“ä½œ</li></ul><h2 id="æ•°æ®åº“çš„éš”ç¦»çº§åˆ«-v2"><a class="header-anchor" href="#æ•°æ®åº“çš„éš”ç¦»çº§åˆ«-v2"></a>æ•°æ®åº“çš„éš”ç¦»çº§åˆ«</h2><ul><li>âˆšä¸ºä¼šå‘ç”Ÿï¼ŒÃ—ä¸ºä¸ä¼šå‘ç”Ÿ</li></ul><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td>read uncommittedï¼ˆæœªæäº¤è¯»ï¼‰</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>read committedï¼ˆæäº¤è¯»ï¼‰</td><td>x</td><td>âˆš</td><td>âˆš</td></tr><tr><td>repeatable readï¼ˆå¯é‡å¤è¯»ï¼‰</td><td>x</td><td>x</td><td>âˆš</td></tr><tr><td>serializationï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰</td><td>x</td><td>x</td><td>x</td></tr></tbody></table><h2 id="mysqlå®é™…æ“ä½œ"><a class="header-anchor" href="#mysqlå®é™…æ“ä½œ"></a>mysqlå®é™…æ“ä½œ</h2><ul><li>åˆå§‹åŒ–è¯­å¥</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token punctuation">`</span>num<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span><span class="token punctuation">,</span><span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>mysql8ä¹‹å‰ç‰ˆæœ¬</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@tx_isolation</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>mysql8</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@transaction_isolation</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>æŸ¥è¯¢ç»“æœ<br><img src="https://s2.ax1x.com/2020/03/01/3c8EEq.png" alt="æŸ¥è¯¢ç»“æœ"></li></ul><p>mysqlçš„é»˜è®¤äº‹åŠ¡æ˜¯<strong>REPEATABLE-READ</strong>-<B>å¯é‡å¤è¯»</B></p><h3 id="è„è¯»"><a class="header-anchor" href="#è„è¯»"></a>è„è¯»</h3><ul><li>è®¾ç½®éš”ç¦»çº§åˆ«ä¸º<strong>è¯»æœªæäº¤</strong>(read uncommitted)</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> <span class="token keyword">SESSION</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">READ</span> <span class="token keyword">UNCOMMITTED</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>Aäº‹åŠ¡</strong></p><ul><li>æŸ¥è¯¢æ•°æ®</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>ç»“æœ</li></ul><p><img src="https://s2.ax1x.com/2020/03/01/3cOI29.png" alt="æŸ¥è¯¢ç»“æœ"></p><p><strong>Bäº‹åŠ¡</strong></p><ul><li>æ’å…¥æ•°æ®</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span> <span class="token punctuation">;</span><span class="token keyword">INSERT</span> test <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>Aäº‹åŠ¡</strong></p><ul><li>æŸ¥è¯¢æ•°æ®</li></ul><p><img src="https://s2.ax1x.com/2020/03/01/3gxwH1.png" alt="æŸ¥è¯¢ç»“æœ"></p><p><strong>æ­¤æ—¶å°±è¯»å–åˆ°äº†æœªæäº¤çš„æ•°æ®</strong></p><p><strong>Bäº‹åŠ¡</strong></p><ul><li>å›æ»šäº‹åŠ¡</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>Aäº‹åŠ¡</strong></p><ul><li>æŸ¥è¯¢æ•°æ®<br><img src="https://s2.ax1x.com/2020/03/01/32Kr5T.png" alt="æŸ¥è¯¢ç»“æœ"></li></ul><h3 id="ä¸å¯é‡å¤è¯»"><a class="header-anchor" href="#ä¸å¯é‡å¤è¯»"></a>ä¸å¯é‡å¤è¯»</h3><ul><li>ç»“æœ<br><img src="https://s2.ax1x.com/2020/03/01/32lyPf.png" alt="æŸ¥è¯¢ç»“æœ"></li></ul><p>çº¿ç¨‹ä¸èƒ½è¯»å–åˆ°å…¶ä»–çº¿ç¨‹å°šæœªæäº¤çš„æ•°æ®</p><h3 id="å¯é‡å¤è¯»"><a class="header-anchor" href="#å¯é‡å¤è¯»"></a>å¯é‡å¤è¯»</h3><p><img src="https://s2.ax1x.com/2020/03/01/321bkt.png" alt="å¯é‡å¤è¯»æŸ¥è¯¢ç»“æœ"></p><p>ä¸Šå›¾å±•ç¤ºäº†åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¯»å–ä¸ç®¡Bäº‹åŠ¡æ˜¯å¦æäº¤ï¼ŒAäº‹åŠ¡è¯»å–çš„æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><ul><li>å¹»è¯»å±•ç¤º<br><img src="https://s2.ax1x.com/2020/03/01/32tbkj.png" alt="å¯é‡å¤è¯»æŸ¥è¯¢ç»“æœ"></li></ul><p>å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«è™½ç„¶ä¿è¯äº†åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå‰åè¯»å–æ•°æ®ä¸€è‡´ï¼Œå½“æ—¶åœ¨æ’å…¥æ—¶ï¼Œç”±äºæ˜¯<strong>è¡¨çº§é”</strong>å› æ­¤æ•°æ®ä¼šç­‰å¾…ä¹‹å‰çš„äº‹åŠ¡æäº¤å®Œæˆåå†æ‰§è¡Œï¼Œå› æ­¤å‡ºç°å¼‚å¸¸ã€‚</p><blockquote><p>å‚è€ƒæ–‡æ¡£</p></blockquote><ul><li><a href="https://blog.csdn.net/Vincent2014Linux/article/details/89669762">å¿«é€Ÿç†è§£è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»</a></li><li><a href="https://blog.csdn.net/qq_22115231/article/details/80767069">æ•°æ®åº“çš„å››ç§äº‹ç‰©éš”ç¦»çº§åˆ«</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitå¤šç¯å¢ƒé…ç½®</title>
      <link href="2020/02/21/git%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>2020/02/21/git%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>ç–«æƒ…æœŸé—´ï¼Œéœ€è¦åœ¨å®¶è¿œç¨‹åŠå…¬ï¼Œå› æ­¤éœ€è¦åœ¨ç”µè„‘ä¸Šé…ç½®ä¸¤å¥—gitç¯å¢ƒåˆ†åˆ«æ˜¯githubã€gitlabçš„ã€‚åœ¨é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›é˜»ç¢ï¼Œç‰¹æ­¤è®°å½•ä¸‹æ¥ã€‚</p><h3 id="æ­¥éª¤ä¸€ï¼šç”ŸæˆSSH-Key"><a class="header-anchor" href="#æ­¥éª¤ä¸€ï¼šç”ŸæˆSSH-Key"></a>æ­¥éª¤ä¸€ï¼šç”ŸæˆSSH-Key</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen -t rsa -C <span class="token string">"email@xx.com"</span> -f ~/.ssh/id_rsa <span class="token comment">#(æˆ–gitlab_rsa)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…¶ä¸­email@xx.comä¸ºgithubæˆ–gitlabæ³¨å†Œçš„é‚®ç®±<br>id_rsaæˆ–gitlab_rsaä¸ºç”Ÿæˆkeyæ–‡ä»¶çš„åç§°ï¼Œé»˜è®¤ä¸ºid_rsaï¼Œä½¿ç”¨åˆ«åæ—¶éœ€è¦è¿›è¡Œæ­¥éª¤ä¸‰</p><ul><li>åˆ†åˆ«ç”Ÿæˆgithubå’Œgitlaçš„SSH-key</li></ul><h3 id="æ­¥éª¤äºŒï¼šè®¾ç½®Serverç«¯å…¬é’¥"><a class="header-anchor" href="#æ­¥éª¤äºŒï¼šè®¾ç½®Serverç«¯å…¬é’¥"></a>æ­¥éª¤äºŒï¼šè®¾ç½®Serverç«¯å…¬é’¥</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token comment">#(æˆ–gitlab_rsa)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°†è·å–åˆ°çš„å…¬é’¥è®¾ç½®åˆ°gitæœåŠ¡ç«¯ï¼Œä¹Ÿå¯ä»¥ç”¨ç¼–è¾‘å™¨æ‰“å¼€~/.ssh/id_rsa.pub(æˆ–gitlab_rsa)å°†å€¼å¤åˆ¶è®¾ç½®åˆ°gitæœåŠ¡ç«¯</p><h3 id="æ­¥éª¤ä¸‰ï¼šæ·»åŠ ç§é’¥"><a class="header-anchor" href="#æ­¥éª¤ä¸‰ï¼šæ·»åŠ ç§é’¥"></a>æ­¥éª¤ä¸‰ï¼šæ·»åŠ ç§é’¥</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-add ~/.ssh/id_rsa <span class="token comment">#(æˆ–gitlab_rsa)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ†åˆ«æ·»åŠ ä¸åŒç¯å¢ƒçš„ç§é’¥</p><h3 id="æ­¥éª¤ä¸‰ï¼šé…ç½®å¤šç¯å¢ƒçš„config"><a class="header-anchor" href="#æ­¥éª¤ä¸‰ï¼šé…ç½®å¤šç¯å¢ƒçš„config"></a>æ­¥éª¤ä¸‰ï¼šé…ç½®å¤šç¯å¢ƒçš„config</h3><p>åœ¨.ssh/ä¸‹åˆ›å»ºconfigæ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># github</span>Host github.com    HostName github.com    PreferredAuthentications publickey    IdentityFile ~/.ssh/id_rsa<span class="token comment"># gitlab</span>Host gitlab.com    HostName gitlab.com    PreferredAuthentications publickey    IdentityFile ~/.ssh/gitlab_rsa<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ­¥éª¤å››ï¼šæµ‹è¯•"><a class="header-anchor" href="#æ­¥éª¤å››ï¼šæµ‹è¯•"></a>æ­¥éª¤å››ï¼šæµ‹è¯•</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> -T git@github.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½¿ç”¨å‘½ä»¤è¿›è¡Œæµ‹è¯•</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Hi userName<span class="token operator">!</span> You've successfully authenticated, but GitHub does not provide shell access.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ ·çš„æç¤ºè¡¨ç¤ºæˆåŠŸ</p><h3 id="å¼‚å¸¸å¤„ç†"><a class="header-anchor" href="#å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h3><ul><li><a href="mailto:git@github.com">git@github.com</a>: Permission denied (publickey).<br>1.æ˜¯å¦ä¿®æ”¹è¿‡github.comçš„host<br>2.æ˜¯å¦æ·»åŠ ç§é’¥</li></ul><h3 id="å‚è€ƒ"><a class="header-anchor" href="#å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://my.oschina.net/stefanzhlg/blog/529403">git é…ç½®å¤šä¸ªSSH-Key</a><br><a href="https://www.cnblogs.com/lxwphp/p/7884700.html">è§£å†³Permission denied (publickey).</a></p>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¯å¢ƒé…ç½® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Arthasåˆæ¢--å®‰è£…åˆæ­¥é€‚ç”¨</title>
      <link href="2019/07/29/1.%E6%9D%82%E8%AE%B0/Arthas%E5%88%9D%E6%8E%A2-%E5%AE%89%E8%A3%85%E5%88%9D%E6%AD%A5%E9%80%82%E7%94%A8/"/>
      <url>2019/07/29/1.%E6%9D%82%E8%AE%B0/Arthas%E5%88%9D%E6%8E%A2-%E5%AE%89%E8%A3%85%E5%88%9D%E6%AD%A5%E9%80%82%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1>Arthasåˆæ¢â€“å®‰è£…åˆæ­¥é€‚ç”¨</h1><p>ç”±äºåœ¨é¡¹ç›®ä¸­é‡åˆ°ä¸€ç§æƒ…å†µï¼ŒæŸæ®µä»£ç åœ¨è¿›è¡Œå•å…ƒæµ‹è¯•å’Œåœ¨tomcatå®¹å™¨ä¸­è¿è¡Œçš„æ€§èƒ½ç›¸å·®æ•°ç™¾å€ï¼Œå› æ­¤éœ€è¦åˆ†æåœ¨ä¸åŒç¯å¢ƒä¸‹æŸä¸ªæ–¹æ³•æ‰§è¡Œçš„å…·ä½“æ—¶é—´ï¼Œä»è€Œç¡®å®šé—®é¢˜ã€‚Arthaså¯ä»¥åšåˆ°æ— ä¾µå…¥çš„ç›‘æ§åº”ç”¨è¿œè¡Œæƒ…å†µã€‚</p><h2 id="å®‰è£…"><a class="header-anchor" href="#å®‰è£…"></a>å®‰è£…</h2><p>githupé¡¹ç›®åœ°å€ï¼š<strong><a href="https://github.com/alibaba/arthas">https://github.com/alibaba/arthas</a></strong><br>æ–‡æ¡£åœ°å€ï¼š<strong><a href="https://alibaba.github.io/arthas/">https://alibaba.github.io/arthas/</a></strong></p><p>å®‰è£…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://alibaba.github.io/arthas/arthas-boot.jarjava -jar arthas-boot.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>linuxä¸‹ç›´æ¥æ‰§è¡Œï¼Œwindowä¸‹è½½æ–‡ä»¶åæ‰§è¡Œ</p><p><img src="https://img-blog.csdnimg.cn/20190630153613103.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ‰§è¡Œå®Œæˆåï¼Œæ˜¾ç¤ºå½“å‰pathä¸­æŒ‡å®šçš„JDKä¸­æ­£åœ¨è¿è¡Œçš„javaè¿›ç¨‹<br>è¾“å…¥ç›¸åº”åºå·,è¿›å…¥shå‘½ä»¤ï¼Œè¡¨ç¤ºå·²è¿æ¥æˆåŠŸ<br><img src="https://img-blog.csdnimg.cn/2019063015385964.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAwMjk0Mzc=,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="åˆæ­¥ä½¿ç”¨"><a class="header-anchor" href="#åˆæ­¥ä½¿ç”¨"></a>åˆæ­¥ä½¿ç”¨</h2><p>Arthaså‘½ä»¤åˆæ­¥ä½¿ç”¨ï¼Œå¤§æ¦‚åˆ†ä¸º5ç±»ï¼š</p><h3 id="åŸºç¡€å‘½ä»¤"><a class="header-anchor" href="#åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h3><ul><li>helpâ€”â€”æŸ¥çœ‹å‘½ä»¤å¸®åŠ©ä¿¡æ¯</li><li>catâ€”â€”æ‰“å°æ–‡ä»¶å†…å®¹ï¼Œå’Œlinuxé‡Œçš„catå‘½ä»¤ç±»ä¼¼</li><li>pwdâ€”â€”è¿”å›å½“å‰çš„å·¥ä½œç›®å½•ï¼Œå’Œlinuxå‘½ä»¤ç±»ä¼¼</li><li>clsâ€”â€”æ¸…ç©ºå½“å‰å±å¹•åŒºåŸŸ</li><li>sessionâ€”â€”æŸ¥çœ‹å½“å‰ä¼šè¯çš„ä¿¡æ¯</li><li>resetâ€”â€”é‡ç½®å¢å¼ºç±»ï¼Œå°†è¢« Arthas å¢å¼ºè¿‡çš„ç±»å…¨éƒ¨è¿˜åŸï¼ŒArthas æœåŠ¡ç«¯å…³é—­æ—¶ä¼šé‡ç½®æ‰€æœ‰å¢å¼ºè¿‡çš„ç±»</li><li>versionâ€”â€”è¾“å‡ºå½“å‰ç›®æ ‡ Java è¿›ç¨‹æ‰€åŠ è½½çš„ Arthas ç‰ˆæœ¬å·</li><li>historyâ€”â€”æ‰“å°å‘½ä»¤å†å²</li><li>quitâ€”â€”é€€å‡ºå½“å‰ Arthas å®¢æˆ·ç«¯ï¼Œå…¶ä»– Arthas å®¢æˆ·ç«¯ä¸å—å½±å“</li><li>shutdownâ€”â€”å…³é—­ Arthas æœåŠ¡ç«¯ï¼Œæ‰€æœ‰ Arthas å®¢æˆ·ç«¯å…¨éƒ¨é€€å‡º</li><li>keymapâ€”â€”Arthaså¿«æ·é”®åˆ—è¡¨åŠè‡ªå®šä¹‰å¿«æ·é”®</li></ul><h3 id="jvmç›¸å…³"><a class="header-anchor" href="#jvmç›¸å…³"></a>jvmç›¸å…³</h3><ul><li>dashboardâ€”â€”å½“å‰ç³»ç»Ÿçš„å®æ—¶æ•°æ®é¢æ¿</li><li>threadâ€”â€”æŸ¥çœ‹å½“å‰ JVM çš„çº¿ç¨‹å †æ ˆä¿¡æ¯</li><li>jvmâ€”â€”æŸ¥çœ‹å½“å‰ JVM çš„ä¿¡æ¯</li><li>syspropâ€”â€”æŸ¥çœ‹å’Œä¿®æ”¹JVMçš„ç³»ç»Ÿå±æ€§</li><li>sysenvâ€”â€”æŸ¥çœ‹JVMçš„ç¯å¢ƒå˜é‡</li><li>getstaticâ€”â€”æŸ¥çœ‹ç±»çš„é™æ€å±æ€§</li><li>New! ognlâ€”â€”æ‰§è¡Œognlè¡¨è¾¾å¼</li><li>New! mbeanâ€”â€”æŸ¥çœ‹ Mbean çš„ä¿¡æ¯</li></ul><h3 id="class-classloaderç›¸å…³"><a class="header-anchor" href="#class-classloaderç›¸å…³"></a>class/classloaderç›¸å…³</h3><ul><li>scâ€”â€”æŸ¥çœ‹JVMå·²åŠ è½½çš„ç±»ä¿¡æ¯</li><li>smâ€”â€”æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯</li><li>jadâ€”â€”åç¼–è¯‘æŒ‡å®šå·²åŠ è½½ç±»çš„æºç </li><li>mcâ€”â€”å†…å­˜ç¼–ç»å™¨ï¼Œå†…å­˜ç¼–ç».javaæ–‡ä»¶ä¸º.classæ–‡ä»¶</li><li>redefineâ€”â€”åŠ è½½å¤–éƒ¨çš„.classæ–‡ä»¶ï¼Œredefineåˆ°JVMé‡Œ</li><li>dumpâ€”â€”dump å·²åŠ è½½ç±»çš„ byte code åˆ°ç‰¹å®šç›®å½•</li><li>classloaderâ€”â€”æŸ¥çœ‹classloaderçš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯ï¼Œä½¿ç”¨classloaderå»getResource</li></ul><h3 id="monitor-watch-traceç›¸å…³"><a class="header-anchor" href="#monitor-watch-traceç›¸å…³"></a>monitor/watch/traceç›¸å…³</h3><p>è¯·æ³¨æ„ï¼Œè¿™äº›å‘½ä»¤ï¼Œéƒ½é€šè¿‡å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¥å®ç°çš„ï¼Œä¼šåœ¨æŒ‡å®šç±»çš„æ–¹æ³•ä¸­æ’å…¥ä¸€äº›åˆ‡é¢æ¥å®ç°æ•°æ®ç»Ÿè®¡å’Œè§‚æµ‹ï¼Œå› æ­¤åœ¨çº¿ä¸Šã€é¢„å‘ä½¿ç”¨æ—¶ï¼Œè¯·å°½é‡æ˜ç¡®éœ€è¦è§‚æµ‹çš„ç±»ã€æ–¹æ³•ä»¥åŠæ¡ä»¶ï¼Œè¯Šæ–­ç»“æŸè¦æ‰§è¡Œ shutdown æˆ–å°†å¢å¼ºè¿‡çš„ç±»æ‰§è¡Œ reset å‘½ä»¤ã€‚</p><ul><li>monitorâ€”â€”æ–¹æ³•æ‰§è¡Œç›‘æ§</li><li>watchâ€”â€”æ–¹æ³•æ‰§è¡Œæ•°æ®è§‚æµ‹</li><li>traceâ€”â€”æ–¹æ³•å†…éƒ¨è°ƒç”¨è·¯å¾„ï¼Œå¹¶è¾“å‡ºæ–¹æ³•è·¯å¾„ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè€—æ—¶</li><li>stackâ€”â€”è¾“å‡ºå½“å‰æ–¹æ³•è¢«è°ƒç”¨çš„è°ƒç”¨è·¯å¾„</li><li>ttâ€”â€”æ–¹æ³•æ‰§è¡Œæ•°æ®çš„æ—¶ç©ºéš§é“ï¼Œè®°å½•ä¸‹æŒ‡å®šæ–¹æ³•æ¯æ¬¡è°ƒç”¨çš„å…¥å‚å’Œè¿”å›ä¿¡æ¯ï¼Œå¹¶èƒ½å¯¹è¿™äº›ä¸åŒçš„æ—¶é—´ä¸‹è°ƒç”¨è¿›è¡Œè§‚æµ‹</li></ul><h3 id="options"><a class="header-anchor" href="#options"></a>options</h3><ul><li>optionsâ€”â€”æŸ¥çœ‹æˆ–è®¾ç½®Arthaså…¨å±€å¼€å…³</li></ul><h2 id="ä½¿ç”¨å®åˆ—"><a class="header-anchor" href="#ä½¿ç”¨å®åˆ—"></a>ä½¿ç”¨å®åˆ—</h2><ul><li><p>trace åˆ†ææ¯ä¸ªæ–¹æ³•çš„å…·ä½“æ‰§è¡Œæ—¶é—´<br><img src="https://img-blog.csdnimg.cn/20190630154629460.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAwMjk0Mzc=,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>é€šè¿‡å›¾ç¤ºè¡¨æ˜è°ƒç”¨MongoTemplate.executeFindMultiInternal()æ–¹æ³•æ—¶ï¼Œæœ€è€—æ—¶çš„æ–¹æ³•æ˜¯åœ¨doWith()æ–¹æ³•ï¼Œæ€»å…±æ‰§è¡Œ10000æ¬¡ï¼Œè€—æ—¶==252.3064ms==,æœ€å°‘ä¸€æ¬¡è°ƒç”¨è€—æ—¶==0.0132ms==ï¼Œæœ€å¤§ä¸€æ¬¡è€—æ—¶==38.4329ms==ï¼Œåˆ†æåŸå› è¿˜æ˜¯åœ¨äºæ•°æ®é‡å¤ªå¤§ï¼ŒMongoTemplateé€šè¿‡å¾ªç¯éå†å‡ºç»“æœåœ¨è¿›è¡Œåºåˆ—åŒ–ã€‚</p></li><li><p>jad åç¼–è¯‘ä»£ç å·¥å…·</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">jad com.sankuai.inf.leaf.common.ZeroIDGen<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://s1.ax1x.com/2020/07/28/aVeudO.png" alt="aVeudO.png"></p><ul><li>watch æŸ¥çœ‹è¾“å…¥å‚æ•°ä¸è¾“å‡ºå‚æ•°</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">watch</span> com.sankuai.inf.leaf.server.service.SegmentService getId <span class="token string">'&#123;params, target, returnObj&#125;'</span> -x <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p><strong>params</strong>è¡¨ç¤ºå…¥å‚ï¼Œ<strong>target</strong>è¡¨ç¤ºå½“å‰çš„ç±»ï¼Œ<strong>returnObj</strong>è¡¨ç¤ºè¿”å›å€¼</p></blockquote><p><img src="https://s1.ax1x.com/2020/07/28/aVmDAO.png" alt="aVmDAO.png"></p><ul><li>stack æŸ¥çœ‹è¢«è°ƒç”¨çš„è·¯å¾„(å‘ä¸Š)</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">stack com.sankuai.inf.leaf.server.service.SegmentService getId<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://s1.ax1x.com/2020/07/28/aVKIUK.png" alt="aVKIUK.png"></p><ul><li>sc æŸ¥çœ‹JVMå·²åŠ è½½çš„ç±»ä¿¡æ¯</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sc -d com.sankuai.inf.leaf.server.service.SegmentService getId<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://s1.ax1x.com/2020/07/28/aVMArn.png" alt="aVMArn.png"></p><ul><li>thread åˆ†ææ­»é”</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">thread b<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://s1.ax1x.com/2020/04/29/JHNalT.png" alt="JHNalT.png"></p><p><img src="https://s1.ax1x.com/2020/04/30/JHUuNR.png" alt="JHUuNR.png"></p><p>å¯ä»¥çœ‹å‡ºå½“å‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…<strong>ReentrantLock$NonfairSync@118f1fb4</strong>ï¼Œè€ŒæŒæœ‰è¿™ä¸ªå¯¹è±¡çš„çº¿ç¨‹åˆåœ¨ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾ï¼Œä»è€Œå½¢æˆæ­»é”!</p><ul><li>thread åˆ†æCPUå ç”¨</li></ul><p><img src="https://s1.ax1x.com/2020/04/30/JH0HQx.png" alt="JH0HQx.png"></p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>å…ˆæ”¾ä¸€å¼ å®˜æ–¹çš„æ€»ç»“å¤§å›¾<br><a href="https://imgchr.com/i/JHBSfA"><img src="https://s1.ax1x.com/2020/04/30/JHBSfA.png" alt="JHBSfA.png"></a></p><p>æ€»ç»“ï¼šArthasæ˜¯ä¸€ä¸ªå¾ˆä¼˜ç§€çš„javaè¯Šæ–­å·¥å…·ï¼Œæ— è®ºæ˜¯å®‰è£…è¿˜æ˜¯ä½¿ç”¨éƒ½å¾ˆç®€æ´ï¼Œå¹¶ä¸”ä½¿ç”¨æ–‡æ¡£å…¨é¢ã€æ¸…æ™°æ˜äº†ï¼Œå€¼å¾—å¥½å¥½ç ”ç©¶ä¸€ç•ªã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> arthas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†å¸ƒå¼äº‹åŠ¡ç†è§£</title>
      <link href="2019/06/28/1.%E6%9D%82%E8%AE%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%80%9D%E8%80%83/"/>
      <url>2019/06/28/1.%E6%9D%82%E8%AE%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<h1>åˆ†å¸ƒå¼äº‹åŠ¡ç†è§£</h1><p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¸ºäº†è§£å†³åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œä¸šåŠ¡æ•°æ®åœ¨è·¨è¿›ç¨‹æ‰§è¡Œæ—¶ï¼Œéœ€è¦ä¿è¯ä¸šåŠ¡çš„äº‹åŠ¡æ€§ã€‚<br>åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ä¸»è¦æœ‰<strong>Seata</strong>ã€<strong>atomikos</strong>ã€<strong>TX-LCN</strong>ã€‚å…¶ä»–æ–¹å¼å¤„ç†æˆ‘ç›®å‰å·²çŸ¥çš„æœ‰é€šè¿‡mqçš„æ–¹å¼(å¾…ç ”ç©¶);</p><h2 id="åŸºæœ¬åŸç†"><a class="header-anchor" href="#åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><ul><li>CAPå®šç†</li><li>BASEç†è®º</li><li>ACIDç†è®º</li></ul><h3 id="CAPç†è®º"><a class="header-anchor" href="#CAPç†è®º"></a>CAPç†è®º</h3><p>CAPç†è®ºæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ— æ³•åŒæ—¶æ»¡è¶³Consistency(ä¸€è‡´æ€§)ã€Availability(å¯ç”¨æ€§)ã€Partition tolerance(åˆ†åŒºå®¹é”™æ€§)</p><ul><li>ä¸€è‡´æ€§(Consistency)æŒ‡çš„æ˜¯åŒä¸€æ—¶é—´ï¼Œä»»æ„èŠ‚ç‚¹ä¸‹çš„æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„</li><li>å¯ç”¨æ€§(Availability)æŒ‡çš„æ˜¯åŒä¸€æ—¶é—´ï¼Œä»»æ„èŠ‚ç‚¹å‡å¯è®¿é—®</li><li>åˆ†åŒºå®¹é”™æ€§(Partition tolerance)æŒ‡çš„æ˜¯æ•°æ®æ²¡æœ‰åœ¨ä¸€å®šçš„æ—¶é—´å†…å®Œæˆæ•°æ®çš„ä¸€è‡´æ€§</li></ul><p>ç”±äºç°æœ‰ç½‘ç»œæ¶æ„ï¼Œ<strong>åˆ†åŒºå®¹é”™æ€§</strong>ä¸€å®šå­˜åœ¨ã€‚å› æ­¤å®é™…ç³»ç»Ÿä¸­åªèƒ½å­˜åœ¨APæˆ–CPä¸¤ç§æƒ…å†µã€‚</p><h3 id="BASEç†è®º"><a class="header-anchor" href="#BASEç†è®º"></a>BASEç†è®º</h3><p>BASEç†è®ºæŒ‡çš„æ˜¯Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ã€Soft-stateï¼ˆ è½¯çŠ¶æ€/æŸ”æ€§äº‹åŠ¡ï¼‰ã€Eventual Consistencyï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚æ˜¯æ ¹æ®CAPç†è®ºæ¼”åŒ–è€Œæ¥çš„ï¼Œé€‚åˆäºå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é‚£ä¹ˆé«˜çš„ç³»ç»Ÿã€‚</p><ul><li>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰æŒ‡çš„æ˜¯å…è®¸ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœçš„é€‚åˆä¿è¯æ ¸å¿ƒä¸šåŠ¡å…è®¸è€ŒæŸå¤±ä¸€äº›å¯ç”¨æ€§</li><li>Soft-stateï¼ˆ è½¯çŠ¶æ€/æŸ”æ€§äº‹åŠ¡ï¼‰æŒ‡çš„æ˜¯å…è®¸ç³»ç»Ÿå­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„ä¸­é—´çŠ¶æ€</li><li>Eventual Consistencyï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰æŒ‡çš„æ˜¯ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å‰¯æœ¬ç»è¿‡ä¸€å®šæ—¶é—´åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</li></ul><h2 id="æŸ”æ€§äº‹åŠ¡"><a class="header-anchor" href="#æŸ”æ€§äº‹åŠ¡"></a>æŸ”æ€§äº‹åŠ¡</h2><p>æŸ”æ€§äº‹åŠ¡æŒ‡çš„æ˜¯æ•°æ®åº“ä¸­çš„äº‹åŠ¡æ»¡è¶³BASEç†è®ºè€Œä¸æ˜¯ACIDç†è®ºçš„äº‹åŠ¡ã€‚<br>ä¸»è¦æœ‰ä¸€ä¸‹å››ç§ï¼š</p><ul><li>ATæ¨¡å¼</li><li>TCCæ¨¡å¼</li><li>Sagaæ¨¡å¼</li><li>XAæ¨¡å¼</li></ul><h3 id="2é˜¶æ®µæäº¤"><a class="header-anchor" href="#2é˜¶æ®µæäº¤"></a>2é˜¶æ®µæäº¤</h3><p>åè°ƒè€…:</p><ol><li>è®©å‚ä¸è€…è¿›è¡Œæ‰§è¡Œäº‹åŠ¡</li></ol><p>å‚ä¸è€…:<br>2. æ‰§è¡Œäº‹åŠ¡,å°†ç»“æœè¿”å›åè°ƒè€…</p><p>åè°ƒè€…:<br>3. æ ¹æ®ç»“æœï¼Œå‘å‚ä¸è€…å‘é€commitæˆ–robackå‘½ä»¤</p><ul><li>äºŒé˜¶æ®µæäº¤çš„é—®é¢˜æ˜¯</li></ul><ol><li>å‚ä¸è€…é•¿æ—¶é—´lockèµ„æº</li><li>åè°ƒè€…å­˜åœ¨å•ç‚¹é—®é¢˜</li><li>commitå¯èƒ½ä¸æˆåŠŸ</li></ol><h3 id="3é˜¶æ®µæäº¤"><a class="header-anchor" href="#3é˜¶æ®µæäº¤"></a>3é˜¶æ®µæäº¤</h3><p>3é˜¶æ®µæäº¤ç›¸æ¯”äº2é˜¶æ®µæäº¤å¤šäº†ä»¥ä¸‹å‡ ä¸ªæ”¹è¿›</p><ol><li>å…è®¸è¶…æ—¶å–æ¶ˆ</li><li>å¢åŠ é¢„æäº¤é˜¶æ®µ</li></ol><h3 id="ATæ¨¡å¼"><a class="header-anchor" href="#ATæ¨¡å¼"></a>ATæ¨¡å¼</h3><p><strong>ATæ¨¡å¼</strong>ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol><li>äº‹åŠ¡å‘èµ·è€…æ‰§è¡Œä¸šåŠ¡sqlã€ä¿å­˜<strong>after image</strong>ã€<strong>before image</strong>ã€ç”Ÿæˆè¡Œçº§é”</li><li>æ ¹æ®åè°ƒè€…åˆ¤æ–­äº‹åŠ¡æ˜¯å¦æäº¤è¿˜æ˜¯å›æ»š</li></ol><h3 id="TCCæ¨¡å¼"><a class="header-anchor" href="#TCCæ¨¡å¼"></a>TCCæ¨¡å¼</h3><p><strong>TCCæ¨¡å¼</strong>ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol><li>try åšèµ„æºæ£€æŸ¥</li><li>1 Confirm æäº¤èµ„æº</li><li>2 Cancel å›æ»šèµ„æº</li></ol><p>TCCæ¨¡å¼éœ€è¦å°†ä¸šåŠ¡ä»£ç æ”¹é€ æˆç¬¦åˆTCCæ¨¡å¼çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯¹ä¸šåŠ¡æœ‰ä¾µå…¥ã€‚<br>ç”±äºTCCæ¨¡å¼ä¸éœ€è¦è¡Œçº§é”ï¼Œå› æ­¤å¹¶å‘æ€§è¾ƒé«˜ã€‚</p><h3 id="Sagaæ¨¡å¼"><a class="header-anchor" href="#Sagaæ¨¡å¼"></a>Sagaæ¨¡å¼</h3><p><strong>Sagaæ¨¡å¼</strong>æŒ‡çš„æ˜¯é€šè¿‡å†²æ­£è¡¥å¿æœåŠ¡æ¥å®ç°äº‹åŠ¡çš„ï¼Œé€‚ç”¨çš„åœºæ™¯æ˜¯ä¸šåŠ¡æµç¨‹é•¿ä¸”éœ€è¦ä¿è¯äº‹åŠ¡æœ€ç»ˆä¸€è‡´æ€§çš„ä¸šåŠ¡ç³»ç»Ÿã€‚</p><h3 id="XAæ¨¡å¼"><a class="header-anchor" href="#XAæ¨¡å¼"></a>XAæ¨¡å¼</h3><p><strong>XAæ¨¡å¼</strong>æŒ‡çš„æ˜¯ä¸€é˜¶æ®µé¢„æäº¤ï¼Œå¹¶å°†æäº¤ç»“æœåé¦ˆç»™==åè°ƒè€…==ï¼Œåè°ƒè€…æ”¶åˆ°å…¨éƒ¨å‚ä¸è€…çš„ç»“æœåï¼ŒåŒä¸€æ‰§è¡Œæäº¤æˆ–å›æ»šã€‚</p><blockquote><p>å‚è€ƒæ–‡æ¡£</p></blockquote><ul><li><a href="https://www.jianshu.com/p/917cb4bdaa03">ç”±Seataçœ‹åˆ†å¸ƒå¼äº‹åŠ¡å–èˆ</a></li><li><a href="https://seata.io/zh-cn/">seataå®˜ç½‘</a></li><li><a href="https://www.jianshu.com/p/73beee3c70e9">åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæ¡†æ¶(LCN)</a></li><li><a href="https://www.codingapi.com/docs/txlcn-lesson01/">åˆ†å¸ƒå¼äº‹åŠ¡ä»0åˆ°1-è®¤è¯†åˆ†å¸ƒå¼äº‹åŠ¡</a></li><li><a href="http://thesecretlivesofdata.com/raft/">raftç®—æ³•</a></li><li><a href="https://www.cnblogs.com/jajian/p/10014145.html">ç»ˆäºæœ‰äººæŠŠâ€œTCCåˆ†å¸ƒå¼äº‹åŠ¡â€å®ç°åŸç†è®²æ˜ç™½äº†</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼äº‹åŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqçš„å­˜å‚¨åŸç†</title>
      <link href="2019/04/01/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/11.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%8E%9F%E7%90%86/"/>
      <url>2019/04/01/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/11.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqçš„å­˜å‚¨åŸç†</h1><p>rocketmqçš„å­˜å‚¨è®¾è®¡ä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ä¸ªæ–‡ä»¶ï¼š</p><ol><li><strong>comitLogæ–‡ä»¶</strong>ï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨æ¥é¡ºåºå­˜æ”¾æ‰€æœ‰çš„æ¶ˆæ¯</li><li><strong>consumeQueueæ–‡ä»¶</strong>ï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨æ¥ä¿å­˜æ¯ä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—çš„æ¶ˆè´¹ä¿¡æ¯çš„</li><li><strong>IndexFile</strong>æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨æ¥åŠ é€Ÿæ¶ˆæ¯çš„æ£€ç´¢æ€§èƒ½ï¼Œæ ¹æ®æ¶ˆæ¯çš„å±æ€§å¿«é€Ÿä»<strong>comitLog</strong>è·å–ä¿¡æ¯çš„</li></ol><h2 id="æ¶ˆæ¯å¦‚ä½•å®ç°å­˜å‚¨çš„ï¼Ÿ"><a class="header-anchor" href="#æ¶ˆæ¯å¦‚ä½•å®ç°å­˜å‚¨çš„ï¼Ÿ"></a>æ¶ˆæ¯å¦‚ä½•å®ç°å­˜å‚¨çš„ï¼Ÿ</h2><p><strong>commitLog</strong>æ˜¯æ¶ˆæ¯å­˜å‚¨çš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªå®¹é‡ä¸º1Gçš„æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶ä»¥æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶åœ¨<strong>broker</strong>ä¸­çš„åç§»é‡ä½œä¸ºæ–‡ä»¶åç§°ã€‚<br>åœ¨mqå†…éƒ¨ç”¨<strong>MappedFileQueue</strong>æ¥è¡¨ç¤º<strong>store/commitLog</strong>è¿™ä¸ªæ–‡ä»¶å¤¹;ç”¨<strong>MappedFile</strong>æ¥è¡¨ç¤ºå•ä¸ª<strong>commitLong</strong>æ–‡ä»¶ã€‚</p><ul><li><p>commitLogå†…éƒ¨æ•°æ®-æœ‰æ•°æ®æ—¶<br><img src="https://s1.ax1x.com/2020/04/02/GtBXlQ.png" alt="GtBXlQ.png"></p></li><li><p>commitLogå†…éƒ¨æ•°æ®-æ— æ•°æ®æ—¶ä¸ºç©ºå­—ç¬¦<br><img src="https://s1.ax1x.com/2020/04/02/GtBcFK.png" alt="GtBcFK.png"></p></li></ul><h2 id="å†™å…¥commitLogæ–‡ä»¶"><a class="header-anchor" href="#å†™å…¥commitLogæ–‡ä»¶"></a>å†™å…¥<strong>commitLog</strong>æ–‡ä»¶</h2><p>å†™å…¥<strong>commitLog</strong>æ–‡ä»¶çš„è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†(æ¶ˆæ¯é¢„å¤„ç†ã€å»¶æ—¶æ¶ˆæ¯å¤„ç†)<br>åŒ…æ‹¬æ¶ˆæ¯çš„é¢„å¤„ç†(setä¸€äº›å±æ€§å€¼)ã€å¤„ç†å»¶æ—¶æ¶ˆæ¯(éšè—çœŸå®topicæ”¾å…¥å»¶æ—¶é˜Ÿåˆ—çš„topicä¸­)</li><li>è·å–åˆ°å½“å‰æ­£åœ¨æ¿€æ´»çš„æ–‡ä»¶<br>è¿™ä¸€æ­¥æŒ‡çš„æ˜¯ï¼Œè·å–åˆ°å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶å¹¶è½¬åŒ–æˆä¸º<strong>MappedFile</strong>æ–‡ä»¶</li><li>è·å–åˆ°æ–‡ä»¶é”<br>è·å–åˆ°æ–‡ä»¶é”ï¼Œä¿è¯æ–‡ä»¶åœ¨å†™å…¥æ—¶æ˜¯ç‹¬å çš„</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">PutMessageLock</span> putMessageLock<span class="token punctuation">;</span>putMessageLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>å°†æ¶ˆæ¯è¿½åŠ åˆ°æ–‡ä»¶<strong>MappedFile</strong>ä¸­</li><li>æ‰§è¡Œåˆ·ç›˜æ“ä½œ</li><li>æ‰§è¡ŒåŒæ­¥æ“ä½œ</li></ol><ul><li>æ—¶åºå›¾</li></ul><p><img src="https://s1.ax1x.com/2020/04/03/GtRo0e.jpg" alt="GtRo0e.jpg"></p><h3 id="appendMessage-è¿½åŠ æ–‡ä»¶çš„æ–¹æ³•"><a class="header-anchor" href="#appendMessage-è¿½åŠ æ–‡ä»¶çš„æ–¹æ³•"></a>appendMessage() - è¿½åŠ æ–‡ä»¶çš„æ–¹æ³•</h3><p>mqè¿½å‡»<strong>commitLog</strong>æ˜¯ç”¨**MappedFile.appendMessagesInner()**æ–¹æ³•æ¥å®ç°çš„ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆ</p><ol><li>è·å–åˆ°å½“å‰å†™å…¥çš„åç§»é‡</li><li>åˆ›å»ºå†…å­˜å…±äº«åŒº(<strong>slice()</strong>)</li><li>bulidMessage(æ„å»ºmsgå¯¹è±¡)</li><li>ç‰¹æ®Šå¤„ç†äº‹åŠ¡æ€§æ¶ˆæ¯</li><li>åºåˆ—åŒ–æ¶ˆæ¯</li><li>è·å–å½“å‰æ¶ˆæ¯çš„åç§»é‡</li><li>å°†æ•°æ®å†™å…¥<strong>ByteBuffer</strong>ä¸­ï¼Œå®Œæˆå†™å…¥æ“ä½œ</li></ol><h3 id="åˆ·ç›˜æ“ä½œ-handleDiskFlush"><a class="header-anchor" href="#åˆ·ç›˜æ“ä½œ-handleDiskFlush"></a>åˆ·ç›˜æ“ä½œ() - <strong>handleDiskFlush</strong></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDiskFlush</span><span class="token punctuation">(</span><span class="token class-name">AppendMessageResult</span> result<span class="token punctuation">,</span> <span class="token class-name">PutMessageResult</span> putMessageResult<span class="token punctuation">,</span> <span class="token class-name">MessageExt</span> messageExt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// åŒæ­¥åˆ·æ–°</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FlushDiskType</span><span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">final</span> <span class="token class-name">GroupCommitService</span> service <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GroupCommitService</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService<span class="token punctuation">;</span>            <span class="token comment">//ç­‰å¾…åˆ·æ–°å¤±è´¥</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">isWaitStoreMsgOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token comment">//çœç•¥ä»£ç </span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//æ‰§è¡Œåˆ·æ–°æ–¹æ³•</span>                service<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// å¼‚æ­¥åˆ·æ–°</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯çš„åˆ·æ–°</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                flushCommitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//æ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯çš„åˆ·æ–°</span>                commitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ—¶åºå›¾<br><img src="https://s1.ax1x.com/2020/04/04/G061xI.png" alt="G061xI.png"></li></ul><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡º</p><ol><li>åŒæ­¥åˆ·ç›˜çš„ç­–ç•¥<br>åœ¨<strong>1.1 putRequest</strong>æ–¹æ³•ä¸­è°ƒç”¨åˆ·ç›˜æ–¹æ³•ï¼Œç„¶åç­‰å¾…<strong>1.2 future</strong>æ–¹æ³•è¿”å›ç»“æœ</li></ol><ul><li>putRequest</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">putRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">GroupCommitRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNotified<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        waitPoint<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// notify</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>putRequest</strong>å°†<strong>GroupCommitRequest</strong>addè¿›*<strong>GroupCommitService.list</strong>çš„é›†åˆä¸­</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//é‡‡ç”¨è¯»listå’Œå†™liståˆ†ç¦»çš„ç­–ç•¥</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GroupCommitRequest</span> req <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// ä¸‹ä¸€ä¸ªæ–‡ä»¶ä¸­ä¹Ÿå¯èƒ½æœ‰ä¸€æ¡æ¶ˆæ¯ï¼Œå› æ­¤è¦å¤šåˆ·æ–°ä¸¤æ¬¡</span>                <span class="token keyword">boolean</span> flushOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flushOK<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    flushOK <span class="token operator">=</span> <span class="token class-name">CommitLog</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getFlushedWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> req<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushOK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token class-name">CommitLog</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>                req<span class="token punctuation">.</span><span class="token function">wakeupCustomer</span><span class="token punctuation">(</span>flushOK<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//flush</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token class-name">MappedFile</span> mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> tmpTimeStamp <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> offset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> where <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>        result <span class="token operator">=</span> where <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere <span class="token operator">=</span> where<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>storeTimestamp <span class="token operator">=</span> tmpTimeStamp<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//mappedByteBuffer.force</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAbleToFlush</span><span class="token punctuation">(</span>flushLeastPages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//We only append data to fileChannel or mappedByteBuffer, never both.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error occurred when force data to disk."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"in flush, hold failed, flush offset = "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFlushedPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°åŒæ­¥åˆ·ç›˜çš„æ­¥éª¤æ˜¯</p><p>i. <strong>GroupCommitService.doCommit()</strong><br>ii. <strong>mappedFile.flush()</strong><br>iii. <strong>mappedByteBuffer.force()</strong></p><blockquote><p>åŒæ­¥åˆ·ç›˜çš„ç®€å•æè¿°å°±æ˜¯ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…åœ¨æ¶ˆæ¯æœåŠ¡ç«¯å°†æ¶ˆæ¯å†…å®¹è¿½åŠ åˆ°å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­ï¼ˆå†…å­˜ï¼‰åï¼Œéœ€è¦åŒæ­¥å°†å†…å­˜çš„å†…å®¹ç«‹åˆ»åˆ·å†™åˆ°ç£ç›˜ã€‚é€šè¿‡è°ƒç”¨å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆMappedByteBufferçš„forceæ–¹æ³•ï¼‰å¯å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ã€‚</p></blockquote><ol start="2"><li>å¼‚æ­¥æœ‰ç¼“å†²åŒºåˆ·ç›˜çš„ç­–ç•¥æ˜¯æ‰§è¡Œ<strong>1.4 flushCommitLogService.wakeup</strong>æ²¡æœ‰ä¸´æ—¶ç¼“å†²åŒº</li><li>å¼‚æ­¥æ— ç¼“å†²åŒºåˆ·ç›˜çš„ç­–ç•¥æ˜¯æ‰§è¡Œ<strong>1.5 commitLogService.wakeup</strong>æœ‰ä¸´æ—¶ç¼“å†²åŒº</li></ol><p>åˆ†æä¸€ä¸‹å¼‚æ­¥åˆ·ç›˜çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š<br>ä¸€ç§æ˜¯å¯ç”¨<strong>transientStorePoolEnable</strong>è¿™ç§ä¼šå…ˆå°†æ•°æ®å†™åˆ°å †å¤–å†…å­˜ä¸Šï¼Œåœ¨ç”±å †å¤–å†…å­˜å†™åˆ°<strong>PageCache</strong>ï¼Œç„¶ååœ¨æœ‰<strong>PageCache</strong>åˆ·ç›˜åˆ°ç£ç›˜ä¸Šã€‚</p><p>ä¸€ç§æ˜¯æ¶ˆæ¯ç›´æ¥è¿½åŠ åˆ°ä¸ç‰©ç†æ–‡ä»¶ç›´æ¥æ˜ å°„çš„å†…å­˜ä¸­ï¼Œç„¶ååˆ·å†™åˆ°ç£ç›˜ä¸­</p><h3 id="åˆ·ç›˜çš„æ€»ç»“"><a class="header-anchor" href="#åˆ·ç›˜çš„æ€»ç»“"></a>åˆ·ç›˜çš„æ€»ç»“</h3><ol><li><p>åŒæ­¥åˆ·ç›˜ä¾æ¬¡æ˜¯<strong>GroupCommitService.doCommit</strong> -&gt; <strong>mappedFile.flush()</strong> -&gt;<strong>mappedByteBuffer.force()</strong></p></li><li><p>å¼‚æ­¥åˆ·ç›˜åˆåˆ†ä¸º<br>2.1 æœ‰ç¼“å†²åŒºï¼šæ¶ˆæ¯å…ˆè¿›å…¥æ–‡ä»¶ç¼“å†²åŒºï¼Œåœ¨æ–‡ä»¶ç¼“å†²åŒºç­‰å¾…2sååœ¨è¿›å…¥å†…å­˜æ˜ å°„åŒº -&gt;æœ€åå†…å­˜æ˜ å°„åˆ·å…¥ç£ç›˜<br>2.2 æ— ç¼“å†²åŒºï¼šæ¶ˆæ¯ç›´æ¥è¿›å…¥å†…å­˜æ˜ å°„åŒº -&gt; æœ€ååˆ·å…¥ç£ç›˜æ–‡ä»¶ä¸­</p></li></ol><h2 id="rocketmqçš„å†…å­˜æ˜ å°„"><a class="header-anchor" href="#rocketmqçš„å†…å­˜æ˜ å°„"></a>rocketmqçš„å†…å­˜æ˜ å°„</h2><p><strong>MappedFile</strong>æ–‡ä»¶æ˜¯rockedmqå†…å­˜æ˜ å°„æ–‡ä»¶çš„å…·ä½“è¡¨ç°ï¼Œå…ˆçœ‹ä¸€ä¸‹å¦‚ä½•æŸ¥æ‰¾</p><h3 id="æŸ¥æ‰¾MappedFileçš„æ–¹æ³•"><a class="header-anchor" href="#æŸ¥æ‰¾MappedFileçš„æ–¹æ³•"></a>æŸ¥æ‰¾<strong>MappedFile</strong>çš„æ–¹æ³•</h3><ul><li>é€šè¿‡æ—¶é—´æˆ³æ¥è¿›è¡ŒæŸ¥æ‰¾</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">MappedFile</span> <span class="token function">getMappedFileByTime</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è·å–åˆ°å…¨éƒ¨MappedFileæ–‡ä»¶</span>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mfs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">copyMappedFiles</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> mfs<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mfs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MappedFile</span> mappedFile <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedFile</span><span class="token punctuation">)</span> mfs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">//æ ¹æ®ä¼ å…¥çš„æ—¶é—´æˆ³ï¼ŒæŸ¥è¯¢ç¬¬ä¸€ä¸ªæ›´æ–°æ—¶é—´å¤§äºä¼ å…¥æ—¶é—´æˆ³çš„æ–‡ä»¶</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile<span class="token punctuation">.</span><span class="token function">getLastModifiedTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> mappedFile<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">MappedFile</span><span class="token punctuation">)</span> mfs<span class="token punctuation">[</span>mfs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ ¹æ®åç§»é‡æ¥æŸ¥è¯¢</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>firstMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">MappedFile</span> targetFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        targetFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åˆ¤æ–­æ ¹æ®offsetè®¡ç®—å‡ºæ¥çš„indexæ˜¯å¦æœ‰å¯¹åº”çš„æ–‡ä»¶</span>    <span class="token comment">//å› ä¸ºMappedFileæ–‡ä»¶å¯èƒ½è¢«ä¿®æ”¹ï¼Œå› æ­¤è¦å†æ¬¡æ£€æŸ¥ä¸€éæ–‡ä»¶çš„offsetæ˜¯å¦ç¬¦åˆ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetFile <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> offset <span class="token operator">>=</span> targetFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">&amp;&amp;</span> offset <span class="token operator">&lt;</span> targetFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> targetFile<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¦‚æœä¸ç¬¦åˆå°±éœ€è¦éå†å¾ªç¯ä¸€æ¬¡</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MappedFile</span> tmpMappedFile <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> tmpMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token operator">&amp;&amp;</span> offset <span class="token operator">&lt;</span> tmpMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> tmpMappedFile<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="MappFileæ–‡ä»¶çš„ä½œç”¨"><a class="header-anchor" href="#MappFileæ–‡ä»¶çš„ä½œç”¨"></a>MappFileæ–‡ä»¶çš„ä½œç”¨</h3><p>æäº¤æ•°æ®çš„æ–¹æ³•ä¸»è¦æœ‰<strong>commit</strong>ã€<strong>commit0</strong>ï¼Œcommit()ä¸»è¦æ˜¯è°ƒç”¨<strong>commit0ï¼ˆï¼‰</strong></p><ul><li><strong>commit0</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commit0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> writePos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> lastCommittedPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>writePos <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> writeBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>lastCommittedPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>            byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>writePos<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å…³é”®ä»£ç </span>            <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>lastCommittedPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>writePos<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error occurred when commit data to FileChannel."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>commit0</strong></p><ol><li>é¦–å…ˆåˆ›å»ºwriteBufferçš„å…±äº«ç¼“å­˜åŒºï¼Œç„¶åå°†æ–°åˆ›å»ºçš„positionå›é€€åˆ°ä¸Šä¸€æ¬¡æäº¤çš„ä½ç½®ï¼ˆcommittedPositionï¼‰ï¼Œè®¾ç½®limitä¸ºwrotePositionï¼ˆå½“å‰æœ€å¤§æœ‰æ•ˆæ•°æ®æŒ‡é’ˆï¼‰</li><li>æŠŠcommitedPositionåˆ°wrotePositionçš„æ•°æ®å¤åˆ¶ï¼ˆå†™å…¥ï¼‰åˆ°File Channelä¸­ï¼Œç„¶åæ›´æ–°committedPositionæŒ‡é’ˆä¸ºwrotePositionã€‚</li></ol><p>commitçš„ä½œç”¨å°±æ˜¯å°†Mapped File#-writeBufferä¸­çš„æ•°æ®æäº¤åˆ°æ–‡ä»¶é€šé“FileChannelä¸­ã€‚</p><blockquote><p>ByteBufferä½¿ç”¨æŠ€å·§ï¼šsliceï¼ˆï¼‰æ–¹æ³•åˆ›å»ºä¸€ä¸ªå…±äº«ç¼“å­˜åŒºï¼Œä¸åŸå…ˆçš„ByteBufferå…±äº«å†…å­˜ä½†ç»´æŠ¤ä¸€å¥—ç‹¬ç«‹çš„æŒ‡é’ˆï¼ˆpositionã€markã€limitï¼‰</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqé¡ºåºæ¶ˆæ¯çš„åˆ†æ</title>
      <link href="2019/03/31/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/10.rocketmq%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF%E7%9A%84%E5%88%86%E6%9E%90/"/>
      <url>2019/03/31/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/10.rocketmq%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF%E7%9A%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqé¡ºåºæ¶ˆæ¯çš„åˆ†æ</h1><p>é¡ºåºæ¶ˆæ¯æ˜¯æŒ‡çš„æ˜¯ä¸€ç»„éœ€è¦æœ‰åºçš„æ¶ˆæ¯é›†åˆï¼Œåœ¨åŒä¸€å‚ç…§ç³»ä¸‹æ‰æœ‰æ„ä¹‰ã€‚rocketmqçš„é¡ºåºæ¶ˆæ¯ä¸»è¦æ˜¯åˆ†ä¸ºä¸¤ä¸ªæ–¹é¢ï¼š</p><ol><li>productä¿è¯å°†ä¸€ç»„æœ‰åºçš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ªmessageQueueä¸‹</li><li>consumeræ¶ˆè´¹æ—¶ä¿è¯åŒä¸€æ—¶åˆ»ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ¶ˆè´¹æ¶ˆæ¯</li></ol><ul><li>èŒƒå›´</li></ul><ol><li>åˆ†åŒºé¡ºåºï¼šå•ä¸ªmessagequeueä¸­çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„</li><li>å…¨å±€é¡ºåºï¼šå•ä¸ªTopicä¸­çš„æ¶ˆæ¯éƒ½æ˜¯æœ‰åºçš„</li></ol><h2 id="åŸç†"><a class="header-anchor" href="#åŸç†"></a>åŸç†</h2><h3 id="å‘é€æ—¶æ˜¯å¦‚ä½•ä¿è¯é¡ºåºçš„ï¼Ÿ"><a class="header-anchor" href="#å‘é€æ—¶æ˜¯å¦‚ä½•ä¿è¯é¡ºåºçš„ï¼Ÿ"></a>å‘é€æ—¶æ˜¯å¦‚ä½•ä¿è¯é¡ºåºçš„ï¼Ÿ</h3><p>å‘é€æ—¶æ˜¯é€šè¿‡<strong>MessageQueueSelector</strong>åœ¨ç”Ÿäº§è€…ä¸€ç«¯ä¿è¯é¡ºåºçš„</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SendResult</span> result <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">></span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>finalI<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MessageQueueSelector.select</strong>çš„æ‰§è¡Œæ—¶é—´æ˜¯åœ¨<strong>DefaultMQProducerImpl.send</strong>æ—¶ï¼Œä¼šè°ƒç”¨ä¼ å…¥çš„MessageQueueSelectorå¹¶æ‰§è¡Œselectæ–¹æ³•è·å–åˆ°messageQueueé˜Ÿåˆ—è¿›è¡Œä¼ å€¼</p><p>ps.æ™®é€šæ¶ˆæ¯è°ƒç”¨æ—¶å€™ä¸ä¼šæ‰‹åŠ¨é€‰æ‹©messageQueueï¼Œè€Œæ˜¯é€šè¿‡**selectOneMessageQueue()**æ–¹æ³•è¿›è¡Œé€‰æ‹©çš„</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> index <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getSendWhichQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">%</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token class-name">MessageQueue</span> mq <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>latencyFaultTolerance<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> lastBrokerName <span class="token operator">||</span> mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lastBrokerName<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> mq<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¸å¿ƒä»£ç å°±æ˜¯ç®€å•çš„è½®è¯¢</p><h2 id="æ¶ˆæ¯å­˜å‚¨æ—¶æ˜¯å¦‚ä½•ä¿è¯é¡ºåºçš„ï¼Ÿ"><a class="header-anchor" href="#æ¶ˆæ¯å­˜å‚¨æ—¶æ˜¯å¦‚ä½•ä¿è¯é¡ºåºçš„ï¼Ÿ"></a>æ¶ˆæ¯å­˜å‚¨æ—¶æ˜¯å¦‚ä½•ä¿è¯é¡ºåºçš„ï¼Ÿ</h2><p>Brokerå°†æ¶ˆæ¯æŒ‰ç…§å‘é€é¡ºåºå†™å…¥Commitlogä¸­ï¼Œä»è€Œä¿è¯äº†æ¶ˆæ¯çš„å†™å…¥æœ‰åº</p><h2 id="æ¶ˆè´¹ç«¯æœ‰åºæ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ"><a class="header-anchor" href="#æ¶ˆè´¹ç«¯æœ‰åºæ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ"></a>æ¶ˆè´¹ç«¯æœ‰åºæ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ</h2><p>é¦–å…ˆæ¶ˆè´¹ç«¯æœ‰åºå¿…é¡»ä½¿ç”¨<strong>MessageListenerOrderly</strong>æ¥ç›‘å¬æ¶ˆæ¯çš„æ‹‰å–äº‹ä»¶ã€‚</p><p>é€šè¿‡ä¸‰æŠŠé”æ¥ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„æœ‰åºï¼š</p><ol><li><strong>messageQueueLock</strong>ç”¨æ¥ä¿è¯åŒä¸€ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®messageQueue</li></ol><p><img src="https://s1.ax1x.com/2020/04/01/GlwV41.png" alt="GlwV41.png"></p><ol start="2"><li><p><strong>Broker</strong>è®¾ç½®é”ï¼Œç”¨äºåœ¨åŒä¸€ä¸ªæ¶ˆè´¹ç»„åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…èƒ½è¿›è¡Œè®¿é—®</p></li><li><p><strong>processQueue.lock</strong> å¿…é¡»è®¾ç½®é”äº†æ‰èƒ½è¿›è¡Œæ¶ˆè´¹ï¼Œç”¨äºå°†1ï¼Œ2æ­¥éª¤çš„ç»“æ„è¿›è¡Œcheckç”Ÿæˆæœ€ç»ˆçš„ç»“æœ</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqçš„é€šä¿¡åè®®åˆ†æ</title>
      <link href="2019/03/29/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/9.rocketmq%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/"/>
      <url>2019/03/29/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/9.rocketmq%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqçš„é€šä¿¡åè®®åˆ†æ</h1><p>rocketmqåº•å±‚çš„é€šä¿¡æ˜¯æ”¾åœ¨<strong>org.apache.rocketmq.remoting</strong>åŒ…ä¸‹çš„ï¼Œä¸»è¦æœ‰<strong>RPCHook</strong>ã€<strong>RemotingServer</strong>ã€<strong>RemotingClient</strong>ã€<strong>RemotingUtil</strong>ã€<strong>RemotingHelper</strong>ç­‰æ¥å£å’Œç±»ç»„æˆ</p><h2 id="RemotingCommandåè®®"><a class="header-anchor" href="#RemotingCommandåè®®"></a>RemotingCommandåè®®</h2><p><strong>RemotingCommand</strong>æ˜¯rocketmqå®šä¹‰çš„è¿œç¨‹é€šä¿¡åè®®</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è¯·æ±‚å¤´statrt</span><span class="token comment">//è¯·æ±‚ç±»å‹</span><span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span><span class="token comment">//è¯­è¨€æ¨¡å¼æ˜¯java</span><span class="token keyword">private</span> <span class="token class-name">LanguageCode</span> language <span class="token operator">=</span> <span class="token class-name">LanguageCode</span><span class="token punctuation">.</span>JAVA<span class="token punctuation">;</span><span class="token comment">//ç‰ˆæœ¬å·</span><span class="token keyword">private</span> <span class="token keyword">int</span> version <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//è¯·æ±‚id</span><span class="token keyword">private</span> <span class="token keyword">int</span> opaque <span class="token operator">=</span> requestId<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> extFields<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">CommandCustomHeader</span> customHeader<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">SerializeType</span> serializeTypeCurrentRPC <span class="token operator">=</span> serializeTypeConfigInThisServer<span class="token punctuation">;</span><span class="token comment">//æ¶ˆæ¯ä½“</span><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åè®®åœ¨è¯·æ±‚å¤´ä¸­å®šä¹‰äº†è¯·æ±‚è¯·æ±‚ç±»å‹ã€è¯­è¨€ã€ç‰ˆæœ¬å·ã€è¯·æ±‚idç­‰ä¿¡æ¯ï¼›å°†æ¶ˆæ¯ä½“å®šä¹‰åœ¨**byte[]**æ•°ç»„ä¸­ã€‚</p><h3 id="decodeè§£ç æ–¹æ³•"><a class="header-anchor" href="#decodeè§£ç æ–¹æ³•"></a>decodeè§£ç æ–¹æ³•</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è¯¥æ–¹æ³•ä¼šå°†ç½‘ç»œä¸­åŠ è½½çš„å­—èŠ‚æ•°ç»„å°è£…æˆä¸ºé€šç”¨çš„RemotingCommandç±»å‹</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RemotingCommand</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ€»é•¿åº¦</span>        <span class="token keyword">int</span> length <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è¯·æ±‚å¤´é•¿åº¦</span>        <span class="token keyword">int</span> oriHeaderLen <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> headerLength <span class="token operator">=</span> <span class="token function">getHeaderLength</span><span class="token punctuation">(</span>oriHeaderLen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>headerLength<span class="token punctuation">]</span><span class="token punctuation">;</span>        byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>headerData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">RemotingCommand</span> cmd <span class="token operator">=</span> <span class="token function">headerDecode</span><span class="token punctuation">(</span>headerData<span class="token punctuation">,</span> <span class="token function">getProtocolType</span><span class="token punctuation">(</span>oriHeaderLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¶ˆæ¯ä½“çš„é•¿åº¦ç­‰äºæ€»é•¿åº¦å‡å»4(æ ‡è®°æŠ¥æ–‡é•¿åº¦çš„æ•°å­—) - è¯·æ±‚å¤´é•¿åº¦</span>        <span class="token keyword">int</span> bodyLength <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">-</span> headerLength<span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bodyData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            bodyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>bodyLength<span class="token punctuation">]</span><span class="token punctuation">;</span>            byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bodyData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        cmd<span class="token punctuation">.</span>body <span class="token operator">=</span> bodyData<span class="token punctuation">;</span>        <span class="token keyword">return</span> cmd<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="NettyRemotingAbstract"><a class="header-anchor" href="#NettyRemotingAbstract"></a>NettyRemotingAbstract</h2><h3 id="invokeSyncImpl-å‘é€è¯·æ±‚"><a class="header-anchor" href="#invokeSyncImpl-å‘é€è¯·æ±‚"></a>invokeSyncImpl å‘é€è¯·æ±‚</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">invokeSyncImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">,</span>       <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span>       <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingSendRequestException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingTimeoutException</span> <span class="token punctuation">&#123;</span>       <span class="token comment">//è·å¾—æœ¬æ¬¡è¯·æ±‚å·</span>       <span class="token keyword">final</span> <span class="token keyword">int</span> opaque <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getOpaque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>           <span class="token keyword">final</span> <span class="token class-name">ResponseFuture</span> responseFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> opaque<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//é€šè¿‡è¯·æ±‚å·æ ‡è®°å½“å‰è¯·æ±‚æ­£åœ¨æ‰§è¡Œä¸­</span>           <span class="token keyword">this</span><span class="token punctuation">.</span>responseTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>opaque<span class="token punctuation">,</span> responseFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> addr <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//å°†æ•°æ®å†™å…¥achnnelå¹¶æ‰§è¡Œåˆ·æ–°</span>           channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>               <span class="token annotation punctuation">@Override</span>               <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> f<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>                   <span class="token comment">//å¯¹æ“ä½œç»“æœçš„å¤„ç†</span>                   <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                       responseFuture<span class="token punctuation">.</span><span class="token function">setSendRequestOK</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token keyword">return</span><span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                       responseFuture<span class="token punctuation">.</span><span class="token function">setSendRequestOK</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">&#125;</span>                   <span class="token comment">//ç§»é™¤è¯·æ±‚</span>                   responseTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>opaque<span class="token punctuation">)</span><span class="token punctuation">;</span>                   responseFuture<span class="token punctuation">.</span><span class="token function">setCause</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   responseFuture<span class="token punctuation">.</span><span class="token function">putResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"send a request command to channel &lt;"</span> <span class="token operator">+</span> addr <span class="token operator">+</span> <span class="token string">"> failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span>           <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//åŒæ­¥ç­‰å¾…è¿”å›ç»“æœ</span>           <span class="token class-name">RemotingCommand</span> responseCommand <span class="token operator">=</span> responseFuture<span class="token punctuation">.</span><span class="token function">waitResponse</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> responseCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>               <span class="token comment">//è¯·æ±‚å¤±è´¥å¤„ç†....</span>           <span class="token punctuation">&#125;</span>           <span class="token keyword">return</span> responseCommand<span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>           <span class="token keyword">this</span><span class="token punctuation">.</span>responseTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>opaque<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>invokeSyncImpl</strong>æ˜¯<strong>NettyRemotingAbstract</strong>æä¾›çš„åŒæ­¥è¯·æ±‚çš„æ–¹æ³•ï¼Œä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºã€‚åœ¨å‘é€è¯·æ±‚åä¼šç­‰å¾…<strong>timeoutMillis</strong>ï¼Œé»˜è®¤æ˜¯3sã€‚</p><h2 id="NettyRemotingServer"><a class="header-anchor" href="#NettyRemotingServer"></a>NettyRemotingServer</h2><h3 id="start-æ–¹æ³•"><a class="header-anchor" href="#start-æ–¹æ³•"></a>start()æ–¹æ³•</h3><p>**NettyRemotingServer.start()**æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªnettyæœåŠ¡ç«¯</p><ul><li>è°ƒç”¨æ–¹</li></ul><p><img src="https://s1.ax1x.com/2020/03/29/GVXWJU.png" alt="GVXWJU.png"></p><ul><li>æ‰§è¡Œè¿‡ç¨‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆå§‹åŒ–äº‹ä»¶æ‰§è¡Œå™¨</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultEventExecutorGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultEventExecutorGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹åŒ–å„ç§handler</span>        <span class="token function">prepareSharableHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ServerBootstrap</span> childHandler <span class="token operator">=</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventLoopGroupBoss<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eventLoopGroupSelector<span class="token punctuation">)</span>                <span class="token comment">//åˆ¤æ–­æ˜¯å¦ä½¿ç”¨Epoll(linuxç¯å¢ƒä½¿ç”¨Epoll)</span>                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token function">useEpoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">EpollServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_BACKLOG<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>TCP_NODELAY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_SNDBUF<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerSocketSndBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_RCVBUF<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerSocketRcvBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getListenPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>defaultEventExecutorGroup<span class="token punctuation">,</span> HANDSHAKE_HANDLER_NAME<span class="token punctuation">,</span> handshakeHandler<span class="token punctuation">)</span>                            <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>defaultEventExecutorGroup<span class="token punctuation">,</span>                                encoder<span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">NettyDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                <span class="token comment">//è®¾ç½®å¿ƒè·³æ£€æŸ¥</span>                                <span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerChannelMaxIdleTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                connectionManageHandler<span class="token punctuation">,</span>                                serverHandler                            <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">isServerPooledByteBufAllocatorEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            childHandler<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>ALLOCATOR<span class="token punctuation">,</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">ChannelFuture</span> sync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">InetSocketAddress</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">)</span> sync<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"this.serverBootstrap.bind().sync() InterruptedException"</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>channelEventListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>nettyEventExecutor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//æ¯éš”1sæ‰«æä¸€æ¬¡å¼‚æ­¥è°ƒç”¨æ˜¯å¦è¶…æ—¶</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scanResponseTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"æ—¶é—´[%s]-çº¿ç¨‹[%s]æ‰§è¡ŒNameServeræ‰«æè¿æ¥è¡¨"</span><span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"scanResponseTable exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯åŠ¨æœåŠ¡ä¸»è¦æ˜¯ç”¨Nettyæ¥åšçš„ï¼Œè¿™ä¸€å—è¿˜éœ€è¦å­¦ä¹ å®ŒæˆNettyåé‡å†™ç†è§£ä¸€ä¸‹ã€‚<br>ç›®å‰çœ‹æ‡‚çš„å°±æ˜¯linuxç¯å¢ƒä¸‹ä½¿ç”¨çš„æ˜¯Epoll,å…¶ä»–ç¯å¢ƒä½¿ç”¨çš„æ˜¯NioServerSocketChannel</p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç¯å¢ƒæ’æŸ¥é—®é¢˜çš„æ€è·¯</title>
      <link href="2019/03/29/1.%E6%9D%82%E8%AE%B0/Linux%E7%8E%AF%E5%A2%83%E6%8E%92%E6%9F%A5%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%B7%AF/"/>
      <url>2019/03/29/1.%E6%9D%82%E8%AE%B0/Linux%E7%8E%AF%E5%A2%83%E6%8E%92%E6%9F%A5%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<h1>Linuxç¯å¢ƒæ’æŸ¥é—®é¢˜çš„å·¥å…·å’Œæ€è·¯</h1><p>å°†å·¥ä½œä¸­ä½¿ç”¨åˆ°çš„åœ¨Linuxä¸‹è¿›è¡Œæ’æŸ¥é—®é¢˜çš„å·¥å…·å’Œæ€è·¯è¿›è¡Œä¸€ä¸ªæ€»ç»“ï¼Œä¸»è¦ä»<strong>CPU</strong>ã€<strong>å†…å­˜</strong>ã€<strong>I/O</strong>ã€<strong>ç½‘ç»œ</strong>ã€<strong>JVM</strong>è¿™äº”ä¸ªæ–¹é¢æ¥è¿›è¡Œã€‚</p><h2 id="CPUéƒ¨åˆ†"><a class="header-anchor" href="#CPUéƒ¨åˆ†"></a><strong>CPU</strong>éƒ¨åˆ†</h2><h3 id="CPUçš„æ€§èƒ½æŒ‡æ ‡"><a class="header-anchor" href="#CPUçš„æ€§èƒ½æŒ‡æ ‡"></a>CPUçš„æ€§èƒ½æŒ‡æ ‡</h3><ul><li>å›¾ç¤º<br><a href="https://imgchr.com/i/JoptbV"><img src="https://s1.ax1x.com/2020/04/29/JoptbV.png" alt="JoptbV.png"></a></li></ul><h3 id="CPUçš„æ€§èƒ½åˆ†æå·¥å…·"><a class="header-anchor" href="#CPUçš„æ€§èƒ½åˆ†æå·¥å…·"></a>CPUçš„æ€§èƒ½åˆ†æå·¥å…·</h3><table><thead><tr><th>æ€§èƒ½æŒ‡æ ‡</th><th>æ€§èƒ½å·¥å…·</th><th>æè¿°</th></tr></thead><tbody><tr><td>ç³»ç»ŸCPUä½¿ç”¨ç‡</td><td>topã€vmstatã€mpstatã€sarã€/proc/stat</td><td>topã€vmstatã€mpstatä½œä¸ºå®æ—¶çš„ç›‘æ§æ•°æ®;sarå¯è®°å½•å†å²;/proc/stat</td></tr><tr><td>è¿›ç¨‹CPUä½¿ç”¨ç‡</td><td>topã€psã€pidstatã€htopã€atop</td><td>topå’Œpså¯ä»¥æŒ‰ç…§cpuä½¿ç”¨ç‡è¿›è¡ŒæŸ¥çœ‹;pidstatå±•ç¤ºå®é™…è¿è¡Œçš„è¿›ç¨‹;htopå’Œatopå¯ä»¥ä»¥ä¸åŒé¢œè‰²è¿›è¡Œå±•ç¤º</td></tr><tr><td>å¹³å‡è´Ÿè½½</td><td>uptimeã€topã€/proc/loadavg</td><td>uptimeç®€æ´ã€topå…¨é¢ã€/proc/loadavgæä¾›ç›‘æ§æ•°æ®</td></tr><tr><td>ç³»ç»Ÿä¸Šä¸‹æ–‡åˆ‡æ¢</td><td>vmstat</td><td>æä¾›ç³»ç»Ÿçº§çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°</td></tr><tr><td>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</td><td>pidstat</td><td>æä¾›è¿›ç¨‹çº§çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°</td></tr><tr><td>è½¯ä¸­æ–­</td><td>topã€/proc/softirqsã€mpstat</td><td></td></tr><tr><td>ç¡¬ä¸­æ–­</td><td>vmstatã€/proc/interrupts</td><td>vmstatæä¾›æ€»çš„ä¸­æ–­æ¬¡æ•°ã€/proc/interruptsæä¾›åœ¨æ¯ä¸ªcpuä¸Šçš„ä¸­æ–­æ¬¡æ•°</td></tr><tr><td>ç½‘ç»œ</td><td>dstatã€sarã€tcpdump</td><td>dstatå’Œsaræä¾›æ€»çš„ç½‘ç»œæ¥æ”¶æƒ…å†µå’Œå‘é€æƒ…å†µã€tcpdumpæ˜¯æä¾›åŠ¨æ€æŠ“å–æ­£åœ¨è¿›è¡Œçš„ç½‘ç»œé€šä¿¡</td></tr><tr><td>I/O</td><td>dstatã€sar</td><td>éƒ½æ˜¯æä¾›æ•´ä½“çš„I/Oæƒ…å†µ</td></tr></tbody></table><h3 id="CPUçš„åˆ†ææ­¥éª¤"><a class="header-anchor" href="#CPUçš„åˆ†ææ­¥éª¤"></a>CPUçš„åˆ†ææ­¥éª¤</h3><blockquote><p><strong>top</strong> -&gt; <strong>vmstat</strong> -&gt; <strong>pidstat</strong> -&gt;è¿›ç¨‹åˆ†æå·¥å…·</p></blockquote><p>æ€»çš„æ€è·¯å°±æ˜¯æ ¹æ®<strong>top</strong>è·å–åˆ°ç³»ç»Ÿå½“å‰çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæ ¹æ®å½“å‰çš„çŠ¶æ€åœ¨è¿›è¡Œå¯¹åº”çš„åˆ†æ</p><h2 id="å†…å­˜"><a class="header-anchor" href="#å†…å­˜"></a>å†…å­˜</h2><h3 id="å†…å­˜åˆ†æå·¥å…·"><a class="header-anchor" href="#å†…å­˜åˆ†æå·¥å…·"></a>å†…å­˜åˆ†æå·¥å…·</h3><table><thead><tr><th>æ€§èƒ½æŒ‡æ ‡</th><th>æ€§èƒ½å·¥å…·</th><th>æè¿°</th></tr></thead><tbody><tr><td>ç³»ç»Ÿå·²ç”¨ã€å¯ç”¨ã€å‰©ä½™å†…å­˜</td><td>freeã€vmstatã€/proc/meminfo</td><td>è·å–å†…å­˜ä¿¡æ¯</td></tr><tr><td>è¿›ç¨‹è™šæ‹Ÿå†…å­˜ã€å¸¸é©»å†…å­˜ã€å…±äº«å†…å­˜</td><td>psã€top</td><td></td></tr><tr><td>è¿›ç¨‹å†…å­˜åˆ†å¸ƒ</td><td>pmap</td><td></td></tr></tbody></table><h3 id="å†…å­˜åˆ†ææµç¨‹"><a class="header-anchor" href="#å†…å­˜åˆ†ææµç¨‹"></a>å†…å­˜åˆ†ææµç¨‹</h3><blockquote><p><strong>free</strong> -&gt; <strong>vmstatå’Œsar</strong> -&gt; ç¡®å®šå†…å­˜é—®é¢˜</p></blockquote><h3 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h3><ul><li>htop<br><a href="https://imgchr.com/i/Jo9FaT"><img src="https://s1.ax1x.com/2020/04/29/Jo9FaT.png" alt="Jo9FaT.png"></a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> arthas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQä¸»ä»åŒæ­¥æœºåˆ¶åˆ†æ</title>
      <link href="2019/03/28/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/8.RocketMQ%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/"/>
      <url>2019/03/28/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/8.RocketMQ%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>RocketMQä¸»ä»åŒæ­¥æœºåˆ¶åˆ†æ</h1><p><strong>Broker</strong>åˆ†ä¸º<strong>Slave</strong>ã€<strong>Master</strong>ä¸¤ç§è§’è‰²ï¼Œå› æ­¤Slaveä¼šä»masterä¸­åŒæ­¥<strong>ä¿¡æ¯</strong>ã€<strong>topicConfig</strong>ã€<strong>ConsumerOffer</strong>ã€<strong>DelayOffset</strong>ã€<strong>SubscriptionGroupConfig</strong>ç­‰ä¿¡æ¯</p><h2 id="å¯åŠ¨åŒæ­¥"><a class="header-anchor" href="#å¯åŠ¨åŒæ­¥"></a>å¯åŠ¨åŒæ­¥</h2><ul><li>handleSlaveSynchronize</li></ul><p><img src="https://s1.ax1x.com/2020/03/28/GAqiCj.png" alt="GAqiCj.png"></p><p><strong>handleSlaveSynchronize</strong>æ˜¯å¤„ç†Slave BrokeråŒæ­¥Marsterçš„æ–¹æ³•ï¼Œåˆ†åˆ«åœ¨ä¸‰ä¸ªåœ°æ–¹æœ‰è°ƒç”¨ï¼š</p><ol><li>BrokerController.start()ä¸­è°ƒç”¨</li><li>è¯¥èŠ‚ç‚¹å˜æˆMarsterèŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨</li><li>è¯¥èŠ‚ç‚¹å˜æˆSlaverèŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨</li></ol><h2 id="ä¸»è¦æ–¹æ³•"><a class="header-anchor" href="#ä¸»è¦æ–¹æ³•"></a>ä¸»è¦æ–¹æ³•</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">syncAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTopicConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncConsumerOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncDelayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncSubscriptionGroupConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="syncTopicConfig"><a class="header-anchor" href="#syncTopicConfig"></a>syncTopicConfig</h2><p><strong>syncTopicConfig</strong>ä¸»è¦æ˜¯åŒæ­¥<strong>topicConfig</strong>ä¿¡æ¯ï¼Œä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š<br><img src="https://s1.ax1x.com/2020/03/28/GEV9de.png" alt="GEV9de.png"></p><h2 id="syncConsumerOffset"><a class="header-anchor" href="#syncConsumerOffset"></a>syncConsumerOffset</h2><p><strong>syncConsumerOffset</strong>ä¸ºåŒæ­¥offsetæ•°æ®ä¸è¿›è¡Œåˆ¤æ–­ç›´æ¥è¦†ç›–ï¼Œè¿™æ ·åšæ˜¯å› ä¸ºoffsetåœ¨ä¸»ä»ç»“ç‚¹è¿›è¡Œåˆ‡æ¢æ—¶å…è®¸ä¸¢å¤±éƒ¨åˆ†offsetä¿¡æ¯</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">syncConsumerOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> masterAddrBak <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>masterAddr<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>masterAddrBak <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>masterAddrBak<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">ConsumerOffsetSerializeWrapper</span> offsetWrapper <span class="token operator">=</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerOuterAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllConsumerOffset</span><span class="token punctuation">(</span>masterAddrBak<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//ç›´æ¥è¿›è¡Œæ›¿æ¢</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOffsetTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>offsetWrapper<span class="token punctuation">.</span><span class="token function">getOffsetTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Update slave consumer offset from master, &#123;&#125;"</span><span class="token punctuation">,</span> masterAddrBak<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"SyncConsumerOffset Exception, &#123;&#125;"</span><span class="token punctuation">,</span> masterAddrBak<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="syncDelayOffset"><a class="header-anchor" href="#syncDelayOffset"></a>syncDelayOffset</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">syncDelayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> masterAddrBak <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>masterAddr<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>masterAddrBak <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>masterAddrBak<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token class-name">String</span> delayOffset <span class="token operator">=</span>                  <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerOuterAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllDelayOffset</span><span class="token punctuation">(</span>masterAddrBak<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>delayOffset <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  <span class="token class-name">String</span> fileName <span class="token operator">=</span>                      <span class="token class-name">StorePathConfigHelper</span><span class="token punctuation">.</span><span class="token function">getDelayOffsetStorePath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController                          <span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                      <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">string2File</span><span class="token punctuation">(</span>delayOffset<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Persist file Exception, &#123;&#125;"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¸å¿ƒä»£ç å°±æ˜¯ä»Brokerä¸­è·å–åˆ°æ­»ä¿¡é˜Ÿåˆ—çš„offset,ç„¶åå°†æ­¤offsetè®°å½•ä¸‹æ¥</p><h2 id="syncSubscriptionGroupConfig"><a class="header-anchor" href="#syncSubscriptionGroupConfig"></a>syncSubscriptionGroupConfig</h2><p>è¿™ä¸ªåŒæ­¥ç±»ä¼¼äºTopicçš„åŒæ­¥æœºåˆ¶ï¼Œéœ€è¦ç”¨ç‰ˆæœ¬å·ä¸¥æ ¼æ§åˆ¶</p><h2 id="åŒæ­¥æ¶ˆæ¯ä½“"><a class="header-anchor" href="#åŒæ­¥æ¶ˆæ¯ä½“"></a>åŒæ­¥æ¶ˆæ¯ä½“</h2><p>åŒæ­¥æ¶ˆæ¯æ˜¯M/Sæ¶æ„ä¸­æœ€é‡è¦çš„åŠŸèƒ½ï¼Œä¸»è¦æ‰§è¡Œä»£ç æ”¾åœ¨<strong>rocketmq-store</strong>ä¸­</p><ul><li>æ¨¡å—å¼•ç”¨<br><img src="https://s1.ax1x.com/2020/03/29/GEnEtg.png" alt="GEnEtg.png"></li></ul><h3 id="Brokerå¯åŠ¨"><a class="header-anchor" href="#Brokerå¯åŠ¨"></a>Brokerå¯åŠ¨</h3><p>åœ¨Brokerå¯åŠ¨æ—¶ä¼šå…ˆåˆ¤æ–­å½“å‰Brokeræ˜¯ä»€ä¹ˆç±»å‹çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯Slaveç±»å‹çš„èŠ‚ç‚¹ä¼šè®¾ç½®<strong>masterAddr</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">&amp;&amp;</span> registerBrokerResult<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">updateHaMasterAddress</span><span class="token punctuation">(</span>registerBrokerResult<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">updateMasterAddress</span><span class="token punctuation">(</span>newAddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Slaveè¿æ¥Master"><a class="header-anchor" href="#Slaveè¿æ¥Master"></a>Slaveè¿æ¥Master</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">connectMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClosedChannelException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> socketChannel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>masterAddress<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//æ ¹æ®Masteråœ°å€æ³¨å†Œä¸€ä¸ªTCPè¿æ¥</span>            <span class="token class-name">SocketAddress</span> socketAddress <span class="token operator">=</span> <span class="token class-name">RemotingUtil</span><span class="token punctuation">.</span><span class="token function">string2SocketAddress</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>socketAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å¼€å¯channel</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">=</span> <span class="token class-name">RemotingUtil</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>socketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">//æ·»åŠ selector</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentReportedOffset <span class="token operator">=</span> <span class="token class-name">HAService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Masterå“åº”Slave"><a class="header-anchor" href="#Masterå“åº”Slave"></a>Masterå“åº”Slave</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beginAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> <span class="token class-name">RemotingUtil</span><span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setReuseAddress</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socketAddressListen<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Masteræ³¨å†Œå®Œæˆä¸€ä¸ªTcpé€šé“ï¼Œè¿æ¥æˆåŠŸååŒæ–¹é€šè¿‡ä¸æ–­å¯¹æ¯”offsetæ¥è¿›è¡ŒåŒæ­¥</p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rocketmqå¸¸è§é—®é¢˜</title>
      <link href="2019/03/27/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/99.rocketmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
      <url>2019/03/27/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/99.rocketmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1>rocketmqå¸¸è§é—®é¢˜</h1><h2 id="RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Ÿ"><a class="header-anchor" href="#RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Ÿ"></a>RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Ÿ</h2><p>ç”±<strong>NameSrv</strong>ã€<strong>Broker</strong>ã€<strong>Consumer</strong>ã€<strong>Producer</strong>ç»„æˆ</p><h2 id="RocketMQçš„æ•´ä½“æµç¨‹ï¼Ÿ"><a class="header-anchor" href="#RocketMQçš„æ•´ä½“æµç¨‹ï¼Ÿ"></a>RocketMQçš„æ•´ä½“æµç¨‹ï¼Ÿ</h2><ol><li><strong>NameSrv</strong>é¦–å…ˆå¯åŠ¨</li><li><strong>Broker</strong>å¯åŠ¨åå‘NameSrvè¿›è¡Œæ³¨å†Œï¼Œå¹¶å¯¹å¤–æä¾›æœåŠ¡</li><li><strong>producer</strong>å‘<strong>NameSrv</strong>æŸ¥è¯¢å‘<strong>Topic</strong>æä¾›å†™æœåŠ¡çš„<strong>Broker</strong>è¿›è¡Œå†™å…¥</li><li><strong>consumer</strong>å‘<strong>NameSrv</strong>æŸ¥è¯¢å‘<strong>Topic</strong>æä¾›å†™æœåŠ¡çš„<strong>Broker</strong>è¿›è¡Œæ¶ˆè´¹</li></ol><blockquote><p>ä¸<strong>NameSrv</strong>éƒ½æ˜¯ä¿æŒé•¿è¿æ¥çš„å½¢å¼,<strong>Broker</strong>æ˜¯å®šæ—¶å‘é€å¿ƒè·³åŒ…(ip:ç«¯å£ã€Topicä¿¡æ¯)</p></blockquote><h2 id="Namesrvçš„äº†è§£ï¼Ÿ"><a class="header-anchor" href="#Namesrvçš„äº†è§£ï¼Ÿ"></a>Namesrvçš„äº†è§£ï¼Ÿ</h2><p>RocketMQçš„<strong>NameSrv</strong>æ˜¯æä¾›ç»™å…¶ä»–å‚ä¸è€…çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œç”±äºæ¯å°NameSrvéƒ½ä¿å­˜çš„æ˜¯å…¨é‡ä¿¡æ¯ï¼Œå› æ­¤æ”¯æŒæ¨ªå‘æ‰©å±•</p><h2 id="å¦‚ä½•é…ç½®NameSrvåœ°å€åˆ°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•é…ç½®NameSrvåœ°å€åˆ°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Ÿ"></a>å¦‚ä½•é…ç½®NameSrvåœ°å€åˆ°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Ÿ</h2><ol><li>setNamesrvAddr()</li><li>javaå¯åŠ¨å‚æ•°</li><li><strong>NAMESRV_ADDR</strong></li><li>HTTPç«™ç‚¹è§£æ</li></ol><h2 id="è¯´è¯´å¯¹Brokerçš„ç†è§£"><a class="header-anchor" href="#è¯´è¯´å¯¹Brokerçš„ç†è§£"></a>è¯´è¯´å¯¹<strong>Broker</strong>çš„ç†è§£</h2><p><strong>Broker</strong>å°†ç½‘ç»œå’Œå­˜å‚¨ç­‰æ ¸å¿ƒåŠŸèƒ½å°è£…èµ·æ¥ï¼Œå¯¹å¤–æä¾›äº†å­˜/å–æ¶ˆæ¯çš„åŠŸèƒ½ã€‚<br>å†…éƒ¨é€šè¿‡å¤§é‡ä½¿ç”¨çº¿ç¨‹æ± ï¼Œå°†æ¶ˆæ¯çš„å¤„ç†è®¾è®¡æˆä¸ºå¼‚æ­¥å½¢å¼çš„ï¼Œæé«˜äº†æ€§èƒ½ã€‚</p><ol><li>é€šè¿‡æ¶ˆæ¯é¡ºåºå†™ï¼Œå»ºç«‹ç´¢å¼•éšæœºè¯»çš„æ–¹å¼</li><li>æ ¹æ®MessageQueueè¿›è¡Œè´Ÿè½½</li><li>æ”¯æŒä¸»ä»éƒ¨ç½²</li><li>é«˜å¯é æ˜¯ç”¨åŒæ­¥åˆ·ç›˜æœºåˆ¶æ¥ä¿è¯çš„</li></ol><h2 id="Brokerå¦‚ä½•å®ç°å­˜å‚¨çš„ï¼Ÿ"><a class="header-anchor" href="#Brokerå¦‚ä½•å®ç°å­˜å‚¨çš„ï¼Ÿ"></a><strong>Broker</strong>å¦‚ä½•å®ç°å­˜å‚¨çš„ï¼Ÿ</h2><p>é€»è¾‘ä¸Šåˆ’åˆ†ä¸šåŠ¡æ•°æ®ã€ç³»ç»Ÿæ•°æ®<br>ä¸šåŠ¡æ•°æ®åˆ†åˆ«ä¸º<strong>CommitLog</strong>ã€<strong>index</strong>ã€<strong>ConsumerQueue</strong>ã€<strong>config</strong>(topicä¿¡æ¯ã€filterç­‰ä¿¡æ¯)<br>ç³»ç»Ÿæ•°æ®åˆ†åˆ«ä¸ºabortã€lock</p><p>æ”¶åˆ°è¯·æ±‚åå°†è¯·æ±‚å°è£…æˆä¸ºæ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼ï¼Œç„¶åæ‰¾åˆ°commitlogæ–‡ä»¶ï¼Œå†™å…¥æ–‡ä»¶åæ›´æ–°indexæ–‡ä»¶</p><h2 id="producerçš„ç†è§£"><a class="header-anchor" href="#producerçš„ç†è§£"></a><strong>producer</strong>çš„ç†è§£</h2><ol><li>é€šè¿‡NameSrvè·å–åˆ°<strong>Broker-Topic</strong>æ•°æ®</li><li>ç”Ÿäº§è€…ç«¯å¯ä»¥è¿›è¡Œè´Ÿè½½</li><li>æœ‰ä¸‰ç§å‘é€æ–¹å¼ï¼ˆåŒæ­¥ï¼Œå¼‚æ­¥ï¼Œå•å‘ï¼‰</li></ol><h2 id="comsumerçš„ç†è§£"><a class="header-anchor" href="#comsumerçš„ç†è§£"></a><strong>comsumer</strong>çš„ç†è§£</h2><ol><li>ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼šé›†ç¾¤å’Œå¹¿æ’­</li><li>è·å–æ¶ˆæ¯çš„æ¨¡å¼ï¼šæ¨é€å’Œæ‹‰å–</li></ol><h2 id="å¦‚ä½•å®ç°æ¶ˆæ¯çš„é‡å‘ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å®ç°æ¶ˆæ¯çš„é‡å‘ï¼Ÿ"></a>å¦‚ä½•å®ç°æ¶ˆæ¯çš„é‡å‘ï¼Ÿ</h2><p>consumerç«¯é‡ç½®offset</p><h2 id="é¡ºåºæ¶ˆæ¯æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#é¡ºåºæ¶ˆæ¯æ˜¯ä»€ä¹ˆï¼Ÿ"></a>é¡ºåºæ¶ˆæ¯æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>é¡ºåºæ¶ˆæ¯åˆ†ä¸º<strong>æ™®é€šé¡ºåºæ¶ˆæ¯</strong>å’Œ<strong>å…¨å±€é¡ºåºæ¶ˆæ¯</strong>ï¼Œå…¨å±€é¡ºåºæ¶ˆæ¯æ˜¯æ™®é€šé¡ºåºæ¶ˆæ¯ä¸‹åªæœ‰ä¸€ä¸ªmessageQueueçš„ç‰¹ä¾‹ã€‚<br>1.ç”Ÿäº§è€…ç«¯å°†æ¶ˆæ¯æœ‰åºçš„å‘é€åˆ°MessageQueue<br>2.æ¶ˆè´¹ç«¯ä¿è¯ä¸€ä¸ªæ¶ˆè´¹ç»„ç»„å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›è¡Œæ¶ˆè´¹(ConsumerOrderLister)</p><h2 id="é¡ºåºæ¶ˆæ¯åœ¨æ‰©å®¹æ—¶å¦‚ä½•ä¿è¯ä¸åœå†™çš„æƒ…å†µä¸‹æ‰©å®¹ï¼Ÿ"><a class="header-anchor" href="#é¡ºåºæ¶ˆæ¯åœ¨æ‰©å®¹æ—¶å¦‚ä½•ä¿è¯ä¸åœå†™çš„æƒ…å†µä¸‹æ‰©å®¹ï¼Ÿ"></a>é¡ºåºæ¶ˆæ¯åœ¨æ‰©å®¹æ—¶å¦‚ä½•ä¿è¯ä¸åœå†™çš„æƒ…å†µä¸‹æ‰©å®¹ï¼Ÿ</h2><ol><li>ä¿è¯keyæŒ‡å®šåˆ°åŸmessageQueue</li><li>æ¶ˆè´¹å®Œæ—§é˜Ÿåˆ—åœ¨æ¶ˆè´¹æ–°é˜Ÿåˆ—</li></ol><h2 id="ä»€ä¹ˆæ˜¯å®šæ—¶æ¶ˆæ¯ï¼Ÿ"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯å®šæ—¶æ¶ˆæ¯ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å®šæ—¶æ¶ˆæ¯ï¼Ÿ</h2><p>RocketMQä¸­æä¾›äº†18ä¸ªçº§åˆ«çš„å®šæ—¶æ¶ˆæ¯ï¼Œä»<strong>1s</strong> -&gt; <strong>2h</strong><br>åŸç†æ˜¯ï¼šå»¶æ—¶æ¶ˆæ¯åœ¨å‘é€åˆ°brokeråä¼šè¢«å­˜å‚¨åˆ°ç‰¹å®šçš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­,brokeræ ¹æ®ä¸åŒçš„å»¶æ—¶çº§åˆ«åˆ›å»ºä¸åŒçš„å®šæ—¶ä»»åŠ¡æ¥æ ¹æ®å»¶è¿Ÿæ¶ˆè´¹è¿›åº¦æ¥ä»å¯¹åº”çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­æ‹‰å»æ¶ˆæ¯ã€‚ç„¶åæ ¹æ®å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„ä¿¡æ¯è¿˜åŸåˆ°çœŸå®çš„topicä¸­ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯é‡è¯•æ¶ˆæ¯ï¼Ÿ"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯é‡è¯•æ¶ˆæ¯ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é‡è¯•æ¶ˆæ¯ï¼Ÿ</h2><p>é‡è¯•æ¶ˆæ¯æŒ‡çš„æ˜¯æ¶ˆæ¯åœ¨æ¶ˆè´¹å¤±è´¥åæä¾›çš„ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¼šè¢«å‘å›Brokerçš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­<br>ä¸»è¦æµç¨‹ï¼š</p><ol><li>consumerGroupæ¶ˆè´¹å¤±è´¥åå‘é€åˆ°broker</li><li>brokeræ”¶åˆ°æ¶ˆæ¯åå°†æ¶ˆæ¯æ”¾åˆ°å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œåˆ°æœŸåå‘consumerå‘é€æ‹‰å–è¯·æ±‚</li><li>consumeré‡æ–°æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å°†topiceæ›¿æ¢ä¸ºåŸå§‹çš„topic</li></ol><h2 id="å¤šæ¬¡æ¶ˆè´¹å¤±è´¥åè¿™ä¹ˆå¤„ç†"><a class="header-anchor" href="#å¤šæ¬¡æ¶ˆè´¹å¤±è´¥åè¿™ä¹ˆå¤„ç†"></a>å¤šæ¬¡æ¶ˆè´¹å¤±è´¥åè¿™ä¹ˆå¤„ç†?</h2><p>rocketmqå¤šæ¬¡æ¶ˆè´¹å¤±è´¥åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œåº”ç”¨å¯ä»¥è®¢é˜…æ­»ä¿¡é˜Ÿåˆ—è¿›è¡Œå‘Šè­¦ã€‚</p><h2 id="RocketMQçš„äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ"><a class="header-anchor" href="#RocketMQçš„äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ"></a>RocketMQçš„äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ</h2><p>RocketMQçš„äº‹åŠ¡æ¶ˆæ¯æ˜¯ä¿è¯ä¸€æ–¹çš„æœ¬åœ°äº‹åŠ¡å’Œæ¶ˆæ¯å‘é€çŠ¶æ€çš„çŠ¶æ€æ˜¯ä¸€ä¸ªåŸå­ç±»å‹çš„æ“ä½œï¼Œé€šè¿‡æ˜¯åŸºäºbaseç†è®ºçš„ï¼Œå› æ­¤é€‚ç”¨äºé•¿äº‹åŠ¡çš„åœºæ™¯</p><h2 id="RocketMQå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ"><a class="header-anchor" href="#RocketMQå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ"></a>RocketMQå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ</h2><ol><li>NameSrvæ— çŠ¶æ€çš„å¤šèŠ‚ç‚¹éƒ¨ç½²</li><li>brokerå¯ä»¥ç”¨master-salveéƒ¨ç½²ï¼ˆ2m-2s-asyncï¼‰</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MQClientInstanceç±»åˆ†æ</title>
      <link href="2019/03/27/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/7.MQClientInstance%E7%B1%BBf%E5%88%86%E6%9E%90/"/>
      <url>2019/03/27/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/7.MQClientInstance%E7%B1%BBf%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>MQClientInstanceç±»åˆ†æ</h1><p><strong>MQClientInstance</strong>æ˜¯ä½äº<strong>org.apache.rocketmq.client.impl.factory</strong>ä¸‹çš„ä¸€ä¸ªä¸ºproducerå’Œconsumeræä¾›ç»Ÿä¸€å’Œ<strong>Broker</strong>è¿›è¡Œäº¤äº’çš„åº•å±‚å·¥å…·ç±»ï¼›</p><h2 id="åˆ›å»º"><a class="header-anchor" href="#åˆ›å»º"></a>åˆ›å»º</h2><ul><li>MQClientManager</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">MQClientInstance</span> <span class="token function">getOrCreateMQClientInstance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ClientConfig</span> clientConfig<span class="token punctuation">,</span> <span class="token class-name">RPCHook</span> rpcHook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> clientId <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">buildMQClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆ¤æ–­å½“å‰clientæ˜¯å¦æœ‰è¿‡å®ä¾‹å¯¹è±¡ï¼Œæœ‰å°±å–</span>        <span class="token class-name">MQClientInstance</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> instance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            instance <span class="token operator">=</span>                <span class="token keyword">new</span> <span class="token class-name">MQClientInstance</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">cloneClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>factoryIndexGenerator<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">MQClientInstance</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                instance <span class="token operator">=</span> prev<span class="token punctuation">;</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Returned Previous MQClientInstance for clientId:[&#123;&#125;]"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Created new MQClientInstance for clientId:[&#123;&#125;]"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MQClientInstance</strong>çš„åˆ›å»ºæ˜¯é€šè¿‡<strong>MQClientManager</strong>æ¥è¿›è¡Œåˆ›å»ºå’Œç®¡ç†çš„ï¼Œé€šè¿‡å°†å®ä¾‹å’Œ<strong>MQClientInstance</strong>æ”¾å…¥ä¸€ä¸ª<strong>ConcurrentHashMap</strong>ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªè¿›ç¨‹å†…å…±äº«åŒä¸€ä¸ªMQClientInstanceå¯¹è±¡è¿æ¥ä¸€ä¸ªé›†ç¾¤ï¼Œå¦‚æœè¦è®¾ç½®å¤šä¸ªé›†ç¾¤éœ€è¦æ‰‹åŠ¨æŒ‡å®šå®ä¾‹åç§°ã€‚</p><p><img src="https://s1.ax1x.com/2020/03/28/GFEx1K.png" alt="GFEx1K.png"></p><h2 id="start-æ–¹æ³•"><a class="header-anchor" href="#start-æ–¹æ³•"></a>start()æ–¹æ³•</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//åˆ¤æ–­æœåŠ¡çŠ¶æ€</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">case</span> CREATE_JUST<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>åˆ›å»ºæœåŠ¡                    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span>START_FAILED<span class="token punctuation">;</span>                    <span class="token comment">// å¦‚æœæœªæŒ‡å®šNamesrvåœ°å€,å°è¯•ä»è¿œç¨‹æœåŠ¡å™¨ä¸­è·å–åœ°å€</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                    <span class="token comment">// Start request-response channel</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// å¯åŠ¨å„ç§å®šæ—¶ä»»åŠ¡</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startScheduledTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// å¯åŠ¨æ‹‰å»æ¶ˆæ¯æœåŠ¡</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// å¯åŠ¨è´Ÿè½½æœåŠ¡</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// å¯åŠ¨æ¨é€æœåŠ¡                this.defaultMQProducer.getDefaultMQProducerImpl().start(false);</span>                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"the client factory [&#123;&#125;] start OK"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> START_FAILED<span class="token operator">:</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">"The Factory object["</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] has been created before, and failed."</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token operator">:</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MQClientInstance</strong>ä¸»è¦æ˜¯ä¸<strong>Broker</strong>è¿›è¡Œé€šä¿¡çš„ï¼Œå› æ­¤åœ¨å¯åŠ¨åéœ€è¦å­˜å‚¨<strong>NameServer</strong>æŸ¥è¯¢å‡ºæ¥çš„<strong>Topic</strong>ã€<strong>Broker</strong>ä¿¡æ¯ã€‚åœ¨start()ä¸­ä½¿ç”¨äº†ä¸€ä¸‹ä¸€ä¸ªçº¿ç¨‹æ± å»æ‰§è¡Œä»»åŠ¡ï¼š</p><ol><li><strong>startScheduledTask</strong>2åˆ†é’Ÿå»è¯·æ±‚ä¸€æ¬¡æœ€æ–°çš„NameServeråœ°å€ã€æ›´æ–°<strong>Topic</strong>ä¿¡æ¯ã€æ¸…ç†å¤±æ•ˆçš„<strong>Broker</strong>ã€ä¿å­˜æ¶ˆè´¹è€…çš„<strong>offset</strong></li><li>å¯åŠ¨æ‹‰æ¶ˆæ¯çš„çº¿ç¨‹</li><li>å¯åŠ¨topicè´Ÿè½½çº¿ç¨‹</li><li>å¯åŠ¨æ¨é€æ¶ˆæ¯çš„çº¿ç¨‹</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MessageQueueçš„åˆ†æ</title>
      <link href="2019/03/27/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/6.MessageQueue%E7%9A%84%E5%88%86%E6%9E%90/"/>
      <url>2019/03/27/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/6.MessageQueue%E7%9A%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Consumeræºä»£ç åˆ†æ</title>
      <link href="2019/03/25/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/5.DefaultMQPushConsumer%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>2019/03/25/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/5.DefaultMQPushConsumer%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>DefaultMQPushConsumeræºä»£ç åˆ†æ</h1><h2 id="åŸºæœ¬ä½¿ç”¨"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p><strong>DefaultMQPushConsumer</strong>æ˜¯é»˜è®¤è¿›è¡Œæ¶ˆè´¹çš„å·¥å…·ç±»ï¼Œç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://s1.ax1x.com/2020/03/25/8x1zJP.png" alt="8x1zJP.png"></p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">,</span> <span class="token class-name">RPCHook</span> rpcHook<span class="token punctuation">,</span>    <span class="token class-name">AllocateMessageQueueStrategy</span> allocateMessageQueueStrategy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup <span class="token operator">=</span> consumerGroup<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>namespace <span class="token operator">=</span> namespace<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMessageQueueStrategy <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">;</span>    defaultMQPushConsumerImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>é»˜è®¤çš„æ„é€ å‡½æ•°å‚æ•°å¦‚ä¸‹</p></blockquote><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>namespace</td><td>æŒ‡å®šproducer/consumerå®ä¾‹,åªæœ‰åœ¨åŒä¸€ä¸ªå®ä¾‹ä¸‹çš„æ¶ˆæ¯æ‰èƒ½è¢«æ¶ˆè´¹åˆ°</td></tr><tr><td>consumerGroup</td><td>æ¶ˆè´¹ç»„</td></tr><tr><td>defaultMQPushConsumerImpl</td><td></td></tr><tr><td>allocateMessageQueueStrategy</td><td>é»˜è®¤çš„æ¶ˆè´¹ç­–ç•¥</td></tr><tr><td>namesrvAddr</td><td>namesrvçš„åœ°å€</td></tr><tr><td>subscribe(topic,subExpression)</td><td>è®¢é˜…çš„ä¸»é¢˜å’Œtagè¿‡æ»¤çš„è§„åˆ™</td></tr></tbody></table><h2 id="åº•å±‚åŸç†"><a class="header-anchor" href="#åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h2><p>ä¸»è¦æ˜¯ä¸€ä¸‹å‡ ä¸ªæ­¥éª¤</p><ol start="0"><li>å‡†å¤‡ç¯å¢ƒï¼Œè®¾ç½®å„ç§ç¯å¢ƒå˜é‡(ä¾‹å¦‚topic,è¿‡æ»¤ç­–ç•¥)ï¼Œæ ¹æ®ç¯å¢ƒå˜é‡åˆå§‹åŒ–<strong>pullRequest</strong></li><li>ä»æœ¬åœ°æˆ–è€…Brokerä¸­è·å–åˆ°offerSetåç§»é‡</li><li>ä»æœ¬åœ°çš„brokerTableä¸­è·å–åˆ°å¯¹åº”çš„brokeråœ°å€</li><li>è°ƒç”¨<strong>MQClientAPIImpl</strong>æ“ä½œè·å–æ¶ˆæ¯å¹¶æ‰§è¡Œå›è°ƒ(å°†Nettyçš„æ“ä½œå°è£…æˆMQå±‚é¢çš„ä¸šåŠ¡æ“ä½œ)</li><li>åº•å±‚è°ƒç”¨<strong>NettyRemotingClient</strong>è¿›è¡Œç½‘ç»œè¿æ¥ï¼Œ<strong>ç‰¹æ®Šçš„æŠ¥æ–‡ç»“æ„</strong></li></ol><p>æ¶ˆæ¯çš„æ–¹å¼æ˜¯é€šè¿‡â€œé•¿è½®è¯¢â€çš„æ–¹å¼è¿›è¡Œå¤„ç†çš„ï¼Œé€šè¿‡æœåŠ¡ç«¯holdä½è¯·æ±‚(é»˜è®¤æ˜¯15s)æ¥å®ç°çš„</p><h1>ConsumerMessageConcurrentlyServiceæºä»£ç åˆ†æ</h1><p>ä¸Šé¢è®²åˆ°å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ª<strong>DefaultMQPushConsumer</strong>,ä½†æ˜¯åœ¨å®é™…æ‰§è¡Œè·å–åŠ¨ä½œçš„æ˜¯<strong>ConsumerMessageConcurrentlyService</strong>æ¥è¿›è¡Œçš„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ConsumeMessageConcurrentlyService</span><span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span> defaultMQPushConsumerImpl<span class="token punctuation">,</span>    <span class="token class-name">MessageListenerConcurrently</span> messageListener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl <span class="token operator">=</span> defaultMQPushConsumerImpl<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>messageListener <span class="token operator">=</span> messageListener<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">getDefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>consumeRequestQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//1. åˆ›å»ºä¸€ä¸ªä¸»çº¿ç¨‹æ± ç”¨æ¥æ‹‰å»æ¶ˆæ¯</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeThreadMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeThreadMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeRequestQueue<span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ConsumeMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2. åˆ›å»ºä¸€ä¸ªç”¨æ¥æ‰§è¡Œæ¨è¿Ÿæ¶ˆè´¹çš„çº¿ç¨‹æ± </span>    <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ConsumeMessageScheduledThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//3. å®šæ—¶æ¸…ç†è¶…æ—¶çš„æ¶ˆæ¯</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cleanExpireMsgExecutors <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"CleanExpireMsgScheduledThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ä¸»çº¿ç¨‹æ± æ‰§è¡Œçš„é€»è¾‘</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span>    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgs<span class="token punctuation">,</span>    <span class="token keyword">final</span> <span class="token class-name">ProcessQueue</span> processQueue<span class="token punctuation">,</span>    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> messageQueue<span class="token punctuation">,</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> dispatchToConsume<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">final</span> <span class="token keyword">int</span> consumeBatchSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeMessageBatchMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//1. msgsæ˜¯ä¸€æ‰¹æ¶ˆæ¯ï¼Œå…ˆåˆ¤æ–­è¿™ä¸€æ‰¹æ¶ˆæ¯æ˜¯å¦å¤§äºæœ€å¤§å¤„ç†é‡</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> consumeBatchSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ConsumeRequest</span> consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//2. æ”¾å…¥æ­£å¸¸é˜Ÿåˆ—æ‰§è¡Œä¸šåŠ¡ä¸Šçš„æ¶ˆè´¹é€»è¾‘</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//3. æ¶ˆè´¹å¤±è´¥ï¼Œæ”¾å…¥å»¶è¿Ÿç­‰å¾…çº¿ç¨‹æ± ä¸­</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//4. å¦‚æœbatchæ¶ˆæ¯å¤ªå¤šä¼šæŒ‰ç…§æœ€å¤§æ¶ˆè´¹é•¿åº¦åˆ†æ‰¹è¿›è¡Œå¤„ç†</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> total <span class="token operator">&lt;</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgThis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>consumeBatchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> consumeBatchSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> total<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>total <span class="token operator">&lt;</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    msgThis<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//é‡å¤2ã€3çš„é€»è¾‘</span>            <span class="token class-name">ConsumeRequest</span> consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>msgThis<span class="token punctuation">,</span> processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> total <span class="token operator">&lt;</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> total<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    msgThis<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¶ˆè´¹çš„é€»è¾‘ï¼š</p><ol><li>åˆ›å»ºä¸‰ä¸ªä¸åŒçš„çº¿ç¨‹æ± åˆ†åˆ«æ˜¯æ­£å¸¸æ¶ˆè´¹çš„çº¿ç¨‹æ± ã€ç­‰å¾…æ¶ˆè´¹çš„çº¿ç¨‹æ± ã€æ¸…ç†æ¶ˆæ¯çš„çº¿ç¨‹æ± </li><li>åˆ¤æ–­å½“å‰æ¶ˆæ¯æ•°é‡æ˜¯å¦å¤§äºæœ€å¤§å¤„ç†æ•°é‡</li><li>å°è¯•ä½¿ç”¨æ­£å¸¸æ¶ˆè´¹çš„çº¿ç¨‹æ± è¿›è¡Œæ¶ˆè´¹ å¦‚æœå¤±è´¥ -&gt; ç­‰å¾…æ¶ˆè´¹çš„çº¿ç¨‹æ± </li></ol><h1>æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹æ± é€»è¾‘</h1><ul><li><strong>ConsumeRequest</strong></li></ul><ol><li>çº¿ç¨‹è°ƒç”¨æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ï¼Œæ ¹æ®æ¶ˆæ¯ä»å¤„ç†é€»è¾‘è¿”å›ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ</li></ol><ul><li>è°ƒç”¨æ¶ˆæ¯çš„é€»è¾‘</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ConsumeReturnType</span> returnType <span class="token operator">=</span> <span class="token class-name">ConsumeReturnType</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msgs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">setConsumeStartTimeStamp</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//listenerå°±æ˜¯æ¶ˆæ¯çš„å¤„ç†é€»è¾‘æ–¹æ³•</span>        status <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span><span class="token punctuation">,</span>            <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">exceptionSimpleDesc</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">ConsumeMessageConcurrentlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">,</span>            msgs<span class="token punctuation">,</span>            messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>        hasException <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¤„ç†æ¶ˆæ¯çš„é€»è¾‘</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> CONSUME_SUCCESS<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackIndex <span class="token operator">>=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            ackIndex <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> ok <span class="token operator">=</span> ackIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> failed <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ok<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeOKTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeFailedTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> RECONSUME_LATER<span class="token operator">:</span>        ackIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeFailedTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> BROADCASTING<span class="token operator">:</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> ackIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MessageExt</span> msg <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"BROADCASTING, the message consume failed, drop it, &#123;&#125;"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CLUSTERING<span class="token operator">:</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgBackFailed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> ackIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MessageExt</span> msg <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMessageBack</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                msg<span class="token punctuation">.</span><span class="token function">setReconsumeTimes</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                msgBackFailed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>å°†ä¸åŒè¿”å›å€¼çš„æ¶ˆæ¯å†™å…¥ä¸åŒçš„é˜Ÿåˆ—ä¸­</li><li>æ ¹æ®ä¸åŒçš„æ¶ˆè´¹æ–¹å¼åšä¸åŒçš„å¤„ç†<br>2.1 å¹¿æ’­æ¨¡å¼ æ¶ˆè´¹ä¸æˆåŠŸä¸å¤„ç†<br>2.2 é›†ç¾¤æ¨¡å¼æ¶ˆè´¹ä¸æˆåŠŸï¼Œæ¨é€brokerï¼Œè®©brokeré€šçŸ¥å…¶ä»–consumerè¿›è¡Œæ¶ˆè´¹ï¼Œè¿˜æ˜¯å¤±è´¥è¿›å…¥å»¶è¿Ÿé˜Ÿåˆ—</li></ol><h1>ProcessQueue</h1><p><strong>ProcessQueue</strong>æ˜¯consumerä¸­æ¯ä¸€ä¸ªMessageQueueæ‰€å¯¹åº”çš„é˜Ÿåˆ—æ¶ˆè€—å¿«ç…§ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> lockTreeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgTreeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">MessageExt</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¸»è¦æ˜¯ç”±ä¸€ä¸ªTreeMepå’ŒReadWriteLocké”ç»„æˆï¼ŒTreeMapé‡Œä»¥MessageQueueçš„Offsetä½œä¸ºKeyï¼Œä»¥æ¶ˆæ¯å†…å®¹çš„å¼•ç”¨ä¸ºValueï¼Œä¿å­˜äº†æ‰€æœ‰ä»MessageQueueè·å–åˆ°ä½†æ˜¯è¿˜æœªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œè¯»å†™é”æ§åˆ¶ç€å¤šä¸ªçº¿ç¨‹å¯¹TreeMapå¯¹è±¡çš„å¹¶å‘è®¿é—®ã€‚</p><h1>MessageQueueçš„åˆ†æ</h1>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMqæºä»£ç ä¹‹NameServer</title>
      <link href="2019/03/22/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/4.RocketMq%E6%BA%90%E4%BB%A3%E7%A0%81%E4%B9%8BNameServer/"/>
      <url>2019/03/22/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/4.RocketMq%E6%BA%90%E4%BB%A3%E7%A0%81%E4%B9%8BNameServer/</url>
      
        <content type="html"><![CDATA[<h1>RocketMqæºä»£ç ä¹‹NameServerè§£æ</h1><p>å‘¨æœ«ç»§ç»­é˜…è¯»RocketMqçš„å­¦ä¹ ,åœ¨ä¸Šå‘¨å·²ç»ç®€å•çš„æŠŠRocketMqçš„å®‰è£…å’Œä½¿ç”¨å­¦ä¹ äº†ä¸€ä¸‹ã€‚æœ¬å‘¨ä¸»è¦æ¥çœ‹ä¸€ä¸‹NameServerçš„æºä»£ç å’Œè®¾è®¡</p><h2 id="NameServerå¯åŠ¨"><a class="header-anchor" href="#NameServerå¯åŠ¨"></a>NameServerå¯åŠ¨</h2><h3 id="NamesrvControllerå¯åŠ¨"><a class="header-anchor" href="#NamesrvControllerå¯åŠ¨"></a>NamesrvControllerå¯åŠ¨</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NamesrvController</span> <span class="token function">main0</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//åˆ›å»ºNamesrvController()</span>            <span class="token class-name">NamesrvController</span> controller <span class="token operator">=</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> tip <span class="token operator">=</span> <span class="token string">"The Name Server boot success. serializeType="</span> <span class="token operator">+</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">getSerializeTypeConfigInThisServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> tip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> controller<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>NamesrvStartup</strong>ä¸­å¯åŠ¨ï¼Œè°ƒç”¨main0() -&gt; createNamesrvController()</p><p>ä¸»è¦ä»£ç é€»è¾‘åœ¨<strong>createNamesrvController</strong>ä¸­ï¼Œä¸»è¦æ‰§è¡Œ<strong>NamesrvControlleråˆå§‹åŒ–</strong>ã€<strong>NamesrvController.start</strong></p><h3 id="NamesrvControlleråˆå§‹åŒ–"><a class="header-anchor" href="#NamesrvControlleråˆå§‹åŒ–"></a>NamesrvControlleråˆå§‹åŒ–</h3><p><strong>NamesrvController</strong>åˆå§‹åŒ–çš„æ­¥éª¤ä¸»è¦æ˜¯ï¼š</p><ol><li>è·å–åˆ°<strong>namesrvConfig</strong>ã€<strong>nettyServerConfig</strong></li><li>æ ¹æ®é…ç½®ç”Ÿæˆ<strong>NamesrvController</strong></li></ol><h3 id="NamesrvController-start"><a class="header-anchor" href="#NamesrvController-start"></a>NamesrvController.start()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//çœç•¥ä»£ç ....</span><span class="token comment">//åˆå§‹åŒ–controller</span><span class="token keyword">boolean</span> initResult <span class="token operator">=</span> controller<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ·»åŠ å…³é—­çš„é’©å­å‡½æ•°</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShutdownHookThread</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        controller<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥ä»£ç ....</span><span class="token comment">//start</span>controller<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> controller<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>**NamesrvController.start()**ä¸»è¦åšäº†ä¸¤ä¸ªå·¥ä½œï¼š</p><ol><li>é€šè¿‡<strong>controller.initialize()<strong>è®¾ç½®å¥½controllerçš„é…ç½®ç¯å¢ƒ<br>1.1 å¼€å¯NettyæœåŠ¡<br>1.2 å¯åŠ¨çº¿ç¨‹æ± ï¼ˆ<strong>remotingExecutor</strong>ã€ä¸¤ä¸ªå®šæ—¶æ‰§è¡Œçš„çº¿ç¨‹ï¼Œä¸€ä¸ªç”¨æ¥æ‰«æå¤±æ•ˆçš„</strong>Brokerï¼ˆscanNotActiveBrokerï¼‰</strong>ï¼Œå¦ä¸€ä¸ªç”¨æ¥æ‰“å°é…ç½®ä¿¡æ¯ï¼ˆ<strong>printAllPeriodically</strong>ï¼‰ï¼‰</li><li>remotingServer.start()<br>2.1 ä½¿ç”¨nettyå¼€å¯æœåŠ¡<br>2.2 <strong>prepareSharableHandlers</strong>ä¸­æ³¨å†Œ<strong>NettyServerHandler</strong>å°†<strong>NettyRequestProcessor</strong>æ³¨å†Œåˆ°å¤„ç†å™¨ä¸­</li></ol><h2 id="Namesrvçš„å¤„ç†é€»è¾‘"><a class="header-anchor" href="#Namesrvçš„å¤„ç†é€»è¾‘"></a>Namesrvçš„å¤„ç†é€»è¾‘</h2><p>Namesrvçš„å¤„ç†é€»è¾‘ä¸»è¦æ˜¯é€šè¿‡<strong>NettyRequestProcessor</strong>çš„å­ç±»<strong>DefaultRequestProcessor</strong>æ¥è¿›è¡Œå®ç°çš„</p><ul><li>DefaultRequestProcessor</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>PUT_KV_CONFIG<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putKVConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_KV_CONFIG<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKVConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>DELETE_KV_CONFIG<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteKVConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>QUERY_DATA_VERSION<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token function">queryBrokerTopicConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>REGISTER_BROKER<span class="token operator">:</span>        <span class="token class-name">Version</span> brokerVersion <span class="token operator">=</span> <span class="token class-name">MQVersion</span><span class="token punctuation">.</span><span class="token function">value2Version</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerVersion<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token class-name">MQVersion<span class="token punctuation">.</span>Version</span><span class="token punctuation">.</span>V3_0_11<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>UNREGISTER_BROKER<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unregisterBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_ROUTEINTO_BY_TOPIC<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRouteInfoByTopic</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_BROKER_CLUSTER_INFO<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBrokerClusterInfo</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>WIPE_WRITE_PERM_OF_BROKER<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wipeWritePermOfBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_ALL_TOPIC_LIST_FROM_NAMESERVER<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token function">getAllTopicListFromNameserver</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>DELETE_TOPIC_IN_NAMESRV<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token function">deleteTopicInNamesrv</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_KVLIST_BY_NAMESPACE<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKVListByNamespace</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_TOPICS_BY_CLUSTER<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTopicsByCluster</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_SYSTEM_TOPIC_LIST_FROM_NS<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSystemTopicListFromNs</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_UNIT_TOPIC_LIST<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUnitTopicList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_HAS_UNIT_SUB_TOPIC_LIST<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHasUnitSubTopicList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHasUnitSubUnUnitTopicList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>UPDATE_NAMESRV_CONFIG<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_NAMESRV_CONFIG<span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ®ä¸åŒçš„è¯·æ±‚è¿”å›ä¸åŒçš„å¤„ç†å‡½æ•°</p><h2 id="æ¶ˆæ¯çš„å­˜å‚¨"><a class="header-anchor" href="#æ¶ˆæ¯çš„å­˜å‚¨"></a>æ¶ˆæ¯çš„å­˜å‚¨</h2><p>NameSrvä¸­ä¿¡æ¯éƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œè€Œä¸”æ¯ä¸€ä¸ªNameSrvä¿å­˜çš„ä¿¡æ¯éƒ½æ˜¯å…¨é‡çš„ã€‚<strong>RouteInfoManager</strong>æ˜¯ä¿å­˜è¿™äº›ä¿¡æ¯çš„ç±»</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RouteInfoManager</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InternalLogger</span> log <span class="token operator">=</span> <span class="token class-name">InternalLoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggerName</span><span class="token punctuation">.</span>NAMESRV_LOGGER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> BROKER_CHANNEL_EXPIRED_TIME <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span></span><span class="token operator">></span> topicQueueTable<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerName */</span><span class="token punctuation">,</span> <span class="token class-name">BrokerData</span><span class="token operator">></span> brokerAddrTable<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* clusterName */</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerName */</span><span class="token operator">>></span> clusterAddrTable<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerAddr */</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token operator">></span> brokerLiveTable<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerAddr */</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token comment">/* Filter Server */</span><span class="token operator">></span> filterServerTable<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™é‡Œç”±äºNamesevä¸­çš„ä¸šåŠ¡åœºæ™¯æ˜¯<strong>è¯»å¤šå†™å°‘</strong>ï¼Œå› æ­¤ç”¨<strong>å¯é‡å…¥çš„è¯»å†™é”</strong>æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨æ€§</p><h1>æ€»ç»“</h1><ol><li>åŠ è½½é…ç½®æ–‡ä»¶è½¬æ¢ä¸ºNameServerConfigã€NettyConfig</li><li>æ ¹æ®é…ç½®æ–‡ä»¶ç”Ÿæˆ<strong>NamesrvController</strong></li><li>åˆ›å»ºçº¿ç¨‹æ± å’Œå®šæ—¶æ‰«æçº¿ç¨‹</li><li>å¼€å¯<strong>Netty</strong>æœåŠ¡</li><li>ç”¨<strong>NettyRequestProcessor</strong>å¤„ç†è¯·æ±‚</li><li><strong>RouteInfoManager</strong>ä¸­å­˜å‚¨ä¿¡æ¯</li></ol><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><ul><li>ã€ŠRocketMQå®æˆ˜ä¸åŸç†è§£æã€‹</li><li><img src="http://www.jiangxinlingdu.com/rocketmq/2018/05/10/mq-rpc.html" alt="RocketMQ ç³»åˆ—æ–‡ç« "></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQç‰¹ç‚¹å’Œç»„ä»¶</title>
      <link href="2019/03/15/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/3.RocketMQ%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/"/>
      <url>2019/03/15/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/3.RocketMQ%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
      
        <content type="html"><![CDATA[<h1>RocketMQç‰¹ç‚¹å’Œç»„ä»¶</h1><h2 id="consumerå¦‚ä½•æ‰¾åˆ°ä¿¡æ¯ï¼Ÿ"><a class="header-anchor" href="#consumerå¦‚ä½•æ‰¾åˆ°ä¿¡æ¯ï¼Ÿ"></a>consumerå¦‚ä½•æ‰¾åˆ°ä¿¡æ¯ï¼Ÿ</h2><ol><li>consumeré€šè¿‡å‘NameServerè¯¢é—®å…·ä½“çš„Topicæ‰€åœ¨çš„Brokerä¿¡æ¯</li><li>consumeré€šè¿‡å‘Brokerä¿æŒé•¿è¿æ¥çš„å½¢å¼ï¼Œè·å–åˆ°ä¿¡æ¯</li><li>åŒä¸€ç»„ä¸‹çš„consumerä¼šå‘brokerä¸­çš„ä¸åŒMessageQueueæ ¹æ®offsetçš„ä½ç½®è¿›è¡Œè·å–msg,offesetä¼šæ ¹æ®ä¸åŒçš„æ¨¡å¼æœ‰ä¸åŒçš„å®ç°ï¼Œå¦‚æœæ˜¯å¹¿æ’­æ¨¡å¼offsetä¼šä¿å­˜åœ¨ä¸åŒçš„consumerä¸­ï¼Œå¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼offsetæ˜¯ä¿å­˜åœ¨brokerä¸­çš„</li></ol><h2 id="NameServer"><a class="header-anchor" href="#NameServer"></a>NameServer</h2><ul><li><strong>NameServer</strong>æ˜¯æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„çŠ¶æ€æœåŠ¡å™¨ï¼Œé›†ç¾¤çš„å„ä¸ªç»„ä»¶é€šè¿‡å®ƒæ¥äº†è§£å…¨å±€çš„ä¿¡æ¯ã€‚åŒæ—¶ï¼Œå„ä¸ªè§’è‰²çš„æœºå™¨éƒ½è¦å®šæœŸå‘NameServerä¸ŠæŠ¥è‡ªå·±çš„çŠ¶æ€ï¼Œè¶…æ—¶ä¸ä¸ŠæŠ¥çš„è¯ï¼ŒNameServerä¼šè®¤ä¸ºæŸä¸ªæœºå™¨å‡ºæ•…éšœä¸å¯ç”¨äº†ï¼Œå…¶ä»–çš„ç»„ä»¶ä¼šæŠŠè¿™ä¸ªæœºå™¨ä»å¯ç”¨åˆ—è¡¨é‡Œç§»é™¤ã€‚</li><li><strong>NameServe</strong>ræœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´NameServerä¸­çš„Brokerã€Topicç­‰çŠ¶æ€ä¿¡æ¯ä¸ä¼šæŒä¹…å­˜å‚¨ï¼Œéƒ½æ˜¯ç”±å„ä¸ªè§’è‰²å®šæ—¶ä¸ŠæŠ¥å¹¶å­˜å‚¨åˆ°å†…å­˜ä¸­çš„</li></ul><p>NameServerå’Œzkçš„å¯¹æ¯”ï¼š</p><ul><li>NameServeråªæ˜¯ä½œä¸ºä¸€ä¸ªè½»é‡çº§çš„å…ƒæ•°æ®æœåŠ¡å™¨</li><li>zkæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºæä¾›åè°ƒæœåŠ¡<br>RocketMQçš„NameServeråªæœ‰å¾ˆå°‘çš„ä»£ç ï¼Œå®¹æ˜“ç»´æŠ¤ï¼Œæ‰€ä»¥ä¸éœ€è¦å†ä¾èµ–å¦ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä»è€Œå‡å°‘æ•´ä½“ç»´æŠ¤æˆæœ¬</li></ul><h2 id="æ•°æ®çš„å‘é€"><a class="header-anchor" href="#æ•°æ®çš„å‘é€"></a>æ•°æ®çš„å‘é€</h2><p>åº•å±‚æ˜¯ä½¿ç”¨Nettyè¿›è¡Œé€šä¿¡çš„ï¼Œè¿™é‡Œè¿˜è¦è¡¥å……ä¸€ä¸‹</p><h2 id="æ•°æ®çš„å­˜å‚¨"><a class="header-anchor" href="#æ•°æ®çš„å­˜å‚¨"></a>æ•°æ®çš„å­˜å‚¨</h2><p>æ•°æ®çš„å­˜å‚¨æ˜¯ç”¨â€œé›¶æ‹·è´â€æŠ€æœ¯å®ç°çš„</p><h3 id="å­˜å‚¨ç»“æ„"><a class="header-anchor" href="#å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h3><p>RocketMQçš„æ•°æ®å­˜å‚¨ç»“æ„åˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li><strong>CommitLog</strong>æ˜¯å®é™…å­˜å‚¨ä¿¡æ¯çš„å•å…ƒï¼Œé¡ºåºè¿›è¡Œå†™å…¥</li><li><strong>ConsumeQueue</strong>æ˜¯æ¶ˆæ¯çš„é€»è¾‘é˜Ÿåˆ—ï¼Œç±»ä¼¼æ•°æ®åº“çš„ç´¢å¼•æ–‡ä»¶ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘ç‰©ç†å­˜å‚¨çš„åœ°å€</li></ol><p>åˆ·ç›˜ç­–ç•¥åˆ†ä¸º<strong>åŒæ­¥åˆ·ç›˜</strong>ã€<strong>å¼‚æ­¥åˆ·ç›˜</strong></p><p>åŒæ­¥ç­–ç•¥åˆ†ä¸º<strong>åŒæ­¥å¤åˆ¶</strong>ã€<strong>å¼‚æ­¥å¤åˆ¶</strong></p><ul><li>æœ€ä½³å®é™…ï¼š<strong>å¼‚æ­¥åˆ·ç›˜</strong>+<strong>åŒæ­¥å¤åˆ¶</strong></li></ul><h2 id="ç­›é€‰æ¶ˆæ¯"><a class="header-anchor" href="#ç­›é€‰æ¶ˆæ¯"></a>ç­›é€‰æ¶ˆæ¯</h2><p>â€å¯¹ä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼Œå°½å¯èƒ½åªç”¨ä¸€ä¸ªTopicï¼Œä¸åŒçš„æ¶ˆæ¯å­ç±»å‹ç”¨Tagæ¥æ ‡è¯†ï¼ˆæ¯æ¡æ¶ˆæ¯åªèƒ½æœ‰ä¸€ä¸ªTagï¼‰ï¼ŒæœåŠ¡å™¨ç«¯åŸºäºTagè¿›è¡Œè¿‡æ»¤ï¼Œå¹¶ä¸éœ€è¦è¯»å–æ¶ˆæ¯ä½“çš„å†…å®¹ï¼Œæ‰€ä»¥æ•ˆç‡å¾ˆé«˜ã€‚å‘é€æ¶ˆæ¯è®¾ç½®äº†Tagä»¥åï¼Œæ¶ˆè´¹æ–¹åœ¨è®¢é˜…æ¶ˆæ¯æ—¶ï¼Œæ‰å¯ä»¥åˆ©ç”¨Tagåœ¨Brokerç«¯åšæ¶ˆæ¯è¿‡æ»¤ã€‚</p><p>å…¶æ¬¡æ˜¯æ¶ˆæ¯çš„Keyã€‚å¯¹å‘é€çš„æ¶ˆæ¯è®¾ç½®å¥½Keyï¼Œä»¥åå¯ä»¥æ ¹æ®è¿™ä¸ªKeyæ¥æŸ¥æ‰¾æ¶ˆæ¯ã€‚æ‰€ä»¥è¿™ä¸ªKeyä¸€èˆ¬ç”¨æ¶ˆæ¯åœ¨ä¸šåŠ¡å±‚é¢çš„å”¯ä¸€æ ‡è¯†ç æ¥è¡¨ç¤ºï¼Œè¿™æ ·åç»­æŸ¥è¯¢æ¶ˆæ¯å¼‚å¸¸ï¼Œæ¶ˆæ¯ä¸¢å¤±ç­‰éƒ½å¾ˆæ–¹ä¾¿ã€‚Brokerä¼šåˆ›å»ºä¸“é—¨çš„ç´¢å¼•æ–‡ä»¶ï¼Œæ¥å­˜å‚¨Keyåˆ°æ¶ˆæ¯çš„æ˜ å°„ï¼Œç”±äºæ˜¯å“ˆå¸Œç´¢å¼•ï¼Œåº”å°½é‡ä½¿Keyå”¯ä¸€ï¼Œé¿å…æ½œåœ¨çš„å“ˆå¸Œå†²çª</p><p>Tagå’ŒKeyçš„ä¸»è¦å·®åˆ«æ˜¯ä½¿ç”¨åœºæ™¯ä¸åŒï¼ŒTagç”¨åœ¨Consumerçš„ä»£ç ä¸­ï¼Œç”¨æ¥è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯è¿‡æ»¤ï¼ŒKeyä¸»è¦ç”¨äºé€šè¿‡å‘½ä»¤è¡ŒæŸ¥è¯¢æ¶ˆæ¯ã€‚â€œ</p><ul><li><strong>Tag</strong>è¿‡æ»¤æ˜¯åœ¨brokerä»<strong>Consume Queue</strong>ä¸­å–æ•°æ®çš„æ—¶å€™å°±è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨è¿™ä¸€è¿‡ç¨‹ä¸­é€šè¿‡æ¯”è¾ƒtagçš„<strong>hashCodeå€¼</strong>å’Œ<strong>å†…å®¹</strong>è¿›è¡ŒåŒé‡è¿‡æ»¤</li><li><strong>SQLè¿‡æ»¤</strong>ï¼Œé€šè¿‡åœ¨producerå‘æ¶ˆæ¯ä¸­æ’å…¥è‡ªå®šä¹‰å±æ€§å’Œå€¼çš„æ–¹å¼,åœ¨comsumerä¸­ä½¿ç”¨**MessageSelect.bySql()**çš„æ–¹æ³•è¿›è¡Œè¿‡æ»¤</li></ul><h2 id="æé«˜æ¶ˆè´¹é€Ÿåº¦"><a class="header-anchor" href="#æé«˜æ¶ˆè´¹é€Ÿåº¦"></a>æé«˜æ¶ˆè´¹é€Ÿåº¦</h2><ul><li>æé«˜æ¶ˆè´¹å¹¶è¡Œåº¦<ol><li>å¢åŠ Consumerå®ä¾‹æ•°é‡</li><li>å¢åŠ å•ä¸ªConsumerä¸­çš„å¹¶è¡Œåº¦ï¼ˆå¢åŠ çº¿ç¨‹ï¼‰</li></ol></li><li>æ‰¹é‡æ¶ˆè´¹</li><li>è‡ªå®šä¹‰æ¶ˆè´¹offseté€»è¾‘,ä¸¢å¼ƒä¸€éƒ¨åˆ†æ¶ˆæ¯</li></ul><h1>RocketMQä½¿ç”¨é—®é¢˜</h1><h2 id="RocketMQæ‰§è¡Œæµç¨‹"><a class="header-anchor" href="#RocketMQæ‰§è¡Œæµç¨‹"></a>RocketMQæ‰§è¡Œæµç¨‹</h2><ol><li>å¯åŠ¨ Namesrvï¼ŒNamesrvèµ· æ¥åç›‘å¬ç«¯å£ï¼Œç­‰å¾… Brokerã€Producerã€Consumer è¿ä¸Šæ¥ï¼Œç›¸å½“äºä¸€ä¸ªè·¯ç”±æ§åˆ¶ä¸­å¿ƒ</li><li>Broker å¯åŠ¨ï¼Œè·Ÿæ‰€æœ‰çš„ Namesrv ä¿æŒé•¿è¿æ¥ï¼Œå®šæ—¶å‘é€å¿ƒè·³åŒ…</li><li>æ”¶å‘æ¶ˆæ¯å‰ï¼Œå…ˆåˆ›å»º Topic ã€‚åˆ›å»º Topic æ—¶ï¼Œéœ€è¦æŒ‡å®šè¯¥ Topic è¦å­˜å‚¨åœ¨ å“ªäº› Brokerä¸Šã€‚ä¹Ÿå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»ºTopic</li><li>Producer å‘é€æ¶ˆæ¯</li><li>Consumer æ¶ˆè´¹æ¶ˆæ¯</li></ol><h2 id="Produceræ‰§è¡Œæµç¨‹"><a class="header-anchor" href="#Produceræ‰§è¡Œæµç¨‹"></a>Produceræ‰§è¡Œæµç¨‹</h2><ol><li>Producer å¯åŠ¨æ—¶ï¼Œä¹Ÿéœ€è¦æŒ‡å®š Namesrv çš„åœ°å€ï¼Œä» Namesrv é›†ç¾¤ä¸­é€‰ä¸€å°å»ºç«‹é•¿è¿æ¥</li><li>ç”Ÿäº§è€…ç«¯çš„è´Ÿè½½å‡è¡¡,ç”Ÿäº§è€…å‘é€æ—¶ï¼Œä¼šè‡ªåŠ¨è½®è¯¢å½“å‰æ‰€æœ‰å¯å‘é€çš„brokerï¼Œä¸€æ¡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä¸‹æ¬¡æ¢å¦å¤–ä¸€ä¸ªbrokerå‘é€ï¼Œä»¥è¾¾åˆ°æ¶ˆæ¯å¹³å‡è½åˆ°æ‰€æœ‰çš„brokerä¸Š</li></ol><h2 id="Consumer"><a class="header-anchor" href="#Consumer"></a>Consumer</h2><ol><li>Consumer å¯åŠ¨æ—¶éœ€è¦æŒ‡å®š Namesrv åœ°å€ï¼Œä¸å…¶ä¸­ä¸€ä¸ª Namesrv å»ºç«‹é•¿è¿æ¥ã€‚æ¶ˆè´¹è€…æ¯éš” 30 ç§’ä» Namesrv è·å–æ‰€æœ‰Topic çš„æœ€æ–°é˜Ÿåˆ—æƒ…å†µ</li><li>æ¶ˆè´¹è€…ç«¯çš„è´Ÿè½½å‡è¡¡ã€‚æ ¹æ®æ¶ˆè´¹è€…çš„æ¶ˆè´¹æ¨¡å¼ä¸åŒï¼Œè´Ÿè½½å‡è¡¡æ–¹å¼ä¹Ÿä¸åŒã€‚</li></ol><h2 id="æ¶ˆè´¹è€…æ¶ˆè´¹æ¨¡å¼"><a class="header-anchor" href="#æ¶ˆè´¹è€…æ¶ˆè´¹æ¨¡å¼"></a>æ¶ˆè´¹è€…æ¶ˆè´¹æ¨¡å¼</h2><ol><li>é›†ç¾¤æ¶ˆè´¹<br>æ¶ˆè´¹è€…çš„ä¸€ç§æ¶ˆè´¹æ¨¡å¼ã€‚ä¸€ä¸ª Consumer Group ä¸­çš„å„ä¸ª Consumer å®ä¾‹åˆ†æ‘Šå»æ¶ˆè´¹æ¶ˆæ¯ï¼Œå³ä¸€æ¡æ¶ˆæ¯åªä¼šæŠ•é€’åˆ°ä¸€ä¸ª Consumer Group ä¸‹é¢çš„ä¸€ä¸ªå®ä¾‹ã€‚</li><li>å¹¿æ’­æ¶ˆè´¹<br>æ¶ˆè´¹è€…çš„ä¸€ç§æ¶ˆè´¹æ¨¡å¼ã€‚æ¶ˆæ¯å°†å¯¹ä¸€ ä¸ªConsumer Group ä¸‹çš„å„ä¸ª Consumer å®ä¾‹éƒ½æŠ•é€’ä¸€éã€‚å³å³ä½¿è¿™äº› Consumer å±äºåŒä¸€ä¸ªConsumer Group ï¼Œæ¶ˆæ¯ä¹Ÿä¼šè¢« Consumer Group ä¸­çš„æ¯ä¸ª Consumer éƒ½æ¶ˆè´¹ä¸€æ¬¡</li></ol><h2 id="æ¶ˆè´¹è€…è·å–æ¶ˆæ¯æœ‰å‡ ç§æ¨¡å¼"><a class="header-anchor" href="#æ¶ˆè´¹è€…è·å–æ¶ˆæ¯æœ‰å‡ ç§æ¨¡å¼"></a>æ¶ˆè´¹è€…è·å–æ¶ˆæ¯æœ‰å‡ ç§æ¨¡å¼</h2><ol><li>PushConsumer<br>æ¨é€æ¨¡å¼ï¼ˆè™½ç„¶ RocketMQ ä½¿ç”¨çš„æ˜¯é•¿è½®è¯¢ï¼‰çš„æ¶ˆè´¹è€…ã€‚æ¶ˆæ¯çš„èƒ½åŠæ—¶è¢«æ¶ˆè´¹ã€‚é•¿è½®è¯¢æ˜¯brokeråœ¨æ²¡æœ‰æ¶ˆæ¯æ—¶ä¼šholdå½“å‰pullçš„è¯·æ±‚ï¼Œç­‰å¾…æ¶ˆæ¯æˆ–è¶…æ—¶è¿”å›ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQä½¿ç”¨</title>
      <link href="2019/03/14/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/2.RocketMQ%E4%B8%AD%E7%9A%84%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F/"/>
      <url>2019/03/14/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/2.RocketMQ%E4%B8%AD%E7%9A%84%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1>RocketMQä¸­çš„é€šä¿¡æ¨¡å¼</h1><p>åœ¨RocketMQä¸­ä¸º<strong>producer</strong>æä¾›äº†ä¸‰ç§é€šè®¯æ¨¡å¼åˆ†åˆ«æ˜¯<strong>åŒæ­¥</strong>ã€<strong>å¼‚æ­¥</strong>ã€<strong>å•å‘</strong></p><h2 id="åŒæ­¥æ¨¡å¼"><a class="header-anchor" href="#åŒæ­¥æ¨¡å¼"></a>åŒæ­¥æ¨¡å¼</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token class-name">MqConfig</span><span class="token punctuation">.</span>GROUP_ID<span class="token punctuation">,</span> <span class="token function">getAclRPCHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token class-name">MqConfig</span><span class="token punctuation">.</span>NAMESRV_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">MqConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span>                    <span class="token class-name">MqConfig</span><span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//        producer.shutdown();</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨**DefaultMQProducer.send(msg)**å‘é€æ¶ˆæ¯å°±æ˜¯åŒæ­¥çš„ï¼Œå‘brokerå‘é€æ¶ˆæ¯åå°±ç«‹å³è¿”å›</p><h2 id="å¼‚æ­¥æ¨¡å¼"><a class="header-anchor" href="#å¼‚æ­¥æ¨¡å¼"></a>å¼‚æ­¥æ¨¡å¼</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">MqConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span>        <span class="token class-name">MqConfig</span><span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>        <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨<strong>producer.send(msg, new SendCallback())</strong>,ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œè¿™æ ·å‘é€çš„æ¶ˆæ¯æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„</p><h2 id="å•å‘æ¶ˆæ¯"><a class="header-anchor" href="#å•å‘æ¶ˆæ¯"></a>å•å‘æ¶ˆæ¯</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>**producer.sendOneway(msg)**å‘é€çš„æ˜¯å•å‘æ¶ˆæ¯</p><h1>RocketMQä¸­çš„æ¶ˆæ¯ç±»å‹</h1><h2 id="å»¶è¿Ÿæ¶ˆæ¯"><a class="header-anchor" href="#å»¶è¿Ÿæ¶ˆæ¯"></a>å»¶è¿Ÿæ¶ˆæ¯</h2><ul><li>Message.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_DELAY_TIME_LEVEL<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>RocketMQé»˜è®¤åªæ”¯æŒå›ºå®šçš„å»¶è¿Ÿçº§åˆ«ï¼Œå¦‚æœéœ€è¦åšåˆ°è‡ªå®šä¹‰å»¶è¿Ÿçº§åˆ«éœ€è¦è¿›è¡Œæ‰©å±•ã€‚å¯ä»¥ç”¨é•¿è½®è¯¢+çŸ­è½®è¯¢çš„æ–¹å¼å®ç°</p><h2 id="é¡ºåºæ¶ˆæ¯"><a class="header-anchor" href="#é¡ºåºæ¶ˆæ¯"></a>é¡ºåºæ¶ˆæ¯</h2><p>ç”±äºåœ¨ä¸€ä¸ªTopicä¸‹ä¼šæœ‰å¤šä¸ªMessageQueueï¼Œå› æ­¤å½“åŒä¸€ç»„ä¸‹çš„å¤šä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¥æ¶ˆè´¹æ—¶ï¼Œæ•°æ®æ¶ˆè´¹å°±æœ‰å¯èƒ½æ˜¯æ— åºçš„ã€‚</p><ul><li><p>å‘é€é¡ºåº<br><img src="https://s1.ax1x.com/2020/03/15/83MLt0.png" alt="83MLt0.png"></p></li><li><p>æ¶ˆè´¹é¡ºåº<br><a href="https://imgchr.com/i/83QuBd"><img src="https://s1.ax1x.com/2020/03/15/83QuBd.png" alt="83QuBd.png"></a></p></li><li><p>æœ‰åºæ¶ˆæ¯-producer</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> orderId <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">MqConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span>        <span class="token class-name">MqConfig</span><span class="token punctuation">.</span>TAG<span class="token punctuation">,</span>        <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>msg<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">></span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Integer</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> id <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æœ‰åºæ¶ˆæ¯- consumer</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">ConsumeOrderlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeOrderlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Receive New Messages: %s %n"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡orderIdå°†æ‰€å±åŒä¸€æ‰¹æœ‰é¡ºåºçš„msgå‘é€åˆ°åŒä¸€ä¸ªmsssageQueueä¸­ï¼Œæ¥ä¿è¯æ¶ˆè´¹çš„æ¶ˆæ¯çš„æœ‰åº</p><h2 id="äº‹åŠ¡æ¶ˆæ¯"><a class="header-anchor" href="#äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h2><p>mqå®ç°æœ¬åœ°äº‹åŠ¡ä¸»è¦æ˜¯å°†æŠ•é€’æ¶ˆæ¯å®Œæˆçš„åŠ¨ä½œå’Œäº‹åŠ¡æ‰§è¡ŒæˆåŠŸçš„åŠ¨ä½œç»“åˆåœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªåŸå­æ“ä½œã€‚å½“æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸå°±æŠ•é€’äº‹åŠ¡å®Œæˆçš„æ¶ˆæ¯ã€‚</p><ul><li>äº‹åŠ¡æ¶ˆæ¯ï¼šæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ç‰ˆæä¾›ç±»ä¼¼ X/Open XA çš„åˆ†å¸ƒå¼äº‹åŠ¡åŠŸèƒ½ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ— RocketMQ ç‰ˆäº‹åŠ¡æ¶ˆæ¯èƒ½è¾¾åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´ã€‚</li><li>åŠäº‹åŠ¡æ¶ˆæ¯ï¼šæš‚ä¸èƒ½æŠ•é€’çš„æ¶ˆæ¯ï¼Œå‘é€æ–¹å·²ç»æˆåŠŸåœ°å°†æ¶ˆæ¯å‘é€åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ— RocketMQ ç‰ˆæœåŠ¡ç«¯ï¼Œä½†æ˜¯æœåŠ¡ç«¯æœªæ”¶åˆ°ç”Ÿäº§è€…å¯¹è¯¥æ¶ˆæ¯çš„äºŒæ¬¡ç¡®è®¤ï¼Œæ­¤æ—¶è¯¥æ¶ˆæ¯è¢«æ ‡è®°æˆâ€œæš‚ä¸èƒ½æŠ•é€’â€çŠ¶æ€ï¼Œå¤„äºè¯¥ç§çŠ¶æ€ä¸‹çš„æ¶ˆæ¯å³åŠäº‹åŠ¡æ¶ˆæ¯ã€‚</li><li>æ¶ˆæ¯å›æŸ¥ï¼šç”±äºç½‘ç»œé—ªæ–­ã€ç”Ÿäº§è€…åº”ç”¨é‡å¯ç­‰åŸå› ï¼Œå¯¼è‡´æŸæ¡äº‹åŠ¡æ¶ˆæ¯çš„äºŒæ¬¡ç¡®è®¤ä¸¢å¤±ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ç‰ˆæœåŠ¡ç«¯é€šè¿‡æ‰«æå‘ç°æŸæ¡æ¶ˆæ¯é•¿æœŸå¤„äºâ€œåŠäº‹åŠ¡æ¶ˆæ¯â€æ—¶ï¼Œéœ€è¦ä¸»åŠ¨å‘æ¶ˆæ¯ç”Ÿäº§è€…è¯¢é—®è¯¥æ¶ˆæ¯çš„æœ€ç»ˆçŠ¶æ€ï¼ˆCommit æˆ–æ˜¯ Rollbackï¼‰ï¼Œè¯¥è¯¢é—®è¿‡ç¨‹å³æ¶ˆæ¯å›æŸ¥ã€‚</li></ul><h2 id="æœ€ä½³å®è·µ"><a class="header-anchor" href="#æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="Topic-ä¸-Tag"><a class="header-anchor" href="#Topic-ä¸-Tag"></a>Topic ä¸ Tag</h3><ul><li><p><strong>Topic</strong>æ¶ˆæ¯ä¸»é¢˜ï¼Œé€šè¿‡ Topic å¯¹ä¸åŒçš„ä¸šåŠ¡æ¶ˆæ¯è¿›è¡Œåˆ†ç±»</p></li><li><p><strong>Tag</strong>æ¶ˆæ¯æ ‡ç­¾ï¼Œç”¨æ¥è¿›ä¸€æ­¥åŒºåˆ†æŸä¸ª Topic ä¸‹çš„æ¶ˆæ¯åˆ†ç±»ï¼Œæ¶ˆæ¯ä»ç”Ÿäº§è€…å‘å‡ºå³å¸¦ä¸Šçš„å±æ€§</p></li></ul><h3 id="æ¶ˆè´¹å¹‚ç­‰"><a class="header-anchor" href="#æ¶ˆè´¹å¹‚ç­‰"></a>æ¶ˆè´¹å¹‚ç­‰</h3><p>å› ä¸ºæ’é™¤æ¶ˆæ¯çš„é‡å¤å¹¶ä¸å±äºmqçš„èŒè´£ï¼Œè€Œæ˜¯ä¸šåŠ¡ç«¯éœ€è¦è¿›è¡Œå¤„ç†çš„ã€‚å¤„ç†é‡å¤æ¶ˆæ¯ä¸»è¦æ˜¯ç”¨ä¸šåŠ¡å¹‚ç­‰çš„æ–¹å¼æ¥è¿›è¡Œå¤„ç†;<br>è¿˜æœ‰ä¸€ç§è®°å½•é‡å¤æ¶ˆæ¯æ¶ˆè´¹çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨æ—¥å¿—è¡¨æ¥è¿›è¡Œå¤„ç†ã€‚</p><h3 id="è®¢é˜…å…³ç³»"><a class="header-anchor" href="#è®¢é˜…å…³ç³»"></a>è®¢é˜…å…³ç³»</h3><p>è®¢é˜…å…³ç³»ä¸€è‡´æŒ‡çš„æ˜¯åŒä¸€ä¸ªæ¶ˆè´¹è€… Group ID ä¸‹æ‰€æœ‰ Consumer å®ä¾‹çš„å¤„ç†é€»è¾‘å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚å…·ä½“æ¥è¯´å°±æ˜¯åŒä¸€ä¸ªæ¶ˆè´¹è€… Group ID ä¸‹æ‰€æœ‰çš„å®ä¾‹éœ€åœ¨ï¼š</p><ol><li>è®¢é˜…çš„ Topic å¿…é¡»ä¸€è‡´</li><li>è®¢é˜…çš„ Topic ä¸­çš„ Tag å¿…é¡»ä¸€è‡´</li></ol><p>å› ä¸ºè¿™æ ·æ‰èƒ½æŒ‰ç…§å¹¿æ’­æˆ–è€…é›†ç¾¤çš„æ¶ˆè´¹æ¨¡å¼å»å…±åŒæ¶ˆè´¹åŒä¸€æ‰¹çš„æ¶ˆæ¯ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><p><img src="https://help.aliyun.com/document_detail/43348.html?spm=a2c4g.11186623.2.17.40004fa4DZswLK#concept-2047067" alt="äº‹åŠ¡æ¶ˆæ¯"></p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQå…¥é—¨</title>
      <link href="2019/03/13/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/1.RocketMQ%E5%85%A5%E9%97%A8/"/>
      <url>2019/03/13/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/1.RocketMQ%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h1>RocketMQå…¥é—¨</h1><p>åœ¨å·¥ä½œä¸­åªæ˜¯ç®€å•çš„ä½¿ç”¨äº†ä¸€ä¸‹kafkaè¿›è¡Œç³»ç»Ÿé—´çš„äº¤äº’ï¼Œå¹¶æœªå¥½å¥½çš„ç³»ç»ŸåŒ–çš„å­¦ä¹ ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—è¿™ä¸ªå·¥å…·ã€‚å› æ­¤é€‰æ‹©ä»é˜¿é‡Œå‡ºæ¥çš„RocketMQæ¥è¿›è¡Œä¸€ä¸ªå­¦ä¹ ï¼Œå†æ¥å°±æ˜¯RocketMQæœ¬èº«ä¹Ÿæ˜¯ç”¨javaè¯­è¨€è¿›è¡Œå¼€å‘çš„ä¸€ä¸ªé¡¹ç›®ã€‚</p><h2 id="å®‰è£…"><a class="header-anchor" href="#å®‰è£…"></a>å®‰è£…</h2><h3 id="å®‰è£…å‰æ"><a class="header-anchor" href="#å®‰è£…å‰æ"></a>å®‰è£…å‰æ</h3><p>éœ€è¦æ‹¥æœ‰ä»¥ä¸‹è½¯ä»¶ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿ(æ¨èä½¿ç”¨64ä½)</li><li>jdk1.8 (æ¨èä½¿ç”¨64ä½çš„)</li><li>Maven 3.2x</li><li>Git</li><li>4Gä»¥ä¸Šçš„ç©ºé—´</li></ul><h4 id="å®‰è£…jdk"><a class="header-anchor" href="#å®‰è£…jdk"></a>å®‰è£…jdk</h4><ul><li>ä¸‹è½½<a href="https://www.oracle.com/cn/java/technologies/javase-jdk8-downloads.html">jdk</a></li></ul><ol><li>è§£å‹<br>æ‰§è¡Œ</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tar</span> -zvxf jdk-8u201-linux-x64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ä¿®æ”¹/etc/profile</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/home/java/jdk1.8.0_60<span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/lib/<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span> JAVA_HOME CLASSPATH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li><p>source /etc/profile</p></li><li><p>æ£€æŸ¥ java -version</p></li></ol><h4 id="å®‰è£…Maven"><a class="header-anchor" href="#å®‰è£…Maven"></a>å®‰è£…Maven</h4><ul><li>ä¸‹è½½<a href="https://maven.apache.org/download.cgi">mav</a></li></ul><ol><li>è§£å‹ã€è®¾ç½®ç¯å¢ƒpathã€ç”Ÿæ•ˆ</li></ol><h4 id="å®‰è£…Git"><a class="header-anchor" href="#å®‰è£…Git"></a>å®‰è£…Git</h4><ul><li>æ›´æ–°æº</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> update -y<span class="token function">apt-get</span> upgrade -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å®‰è£…git</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">apt install git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>git --version</li></ul><h4 id="å®‰è£…RocketMQ"><a class="header-anchor" href="#å®‰è£…RocketMQ"></a>å®‰è£…RocketMQ</h4><ol><li><p>è§£å‹</p></li><li><p>ä¿®æ”¹å†…å­˜è®¾ç½®</p></li></ol><ul><li><a href="http://runserver.sh">runserver.sh</a></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span> <span class="token operator">!</span> -e <span class="token string">"<span class="token variable">$JAVA_HOME</span>/bin/java"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/jdk/java<span class="token punctuation">[</span> <span class="token operator">!</span> -e <span class="token string">"<span class="token variable">$JAVA_HOME</span>/bin/java"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/java<span class="token punctuation">[</span> <span class="token operator">!</span> -e <span class="token string">"<span class="token variable">$JAVA_HOME</span>/bin/java"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> error_exit <span class="token string">"Please set the JAVA_HOME variable in your environment, We need java(x64)!"</span><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=32m -XX:MaxMetaspaceSize=64m"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="http://runbroker.sh">runbroker.sh</a></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span> <span class="token operator">!</span> -e <span class="token string">"<span class="token variable">$JAVA_HOME</span>/bin/java"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/home/java/jdk1.8.0_60<span class="token comment">#[ ! -e "$JAVA_HOME/bin/java" ] &amp;&amp; JAVA_HOME=/usr/java</span><span class="token comment">#[ ! -e "$JAVA_HOME/bin/java" ] &amp;&amp; error_exit "Please set the JAVA_HOME variable in your environment, We need java(x64)!"</span><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m"</span><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;JAVA_OPT&#125;</span> -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:SoftRefLRUPolicyMSPerMB=0"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>å¯åŠ¨NameServer</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> <span class="token function">sh</span> bin/mqnamesrv <span class="token operator">&amp;</span><span class="token function">tail</span> -f ~/logs/rocketmqlogs/namesrv.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>å¯åŠ¨Broker</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> <span class="token function">sh</span> bin/mqbroker -n localhost:9876 <span class="token operator">&amp;</span><span class="token function">tail</span> -f ~/logs/rocketmqlogs/broker.log <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="4"><li>å‘é€å’Œæ¥æ”¶æ¶ˆæ¯</li></ol><ul><li>Producer</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// æ„é€ Producer</span>        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"ProducerGroupName12345"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"TagA"</span><span class="token punctuation">,</span>                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ!!!"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//        producer.shutdown();</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Consumer</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"PushMsgGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_FIRST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"Receive New Messages :"</span> <span class="token operator">+</span> msgs <span class="token operator">+</span> <span class="token string">"%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°è¿è¡Œç¯å¢ƒæ˜¯åœ¨windowså­ç³»ç»Ÿä¸­è¿›è¡Œè¿è¡Œçš„,ä½†æ˜¯ç”±äºç½‘ç»œçš„é—®é¢˜producerä¸€ç›´è¿æ¥ä¸ä¸Šbrokerï¼Œå¯¼è‡´å®éªŒå¤±è´¥ã€‚æœ€ååˆ‡æ¢åˆ°windowsç¯å¢ƒä¸‹ï¼Œè¿è¡Œå€’æ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯ç”±äºcç›˜å¤ªå°äº†ï¼Œæ¯æ¬¡éƒ½è¦åˆ é™¤commitLogè¿›è¡Œè¿è¡Œï¼Œå®åœ¨æ˜¯å¤ªè€—è´¹ç²¾åŠ›å’Œæ—¶é—´äº†ï¼Œæ‰€ä»¥ä¸åœ¨ç¯å¢ƒé—®é¢˜ä¸Šçº ç»“äº†ã€‚</p><p>##RocketMQä¸­çš„åŸºç¡€æ¦‚å¿µ</p><ul><li><p>NameServer<br><strong>NameServer</strong>åŠŸèƒ½è¿‘ä¼¼äºzkï¼Œç‰©ç†é€»è¾‘ä¸Šçš„<strong>broker</strong>å¯åŠ¨åå‘NameServeræ³¨å†Œã€‚NameServelæ˜¯ä¸€ç§æ— çŠ¶æ€çš„ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜çš„éƒ½æ˜¯å…¨é‡çš„<strong>Broker</strong>èŠ‚ç‚¹ä¿¡æ¯ï¼Œå…¶ä»–èŠ‚ç‚¹é€šè¿‡å’ŒNameServerä¿æŒé•¿è¿æ¥æ¥è·å–ä¿¡æ¯</p></li><li><p>broker<br><strong>broker</strong>ç±»ä¼¼äºç‰©ç†é€»è¾‘ä¸Šçš„æœºå™¨ï¼Œæ”¯æŒä¸»ä»éƒ¨ç½²ï¼Œæ˜¯å®é™…äºæ¶ˆæ¯ä½“äº¤äº’çš„</p></li><li></li></ul><p>producer<br><strong>producer</strong>æ¶ˆæ¯çš„æä¾›æ–¹</p><p>comsumer<br><strong>comsumer</strong>æ¶ˆæ¯çš„æ¶ˆè´¹æ–¹</p><p>å…·ä½“çš„äº¤äº’é€»è¾‘ï¼Œå¦‚ä¸‹å›¾å±•ç¤ºï¼š<br><img src="https://s1.ax1x.com/2020/03/14/8luQ76.png" alt="8luQ76.png"></p><ul><li>å®˜æ–¹å›¾<br><img src="https://s1.ax1x.com/2020/03/14/8lKAbt.png" alt="8lKAbt.png"></li></ul><blockquote><p>å‚è€ƒæ–‡ç« </p></blockquote><p><img src="https://segmentfault.com/a/1190000017841402#item-3-8" alt="RocketMQå…¥é—¨ç¯‡"><br><img src="https://blog.csdn.net/micholas_net/article/details/89178761" alt="windowsä¸‹å®‰è£…rocketMQ"></p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯é˜Ÿåˆ— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯»ä¹¦åˆ—è¡¨</title>
      <link href="2019/03/13/1.%E6%9D%82%E8%AE%B0/%E8%AF%BB%E4%B9%A6%E5%88%97%E8%A1%A8/"/>
      <url>2019/03/13/1.%E6%9D%82%E8%AE%B0/%E8%AF%BB%E4%B9%A6%E5%88%97%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<h1>è¯»ä¹¦åˆ—è¡¨</h1><h2 id="æ­£åœ¨è¯»"><a class="header-anchor" href="#æ­£åœ¨è¯»"></a>æ­£åœ¨è¯»</h2><table><thead><tr><th>åç§°</th><th>çŠ¶æ€</th></tr></thead><tbody><tr><td>ã€ŠEffective Javaä¸­æ–‡ç‰ˆã€‹</td><td>ing</td></tr><tr><td>ã€ŠJavaå®æˆ˜ã€‹</td><td>ing</td></tr><tr><td>ã€ŠJavaå¼‚æ­¥ç¼–ç¨‹å®æˆ˜ã€‹</td><td>ing</td></tr></tbody></table><h2 id="è¯»è¿‡"><a class="header-anchor" href="#è¯»è¿‡"></a>è¯»è¿‡</h2><table><thead><tr><th>åç§°</th><th>çŠ¶æ€</th></tr></thead><tbody><tr><td>ã€Šé‡æ„â€“æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹</td><td>end</td></tr><tr><td>ã€Šå¤§è¯è®¾è®¡æ¨¡å¼ã€‹</td><td>end</td></tr><tr><td>ã€ŠRocketMQå®æˆ˜ä¸åŸç†è§£æã€‹</td><td>end</td></tr><tr><td>ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</td><td>end</td></tr><tr><td>ã€ŠMySQLæŠ€æœ¯å†…å¹•.InnoDBå­˜å‚¨å¼•æ“ã€‹</td><td>end</td></tr></tbody></table>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="2019/02/25/hello-world/"/>
      <url>2019/02/25/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a class="header-anchor" href="#Quick-Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a class="header-anchor" href="#Create-a-new-post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a class="header-anchor" href="#Run-server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a class="header-anchor" href="#Generate-static-files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a class="header-anchor" href="#Deploy-to-remote-sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> å…¶ä»– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisåŸºç¡€çŸ¥è¯†</title>
      <link href="2019/02/25/1.%E6%9D%82%E8%AE%B0/redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>2019/02/25/1.%E6%9D%82%E8%AE%B0/redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h3 id="åŸºæœ¬æ•°æ®ç»“æ„"><a class="header-anchor" href="#åŸºæœ¬æ•°æ®ç»“æ„"></a>åŸºæœ¬æ•°æ®ç»“æ„</h3><table><thead><tr><th>ç±»å‹</th><th>ç‰¹ç‚¹</th></tr></thead><tbody><tr><td>string</td><td>å­—ç¬¦ä¸²</td></tr><tr><td>list</td><td>åˆ—è¡¨</td></tr><tr><td>set</td><td>ä¸é‡å¤åˆ—è¡¨</td></tr><tr><td>hash</td><td>å“ˆå¸Œ</td></tr><tr><td>zset</td><td>æœ‰åºé›†åˆ</td></tr></tbody></table><p>Redisä¸­çš„hashæ˜¯æ¸è¿›å¼hash,ä¸ä¼šåœ¨æ‰©å®¹æ—¶æš‚åœï¼Œè€Œæ˜¯ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„hashæ¥ä¿å­˜</p><h3 id="åŸºç¡€æ“ä½œ"><a class="header-anchor" href="#åŸºç¡€æ“ä½œ"></a>åŸºç¡€æ“ä½œ</h3><h4 id="å­—ç¬¦ä¸²"><a class="header-anchor" href="#å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h4><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>1</td><td>SET key value [EX seconds|PX milliseconds|KEEPTTL] [NX|XX]</td><td>è®¾ç½®å­—ç¬¦ä¸²</td><td>set key value</td></tr><tr><td>2</td><td>GET key</td><td>è·å–å­—ç¬¦ä¸²</td><td>get key</td></tr><tr><td>3</td><td>EXISTS key [key â€¦]</td><td>åˆ¤æ–­æ˜¯å¦å­˜åœ¨</td><td>exists key</td></tr><tr><td>4</td><td>DEL key [key â€¦]</td><td>åˆ é™¤key</td><td>del key</td></tr></tbody></table><h4 id="åˆ—è¡¨"><a class="header-anchor" href="#åˆ—è¡¨"></a>åˆ—è¡¨</h4><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>1</td><td>RPUSH key element [element â€¦]</td><td>è£…è½½å…ƒç´ </td><td>rpush list item0</td></tr><tr><td>2</td><td>LLEN key</td><td>è¿”å›é•¿åº¦</td><td>LLEN list</td></tr><tr><td>3</td><td>LPOP key</td><td>å¼¹å‡ºç¬¬ä¸€ä¸ªå…ƒç´ </td><td>LPOP list</td></tr><tr><td>4</td><td>RPOP key</td><td>å¼¹å‡ºæœ€åä¸€ä¸ªå…ƒç´ </td><td>RPOP list</td></tr><tr><td>5</td><td>LINDEX key index</td><td>æ ¹æ®ç´¢å¼•æŸ¥è¯¢å…ƒç´ </td><td>LINDEX list 0</td></tr><tr><td>6</td><td>LRANGE key start stop</td><td>æŒ‰ç…§èŒƒå›´è·å–å…ƒç´ </td><td>lrange books 0 -1</td></tr><tr><td>7</td><td>LTRIM list start stop</td><td>æˆªå–list</td><td>LTRIM list 0 1</td></tr></tbody></table><h4 id="hash-å­—å…¸"><a class="header-anchor" href="#hash-å­—å…¸"></a>hash(å­—å…¸)</h4><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>1</td><td>HSET key field value [field value â€¦]</td><td>è£…è½½å…ƒç´ </td><td>hset map key value</td></tr><tr><td>2</td><td>HGET key field</td><td>è·å–æŒ‡å®šå…ƒç´ </td><td>hget map key</td></tr><tr><td>3</td><td>HGETALL key</td><td>è·å–å…¨éƒ¨å…ƒç´ </td><td>hgetall map</td></tr><tr><td>4</td><td>HLEN key</td><td>è·å–mapé•¿åº¦</td><td>hlen map</td></tr></tbody></table><h4 id="set-é›†åˆ"><a class="header-anchor" href="#set-é›†åˆ"></a>set(é›†åˆ)</h4><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>1</td><td>SADD set keyâ€¦</td><td>è£…è½½å…ƒç´ </td><td>sadd set item1</td></tr><tr><td>2</td><td>SMEMBERS set</td><td>è·å–å…¨éƒ¨å…ƒç´ </td><td>smembers set</td></tr><tr><td>3</td><td>SCARD set</td><td>è·å–seté•¿åº¦</td><td>scard set</td></tr><tr><td>4</td><td>SPOP set</td><td>å¼¹å‡ºå…ƒç´ </td><td>spop set</td></tr></tbody></table><h4 id="zset-æœ‰åºé›†åˆ"><a class="header-anchor" href="#zset-æœ‰åºé›†åˆ"></a>zset(æœ‰åºé›†åˆ)</h4><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>1</td><td>ZADD key [NX|XX] [CH] [INCR] score member [score member â€¦]</td><td>æ·»åŠ å…ƒç´ </td><td>zadd books 9.0 â€œthink in javaâ€</td></tr><tr><td>2</td><td>ZRANGE key start stop [WITHSCORES]</td><td>æŒ‰ç…§å…ƒç´ èŒƒå›´å–å€¼</td><td>zrange books 0 -1</td></tr><tr><td>3</td><td>ZREVRANGE key start stop [WITHSCORES]</td><td>å€’åºå–å€¼</td><td>zrevrange books 0 -1</td></tr><tr><td>4</td><td>ZCARD key</td><td>è·å–é•¿åº¦</td><td>zcard books</td></tr><tr><td>5</td><td>ZRANK key</td><td>è·å–åˆ†æ•°</td><td>zrank books</td></tr><tr><td>6</td><td>ZRANGEBYSCORE key start stop</td><td>æ ¹æ®åˆ†å€¼åŒºé—´éå†</td><td>zrangebyscore key 0 -1</td></tr><tr><td>7</td><td>ZREM set key</td><td>åˆ é™¤å…ƒç´ </td><td>zrem books item1</td></tr></tbody></table><h4 id="è¿ç»´"><a class="header-anchor" href="#è¿ç»´"></a>è¿ç»´</h4><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>1</td><td>keys</td><td>æ ¹æ®æ­£åˆ™åŒ¹é…æŸ¥è¯¢(æ…ç”¨)</td><td>keys *</td></tr></tbody></table><h4 id="Redisåˆ é™¤è¿‡æœŸKeyçš„ç­–ç•¥"><a class="header-anchor" href="#Redisåˆ é™¤è¿‡æœŸKeyçš„ç­–ç•¥"></a>Redisåˆ é™¤è¿‡æœŸKeyçš„ç­–ç•¥</h4><ol><li>å°†å…·æœ‰è¿‡æœŸæ—¶é—´è®¾ç½®çš„keyæ”¾åœ¨ä¸€ä¸ªç‰¹æ®Šçš„é˜Ÿåˆ—ä¸­</li><li>æ¯ç§’æ‰«æ10æ¬¡è¿›è¡Œè¿‡æœŸkeyçš„åˆ é™¤æ“ä½œ<br>2.1 éšæœºä»è¿‡æœŸçš„keyä¸­è·å–20ä¸ªæ•°æ®<br>2.2 åˆ¤æ–­keyæ˜¯å¦è¿‡æœŸ,è¿‡æœŸè¿›è¡Œåˆ é™¤<br>2.3 å¦‚æœç­›é€‰å‡ºæ¥çš„æ•°æ®æœ‰è¶…è¿‡1/4éœ€è¦åˆ é™¤,é‚£ä¹ˆé‡å¤è¿›è¡Œ2.1çš„æ“ä½œ<br>ç”±äºRedisåœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ä¼šé˜»å¡ä¸»çº¿ç¨‹,å› æ­¤åœ¨â€™set key nxâ€™æ—¶éœ€è¦æ³¨æ„keyçš„è¿‡æœŸæ—¶é—´,å°½é‡é¿å…å¤§é‡çš„keyåœ¨åŒä¸€æ—¶é—´åˆ é™¤,é˜»å¡ä¸šåŠ¡</li></ol><p>è¿™ç§åˆ é™¤æ–¹å¼ç§°ä¸ºâ€™ä¸»åŠ¨åˆ é™¤â€™,è¿˜æœ‰ä¸€ç§åˆ é™¤æ–¹å¼æ˜¯åœ¨ä½¿ç”¨æ—¶checkæ—¶é—´,å½“è¶…æ—¶æ—¶ä¼šè¿›è¡Œåˆ é™¤è¿™ç§æ–¹å¼è¢«ç§°ä¸ºâ€™æƒ°æ€§åˆ é™¤â€™</p><h4 id="Redisçš„æ·˜æ±°ç­–ç•¥"><a class="header-anchor" href="#Redisçš„æ·˜æ±°ç­–ç•¥"></a>Redisçš„æ·˜æ±°ç­–ç•¥</h4><ol><li>ä¸æ¥å—writeè¯·æ±‚,ä¿æŒç°æœ‰key(é»˜è®¤ç­–ç•¥)</li><li>LRUç­–ç•¥<br>2.1 è¿‡æœŸæ—¶é—´(æ·˜æ±°è®¾ç½®è¿‡æœŸæ—¶é—´çš„key,æŒ‰ç…§æœ€å°‘ä½¿ç”¨çš„åŸåˆ™)<br>2.2 å‰©ä½™æ—¶é—´(æ·˜æ±°å‰©ä½™æ—¶é—´æœ€å°çš„æ—¶é—´)<br>2.3 è¿‡æœŸæ—¶é—´(æŒ‰ç…§éšæœºçš„æ–¹å¼è¿›è¡Œæ·˜æ±°)<br>2.4 å…¨éƒ¨key(æŒ‰ç…§æœ€å°‘ä½¿ç”¨çš„åŸåˆ™è¿›è¡Œæ·˜æ±°)<br>2.5 å…¨éƒ¨key(éšæœºæ·˜æ±°)<br>å°ç»“:Redisæ·˜æ±°keyçš„èŒƒå›´ä¸»è¦æœ‰ä¸¤ç§â€™è¿‡æœŸkeyâ€™å’Œâ€™å…¨é‡keyâ€™,ç­›é€‰ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§:â€˜æ—¶é—´/ä½¿ç”¨é¢‘ç‡â€™å’Œâ€™éšæœºâ€™</li></ol><h4 id="å¤§keyæŸ¥è¯¢"><a class="header-anchor" href="#å¤§keyæŸ¥è¯¢"></a>å¤§keyæŸ¥è¯¢</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./redis-cli --bigkeys -i <span class="token number">0.01</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="åŸç†åˆ†æ"><a class="header-anchor" href="#åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><h3 id="å­—ç¬¦ä¸²-v2"><a class="header-anchor" href="#å­—ç¬¦ä¸²-v2"></a>å­—ç¬¦ä¸²</h3><h4 id="æ•°æ®ç»“æ„"><a class="header-anchor" href="#æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><p>Redisçš„å­—ç¬¦ä¸²ç»“æ„åº•å±‚æ˜¯é€šè¿‡â€™æ•°ç»„â€™æ¥å®ç°çš„,æ•°æ®æ ¼å¼åˆ†ä¸ºä¸¤ç§ç±»å‹:</p><ol><li>embæ ¼å¼<br>é’ˆå¯¹å®¹é‡è¾ƒå°çš„å­—ç¬¦ä¸²é‡‡ç”¨çš„æ˜¯embæ ¼å¼,embçš„ç‰¹ç‚¹æ˜¯æ•°æ®çš„å…ƒæ•°æ®å’Œå†…å®¹åœ¨å†…å­˜ä¸Šæ˜¯è¿ç»­çš„.è¿™æ ·åšçš„å¥½å¤„æ˜¯èŠ‚çœäº†å…ƒæ•°æ®çš„ç©ºé—´</li><li>rawæ ¼å¼<br>é’ˆå¯¹æ™®é€šæ•°æ®é‡‡ç”¨çš„æ˜¯rawæ ¼å¼,è¿™ç§æ ¼å¼åœ¨è®°å½•å…ƒæ•°æ®å’Œå†…å®¹åœ¨å†…å­˜ä¸Šä¸æ˜¯è¿ç»­çš„,éœ€è¦ç»è¿‡ä¸¤æ¬¡å†…å­˜åˆ†é…,å¥½å¤„æ˜¯ç©ºé—´å¯ä»¥è¾ƒå¤§,ä½†æ˜¯å…ƒæ•°æ®å ç”¨ç©ºé—´è¾ƒå¤š<br>çŒœæµ‹redisæœ€å¼€å§‹åº”è¯¥æ˜¯ä¸æ”¯æŒembæ ¼å¼çš„,ä½†æ˜¯ç”±äºredisåœ¨ä½¿ç”¨æ—¶,å¤§éƒ¨åˆ†åœºæ™¯ä¸‹éƒ½æ˜¯å­˜å‚¨è¾ƒå°çš„å­—ç¬¦ä¸²,å› æ­¤åæ¥æ‰æ”¯æŒembè¿™ç§æ ¼å¼çš„.ç”±äºå¤§éƒ¨åˆ†æ˜¯å°å­—ç¬¦ä¸²å› æ­¤è¿™æ ·çš„æ”¹åŠ¨ä¼šä¼˜åŒ–å¾ˆå¤§ä¸€éƒ¨åˆ†å†…å­˜ç©ºé—´</li></ol><h4 id="dict-å­—å…¸-ç»“æ„"><a class="header-anchor" href="#dict-å­—å…¸-ç»“æ„"></a>dict(å­—å…¸)ç»“æ„</h4><p>dictæ˜¯Rediså†…éƒ¨ä½¿ç”¨æœ€é¢‘ç¹çš„ç»“æ„,ç”±äºRedisåœ¨æ˜¯åœ¨åˆå§‹åŒ–dictæ—¶è¿›è¡Œå†…å­˜åˆ†é…,å› æ­¤åœ¨æ‰©å®¹æ—¶é‡‡ç”¨çš„æ˜¯â€™æ¸è¿›å¼â€™æ‰©å®¹çš„æ–¹å¼.<br>Redisçš„æ¸è¿›å¼æ‰©å®¹éœ€è¦ç”¨åˆ°å¦å¤–ä¸€ä¸ªhashtable,åœ¨è¿ç§»æ•°æ®çš„è¿‡ç¨‹ä¸­å¯¹äºsetæ“ä½œä¼šç›´æ¥setåˆ°æ–°çš„hashtableä¸Š,å¯¹äºputæ“ä½œä¼šå¯¹ä¸¤ä¸ªhashtableè¿›è¡ŒæŸ¥æ‰¾<br>æ‰©å®¹é»˜è®¤çš„é˜€å€¼æ˜¯éœ€è¦è¾¾åˆ°åŸhashtableçš„é•¿åº¦,æ‰ä¼šå¯¹hashtableè¿›è¡Œä¸€å€å®¹é‡çš„æ‰©å®¹.ç¼©å®¹çš„æ¡ä»¶æ˜¯æ•°æ®ä¸æ»¡æ•°ç»„é•¿åº¦çš„1/10æ—¶</p><h4 id="è·³è·ƒåˆ—è¡¨ç»“æ„"><a class="header-anchor" href="#è·³è·ƒåˆ—è¡¨ç»“æ„"></a>è·³è·ƒåˆ—è¡¨ç»“æ„</h4><p>è·³è·ƒåˆ—è¡¨æ˜¯å®ç°zsetçš„å…³é”®,zsetæ˜¯ç”±hashtableå’Œè·³è·ƒåˆ—è¡¨è¿™ä¸¤ç§æ•°æ®ç»“æ„ç»„æˆ<br><img src="https://oscimg.oschina.net/oscnet/c88f04bbc62a5510e106502e65b5b374541.png" alt="è·³è·ƒè¡¨"></p><ul><li>è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹,è·³è·ƒè¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(log(n))ä¸äºŒåˆ†æ³•çš„æ—¶é—´å¤æ‚åº¦ç±»ä¼¼,è·³è·ƒè¡¨æ˜¯åº•å±‚æ•°æ®ç»“æ„å¹¶ä¸æ˜¯æŸ¥è¯¢ç®—æ³•è¿™é‡Œéœ€è¦é¢å¤–æ³¨æ„ä¸€ä¸‹.zsetçš„åº•å±‚æ•°æ®ç»“æ„é€‰æ‹©è·³è·ƒè¡¨çš„åŸå› å¤§æ¦‚æ˜¯å› ä¸ºè·³è·ƒè¡¨æ•°æ®ç»“æ„ç®€å•,å¹¶ä¸”åœ¨å±‚çº§éšæœºçš„å‰æä¸‹æ€§èƒ½è¿˜è¡Œ,å¹¶ä¸”æ”¯æŒèŒƒå›´æŸ¥è¯¢,è¿™æ˜¯çº¢é»‘æ ‘/ å¹³è¡¡æ ‘æ‰€ä¸èƒ½æ”¯æŒçš„,</li><li>è·³è·ƒåˆ—è¡¨çš„æ›´æ–°åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤,å…ˆåˆ é™¤åŸæ¥çš„èŠ‚ç‚¹,åœ¨å°†æ–°çš„èŠ‚ç‚¹æ’å…¥è·³è·ƒåˆ—è¡¨ä¸­</li></ul><h2 id="ç¤ºä¾‹"><a class="header-anchor" href="#ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><h3 id="rediåˆ†å¸ƒå¼é”"><a class="header-anchor" href="#rediåˆ†å¸ƒå¼é”"></a>rediåˆ†å¸ƒå¼é”</h3><h3 id="å®ç°åŸç†"><a class="header-anchor" href="#å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>redisåˆ†å¸ƒå¼é”å®ç°çš„åŸç†æ˜¯ï¼Œå¤šä¸ªè¿›ç¨‹åŒæ—¶ç«äº‰åŒä¸€ä¸ªå…±äº«èµ„æºï¼Œæ‹¥æœ‰è¿™ä¸ªèµ„æºçš„çº¿ç¨‹å°±å¯ä»¥æ‰§è¡Œï¼Œå…¶ä»–è¿›ç¨‹ç­‰å¾…æ‰§è¡Œçº¿ç¨‹é‡Šæ”¾ã€‚</p><h3 id="é—®é¢˜"><a class="header-anchor" href="#é—®é¢˜"></a>é—®é¢˜</h3><p>åŠ é”ï¼š</p><ol><li>setå’Œgetæ˜¯ä¸¤ä¸ªå‘½ä»¤ï¼Œå› æ­¤è¦ç”¨<strong>set nx</strong></li><li>ä¸ä¼šè‡ªåŠ¨è¿‡æœŸï¼Œå› æ­¤è¦ç”¨<strong>px</strong>,è®¾å®šè¿‡æœŸæ—¶é—´</li><li>æ— æ³•æ ‡è®°æ‰§è¡Œçº¿ç¨‹ï¼Œå› æ­¤è¦è®¾ç½®rediså”¯ä¸€å€¼</li></ol><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">SET resource_name my_random_value NX PX <span class="token number">30000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£é”ï¼š<br>è§£é”éœ€è¦åˆ¤æ–­çº¿ç¨‹æŒæœ‰çš„éšæœºå€¼å’Œredisçš„å€¼æ˜¯å¦ä¸€æ ·ï¼Œå› æ­¤è¦ä½¿ç”¨luaè„šæœ¬</p><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨åªæ˜¯å•æœºç‰ˆredisçš„åˆ†å¸ƒå¼é”ï¼Œä¸é€‚åˆåˆ†å¸ƒå¼ç¯å¢ƒã€‚å½“rediså®•æœºåï¼Œæ‰§è¡Œçº¿ç¨‹ä¸ä¼šè¢«é‡Šæ”¾ã€‚å½“çº¿ç¨‹æ‰§è¡Œè€—æ—¶ä»»åŠ¡æ—¶ï¼Œå¯èƒ½å‡ºç°redisé‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹æŒæœ‰é”ã€‚<br>åˆ†å¸ƒå¼redisé”å¯ä»¥é‡‡ç”¨Redissionå®ç°ï¼Œåº•å±‚æ˜¯redisä½œè€…å®ç°çš„RedlockåŸç†ã€‚</p><ul><li>å…³äºRedLockå­˜åœ¨çš„é—®é¢˜</li></ul><ol><li>å¯¹è·å–åˆ°é”çš„è¿›è¡Œæ“ä½œæ²¡æœ‰ä¿æŠ¤æœºåˆ¶,è¿™é‡Œå…¶å®å¯ä»¥å¯¹æ¯”è¿‡æœŸæ—¶é—´çš„æ–¹å¼æ¥å¤„ç†</li><li>RedLockæ˜¯å»ºç«‹åœ¨æ—¶é—´æœ‰åºçš„å‰æä¸‹çš„<br>ä¸€èˆ¬ä¸šåŠ¡ç³»ç»Ÿå¯ä»¥ä½¿ç”¨RedLockç®—æ³•,åœ¨ä¸¥æ ¼è¦æ±‚åˆ†å¸ƒå¼é”æ­£ç¡®æ€§çš„åœºæ™¯ä¸‹æ¨èä½¿ç”¨ZK(curatorå·²æœ‰ç°æˆå®ç°)</li></ol><h4 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h4><ul><li><p>ç¼“å­˜é›ªå´©<br>é›ªå´©æŒ‡çš„æ˜¯å¤§é‡keyåœ¨åŒä¸€æ—¶é—´å¤±æ•ˆ,å¯¼è‡´å¤§é‡è¯·æ±‚å‘é€åˆ°åç«¯,å½±å“æ•°æ®åº“çš„æƒ…å†µ<br>åœ¨è®¾è®¡keyæ—¶å°±è¦è€ƒè™‘åˆ°å¤±æ•ˆæ—¶é—´çš„å½±å“,å°†æ—¶æ•ˆæ—¶é—´æ‹‰æˆä¸€ä¸ªæ—¶é—´æ®µå°†è¯·æ±‚è¿›è¡Œé˜²èŒƒ</p></li><li><p>ç¼“å­˜ç©¿é€/å‡»ç©¿<br>ç¼“å­˜ç©¿é€/å‡»ç©¿æŒ‡çš„æ˜¯è¯·æ±‚çš„keyä¸åœ¨cacheä¸­,å¯¼è‡´å¤§é‡è¯·æ±‚å‘é€åˆ°åç«¯ç³»ç»Ÿä¸­<br>è§£å†³è¿™ç§é—®é¢˜éœ€è¦ä»ä¸‰ä¸ªæ–¹é¢è¿›è¡Œå¤„ç†:<br>1.ä¸šåŠ¡æ¥å£çš„è®¾è®¡ä¸Šåšåˆ°åªæä¾›æœ€å°èŒƒå›´(å¯æ§å¯çŸ¥)çš„å…¥å‚,å°½é‡é¿å…å‡ºç°ç¼“å­˜ç©¿é€çš„æƒ…å†µ;<br>2.å¯¹äºæ¶æ„çš„è¯·æ±‚å¯ä»¥é€šè¿‡Nginxè¿™äº›åå‘ä»£ç†å·¥å…·è¿›è¡Œéš”ç¦»,ä¹Ÿå¯ä»¥é€šè¿‡ä¸šåŠ¡ç½‘å…³è¿›è¡Œéš”ç¦»<br>3.åšå¥½å¯¹å‡ºç°ç©¿é€åçš„å¼‚å¸¸æ£€æµ‹å’Œæ¢å¤æœºåˆ¶,å¯ä»¥ä½¿ç”¨Hystrixè¿›è¡Œé™æµå’Œé™çº§</p></li></ul><h4 id="Cacheä½¿ç”¨ç­–ç•¥"><a class="header-anchor" href="#Cacheä½¿ç”¨ç­–ç•¥"></a>Cacheä½¿ç”¨ç­–ç•¥</h4><ol><li>æŸ¥è¯¢æ­¥éª¤<br>user -&gt; cache -&gt; DB</li><li>æ›´æ–°æ­¥éª¤<br>user -&gt; DB(update) -&gt;cache(delete)<br>ä¸€èˆ¬ä½¿ç”¨cacheéƒ½æ˜¯ä½¿ç”¨è¿™ç§ç­–ç•¥,è¿™ç§ç­–ç•¥å¯èƒ½å‡ºç°çš„é—®é¢˜æ˜¯ä¸€ä¸ªæ“ä½œæŒæœ‰ä¿®æ”¹å‰çš„æ•°æ®,ä½†æ˜¯åœ¨å¦å¤–ä¸€ä¸ªæ“ä½œå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹åæ‰å°†æ•°æ®æ”¾åˆ°cacheä¸­;è¿™ç§é—®é¢˜å‡ºç°çš„æ¦‚å¿µè¾ƒä½,å¯ä»¥ä¸ºç¼“å­˜è®¾ç½®å¤±æ•ˆæ—¶é—´æ¥å°½å¯èƒ½çš„é¿å…å½±å“èŒƒå›´.è¿˜æœ‰çš„è®¾è®¡æ–¹æ¡ˆæ˜¯è®©cacheç›´æ¥å»ç»´æŠ¤DBçš„æ•°æ®ä¿®æ”¹æ ¸å¿ƒæ€æƒ³å°±æ˜¯å°†ä¸¤ä¸ªå†™æ“ä½œå…¥å£åˆå¹¶æˆä¸ºä¸€ä¸ª,ä»è€Œè§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜;</li></ol><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p><a href="https://imgtu.com/i/c6a3Jx"><img src="https://z3.ax1x.com/2021/04/14/c6a3Jx.png" alt="æ€»ç»“"></a></p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://try.redis.io/">Redisåœ¨çº¿æ•™ç¨‹</a><br><a href="https://my.oschina.net/u/4283481/blog/4133755">Redis(2)â€”â€”è·³è·ƒè¡¨</a><br><a href="http://redisbook.com/">Redis è®¾è®¡ä¸å®ç°</a><br><a href="https://www.processon.com/view/link/60767e21f346fb647a4e4ebd">æ€ç»´å¯¼å›¾åœ°å€</a><br><a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">å…³äºRedisåˆ†å¸ƒå¼é”çš„äº‰è®º</a><br><a href="https://redis.io/topics/distlock">ä½¿ç”¨Redisçš„åˆ†å¸ƒå¼é”</a><br><a href="http://antirez.com/news/101">Redlockå®‰å…¨å—</a></p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> åˆ†å¸ƒå¼é” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatisæ’ä»¶æœºåˆ¶</title>
      <link href="2018/04/23/11.orm%E6%A1%86%E6%9E%B6/4.mybatis%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6/"/>
      <url>2018/04/23/11.orm%E6%A1%86%E6%9E%B6/4.mybatis%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1>mybatisæ’ä»¶æœºåˆ¶</h1><p>mybatisæ¡†æ¶æ”¯æŒé€šè¿‡æ’ä»¶æœºåˆ¶æ¥æ‰©å±•åŠŸèƒ½ï¼Œåˆ†åˆ«æä¾›äº†4ç§æ‰©å±•ç‚¹ï¼š</p><ol><li>Executor ï¼š mybatisçš„æ‰§è¡Œå™¨ï¼Œç”¨äºæ‰§è¡Œcurdæ“ä½œ</li><li>StatementHandlerï¼šæ•°æ®åº“å¤„ç†å¯¹è±¡ï¼Œç”¨äºæ‰§è¡Œsqlæ“ä½œ</li><li>ParameterHandlerï¼šå¤„ç†å‚æ•°å¯¹è±¡</li><li>ResultSetHandlerï¼šå¤„ç†è¿”å›ç»“æœé›†</li></ol><p>å…¶ä¸­<strong>executor</strong>å’Œ<strong>statementHandler</strong>çš„åŒºåˆ«åœ¨äºexecutoræ˜¯ä½¿ç”¨connectionçš„ä¸€æ–¹ï¼ŒstatementHandleré€šè¿‡å¯¹connectionè¿›è¡Œå°è£…ã€‚</p><h2 id="æ’ä»¶çš„åŸºæœ¬åŸç†"><a class="header-anchor" href="#æ’ä»¶çš„åŸºæœ¬åŸç†"></a>æ’ä»¶çš„åŸºæœ¬åŸç†</h2><p>é€šè¿‡è´£ä»»é“¾çš„æ¨¡å¼å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨ä»£ç†æ¨¡å¼å¯¹ç›®æ ‡ç±»è¿›è¡Œå¢å¼ºä»è€Œè¾¾åˆ°å¤„ç†çš„ç›®çš„ã€‚</p><h2 id="æ’ä»¶çš„æ³¨å†Œæ—¶æœºï¼Ÿ"><a class="header-anchor" href="#æ’ä»¶çš„æ³¨å†Œæ—¶æœºï¼Ÿ"></a>æ’ä»¶çš„æ³¨å†Œæ—¶æœºï¼Ÿ</h2><p>æ’ä»¶æ˜¯åœ¨configation.newParameterHandler/newResultSetHandler/newStatementHandler/newExecutoræ–¹æ³•ä¸­ä¼šæ³¨å†Œæ‹¦æˆªå™¨æ’ä»¶<br><img src="https://s1.ax1x.com/2020/04/23/J09Llt.png" alt="J09Llt.png"></p><h2 id="æ’ä»¶çš„æ‰§è¡Œæ—¶æœºï¼Ÿ"><a class="header-anchor" href="#æ’ä»¶çš„æ‰§è¡Œæ—¶æœºï¼Ÿ"></a>æ’ä»¶çš„æ‰§è¡Œæ—¶æœºï¼Ÿ</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">></span></span> methods <span class="token operator">=</span> signatureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> methods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Invocation</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»<strong>Plugin</strong>ä¸­çš„invokeræ–¹æ³•å¯ä»¥çœ‹å‡ºå…·ä½“æ‰§è¡Œæ’ä»¶çš„æ–¹æ³•æ˜¯åœ¨ä»£ç†ç±»æ‰§è¡Œçš„æ—¶å€™ä¼šåˆ¤æ–­æ—¶å€™æœ‰æ’ä»¶å¦‚æœæœ‰æ’ä»¶å°±æ‰§è¡Œæ’ä»¶ä¸­çš„æ–¹æ³•å¹¶è¿”å›ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatisæ–¹æ³•é‡è½½é—®é¢˜</title>
      <link href="2018/04/18/11.orm%E6%A1%86%E6%9E%B6/3.mybatis%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD%E9%97%AE%E9%A2%98/"/>
      <url>2018/04/18/11.orm%E6%A1%86%E6%9E%B6/3.mybatis%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1>mybatisæ–¹æ³•é‡è½½é—®é¢˜</h1><p>åœ¨mapperæ¥å£ä¸­ä¸èƒ½é‡è½½æ–¹æ³•ï¼Œç½‘ä¸Šè§£é‡Šå¤§éƒ¨åˆ†çš„åŸå› æ˜¯å› ä¸ºmybatisä½¿ç”¨package+Mapper+methodå…¨é™åä½œä¸ºkeyï¼Œåœ¨xmlä¸­å»å¯»æ‰¾å”¯ä¸€çš„sqlæ¥æ‰§è¡Œæ—¶å€™ä¼šå‘ç”Ÿå†²çªã€‚<br>ä»¥ä¸Šè¿™æ ·åŸå› çš„è§£é‡Šæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯ç°åœ¨ç½‘ä¸Šå¯¹è¿™ä¸ªç»“æœçš„æè¿°æ˜¯åœ¨å¯åŠ¨æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨<strong>mybatis-spring-boot-starter.2.1.0</strong>çš„ç‰ˆæœ¬ä¸­å¹¶æœªå‘ç°å¼‚å¸¸ï¼ŒæŸ¥çœ‹æºä»£ç å‘ç°åœ¨è§£æxmlæ—¶å€™é€»è¾‘ä¿®æ”¹æˆä¸ºï¼Œæ ¹æ®keyè§£æå‡ºç¬¬ä¸€ä¸ªsqlè¯­å¥å¹¶æ‰§è¡Œ</p><ul><li>XPathParser</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XNode</span><span class="token punctuation">></span></span> <span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token class-name">Object</span> root<span class="token punctuation">,</span> <span class="token class-name">String</span> expression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XNode</span><span class="token punctuation">></span></span> xnodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">NodeList</span> nodes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NodeList</span><span class="token punctuation">)</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token class-name">XPathConstants</span><span class="token punctuation">.</span>NODESET<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    xnodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nodes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> xnodes<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ·±å…¥åˆ†æåŸå› æ˜¯ç”±äºmybatis-bootåœ¨å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–<strong>SqlSessionFactory</strong>çš„æ–¹å¼ä¸º</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> config<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSessionFactory</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è§£æå¥½é…ç½®åè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸æ˜¯mybatisæ¥è¿›è¡Œé…ç½®æ–‡ä»¶çš„è§£æçš„ï¼Œå¦‚æœæ˜¯mybatisè¿›è¡Œé…ç½®æ–‡ä»¶çš„è§£æä¼šåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>æ·±å…¥åˆ†æå…¶å®åœ¨mybatisä¸­ä¸åº”è¯¥å®šä¹‰æ–¹æ³•çš„é‡è½½ï¼Œé‡è½½çš„æœ¬è´¨æ˜¯æ–¹æ³•ç­¾åä¸åŒä»è€Œäº§ç”Ÿä¸åŒçš„ç»“æœï¼Œä½†æ˜¯åœ¨ORMä¸­å¦‚æœæ–¹æ³•ç­¾åæœ€å¥½ä¸è¦æ··ç”¨ç›¸åŒçš„æ–¹æ³•åç§°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatisåˆå§‹åŒ–æµç¨‹</title>
      <link href="2018/04/16/11.orm%E6%A1%86%E6%9E%B6/2.mybatis%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/"/>
      <url>2018/04/16/11.orm%E6%A1%86%E6%9E%B6/2.mybatis%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1>mybatisåˆå§‹åŒ–æµç¨‹</h1><p>mybatisåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸»è¦åˆ†ä¸º<strong>åŠ è½½mybatis-config.xmlé…ç½®æ–‡ä»¶</strong>ã€<strong>åŠ è½½ Mapper æ˜ å°„é…ç½®æ–‡ä»¶</strong>ã€<strong>åŠ è½½ Mapper æ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯</strong></p><h2 id="åŠ è½½mybatis-config-xmlä¸­çš„ä¿¡æ¯"><a class="header-anchor" href="#åŠ è½½mybatis-config-xmlä¸­çš„ä¿¡æ¯"></a>åŠ è½½<strong>mybatis-config.xml</strong>ä¸­çš„ä¿¡æ¯</h2><ol><li>è§£æé…ç½®mybatis-config.xmlæ–‡ä»¶</li><li>åˆ›å»º<strong>DefaultSqlSessionFactory</strong>æ–‡ä»¶</li></ol><ul><li>æµç¨‹å›¾<br><img src="https://s1.ax1x.com/2020/04/16/JEFmpF.png" alt="JEFmpF.png"></li></ul><h2 id="åŠ è½½Mapperæ˜ å°„æ–‡ä»¶"><a class="header-anchor" href="#åŠ è½½Mapperæ˜ å°„æ–‡ä»¶"></a>åŠ è½½<strong>Mapper</strong>æ˜ å°„æ–‡ä»¶</h2>]]></content>
      
      
      <categories>
          
          <category> mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatiså¸¸è§é—®é¢˜</title>
      <link href="2018/04/14/11.orm%E6%A1%86%E6%9E%B6/99.mybatis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
      <url>2018/04/14/11.orm%E6%A1%86%E6%9E%B6/99.mybatis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1>mybatiså¸¸è§é—®é¢˜</h1><h2 id="MyBatis-ç¼–ç¨‹æ­¥éª¤"><a class="header-anchor" href="#MyBatis-ç¼–ç¨‹æ­¥éª¤"></a>MyBatis ç¼–ç¨‹æ­¥éª¤</h2><ol><li>åˆ›å»º<strong>SqlSessionFactoy</strong>å¯¹è±¡</li><li>é€šè¿‡<strong>SqlSessionFactory</strong>è·å–<strong>SqlSession</strong>å¯¹è±¡</li><li>é€šè¿‡<strong>SqlSession</strong>è·å–<strong>Mapper</strong>æ¥å£çš„ä»£ç†å¯¹è±¡</li><li>é€šè¿‡<strong>Mapper</strong>ä»£ç†å¯¹è±¡æ‰§è¡Œæ•°æ®åº“æ“ä½œ</li><li>æ‰§è¡ŒæˆåŠŸæäº¤äº‹åŠ¡ï¼Œå¤±è´¥åˆ™å›æ»š</li><li>æœ€åè¿”å›è¿æ¥</li></ol><h2 id="å’Œ-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#å’Œ-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a><strong>#{}</strong> å’Œ <strong>${}</strong> çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ol><li>**#{}**å±æ€§æ›¿æ¢</li><li>**${}**å‚æ•°å ä½ç¬¦ï¼Œé‡‡ç”¨çš„æ˜¯é¢„ç¼–è¯‘çš„æ–¹å¼</li></ol><h2 id="å½“å®ä½“ç±»ä¸­çš„å±æ€§åå’Œè¡¨ä¸­çš„å­—æ®µåä¸ä¸€æ ·-ï¼Œæ€ä¹ˆåŠï¼Ÿ"><a class="header-anchor" href="#å½“å®ä½“ç±»ä¸­çš„å±æ€§åå’Œè¡¨ä¸­çš„å­—æ®µåä¸ä¸€æ ·-ï¼Œæ€ä¹ˆåŠï¼Ÿ"></a>å½“å®ä½“ç±»ä¸­çš„å±æ€§åå’Œè¡¨ä¸­çš„å­—æ®µåä¸ä¸€æ · ï¼Œæ€ä¹ˆåŠï¼Ÿ</h2><ol><li>aslias åˆ«å</li><li><resultMap>æ¥è®¾å®šå­—æ®µå¯¹åº”å®ä½“çš„å±æ€§å€¼</li><li>é»˜è®¤é©¼å³°é£æ ¼</li></ol><h2 id="XML-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„-select-insert-update-deleteæ ‡-ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ"><a class="header-anchor" href="#XML-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„-select-insert-update-deleteæ ‡-ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ"></a>XML æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„ select | insert | update | deleteæ ‡ ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ</h2><ol><li><sql/>å¯è¢«å¼•ç”¨</li><li><cache/> ä½œä¸ºäºŒçº§ç¼“å­˜çš„å¼•å…¥æ ‡ç­¾</li><li><cache-ref/></li><li><resultMap/></li><li><foreach/></li><li><if></li><li><where></li></ol><h2 id="Mybatis-åŠ¨æ€-SQL-æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€-SQL-ï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€-SQL-çš„æ‰§è¡ŒåŸç†å—ï¼Ÿ"><a class="header-anchor" href="#Mybatis-åŠ¨æ€-SQL-æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€-SQL-ï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€-SQL-çš„æ‰§è¡ŒåŸç†å—ï¼Ÿ"></a>Mybatis åŠ¨æ€ SQL æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€ SQL ï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€ SQL çš„æ‰§è¡ŒåŸç†å—ï¼Ÿ</h2><p>åŠ¨æ€sqlæŒ‡çš„æ˜¯åœ¨xmlä¸­ç”¨xmlæ ‡ç­¾ç¼–å†™åŠ¨æ€sql<br><where>ã€<if>ã€<set>ã€<forEache></p><h2 id="æœ€ä½³å®è·µä¸­ï¼Œé€šå¸¸ä¸€ä¸ª-XML-æ˜ å°„æ–‡ä»¶ï¼Œéƒ½ä¼šå†™ä¸€ä¸ª-Mapper-æ¥å£ä¸ä¹‹å¯¹åº”ã€‚è¯·é—®ï¼Œè¿™ä¸ª-Mapper-æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸMapper-æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ"><a class="header-anchor" href="#æœ€ä½³å®è·µä¸­ï¼Œé€šå¸¸ä¸€ä¸ª-XML-æ˜ å°„æ–‡ä»¶ï¼Œéƒ½ä¼šå†™ä¸€ä¸ª-Mapper-æ¥å£ä¸ä¹‹å¯¹åº”ã€‚è¯·é—®ï¼Œè¿™ä¸ª-Mapper-æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸMapper-æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ"></a>æœ€ä½³å®è·µä¸­ï¼Œé€šå¸¸ä¸€ä¸ª XML æ˜ å°„æ–‡ä»¶ï¼Œéƒ½ä¼šå†™ä¸€ä¸ª Mapper æ¥å£ä¸ä¹‹å¯¹åº”ã€‚è¯·é—®ï¼Œè¿™ä¸ª Mapper æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸMapper æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ</h2><p>Mapperæ¥å£çš„å®ç°ç±»æ˜¯mybatisä½¿ç”¨JDK Proxyè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç†å¯¹è±¡,ä»£ç†å¯¹è±¡ä¼šæ‹¦æˆªæ¥å£æ–¹æ³•ã€‚ç„¶åé€šè¿‡statementæ¥å£å»æ‰§è¡Œå…·ä½“çš„sqlã€‚<br>ä¸èƒ½ï¼Œå¦‚æœé‡è½½ä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼Œè‡ªå®šä¹‰mybatisåŠ è½½æ–¹å¼ä¼šå§‹ç»ˆæ‰§è¡Œç¬¬ä¸€ä¸ªsqlã€‚ä½¿ç”¨SqlSessionFactoryåˆå§‹åŒ–ä¼šåœ¨å¯åŠ¨æ—¶æŠ›å‡ºå¼‚å¸¸</p><h2 id="Mapperæ¥å£ç»‘å®šæœ‰å‡ ç§å®ç°æ–¹å¼-åˆ†åˆ«æ˜¯æ€ä¹ˆå®ç°çš„"><a class="header-anchor" href="#Mapperæ¥å£ç»‘å®šæœ‰å‡ ç§å®ç°æ–¹å¼-åˆ†åˆ«æ˜¯æ€ä¹ˆå®ç°çš„"></a>Mapperæ¥å£ç»‘å®šæœ‰å‡ ç§å®ç°æ–¹å¼,åˆ†åˆ«æ˜¯æ€ä¹ˆå®ç°çš„?</h2><p>ä¸‰ç§ï¼›1.xmlç»‘å®š 2.åœ¨mappperæ¥å£ä¸­ä½¿ç”¨æ³¨è§£çš„å½¢å¼ 3.æ³¨è§£çš„æ–¹å¼å¹¶ä¸”é€šè¿‡javaConfigçš„å½¢å¼</p><h2 id="Mybatis-çš„-XML-Mapperæ–‡ä»¶ä¸­ï¼Œä¸åŒçš„-XML-æ˜ å°„æ–‡ä»¶ï¼Œid-æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ"><a class="header-anchor" href="#Mybatis-çš„-XML-Mapperæ–‡ä»¶ä¸­ï¼Œä¸åŒçš„-XML-æ˜ å°„æ–‡ä»¶ï¼Œid-æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ"></a>Mybatis çš„ XML Mapperæ–‡ä»¶ä¸­ï¼Œä¸åŒçš„ XML æ˜ å°„æ–‡ä»¶ï¼Œid æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ</h2><p>å¯ä»¥ï¼Œä½†æ˜¯ä¸å»ºè®®ï¼Œå› ä¸ºæ˜¯namespace + idçš„å½¢å¼ä½œä¸º Map&lt;String, MappedStatement&gt; çš„ key ä½¿ç”¨çš„</p><h2 id="å¦‚ä½•è·å–è‡ªåŠ¨ç”Ÿæˆçš„-ä¸»-é”®å€¼"><a class="header-anchor" href="#å¦‚ä½•è·å–è‡ªåŠ¨ç”Ÿæˆçš„-ä¸»-é”®å€¼"></a>å¦‚ä½•è·å–è‡ªåŠ¨ç”Ÿæˆçš„(ä¸»)é”®å€¼?</h2><ol><li>useGeneratedKeys + keyProperty å±æ€§</li><li><selectKey>çš„æ–¹å¼</li></ol><h2 id="Mybatis-æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ"><a class="header-anchor" href="#Mybatis-æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ"></a>Mybatis æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ</h2><p>å¯</p><h2 id="åœ¨-Mapper-ä¸­å¦‚ä½•ä¼ é€’å¤šä¸ªå‚æ•°"><a class="header-anchor" href="#åœ¨-Mapper-ä¸­å¦‚ä½•ä¼ é€’å¤šä¸ªå‚æ•°"></a>åœ¨ Mapper ä¸­å¦‚ä½•ä¼ é€’å¤šä¸ªå‚æ•°?</h2><ol><li>ç”¨å¯¹è±¡ä¼ å‚</li><li>ç”¨mapç©¿å‚</li><li>ç”¨**@Param**</li></ol><h2 id="Mybatis-æ˜¯å¦å¯ä»¥æ˜ å°„-Enum-æšä¸¾ç±»ï¼Ÿ"><a class="header-anchor" href="#Mybatis-æ˜¯å¦å¯ä»¥æ˜ å°„-Enum-æšä¸¾ç±»ï¼Ÿ"></a>Mybatis æ˜¯å¦å¯ä»¥æ˜ å°„ Enum æšä¸¾ç±»ï¼Ÿ</h2><p>å¯ï¼Œä½¿ç”¨<strong>TypeHandler</strong></p><h2 id="Mybatis-éƒ½æœ‰å“ªäº›-Executor-æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#Mybatis-éƒ½æœ‰å“ªäº›-Executor-æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Mybatis éƒ½æœ‰å“ªäº› Executor æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ol><li>SimpleExecutoræ¯æ¬¡æ‰§è¡Œä¸€æ¬¡updateæˆ–è€…selectæ“ä½œï¼Œå°±åˆ›å»ºä¸€ä¸ªstatementå¯¹è±¡ï¼Œç”¨å®Œå°±å…³é—­</li><li>ReuseExecutoré€šè¿‡Map&lt;String,Statement&gt;è¿›è¡Œç¼“å­˜çš„å¯¹è±¡</li><li>BatchExecutor</li><li>cacheExecutor</li></ol><h2 id="MyBatis-å¦‚ä½•æ‰§è¡Œæ‰¹é‡æ’å…¥"><a class="header-anchor" href="#MyBatis-å¦‚ä½•æ‰§è¡Œæ‰¹é‡æ’å…¥"></a>MyBatis å¦‚ä½•æ‰§è¡Œæ‰¹é‡æ’å…¥?</h2><ol><li>ä½¿ç”¨batchè¿›è¡Œæ’å…¥</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span><span class="token punctuation">.</span>BATCH<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Mapper</span> mapper <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">Mapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>itemDO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>session<span class="token punctuation">.</span><span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>ä½¿ç”¨<xml>æ ‡ç­¾è¿›è¡Œæ‹¼æ¥çš„æ–¹å¼<br><forEach></forEach></li></ol><p>å°½é‡ä½¿ç”¨batchçš„æ–¹å¼</p><h2 id="ä»‹ç»-MyBatis-çš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„æ¦‚å¿µå’Œå®ç°åŸç†ï¼Ÿ"><a class="header-anchor" href="#ä»‹ç»-MyBatis-çš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„æ¦‚å¿µå’Œå®ç°åŸç†ï¼Ÿ"></a>ä»‹ç» MyBatis çš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„æ¦‚å¿µå’Œå®ç°åŸç†ï¼Ÿ</h2><p>ä¸€çº§ç¼“å­˜æ˜¯åœ¨sessionèŒƒå›´å†…çš„<br>äºŒçº§ç¼“å­˜æ˜¯åœ¨applicationä¸­çš„<br>äºŒçº§ç¼“å­˜çš„å±€é™æ€§è¾ƒå¤§ï¼ŒåŠŸèƒ½ä¸Šå’Œç¼“å­˜ä¸­é—´ä»¶æœ‰éƒ¨åˆ†å†²çªï¼Œé€‚ç”¨äºå°å‹å•ä½“é¡¹ç›®ã€‚</p><h2 id="Mybatis-æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#Mybatis-æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Mybatis æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ä¸ä¼š</p><h2 id="Mybatis-èƒ½å¦æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚"><a class="header-anchor" href="#Mybatis-èƒ½å¦æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚"></a>Mybatis èƒ½å¦æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚</h2><p>å¯</p><ol><li>ä¸€ç§æ˜¯å•ç‹¬å‘é€ä¸€ä¸ª SQL å»æŸ¥è¯¢å…³è”å¯¹è±¡ï¼Œèµ‹ç»™ä¸»å¯¹è±¡ï¼Œç„¶åè¿”å›ä¸»å¯¹è±¡</li><li>å¦ä¸€ç§æ˜¯ä½¿ç”¨åµŒå¥—æŸ¥è¯¢ï¼ŒåµŒå¥—æŸ¥è¯¢çš„å«ä¹‰ä¸ºä½¿ç”¨ join æŸ¥è¯¢ï¼Œä¸€éƒ¨åˆ†åˆ—æ˜¯ A å¯¹è±¡çš„å±æ€§å€¼ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åˆ—æ˜¯å…³è”å¯¹è±¡ B çš„å±æ€§å€¼</li></ol><h2 id="ç®€è¿°-Mybatis-çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Ÿä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶ï¼Ÿ"><a class="header-anchor" href="#ç®€è¿°-Mybatis-çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Ÿä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶ï¼Ÿ"></a>ç®€è¿° Mybatis çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Ÿä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶ï¼Ÿ</h2><h2 id="ä½¿ç”¨mybatisè¿›è¡Œæ›´æ–°çš„æµç¨‹æ˜¯ä¸Šé¢ï¼Ÿ"><a class="header-anchor" href="#ä½¿ç”¨mybatisè¿›è¡Œæ›´æ–°çš„æµç¨‹æ˜¯ä¸Šé¢ï¼Ÿ"></a>ä½¿ç”¨mybatisè¿›è¡Œæ›´æ–°çš„æµç¨‹æ˜¯ä¸Šé¢ï¼Ÿ</h2><ol><li>æŸ¥è¯¢<strong>cacheExecutor</strong>åˆ¤æ–­äºŒçº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰ç¼“å­˜å­˜åœ¨ç¼“å­˜è¿›è¡Œåˆ·æ–°</li><li>è°ƒç”¨<strong>BaseExecutor</strong>æ–¹æ³•æ‰§è¡Œupdateè¯­å¥ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼šåœ¨BaseExecutorä¸­å…ˆæ¸…ç©ºä¸€çº§ç¼“å­˜ï¼Œå†è°ƒç”¨å…·ä½“çš„æ‰§è¡Œå¯¹è±¡ï¼‰</li><li>å…·ä½“çš„æ‰§è¡Œå¯¹è±¡åˆ›å»º<strong>configuration</strong>å¯¹è±¡ï¼Œé€šè¿‡configurationå¯¹è±¡åˆ›å»º<strong>statementHandle</strong>rå¯¹è±¡è¿”å›æ‰§è¡Œå™¨</li><li>æ‰§è¡Œå™¨ä½¿ç”¨statementå¯¹è±¡è¿›è¡Œå‚æ•°èµ‹å€¼</li></ol><h2 id="Mybatis-æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#Mybatis-æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Mybatis æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>PageHelper<br>é€šè¿‡statementä¸­è§£æsqlå¹¶è¿›è¡Œæ‹¦æˆªï¼Œä»è€Œå®ç°åˆ†é¡µ</p><h2 id="MyBatis-ä¸-Hibernate-æœ‰å“ªäº›ä¸åŒï¼Ÿ"><a class="header-anchor" href="#MyBatis-ä¸-Hibernate-æœ‰å“ªäº›ä¸åŒï¼Ÿ"></a>MyBatis ä¸ Hibernate æœ‰å“ªäº›ä¸åŒï¼Ÿ</h2><p>Hibernateæ˜¯é¢å‘å¯¹è±¡çš„ORMæ¡†æ¶ä¸é¼“åŠ±ä½ å»å†™å®šåˆ¶åŒ–çš„sqlï¼Œè€Œæ˜¯é¢å‘æ•°æ®åº“å¯¹è±¡å»è¿›è¡ŒCRUDçš„æ“ä½œ</p><h2 id="JDBC-ç¼–ç¨‹æœ‰å“ªäº›ä¸è¶³ä¹‹å¤„ï¼ŒMyBatisæ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ"><a class="header-anchor" href="#JDBC-ç¼–ç¨‹æœ‰å“ªäº›ä¸è¶³ä¹‹å¤„ï¼ŒMyBatisæ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ"></a>JDBC ç¼–ç¨‹æœ‰å“ªäº›ä¸è¶³ä¹‹å¤„ï¼ŒMyBatisæ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ</h2><p>sqlåœ¨ä»£ç ä¸­ä¸æ˜“ç»´æŠ¤</p><h2 id="Mybatis-æ¯”-IBatis-æ¯”è¾ƒå¤§çš„å‡ ä¸ªæ”¹è¿›æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#Mybatis-æ¯”-IBatis-æ¯”è¾ƒå¤§çš„å‡ ä¸ªæ”¹è¿›æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Mybatis æ¯” IBatis æ¯”è¾ƒå¤§çš„å‡ ä¸ªæ”¹è¿›æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ä¸ä¼š</p><h2 id="Mybatis-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ-A-æ ‡ç­¾é€šè¿‡-include-å¼•ç”¨äº†Bæ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB-æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨-A-æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨Aæ ‡ç­¾çš„å‰é¢ï¼Ÿ"><a class="header-anchor" href="#Mybatis-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ-A-æ ‡ç­¾é€šè¿‡-include-å¼•ç”¨äº†Bæ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB-æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨-A-æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨Aæ ‡ç­¾çš„å‰é¢ï¼Ÿ"></a>Mybatis æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ A æ ‡ç­¾é€šè¿‡ include å¼•ç”¨äº†Bæ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨ A æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨Aæ ‡ç­¾çš„å‰é¢ï¼Ÿ</h2><p>ä¸ä¼š</p><h2 id="ç®€è¿°-Mybatis-çš„-XML-æ˜ å°„æ–‡ä»¶å’Œ-Mybatis-å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ"><a class="header-anchor" href="#ç®€è¿°-Mybatis-çš„-XML-æ˜ å°„æ–‡ä»¶å’Œ-Mybatis-å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ"></a>ç®€è¿° Mybatis çš„ XML æ˜ å°„æ–‡ä»¶å’Œ Mybatis å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ</h2><p>xmlæ–‡ä»¶ä¼šè§£æåˆ°configuationå¯¹è±¡ä¸­</p>]]></content>
      
      
      <categories>
          
          <category> mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatisæºä»£ç åˆ†æ(ä¸€)</title>
      <link href="2018/04/14/11.orm%E6%A1%86%E6%9E%B6/1.mybatis%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80/"/>
      <url>2018/04/14/11.orm%E6%A1%86%E6%9E%B6/1.mybatis%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<h1>mybatisæºä»£ç åˆ†æ(ä¸€)</h1><p>åœ¨è¿‘ä¸¤å¹´çš„å·¥ä½œä¸­ä¸€ç›´æ˜¯åœ¨é€‚ç”¨çš„æ˜¯mybatisæ¡†æ¶ï¼Œè¿›è¡Œæ•°æ®åº“çš„ç›¸å…³æ“ä½œã€‚è¿™æ¬¡æ¥è¿›è¡Œå¯¹mybatisæºä»£ç çš„ä¸€ä¸ªå­¦ä¹ ã€‚å›æƒ³ä¸€ä¸‹ç¬¬ä¸€ä»½å·¥ä½œæ—¶è¿˜ä½¿ç”¨çš„æ˜¯ibatisï¼Œç€å®æœ‰ä¸€äº›å²æœˆäº†ã€‚ä¸‹é¢æ¥ä¸€æ­¥ä¸€æ­¥çš„è¿›è¡Œåˆ†æ</p><h2 id="è°ƒè¯•ç¯å¢ƒçš„æ­å»º"><a class="header-anchor" href="#è°ƒè¯•ç¯å¢ƒçš„æ­å»º"></a>è°ƒè¯•ç¯å¢ƒçš„æ­å»º</h2><p>å‚ç…§èŠ‹å¤§çš„ä»£ç ï¼Œåœ¨è®¾ç½®mavençš„æ—¶å€™éœ€è¦æŒ‡å®šä¸­å¤®ä»“åº“è¿™æ ·ç¨å¾®å¿«ä¸€ç‚¹</p><p>ä½¿ç”¨<strong>AutoConstructorTest</strong>è¿›è¡Œæµ‹è¯•</p><h2 id="mybatisçš„åˆ†å±‚èŒè´£"><a class="header-anchor" href="#mybatisçš„åˆ†å±‚èŒè´£"></a>mybatisçš„åˆ†å±‚èŒè´£</h2><table><thead><tr><th>ç»„ä»¶</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>sqlSession</td><td>æ¥å£å±‚</td></tr><tr><td>é…ç½®è§£æ</td><td>æ ¸å¿ƒå¤„ç†å±‚</td></tr><tr><td>å‚æ•°æ˜ å°„</td><td>æ ¸å¿ƒå¤„ç†å±‚</td></tr><tr><td>SQLè§£æ</td><td>æ ¸å¿ƒå¤„ç†å±‚</td></tr><tr><td>SQlæ‰§è¡Œ</td><td>æ ¸å¿ƒå¤„ç†å±‚</td></tr><tr><td>ç»“æœé›†æ˜ å°„</td><td>æ ¸å¿ƒå¤„ç†å±‚</td></tr><tr><td>æ’ä»¶</td><td>æ ¸å¿ƒå¤„ç†å±‚</td></tr><tr><td>æ•°æ®æºæ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>äº‹åŠ¡ç®¡ç†æ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>ç¼“å­˜æ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>Bindingæ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>åå°„æ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>ç±»å‹è½¬åŒ–</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>æ—¥å¿—æ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>èµ„æºåŠ è½½</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr><tr><td>è§£æå™¨æ¨¡å—</td><td>åŸºç¡€æ”¯æŒå±‚</td></tr></tbody></table><h2 id="æ ¸å¿ƒåŸºç¡€ç»„ä»¶"><a class="header-anchor" href="#æ ¸å¿ƒåŸºç¡€ç»„ä»¶"></a>æ ¸å¿ƒåŸºç¡€ç»„ä»¶</h2><p>æ ¸å¿ƒçš„åŸºç¡€ç»„ä»¶ï¼š</p><ol><li><strong>SqlSession</strong>æ˜¯æŠ½è±¡å¤„ç†å‡ºæ¥ä¸ºJDBCç”Ÿæˆçš„Connectionå¯¹è±¡çš„SqlSessionå¯¹è±¡ï¼Œè¿™æ ·æ‰èƒ½ä¸æ•°æ®åº“å¼€å¯â€œæ²Ÿé€šâ€ï¼Œé€šè¿‡SqlSessionå¯ä»¥å®ç°å¢åˆ æ”¹æŸ¥çš„æ¥å£</li></ol><p><img src="https://s1.ax1x.com/2020/04/16/JEVXRK.png" alt="JEVXRK.png"></p><ul><li>é»˜è®¤å®ç°<strong>DefaultSqlSession</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span>NO_RESULT_HANDLER<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error querying database.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œsqlçš„æ‰§è¡Œæ˜¯äº¤ç»™äº†<strong>executor</strong>å¯¹è±¡å»æ‰§è¡Œçš„ï¼Œè¯¥å¯¹è±¡æ˜¯<strong>SqlSession</strong>çš„ä¸€ä¸ªå±æ€§ã€‚è¯¥å±æ€§æ˜¯åœ¨<strong>SqlSession</strong>å¯¹è±¡çš„æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ã€‚ç»§ç»­å»¶ç€è°ƒç”¨é“¾æŸ¥çœ‹è°ƒç”¨è€…</p><ol start="2"><li><strong>SqlSessionFactory</strong>æ˜¯è·å–<strong>SqlSession</strong>çš„çš„æ¥å£</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">SqlSession</span> <span class="token function">openSessionFromDataSource</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">final</span> <span class="token class-name">Environment</span> environment <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token class-name">TransactionFactory</span> transactionFactory <span class="token operator">=</span> <span class="token function">getTransactionFactoryFromEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>    tx <span class="token operator">=</span> transactionFactory<span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newExecutor</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> execType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSession</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">closeTransaction</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// may have fetched a connection so lets call close()</span>    <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error opening session.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹åˆ°<strong>executor</strong>å¯¹è±¡æ˜¯é€šè¿‡<strong>comfiguration</strong>å¯¹è±¡è·å–åˆ°çš„ã€‚ç¨ååˆ†æ<strong>connfiguration</strong>æ—¶è¿›è¡Œåˆ†æè¯¥æ–¹æ³•ã€‚</p><ol start="3"><li><strong>SqlSessionManager</strong>æ˜¯ç»„åˆ<strong>SqlSession</strong>å’Œ<strong>SqlSessionFactory</strong>çš„å·¥å…·ç±»ã€‚é€šè¿‡è¿™ä¸ªç±»å¯ä»¥ç›´æ¥å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚è¯¥ç±»ä¼šå¤ç”¨<strong>SqlSessionManagerçš„localSqlSession</strong>çš„é€»è¾‘ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥åˆ†æBeanWrapper</title>
      <link href="2018/03/24/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/19.%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90BeanWrapper/"/>
      <url>2018/03/24/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/19.%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90BeanWrapper/</url>
      
        <content type="html"><![CDATA[<h1>æ·±å…¥åˆ†æBeanWrapper</h1><p><strong>BeanWrapper</strong>æ˜¯ä¸€ä¸ªä»BeanDefinitionåˆ°Beanç›´æ¥çš„ä¸­é—´äº§ç‰©</p><blockquote><p>å¯ä»¥è®¿é—®å±æ€§çš„é€šç”¨å‹æ¥å£ï¼ˆä¾‹å¦‚å¯¹è±¡çš„ bean å±æ€§æˆ–è€…å¯¹è±¡ä¸­çš„å­—æ®µï¼‰ï¼Œä½œä¸º BeanWrapper çš„åŸºç¡€æ¥å£</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†æBeanFactoryPostProcessor</title>
      <link href="2018/03/24/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/18.%E5%88%86%E6%9E%90BeanFactoryPostProcessor/"/>
      <url>2018/03/24/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/18.%E5%88%86%E6%9E%90BeanFactoryPostProcessor/</url>
      
        <content type="html"><![CDATA[<h1>åˆ†æBeanFactoryPostProcessor</h1><p><strong>BeanFactoryPostProcessor</strong>æ˜¯åœ¨æ³¨å†Œå®Œæˆ<strong>BeanDifinition</strong>åæ‰§è¡Œçš„æ¥å£ï¼Œè¯¥æ¥å£å°±åªæœ‰ä¸€ä¸ªæ–¹æ³•<strong>postProcessBeanFactory</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanFactoryPostProcessor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="å­ç±»PropertyPlaceholderConfigurer"><a class="header-anchor" href="#å­ç±»PropertyPlaceholderConfigurer"></a>å­ç±»PropertyPlaceholderConfigurer</h2><p><strong>PropertyPlaceholderConfigurer</strong>å·²è¿‡æ—¶</p><p><strong>PropertyResourceConfigurer</strong>å¸®ç€å¤„ç†å¥½å±æ€§åä¼ å…¥å­ç±»çš„æ–¹æ³•è¿›è¡Œæ‰§è¡Œ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Properties</span> mergedProps <span class="token operator">=</span> <span class="token function">mergeProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Convert the merged properties, if necessary.</span><span class="token function">convertProperties</span><span class="token punctuation">(</span>mergedProps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Let the subclass process the properties.</span><span class="token function">processProperties</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> mergedProps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInitializationException</span><span class="token punctuation">(</span><span class="token string">"Could not load properties"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦ç”¨æ³•æ˜¯ç”¨äºä¸åŒçš„ç¯å¢ƒæ³¨å…¥ä¸åŒçš„ç¯å¢ƒå‚æ•°ï¼Œåœ¨springBootä¸­å¯ä»¥ç”¨<strong>envAbstractEnvironment</strong>æ¥è¿›è¡Œæ›¿ä»£</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Beançš„ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="2018/03/23/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/17.Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
      <url>2018/03/23/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/17.Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      
        <content type="html"><![CDATA[<h1>Beançš„ç”Ÿå‘½å‘¨æœŸ</h1><p>å…ˆä¸Šä¸€å¼ æµç¨‹å›¾</p><p><img src="https://s1.ax1x.com/2020/03/23/8HBWTA.png" alt="8HBWTA.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºåˆå§‹åŒ–beançš„æµç¨‹ä¸»è¦åˆ†ä¸º</p><ol><li>å®ä¾‹åŒ–Bean</li><li>Awareã€BeanProcessorå¤„ç†</li><li>beanè‡ªå·±çš„initæ–¹æ³•</li><li>æ³¨é”€beanæ—¶æ‰§è¡Œdestroy-methodæ–¹æ³•</li></ol><h2 id="å®ä¾‹åŒ–Bean"><a class="header-anchor" href="#å®ä¾‹åŒ–Bean"></a>å®ä¾‹åŒ–Bean</h2><p>å®ä¾‹åŒ–beanä¸»è¦æ˜¯ç”¨<strong>BeanWrapperImpl</strong>,å…¶ä¸»è¦ä½œç”¨æ˜¯å¯¹è¿™ä¸ªBeanè¿›è¡ŒåŒ…è£…ã€‚Beançš„åˆå§‹åŒ–ä¸»è¦æ˜¯æ ¹æ®ç­–ç•¥æ¨¡å¼æ¥è¿›è¡Œé€‰æ‹©æ˜¯ç”¨JDKçš„åŠ¨æ€ä»£ç†æˆ–CGLibçš„åŠ¨æ€ä»£ç†æ¥å®ç°ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** Strategy for creating bean instances. */</span><span class="token keyword">private</span> <span class="token class-name">InstantiationStrategy</span> instantiationStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibSubclassingInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>               <span class="token class-name">Object</span> beanInstance<span class="token punctuation">;</span>               <span class="token keyword">final</span> <span class="token class-name">BeanFactory</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                   beanInstance <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>                           <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">,</span>                           <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span>               <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                   beanInstance <span class="token operator">=</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span>               <span class="token class-name">BeanWrapper</span> bw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapperImpl</span><span class="token punctuation">(</span>beanInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token function">initBeanWrapper</span><span class="token punctuation">(</span>bw<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token keyword">return</span> bw<span class="token punctuation">;</span>           <span class="token punctuation">&#125;</span>           <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>                       mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åœ¨è¿™é‡Œ<strong>getInstantiationStrategy()</strong>ï¼Œé€šè¿‡è·å–æŒ‡å®šçš„åŠ¨æ€ä»£ç†ç­–ç•¥æ¥è¿›è¡Œå®ä¾‹åŒ–</p></blockquote><ul><li>å¦‚ä½•æŒ‡å®šä½¿ç”¨JDKçš„proxyï¼Ÿ</li></ul><blockquote><p>spring5ä¸­è²Œä¼¼æ²¡æœ‰æ‰¾åˆ°</p></blockquote><h2 id="ä½¿ç”¨Awareæ¥å£"><a class="header-anchor" href="#ä½¿ç”¨Awareæ¥å£"></a>ä½¿ç”¨Awareæ¥å£</h2><p><strong>Aware</strong>æ¥å£æ˜¯ä¸€ä¸ªå…·æœ‰å…·æœ‰æ„ŸçŸ¥èƒ½åŠ›çš„æ¥å£ï¼Œå…¶ä¸»è¦çš„å­ç±»åˆ†åˆ«æ˜¯<strong>BeanNameAware</strong>ã€<strong>BeanClassLoaderAware</strong>ã€<strong>BeanFactoryAware</strong>æ¥å£ï¼Œä»¥ä¸Šä¸‰ä¸ªæ¥å£çš„æ–¹æ³•éƒ½æ˜¯åœ¨å®ä¾‹åŒ–å®Œæˆåè°ƒç”¨<strong>invokeAware</strong>å®ç°</p><h2 id="BeanPostProcessorå¢å¼º"><a class="header-anchor" href="#BeanPostProcessorå¢å¼º"></a>BeanPostProcessorå¢å¼º</h2><p><strong>BeanPostProcessor</strong>æ˜¯beançš„å¢å¼ºå™¨ï¼Œæ˜¯springå®¹å™¨ç”¨äºå¢å¼ºå…¨éƒ¨beançš„ç±»ã€‚ä¸»è¦æ˜¯åˆå§‹åŒ–çš„å‰ç½®æ–¹æ³•å’Œåç½®æ–¹æ³•ï¼Œä¸»è¦çš„å­ç±»æ˜¯<strong>InstantiationAwareBeanPostProcessorAdapter</strong>åœ¨åˆå§‹åŒ–å‰å°±å¯¹beanè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†ï¼Œä»¥ä¾¿è¿›è¡Œç‰¹æ®Šå¤„ç†</p><h2 id="init-method"><a class="header-anchor" href="#init-method"></a>init-method()</h2><p>init-methodè¡¨ç¤ºçš„æ˜¯beanè‡ªèº«å®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œåªä¼šä½œç”¨äºbeanæœ¬èº«çš„æ–¹æ³•ã€‚æ‰§è¡Œæ—¶æœºæ˜¯åœ¨å±æ€§èµ‹å€¼åè¿›è¡Œæ‰§è¡Œã€‚ä¸»è¦æœ‰</p><ol><li><strong>InitializingBeanæ¥å£</strong></li><li><strong>@init-methodæ³¨è§£</strong></li><li><strong>@PostConstruct</strong>ï¼Œåº•å±‚çš„å®ç°æ˜¯ä¾èµ–äº<strong>BeanPostProcessor</strong></li></ol><h2 id="DisposableBean"><a class="header-anchor" href="#DisposableBean"></a>DisposableBean</h2><p>é”€æ¯æ–¹æ³•</p><h1>æ€»ç»“</h1><p>Beanåˆå§‹åŒ–çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol start="0"><li>InstantiationAwareBeanPostProcessorçš„å‰ç½®æ–¹æ³•</li><li>å®åˆ—åŒ–<br>1.1 æ ¹æ®å®ä¾‹åŒ–ç­–ç•¥é€‰æ‹©è¿›è¡ŒJDKåå°„æˆ–è€…CGlibåå°„<br>1.2 æ‰§è¡ŒInstantiationAwareBeanPostProcessorçš„åç½®æ–¹æ³•<br>1.3 beançš„å±æ€§è¿›è¡Œèµ‹å€¼</li><li>Awareæ¥å£å¤„ç†</li><li>BeanProcessorsæ¥å£çš„å‰ç½®å¤„ç†</li><li>init-methodæ–¹æ³•è¿›è¡Œå¤„ç†</li><li>BeanProcessorsæ¥å£çš„åç½®å¤„ç†</li><li>é”€æ¯æ–¹æ³•</li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>InitializingBeanæ‰©å±•ç‚¹åˆ†æ</title>
      <link href="2018/03/21/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/16.InitializingBean%E6%89%A9%E5%B1%95%E7%82%B9%E5%88%86%E6%9E%90/"/>
      <url>2018/03/21/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/16.InitializingBean%E6%89%A9%E5%B1%95%E7%82%B9%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>InitializingBeanæ‰©å±•ç‚¹åˆ†æ</h1><p>ä¸Šé¢ä¸¤ç¯‡åˆ†åˆ«åˆ†æäº†æ‰©å±•ç‚¹<strong>aware</strong>ã€<strong>BreaProcessesor</strong>ï¼Œæ¥ä¸‹æ¥ç»§ç»­åˆ†æ<strong>InitializingBean</strong></p><h2 id="ä»£ç ç¤ºä¾‹"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>ä»£ç æ¼”ç¤º<br><img src="https://s1.ax1x.com/2020/03/21/8W8Ptf.png" alt="8W8Ptf.png"></li></ul><ol><li>InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()</li><li>InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()</li><li>InstantiationAwareBeanPostProcessor.postProcessProperties()</li><li>BeanPostProcessor.postProcessBeforeInitialization()</li><li>InitializingBean.afterPropertiesSet()</li><li>@Init-Method.initMethhod()</li><li>BeanPostProcessor.postProcessAfterInstantiation()</li></ol><blockquote><p><strong>@PostConstruct</strong>æ–¹æ³•åº•å±‚è¿˜æ˜¯ä¾èµ–äº<strong>BeanPostProcessæ¥å£</strong>å› æ­¤åº”è¯¥æ˜¯åœ¨4-5ä¹‹é—´è¿›è¡Œæ‰§è¡Œ</p></blockquote><h2 id="æ‰§è¡Œè¿‡ç¨‹"><a class="header-anchor" href="#æ‰§è¡Œè¿‡ç¨‹"></a>æ‰§è¡Œè¿‡ç¨‹</h2><ul><li>è°ƒç”¨æ–¹æ³•</li></ul><ol><li><p><strong>populateBean</strong><br><img src="https://s1.ax1x.com/2020/03/21/8Wetij.png" alt="8Wetij.png"></p></li><li><p><strong>initializeBean</strong>æ–¹æ³•</p></li></ol><p><img src="https://s1.ax1x.com/2020/03/21/8WeEZD.png" alt="8WeEZD.png"></p><p><strong>InitializingBean</strong>æ¥å£æ˜¯ä¸€ä¸ªä½œç”¨åŸŸä¸ºå½“å‰beançš„æ¥å£ï¼Œé€šè¿‡åœ¨åˆå§‹åŒ–å®Œæˆå±æ€§åè¿›è¡Œæ‰§è¡Œ</p><p>åœ¨<strong>initializeBean</strong>æ–¹æ³•æ¯”è¾ƒçš„é‡è¦åˆ†åˆ«æ‰§è¡Œäº†<strong>Awarea</strong>ã€<strong>BeanPostProcess</strong>çš„åç½®æ–¹æ³•ã€<strong>invokeInitMethods</strong>æ–¹æ³•</p><p>è¿™ä¸‰ä¸ªæ‰©å±•æ¥å£æ•´ä½“çš„æ‰§è¡Œæµç¨‹å°±æ˜¯<br><strong>Instantiation</strong> -&gt; <strong>BeanPostProcessor.beafore</strong> -&gt; <strong>InitializingBean</strong> -&gt; <strong>@Init-Method</strong> -&gt; <strong>BeanPostProcessor.after</strong></p><p>æ€»ç»“ï¼š<br><strong>InitializingBean</strong>æ˜¯ä½œä¸ºåˆå§‹åŒ–å¯¹è±¡è¿‡ç¨‹èµ‹å€¼å®Œæ¯•åæ‰§è¡Œçš„åˆå§‹åŒ–æ–¹æ³•</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BeanPostProcessoræ‰©å±•ç‚¹åˆ†æ</title>
      <link href="2018/03/20/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/15.BeanPostProcessor%E6%89%A9%E5%B1%95%E7%82%B9%E5%88%86%E6%9E%90/"/>
      <url>2018/03/20/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/15.BeanPostProcessor%E6%89%A9%E5%B1%95%E7%82%B9%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>BeanPostProcessoræ‰©å±•ç‚¹åˆ†æ</h1><blockquote><p>BeanPostProcessæ¥å£æ˜¯åœ¨Beanå®Œæˆå®ä¾‹åŒ–åï¼Œå¦‚æœæˆ‘ä»¬è¦å¯¹æ‰€æœ‰çš„åŠ è½½beanè¿›è¡Œä¸€äº›å¤„ç†æˆ–å¢åŠ é…ç½®çš„æ¥å£</p></blockquote><ul><li>BeanPostProcessor.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>    <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œç»“æœ</li></ul><p><a href="https://imgchr.com/i/8RTugf"><img src="https://s1.ax1x.com/2020/03/21/8RTugf.png" alt="8RTugf.png"></a></p><p>å¯ä»¥çœ‹å‡º<strong>BeanPostprocessor</strong>ä¼šå¯¹æ¯ä¸€ä¸ªbeanåœ¨åˆå§‹åŒ–å‰åè¿›è¡Œå¤„ç†</p><h2 id="å¤„ç†æœºåˆ¶"><a class="header-anchor" href="#å¤„ç†æœºåˆ¶"></a>å¤„ç†æœºåˆ¶</h2><p><img src="https://s1.ax1x.com/2020/03/21/8RvFDx.png" alt="8RvFDx.png"></p><blockquote><p>åœ¨å®Œæˆå±æ€§è£…é…ä¹‹åæ‰§è¡Œ<strong>initializeBean</strong>æ–¹æ³•</p></blockquote><p><a href="https://imgchr.com/i/8RvtPg"><img src="https://s1.ax1x.com/2020/03/21/8RvtPg.md.png" alt="8RvtPg.md.png"></a></p><p>æ³¨æ„åœ¨è¿™é‡Œçš„<strong>getBeanPostProcessors()<strong>å¹¶æ²¡æœ‰é€‰æ‹©æŸäº›ç‰¹å®šçš„BeanPostProcessoræ¥æ‰§è¡Œï¼›<br>åœ¨è£…é…å±æ€§çš„</strong>populateBean</strong>æ–¹æ³•ä¸­ä¼šæŒ‡å®šæ‰§è¡Œæ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://s1.ax1x.com/2020/03/21/8RzUun.png" alt="8RzUun.png"></p><h2 id="BeanPostProcessoråŠ è½½æ—¶æœº"><a class="header-anchor" href="#BeanPostProcessoråŠ è½½æ—¶æœº"></a>BeanPostProcessoråŠ è½½æ—¶æœº</h2><p>åœ¨<strong>AbstractApplicationContext</strong>åˆ·æ–°å®¹å™¨çš„è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œ<strong>registerBeanPostProcessors</strong>æ–¹æ³•.è¿™ä¸ªæ–¹æ³•çš„ç›®çš„å°±æ˜¯å°†<strong>BeanPostProcessors</strong>å­ç±»æ³¨å†Œåˆ°BeanFactoryä¸­ï¼Œå…¶ä¸­è¿˜ä¼šå®ç°<strong>priority</strong>ã€<strong>order</strong>ç­‰åŠŸèƒ½è¿›è¡Œæ’åº<br><a href="https://s1.ax1x.com/2020/03/21/8WSfMj.png">8WSfMj.png</a></p><h2 id="å¸¸ç”¨çš„BeanPostProcessorå­ç±»"><a class="header-anchor" href="#å¸¸ç”¨çš„BeanPostProcessorå­ç±»"></a>å¸¸ç”¨çš„BeanPostProcessorå­ç±»</h2><table><thead><tr><th>ç±»å</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>InstantiationAwareBeanPostProcessorAdapter</td><td>å®ä¾‹åŒ–åè¿›è¡Œåˆå§‹åŒ–å‰åæ‰§è¡Œï¼ˆå¯ä»¥å¯¹å±æ€§çš„è£…é…è¿›è¡Œæ§åˆ¶ï¼‰</td></tr><tr><td>ServletContextAwareProcessor</td><td>å¯¹servletContextè¿›è¡Œå¤„ç†</td></tr><tr><td>ApplicationContextAwareProcessor</td><td>å¯¹å®¹å™¨å·¥å…·ç±»è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œä»¥ä¾¿åç»­è¿›è¡Œä½¿ç”¨ï¼ˆä¾‹å¦‚æ³¨å…¥ç¯å¢ƒå˜é‡è¿™äº›ï¼‰</td></tr></tbody></table><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><ol><li><strong>BeanPostProcessor</strong> çš„ä½œç”¨åŸŸæ˜¯å®¹å™¨çº§åˆ«çš„ï¼Œå®ƒåªå’Œæ‰€åœ¨çš„å®¹å™¨ç›¸å…³ ï¼Œå½“ <strong>BeanPostProcessor</strong> å®Œæˆæ³¨å†Œåï¼Œå®ƒä¼šåº”ç”¨äºæ‰€æœ‰è·Ÿå®ƒåœ¨åŒä¸€ä¸ªå®¹å™¨å†…çš„ bean ã€‚</li><li><strong>BeanFactory</strong> å’Œ <strong>ApplicationContext</strong> å¯¹ <strong>BeanPostProcessor</strong> çš„å¤„ç†ä¸åŒï¼ŒApplicationContext ä¼šè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰å®ç°äº† <strong>BeanPostProcessor</strong> æ¥å£çš„ beanï¼Œå¹¶å®Œæˆæ³¨å†Œï¼Œä½†æ˜¯ä½¿ç”¨ BeanFactory å®¹å™¨æ—¶åˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <strong>AbstractBeanFactory#addBeanPostProcessor(BeanPostProcessor beanPostProcessor)</strong> æ–¹æ³•æ¥å®Œæˆæ³¨å†Œ</li><li><strong>ApplicationContext</strong> çš„ <strong>BeanPostProcessor</strong> æ”¯æŒ Orderedï¼Œè€Œ BeanFactory çš„ <strong>BeanPostProcessor</strong> æ˜¯ä¸æ”¯æŒçš„ï¼ŒåŸå› åœ¨äºApplicationContext ä¼šå¯¹ <strong>BeanPostProcessor</strong> è¿›è¡Œ Ordered æ£€æµ‹å¹¶å®Œæˆæ’åºï¼Œè€Œ BeanFactory ä¸­çš„ <strong>BeanPostProcessor</strong> åªè·Ÿæ³¨å†Œçš„é¡ºåºæœ‰å…³ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Awareæ¥å£æ‰©å±•ç‚¹çš„åˆ†æ</title>
      <link href="2018/03/20/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/14.Aware%E6%8E%A5%E5%8F%A3%E6%89%A9%E5%B1%95%E7%82%B9%E7%9A%84%E5%88%86%E6%9E%90/"/>
      <url>2018/03/20/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/14.Aware%E6%8E%A5%E5%8F%A3%E6%89%A9%E5%B1%95%E7%82%B9%E7%9A%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>Awareæ¥å£æ‰©å±•ç‚¹çš„åˆ†æ</h1><p><strong>aware</strong>å­—é¢ä¸Šçš„æ„æ€ä¸ºæ„ŸçŸ¥ï¼Œåœ¨springä¸­å°±æ˜¯æ„ŸçŸ¥å®¹å™¨ã€beançš„æ—¶æœºå¹¶è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•çš„</p><h2 id="ä½¿ç”¨"><a class="header-anchor" href="#ä½¿ç”¨"></a>ä½¿ç”¨</h2><p><img src="https://s1.ax1x.com/2020/03/20/86lLsf.png" alt="86lLsf.png"></p><h2 id="å¸¸ç”¨çš„Aware"><a class="header-anchor" href="#å¸¸ç”¨çš„Aware"></a>å¸¸ç”¨çš„Aware</h2><table><thead><tr><th>ç±»å</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>LoadTimeWeaverAware</td><td>åŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ</td></tr><tr><td>BeanClassLoaderAware</td><td>åŠ è½½Spring Beançš„ç±»åŠ è½½å™¨</td></tr><tr><td>BootstrapContextAware</td><td>èµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI</td></tr><tr><td>ResourceLoaderAware</td><td>åº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨</td></tr><tr><td>BeanFactoryAware</td><td>å£°æ˜BeanFactory</td></tr><tr><td>PortletConfigAware</td><td>PortletConfig</td></tr><tr><td>PortletContextAware</td><td>PortletContext</td></tr><tr><td>ServletConfigAware</td><td>ServletConfig</td></tr><tr><td>ServletContextAware</td><td>ServletContext</td></tr><tr><td>MessageSourceAware</td><td>å›½é™…åŒ–</td></tr><tr><td>ApplicationEventPublisherAware</td><td>åº”ç”¨äº‹ä»¶</td></tr><tr><td>NotificationPublisherAware</td><td>JMXé€šçŸ¥</td></tr><tr><td>BeanNameAware</td><td>å£°æ˜Spring Beançš„åå­—</td></tr></tbody></table><h2 id="å¦‚ä½•å®ç°"><a class="header-anchor" href="#å¦‚ä½•å®ç°"></a>å¦‚ä½•å®ç°</h2><ul><li>AbstractAutowireCapableBeanFactory</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">Aware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ClassLoader</span> bcl <span class="token operator">=</span> <span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bcl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span>bcl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">*</span><span class="token operator">/</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨åˆå§‹åŒ–beançš„æ—¶å€™åˆ¤æ–­beanæ˜¯å¦æ˜¯awareå­ç±»æœ¬è¿›è¡Œå›è°ƒã€‚å¯¹äºå…¶ä»–awareå­ç±»ä¹Ÿåº”è¯¥ä¸€æ ·æ˜¯åœ¨è®¾å®šçš„ä¸šåŠ¡å›è°ƒç‚¹è¿›è¡Œå›è°ƒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ›å»ºbeançš„æµç¨‹</title>
      <link href="2018/03/19/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/13.%E5%88%9B%E5%BB%BAbean%E7%9A%84%E6%B5%81%E7%A8%8B/"/>
      <url>2018/03/19/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/13.%E5%88%9B%E5%BB%BAbean%E7%9A%84%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1>åˆ›å»ºbeançš„æµç¨‹</h1><p>é€šè¿‡ä¸Šé¢å‡ ä¸ªæµç¨‹çš„åˆ†æï¼Œç»ˆäºæ¥åˆ°äº†springåˆå§‹åŒ–beançš„æµç¨‹äº†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸»è¦çš„åŠŸèƒ½æœ‰å®åˆ—åŒ–beanå¯¹è±¡ã€åŠ è½½åˆ°ç¼“å­˜ã€å‰åç½®å¤„ç†;</p><h2 id="åˆ›å»ºæµç¨‹"><a class="header-anchor" href="#åˆ›å»ºæµç¨‹"></a>åˆ›å»ºæµç¨‹</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//1.å¤„ç†BeanDefinition</span>        <span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>        mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//2. å°è¯•ä»BeanPostProcessorsè¿”å›ä»£ç†ç±»å¯¹è±¡</span>        <span class="token comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>        <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//åˆ›å»ºbean</span>        <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºæµç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥ï¼š</p><ol><li>å¯¹BeanDifinitionå±æ€§åœ¨åŠ è½½å‰è¿›è¡Œå¤„ç†<br>1.1 è§£ææŒ‡å®š BeanDefinition çš„ class<br>1.2 å¤„ç†overrideå±æ€§</li><li>å°è¯•åœ¨åˆ›å»ºå‰è°ƒç”¨å‰ç½®å¤„ç†è¿”å›bean<br>2.1 ä¸»è¦æ˜¯è°ƒç”¨<strong>InstantiationAwareBeanPostProcessor</strong>æ¥å£(æå‰è¿”å›ä»£ç†ç±»ï¼ŒAOPå°±æ˜¯åŸºäºæ­¤)</li><li>å¼€å§‹åˆå§‹åŒ–bean</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Instantiate the bean.</span><span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>        <span class="token comment">//æ„é€ æ–¹æ³•åˆå§‹åŒ–beanå¯¹è±¡</span><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">final</span> <span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è§£å†³å•åˆ—æ¨¡å¼å¾ªç¯åŠ è½½beanï¼Œæå‰å°†åˆå§‹åŒ–ä¸­çš„beanæ”¾å…¥æ­£åœ¨åˆå§‹åŒ–çš„mapä¸­</span><span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Initialize the bean instance.</span>        <span class="token comment">//åˆå§‹åŒ–beanå¯¹è±¡</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¯¹beanè¿›è¡Œå¡«å……å°†å„ä¸ªå±æ€§å€¼æ³¨å…¥ï¼Œå¯èƒ½å­˜åœ¨ä¾èµ–äºå…¶ä»–beançš„å±æ€§</span><span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span>exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>        <span class="token comment">//è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Register bean as disposable.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//æ³¨å†Œbean</span><span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>        <span class="token comment">//è¿”å›</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>å•åˆ—æ¨¡å¼ä¸‹æ¸…é™¤å®¹å™¨</li><li>æ„é€ æ–¹æ³•åˆå§‹åŒ–beanå¯¹è±¡</li><li>å±æ€§è£…é…è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</li><li>è§£å†³å¾ªç¯ä¾èµ–</li><li>æ³¨å†Œã€è¿”å›bean</li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Beançš„åŠ è½½1</title>
      <link href="2018/03/19/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/12.Bean%E7%9A%84%E5%8A%A0%E8%BD%BD/"/>
      <url>2018/03/19/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/12.Bean%E7%9A%84%E5%8A%A0%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<h1>Beançš„åŠ è½½</h1><p>Spring Iocå®¹å™¨å°±æ˜¯ä»¥æŸç§æ–¹å¼åŠ è½½é…ç½®æ–‡ä»¶å¹¶åˆ›å»ºç›¸åº”çš„å¯¹è±¡è¿›è¡Œç»‘å®šå½¢æˆä¸€ä¸ªå¯å–å¯å­˜çš„å®¹å™¨ã€‚</p><p>springåœ¨å®ç°è¿‡ç¨‹ä¸­åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ</li><li>åŠ è½½beané˜¶æ®µ</li></ol><h2 id="å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ"><a class="header-anchor" href="#å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ"></a>å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ</h2><ol><li>é€šè¿‡æŸç§æ–¹å¼(<strong>ResourceLoadle</strong>)å°†é…ç½®æ–‡ä»¶(Resource)åŠ è½½</li><li>é€šè¿‡<strong>BeanDefinitionReader</strong>å°†é…ç½®æ–‡ä»¶è½¬æ¢ä¸ºBeanDefinition</li><li>é€šè¿‡<strong>BeanDefinitionRegistry</strong>å°†BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­</li><li>Iocå®¹å™¨å¼€å§‹è¿›è¡Œåˆå§‹åŒ–</li></ol><h2 id="åŠ è½½beané˜¶æ®µ"><a class="header-anchor" href="#åŠ è½½beané˜¶æ®µ"></a>åŠ è½½beané˜¶æ®µ</h2><ol><li>è°ƒç”¨**BeanFactory.getBean(â€¦)**è¿›è¡ŒbeanåŠ è½½</li><li>åˆå§‹åŒ–Beanå®Œæˆä¹‹åè¿›è¡Œç¼“å­˜æˆ–åŸå‹æ¨¡å¼</li></ol><h1>doGetBean(â€¦)æ–¹æ³•</h1><p>**doGetBean(â€¦)**æ–¹æ³•æ˜¯beanåŠ è½½çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæµç¨‹ï¼š</p><h2 id="æ ¸å¿ƒæµç¨‹"><a class="header-anchor" href="#æ ¸å¿ƒæµç¨‹"></a>æ ¸å¿ƒæµç¨‹</h2><ol><li>å¯¹BeanNameçš„å¤„ç†</li></ol><blockquote><p>é€šè¿‡å¯¹ä¼ å…¥çš„beanNameè¿›è¡Œå¤„ç†è·å–åˆ°çœŸå®çš„beanName</p></blockquote><ol start="2"><li>å°è¯•ä»å·²åŠ è½½çš„å®¹å™¨ä¸­è·å–</li></ol><blockquote><p>å¦‚æœå®¹å™¨ä¸­å·²ç»å­˜åœ¨beanï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿›è¡Œè¿”å›</p></blockquote><ol start="3"><li>å¯¹åŸå‹æ¨¡å¼å¾ªç¯ä¾èµ–çš„æ£€æŸ¥</li><li>å°è¯•é€šè¿‡ParentBeanFacotyè¿”å›bean</li><li>æ ‡è®°beanæ­£åœ¨è¿›è¡Œåˆ›å»º</li><li>å¤„ç†å¾ªç¯ä¾èµ–</li></ol><blockquote><p>é€šè¿‡æ ‡è®° beanName -&gt; ä¾èµ–çš„beanNamesï¼Œé€’å½’è¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨é€’å½’å…³ç³»ï¼›å¦‚æœå­˜åœ¨é€’å½’å…³ç³» -&gt; å¤„ç†å¾ªç¯ä¾èµ–</p></blockquote><ol start="8"><li>ä¸åŒä½œç”¨åŸŸä¸‹çš„å®ä¾‹åŒ–</li></ol><blockquote><p>createBean(â€¦)</p></blockquote><ol start="9"><li>å¯¹è¿”å›ç»“æœè¿›è¡Œç±»å‹è½¬åŒ–</li></ol><h2 id="å¾ªç¯ä¾èµ–"><a class="header-anchor" href="#å¾ªç¯ä¾èµ–"></a>å¾ªç¯ä¾èµ–</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å±æ€§ä¾èµ–</li></ul><ol><li>åŠ è½½Aç±»ï¼Œå°è¯•ä»ç¼“å­˜æˆ–æ­£åœ¨åŠ è½½çš„é›†åˆä¸­è·å–,ç”±äºç¬¬ä¸€æ¬¡åˆå§‹åŒ–è‚¯å®šæ˜¯å–ä¸åˆ°çš„</li><li>ç”±äºç¼“å­˜ä¸­æ²¡æœ‰beanï¼ŒAç±»è¿›è¡Œåˆå§‹åŒ–</li><li>Aç±»åˆå§‹åŒ–å®Œæˆéœ€è¦è£…é…å±æ€§ï¼Œè£…é…å±æ€§çš„æ—¶å€™å‘ç°ä¾èµ–çš„Bè¿˜æœªè¿›è¡ŒåŠ è½½ï¼Œå°±æ‰§è¡ŒåŠ è½½Bç±»çš„åŠ¨ä½œ</li><li>Bç±»é‡å¤1ï¼Œ2ï¼Œ3ï¼Œåœ¨æ‰§è¡Œ3æ—¶ï¼Œå‘ç°ä¾èµ–äºA,é‚£ä¹ˆå°±å°†ä¼šä»æ­£åœ¨æ‰§è¡Œçš„åŠ è½½Mapå¯¹è±¡ä¸­å»è·å–Aç±»</li><li>Bç±»åŠ è½½æˆåŠŸ-&gt;Aç±»ç»§ç»­åŠ è½½</li></ol><ul><li>@DependsOn</li></ul><blockquote><p>@DependsOnæ˜¯æŒ‡å®šå…¶ä»–beanè¦åœ¨å½“å‰beanåˆå§‹åŒ–ä¹‹å‰è¿›è¡ŒåŠ è½½ï¼›å¹¶ä¸”ä¸èƒ½æœ‰å¾ªç¯ä¾èµ–çš„åœºæ™¯å‡ºç°</p></blockquote><ol><li>Aç±»ä¾èµ–äºBç±»ï¼ŒAç±»åˆå§‹åŒ–åˆ°è¿™é‡Œæ—¶ä¼šå»åŠ è½½Bç±»ï¼Œ</li><li>å¦‚æœBç±»ä¾èµ–äºAç±»ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆè°ƒç”¨ä¸€æ¬¡getBean(â€œAâ€)ï¼Œè¿™é‡Œæ˜¯ä¸è¦æ±‚æœ‰è¿”å›ç»“æœ</li></ol><h2 id="beanåˆå§‹åŒ–çš„ç»†èŠ‚"><a class="header-anchor" href="#beanåˆå§‹åŒ–çš„ç»†èŠ‚"></a>beanåˆå§‹åŒ–çš„ç»†èŠ‚</h2><h3 id="Singleton-scope"><a class="header-anchor" href="#Singleton-scope"></a>Singleton scope</h3><ol><li>å†æ¬¡æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰bean</li><li>åˆå§‹åŒ–beançš„å‰ç½®å¤„ç†</li><li>**singletonFactory.getObject();**åˆå§‹åŒ–bean</li><li>åˆå§‹åŒ–beançš„åç½®å¤„ç†</li><li>æ”¾å…¥ç¼“å­˜åŠå¤„ç†<br>5.1 ã€putã€‘singletonObjects å±æ€§ï¼Œå•ä¾‹ bean çš„ç¼“å­˜ã€‚<br>5.2 ã€removeã€‘singletonFactories å±æ€§ï¼Œå•ä¾‹ bean Factory çš„ç¼“å­˜ã€‚<br>5.3 ã€removeã€‘earlySingletonObjects å±æ€§ï¼Œâ€œæ—©æœŸâ€åˆ›å»ºçš„å•ä¾‹ bean çš„ç¼“å­˜ã€‚<br>5.4 ã€addã€‘registeredSingletons å±æ€§ï¼Œå·²ç»æ³¨å†Œçš„å•ä¾‹ç¼“å­˜ã€‚</li></ol><h3 id="prototype-scope"><a class="header-anchor" href="#prototype-scope"></a>prototype scope</h3><ol><li>åˆå§‹åŒ–beançš„å‰ç½®å¤„ç†</li><li>**createBean();**åˆå§‹åŒ–bean</li><li>åˆå§‹åŒ–beançš„åç½®å¤„ç†</li></ol><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>Beançš„åŠ è½½çš„åŠ è½½ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªå¤§æµç¨‹ï¼š</p><ol><li>å®¹å™¨ç¯å¢ƒçš„åˆå§‹åŒ–<br>1.1 èµ„æºæ–‡ä»¶åŠ è½½<br>1.2 èµ„æºæ–‡ä»¶ -&gt; BeanDefinition<br>1.3 æ³¨å†ŒBeanDefinition<br>2.Beançš„åˆå§‹åŒ–<br>2.1 å¯¹æ³¨å†Œçš„BeanDefinitionçš„å†æ¬¡å¤„ç†(å±æ€§åˆå¹¶ã€åŠ è½½é¡ºåºç­‰)<br>2.2 åŠ è½½Bean(è§£å†³å¾ªç¯ä¾èµ–ã€å‰ç½®åç½®æ“ä½œã€åˆå§‹åŒ–bean)</li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springçš„BeanDefinitionä½“ç³»</title>
      <link href="2018/03/18/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/11.spring%E7%9A%84BeanDefinition%E4%BD%93%E7%B3%BB/"/>
      <url>2018/03/18/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/11.spring%E7%9A%84BeanDefinition%E4%BD%93%E7%B3%BB/</url>
      
        <content type="html"><![CDATA[<h1>springçš„BeanDefinitionä½“ç³»</h1><p>BeanDefinitionæ˜¯ä½œä¸ºè®°å½•Beançš„åŸå§‹ä¿¡æ¯ã€‚è¯»å–å®Œæˆé…ç½®æ–‡ä»¶åå°±è¦å°†é…ç½®æ–‡ä»¶è§£æä¸º<strong>BeanDefinition</strong>ã€‚æˆ‘ä»¬æ¥åˆ†æä¸€ä¸€ä¸‹è¿™ä¸ªæµç¨‹</p><h2 id="beançš„å…ƒæ•°æ®"><a class="header-anchor" href="#beançš„å…ƒæ•°æ®"></a>beançš„å…ƒæ•°æ®</h2><ul><li>BeanDefinition -&gt; beançš„å…ƒæ•°æ®</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> SCOPE_SINGLETON <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>SCOPE_SINGLETON<span class="token punctuation">;</span><span class="token class-name">String</span> SCOPE_PROTOTYPE <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>SCOPE_PROTOTYPE<span class="token punctuation">;</span><span class="token keyword">int</span> ROLE_APPLICATION <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> ROLE_SUPPORT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> ROLE_INFRASTRUCTURE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®çˆ¶å®šä¹‰çš„åç§°</span><span class="token keyword">void</span> <span class="token function">setParentName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®BeanClassName</span><span class="token keyword">void</span> <span class="token function">setBeanClassName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®ä½œç”¨åŸŸ</span><span class="token keyword">void</span> <span class="token function">setScope</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®åŠ è½½æ—¶é—´</span><span class="token keyword">void</span> <span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> lazyInit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®ä¾èµ–</span><span class="token keyword">void</span> <span class="token function">setDependsOn</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®æ˜¯å¦è‡ªåŠ¨è£…é…</span><span class="token keyword">void</span> <span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autowireCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®æ˜¯å¦æ˜¯è‡ªåŠ¨è£…é…çš„é¦–é€‰å¯¹è±¡</span><span class="token keyword">void</span> <span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> primary<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">isPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®BeanFactoryåç§°</span><span class="token keyword">void</span> <span class="token function">setFactoryBeanName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> factoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getFactoryBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®è°ƒç”¨BeanFacoryçš„æŒ‡å®šæ–¹æ³•</span><span class="token keyword">void</span> <span class="token function">setFactoryMethodName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> factoryMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿”å›beanæ„é€ æ–¹æ³•çš„å‚æ•°</span><span class="token class-name">ConstructorArgumentValues</span> <span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è·å–å±æ€§å€¼</span><span class="token class-name">MutablePropertyValues</span> <span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è®¾ç½®åˆå§‹åŒ–æ–¹æ³•</span><span class="token keyword">void</span> <span class="token function">setInitMethodName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> initMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getInitMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®é”€æ¯æ–¹æ³•</span><span class="token keyword">void</span> <span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getDestroyMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®beançš„è§’è‰²</span><span class="token keyword">void</span> <span class="token function">setRole</span><span class="token punctuation">(</span><span class="token keyword">int</span> role<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®beançš„æè¿°ä¿¡æ¯</span><span class="token keyword">void</span> <span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿”å›èµ„æºçš„æè¿°ä¿¡æ¯</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">String</span> <span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–åŸå§‹çš„BeanDefinitionä¿¡æ¯</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">BeanDefinition</span> <span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>BeanDefinition</strong>ç»§æ‰¿ä¸¤ä¸ªæ¥å£<strong>AttributeAccessor</strong>ã€<strong>BeanMetadataElement</strong></p><ul><li>AttributeAccessor</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AttributeAccessor</span> <span class="token punctuation">&#123;</span><span class="token keyword">void</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">Object</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">Object</span> <span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> <span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">attributeNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>AttributeAccessor</strong>å®šä¹‰äº†ä¸€ç³»åˆ—æœ‰å…³å±æ€§çš„æ“ä½œæ¥å£</p><ul><li>BeanMetadataElement</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">Object</span> <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>BeanMetadataElement</strong>è¿”å›åŸå§‹æ–‡ä»¶ä¿¡æ¯</p><ul><li>å­ç±»</li></ul><p><img src="https://s1.ax1x.com/2020/03/18/8D1wJx.png" alt="8D1wJx.png"></p><ul><li><p><strong>AbstractBeanDefinition</strong>æŠ½è±¡å‡ºæ–‡ä»¶å®šä¹‰çš„BeanDefintion</p></li><li><p><strong>AnnotatedBeanDefinition</strong>åŸºäºæ³¨è§£çš„BeanDefinition</p></li></ul><h2 id="BeanDefinitionçš„åŠ è½½å™¨"><a class="header-anchor" href="#BeanDefinitionçš„åŠ è½½å™¨"></a>BeanDefinitionçš„åŠ è½½å™¨</h2><p>AnnotatedBeanDefinitionReader -&gt; BeanDefinitionçš„åŠ è½½å™¨</p><ul><li>BeanDefinitionReader.java</li></ul><blockquote><p>BeanDefinitionReader ï¼Œä¸»è¦å®šä¹‰èµ„æºæ–‡ä»¶è¯»å–å¹¶è½¬æ¢ä¸º BeanDefinition çš„å„ä¸ªåŠŸèƒ½ã€‚ from ã€ŠSpring æºç æ·±åº¦è§£æã€‹</p></blockquote><p>ç°åœ¨æ™®éä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥åŠ è½½beanï¼Œå› æ­¤ç”¨<strong>AnnotatedBeanDefinitionReader</strong>æ¥åˆ†æåŠ è½½èµ„æºçš„æµç¨‹</p><ul><li>AnnotatedBeanDefinitionReader.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">doRegisterBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> annotatedClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> instanceSupplier<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> qualifiers<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionCustomizer</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> definitionCustomizers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AnnotatedGenericBeanDefinition</span> abd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedGenericBeanDefinition</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>abd<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>abd<span class="token punctuation">.</span><span class="token function">setInstanceSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>abd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>qualifiers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> qualifier <span class="token operator">:</span> qualifiers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Primary</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>abd<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Lazy</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>abd<span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>abd<span class="token punctuation">.</span><span class="token function">addQualifier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutowireCandidateQualifier</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionCustomizer</span> customizer <span class="token operator">:</span> definitionCustomizers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>customizer<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨å†Œä»£ç ä¸»è¦åˆ†ä¸ºä¸¤æ­¥</p><ol><li>åˆ›å»º<strong>AnnotatedGenericBeanDefinition</strong>,setå„ç§å±æ€§</li><li>æ³¨å†ŒBeanDefinition<br>å…¶ä¸­æ³¨å†Œ<strong>registerBeanDefinition</strong>ä½¿ç”¨çš„æ˜¯æ¨¡æ¿æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒçš„å®ç°å‘æ³¨å†ŒBeanDefinitionæ—¶è¿›è¡Œä¸åŒçš„æ“ä½œå’Œæ£€æŸ¥</li></ol><h2 id="BeanDefinitionçš„æ³¨å†Œå™¨"><a class="header-anchor" href="#BeanDefinitionçš„æ³¨å†Œå™¨"></a>BeanDefinitionçš„æ³¨å†Œå™¨</h2><p>åœ¨ä¸Šä¸€æ­¥çš„ç»“å°¾ï¼Œé€šè¿‡è°ƒç”¨<strong>BeanDefinitionReaderUtils.registerBeanDefinition</strong>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯<strong>BeanDefinitionRegistry.registerBeanDefinition</strong></p><p>æ³¨å†ŒBeanDefinitionçš„è¿‡ç¨‹å…¶å®å°±å‘<strong>beanDefinitionMap</strong>ä¸­æ·»åŠ å…ƒç´ çš„</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p><strong>BeanDefinition</strong>ä½œä¸ºbeanå®šä¹‰çš„å…ƒæ•°æ®ï¼Œé€šè¿‡<strong>BeanDefinitionReader</strong>æ¥è¿›è¡ŒåŠ è½½ã€‚å¯ä»¥ä»æ–‡ä»¶ã€æ³¨è§£ç­‰åœ°æ–¹åŠ è½½å®šä¹‰ã€‚æœ€åé€šè¿‡<strong>BeanDefinitionRegistry</strong>å°†<strong>BeanDefinitionReader</strong>åŠ è½½è¿›<strong>beanDefinitionMap</strong>ä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springä¸­èµ„æºçš„åŠ è½½</title>
      <link href="2018/03/17/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/10.spring%E4%B8%AD%E8%B5%84%E6%BA%90%E7%9A%84%E5%8A%A0%E8%BD%BD/"/>
      <url>2018/03/17/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/10.spring%E4%B8%AD%E8%B5%84%E6%BA%90%E7%9A%84%E5%8A%A0%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<h1>springä¸­èµ„æºçš„åŠ è½½</h1><p>å¯¹äºèµ„æºçš„åŠ è½½è¿™ä¸ªåœºæ™¯é¦–å…ˆè¦åˆ’åˆ†<strong>è¾¹ç•Œ</strong>,springæŠ½è±¡å‡ºä¸¤ä¸ªç»„ä»¶ï¼š<strong>Resource</strong>ã€<strong>ResourceLoader</strong></p><h2 id="Resourceæ¥å£"><a class="header-anchor" href="#Resourceæ¥å£"></a>Resourceæ¥å£</h2><p><strong>Resource</strong>æ˜¯å¯¹èµ„æºçš„ä¸€ç§æŠ½è±¡ï¼Œæä¾›ä¸€ç³»åˆ—æ“ä½œæ–‡ä»¶çš„æ–¹æ³•</p><h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰"></a>å®šä¹‰</h3><ul><li>resource.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Resource</span> <span class="token keyword">extends</span> <span class="token class-name">InputStreamSource</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>    <span class="token keyword">boolean</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶æ˜¯å¦å¯è¯»</span>    <span class="token keyword">boolean</span> <span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶æ˜¯å¦æ‰“å¼€</span>    <span class="token keyword">boolean</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›ç»Ÿä¸€èµ„æºå®šä½å™¨(URL)</span>    <span class="token class-name">URL</span> <span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›URI</span>    <span class="token class-name">URI</span> <span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›æ–‡ä»¶</span>    <span class="token class-name">File</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´</span>    <span class="token keyword">long</span> <span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶æ–‡ä»¶ç›¸å¯¹è·¯å¾„</span>    <span class="token class-name">Resource</span> <span class="token function">createRelative</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›æ–‡ä»¶åç§°</span>    <span class="token class-name">String</span> <span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›æ–‡ä»¶æè¿°</span>    <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å­ç±»"><a class="header-anchor" href="#å­ç±»"></a>å­ç±»</h3><table><thead><tr><th>ç±»å</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>FileSystemResource</td><td>å¯¹ java.io.File ç±»å‹èµ„æºçš„å°è£…</td></tr><tr><td>ByteArrayResource</td><td>å¯¹å­—èŠ‚æ•°ç»„æä¾›çš„æ•°æ®çš„å°è£…</td></tr><tr><td>UrlResource</td><td>å¯¹ java.net.URLç±»å‹èµ„æºçš„å°è£…</td></tr><tr><td>ClassPathResource</td><td>class path ç±»å‹èµ„æºçš„å®ç°ã€‚ä½¿ç”¨ç»™å®šçš„ ClassLoader æˆ–è€…ç»™å®šçš„ Class æ¥åŠ è½½èµ„æº</td></tr><tr><td>InputStreamResource</td><td>å°†ç»™å®šçš„ InputStream ä½œä¸ºä¸€ç§èµ„æºçš„ Resource çš„å®ç°ç±»</td></tr></tbody></table><h3 id="AbstractResource"><a class="header-anchor" href="#AbstractResource"></a>AbstractResource</h3><p><strong>AbstractResource</strong>æ˜¯Resourceçš„é»˜è®¤æŠ½è±¡ç±»ï¼Œå®ç°äº†å¤§éƒ¨åˆ†å…¬å…±æ–¹æ³•ï¼›</p><h2 id="ResourceLoader"><a class="header-anchor" href="#ResourceLoader"></a>ResourceLoader</h2><p><strong>ResourceLoader</strong>å®šä¹‰å¦‚ä½•åŠ è½½Resourceçš„æ¥å£</p><h3 id="å®šä¹‰-v2"><a class="header-anchor" href="#å®šä¹‰-v2"></a>å®šä¹‰</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ResourceLoader</span> <span class="token punctuation">&#123;</span><span class="token comment">/** Pseudo URL prefix for loading from the class path: "classpath:". */</span><span class="token class-name">String</span> CLASSPATH_URL_PREFIX <span class="token operator">=</span> <span class="token class-name">ResourceUtils</span><span class="token punctuation">.</span>CLASSPATH_URL_PREFIX<span class="token punctuation">;</span><span class="token class-name">Resource</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Nullable</span><span class="token class-name">ClassLoader</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>Resource getResource(String location)<br>æ ¹æ®åœ°å€è¿”å›Resource,ä¸ä¿è¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå› æ­¤éœ€è¦è°ƒç”¨**exists()**è¿›è¡Œåˆ¤æ–­</p></li><li><p>getClassLoader()<br>getClassLoader() æ–¹æ³•ï¼Œè¿”å› ClassLoader å®ä¾‹</p></li></ul><h3 id="DefaultResourceLoader-java"><a class="header-anchor" href="#DefaultResourceLoader-java"></a>DefaultResourceLoader.java</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Resource</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> location<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token string">"Location must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//1. é¦–å…ˆé€šè¿‡ProtocolResolveræ¥åŠ è½½</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolResolver</span> protocolResolver <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>protocolResolvers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Resource</span> resource <span class="token operator">=</span> protocolResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> resource<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>        <span class="token comment">//2. ç”¨ClassPathResourceåŠ è½½</span><span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">getResourceByPath</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>CLASSPATH_URL_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>CLASSPATH_URL_PREFIX<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//3. å°è¯•ç”¨FileUrlResourceæˆ–UrlResourceè¿›è¡ŒåŠ è½½</span><span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ResourceUtils</span><span class="token punctuation">.</span><span class="token function">isFileURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FileUrlResource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">UrlResource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>            <span class="token comment">//4. urlç±»å‹åŠ è½½ä¸åˆ°ï¼Œç»§ç»­ä½¿ç”¨ClassPathResourceæ–¹å¼è¿›è¡ŒåŠ è½½</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// No URL -> resolve as resource path.</span><span class="token keyword">return</span> <span class="token function">getResourceByPath</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ProtocolResolver"><a class="header-anchor" href="#ProtocolResolver"></a>ProtocolResolver</h4><p><strong>ProtocolResolver</strong>ç”¨æˆ·è‡ªå®šä¹‰åè®®èµ„æºè§£å†³ç­–ç•¥</p><h4 id="ä»£ç æ¼”ç¤º"><a class="header-anchor" href="#ä»£ç æ¼”ç¤º"></a>ä»£ç æ¼”ç¤º</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ResourceLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Resource</span> fileResource1 <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"D:/text.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Resource</span> fileResource2 <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/text.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Resource</span> urlResource1 <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"file:/Users/text.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Resource</span> urlResource2 <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"fileResource1.class = "</span> <span class="token operator">+</span> fileResource1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"fileResource2.class = "</span> <span class="token operator">+</span> fileResource1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"urlResource1.class = "</span> <span class="token operator">+</span> urlResource1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"urlResource2.class = "</span> <span class="token operator">+</span> urlResource2<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è¿è¡Œç»“æœ</p></blockquote><p><img src="https://s1.ax1x.com/2020/03/18/8dJXjg.png" alt="8dJXjg.png"></p><p>ç”±äºfileResource1èµ„æºä¸å­˜åœ¨ï¼Œå› æ­¤æŠ›å‡ºå¼‚å¸¸ï¼Œä½¿ç”¨<strong>ClassPathResource</strong>æ¥åŠ è½½èµ„æº</p><h3 id="FileSystemResourceLoader"><a class="header-anchor" href="#FileSystemResourceLoader"></a>FileSystemResourceLoader</h3><p><strong>FileSystemResourceLoader</strong>æ˜¯å¯¹fileæ–‡ä»¶çš„åŠ è½½çš„ä¼˜åŒ–</p><ul><li>getResourceByPath(String path)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Resource</span> <span class="token function">getResourceByPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileSystemResourceLoader<span class="token punctuation">.</span>FileSystemContextResource</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹<strong>getResourceByPath</strong>æ–¹æ³•é’ˆå¯¹fileçš„<strong>é‡å†™</strong>,è‡ªç„¶è¿”å›çš„éƒ½æ˜¯<strong>FileSystemContextResource</strong>ç±»å‹çš„Resource</p><h3 id="ClassRelativeResourceLoader"><a class="header-anchor" href="#ClassRelativeResourceLoader"></a>ClassRelativeResourceLoader</h3><ul><li>getResourceByPath(String path)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token class-name">Resource</span> <span class="token function">getResourceByPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClassRelativeContextResource</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ClassRelativeResourceLoader</strong>æ˜¯é’ˆå¯¹åŠ è½½ClassPathResourceå­ç±»ClassRelativeContextResourceæ–‡ä»¶çš„é‡å†™</p><h3 id="ResourcePatternResolver"><a class="header-anchor" href="#ResourcePatternResolver"></a>ResourcePatternResolver</h3><p><strong>ResourcePatternResolver</strong>æ˜¯é’ˆå¯¹ResourceLoaderçš„å¢å¼ºï¼Œå®šä¹‰è¿”å›å¤šä¸ªResourceçš„æ–¹æ³•</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><ol><li>srpingé€šè¿‡è®¾è®¡å‡ºæŠ½è±¡çš„èµ„æº(Resource)å’Œèµ„æºåŠ è½½å™¨(ResourceLoader)è®©åŠ è½½èµ„æºè¿™ä¸ªä¸šåŠ¡åœºæ™¯ï¼Œå˜çš„æ›´åŠ çš„è¾¹ç•Œæ¸…æ™°å’Œæ¾è€¦åˆ</li><li><strong>AbstrctResource</strong>æ˜¯Resourceçš„æŠ½è±¡å®ç°ç±»ï¼Œå®ç°äº†Resourceå¤§éƒ¨åˆ†æ¥å£ï¼Œä½¿ç”¨æ¨¡æ¿æ–¹æ³•</li><li><strong>DefaultResourceLoader</strong>æ˜¯ResourceLoaderé»˜è®¤å®ç°ï¼Œå®ç°äº†æœ€çº§åˆ«çš„æ–¹æ³•èµ„æºçš„æ–¹æ³•ï¼Œå¹¶æä¾›äº†ä¸€äº›å…¬å…±æ¥å£ä¸ºå­ç±»çš„æ‰©å±•æä¾›ä¾¿åˆ©ã€‚</li><li><strong>PathMatchingResourcePatternResolver</strong>å®ç°äº†<strong>ResourcePatternResolver</strong>ï¼ˆä¸€ä¸ªå…è®¸è¿”å›å¤šä¸ªèµ„æºæ–‡ä»¶çš„ResourceLoderæ¥å£ï¼‰,æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ResourceLoader</li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springæºä»£ç åŸºç¡€å’Œç»„ä»¶</title>
      <link href="2018/03/17/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/9.spring%E6%BA%90%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80%E5%92%8C%E7%BB%84%E4%BB%B6/"/>
      <url>2018/03/17/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/9.spring%E6%BA%90%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80%E5%92%8C%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1>springçš„IoCç†è§£</h1><p><strong>IoC</strong>åè¯å«ä¹‰æŒ‡çš„æ˜¯<strong>æ§åˆ¶åè½¬</strong>æˆ–<strong>ä¾èµ–æ³¨å…¥</strong>ï¼Œä½†æ˜¯æœ¬è´¨ä¸ŠæŒ‡çš„æ˜¯æˆ‘ä»¬åœ¨ä¸åŒçš„ç±»ä¸­ç›¸äº’ä¾èµ–çš„ä¸æ˜¯ç±»æœ¬èº«ï¼Œè€Œæ˜¯ä¸åŒçš„ç±»æä¾›å‡ºæ¥çš„ä¸åŒæœåŠ¡ï¼Œæœ¬è´¨æ˜¯ä¾èµ–äºæœåŠ¡ã€‚ç”±äºä¸šåŠ¡å¤„ç†é€»è¾‘æœ¬èº«æ˜¯ä¸€ç§<strong>æ— çŠ¶æ€</strong>çš„å¤„ç†è¿‡ç¨‹ï¼Œå› æ­¤ä¸è¯¥ä½¿ç”¨è€…å»å…³å¿ƒæœåŠ¡æä¾›è€…çš„ç”Ÿå‘½å‘¨æœŸ(åˆ›å»ºã€åˆå§‹åŒ–ã€é”€æ¯),ä½¿ç”¨è€…å…³å¿ƒäºæä¾›çš„æœåŠ¡æœ¬èº«ã€‚<strong>IoC</strong>æœ¬è´¨ä¸Šå°±æ˜¯å»æ§åˆ¶ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼Œè®©å¼€å‘è€…å…³æ³¨äºæœåŠ¡æœ¬èº«çš„å·¥å…·ã€‚</p><h1>æ³¨å…¥æ–¹å¼</h1><p>ä»ä¸Šä¸€ä¸ªé—®é¢˜åˆå¼•å‡ºè¿™ä¸€ä¸ªé—®é¢˜ï¼ŒIoCå®¹å™¨ç®¡ç†ç€ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯IoCå®¹å™¨ä¸çŸ¥é“åº”è¯¥å°†ç®¡ç†çš„ç±»æ˜¯æœåŠ¡äºé‚£ç§ä¸šåŠ¡åœºæ™¯ä¸‹ã€‚å› æ­¤å°±éœ€è¦æˆ‘ä»¬å°†ç®¡ç†çš„ç±»<strong>æ³¨å…¥</strong>åˆ°ä¸šåŠ¡ç±»ä¸­ã€‚springå¸¸ç”¨çš„ä¸‰ç§æ³¨å…¥æ–¹å¼</p><ol><li>@Autowiredï¼Œè‡ªåŠ¨è£…é…æ³¨å…¥ï¼ŒåŸºäºåå°„</li><li>æ„é€ å™¨æ³¨å…¥</li><li>setteræ–¹æ³•æ³¨å…¥</li></ol><h1>springçš„ç»„ä»¶</h1><p>ï¼ˆå›¾è‡ª:<a href="http://singleant.iteye.com/blog/1177358%EF%BC%89">http://singleant.iteye.com/blog/1177358ï¼‰</a></p><p><img src="https://s1.ax1x.com/2020/03/17/8dekeU.jpg" alt="8dekeU.jpg"></p><h2 id="Resource-ä½“ç³»"><a class="header-anchor" href="#Resource-ä½“ç³»"></a>Resource ä½“ç³»</h2><p><img src="https://s1.ax1x.com/2020/03/17/8defXV.jpg" alt="8defXV.jpg"></p><p>org.springframework.core.io.Resourceï¼Œ<strong>å¯¹èµ„æºçš„æŠ½è±¡</strong>ã€‚å®ƒçš„æ¯ä¸€ä¸ªå®ç°ç±»éƒ½ä»£è¡¨äº†ä¸€ç§èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œå¦‚ ClassPathResourceã€RLResourceã€FileSystemResourceç­‰</p><h2 id="ResourceLoader-ä½“ç³»"><a class="header-anchor" href="#ResourceLoader-ä½“ç³»"></a>ResourceLoader ä½“ç³»</h2><p><img src="https://s1.ax1x.com/2020/03/17/8devnK.png" alt="8devnK.png"></p><p>org.springframework.core.io.ResourceLoaderå®šä¹‰äº†<strong>ç»Ÿä¸€èµ„æºåŠ è½½</strong>çš„æ–¹æ³•</p><h2 id="BeanFactory-ä½“ç³»"><a class="header-anchor" href="#BeanFactory-ä½“ç³»"></a>BeanFactory ä½“ç³»</h2><p>org.springframework.beans.factory.BeanFactoryæ˜¯springæœ€åº•å±‚å®šä¹‰å¦‚ä½•æ“ä½œbeançš„æ¥å£,<strong>AbstractBeanFactory</strong>å†…éƒ¨æŒæœ‰ä¸€ä¸ª<strong>ConcurrentHashMap</strong>æ¥ä¿å­˜nameå’ŒBeanDefinitionä¹‹é—´çš„æ˜ å°„</p><h2 id="BeanDefinition-ä½“ç³»"><a class="header-anchor" href="#BeanDefinition-ä½“ç³»"></a>BeanDefinition ä½“ç³»</h2><p><a href="https://imgchr.com/i/8dnjoD"><img src="https://s1.ax1x.com/2020/03/17/8dnjoD.png" alt="8dnjoD.png"></a><br><strong>BeanDefinition</strong>ç”¨äºæè¿°beançš„å…ƒæ•°æ®</p><h2 id="BeanDefinitionReader-ä½“ç³»"><a class="header-anchor" href="#BeanDefinitionReader-ä½“ç³»"></a>BeanDefinitionReader ä½“ç³»</h2><p><img src="https://s1.ax1x.com/2020/03/17/8duKln.png" alt="8duKln.png"></p><p>org.springframework.beans.factory.support.BeanDefinitionReader çš„ä½œç”¨æ˜¯è¯»å– Spring çš„é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ Ioc å®¹å™¨å†…éƒ¨çš„æ•°æ®ç»“æ„ ï¼šBeanDefinition</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springè°ƒè¯•ç¯å¢ƒæ­å»º</title>
      <link href="2018/03/17/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/8.spring%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
      <url>2018/03/17/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/8.spring%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1>springè°ƒè¯•ç¯å¢ƒæ­å»º</h1><h2 id="ç¯å¢ƒä¾èµ–"><a class="header-anchor" href="#ç¯å¢ƒä¾èµ–"></a>ç¯å¢ƒä¾èµ–</h2><ul><li>Gradle</li><li>Git</li><li>JDK1.8+</li></ul><h2 id="clone"><a class="header-anchor" href="#clone"></a>clone</h2><p>è·³è¿‡ï¼Œä¸‹è½½åå¯¼å…¥ideaä¼šè‡ªåŠ¨ä½¿ç”¨Gradleæ¥<strong>Build</strong>é¡¹ç›®</p><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">gradlew :spring-oxm:compileTestJava<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id=""><a class="header-anchor" href="#"></a></h2>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springæºä»£ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring æŒä¹…åŒ–çš„è®¾è®¡</title>
      <link href="2018/03/13/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/7.spring%20%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E8%AE%BE%E8%AE%A1/"/>
      <url>2018/03/13/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/7.spring%20%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>springæŒä¹…åŒ–çš„è®¾è®¡</h1><p>springä¸­å¤§é‡è¿ç”¨åˆ°<strong>æ¨¡æ¿æ¨¡å¼</strong>ï¼Œç®€å•å›é¡¾ä¸€ä¸‹æ¨¡æ¿æ¨¡å¼å°±æ˜¯</p><blockquote><p>æŠ½è±¡ç±»ä¸­å®šä¹‰å¥½äº§å“çš„æ­¥éª¤ï¼Œä¸åŒçš„ä¹‹ç±»å»å®ç°ç›¸åŒçš„æ­¥éª¤æ–¹æ³•ï¼Œå®¢æˆ·ç«¯è°ƒç”¨æŠ½è±¡ç±»çš„æ–¹æ³•ï¼Œæ‰§è¡Œç»Ÿä¸€çš„äº§å“æ­¥éª¤ï¼Œä»è€Œè¿”å›ç»“æœæœ‰ç‚¹ç±»ä¼¼äºæ¡¥æ¥æ¨¡å¼çš„ä¸€åŠï¼Œå°†å»ºé€ è¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼Œå½¢æˆç»Ÿä¸€çš„æ¨¡æ¿æ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨é’©å­æ–¹æ³•æ”¹é€ æ¨¡æ¿æ–¹æ³•æµç¨‹ï¼Œä»è€Œå¢åŠ å¥å£®æ€§ã€‚</p></blockquote><h2 id="JdbcTemplateåˆ†æ"><a class="header-anchor" href="#JdbcTemplateåˆ†æ"></a>JdbcTemplateåˆ†æ</h2><h3 id="ä½¿ç”¨ä»£ç "><a class="header-anchor" href="#ä½¿ç”¨ä»£ç "></a>ä½¿ç”¨ä»£ç </h3><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>  <span class="token key atrule">active</span><span class="token punctuation">:</span> dev  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/tables<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;serverTimezone=GMT</span>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>UserDO.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDO</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>UserRowMapper.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRowMapper</span> <span class="token keyword">implements</span> <span class="token class-name">RowMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">UserDO</span> <span class="token function">mapRow</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">,</span> <span class="token keyword">int</span> rowNum<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">UserDO</span> userDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDO<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDO<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDO<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"pass_word"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> userDO<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>UserServiceImpl.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">UserDO</span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from t_user where id = ? "</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">></span></span> stu <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UserDO</span> student <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>stu<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            student <span class="token operator">=</span> stu<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> student<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserDO</span> userDO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span><span class="token string">"insert into student(id,user_name,pass_word) values(null,?,?)"</span><span class="token punctuation">;</span>        <span class="token class-name">KeyHolder</span> keyHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GeneratedKeyHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> resRow <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PreparedStatementCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">PreparedStatement</span> <span class="token function">createPreparedStatement</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>userDO<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>userDO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> ps<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>keyHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>keyHolder<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Test.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">UserService</span> service<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">UserDO</span> user <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">UserDO</span> userDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDO<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDO<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Integer</span> userId <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userDO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>**private JdbcTemplate jdbcTemplate;**æ˜¯ç”±JdbcTemplateAutoConfigurationåŠ è½½åˆ°å®¹å™¨ä¸­çš„ï¼›</p><ul><li><p><strong>JdbcTemplate</strong>å®ç°äº†JdbcAccessorã€JdbcOperationsæ¥å£<br><img src="https://s1.ax1x.com/2020/03/16/8Yb6aR.png" alt="8Yb6aR.png"></p></li><li><p>query</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Nullable</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatementCreator</span> psc<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">PreparedStatementSetter</span> pss<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ResultSetExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> rse<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rse<span class="token punctuation">,</span> <span class="token string">"ResultSetExtractor must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Executing prepared SQL query"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">execute</span><span class="token punctuation">(</span>psc<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PreparedStatementCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Override</span><span class="token annotation punctuation">@Nullable</span><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">doInPreparedStatement</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pss <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>pss<span class="token punctuation">.</span><span class="token function">setValues</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>rs <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> rse<span class="token punctuation">.</span><span class="token function">extractData</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">closeResultSet</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pss <span class="token keyword">instanceof</span> <span class="token class-name">ParameterDisposer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParameterDisposer</span><span class="token punctuation">)</span> pss<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cleanupParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>execute</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatementCreator</span> psc<span class="token punctuation">,</span> <span class="token class-name">PreparedStatementCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> action<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>ps <span class="token operator">=</span> psc<span class="token punctuation">.</span><span class="token function">createPreparedStatement</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">applyStatementSettings</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">T</span> result <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">doInPreparedStatement</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">handleWarnings</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>psc <span class="token keyword">instanceof</span> <span class="token class-name">ParameterDisposer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParameterDisposer</span><span class="token punctuation">)</span> psc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cleanupParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">closeStatement</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>execute</strong>æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå°†<strong>connection</strong>çš„è·å–å’Œå…³é—­æŠ½è±¡å‡ºæ¥ä½œä¸ºæ‰§è¡Œï¼Œä¼ å…¥çš„actionä½œä¸ºæ‰©å±•å®ç°çš„æ–¹æ³•ã€‚</p><h2 id="Connection"><a class="header-anchor" href="#Connection"></a>Connection</h2><p><strong>Connection</strong>æ˜¯é€šè¿‡DataSourceUtils.getConnection(DataSource dataSource)æ¥è·å–çš„</p><ul><li>doGetConnection</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> <span class="token string">"No DataSource specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ConnectionHolder</span> conHolder <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionHolder</span><span class="token punctuation">)</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>conHolder <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>conHolder<span class="token punctuation">.</span><span class="token function">hasConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> conHolder<span class="token punctuation">.</span><span class="token function">isSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>conHolder<span class="token punctuation">.</span><span class="token function">requested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>conHolder<span class="token punctuation">.</span><span class="token function">hasConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Fetching resumed JDBC Connection from DataSource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conHolder<span class="token punctuation">.</span><span class="token function">setConnection</span><span class="token punctuation">(</span><span class="token function">fetchConnection</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> conHolder<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Else we either got no holder or an empty thread-bound holder here.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Fetching JDBC Connection from DataSource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token function">fetchConnection</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// Use same Connection for further JDBC actions within the transaction.</span><span class="token comment">// Thread-bound object will get removed by synchronization at transaction completion.</span><span class="token class-name">ConnectionHolder</span> holderToUse <span class="token operator">=</span> conHolder<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>holderToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>holderToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionHolder</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>holderToUse<span class="token punctuation">.</span><span class="token function">setConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>holderToUse<span class="token punctuation">.</span><span class="token function">requested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">registerSynchronization</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectionSynchronization</span><span class="token punctuation">(</span>holderToUse<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>holderToUse<span class="token punctuation">.</span><span class="token function">setSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>holderToUse <span class="token operator">!=</span> conHolder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">bindResource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> holderToUse<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Unexpected exception from external delegation call -> close Connection and rethrow.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> con<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>TransactionSynchronizationManager.resource</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"Transactional resources"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>resourceæ˜¯ä¸€ä¸ªçº¿ç¨‹å˜é‡,å½“åŒä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–jdbc Connectionæ—¶è¿”å›çš„æ˜¯åŒä¸€ä¸ªConnection<br>å½“Connectionè·å–ä¸åˆ°æ—¶å°±ä¼šä»DataSourceä¸­è·å–æ–°çš„jdbcè¿æ¥ï¼Œå¹¶æ”¾åˆ°resourceä¸­</p><h2 id="äº‹åŠ¡"><a class="header-anchor" href="#äº‹åŠ¡"></a>äº‹åŠ¡</h2><p>springä¸­<strong>äº‹åŠ¡ä¼ æ’­çº§åˆ«</strong>åˆ†ä¸º</p><p>æ”¯æŒå½“å‰äº‹åŠ¡çš„æƒ…å†µ:</p><ul><li><strong>TransactionDefinition.PROPAGATION_REQUIRED</strong>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™åŠ å…¥è¯¥äº‹åŠ¡;å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡,åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</li><li><strong>TransactionDefinition.PROPAGATION_SUPPORTS</strong>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™åŠ å…¥è¯¥äº‹åŠ¡;å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡,åˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚</li><li><strong>TransactionDefinition.PROPAGATION_MANDATORY</strong>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™åŠ å…¥è¯¥äº‹åŠ¡;å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡,åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚(mandatory:å¼ºåˆ¶æ€§)</li></ul><p>ä¸æ”¯æŒå½“å‰äº‹åŠ¡çš„æƒ…å†µ:</p><ul><li><strong>TransactionDefinition.PROPAGATION_REQUIRES_NEW</strong>: åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡,å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li><li><strong>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</strong>: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ,å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li><li><strong>TransactionDefinition.PROPAGATION_NEVER</strong>: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ,å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><p>å…¶ä»–æƒ…å†µ:</p><ul><li><strong>TransactionDefinition.PROPAGATION_NESTED</strong>: å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡,åˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡æ¥è¿è¡Œ;å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡,åˆ™è¯¥å–å€¼ç­‰ä»·äºTransactionDefinition.PROPAGATION_REQUIREDã€‚</li></ul><p>springä¸­<strong>äº‹åŠ¡éš”ç¦»çº§åˆ«</strong>åˆ†ä¸º</p><ul><li><strong>TransactionDefinition.ISOLATION_DEFAULT</strong>: ä½¿ç”¨åç«¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«,Mysql é»˜è®¤é‡‡ç”¨çš„<strong>REPEATABLE_READ</strong>éš”ç¦»çº§åˆ« Oracle é»˜è®¤é‡‡ç”¨çš„ <strong>READ_COMMITTED</strong>éš”ç¦»çº§åˆ«ã€‚</li><li><strong>TransactionDefinition.ISOLATION_READ_UNCOMMITTED</strong>: æœ€ä½çš„éš”ç¦»çº§åˆ«,å…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´,å¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚</li><li><strong>TransactionDefinition.ISOLATION_READ_COMMITTED</strong>: å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®,å¯ä»¥é˜»æ­¢è„è¯»,ä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li><strong>TransactionDefinition.ISOLATION_REPEATABLE_READ</strong>: å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„,é™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹,å¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»,ä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li><strong>TransactionDefinition.ISOLATION_SERIALIZABLE</strong>: æœ€é«˜çš„éš”ç¦»çº§åˆ«,å®Œå…¨æœä»ACIDçš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œ,è¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°,ä¹Ÿå°±æ˜¯è¯´,è¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ä½†æ˜¯è¿™å°†ä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç”¨åˆ°è¯¥çº§åˆ«ã€‚</li></ul><h2 id="äº‹åŠ¡çš„è¿œè¡ŒåŸç†"><a class="header-anchor" href="#äº‹åŠ¡çš„è¿œè¡ŒåŸç†"></a>äº‹åŠ¡çš„è¿œè¡ŒåŸç†</h2><ul><li><p>TransactionAspectSupport<br><strong>TransactionAspectSupport</strong> implements BeanFactoryAware, InitializingBean<br>è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•</p></li><li><p>TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);<br>createTransactionIfNecessary() -&gt; AbstractPlatformTransactionManager.getTransaction(txAttr) -&gt; doBegin(transaction, definition)</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">con <span class="token operator">=</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>con<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  txObject<span class="token punctuation">.</span><span class="token function">setMustRestoreAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Switching JDBC Connection ["</span> <span class="token operator">+</span> con <span class="token operator">+</span> <span class="token string">"] to manual commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  con<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨doBeginæ–¹æ³•ä¸­è·å–åˆ°è®¾ç½®ä¸€ä¸ª<strong>con.setAutoCommit(false);</strong></p><ul><li>completeTransactionAfterThrowing(txInfo, ex);</li></ul><p><strong>completeTransactionAfterThrowing(txInfo, ex)</strong> -&gt; <strong>txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus())</strong> -&gt;<strong>processRollback(defStatus, false)</strong> -&gt;<strong>doRollback</strong></p><p>è°ƒç”¨<strong>AbstractPlatformTransactionManager</strong>çš„doRollbackæ–¹æ³•æ‰§è¡Œçš„å›æ»šï¼Œè¿™é‡Œä½¿ç”¨çš„ä¹Ÿæ˜¯æ¨¡æ¿æ¨¡å¼ä¸åŒçš„è¿æ¥æ–¹å¼æœ‰ä¸åŒçš„å›æ»šé€»è¾‘ï¼Œä¾‹å¦‚<strong>DataSourceTransactionManager</strong>çš„å›æ»šæ–¹æ³•å°±æ˜¯è°ƒç”¨<strong>con.rollback()</strong>ï¼ˆæ•°æ®åº“é©±åŠ¨ç¨‹åºçš„rollbackï¼‰</p><h2 id="å¦‚ä½•ç»‡å…¥çš„ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•ç»‡å…¥çš„ï¼Ÿ"></a>å¦‚ä½•ç»‡å…¥çš„ï¼Ÿ</h2><p>springå®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå°† @Transactionalæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å…ˆè¿›è¡Œä¸€ä¸ªé…ç½®è§£æï¼Œå†è¿›è¡Œä¸€ä¸ªaopçš„å¢å¼ºï¼Œå½“æ‰§è¡Œè¿™ä¸ªæ–¹æ³•æ—¶å€™ä¼šå…ˆæ‰§è¡Œaopçš„æ–¹æ³•å¼€å¯äº‹åŠ¡ï¼Œé€šè¿‡åå°„å°†ç›®æ ‡æ–¹æ³•æ‰§è¡Œå®Œæ¯•ååœ¨é€šè¿‡ç»“è¿‡è¿›è¡Œå¯¹åº”çš„ä¸€ä¸ªå¤„ç†</p><h1>æ€»ç»“ï¼š</h1><ul><li><p>SpringåŸºäºThreadLocalè§£å†³æœ‰çŠ¶æ€çš„Connetionçš„å¹¶å‘é—®é¢˜ï¼Œäº‹åŠ¡åŒæ­¥ç®¡ç†å™¨org.springframework.transaction.support.TransactionSynchronizationManagerä½¿ç”¨ThreadLocalä¸ºä¸åŒäº‹åŠ¡çº¿ç¨‹æä¾›ç‹¬ç«‹çš„èµ„æºå‰¯æœ¬</p></li><li><p>Springäº‹åŠ¡ç®¡ç†åŸºäº3ä¸ªæ¥å£ï¼šTransactionDefinitionï¼ŒTransactionStatuså’ŒPlatformTransactionManager</p></li></ul><p><strong>TransactionDefinition</strong>å®šä¹‰äº†ä¼ æ’­çº§åˆ«å’Œéš”ç¦»çº§åˆ«</p><p><strong>TransactionStatus</strong>å®šä¹‰äº†äº‹åŠ¡çš„çŠ¶æ€</p><p><strong>PlatformTransactionManager</strong>å®ç°äº†äº‹åŠ¡çš„æ‰§è¡Œæ–¹æ³•</p><ul><li>æ³¨æ„ç‚¹</li></ul><ol><li>æ³¨è§£ä¸èƒ½è¢«ç»§æ‰¿ï¼Œæ‰€ä»¥ä¸šåŠ¡æ¥å£ä¸­çš„@Transactionalæ³¨è§£ä¸ä¼šè¢«ä¸šåŠ¡å®ç°ç±»ç»§æ‰¿ï¼›æ–¹æ³•å¤„çš„æ³¨è§£ä¼šè¦†ç›–ç±»å®šä¹‰å¤„çš„æ³¨è§£</li><li>å¯¹äºåŸºäºæ¥å£åŠ¨æ€ä»£ç†çš„AOPäº‹åŠ¡ï¼Œç”±äºæ¥å£æ–¹æ³•éƒ½æ˜¯publicçš„ï¼Œå®ç°ç±»çš„å®ç°æ–¹æ³•å¿…é¡»æ˜¯publicçš„ï¼ŒåŒæ—¶ä¸èƒ½ä½¿ç”¨staticä¿®é¥°ç¬¦ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ¥å£åŠ¨æ€ä»£ç†å®æ–½AOPå¢å¼ºã€å®ç°Springäº‹åŠ¡çš„æ–¹æ³•åªèƒ½æ˜¯publicæˆ–public finalçš„</li><li>åŸºäºCGLibåŠ¨æ€ä»£ç†å®æ–½AOPçš„æ—¶å€™ï¼Œç”±äºä½¿ç”¨finalã€staticã€privateçš„æ–¹æ³•ä¸èƒ½è¢«å­ç±»è¦†ç›–ï¼Œç›¸åº”çš„ï¼Œè¿™äº›æ–¹æ³•ä¸èƒ½å®æ–½AOPå¢å¼ºï¼Œå®ç°äº‹åŠ¡</li><li>ä¸èƒ½è¢«Springè¿›è¡ŒAOPäº‹åŠ¡å¢å¼ºçš„æ–¹æ³•ä¸èƒ½å¯åŠ¨äº‹åŠ¡ï¼Œä½†æ˜¯å¤–å±‚æ–¹æ³•çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ä»ç„¶å¯ä»¥ä¼ æ’­åˆ°è¿™äº›æ–¹æ³•ä¸­</li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æŒä¹…åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring MVCåˆ†æ</title>
      <link href="2018/03/12/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/6.spring%20MVC%E5%88%86%E6%9E%90/"/>
      <url>2018/03/12/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/6.spring%20MVC%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>spring MVCåˆ†æ</h1><p>æœ¬ç« ä¸»è¦åˆ†æä¸€ä¸‹spring MVCçš„è¿‡ç¨‹ï¼Œä¸»è¦ä»ä¸€ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><h2 id="spring-MVCæ¦‚è¿°"><a class="header-anchor" href="#spring-MVCæ¦‚è¿°"></a>spring MVCæ¦‚è¿°</h2><p>å¦‚æœè¦åœ¨webç¯å¢ƒä¸­ä½¿ç”¨IOCå®¹å™¨ï¼Œéœ€è¦spring IOCè®¾è®¡ä¸€ä¸ªå¯åŠ¨è¿‡ç¨‹æŠŠIOCå®¹å™¨å¯¼å…¥ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸€æ–¹é¢<strong>å¤„ç†Webå®¹å™¨çš„å¯åŠ¨</strong>ï¼Œå¦ä¸€æ–¹é¢é€šè¿‡è®¾è®¡ç‰¹å®šçš„webå®¹å™¨æ‹¦æˆªå™¨å°†IOCå®¹å™¨åŠ è½½åˆ°webç¯å¢ƒä¸­è¿›è¡Œåˆå§‹åŒ–ã€‚</p><ul><li>web.xmlæ–‡ä»¶æè¿°</li></ul><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>springmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>spring mvc é…ç½®æ–‡ä»¶<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>classpath*:/spring-mvc.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>springmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener-class</span><span class="token punctuation">></span></span>org.springframework.web.context.ContextLoaderListener<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>context-param</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>classpath:applicationContext.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>context-param</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡åœ¨web.xmlæ–‡ä»¶ä¸­</p><ol><li>å®šä¹‰ä¸€ä¸ª<strong>DispatcherServlet</strong>å¹¶ä¸”æ‹¦æˆªæ‰€æœ‰è¯·æ±‚</li><li>å‘ServletContextæ³¨å†Œå‚æ•°æ–‡ä»¶ä¸º<strong>applicationContext.xml</strong></li><li>æ³¨å†Œç›‘å¬å™¨<strong>ContextLoaderListener</strong><br>é€šè¿‡è¿™æ ·çš„è®¾ç½®<strong>ServletContext</strong>å°±ä¸ºspring IOC æä¾›äº†ä¸€ä¸ªå®¿ä¸»ç¯å¢ƒã€‚IOCå®¹å™¨é€šè¿‡<strong>ContextLoaderListener</strong>çš„åˆå§‹åŒ–æ¥å»ºç«‹ï¼ŒIOCå®¹å™¨åˆå§‹åŒ–å®Œæˆåï¼Œåˆ©ç”¨<strong>DispatcherServlet</strong>ä½œä¸ºSpring MVCå¤„ç†è¯·æ±‚çš„è½¬å‘å™¨ï¼Œæ¥è½¬å‘HTTPè¯·æ±‚ã€‚</li></ol><h2 id="åˆå§‹åŒ–è¿‡ç¨‹"><a class="header-anchor" href="#åˆå§‹åŒ–è¿‡ç¨‹"></a>åˆå§‹åŒ–è¿‡ç¨‹</h2><ul><li>ContextLoaderListeneræ˜¯åˆå§‹åŒ–Spring IOCå®¹å™¨çš„å…³é”®ï¼Œç±»å›¾å¦‚ä¸‹</li></ul><p><img src="https://s1.ax1x.com/2020/03/12/8m7l28.png" alt="8m7l28.png"></p><ul><li><p>ServletContextListeneræ˜¯Servletè§„èŒƒä¸­å®šä¹‰çš„æ¥å£</p></li><li><p>ContextLoaderæ˜¯springç”¨æ¥è¿›è¡Œåˆå§‹åŒ–çš„ç±»</p></li><li><p>ContextLoaderListenerä»£ç ,è°ƒç”¨ContextLoaderè¿›è¡Œåˆå§‹åŒ–</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token class-name">ServletContextEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">initWebApplicationContext</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ContextLoaderä»£ç </li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">WebApplicationContext</span> <span class="token function">initWebApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>servletContext<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Cannot initialize context because there is already a root application context present - "</span> <span class="token operator">+</span><span class="token string">"check whether you have multiple ContextLoader* definitions in your web.xml!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>        <span class="token comment">//çœç•¥ä»£ç ...</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// Store context in local instance variable, to guarantee that</span><span class="token comment">// it is available on ServletContext shutdown.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">createWebApplicationContext</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ConfigurableWebApplicationContext</span> cwac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cwac<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¸Šä¸‹æ–‡å°šæœªåˆ·æ–°->æä¾›è¯¸å¦‚è®¾ç½®çˆ¶ä¸Šä¸‹æ–‡ï¼Œè®¾ç½®åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡IDç­‰æœåŠ¡ã€‚</span><span class="token keyword">if</span> <span class="token punctuation">(</span>cwac<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// ä¸Šä¸‹æ–‡å®ä¾‹æ˜¯åœ¨æ²¡æœ‰æ˜¾å¼çˆ¶çº§çš„æƒ…å†µä¸‹æ³¨å…¥çš„-> ç¡®å®šæ ¹Webåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„çˆ¶çº§ï¼ˆå¦‚æœæœ‰ï¼‰</span><span class="token class-name">ApplicationContext</span> parent <span class="token operator">=</span> <span class="token function">loadParentContext</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>cwac<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">configureAndRefreshWebApplicationContext</span><span class="token punctuation">(</span>cwac<span class="token punctuation">,</span> servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>            <span class="token comment">//çœç•¥ä»£ç </span>servletContext<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initWebApplicationContextä¸»è¦æ˜¯åˆ›å»º<strong>WebApplicationContext</strong>å¯¹è±¡å¹¶è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œç„¶ååœ¨å°†<strong>WebApplicationContext</strong>å¯¹è±¡æ”¾åˆ°<strong>servletContext</strong>åŸŸä¸­</p><ul><li>createWebApplicationContextæ–¹æ³•</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">WebApplicationContext</span> <span class="token function">createWebApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> sc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> contextClass <span class="token operator">=</span> <span class="token function">determineContextClass</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>contextClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">"Custom context class ["</span> <span class="token operator">+</span> contextClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"] is not of type ["</span> <span class="token operator">+</span> <span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">)</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>contextClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>determineContextClass(sc)æ–¹æ³•è·å–åˆ°æ˜¯paramä¸­è®¾ç½®çš„<em>contextClass</em>,é»˜è®¤æ˜¯è¿”å›<strong>WebApplicationContext.class</strong></li></ul><p>é»˜è®¤å®šä¹‰çš„æ˜¯XmlWebApplicationContext.class</p><pre class="line-numbers language-none"><code class="language-none">org.springframework.web.context.WebApplicationContext&#x3D;org.springframework.web.context.support.XmlWebApplicationContext<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>**BeanUtils.instantiateClass(contextClass)**è¿”å›XmlWebApplicationContext</li></ul><p>åˆå§‹åŒ–å®Œæˆä¸Šä¸‹æ–‡å¯¹è±¡åä¼šå»è°ƒç”¨<strong>configureAndRefreshWebApplicationContext</strong>æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configureAndRefreshWebApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableWebApplicationContext</span> wac<span class="token punctuation">,</span> <span class="token class-name">ServletContext</span> sc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//çœç•¥ä»£ç ...</span>    wac<span class="token punctuation">.</span><span class="token function">setServletContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">customizeContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> wac<span class="token punctuation">)</span><span class="token punctuation">;</span>    wac<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸€æ­¥éª¤ä¸­ï¼Œå°†<strong>ServletContext</strong>å¯¹è±¡è®¾ç½®åœ¨äº†ApplicationContextä¸­ï¼Œå¹¶ä¸”è¿›è¡Œäº†**refresh()**æ–¹æ³•</p><h2 id="DispatcherServletåˆ†æ"><a class="header-anchor" href="#DispatcherServletåˆ†æ"></a>DispatcherServletåˆ†æ</h2><p><strong>DispatcherServlet</strong>ä½œä¸ºä¸€ä¸ªå‰ç«¯æ§åˆ¶å™¨ï¼Œæ‰€æœ‰çš„Webè¯·æ±‚éƒ½éœ€è¦é€šè¿‡å®ƒæ¥å¤„ç†ï¼Œè¿›è¡Œè½¬å‘ã€åŒ¹é…ã€æ•°æ®å¤„ç†åè¿”å›</p><h3 id="åˆå§‹åŒ–"><a class="header-anchor" href="#åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><ol><li>åœ¨Servletçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒServletçš„initæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼ŒDispatcherServletæ‰§è¡Œåˆå§‹åŒ–</li><li>DispatcherServletæŒæœ‰çš„IoCå®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåˆ›å»º<strong>DispatcherServlet</strong>æŒæœ‰çš„ä¸Šä¸‹æ–‡ï¼Œè¯¥ä¸Šä¸‹æ–‡æ˜¯webåº”ç”¨ä¸Šä¸‹æ–‡çš„å­ä¸‹æ–‡ï¼Œå› ä¸ºgetBeanæ–¹æ³•ä¼šå…ˆæ£€ç´¢çˆ¶ä¸Šä¸‹æ–‡å¯¹è±¡è·å–bean</li></ol><h3 id="Dispatcherè¿‡ç¨‹"><a class="header-anchor" href="#Dispatcherè¿‡ç¨‹"></a>Dispatcherè¿‡ç¨‹</h3><ul><li><p><strong>Dispatcher</strong>æ˜¯åˆ©ç”¨<strong>HandlerMapping</strong>å¯ä»¥æŒæœ‰ä¸€ç³»åˆ—ä»URLè¯·æ±‚åˆ°Controllerçš„æ˜ å°„ï¼Œé€šè¿‡URLè·¯å¾„åœ¨handleMapä¸­è·å–åˆ°handlerå¯¹è±¡</p></li><li><p>doDispatchæ–¹æ³•æ˜¯DispatcherServletå®ŒæˆDisp*atcherçš„ä¸»è¦æ–¹æ³•ï¼ŒåŒ…æ‹¬</p></li></ul><ol><li>å‡†å¤‡ModelAndView*</li><li>è°ƒç”¨getHandleræ¥å“åº”HTTPè¯·æ±‚</li><li>æ‰§è¡ŒHandlerçš„å¤„ç†æ¥å¾—åˆ°è¿”å›çš„ModelAndViewç»“æœï¼Œ</li><li>æœ€åæŠŠè¿™ä¸ªModelAndViewå¯¹è±¡äº¤ç»™ç›¸åº”çš„è§†å›¾å¯¹è±¡å»å‘ˆç°</li></ol><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><ol><li>é€šè¿‡<strong>ContextLoaderListener</strong>å®ç°servlertæ¥å£ï¼ŒåŠ è½½webApplicationContexï¼Œreflesh IOCå®¹å™¨</li><li>åˆå§‹åŒ–<strong>DispatcherServlet</strong>å¯¹è±¡ä½œä¸ºwebApplicationContexçš„å­å®¹å™¨</li><li>åˆå§‹åŒ–HandlerMappingå¾—åˆ°urlå¯¹åº”çš„handlerä¹‹é—´çš„æ˜ å°„å…³ç³»</li><li>é€šè¿‡servletæ‹¦æˆªè¯·æ±‚è½¬å‘åˆ°<strong>DispatcherServlet</strong>ä¸Šæ‰§è¡Œ**doDispatch()*<em>æ–¹æ³•<br>4.1. å‡†å¤‡ModelAndView</em><br>4.2. è°ƒç”¨getHandleræ¥å“åº”HTTPè¯·æ±‚<br>4.3. æ‰§è¡ŒHandlerçš„å¤„ç†æ¥å¾—åˆ°è¿”å›çš„ModelAndViewç»“æœï¼Œ<br>4.4. æœ€åæŠŠè¿™ä¸ªModelAndViewå¯¹è±¡äº¤ç»™ç›¸åº”çš„è§†å›¾å¯¹è±¡å»å‘ˆç°</li></ol><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><ul><li>SpringæŠ€æœ¯å†…å¹•â€”â€”æ·±å…¥è§£æSpringæ¶æ„ä¸è®¾è®¡åŸç†ï¼ˆç¬¬2ç‰ˆï¼‰</li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mvc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AOPæºä»£ç åˆ†æ</title>
      <link href="2018/03/10/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/5.AOP%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>2018/03/10/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/5.AOP%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>AOPæºä»£ç åˆ†æ</h1><p>é˜…è¯»springçš„æºä»£ç ï¼Œæ¥æŸ¥çœ‹springæ˜¯å¦‚ä½•å®ç°AOPå¢å¼ºçš„</p><h2 id="æ¢å¯»beanåˆå§‹åŒ–çš„æ–¹æ³•"><a class="header-anchor" href="#æ¢å¯»beanåˆå§‹åŒ–çš„æ–¹æ³•"></a>æ¢å¯»beanåˆå§‹åŒ–çš„æ–¹æ³•</h2><p>åœ¨æ™®é€šbeançš„åŠ è½½æµç¨‹ä¸­ï¼Œå¦‚æœä¸€ä¸ªbeanæ˜¯è¢«AOPæ‹¦æˆªå¢å¼ºå<strong>doCreateBean</strong>æ–¹æ³•è¿”å›çš„æ˜¯CGLibåŠ¨æ€ä»£ç†ç±»ç”Ÿæˆçš„å¯¹è±¡</p><blockquote><p>CGLibåŠ¨æ€ä»£ç†å¯¹è±¡</p></blockquote><p><img src="https://s1.ax1x.com/2020/03/11/8Ejz79.png" alt="8Ejz79.png"></p><blockquote><p>æœªè¢«AOPå¢å¼ºçš„å¯¹è±¡</p></blockquote><p><img src="https://s1.ax1x.com/2020/03/11/8EvDjU.png" alt="8EvDjU.png"></p><p>å¯ä»¥å¾—å‡ºç»“è®º,springæ˜¯åœ¨beançš„åˆ›å»ºæ—¶æœŸå¯¹beanå°±è¿›è¡Œäº†å¢å¼ºã€‚æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™é‡Œåˆ›å»ºå‡ºbeanå¯¹è±¡ï¼Œç»§ç»­å‘ä¸‹çœ‹ä»£ç ,<strong>initializeBean</strong>è¿™ä¸ªæ–¹æ³•å¯¹beanåˆ›å»ºåè¿›è¡Œäº†åç½®æ“ä½œåè¿”å›çš„æ˜¯CGLibåŠ¨æ€ä»£ç†åçš„å¯¹è±¡ã€‚è·Ÿè¸ªæ–¹æ³•åˆ°äº†<strong>applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)</strong>,åœ¨è¿™é‡Œå®Œæˆäº†åŠ¨æ€ä»£ç†ã€‚</p><p><strong>applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)<strong>æ–¹æ³•åˆ†æè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯æ‰§è¡Œ</strong>BeanPostProcessor.postProcessAfterInitialization</strong>è¿™ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­åœ¨åˆå§‹åŒ–æ—¶å€™ä¼šæ‰§è¡Œ<strong>AnnotationAwareAspectJAutoProxyCreator</strong>è¿™ä¸ªå®ç°ç±»</p><blockquote><p>ç±»å›¾</p></blockquote><p><img src="https://s1.ax1x.com/2020/03/11/8ViR1A.png" alt="8ViR1A.png"></p><p>ä»ç±»å›¾å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»çš„<strong>postProcessAfterInitialization</strong>æ–¹æ³•æ˜¯çˆ¶ç±»<strong>AbstractAutoProxyCreator</strong>çš„æ–¹æ³•</p><blockquote><p>postProcessAfterInitializationå®ç°</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>wrapIfNecessaryæ–¹æ³•</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Create proxy if we have advice.</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>wrapIfNecessaryæ–¹æ³•é¦–å…ˆè¿”å›äº†ç›®æ ‡å¯¹è±¡éœ€è¦å¢å¼ºçš„æ‹¦æˆªå™¨<br><img src="https://s1.ax1x.com/2020/03/11/8VkGRJ.png" alt="8VkGRJ.png"><br>å¦‚æœç›®æ ‡å¯¹è±¡æœ‰éœ€è¦å¢å¼ºçš„æ‹¦æˆªå™¨ï¼Œæ‰§è¡Œåˆ›å»ºproxyçš„ç¨‹åº</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors<span class="token punctuation">,</span> <span class="token class-name">TargetSource</span> targetSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AutoProxyUtils</span><span class="token punctuation">.</span><span class="token function">exposeTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>proxyFactory<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proxyFactory<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldProxyTargetClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>proxyFactory<span class="token punctuation">.</span><span class="token function">setProxyTargetClass</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">evaluateProxyInterfaces</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token class-name">Advisor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> <span class="token function">buildAdvisors</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>proxyFactory<span class="token punctuation">.</span><span class="token function">addAdvisors</span><span class="token punctuation">(</span>advisors<span class="token punctuation">)</span><span class="token punctuation">;</span>proxyFactory<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">customizeProxyFactory</span><span class="token punctuation">(</span>proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>proxyFactory<span class="token punctuation">.</span><span class="token function">setFrozen</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>freezeProxy<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">advisorsPreFiltered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>proxyFactory<span class="token punctuation">.</span><span class="token function">setPreFiltered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token function">getProxyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>æš´éœ²ç›®æ ‡çš„åŸå§‹å±æ€§</li><li>åˆ›å»ºProxyFactoryå¯¹è±¡</li><li>è·å–åˆ°ç›®æ ‡å¯¹è±¡çš„<strong>Advisor</strong></li><li>æœ€åä½¿ç”¨<strong>proxyFactory.getProxy</strong>æ¥è¿›è¡Œä¸€ä¸ªåˆå§‹åŒ–å·¥ä½œï¼Œåº•å±‚è°ƒç”¨JDKçš„åŠ¨æ€ä»£ç†æˆ–è€…æ˜¯CGLibçš„åŠ¨æ€ä»£ç†</li></ol><h2 id="AOPçš„åº•å±‚åŸç†"><a class="header-anchor" href="#AOPçš„åº•å±‚åŸç†"></a>AOPçš„åº•å±‚åŸç†</h2><p>é€šè¿‡JDKæˆ–è€…CGLibç”Ÿæˆä¸åŒçš„AopProxyå¯¹è±¡ï¼Œä»è€Œæ„é€ äº†ä¸åŒçš„å›è°ƒæ–¹æ³•æ¥å¯¹æ‹¦æˆªå™¨é“¾è¿›è¡Œè°ƒç”¨ã€‚<br>æ‹¦æˆªå™¨çš„è°ƒç”¨è°ƒç”¨çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨ReflectiveMethodInvocationä¸­é€šè¿‡proceedæ–¹æ³•å®ç°çš„ã€‚åœ¨proceedæ–¹æ³•ä¸­ï¼Œä¼šé€ä¸ªè¿è¡Œæ‹¦æˆªå™¨çš„æ‹¦æˆªæ–¹æ³•ã€‚åœ¨è¿è¡Œæ‹¦æˆªå™¨çš„æ‹¦æˆªæ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦å¯¹ä»£ç†æ–¹æ³•å®Œæˆä¸€ä¸ªåŒ¹é…åˆ¤æ–­ï¼Œé€šè¿‡è¿™ä¸ªåŒ¹é…åˆ¤æ–­æ¥å†³å®šæ‹¦æˆªå™¨æ˜¯å¦æ»¡è¶³åˆ‡é¢å¢å¼ºçš„è¦æ±‚ã€‚å¦‚æœæ–¹æ³•ç¬¦åˆè¦æ±‚è¿›è¡Œé€šçŸ¥å¢å¼ºï¼Œä¾æ¬¡è°ƒç”¨æ‹¦æˆªå™¨é“¾ä¸Šçš„æ‹¦æˆªå™¨ä¾æ¬¡ç›´åˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨è°ƒç”¨å®Œæ¯•æ‰§è¡Œç›®æ ‡æ–¹æ³•</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>springå®ç°AOPçš„æ–¹å¼æ˜¯åœ¨beanåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ª<strong>BeanPostProcessor</strong>æ¥å£çš„<strong>postProcessAfterInitialization</strong>æ–¹æ³•å¯¹beanè¿›è¡Œä¸€ä¸ªå¤„ç†ã€‚<strong>AbstractAutoProxyCreator</strong>æ˜¯å®é™…è¿›è¡Œaopæ‹¦æˆªå¢å¼ºçš„ç±»ï¼Œæ‰§è¡Œæ­¥éª¤ä¾æ¬¡æ˜¯<br>1.æš´éœ²ç›®æ ‡ç±»çš„åŸå§‹å±æ€§<br>2. åˆ›å»ºProxyFactoryå¯¹è±¡<br>3. è·å–åˆ°ç›®æ ‡å¯¹è±¡çš„<strong>Advisor</strong><br>4. ä½¿ç”¨JDKæˆ–CGLibç”Ÿæˆä»£ç†å¯¹è±¡</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AOPç®€å•ä½¿ç”¨</title>
      <link href="2018/03/10/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/4.AOP%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
      <url>2018/03/10/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/4.AOP%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1>AOPç®€å•ä½¿ç”¨</h1><h2 id="AOPæœ¯è¯­"><a class="header-anchor" href="#AOPæœ¯è¯­"></a>AOPæœ¯è¯­</h2><ul><li><strong>é€šçŸ¥(Advice)</strong></li></ul><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>å‰ç½®é€šçŸ¥</td><td>åœ¨ç›®æ ‡æ–¹æ³•è°ƒç”¨ä¹‹å‰æ‰§è¡Œé€šçŸ¥åŠŸèƒ½</td></tr><tr><td>åç½®é€šçŸ¥</td><td>åœ¨ç›®æ ‡æ–¹æ³•è°ƒç”¨ä¹‹åæ‰§è¡Œé€šçŸ¥åŠŸèƒ½</td></tr><tr><td>è¿”å›é€šçŸ¥</td><td>åœ¨ç›®æ ‡æˆåŠŸæ‰§è¡Œä¹‹åè°ƒç”¨é€šçŸ¥</td></tr><tr><td>å¼‚å¸¸é€šçŸ¥</td><td>åœ¨ç›®æ ‡è¿”å›æŠ›å‡ºå¼‚å¸¸åè°ƒç”¨é€šçŸ¥</td></tr><tr><td>ç¯ç»•é€šçŸ¥</td><td>é€šçŸ¥åŒ…è£¹è¢«é€šçŸ¥çš„æ–¹æ³•ï¼Œåœ¨è¢«é€šçŸ¥çš„æ–¹æ³•è°ƒç”¨ä¹‹å‰å’Œè°ƒç”¨ä¹‹åæ‰§è¡Œè‡ªå®šä¹‰çš„è¡Œä¸º</td></tr></tbody></table><ul><li><p><strong>è¿æ¥ç‚¹</strong><br>è¿æ¥ç‚¹æ˜¯åº”ç”¨æ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ’å…¥åˆ‡é¢çš„ä¸€ä¸ªç‚¹ã€‚åˆ‡é¢ä»£ç å¯ä»¥åˆ©ç”¨è¿™äº›ç‚¹å°†åˆ‡é¢æ’å…¥åˆ°æ­£å¸¸æµç¨‹ä¸­</p></li><li><p><strong>åˆ‡ç‚¹</strong><br>åˆ‡ç‚¹çš„å®šä¹‰ä¼šåŒ¹é…é€šçŸ¥æ‰€è¦ç»‡å…¥çš„ä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥ç‚¹ã€‚é€šå¸¸ç”¨æ˜ç¡®çš„ç±»æˆ–æ–¹æ³•åç§°æˆ–è€…æ˜¯æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰æ‰€åŒ¹é…çš„ç±»å’Œæ–¹æ³•æ¥æŒ‡å®šåˆ‡ç‚¹</p></li><li><p><strong>åˆ‡é¢</strong><br>åˆ‡é¢æ˜¯é€šçŸ¥å’Œåˆ‡ç‚¹çš„ç»“åˆã€‚é€šçŸ¥å’Œåˆ‡ç‚¹å®šä¹‰äº†åˆ‡é¢çš„å…¨éƒ¨å†…å®¹</p></li><li><p><strong>å¼•å…¥</strong><br>å¼•å…¥å…è®¸æˆ‘ä»¬å‘ç°æœ‰çš„ç±»æ·»åŠ æ–°æ–¹æ³•æˆ–å±æ€§</p></li><li><p><strong>ç»‡å…¥</strong><br>ç»‡å…¥æ˜¯æŠŠåˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚ç»‡å…¥å¯ä»¥åœ¨<strong>ç¼–è¯‘å™¨</strong>ã€<strong>ç±»åŠ è½½æœŸ</strong>ã€<strong>è¿è¡ŒæœŸ</strong></p></li></ul><h2 id="AOPç¤ºä¾‹"><a class="header-anchor" href="#AOPç¤ºä¾‹"></a>AOPç¤ºä¾‹</h2><blockquote><p>åˆ‡ç‚¹</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* com.example.springdemo.interfaces.impl.*.*(..))"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>å‰ç½®é€šçŸ¥</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"performance()"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">silenceCellPhones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Silencing cell phone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åç½®é€šçŸ¥</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"performance()"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">silenceCellPhones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Silencing cell phone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ç¯ç»•é€šçŸ¥</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"performance()"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aroundMethod</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ‰§è¡Œç›®æ ‡æ–¹æ³•</span>    joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è¿”å›é€šçŸ¥</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"performance()"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"CLAP CLAP CLAP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¼‚å¸¸é€šçŸ¥</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span><span class="token string">"performance()"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demandRefund</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Demanding a refund"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å¢å¼ºç±»å‹"><a class="header-anchor" href="#å¢å¼ºç±»å‹"></a>å¢å¼ºç±»å‹</h2><h3 id="å‰ç½®å¢å¼º"><a class="header-anchor" href="#å‰ç½®å¢å¼º"></a>å‰ç½®å¢å¼º</h3><ul><li>æ¥å£<strong>org.springframework.aop.MethodBeforeAdvice</strong></li></ul><h3 id="åç½®å¢å¼º"><a class="header-anchor" href="#åç½®å¢å¼º"></a>åç½®å¢å¼º</h3><ul><li>æ¥å£<strong>org.springframework.aop.AfterReturningAdvice</strong></li></ul><h3 id="ç¯ç»•å¢å¼º"><a class="header-anchor" href="#ç¯ç»•å¢å¼º"></a>ç¯ç»•å¢å¼º</h3><ul><li>æ¥å£<strong>org.springframework.aop.MethodMatcher</strong></li></ul><h3 id="å¼‚å¸¸å¢å¼º"><a class="header-anchor" href="#å¼‚å¸¸å¢å¼º"></a>å¼‚å¸¸å¢å¼º</h3><ul><li>æ¥å£<strong>org.springframework.aop.ThrowsAdvice</strong></li></ul><blockquote><p>Advice*Impl</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AfterAdviceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AfterReturningAdvice</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token class-name">Object</span> returnValue<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" æ‰§è¡Œåç½®å¢å¼º : "</span> <span class="token operator">+</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AroundAdviceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" around advice: before "</span> <span class="token operator">+</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> obj <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"around advice: after "</span> <span class="token operator">+</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeforeAdviceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MethodBeforeAdvice</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" æ‰§è¡Œå‰ç½®å¢å¼º : "</span> <span class="token operator">+</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionAdviceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ThrowsAdvice</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" throws exception, method="</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"throws exception, message="</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ServiceTest.java</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : execute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ‰§è¡Œä¸»å‡½æ•°</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdviceMainApp</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ProxyFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">addAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeforeAdviceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">addAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AroundAdviceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">addAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AfterAdviceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">addAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExceptionAdviceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ServiceTest</span> serviceTest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServiceTest</span><span class="token punctuation">)</span> factory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serviceTest<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ‰§è¡Œç»“æœ<br><img src="https://s2.ax1x.com/2020/03/11/8F5eDU.png" alt="8F5eDU.png"></p></blockquote><p>é€šè¿‡<strong>ProxyFactory</strong>é€šè¿‡<strong>setTarget()<strong>è®¾ç½®ç›®æ ‡å¯¹è±¡ï¼Œé€šè¿‡</strong>addAdvice</strong>æ·»åŠ å¢å¼ºå™¨å½¢æˆå¢å¼ºé“¾ï¼Œåœ¨ä»£ç†ç±»æ‰§è¡Œæ–¹æ³•æ—¶ä¼šæ‰§è¡Œå¢å¼ºå™¨</p><h2 id="åˆ‡ç‚¹è¡¨è¾¾å¼"><a class="header-anchor" href="#åˆ‡ç‚¹è¡¨è¾¾å¼"></a>åˆ‡ç‚¹è¡¨è¾¾å¼</h2><p>spring aopä¸­åªæ˜¯ç”¨åˆ°AspectJè¯­æ³•ä¸­çš„ä¸€ä¸ªå­é›†</p><h3 id="åˆ‡ç‚¹è¡¨è¾¾å¼å‡½æ•°"><a class="header-anchor" href="#åˆ‡ç‚¹è¡¨è¾¾å¼å‡½æ•°"></a>åˆ‡ç‚¹è¡¨è¾¾å¼å‡½æ•°</h3><table><thead><tr><th>ç±»å‹</th><th>å‡½æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æ–¹æ³•åˆ‡ç‚¹å‡½æ•°</td><td>execution()ï¼Œ@annotation()</td><td>é€šè¿‡æè¿°ç›®æ ‡æ–¹æ³•ä¿¡æ¯å®šä¹‰è¿æ¥ç‚¹</td></tr><tr><td>æ–¹æ³•å…¥å‚åˆ‡ç‚¹å‡½æ•°</td><td>args()ï¼Œ@args()</td><td>é€šè¿‡æè¿°ç›®æ ‡ç±»æ–¹æ³•å…¥å‚çš„ä¿¡æ¯å®šä¹‰è¿æ¥ç‚¹</td></tr><tr><td>ç›®æ ‡ç±»åˆ‡ç‚¹å‡½æ•°</td><td>within()ï¼Œtarget()ï¼Œ@within()ï¼Œ@target()</td><td>é€šè¿‡æè¿°ç›®æ ‡ç±»ç±»å‹ä¿¡æ¯å®šä¹‰è¿æ¥ç‚¹</td></tr><tr><td>ä»£ç†ç±»åˆ‡ç‚¹å‡½æ•°</td><td>this()</td><td>é€šè¿‡æè¿°ç›®æ ‡ç±»çš„ä»£ç†ç±»çš„ä¿¡æ¯å®šä¹‰è¿æ¥ç‚¹</td></tr></tbody></table><h3 id="å‡½æ•°è¯´æ˜"><a class="header-anchor" href="#å‡½æ•°è¯´æ˜"></a>å‡½æ•°è¯´æ˜</h3><table><thead><tr><th>å‡½æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>execution()</td><td>è¡¨ç¤ºæ»¡è¶³æŸä¸€åŒ¹é…æ¨¡å¼çš„æ‰€æœ‰ç›®æ ‡ç±»æ–¹æ³•è¿æ¥ç‚¹ï¼Œå¦‚execution(* handle(â€¦))è¡¨ç¤ºæ‰€æœ‰ç›®æ ‡ç±»ä¸­çš„handle()æ–¹æ³•</td></tr><tr><td>@annotation()</td><td>è¡¨ç¤ºæ ‡æ³¨äº†ç‰¹å®šæ³¨è§£çš„ç›®æ ‡æ–¹æ³•è¿æ¥ç‚¹ï¼Œå¦‚@annotation(com.aspectj.Authority)è¡¨ç¤ºä»»ä½•æ ‡æ³¨äº†@Authorityæ³¨è§£çš„ç›®æ ‡ç±»æ–¹æ³•</td></tr><tr><td>args()</td><td>é€šè¿‡åˆ¤åˆ«ç›®æ ‡ç±»æ–¹æ³•è¿è¡Œæ—¶å…¥å‚å¯¹è±¡çš„ç±»å‹å®šä¹‰æŒ‡å®šè¿æ¥ç‚¹ï¼Œå¦‚args(com.data.Car)è¡¨ç¤ºæ‰€æœ‰æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŒ‰ç±»å‹åŒ¹é…äºCarï¼ˆå«å­ç±»ï¼‰å…¥å‚çš„æ–¹æ³•</td></tr><tr><td>@args()</td><td>é€šè¿‡åˆ¤åˆ«ç›®æ ‡æ–¹æ³•è¿è¡Œæ—¶å…¥å‚å¯¹è±¡çš„ç±»æ˜¯å¦æ ‡æ³¨ç‰¹å®šæ³¨è§£æ¥åˆ¶å®šè¿æ¥ç‚¹ï¼Œå¦‚@args(com.aspectj.Authority)è¡¨ç¤ºä»»ä½•è¿™æ ·çš„ä¸€ä¸ªç›®æ ‡æ–¹æ³•ï¼šå®ƒæœ‰ä¸€ä¸ªå…¥å‚ä¸”å…¥å‚å¯¹è±¡çš„ç±»æ ‡æ³¨@Authorityæ³¨è§£ã€‚è¦ä½¿@args()ç”Ÿæ•ˆï¼Œç±»ç»§æ‰¿æ ‘ä¸­ï¼Œæ ‡æ³¨æ³¨è§£çš„ç±»ç±»å‹éœ€è¦ä¸é«˜äºå…¥å‚ç±»ç±»å‹</td></tr><tr><td>within</td><td>è¡¨ç¤ºç‰¹å®šåŸŸä¸‹çš„æ‰€æœ‰è¿æ¥ç‚¹ï¼Œå¦‚within(com.service.*)ï¼Œwithin(com.service.*Service)å’Œwithin(com.serviceâ€¦*)</td></tr><tr><td>target()</td><td>å‡å¦‚ç›®æ ‡æŒ‰ç±»å‹åŒ¹é…äºæŒ‡å®šç±»ï¼Œåˆ™ç›®æ ‡ç±»çš„æ‰€æœ‰è¿æ¥ç‚¹åŒ¹é…è¿™ä¸ªåˆ‡ç‚¹ã€‚å¦‚é€šè¿‡target(com.data.Car)å®šä¹‰çš„åˆ‡ç‚¹ï¼ŒCaråŠCarçš„å­ç±»ä¸­çš„æ‰€æœ‰è¿æ¥ç‚¹éƒ½åŒ¹é…è¯¥åˆ‡ç‚¹ï¼ŒåŒ…æ‹¬å­ç±»ä¸­æ‰©å±•çš„æ–¹æ³•</td></tr><tr><td>@within()</td><td>å‡å¦‚ç›®æ ‡ç±»æŒ‰ç±»å‹åŒ¹é…äºæŸä¸ªç±»Aï¼Œä¸”ç±»Aæ ‡æ³¨äº†ç‰¹å®šæ³¨è§£ï¼Œåˆ™ç›®æ ‡ç±»çš„æ‰€æœ‰è¿æ¥ç‚¹éƒ½åŒ¹é…äºè¿™ä¸ªåˆ‡ç‚¹ã€‚å¦‚@within(com.aspectj.Authority)å®šä¹‰çš„åˆ‡ç‚¹ï¼Œå‡å¦‚Carç±»æ ‡æ³¨äº†@Authorityæ³¨è§£ï¼Œåˆ™Carä»¥åŠCarçš„å­ç±»çš„æ‰€æœ‰è¿æ¥ç‚¹éƒ½åŒ¹é…ã€‚@withinæ ‡æ³¨æ¥å£ç±»æ— æ•ˆ</td></tr><tr><td>@target()</td><td>ç›®æ ‡ç±»æ ‡æ³¨äº†ç‰¹å®šæ³¨è§£ï¼Œåˆ™ç›®æ ‡ç±»ï¼ˆä¸åŒ…æ‹¬å­ç±»ï¼‰æ‰€æœ‰è¿æ¥ç‚¹éƒ½åŒ¹é…è¯¥åˆ‡ç‚¹ã€‚å¦‚é€šè¿‡@target(com.aspectj.Authority)å®šä¹‰çš„åˆ‡ç‚¹ï¼Œè‹¥BMWCaræ ‡æ³¨äº†@Authorityï¼Œåˆ™BMWCaræ‰€æœ‰è¿æ¥ç‚¹åŒ¹é…è¯¥åˆ‡ç‚¹</td></tr><tr><td>this()</td><td>ä»£ç†ç±»æŒ‰ç±»å‹åŒ¹é…äºæŒ‡å®šç±»ï¼Œåˆ™è¢«ä»£ç†çš„ç›®æ ‡ç±»æ‰€æœ‰è¿æ¥ç‚¹åŒ¹é…åˆ‡ç‚¹</td></tr><tr><td>bean(beanName)</td><td>è¿™ä¸ªæ˜¯Springç‰¹æœ‰çš„è¡¨ç¤ºbeanNameçš„bean</td></tr></tbody></table><h3 id="é€šé…ç¬¦"><a class="header-anchor" href="#é€šé…ç¬¦"></a>é€šé…ç¬¦</h3><table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>*</td><td>åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œä½†åªèƒ½åŒ¹é…ä¸Šä¸‹æ–‡ä¸­çš„ä¸€ä¸ªå…ƒç´ </td></tr><tr><td>â€¦</td><td>åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œå¯ä»¥åŒ¹é…ä¸Šä¸‹æ–‡ä¸­çš„å¤šä¸ªå…ƒç´ ã€‚è¡¨ç¤ºç±»æ—¶ï¼Œå’Œ*è”åˆä½¿ç”¨ï¼›è¡¨ç¤ºå…¥å‚æ—¶å•ç‹¬ä½¿ç”¨</td></tr><tr><td>+</td><td>æŒ‰ç±»å‹åŒ¹é…æŒ‡å®šç±»çš„æ‰€æœ‰ç±»ï¼ˆåŒ…æ‹¬å®ç°ç±»å’Œç»§æ‰¿ç±»ï¼‰ï¼Œå¿…é¡»è·Ÿåœ¨ç±»ååé¢</td></tr></tbody></table><ul><li>æ”¯æŒæ‰€æœ‰é€šé…ç¬¦ï¼šexecution()ï¼Œwithin()</li><li>ä»…æ”¯æŒ+é€šé…ç¬¦ï¼šargs()ï¼Œthis()ï¼Œtarget()</li><li>ä¸æ”¯æŒé€šé…ç¬¦ï¼š@argsï¼Œ@withinï¼Œ@targetï¼Œ@annotation</li></ul><h3 id="execution-è¯­æ³•"><a class="header-anchor" href="#execution-è¯­æ³•"></a>execution()è¯­æ³•</h3><ul><li>è¯­æ³•ï¼šexecution(&lt;ä¿®é¥°ç¬¦æ¨¡å¼&gt;? &lt;è¿”å›ç±»å‹æ¨¡å¼&gt; &lt;æ–¹æ³•åæ¨¡å¼&gt; (&lt;å‚æ•°æ¨¡å¼&gt;) &lt;å¼‚å¸¸æ¨¡å¼&gt;?)</li></ul><h4 id="é€šè¿‡æ–¹æ³•ç­¾åå®šä¹‰åˆ‡ç‚¹"><a class="header-anchor" href="#é€šè¿‡æ–¹æ³•ç­¾åå®šä¹‰åˆ‡ç‚¹"></a>é€šè¿‡æ–¹æ³•ç­¾åå®šä¹‰åˆ‡ç‚¹</h4><ul><li>execution(pulic * *(â€¦))ï¼šåŒ¹é…ç›®æ ‡ç±»çš„publicæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ª*ä»£è¡¨è¿”å›ç±»å‹ï¼Œç¬¬äºŒä¸ª*ä»£è¡¨æ–¹æ³•åï¼Œâ€¦ä»£è¡¨ä»»æ„å…¥å‚</li><li>execution(* *To(â€¦))ï¼šåŒ¹é…ç›®æ ‡ç±»æ‰€æœ‰ä»¥Toç»“å°¾çš„æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ª*ä»£è¡¨è¿”å›ç±»å‹ï¼Œ*Toä»£è¡¨ä»»æ„ä»¥Toç»“å°¾çš„æ–¹æ³•</li></ul><h4 id="é€šè¿‡ç±»å®šä¹‰åˆ‡ç‚¹"><a class="header-anchor" href="#é€šè¿‡ç±»å®šä¹‰åˆ‡ç‚¹"></a>é€šè¿‡ç±»å®šä¹‰åˆ‡ç‚¹</h4><ul><li>execution(* com.data.User.*(â€¦))ï¼šåŒ¹é…Useræ¥å£çš„æ‰€æœ‰æ–¹æ³•</li><li>execution(* com.data.User+.*(â€¦))ï¼šåŒ¹é…Useræ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¶å®ç°ç±»ä¸­ä¸åœ¨Useræ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•</li></ul><h4 id="é€šè¿‡ç±»åŒ…å®šä¹‰åˆ‡ç‚¹"><a class="header-anchor" href="#é€šè¿‡ç±»åŒ…å®šä¹‰åˆ‡ç‚¹"></a>é€šè¿‡ç±»åŒ…å®šä¹‰åˆ‡ç‚¹</h4><ul><li>execution(* com.data.*(â€¦))ï¼šåŒ¹é…dataåŒ…ä¸‹æ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•</li><li>execution(* com.data.Userâ€¦*(â€¦))ï¼šåŒ¹é…dataåŒ…åŠå…¶å­å­™åŒ…ä¸­çš„æ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•</li><li>execution(* comâ€¦*Manager.get*(â€¦))ï¼šåŒ¹é…comåŒ…åŠå…¶å­å­™åŒ…ä¸­åç¼€ä¸ºManagerçš„ç±»é‡Œä»¥getå¼€å¤´çš„æ–¹æ³•</li></ul><h4 id="é€šè¿‡æ–¹æ³•å…¥å‚å®šä¹‰åˆ‡ç‚¹"><a class="header-anchor" href="#é€šè¿‡æ–¹æ³•å…¥å‚å®šä¹‰åˆ‡ç‚¹"></a>é€šè¿‡æ–¹æ³•å…¥å‚å®šä¹‰åˆ‡ç‚¹</h4><ul><li>execution(* get(String, int))ï¼šåŒ¹é…get(String, int)æ–¹æ³•</li><li>execution(* get(String, *))ï¼šåŒ¹é…åä¸ºgetä¸”ç¬¬ä¸€ä¸ªå…¥å‚ç±»å‹ä¸ºStringã€ç¬¬äºŒä¸ªå…¥å‚ç±»å‹ä»»æ„çš„æ–¹æ³•</li><li>execution(* get(String, â€¦))ï¼šåŒ¹é…åä¸ºgetä¸”ç¬¬ä¸€ä¸ªå…¥å‚ä¸ºStringç±»å‹çš„æ–¹æ³•</li><li>execution(* get(Object+))ï¼šåŒ¹é…åä¸ºgetä¸”å”¯ä¸€å…¥å‚æ˜¯Objectæˆ–å…¶å­ç±»çš„æ–¹æ³•</li></ul><h3 id="é€»è¾‘è¿ç®—ç¬¦"><a class="header-anchor" href="#é€»è¾‘è¿ç®—ç¬¦"></a>é€»è¾‘è¿ç®—ç¬¦</h3><ul><li>ä¸&amp;&amp;ï¼Œæˆ–||ï¼Œé!</li></ul><h3 id="ç»‡å…¥é¡ºåº"><a class="header-anchor" href="#ç»‡å…¥é¡ºåº"></a>ç»‡å…¥é¡ºåº</h3><ul><li>å¦‚æœå¢å¼ºåœ¨åŒä¸€ä¸ªåˆ‡é¢ç±»ä¸­å£°æ˜ï¼Œåˆ™ä¾ç…§å¢å¼ºåœ¨åˆ‡é¢ç±»ä¸­å®šä¹‰çš„é¡ºåºç»‡å…¥</li><li>å¦‚æœå¢å¼ºä½äºä¸åŒçš„å¢å¼ºç±»ä¸­ï¼Œä¸”éƒ½å®ç°äº†org.springframework.core.Orderedæ¥å£ï¼Œåˆ™ç”±æ¥å£æ–¹æ³•çš„é¡ºåºå·å†³å®šï¼ˆé¡ºåºå·å°çš„å…ˆç»‡å…¥ï¼‰</li><li>å¦‚æœå¢å¼ºä½äºä¸åŒçš„å¢å¼ºç±»ä¸­ï¼Œä¸”æ²¡æœ‰å®ç°org.springframework.core.Orderedæ¥å£ï¼Œç»‡å…¥é¡ºåºä¸ç¡®å®š</li></ul><h3 id="è·å–è¿æ¥ç‚¹ä¿¡æ¯"><a class="header-anchor" href="#è·å–è¿æ¥ç‚¹ä¿¡æ¯"></a>è·å–è¿æ¥ç‚¹ä¿¡æ¯</h3><ul><li>**args()<strong>ç”¨äºç»‘å®šè¿æ¥ç‚¹æ–¹æ³•çš„å…¥å‚ï¼Œ</strong>@annotation()<strong>ç”¨äºç»‘å®šè¿æ¥ç‚¹æ–¹æ³•çš„æ³¨è§£å¯¹è±¡ï¼Œ</strong>@args()**ç”¨äºç»‘å®šè¿æ¥ç‚¹æ–¹æ³•çš„å…¥å‚æ³¨è§£ã€‚ä¸‹ä¾‹è¡¨ç¤ºæ–¹æ³•å…¥å‚ä¸º(String, int, â€¦)çš„æ–¹æ³•åŒ¹é…è¯¥åˆ‡ç‚¹ï¼Œå¹¶å°†nameå’Œageä¸¤ä¸ªå‚æ•°ç»‘å®šåˆ°åˆ‡é¢æ–¹æ³•çš„å…¥å‚ä¸­</li><li>AspectJä½¿ç”¨org.aspectj.lang.<strong>JointPoint</strong>æ¥å£è¡¨ç¤ºç›®æ ‡ç±»è¿æ¥ç‚¹å¯¹è±¡ã€‚å¦‚æœæ˜¯ç¯ç»•å¢å¼ºæ—¶ï¼Œä½¿ç”¨org.aspectj.lang.<strong>ProceedingJointPoint</strong>è¡¨ç¤ºè¿æ¥ç‚¹å¯¹è±¡ï¼Œè¯¥ç±»æ˜¯JointPointæ¥å£çš„å­æ¥å£ã€‚ä»»ä½•ä¸€ä¸ªå¢å¼ºæ–¹æ³•éƒ½å¯ä»¥é€šè¿‡å°†ç¬¬ä¸€ä¸ªå…¥å‚å£°æ˜ä¸ºJointPointè®¿é—®åˆ°è¿æ¥ç‚¹ä¸Šä¸‹æ–‡çš„ä¿¡æ¯</li><li>ä½¿ç”¨**this()<strong>æˆ–</strong>target()**å¯ä»¥ç»‘å®šè¢«ä»£ç†å¯¹è±¡çš„å®ä¾‹ã€‚ä¸‹ä¾‹è¡¨ç¤ºä»£ç†å¯¹è±¡ä¸ºUserç±»çš„æ‰€æœ‰æ–¹æ³•åŒ¹é…è¯¥åˆ‡ç‚¹ï¼Œä¸”ä»£ç†å¯¹è±¡ç»‘å®šåˆ°userå…¥å‚ä¸­</li><li>**@within()**å’Œ__@target()__å‡½æ•°å¯ä»¥å°†ç›®æ ‡ç±»çš„æ³¨è§£å¯¹è±¡ç»‘å®šåˆ°å¢å¼ºæ–¹æ³•ä¸­</li><li>é€šè¿‡<strong>returning</strong>ç»‘å®šè¿æ¥ç‚¹æ–¹æ³•çš„è¿”å›å€¼</li><li>ä½¿ç”¨<strong>AfterThrowing</strong>æ³¨è§£çš„<strong>throwing</strong>æˆå‘˜ç»‘å®š</li></ul><h2 id="åŠ¨æ€ä»£ç†çš„ä¸¤ç§æ–¹å¼"><a class="header-anchor" href="#åŠ¨æ€ä»£ç†çš„ä¸¤ç§æ–¹å¼"></a>åŠ¨æ€ä»£ç†çš„ä¸¤ç§æ–¹å¼</h2><ul><li><p>JDKä¸­çš„åŠ¨æ€ä»£ç†æ˜¯åŠ¨æ€åˆ›å»ºä¸€ä¸ªå…·æœ‰æŸç§æ¥å£èƒ½åŠ›çš„ä»£ç†å¯¹è±¡ã€‚è¿™æ ·å°±å¿…é¡»è¦æœ‰Interfaceå¹¶ä¸”æ–¹æ³•å¿…é¡»æ˜¯<strong>public</strong>å’Œ<strong>public final</strong>çš„</p></li><li><p>CGLibé‡‡ç”¨çš„æ˜¯åº•å±‚çš„å­—èŠ‚ç æŠ€æœ¯ï¼Œé€šè¿‡å­ç±»å»æ‹¦æˆªçˆ¶ç±»çš„æ–¹æ³•ï¼Œç»‡å…¥æ¨ªåˆ‡é€»è¾‘ï¼›ä¸èƒ½ä»£ç†<strong>final</strong>å’Œ<strong>private</strong></p></li><li><p>æ¼”ç¤ºä»£ç </p></li><li><p>TargetService.java</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">TargetService</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>TargetServiceImpl.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TargetServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TargetService</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>CglibProxy.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CglibProxy</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : before execute"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> obj <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>objects<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : before after"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>JdkProxy.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdkProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Object</span> targer<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">JdkProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> targer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>targer <span class="token operator">=</span> targer<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : before execute"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> obj <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>targer<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : before after"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>MainApp.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainApp</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//JDK proxy</span>        <span class="token class-name">TargetServiceImpl</span> jdkService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TargetServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">JdkProxy</span> jdkProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdkProxy</span><span class="token punctuation">(</span>jdkService<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TargetService</span> jdkServiceProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TargetService</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>jdkService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>jdkService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>jdkProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>        jdkServiceProxy<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">"jdk åŠ¨æ€ä»£ç†"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//CGLib proxy</span>        <span class="token class-name">CglibProxy</span> cglibProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TargetService</span> cglibServiceProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TargetService</span><span class="token punctuation">)</span> cglibProxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">TargetServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cglibServiceProxy<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">"CGLib åŠ¨æ€ä»£ç†"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è¿è¡Œç»“æœ</li></ul><p><img src="https://s2.ax1x.com/2020/03/10/8Fdk5Q.png" alt="8Fdk5Q.png"></p><p>ä»ç»“æœå¯ä»¥çœ‹å‡ºCGLibæ˜¯ç”ŸæˆåŠ¨æ€ä»£ç†çš„å†…éƒ¨ç±»è¿›è¡Œæ–¹æ³•çš„æ‹¦æˆªï¼Œä»è€Œè¾¾åˆ°å¢å¼ºçš„ç›®çš„ã€‚jdkçš„åŠ¨æ€ä»£ç†æ˜¯ä¼ å…¥ç›®æ ‡ç±»å¯¹è±¡é€šè¿‡åå°„å»æ‰§è¡Œç›®æ ‡ç±»å¯¹è±¡çš„æ–¹æ³•ä»è€Œåˆ°è¾¾æ‰§è¡Œå¢å¼ºçš„ç›®çš„ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><ul><li><a href="https://segmentfault.com/a/1190000008283874">Learn Spring - Spring AOP</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>finishBeanFactoryInitializationåŠ è½½beanæµç¨‹</title>
      <link href="2018/03/07/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/3.finishBeanFactoryInitialization%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/"/>
      <url>2018/03/07/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/3.finishBeanFactoryInitialization%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1>finishBeanFactoryInitializationåŠ è½½æµç¨‹</h1><h2 id="finishBeanFactoryInitializationå…¥å£æ–¹æ³•"><a class="header-anchor" href="#finishBeanFactoryInitializationå…¥å£æ–¹æ³•"></a>finishBeanFactoryInitializationå…¥å£æ–¹æ³•</h2><h3 id="ä»£ç å±•ç¤º"><a class="header-anchor" href="#ä»£ç å±•ç¤º"></a>ä»£ç å±•ç¤º</h3><p><strong>finishBeanFactoryInitialization</strong>æ˜¯åŠ è½½æ™®é€šçš„spring beanæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åœ¨contextä¸­é€šè¿‡beanFactoryå®Œæˆå¯¹beançš„åˆå§‹åŒ–, * å°†ä¼šåˆå§‹åŒ–å‰©ä½™çš„å…¨éƒ¨ä½œç”¨åŸŸä¸ºå•åˆ—çš„bean. */</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// è®¾ç½®æ˜¯å¦æœ‰åç§°è½¬æ¢æœåŠ¡.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>CONVERSION_SERVICE_BEAN_NAME<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>CONVERSION_SERVICE_BEAN_NAME<span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">setConversionService</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>CONVERSION_SERVICE_BEAN_NAME<span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ²¡æœ‰beançš„åç½®å¤„ç†å™¨å°±æ³¨å†Œé»˜è®¤çš„æ’å€¼è§£æå™¨</span><span class="token comment">// ï¼ˆä¾‹å¦‚PropertyPlaceholderConfigurer beanï¼‰ä¹‹å‰æ³¨å†Œè¿‡çš„ä»»ä½•ä¸œè¥¿ï¼š</span><span class="token comment">// æ­¤æ—¶ï¼Œä¸»è¦ç”¨äºæ³¨é‡Šå±æ€§å€¼çš„è§£æ.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">hasEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addEmbeddedValueResolver</span><span class="token punctuation">(</span>strVal <span class="token operator">-></span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>strVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ³¨å†ŒLoadTimeWeaverAwareçš„å¤„ç†.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weaverAwareNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">LoadTimeWeaverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> weaverAwareName <span class="token operator">:</span> weaverAwareNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getBean</span><span class="token punctuation">(</span>weaverAwareName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// åœæ­¢ä½¿ç”¨ä¸´æ—¶ClassLoaderè¿›è¡Œç±»å‹åŒ¹é….</span>beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å…è®¸ç¼“å­˜æ‰€æœ‰beanå®šä¹‰å…ƒæ•°æ®ï¼Œä¸å¸Œæœ›æœ‰è¿›ä¸€æ­¥çš„æ›´æ”¹.</span>beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¼€å§‹å®åˆ—åŒ–å‰©ä¸‹çš„æ‡’åŠ è½½bean.</span>beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><p>å¯ä»¥çœ‹å‡ºåœ¨è¿™æ®µä»£ç çš„å‰å¤§éƒ¨åˆ†è¿˜æ˜¯å¯¹beanFactoryåœ¨è¿›è¡Œåˆå§‹åŒ–beanä¹‹å‰ï¼Œå¯¹beanFactoryè¿›è¡Œæ ‡è®°å¤„ç†ã€‚æœ€åä¸€è¡Œçš„<strong>beanFactory.preInstantiateSingletons()<strong>æ‰æ˜¯å¼€å§‹è¿›è¡Œbeançš„åŠ è½½,ç»§ç»­æŸ¥çœ‹ä»£ç ,è¿™é‡Œå®é™…ä¸Šè°ƒç”¨äº†</strong>DefaultListableBeanFactory.preInstantiateSingletons()</strong></p><h2 id="preInstantiateSingletonsæ–¹æ³•"><a class="header-anchor" href="#preInstantiateSingletonsæ–¹æ³•"></a>preInstantiateSingletonsæ–¹æ³•</h2><h3 id="ä»£ç å±•ç¤º-v2"><a class="header-anchor" href="#ä»£ç å±•ç¤º-v2"></a>ä»£ç å±•ç¤º</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Pre-instantiating singletons in "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// åˆ›å»ºBeanDefinitionçš„å‰¯æœ¬ï¼Œä¸€æ¬¡è¿›è¡Œæ³¨å†Œ.</span><span class="token comment">// å°½ç®¡è¿™ä¸æ˜¯ä¸€äº›factory beançš„åˆå§‹åŒ–æ–¹å¼ï¼Œä½†æ˜¯è¿™ä¹Ÿæ˜¯æ­£å¸¸çš„</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¿›è¡Œæ‰€ä»¥éæ‡’åŠ è½½beançš„åˆå§‹åŒ–...</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span>FACTORY_BEAN_PREFIX <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">final</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span><span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>isEagerInit <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">isEagerInit</span><span class="token punctuation">,</span><span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“-v2"><a class="header-anchor" href="#æ€»ç»“-v2"></a>æ€»ç»“</h3><p>åˆ†æä»£ç å¯ä»¥çœ‹åˆ°<strong>preInstantiateSingletons</strong>ä¸»è¦æ˜¯è·å–beanNameå’Œ<strong>RootBeanDefinition</strong>,ç„¶åæ ¹æ®<strong>BeanDefinition</strong>æ˜¯å¦æ˜¯<strong>å»¶è¿ŸåŠ è½½</strong>ã€<strong>å•åˆ—</strong>è¿›è¡Œåˆå§‹åŒ–ã€‚ç„¶åè°ƒç”¨<strong>getBean(String name)</strong>,å¯¹äºå·¥å‚ç±»è¿™é‡Œä¼šåŠ ä¸Šå‰ç¼€â€™&amp;'è¿™æ ·è·å–åˆ°çš„å°±æ˜¯BeanFactoryè€Œä¸æ˜¯bean;</p><h2 id="getBean-String-name"><a class="header-anchor" href="#getBean-String-name"></a>getBean(String name)</h2><h3 id="ä»£ç å±•ç¤º-v3"><a class="header-anchor" href="#ä»£ç å±•ç¤º-v3"></a>ä»£ç å±•ç¤º</h3><ul><li>getBean(String name)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>AbstractBeanFactory.doGetBean(name, null, null, false)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> requiredType<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//è¿›è¡Œbeançš„åç§°è½¬æ¢</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Object</span> bean<span class="token punctuation">;</span><span class="token comment">// æ£€æŸ¥Beanæ˜¯å¦å·²ç»è¿›è¡Œæ‰‹åŠ¨æ³¨å†Œè¿‡ï¼Œå¦‚æœæ³¨å†Œè¿‡å°±è¿›è¡Œè¿”å›.</span><span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning eagerly cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// åˆå§‹åŒ–å·²ç»åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„beanä¼šæŠ›å‡ºå¼‚å¸¸:</span><span class="token comment">// é€šè¿‡å¾ªç¯çš„æ–¹å¼å»åˆ¤æ–­.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ£€æŸ¥beanFactoryå·¥å‚ä¸­æ˜¯å¦æœ‰BeanDefinitionçš„å®šä¹‰.</span><span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Not found -> check parent.</span><span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å°†å‚æ•°ä¼ é€’ç»™çˆ¶ç±».</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// No args -> delegate to standard getBean method.</span><span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ç¡®ä¿ä¾èµ–beançš„åˆå§‹.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Circular depends-on relationship between '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"'"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' depends on missing bean '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// åˆ›å»ºbeanå®ä¾‹.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å‡ºç°å¼‚å¸¸è¦é¢„å…ˆç§»é™¤bean</span><span class="token comment">// å› ä¸ºåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¸ºè§£å†³å¾ªç¯å¼•ç”¨ä¾èµ–æå‰å°†beanåŠ è½½</span>             <span class="token comment">// åˆ é™¤æ‰æ‰€ä»¥çš„ä¸´æ—¶å¼•ç”¨.</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å¦‚æœæ˜¯åŸå‹æ¨¡å¼å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹.</span><span class="token class-name">Object</span> prototypeInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">final</span> <span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Scope '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"' is not active for the current thread; consider "</span> <span class="token operator">+</span><span class="token string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="token punctuation">,</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ£€æŸ¥æ‰€éœ€ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é….</span><span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">T</span> convertedBean <span class="token operator">=</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>convertedBean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> convertedBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Failed to convert bean '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' to required type '"</span> <span class="token operator">+</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“-v3"><a class="header-anchor" href="#æ€»ç»“-v3"></a>æ€»ç»“</h3><ol><li>åˆ¤æ–­æ˜¯å¦åˆ›å»ºè¿‡æˆ–è€…æ­£åœ¨åˆ›å»ºä¸­</li><li>æ ¹æ®åç§°æ£€æŸ¥å½“å‰beanFactoryæ˜¯å¦æœ‰BeanDefinitionçš„å®šä¹‰ï¼Œæ²¡æœ‰å°±æ£€æŸ¥çˆ¶ç±»</li><li>è¿›è¡Œbeanä¾èµ–çš„åŠ è½½</li><li>å¯¹å•åˆ—beanè¿›è¡Œåˆ›å»º</li><li>å¯¹åŸå‹beanè¿›è¡Œåˆ›å»º</li><li>æ£€æŸ¥è¿”å›çš„beanç±»å‹æ˜¯å¦ç¬¦åˆé¢„æœŸ<br>åœ¨è¿™æ®µä»£ç ä¸­ä¸»è¦æ˜¯å¯¹beanåˆ›å»ºå‰è¿›è¡Œæœ€åä¸€æ¬¡æ£€æŸ¥å·²ç»æ¶ˆé™¤å¾ªç¯ä¾èµ–çš„é€»è¾‘ï¼Œä¸ç®¡æ˜¯åŸå‹æ¨¡å¼è¿˜æ˜¯å•åˆ—æ¨¡å¼æœ€åä»£ç éƒ½æ˜¯è°ƒç”¨çš„**AbstractBeanFactory.createBean(String name)**çš„æ–¹æ³•è¿›è¡Œçš„åˆ›å»º</li></ol><p>**registerDependentBean(dep, beanName);**è¿™ä¸ªæ–¹æ³•ä¼šè§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œå¦‚æœA-&gt;Bï¼ŒB-&gt;A,å½“Aè¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æŸ¥è¯¢åˆ°Aä¾èµ–äº†B,ç„¶åè¿›è¡Œä¾èµ–çš„æš‚æ—¶è§£é™¤ï¼Œè¿™ä¸ªæ—¶å€™æ‰ä¼šå¯¹Bè¿›è¡ŒgetBean(B)çš„æ–¹æ³•ã€‚</p><h2 id="createBean"><a class="header-anchor" href="#createBean"></a>createBean()</h2><h3 id="ä»£ç å±•ç¤º-v4"><a class="header-anchor" href="#ä»£ç å±•ç¤º-v4"></a>ä»£ç å±•ç¤º</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span><span class="token comment">// ç¡®ä¿æ­¤æ—¶ç¡®å®è§£æäº†BeanDefiniton</span>   <span class="token comment">//å¹¶ä¸”åœ¨æ— æ³•åŠ¨æ€å­˜å‚¨çš„classã€åˆå¹¶BeanDefinition</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å‡†å¤‡è¦†ç›–æ–¹æ³•.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>beanName<span class="token punctuation">,</span> <span class="token string">"Validation of method overrides failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// ç»™BeanPostProcessorä¸€ä¸ªè¿”å›ä»£ç†è€Œä¸æ˜¯å®ä¾‹çš„æœºä¼š</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"BeanPostProcessor before instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Finished creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> <span class="token class-name">ImplicitlyAppearedSingletonException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// A previously detected exception with proper bean creation context already,</span><span class="token comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Unexpected exception during bean creation"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“-v4"><a class="header-anchor" href="#æ€»ç»“-v4"></a>æ€»ç»“</h2><p>åœ¨<strong>CreateBean()<strong>æ–¹æ³•ä¸­ï¼Œå‰é¢ä¸»è¦æ˜¯å¯¹beanDefinitionçš„æ£€æŸ¥ã€‚æ£€æŸ¥å®Œæ¯•ä¹‹åè°ƒç”¨ä¸¤ä¸ªæ–¹æ³•</strong>resolveBeforeInstantiation</strong>ã€<strong>doCreate()</strong></p><h2 id="resolveBeforeInstantiationæ–¹æ³•"><a class="header-anchor" href="#resolveBeforeInstantiationæ–¹æ³•"></a>resolveBeforeInstantiationæ–¹æ³•</h2><ul><li><p><strong>resolveBeforeInstantiation</strong>æ˜¯è°ƒç”¨<strong>InstantiationAwareBeanPostProcessor</strong>å­ç±»å°è¯•è¿”å›bean</p></li><li><p>ä»£ç å±•ç¤º</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Nullable</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token class-name">Object</span> result <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¼”ç¤ºç»“æœ<br><img src="https://s2.ax1x.com/2020/03/07/3XclJx.png" alt="3XclJx.png"></li></ul><h2 id="doCreateæ–¹æ³•"><a class="header-anchor" href="#doCreateæ–¹æ³•"></a>doCreateæ–¹æ³•</h2><h3 id="ä»£ç å±•ç¤º-v5"><a class="header-anchor" href="#ä»£ç å±•ç¤º-v5"></a>ä»£ç å±•ç¤º</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Instantiate the bean.</span><span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">final</span> <span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Allow post-processors to modify the merged bean definition.</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Eagerly cache singletons to be able to resolve circular references</span><span class="token comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Initialize the bean instance.</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Initialization of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' has been injected into other beans ["</span> <span class="token operator">+</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="token operator">+</span><span class="token string">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="token operator">+</span><span class="token string">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="token operator">+</span><span class="token string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Register bean as disposable.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ"></a>åˆ†æ</h3><p><strong>doCreateBean</strong>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><ol><li>createBeanInstance(beanName, mbd, args)</li><li>applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName)</li><li>populateBean(beanName, mbd, instanceWrapper)</li><li>initializeBean(beanName, exposedObject, mbd)</li></ol><h4 id="createBeanInstance"><a class="header-anchor" href="#createBeanInstance"></a>createBeanInstance</h4><p><strong>createBeanInstance</strong> -&gt; <strong>instantiateBean(beanName, mbd)</strong> -&gt; <strong>getInstantiationStrategy().instantiate(mbd, beanName, parent)</strong> -&gt; <strong>BeanUtils.instantiateClass(constructorToUse)</strong> -&gt;<strong>ctor.newInstance(argsWithDefaultValues)</strong><br>é€šè¿‡**class.newInstance()**å¯ä»¥çœ‹å‡ºè¿™é‡Œç”¨åå°„è°ƒç”¨æ„é€ å‡½æ•°ä»è€Œæ„é€ å¥½ä¸€ä¸ªbean</p><h4 id="applyMergedBeanDefinitionPostProcessorsè¿™é‡Œæ˜¯è°ƒç”¨MergedBeanDefinitionPostProcessorsçš„å­ç±»æ‰§è¡Œ"><a class="header-anchor" href="#applyMergedBeanDefinitionPostProcessorsè¿™é‡Œæ˜¯è°ƒç”¨MergedBeanDefinitionPostProcessorsçš„å­ç±»æ‰§è¡Œ"></a>applyMergedBeanDefinitionPostProcessorsè¿™é‡Œæ˜¯è°ƒç”¨MergedBeanDefinitionPostProcessorsçš„å­ç±»æ‰§è¡Œ</h4><h4 id="populateBean"><a class="header-anchor" href="#populateBean"></a>populateBean</h4><ul><li>ä»£ç å±•ç¤º</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//çœç•¥ä»£ç ...</span><span class="token comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token comment">//çœç•¥ä»£ç ...</span><span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span>DEPENDENCY_CHECK_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//çœç•¥ä»£ç ...</span>  <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>populateBean</strong>æ–¹æ³•ä¸»è¦æ˜¯æ‰§è¡ŒInstantiationAwareBeanPostProcessoræ¥å£ä¸‹çš„<strong>postProcessAfterInstantiation</strong>ã€<strong>getBeanPostProcessors</strong></p><h4 id="initializeBean"><a class="header-anchor" href="#initializeBean"></a>initializeBean</h4><ul><li>ä»£ç å±•ç¤º</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//çœç•¥ä»£ç ...</span>wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥ä»£ç ...</span>      <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> wrappedBean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥ä»£ç ...</span>      wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦æœ‰ï¼š</p><ol><li><strong>invokeAwareMethods</strong>çš„ä½œç”¨æ˜¯å¦‚æœbeanç»§æ‰¿äº†Awareæ¥å£ï¼Œåœ¨èµ‹å€¼æ“ä½œä¹‹å‰æ‰§è¡ŒAwareæ¥å£ä¸­çš„æ–¹æ³•<br>i. BeanNameAware<br>ii. BeanClassLoaderAware<br>iii. BeanFactoryAware</li><li><strong>applyBeanPostProcessorsBeforeInitialization</strong>æ‰§è¡Œ<strong>BeanPostProcessors</strong>æ¥å£ä¸‹beforeçš„æ–¹æ³•</li><li><strong>invokeInitMethods</strong>æ˜¯æ‰§è¡ŒæŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•</li><li><strong>applyBeanPostProcessorsAfterInitialization</strong>æ‰§è¡Œ<strong>BeanPostProcessors</strong>æ¥å£ä¸‹çš„afteræ–¹æ³•</li></ol><h2 id="æµç¨‹å›¾"><a class="header-anchor" href="#æµç¨‹å›¾"></a>æµç¨‹å›¾</h2><p><img src="https://s2.ax1x.com/2020/03/07/3XXbuQ.png" alt="3XXbuQ.png"></p><h2 id="æ€»ç»“ï¼š"><a class="header-anchor" href="#æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><ol><li><strong>refresh()<strong>ä¸­åŠ è½½å®Œæˆspringçš„ç»„ä»¶åï¼Œæ‰§è¡ŒåŠ è½½æ™®é€šbeanæ–¹æ³•ï¼Œå…¥å£æ˜¯</strong>finishBeanFactoryInitialization</strong>ã€‚</li><li><strong>finishBeanFactoryInitialization</strong>ä¸­ä¸»è¦çš„å·¥ä½œåˆ†ä¸ºä¸¤ç±»ï¼š<ol><li>æ£€æŸ¥ç¯å¢ƒå’Œæ£€æŸ¥BeanDefiniation</li><li>åŠ è½½beanã€‚è°ƒç”¨çš„æ–¹æ³•æ˜¯**getBean()**æ–¹æ³•ï¼Œ**getBean()**æ–¹æ³•è°ƒç”¨çš„æœ‰æ˜¯doGetBean()æ–¹æ³•</li></ol></li><li>**doGetBean()**æ–¹æ³•ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š<ol><li>é€šè¿‡<strong>registerDependentBean</strong>è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜</li><li>è°ƒç”¨**AbstractBeanFactory.createBean(String name)**åŠ è½½bean</li></ol></li><li>**AbstractBeanFactory.createBean(String name)**ä¸»è¦æ˜¯ä¾èµ–ä¸¤ä¸ªæ–¹æ³•ï¼š<ol><li>resolveBeforeInstantiationæ–¹æ³•é€šè¿‡è¿™ä¸ªæ–¹æ³•å°è¯•ç”¨<strong>InstantiationAwareBeanPostProcessor</strong>æ¥å£è¿”å›bean</li><li>å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰è¿”å›beanï¼Œå°±è°ƒç”¨**doCreate()**æ–¹æ³•</li></ol></li><li>**doCreate()**å†…éƒ¨ä¸»è¦æœ‰å››ä¸ªæ–¹æ³•<ol><li><strong>createBeanInstance</strong>è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡åå°„è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºbeanå¯¹è±¡</li><li><strong>applyMergedBeanDefinitionPostProcessors</strong>æ‰§è¡ŒMergedBeanDefinitionPostProcessorsçš„ä¸€ä¸ªæ“ä½œ</li><li><strong>populateBean</strong>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¯¹<strong>InstantiationAwareBeanPostProcessor</strong>æ¥å£ä¸‹çš„<strong>postProcessAfterInstantiation</strong>å’Œ<strong>getBeanPostProcessors</strong>ä»¥åŠè¿›è¡Œä¸€ä¸ªèµ‹å€¼çš„æ“ä½œ</li><li><strong>initializeBean</strong>æ–¹æ³•ä¸»è¦æ˜¯æ‰§è¡Œï¼š</li><li><strong>Aware</strong>ä¸‹çš„<strong>BeanNameAware</strong>ã€<strong>BeanClassLoaderAware</strong>ã€<strong>BeanFactoryAware</strong>çš„æ“ä½œ</li><li><strong>BeanPostProcessors</strong>æ¥å£ä¸‹çš„<strong>before</strong>æ–¹æ³•</li><li><strong>invokeInitMethods</strong>æ‰§è¡ŒæŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•</li><li><strong>BeanPostProcessors</strong>æ¥å£ä¸‹çš„<strong>after</strong>æ–¹æ³•</li></ol></li></ol><p>è‡³æ­¤ï¼Œæ™®é€šbeançš„åˆå§‹åŒ–è¿‡ç¨‹åŠ è½½å®Œæˆã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><ul><li><a href="https://www.jianshu.com/p/867991f3daa0">Spring AOPæºç è§£è¯»1 - ç¨‹åºå…¥å£</a></li><li><a href="https://www.sohu.com/a/214717253_714863">Springæºç åˆ†æä¹‹Beançš„åŠ è½½ </a></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Beanå®¹å™¨refreshçš„è¿‡ç¨‹</title>
      <link href="2018/03/05/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/2.bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
      <url>2018/03/05/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/2.bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      
        <content type="html"><![CDATA[<h1>beançš„ç”Ÿå‘½å‘¨æœŸ</h1><p>beançš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥é€šè¿‡**AbstrctApplicationContext.refresh()**æ–¹æ³•è¿›è¡ŒåŠ è½½æ™®é€šbeanå¯ä»¥å¾—å‡ºã€‚</p><h2 id="refresh"><a class="header-anchor" href="#refresh"></a>refresh()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ä»¥è¿›è¡Œåˆ·æ–°.</span><span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å‘Šè¯‰å­ç±»åˆ·æ–°å†…éƒ¨beanå·¥å‚.(è·å–beanFactory)</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å‡†å¤‡åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨çš„beanå·¥å‚.(å¯¹beanFactoryè¿›è¡Œé¢„å¤„ç†)</span><span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// åœ¨ä¸Šä¸‹æ–‡å­ç±»ä¸­å¯¹beanå·¥å‚è¿›è¡Œåç½®å¤„ç†.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è°ƒç”¨åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œä¸ºBeançš„å·¥å‚å¤„ç†å™¨.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨.</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–æ¶ˆæ¯æº.</span><span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨.</span><span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbean.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ£€æŸ¥ä¾¦å¬å™¨beanå¹¶æ³¨å†Œå®ƒä»¬.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéå»¶è¿Ÿåˆå§‹åŒ–ï¼‰å•ä¾‹bean.</span><span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æœ€åä¸€æ­¥ï¼šå‘å¸ƒç›¸åº”äº‹ä»¶.</span><span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - "</span> <span class="token operator">+</span><span class="token string">"cancelling refresh attempt: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// é”€æ¯å·²åˆ›å»ºçš„å•ä¾‹ä»¥é¿å…èµ„æºæ‚¬ç©º.</span><span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é‡ç½®â€œactiveâ€æ ‡å¿—</span><span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Propagate exception to caller.</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token comment">//è‡ªæ£€å¹¶é‡ç½®springä¸­ç¼“å­˜çš„beançš„å…ƒæ•°æ®ï¼Œå› ä¸ºå¯èƒ½ä¸åœ¨ä½¿ç”¨</span><span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æŒ‰ç…§æµç¨‹è¿›ä¸€æ­¥åˆ†ærefresh()æ–¹æ³•</p><h2 id="é…ç½®èµ„æºåˆå§‹åŒ–ç¯å¢ƒ"><a class="header-anchor" href="#é…ç½®èµ„æºåˆå§‹åŒ–ç¯å¢ƒ"></a>é…ç½®èµ„æºåˆå§‹åŒ–ç¯å¢ƒ</h2><p>é…ç½®åº”ç”¨åˆ·æ–°ä¸Šä¸‹æ–‡ç¯å¢ƒçš„æ–¹æ³•ä¸»è¦æœ‰<strong>prepareRefresh()</strong>ã€<strong>obtainFreshBeanFactory()</strong>ã€<strong>prepareBeanFactory(beanFactory)</strong></p><h3 id="prepareRefresh"><a class="header-anchor" href="#prepareRefresh"></a>prepareRefresh()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ä»¥è¿›è¡Œåˆ·æ–°ï¼Œè®¾ç½®å…¶å¯åŠ¨æ—¥æœŸå’Œ * æ´»åŠ¨æ ‡å¿—ï¼Œä»¥åŠæ‰§è¡Œå±æ€§æºçš„ä»»ä½•åˆå§‹åŒ–. */</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ‡æ¢åˆ°æ´»åŠ¨çŠ¶æ€.</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupDate <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Refreshing "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Refreshing "</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// åˆå§‹åŒ–ProperySourceså®¹å™¨.</span><span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// éªŒè¯æ‰€æœ‰æ ‡è®°ä¸ºå¿…éœ€çš„å±æ€§éƒ½æ˜¯å¯è§£æçš„:</span><span class="token comment">// see ConfigurablePropertyResolver#setRequiredProperties</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateRequiredProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ApplicationListenersè®¾ç½®ä¸ºé¢„å¤„ç†</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationListeners <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationListeners<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// å°†ApplicationListenersé‡æ–°è®¾ç½®æˆé¢„å¤„ç†çŠ¶æ€.</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationListeners<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>prepareRefresh()<strong>æ–¹æ³•åªæ˜¯åœ¨æ¸…ç†ä¸Šä¸‹æ–‡ç¯å¢ƒã€è®¾ç½®å¯åŠ¨äº‹ä»¶ä»¥åŠåˆå§‹åŒ–</strong>PropertySourceså®¹å™¨</strong>ç­‰ï¼›<br>åˆå§‹åŒ–<strong>PropertySources</strong>å®¹å™¨æ–¹æ³•å¯¹åº”webåº”ç”¨åº•å±‚æ˜¯è°ƒç”¨</p><pre class="line-numbers language-none"><code class="language-none">WebApplicationContextUtils.initServletPropertySources(getPropertySources(), servletContext, servletConfig)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®ç°å°†<strong>servletContext</strong>, <strong>servletConfig</strong>åŠ è½½åˆ°<strong>PropertySourceså®¹å™¨</strong>ä¸­çš„</p><ul><li>servletContextæ˜¯webåº”ç”¨æœåŠ¡å™¨ä¸ºæ¯ä¸€ä¸ªåº”ç”¨åˆ›å»ºçš„ä¸€ä¸ªæœåŠ¡ä¸Šä¸‹æ–‡å¯¹è±¡</li><li>servletConfigæ˜¯æ“ä½œä¸€ä¸ªservletä¸­çš„é…ç½®å±æ€§çš„æ¥å£</li></ul><h3 id="obtainFreshBeanFactory"><a class="header-anchor" href="#obtainFreshBeanFactory"></a>obtainFreshBeanFactory()</h3><p><strong>obtainFreshBeanFactory()</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">ConfigurableListableBeanFactory</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>**refreshBeanFactory()<strong>åˆ·æ–°beanFactoryï¼Œåº•å±‚æ˜¯è°ƒç”¨</strong>DefaultListableBeanFactory.setSerializationId()**æ–¹æ³•å»åˆ·æ–°å·¥å‚é›†åˆ</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token comment">//è¿™é‡Œä½¿ç”¨çš„æ˜¯ConcurrentHashMap</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Reference</span><span class="token punctuation">&lt;</span><span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">></span><span class="token punctuation">></span></span> serializableFactories <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> serializationId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>serializationId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           <span class="token comment">//æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯WeakReferenceä¿è¯äº†å¹¶å‘å®‰å…¨æ€§</span>serializableFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serializationId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serializationId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>serializableFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serializationId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>serializationId <span class="token operator">=</span> serializationId<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>getBeanFactory()æ–¹æ³•ä¸åŒçš„å®ç°éƒ½æ˜¯è¿”å›<strong>DefaultListableBeanFactory</strong></li></ol><h3 id="prepareBeanFactory-beanFactory"><a class="header-anchor" href="#prepareBeanFactory-beanFactory"></a>prepareBeanFactory(beanFactory)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å‘Šè¯‰å†…éƒ¨beanå·¥å‚ä½¿ç”¨ä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨ç­‰.</span>beanFactory<span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">setBeanExpressionResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardBeanExpressionResolver</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addPropertyEditorRegistrar</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEditorRegistrar</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä½¿ç”¨ä¸Šä¸‹æ–‡å›è°ƒé…ç½®Beanå·¥å‚.</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedValueResolverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoaderAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">MessageSourceAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// BeanFactoryæ¥å£ä¸åœ¨æ™®é€šå·¥å‚ä¸­æ³¨å†Œè®¾ç½®ä¸ºå¯è§£æç±»å‹.</span><span class="token comment">// MessageSourceæ³¨å†Œä¸ºBeanï¼ˆå¹¶å‘ç°ç”¨äºè‡ªåŠ¨è£…é…ï¼‰.</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ³¨å†Œæ—©æœŸçš„åç½®å¤„ç†å™¨ä»¥å°†å†…éƒ¨beanæ£€æµ‹ä¸ºApplicationListeners.</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¦‚æœå‘ç°LoadTimeWeaverï¼Œè¯·å‡†å¤‡ç»‡å…¥ã€‚</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Set a temporary ClassLoader for type matching.</span>beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ³¨å†Œé»˜è®¤ç¯å¢ƒbean.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>ENVIRONMENT_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>ENVIRONMENT_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>**prepareBeanFactory(beanFactory)**ä¸»è¦æ˜¯ç»™beanFactoryè®¾ç½®å„ç§é¢„è®¾çš„å±æ€§çš„</p><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><p>å¯¹<strong>é…ç½®èµ„æºåˆå§‹åŒ–ç¯å¢ƒ</strong>çš„æ€»ç»“å°±æ˜¯ï¼š</p><ol><li>æ¸…ç†ç¯å¢ƒï¼Œè®¾ç½®å¯åŠ¨æ—¶é—´ï¼Œè£…è½½servletContextå’ŒservletConfig</li><li>è·å–<strong>DefaultListableBeanFactory</strong></li><li>ç»™è·å–åˆ°çš„<strong>DefaultListableBeanFactory</strong>è®¾ç½®å„ç§å±æ€§</li></ol><h2 id="postProcessBeanFactory"><a class="header-anchor" href="#postProcessBeanFactory"></a>postProcessBeanFactory</h2><p><strong>postProcessBeanFactory</strong>æ˜¯ç”¨æ¥åœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„<strong>BeanPostProrecessors</strong></p><h3 id="GenericWebApplicationContextåˆ†æ"><a class="header-anchor" href="#GenericWebApplicationContextåˆ†æ"></a>GenericWebApplicationContextåˆ†æ</h3><ul><li>ä»£ç å±•ç¤º</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletContextAwareProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ServletContextAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">WebApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">registerWebApplicationScopes</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">WebApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">registerEnvironmentBeans</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><strong>ServletContextAwareProcessor</strong></li></ol><ul><li>WebApplicationContextUtils.registerWebApplicationScopes(beanFactory, this.servletContext)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerWebApplicationScopes</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ServletContext</span> sc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerScope</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>SCOPE_REQUEST<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerScope</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>SCOPE_SESSION<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SessionScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ServletContextScope</span> appScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletContextScope</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerScope</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>SCOPE_APPLICATION<span class="token punctuation">,</span> appScope<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Register as ServletContext attribute, for ContextCleanupListener to detect it.</span>sc<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">ServletContextScope</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appScope<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ServletResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ResponseObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SessionObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">WebRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WebRequestObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>jsfPresent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">FacesDependencyRegistrar</span><span class="token punctuation">.</span><span class="token function">registerFacesDependencies</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>ä¸»è¦æ˜¯ç”¨äºæ³¨å†Œwebåº”ç”¨ç¨‹åºbeançš„æ³¨å†ŒèŒƒå›´å¢åŠ <strong>request</strong>ã€<strong>session</strong>ã€<strong>application</strong></li></ol><ul><li>WebApplicationContextUtils.registerEnvironmentBeans(beanFactory, this.servletContext)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerEnvironmentBeans</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> bf<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ServletConfig</span> servletConfig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>servletContext <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bf<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>SERVLET_CONTEXT_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bf<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>SERVLET_CONTEXT_BEAN_NAME<span class="token punctuation">,</span> servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>servletConfig <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bf<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">.</span>SERVLET_CONFIG_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bf<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">.</span>SERVLET_CONFIG_BEAN_NAME<span class="token punctuation">,</span> servletConfig<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//çœç•¥...</span>bf<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>CONTEXT_PARAMETERS_BEAN_NAME<span class="token punctuation">,</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//çœç•¥...</span>bf<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span>CONTEXT_ATTRIBUTES_BEAN_NAME<span class="token punctuation">,</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>attributeMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>å°†<strong>servletContext</strong>ã€<strong>servletConfig</strong>ã€<strong>contextParameters</strong>ã€<strong>contextParameters</strong>æ³¨å†Œåˆ°å®¹å™¨ä¸­</li></ol><h3 id="æ€»ç»“ï¼špostProcessBeanFactoryæ–¹æ³•å°±æ˜¯åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†ä¸€äº›ç‰¹æ®Šçš„beanæ³¨å†Œåˆ°å®¹å™¨ä¸­å»ï¼Œä»è€Œå®Œæˆæ¥ä¸‹æ¥çš„åˆå§‹åŒ–æ“ä½œ"><a class="header-anchor" href="#æ€»ç»“ï¼špostProcessBeanFactoryæ–¹æ³•å°±æ˜¯åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†ä¸€äº›ç‰¹æ®Šçš„beanæ³¨å†Œåˆ°å®¹å™¨ä¸­å»ï¼Œä»è€Œå®Œæˆæ¥ä¸‹æ¥çš„åˆå§‹åŒ–æ“ä½œ"></a>æ€»ç»“ï¼špostProcessBeanFactoryæ–¹æ³•å°±æ˜¯åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†ä¸€äº›ç‰¹æ®Šçš„beanæ³¨å†Œåˆ°å®¹å™¨ä¸­å»ï¼Œä»è€Œå®Œæˆæ¥ä¸‹æ¥çš„åˆå§‹åŒ–æ“ä½œ</h3><h2 id="invokeBeanFactoryPostProcessors"><a class="header-anchor" href="#invokeBeanFactoryPostProcessors"></a>invokeBeanFactoryPostProcessors</h2><p><strong>invokeBeanFactoryPostProcessors</strong>æ–¹æ³•æ˜¯æ‰§è¡Œå®ç°<strong>BeanFactoryPostProcessor</strong>æ¥å£çš„æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">PostProcessorRegistrationDelegate</span><span class="token punctuation">.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span><span class="token function">getBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span><span class="token comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getTempClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>getBeanFactoryPostProcessors()<strong>ä¸­è¿”å›çš„beanæ˜¯åœ¨åˆå§‹åŒ–åŒ–ç¯å¢ƒ</strong>prepareContext</strong>ä¸­åŠ è½½çš„</p><p><strong>invokeBeanFactoryPostProcessors</strong>çš„ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> processedBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionRegistry</span> registry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> regularPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">></span></span> registryProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span> postProcessor <span class="token operator">:</span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>postProcessor <span class="token keyword">instanceof</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span> registryProcessor <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">)</span> postProcessor<span class="token punctuation">;</span>registryProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>regularPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>postProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">></span></span> currentRegistryProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥....</span><span class="token comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><span class="token comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><span class="token keyword">boolean</span> reiterate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>reiterate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>registryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>regularPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥....</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä»£ç çš„ä½œç”¨å°±æ˜¯</p><ol><li>å…ˆå¤„ç†<strong>BeanDefinitionRegistryPostProcessor</strong>ï¼ŒæŒ‰ç…§PriorityOrdered &gt; Ordered &gt; æ™®é€šçš„é¡ºåºä¸€æ¬¡æ‰§è¡Œ<strong>postProcessBeanDefinitionRegistry</strong>æ–¹æ³•ï¼›</li><li>å†å¤„ç†<strong>BeanFactoryPostProcessors</strong>ï¼ŒæŒ‰ç…§PriorityOrdered &gt; Ordered &gt; æ™®é€šçš„é¡ºåºä¸€æ¬¡æ‰§è¡Œ<strong>postProcessBeanFactory</strong>æ–¹æ³•ï¼›</li></ol><h3 id="æ€»ç»“-v2"><a class="header-anchor" href="#æ€»ç»“-v2"></a>æ€»ç»“</h3><p><strong>invokeBeanFactoryPostProcessors</strong>æ–¹æ³•å°±æ˜¯æ‰§è¡Œå®ç°<strong>BeanDefinitionRegistryPostProcessor</strong>æ¥å£çš„<strong>postProcessBeanDefinitionRegistry</strong>ä»¥åŠæ‰§è¡Œå®ç°<strong>BeanFactoryPostProcessors</strong>æ¥å£çš„<strong>postProcessBeanFactory</strong>æ–¹æ³•</p><blockquote><p>è¿è¡Œç¤ºä¾‹<br><img src="https://s2.ax1x.com/2020/03/06/3LvlRO.png" alt="3LvlRO.png"></p></blockquote><h2 id="registerBeanPostProcessorsåˆ†æ"><a class="header-anchor" href="#registerBeanPostProcessorsåˆ†æ"></a>registerBeanPostProcessorsåˆ†æ</h2><ul><li>ä»£ç ç¤ºä¾‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">AbstractApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Register BeanPostProcessorChecker that logs an info message when</span><span class="token comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span><span class="token comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span><span class="token keyword">int</span> beanProcessorTargetCount <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanPostProcessorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> postProcessorNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanPostProcessorChecker</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> beanProcessorTargetCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span><span class="token comment">// Ordered, and the rest.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> priorityOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> internalPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> orderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> nonOrderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> priorityOrderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥ä»£ç ...</span><span class="token comment">// Next, register the BeanPostProcessors that implement Ordered.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> orderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> orderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥ä»£ç ...</span><span class="token comment">// Now, register all regular BeanPostProcessors.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> nonOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> nonOrderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥ä»£ç ...</span><span class="token comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span><span class="token comment">// moving it to the end of the processor chain (for picking up proxies etc).</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦æ˜¯å¾€beanFactoryä¸­æ³¨å†Œ<strong>BeanProcessor</strong>çš„å®ç°ï¼Œåœ¨beanFactoryä¸­æ˜¯ç”¨<strong>CopyOnWriteArrayList</strong>æ¥ä½œä¸ºç¼“å­˜å®¹å™¨çš„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** AbstractBeanFactoryå†…éƒ¨æ˜¯ç”¨CopyOnWriteArrayListæ¥ä¿è¯å®‰å…¨æ€§çš„ */</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> beanPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="initMessageSource"><a class="header-anchor" href="#initMessageSource"></a>initMessageSource()</h2><p><strong>initMessageSource</strong>æ˜¯åˆå§‹åŒ–æ¶ˆæ¯æºçš„ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œåˆå§‹åŒ–å›½é™…åŒ–é…ç½®ç›¸å…³çš„</p><h2 id="initApplicationEventMulticaster"><a class="header-anchor" href="#initApplicationEventMulticaster"></a>initApplicationEventMulticaster</h2><p><strong>initApplicationEventMulticaster</strong>è¿›è¡Œåˆå§‹åŒ–äº‹ä»¶å‘å¸ƒå™¨ã€‚beanFactoryä¸­å­˜åœ¨<strong>ApplicationEventMulticaster</strong>å°±è¿›è¡Œæ³¨å†Œï¼Œæ²¡æœ‰å°±æ³¨å†Œ<strong>SimpleApplicationEventMulticaster</strong>ã€‚</p><h2 id="onRefresh"><a class="header-anchor" href="#onRefresh"></a>onRefresh()</h2><p><strong>onRefresh</strong>,ç”¨äºå­ç±»å®ç°å®¹å™¨refreshçš„è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–ç‰¹æ®Šæ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå…è®¸å­ç±»å»æ‰©å±•</p><h2 id="registerListeners"><a class="header-anchor" href="#registerListeners"></a>registerListeners</h2><p><strong>registerListeners</strong>æ³¨å†Œç›‘å¬å™¨</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// é¦–å…ˆæ³¨å†ŒæŒ‡å®šçš„é™æ€ä¾¦å¬å™¨.</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> listener <span class="token operator">:</span> <span class="token function">getApplicationListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ä¸è¦åœ¨è¿™é‡Œåˆå§‹åŒ–FactoryBeansï¼šæˆ‘ä»¬éœ€è¦ä¿ç•™æ‰€æœ‰å¸¸è§„bean</span><span class="token comment">//å¦åˆ™åç½®å¤„ç†å™¨å°†æ— æ³•å¯¹ä»–ä»¬è¿›è¡Œå¤„ç†!</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> listenerBeanNames <span class="token operator">=</span> <span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> listenerBeanName <span class="token operator">:</span> listenerBeanNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListenerBean</span><span class="token punctuation">(</span>listenerBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Publish early application events now that we finally have a multicaster...</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">></span></span> earlyEventsToProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlyEventsToProcess <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> earlyEvent <span class="token operator">:</span> earlyEventsToProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span>earlyEvent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="finishBeanFactoryInitialization-beanFactory"><a class="header-anchor" href="#finishBeanFactoryInitialization-beanFactory"></a>finishBeanFactoryInitialization(beanFactory)</h2><p>**finishBeanFactoryInitialization(beanFactory)**å®åˆ—åŒ–å‰©ä¸‹çš„bean,è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯ç»å¤§å¤šæ•°beanåˆå§‹åŒ–çš„æ–¹å¼ã€‚è¿™ä¸ªæ–¹æ³•çš„è§£ææ”¾åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« </p><h2 id="finishRefresh"><a class="header-anchor" href="#finishRefresh"></a>finishRefresh</h2><p><strong>finishRefresh</strong>å®Œæˆå®¹å™¨çš„åˆ·æ–°</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ¸…é™¤ä¸Šä¸‹æ–‡çº§åˆ«çš„èµ„æºç¼“å­˜ï¼ˆä¾‹å¦‚æ¥è‡ªæ‰«æçš„ASMå…ƒæ•°æ®ï¼‰.</span><span class="token function">clearResourceCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¸ºå®¹å™¨åˆå§‹åŒ–å¤„ç†å™¨.æ³¨å†Œä¸€ä¸ªLifecycleProcessor</span><span class="token function">initLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¯¹ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨è¿›è¡Œåˆ·æ–°.</span><span class="token function">getLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¹¿æ’­å®¹å™¨åˆå§‹åŒ–å®Œæˆçš„æ¶ˆæ¯.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å…ˆLiveBeanViewä¸­æ³¨å†ŒApplicationContext.</span><span class="token class-name">LiveBeansView</span><span class="token punctuation">.</span><span class="token function">registerApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>initLifecycleProcessor</strong>å®¹å™¨æ‰§è¡Œå®¹å™¨åˆå§‹åŒ–å‘¨æœŸè¿‡ç¨‹ä¸­çš„æ§åˆ¶</p><ul><li>ä»£ç è¿è¡Œ<br><img src="https://s2.ax1x.com/2020/03/07/3OuocQ.png" alt="3OuocQ.png"></li></ul><h1>æ€»ç»“</h1><ol><li>é…ç½®èµ„æºåˆå§‹åŒ–ç¯å¢ƒ<ol><li>æ¸…ç†ç¯å¢ƒï¼Œè®¾ç½®å¯åŠ¨æ—¶é—´ï¼Œè£…è½½servletContextå’ŒservletConfig</li><li>è·å–DefaultListableBeanFactory</li><li>ç»™DefaultListableBeanFactoryè®¾ç½®å„ç§å±æ€§</li></ol></li><li>postProcessBeanFactory()<ol><li>æ³¨å†ŒServletContextAwareProcessor</li><li>ä¸»è¦æ˜¯ç”¨äºæ³¨å†Œwebåº”ç”¨ç¨‹åºbeançš„æ³¨å†ŒèŒƒå›´å¢åŠ requestã€sessionã€application</li><li>å°†servletContextã€servletConfigã€contextParametersã€contextParametersæ³¨å†Œåˆ°å®¹å™¨ä¸­</li></ol></li><li>invokeBeanFactoryPostProcessors()<ol><li>å…ˆå¤„ç†BeanDefinitionRegistryPostProcessorï¼ŒæŒ‰ç…§PriorityOrdered &gt; Ordered &gt; æ™®é€šçš„é¡ºåºä¸€æ¬¡æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•</li><li>å†å¤„ç†BeanFactoryPostProcessorsï¼ŒæŒ‰ç…§PriorityOrdered &gt; Ordered &gt; æ™®é€šçš„é¡ºåºä¸€æ¬¡æ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•</li></ol></li><li>registerBeanPostProcessors()<ol><li>å¾€beanFactoryä¸­æ³¨å†ŒBeanProcessorçš„å®ç°</li></ol></li><li>initMessageSourceè¿›è¡Œå›½é™…åŒ–é…ç½®å¤„ç†</li><li>initApplicationEventMulticasterè¿›è¡Œåˆå§‹åŒ–äº‹ä»¶å‘å¸ƒå™¨ã€‚beanFactoryä¸­å­˜åœ¨ApplicationEventMulticasterå°±è¿›è¡Œæ³¨å†Œï¼Œæ²¡æœ‰å°±æ³¨å†ŒSimpleApplicationEventMulticaster</li><li>onRefresh,ç”¨äºå­ç±»å®ç°å®¹å™¨refreshçš„è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–ç‰¹æ®Šæ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå…è®¸å­ç±»å»æ‰©å±•</li><li>registerListenersæ³¨å†Œç›‘å¬å™¨</li><li>finishBeanFactoryInitialization()åŠ è½½bean</li><li>finishRefreshå®Œæˆå®¹å™¨çš„åˆ·æ–°</li></ol><ul><li>æµç¨‹å›¾<br><img src="https://s2.ax1x.com/2020/03/07/3OMqYV.png" alt="3OMqYV.png"></li></ul><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><ul><li><a href="https://www.jianshu.com/p/5323114c0d05">springä¹‹BeanFactoryPostProcessoræ‰§è¡Œæµç¨‹</a></li><li><a href="https://www.jianshu.com/p/1bc735c30c54">è§£è¯»Springå®¹å™¨çš„refresh()</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springæºä»£ç å­¦ä¹ (ä¸€) è®¤è¯†springå®¹å™¨å’Œç»„ä»¶</title>
      <link href="2018/03/03/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/1.%E8%AE%A4%E8%AF%86spring%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BB%84%E4%BB%B6/"/>
      <url>2018/03/03/4.spring%E6%BA%90%E4%BB%A3%E7%A0%81/1.%E8%AE%A4%E8%AF%86spring%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>å‰è¨€ï¼š<br>springå§‹ç»ˆæ˜¯javaç¨‹åºå‘˜å¿…é¡»è¦æŒæ¡çš„ä¸€ä¸ªæŠ€èƒ½ï¼Œéšç€springBootçš„æ™®åŠåŒ–ï¼ŒspringBootå°†å¤§é‡åˆå§‹åŒ–å·¥ä½œæ›¿æˆ‘ä»¬å®ç°ï¼Œéšè—äº†å®ç°ç»†èŠ‚ã€‚æ–¹ä¾¿äº†æˆ‘ä»¬å¿«é€Ÿå¼€å±•ä¸šåŠ¡ï¼Œä½†æ˜¯æŒæ¡å¥½springï¼Œç†Ÿæ‚‰åŸºç¡€ï¼Œæ‰èƒ½æ›´å¥½çš„çŸ¥é“åº”ç”¨è¿è¡Œçš„æœ¬è´¨æ˜¯ä»€ä¹ˆã€‚å‡ºç°é—®é¢˜æ€ä¹ˆå»è§£å†³ã€‚ååå¤å¤ï¼Œæˆ‘ä¹Ÿå°è¯•çœ‹äº†å¾ˆå¤šéspringçš„æºä»£ç ï¼Œä½†æ˜¯éƒ½åªæ˜¯çŸ¥è¯†åœ¨è„‘æµ·ä¸­è¿‡äº†ä¸€ä¸‹ï¼Œå¹¶æ²¡æœ‰ç•™ä¸‹ã€ç†è§£ã€‚è¿™ä¸€æ¬¡ä¸€å®šè¦æŠŠspringå¼„æ‡‚ï¼</p><h1>è®¤è¯†springå®¹å™¨å’Œç»„ä»¶</h1><h2 id="springå®¹å™¨"><a class="header-anchor" href="#springå®¹å™¨"></a>springå®¹å™¨</h2><h3 id="springå®¹å™¨æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#springå®¹å™¨æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>springå®¹å™¨æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>springå®¹å™¨æŒ‡çš„æ˜¯</p><ul><li>åŠŸèƒ½æè¿°ï¼šæ˜¯ä¸€ä¸ªé€šè¿‡é…ç½®æ–‡ä»¶æˆ–ç±»ä¼¼æ–¹å¼åŠ è½½é…ç½®çš„å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨å¯ä»¥æ ¹æ®é…ç½®å»<strong>åˆ›å»º</strong>ã€<strong>ç®¡ç†</strong>ã€<strong>é”€æ¯</strong>Beanå¯¹è±¡ã€‚</li><li>ä»£ç æè¿°ï¼šæ˜¯å®ç°äº†<strong>ApplicationContext</strong>æ¥å£çš„å­ç±»</li></ul><h3 id="springå®¹å™¨çš„åŠŸèƒ½å’Œç‰¹ç‚¹æœ‰å“ªäº›ï¼Ÿ"><a class="header-anchor" href="#springå®¹å™¨çš„åŠŸèƒ½å’Œç‰¹ç‚¹æœ‰å“ªäº›ï¼Ÿ"></a>springå®¹å™¨çš„åŠŸèƒ½å’Œç‰¹ç‚¹æœ‰å“ªäº›ï¼Ÿ</h3><ul><li><p>springå®¹å™¨åŠŸèƒ½<br><img src="https://s2.ax1x.com/2020/03/03/34bTkq.png" alt="springå®¹å™¨åŠŸèƒ½"></p></li><li><p>springå®¹å™¨ç±»å‹<br><img src="https://s2.ax1x.com/2020/03/03/35pvRA.png" alt="springå®¹å™¨ç±»å‹"></p></li></ul><h3 id="BeanFactoryå’ŒApplicationContextçš„å¯¹æ¯”"><a class="header-anchor" href="#BeanFactoryå’ŒApplicationContextçš„å¯¹æ¯”"></a>BeanFactoryå’ŒApplicationContextçš„å¯¹æ¯”</h3><table><thead><tr><th>\</th><th>BeanFactory</th><th>ApplicationContext</th></tr></thead><tbody><tr><td>åˆå§‹åŒ–beanæ–¹å¼</td><td>åœ¨å¯åŠ¨æ—¶ï¼Œä¸ä¼šå®ä¾‹åŒ–Beanï¼Œä»å®¹å™¨ä¸­è·å–çš„æ—¶å€™æ‰ä¼šå®ä¾‹åŒ–bean</td><td>å¯åŠ¨æ—¶å°±ä¼šåˆå§‹åŒ–å…¨éƒ¨beanï¼Œå¯é…ç½®lazy-init=trueå®ç°å»¶è¿ŸåŠ è½½</td></tr></tbody></table><h3 id="Applicationå®¹å™¨çš„ç‰¹ç‚¹å’ŒåŠŸèƒ½"><a class="header-anchor" href="#Applicationå®¹å™¨çš„ç‰¹ç‚¹å’ŒåŠŸèƒ½"></a>Applicationå®¹å™¨çš„ç‰¹ç‚¹å’ŒåŠŸèƒ½</h3><p><img src="https://s2.ax1x.com/2020/03/03/35SvuV.png" alt="Applicationç±»åˆ«å’Œç‰¹ç‚¹"></p><h2 id="springç»„ä»¶"><a class="header-anchor" href="#springç»„ä»¶"></a>springç»„ä»¶</h2><h3 id="èµ„æºæŠ½è±¡æ¥å£"><a class="header-anchor" href="#èµ„æºæŠ½è±¡æ¥å£"></a>èµ„æºæŠ½è±¡æ¥å£</h3><table><thead><tr><th>åç§°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>FileSystemResource</td><td>æ–‡ä»¶ç³»ç»Ÿç»å¯¹è·¯å¾„çš„æ–¹å¼è¿›è¡Œè®¿é—®</td></tr><tr><td>ClassPathResource</td><td>ä»¥ç±»è·¯å¾„çš„æ–¹å¼è¿›è¡Œè®¿é—®</td></tr><tr><td>ServletContextResource</td><td>ç›¸å¯¹äºWebåº”ç”¨æ ¹ç›®å½•çš„æ–¹å¼è¿›è¡Œè®¿é—®</td></tr></tbody></table><h3 id="BeanFactoryç»„ä»¶ç±»"><a class="header-anchor" href="#BeanFactoryç»„ä»¶ç±»"></a>BeanFactoryç»„ä»¶ç±»</h3><ul><li><p>DefaultListableBeanFactoryç±»å›¾<br><img src="https://s2.ax1x.com/2020/03/04/35EWge.png" alt="DefaultListableBeanFactoryç±»å›¾"></p></li><li><p>è§‚å¯ŸBeanFactoryçš„ç±»å›¾ç»“æ„ä¸ºï¼š<br><img src="https://s2.ax1x.com/2020/03/04/3omrsU.png" alt="BeanFactoryçš„ç±»å›¾"></p></li><li><p>BeanFactoryä¸­å®šä¹‰çš„åŠŸèƒ½<br><img src="https://s2.ax1x.com/2020/03/04/3oQ9cq.png" alt="BeanFactoryçš„åŠŸèƒ½"></p></li></ul><p><strong>BeanFactory</strong>ä¸‹æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>ListableBeanFactory</li><li>HierarchicalBeanFactory</li><li>AutowireCapableBeanFactory</li></ul><h4 id="ListableBeanFactory"><a class="header-anchor" href="#ListableBeanFactory"></a>ListableBeanFactory</h4><ul><li><p>å®šä¹‰ï¼šå¯å°†Beanåˆ—å‡ºçš„å·¥å‚ç±»</p></li><li><p>ä¸»è¦çš„åŠŸèƒ½æœ‰ï¼š</p></li></ul><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>boolean containsBeanDefinition(String beanName)</td><td>æ ¹æ®åç§°åˆ¤æ–­æ˜¯å¦æœ‰BeanDefinition</td></tr><tr><td>int getBeanDefinitionCount()</td><td>è¿”å›BeanDefinitionçš„ä¸ªæ•°</td></tr><tr><td>String[] getBeanDefinitionNames()</td><td>è¿”å›BeanDefinitionçš„åç§°é›†åˆ</td></tr><tr><td>String[] getBeanNamesForType(Class&lt;?&gt; type)</td><td>æ ¹æ®ç±»å‹è¿”å›Beançš„åç§°é›†åˆ</td></tr><tr><td>Map&lt;String,T&gt; getBeansOfType(Class<T> type)</td><td>æ ¹æ®ç±»å‹è¿”å›Beanå®ä¾‹</td></tr></tbody></table><h4 id="HierarchicalBeanFactory"><a class="header-anchor" href="#HierarchicalBeanFactory"></a>HierarchicalBeanFactory</h4><ul><li><p>å®šä¹‰ï¼šå®ç°Beanå·¥å‚çš„åˆ†å±‚</p></li><li><p>ä¸»è¦çš„åŠŸèƒ½æœ‰ï¼š</p></li></ul><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>BeanFactory getParentBeanFactory()</td><td>è¿”å›beanå·¥å‚çš„çˆ¶å·¥å‚</td></tr><tr><td>boolean containsLocalBean(String name)</td><td>æ ¹æ®åç§°åˆ¤æ–­è¯¥Beanå·¥å‚æ˜¯å¦åŒ…å«è¿™ä¸ªbean</td></tr></tbody></table><h4 id="AutowireCapableBeanFactory"><a class="header-anchor" href="#AutowireCapableBeanFactory"></a>AutowireCapableBeanFactory</h4><ul><li><p>å®šä¹‰ï¼šå®ç°è‡ªåŠ¨è£…é…çš„Beanå·¥å‚</p></li><li><p>ä¸»è¦çš„åŠŸèƒ½æœ‰ï¼š</p></li></ul><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>applyBeanPostProcessorsBeforeInitializationã€applyBeanPostProcessorsBeforeInitializationã€applyBeanPropertyValues</td><td>åˆ†åˆ«æ˜¯æ‰§è¡ŒInstantiationAwareBeanPostProcessoræ¥å£å¯¹åº”çš„æ–¹æ³•</td></tr><tr><td>configureBean</td><td>ç»™Beanè‡ªåŠ¨è£…é…å±æ€§</td></tr><tr><td>createBeanã€destroyBean</td><td>åˆ†åˆ«æ˜¯åˆ›å»ºå’Œé”€æ¯bean</td></tr><tr><td>initializeBean</td><td>åˆå§‹åŒ–bean</td></tr><tr><td>resolveBeanByName</td><td>åˆ†è§£æŒ‡å®šä¾èµ–çš„æ–¹æ³•</td></tr></tbody></table><ul><li>AutowireCapableBeanFactoryæ–¹æ³•<br><img src="https://s2.ax1x.com/2020/03/04/3oBjsO.png" alt="AutowireCapableBeanFactory"></li></ul><h4 id="ConfigurableBeanFactory"><a class="header-anchor" href="#ConfigurableBeanFactory"></a>ConfigurableBeanFactory</h4><p><strong>ConfigurableBeanFactory</strong>æ˜¯å¯é…ç½®çš„beanå·¥å‚,å®ç°äº†<strong>HierarchicalBeanFactory</strong>ã€<strong>SingletonBeanRegistry</strong></p><ul><li>SingletonBeanRegistry<br>æ³¨å†Œå•åˆ—beançš„æ¥å£</li></ul><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>containsSingleton</td><td>æ ¹æ®åç§°åˆ¤æ–­Beanæ˜¯å¦å­˜åœ¨</td></tr><tr><td>getSingleton</td><td>æ ¹æ®åç§°è¿”å›Bean</td></tr><tr><td>getSingletonCount</td><td>è¿”å›Beançš„ä¸ªæ•°</td></tr><tr><td>getSingletonMutex</td><td>è¿”å›å®ä¾‹åŒ–è¿‡ç¨‹ä¸­çš„é”</td></tr><tr><td>getSingletonNames</td><td>è¿”å›æ‰€æœ‰beançš„åç§°</td></tr><tr><td>registerSingleton</td><td>æ³¨å†Œå•åˆ—bean</td></tr></tbody></table><p>ç”±äº<strong>ConfigurableBeanFactory</strong>æ–¹æ³•å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå› æ­¤è¿™é‡Œåªå•ç‹¬åˆ—ä¸¾å‡ ä¸ªæ¯”è¾ƒå…¸å‹çš„æ–¹æ³•ï¼Œåé¢çš„ç« èŠ‚åœ¨ç»“åˆæµç¨‹æ¥åˆ†æã€‚</p><ul><li>ConfigurableBeanFactoryçš„æ–¹æ³•</li></ul><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>isFactoryBean</td><td>åˆ¤æ–­æ˜¯å¦æ˜¯BeanFactory</td></tr><tr><td>register*</td><td>æ³¨å†ŒBeanç›¸å…³çš„æ–¹æ³•</td></tr><tr><td>addBeanPostProcessor</td><td>æ·»åŠ BeanPostProcessor</td></tr></tbody></table><h4 id="ConfigurableListableBeanFactory"><a class="header-anchor" href="#ConfigurableListableBeanFactory"></a>ConfigurableListableBeanFactory</h4><p><strong>ConfigurableListableBeanFactory</strong>è¯¥ç±»ç»§æ‰¿è‡ª<strong>ListableBeanFactory</strong>ã€<strong>AutowireCapableBeanFactory</strong>ã€<strong>ConfigurableBeanFactory</strong>ç­‰ç±»</p><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>registerResolvableDependency</td><td>æ³¨å†Œä¸€ä¸ªå¯åˆ†è§£çš„ä¾èµ–</td></tr><tr><td>preInstantiateSingletons</td><td>å®ä¾‹åŒ–éå»¶è¿ŸåŠ è½½çš„bean</td></tr><tr><td>getBeanDefinition</td><td>æ ¹æ®åç§°è¿”å›BeanDefinition</td></tr></tbody></table><h4 id="BeanDefinitionRegistry"><a class="header-anchor" href="#BeanDefinitionRegistry"></a>BeanDefinitionRegistry</h4><p><strong>BeanDefinitionRegistry</strong>ç”¨æ¥æ“ä½œBeanDefinitionçš„ç±»ï¼Œç»§æ‰¿äº†<strong>AliasRegistry</strong></p><p><strong>AliasRegistry</strong>å®šä¹‰äº†æ ¹æ®åˆ«åå¯¹ç±»è¿›è¡Œæ“ä½œçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬<strong>registerAlias</strong>ã€<strong>removeAlias</strong>ã€<strong>isAlias</strong>ã€<strong>getAliases</strong></p><ul><li>BeanDefinitionRegistryæ–¹æ³•çš„å®šä¹‰</li></ul><table><thead><tr><th>æ–¹æ³•åç§°</th><th>åŠŸèƒ½å«ä¹‰</th></tr></thead><tbody><tr><td>registerBeanDefinition</td><td>æ³¨å†Œä¸€ä¸ªbeanNameåç§°çš„BeanDefinition</td></tr><tr><td>removeã€getã€contains</td><td>ç§»é™¤ã€è·å–ã€åˆ¤æ–­BeanDefinition</td></tr><tr><td>getBeanDefinitionNames</td><td>è¿”å›å®¹å™¨å†…BeanDefinitionçš„åç§°æ•°ç»„</td></tr><tr><td>getBeanDefinitionCount</td><td>è¿”å›BeanDefintionçš„ä¸ªæ•°</td></tr><tr><td>isBeanNameInUse</td><td>æ ¹æ®åç§°åˆ¤æ–­BeanDefintionæ˜¯å¦è¢«æ³¨å†Œè¿‡</td></tr></tbody></table><h3 id="ApplicationContextç»„ä»¶ç±»"><a class="header-anchor" href="#ApplicationContextç»„ä»¶ç±»"></a>ApplicationContextç»„ä»¶ç±»</h3><p>ApplicationContextå®¹å™¨ä»¥<strong>AbstractXmlApplicationContext</strong>æ¥è¿›è¡Œåˆ†æ</p><ul><li>AbstractXmlApplicationContextç±»å›¾</li></ul><p><img src="https://s2.ax1x.com/2020/03/04/3ohgJO.png" alt="3ohgJO.png"><br>ä»ç±»å›¾å¯ä»¥çœ‹å¾—å‡ºApplicationContxtä¸»è¦è¿˜æ˜¯å®ç°BeanFactoryçš„å­ç±»ï¼Œå¹¶ä¸”ä¹Ÿç»§æ‰¿äº†å®ç°Springå®¹å™¨å…¶ä»–ç‰¹æ€§çš„åŠŸèƒ½ï¼Œä¾‹å¦‚äº‹ä»¶ç›‘å¬ã€èµ„æºæ–‡ä»¶ã€å›½é™…åŒ–ç­‰æ¥å£</p><p>ä»¥ä¸‹æˆªå–â˜<a href="https://segmentfault.com/a/1190000008291174">Learn Spring - Spring IoC</a>çš„æ€»ç»“</p><ul><li><p><strong>ApplicationEventPublisher</strong>ï¼šè®©å®¹å™¨æ‹¥æœ‰å‘å¸ƒåº”ç”¨ä¸Šä¸‹æ–‡äº‹ä»¶çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®¹å™¨å¯åŠ¨äº‹ä»¶ã€å…³é—­äº‹ä»¶ç­‰ã€‚å®ç°äº†ApplicationListeneräº‹ä»¶ç›‘å¬æ¥å£çš„Bean å¯ä»¥æ¥æ”¶åˆ°å®¹å™¨äº‹ä»¶ï¼Œå¹¶å¯¹äº‹ä»¶è¿›è¡Œå“åº”å¤„ç†ã€‚åœ¨ApplicationContextæŠ½è±¡å®ç°ç±»AbstractApplicationContextä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å­˜åœ¨ä¸€ä¸ªApplicationEventMulticasterï¼Œå®ƒè´Ÿè´£ä¿å­˜æ‰€æœ‰ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨å®¹å™¨äº§ç”Ÿä¸Šä¸‹æ–‡äº‹ä»¶æ—¶é€šçŸ¥è¿™äº›äº‹ä»¶ç›‘å¬è€…ã€‚</p></li><li><p><strong>MessageSource</strong>ï¼šä¸ºåº”ç”¨æä¾›i18nå›½é™…åŒ–æ¶ˆæ¯è®¿é—®çš„åŠŸèƒ½ï¼›</p></li><li><p><strong>ResourcePatternResolver</strong>ï¼šæ‰€æœ‰ApplicationContextå®ç°ç±»éƒ½å®ç°äº†ç±»ä¼¼äºPathMatchingResourcePatternResolverçš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å¸¦å‰ç¼€çš„Anté£æ ¼çš„èµ„æºæ–‡ä»¶è·¯å¾„è£…è½½Springçš„é…ç½®æ–‡ä»¶ã€‚</p></li><li><p><strong>LifeCycle</strong>ï¼šè¯¥æ¥å£æ˜¯Spring 2.0åŠ å…¥çš„ï¼Œè¯¥æ¥å£æä¾›äº†start()å’Œstop()ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸»è¦ç”¨äºæ§åˆ¶å¼‚æ­¥å¤„ç†è¿‡ç¨‹ã€‚åœ¨å…·ä½“ä½¿ç”¨æ—¶ï¼Œè¯¥æ¥å£åŒæ—¶è¢«ApplicationContextå®ç°åŠå…·ä½“Beanå®ç°ï¼ŒApplicationContextä¼šå°†start/stopçš„ä¿¡æ¯ä¼ é€’ç»™å®¹å™¨ä¸­æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„Beanï¼Œä»¥è¾¾åˆ°ç®¡ç†å’Œæ§åˆ¶JMXã€ä»»åŠ¡è°ƒåº¦ç­‰ç›®çš„ã€‚</p></li><li><p><strong>ConfigurableApplicationContext</strong>æ‰©å±•äºApplicationContextï¼Œå®ƒæ–°å¢åŠ äº†ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ï¼šrefresh()å’Œclose()ï¼Œè®©ApplicationContextå…·æœ‰å¯åŠ¨ã€åˆ·æ–°å’Œå…³é—­åº”ç”¨ä¸Šä¸‹æ–‡çš„èƒ½åŠ›ã€‚åœ¨åº”ç”¨ä¸Šä¸‹æ–‡å…³é—­çš„æƒ…å†µä¸‹è°ƒç”¨refresh()å³å¯å¯åŠ¨åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œåœ¨å·²ç»å¯åŠ¨çš„çŠ¶æ€ä¸‹ï¼Œè°ƒç”¨refresh()åˆ™æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è£…è½½é…ç½®ä¿¡æ¯ï¼Œè€Œè°ƒç”¨close()åˆ™å¯å…³é—­åº”ç”¨ä¸Šä¸‹æ–‡ã€‚</p></li></ul><h3 id="WebApplicantContextç»„ä»¶ç±»"><a class="header-anchor" href="#WebApplicantContextç»„ä»¶ç±»"></a>WebApplicantContextç»„ä»¶ç±»</h3><p><strong>WebApplicationContext</strong>æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºWebåº”ç”¨å‡†å¤‡çš„ï¼Œå®ƒå…è®¸ä»Webæ ¹ç›®å½•æ ¹æ®ç›¸å¯¹è·¯å¾„è¿›è¡Œè£…è½½é…ç½®æ–‡ä»¶å®Œæˆåˆå§‹åŒ–ã€‚ä»WebApplicationContextä¸­å¯ä»¥è·å–ServletContextå¼•ç”¨ï¼Œæ•´ä¸ªWebåº”ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡å°†ä½œä¸ºå±æ€§æ”¾ç½®åœ¨ServletContextä¸­ï¼Œä»¥ä¾¿Webåº”ç”¨ç¯å¢ƒå¯ä»¥è®¿é—®springä¸Šä¸‹æ–‡ã€‚</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸»è¦ä»‹ç»äº†Springå®¹å™¨å’Œç»„ä»¶ï¼ŒSpringç»„ä»¶ä¸»è¦æ˜¯åˆ†ä¸ºBeanFactoryç»„ä»¶å’ŒApplicationContextç»„ä»¶ã€‚è¿™ä¸¤ä¸ªç»„ä»¶ä¸‹é¢æœ‰åˆ†åˆ«æ´¾ç”Ÿå‡ºå…¶ä»–çš„ç»„ä»¶ä¾‹å¦‚BeanFactoryä¸‹åˆæœ‰<strong>AutowireCapableBeanFactory</strong>å®ç°äº†è‡ªåŠ¨è£…é…å’Œåº”ç”¨InstantiationAwareBeanPostProcessoræ¥å£çš„æ–¹æ³•ã€<strong>ConfigurableBeanFactory</strong>å¯é…ç½®åŒ–çš„BeanFactoryå¢å¼ºäº†BeanFactoryçš„èƒ½åŠ›ï¼›Applicationä¸‹çš„<strong>ApplicationEventPublisher</strong>è®©å®¹å™¨æ‹¥æœ‰å‘å¸ƒåº”ç”¨ä¸Šä¸‹æ–‡äº‹ä»¶çš„åŠŸèƒ½(å¯åŠ¨å’Œå…³é—­)ã€<strong>ConfigurableApplicationContext</strong>æ‰©å±•äºApplicationContextï¼Œå®ƒæ–°å¢åŠ äº†ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š**refresh()**å’Œclose()ï¼Œè®©ApplicationContextå…·æœ‰å¯åŠ¨ã€åˆ·æ–°å’Œå…³é—­åº”ç”¨ä¸Šä¸‹æ–‡çš„èƒ½åŠ›ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™</p></blockquote><ul><li><a href="https://blog.csdn.net/qq_34598667/article/details/83245753">Springå®¹å™¨æ˜¯ä»€ä¹ˆ(æµ…æ˜¾æ˜“æ‡‚)ï¼Ÿ</a></li><li><a href="https://www.jianshu.com/p/6a2100dd6532">Spring å®¹å™¨æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href="https://segmentfault.com/a/1190000008291174">Learn Spring - Spring IoC</a></li><li><a href="https://blog.csdn.net/xiao__jia__jia/article/details/102470325">ConfigurableApplicationContext</a></li><li><a href="https://www.jianshu.com/p/2854d8984dfc">ç†è§£Springå®¹å™¨ã€BeanFactoryå’ŒApplicationContext</a></li><li><a href="https://www.cnblogs.com/zrtqsk/p/4028453.html">Springæºç åˆ†æâ€”â€”BeanFactoryä½“ç³»ä¹‹æ¥å£è¯¦ç»†åˆ†æ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Markdownæ¨¡æ¿</title>
      <link href="2017/12/22/Markdown%E6%A8%A1%E6%9D%BF/"/>
      <url>2017/12/22/Markdown%E6%A8%A1%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<h1>Markdown åŸºæœ¬è¦ç´ </h1><p>è¿™ç¯‡æ–‡ä»¶æ„åœ¨ç®€è¦ä»‹ç» <a href="https://guides.github.com/features/mastering-markdown/">GitHub Flavored Markdown å†™ä½œ</a>ã€‚</p><h2 id="è¯­æ³•è¯´æ˜"><a class="header-anchor" href="#è¯­æ³•è¯´æ˜"></a>è¯­æ³•è¯´æ˜</h2><h3 id="æ ‡é¢˜"><a class="header-anchor" href="#æ ‡é¢˜"></a>æ ‡é¢˜</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> è¿™æ˜¯ &lt;h1> ä¸€çº§æ ‡é¢˜</span><span class="token title important"><span class="token punctuation">##</span> è¿™æ˜¯ &lt;h2> äºŒçº§æ ‡é¢˜</span><span class="token title important"><span class="token punctuation">###</span> è¿™æ˜¯ &lt;h3> ä¸‰çº§æ ‡é¢˜</span><span class="token title important"><span class="token punctuation">####</span> è¿™æ˜¯ &lt;h4> å››çº§æ ‡é¢˜</span><span class="token title important"><span class="token punctuation">#####</span> è¿™æ˜¯ &lt;h5> äº”çº§æ ‡é¢˜</span><span class="token title important"><span class="token punctuation">######</span> è¿™æ˜¯ &lt;h6> å…­çº§æ ‡é¢˜</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å¼ºè°ƒ"><a class="header-anchor" href="#å¼ºè°ƒ"></a>å¼ºè°ƒ</h3><!-- prettier-ignore --><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token italic"><span class="token punctuation">*</span><span class="token content">è¿™ä¼šæ˜¯ æ–œä½“ çš„æ–‡å­—</span><span class="token punctuation">*</span></span><span class="token italic"><span class="token punctuation">_</span><span class="token content">è¿™ä¼šæ˜¯ æ–œä½“ çš„æ–‡å­—</span><span class="token punctuation">_</span></span><span class="token bold"><span class="token punctuation">**</span><span class="token content">è¿™ä¼šæ˜¯ ç²—ä½“ çš„æ–‡å­—</span><span class="token punctuation">**</span></span><span class="token bold"><span class="token punctuation">__</span><span class="token content">è¿™ä¼šæ˜¯ ç²—ä½“ çš„æ–‡å­—</span><span class="token punctuation">__</span></span><span class="token italic"><span class="token punctuation">_</span><span class="token content">ä½ ä¹Ÿ <span class="token bold"><span class="token punctuation">**</span><span class="token content">ç»„åˆ</span><span class="token punctuation">**</span></span> è¿™äº›ç¬¦å·</span><span class="token punctuation">_</span></span><span class="token strike"><span class="token punctuation">~~</span><span class="token content">è¿™ä¸ªæ–‡å­—å°†ä¼šè¢«æ¨ªçº¿åˆ é™¤</span><span class="token punctuation">~~</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ—è¡¨"><a class="header-anchor" href="#åˆ—è¡¨"></a>åˆ—è¡¨</h3><h4 id="æ— åºåˆ—è¡¨"><a class="header-anchor" href="#æ— åºåˆ—è¡¨"></a>æ— åºåˆ—è¡¨</h4><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> Item 1<span class="token list punctuation">-</span> Item 2  <span class="token list punctuation">-</span> Item 2a  <span class="token list punctuation">-</span> Item 2b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æœ‰åºåˆ—è¡¨"><a class="header-anchor" href="#æœ‰åºåˆ—è¡¨"></a>æœ‰åºåˆ—è¡¨</h4><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">1.</span> Item 1<span class="token list punctuation">1.</span> Item 2<span class="token list punctuation">1.</span> Item 3   <span class="token list punctuation">1.</span> Item 3a   <span class="token list punctuation">1.</span> Item 3b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ·»åŠ å›¾ç‰‡"><a class="header-anchor" href="#æ·»åŠ å›¾ç‰‡"></a>æ·»åŠ å›¾ç‰‡</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token url"><span class="token operator">!</span>[<span class="token content">GitHub Logo</span>](<span class="token url">/images/logo.png</span>)</span>Format: <span class="token url"><span class="token operator">!</span>[<span class="token content">Alt Text</span>](<span class="token url">url</span>)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="é“¾æ¥"><a class="header-anchor" href="#é“¾æ¥"></a>é“¾æ¥</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">http://github.com - è‡ªåŠ¨ç”Ÿæˆï¼<span class="token url">[<span class="token content">GitHub</span>](<span class="token url">http://github.com</span>)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="å¼•ç”¨"><a class="header-anchor" href="#å¼•ç”¨"></a>å¼•ç”¨</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">æ­£å¦‚ Kanye West æ‰€è¯´ï¼š<span class="token blockquote punctuation">></span> We're living the future so<span class="token blockquote punctuation">></span> the present is our past.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ†å‰²çº¿"><a class="header-anchor" href="#åˆ†å‰²çº¿"></a>åˆ†å‰²çº¿</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">å¦‚ä¸‹ï¼Œä¸‰ä¸ªæˆ–è€…æ›´å¤šçš„<span class="token hr punctuation">---</span>è¿å­—ç¬¦<span class="token hr punctuation">---</span>æ˜Ÿå·<span class="token hr punctuation">---</span>ä¸‹åˆ’çº¿<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è¡Œå†…ä»£ç "><a class="header-anchor" href="#è¡Œå†…ä»£ç "></a>è¡Œå†…ä»£ç </h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">æˆ‘è§‰å¾—ä½ åº”è¯¥åœ¨è¿™é‡Œä½¿ç”¨<span class="token code-snippet code keyword">`&lt;addr>`</span> æ‰å¯¹ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="ä»£ç å—"><a class="header-anchor" href="#ä»£ç å—"></a>ä»£ç å—</h3><p>ä½ å¯ä»¥åœ¨ä½ çš„ä»£ç ä¸Šé¢å’Œä¸‹é¢æ·»åŠ  <code>```</code> æ¥è¡¨ç¤ºä»£ç å—ã€‚</p><h4 id="è¯­æ³•é«˜äº®"><a class="header-anchor" href="#è¯­æ³•é«˜äº®"></a>è¯­æ³•é«˜äº®</h4><p>ä½ å¯ä»¥ç»™ä½ çš„ä»£ç å—æ·»åŠ ä»»ä½•ä¸€ç§è¯­è¨€çš„è¯­æ³•é«˜äº®</p><p>ä¾‹å¦‚ï¼Œç»™ ruby ä»£ç æ·»åŠ è¯­æ³•é«˜äº®ï¼š</p><pre><code><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string">'redcarpet'</span>markdown <span class="token operator">=</span> <span class="token constant">Redcarpet</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span>puts markdown<span class="token punctuation">.</span>to_html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></code></pre><p>ä¼šå¾—åˆ°ä¸‹é¢çš„æ•ˆæœï¼š</p><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string">'redcarpet'</span>markdown <span class="token operator">=</span> <span class="token constant">Redcarpet</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span>puts markdown<span class="token punctuation">.</span>to_html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="ä»»åŠ¡åˆ—è¡¨"><a class="header-anchor" href="#ä»»åŠ¡åˆ—è¡¨"></a>ä»»åŠ¡åˆ—è¡¨</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> [x] @mentions, #refs, [links](), <span class="token bold"><span class="token punctuation">**</span><span class="token content">formatting</span><span class="token punctuation">**</span></span>, and <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>del</span><span class="token punctuation">></span></span>tags<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>del</span><span class="token punctuation">></span></span> supported<span class="token list punctuation">-</span> [x] list syntax required (any unordered or ordered list supported)<span class="token list punctuation">-</span> [x] this is a complete item<span class="token list punctuation">-</span> [ ] this is an incomplete item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è¡¨æ ¼"><a class="header-anchor" href="#è¡¨æ ¼"></a>è¡¨æ ¼</h3><!-- prettier-ignore --><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token table"><span class="token table-header-row"><span class="token table-header important">First Header </span><span class="token punctuation">|</span><span class="token table-header important"> Second Header</span></span><span class="token table-line"><span class="token punctuation">------------</span> <span class="token punctuation">|</span> <span class="token punctuation">-------------</span></span><span class="token table-data-rows"><span class="token table-data">Content from cell 1 </span><span class="token punctuation">|</span><span class="token table-data"> Content from cell 2</span><span class="token table-data">Content in the first column </span><span class="token punctuation">|</span><span class="token table-data"> Content in the second column</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ‰©å±•çš„è¯­æ³•"><a class="header-anchor" href="#æ‰©å±•çš„è¯­æ³•"></a>æ‰©å±•çš„è¯­æ³•</h2><h3 id="ä¸Šæ ‡"><a class="header-anchor" href="#ä¸Šæ ‡"></a>ä¸Šæ ‡</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">30^th^<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ä¸‹æ ‡"><a class="header-anchor" href="#ä¸‹æ ‡"></a>ä¸‹æ ‡</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">H<span class="token strike"><span class="token punctuation">~</span><span class="token content">2</span><span class="token punctuation">~</span></span>O<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="è„šæ³¨"><a class="header-anchor" href="#è„šæ³¨"></a>è„šæ³¨</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">Content [^1]<span class="token url-reference url"><span class="token punctuation">[</span><span class="token variable">^1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Hi!</span> This is a footnote<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="ç¼©ç•¥"><a class="header-anchor" href="#ç¼©ç•¥"></a>ç¼©ç•¥</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token italic"><span class="token punctuation">_</span><span class="token content">[HTML]: Hyper Text Markup Language</span><span class="token punctuation">_</span></span><span class="token url-reference url"><span class="token punctuation">[</span><span class="token variable">W3C</span><span class="token punctuation">]</span><span class="token punctuation">:</span> World</span> Wide Web ConsortiumThe HTML specificationis maintained by the W3C.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ ‡è®°"><a class="header-anchor" href="#æ ‡è®°"></a>æ ‡è®°</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">==marked==<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="CriticMarkup"><a class="header-anchor" href="#CriticMarkup"></a>CriticMarkup</h3><p>CriticMarkup ç¼ºçœæ˜¯ç¦ç”¨çš„ï¼Œä½ å¯ä»¥é€šè¿‡æ’ä»¶è®¾ç½®æ¥å¯åŠ¨å®ƒã€‚<br>æœ‰å…³ CriticMarkup çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ <a href="http://criticmarkup.com/users-guide.php">CriticMarkup ç”¨æˆ·æŒ‡å—</a>.</p><p>è¿™é‡Œæœ‰ 5 ç§åŸºæœ¬è¯­æ³•ï¼š</p><ul><li>æ·»åŠ  <code>&#123;++ ++&#125;</code></li><li>åˆ é™¤ <code>&#123;-- --&#125;</code></li><li>æ›¿æ¢ <code>&#123;~~ ~&gt; ~~&#125;</code></li><li>æ³¨é‡Š <code>&#123;&gt;&gt; &lt;&lt;&#125;</code></li><li>é«˜äº® <code>&#123;== ==&#125;&#123;&gt;&gt; &lt;&lt;&#125;</code></li></ul><blockquote><p>CriticMarkup ä»…å¯ç”¨äº markdown-it parserï¼Œä¸ä¸ pandoc parser å…¼å®¹ã€‚</p></blockquote><h2 id="å‚è€ƒ"><a class="header-anchor" href="#å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://guides.github.com/features/mastering-markdown/">Mastering Markdown</a></li><li><a href="https://daringfireball.net/projects/markdown/basics">Daring Fireball: Markdown Basics</a></li></ul><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> <span class="token url">[<span class="token content">Mastering Markdown</span>](<span class="token url">https://guides.github.com/features/mastering-markdown/</span>)</span><span class="token list punctuation">-</span> <span class="token url">[<span class="token content">Daring Fireball: Markdown Basics</span>](<span class="token url">https://daringfireball.net/projects/markdown/basics</span>)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>å‚è€ƒæ–‡æ¡£</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> markdown </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdownæ¨¡æ¿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå†…å­˜æ¨¡å‹</title>
      <link href="2017/06/19/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/11.java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"/>
      <url>2017/06/19/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/11.java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h1>javaå†…å­˜æ¨¡å‹</h1><ul><li>jvmå†…å­˜æ¨¡å‹<br>jvmè™šæ‹Ÿæœºä¸­é—´å†…å­˜åˆ’åˆ†ä¸ºï¼š</li></ul><ol><li>å †åŒº</li><li>è™šæ‹Ÿæœºæ ˆåŒº</li><li>æ–¹æ³•åŒº</li><li>æœ¬åœ°æ–¹æ³•æ ˆ</li><li>ç¨‹åºè®¡æ•°å™¨</li><li>è¿è¡Œæ—¶å¸¸é‡</li></ol><ul><li>javaå†…å­˜æ¨¡å‹<br><strong>javaå†…å­˜æ¨¡å‹</strong>æ˜¯javaçš„è§„èŒƒï¼Œå®šä¹‰äº†è¯­ä¹‰åˆ°å®ç°çš„è§„èŒƒã€‚ä¸»è¦æœ‰<strong>é‡æ’åº</strong>ã€<strong>åŸå­æ€§</strong>ã€<strong>å†…å­˜å¯è§æ€§</strong></li></ul><h2 id="é‡æ’åº"><a class="header-anchor" href="#é‡æ’åº"></a>é‡æ’åº</h2><p>æŒ‡ä»¤é‡æ’åºæ˜¯é€šè¿‡å‡å°‘æ‰§è¡ŒæŒ‡ä»¤ï¼Œæ¥æé«˜æ•´ä½“è¿è¡Œé€Ÿåº¦ã€‚ä¸»è¦æœ‰ä¸‰ä¸ªåœ°æ–¹ï¼š</p><ol><li>ç¼–è¯‘å™¨ä¼˜åŒ–</li><li>cpué‡æ’åº</li><li>å†…å­˜é‡æ’åº</li></ol><h2 id="åŸå­æ“ä½œ"><a class="header-anchor" href="#åŸå­æ“ä½œ"></a>åŸå­æ“ä½œ</h2><p>javaä¸­åŸå­æ“ä½œæœ‰å“ªäº›ï¼Ÿ</p><ol><li>é™¤longå’Œdoubleä¹‹å¤–çš„åŸºæœ¬ç±»å‹</li><li>æ‰€æœ‰referenceçš„è¯»å†™</li><li>ç”¨volatileä¿®é¥°åçš„å˜é‡è¯»å†™</li><li>j.u.cåŒ…ä¸‹çš„åŸå­ç±»</li></ol><h2 id="å†…å­˜çš„å¯è§æ€§"><a class="header-anchor" href="#å†…å­˜çš„å¯è§æ€§"></a>å†…å­˜çš„å¯è§æ€§</h2><p>å†…å­˜çš„å¯è§æ€§æŒ‡çš„æ˜¯ï¼Œå½“å‰çº¿ç¨‹ä¿®æ”¹å†…å­˜ä¸­çš„å€¼ä»¥åä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜æ¨¡å‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹åä½œ</title>
      <link href="2017/06/12/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/10.%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/"/>
      <url>2017/06/12/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/10.%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1>çº¿ç¨‹åä½œ</h1><p>çº¿ç¨‹ä¹‹é—´ç›¸äº’åä½œ</p><h2 id="ä¿¡å·é‡"><a class="header-anchor" href="#ä¿¡å·é‡"></a>ä¿¡å·é‡</h2><p>çº¿ç¨‹ï¼ˆsemaphoreï¼‰ä¹‹é—´ä¿¡å·é‡çš„ä½œç”¨æ˜¯äºæ ‡è®°å½“å‰èµ„æºèƒ½å¦è¢«çº¿ç¨‹è®¿é—®çš„ä¿¡å·ã€‚çº¿ç¨‹è®¿é—®èµ„æºæ—¶å°è¯•ç”¨<strong>acquire</strong>ï¼Œè®¿é—®å®Œæˆä½¿ç”¨<strong>release</strong>å½’è¿˜èµ„æº</p><h2 id="countDownLatch"><a class="header-anchor" href="#countDownLatch"></a>countDownLatch</h2><p><strong>countDownLatch</strong>çš„ä½œç”¨æ˜¯å¤šçº¿ç¨‹ä¹‹é—´çš„å€’è®¡æ—¶å™¨ï¼Œç”¨äºå¤šçº¿ç¨‹ä¹‹é—´çš„åä½œã€‚æœ‰ä¸¤ç§ç”¨æ³•ï¼š</p><ol><li>ä¸»çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹è¿è¡Œå®Œæ¯•åæ‰§è¡Œ</li><li>å…¶ä»–çº¿ç¨‹ç­‰å¾…ä¸»çº¿ç¨‹è¿è¡Œå®Œæ¯•åæ‰§è¡Œ</li></ol><ul><li>æ¼”ç¤ºä»£ç </li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹_%s"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CountDownLatch</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%så¼€å§‹æ‰§è¡Œ..."</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                count<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        count<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"æ‰§è¡Œå®Œæ¯•..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>````<span class="token operator">!</span><span class="token punctuation">[</span>GZRSF1<span class="token punctuation">.</span>png<span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>s1<span class="token punctuation">.</span>ax1x<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">03</span><span class="token operator">/</span><span class="token number">29</span><span class="token operator">/</span>GZRSF1<span class="token punctuation">.</span>png<span class="token punctuation">)</span>## <span class="token class-name">CyclicBarriar</span><span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CyclicBarriar</span><span class="token operator">*</span><span class="token operator">*</span>æ˜¯ä¸€ç»„çº¿ç¨‹åˆ°è¾¾æŸä¸ªçŠ¶æ€åæ‰å¼€å§‹æ‰§è¡Œ<span class="token punctuation">,</span>ä¸<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CountDownLatch</span><span class="token operator">*</span><span class="token operator">*</span>ä¸åŒã€‚<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CountDownLatch</span><span class="token operator">*</span><span class="token operator">*</span>æ˜¯è¾¾åˆ°count<span class="token operator">=</span><span class="token number">0</span>ä»¥åå¼€å§‹æ‰§è¡Œï¼Œæ˜¯ä½œç”¨äº<span class="token operator">*</span><span class="token operator">*</span>äº‹ä»¶<span class="token operator">*</span><span class="token operator">*</span>é©±åŠ¨ã€‚<span class="token operator">*</span><span class="token operator">*</span><span class="token class-name">CyclicBarriar</span><span class="token operator">*</span><span class="token operator">*</span>æ˜¯çº¿ç¨‹é©±åŠ¨ï¼Œ<span class="token class-name">N</span>ä¸ªçº¿ç¨‹åˆ°è¾¾<span class="token operator">*</span><span class="token operator">*</span>wait<span class="token operator">*</span><span class="token operator">*</span>çš„çŠ¶æ€ç»Ÿä¸€å¼€å§‹æ‰§è¡Œã€‚<span class="token operator">-</span> <span class="token class-name">CyclicBarriar</span>æ¼”ç¤ºä»£ç ```java<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CyclicBarriarDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹_%s"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> finalI1 <span class="token operator">=</span> i<span class="token punctuation">;</span>            threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span> msg1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s]-å°è€é¼ [%d]å¼€å§‹å‡ºæ´"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> finalI1<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Integer</span> sleepTime <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>sleepTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">String</span> msg2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s]-å°è€é¼ [%d]åˆ°è¾¾æŒ‡å®šåœ°ç‚¹"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> finalI1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg2<span class="token punctuation">)</span><span class="token punctuation">;</span>                    cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">String</span> msg3 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s]-å°è€é¼ [%d]åˆåŠ›è·å–åˆ°å¥¶é…ª(ğŸ§€)"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> finalI1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg3<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>æ‰§è¡Œç»“æœ<br><img src="https://s1.ax1x.com/2020/03/29/GZ57WR.png" alt="GZ57WR.png"></p></li><li><p>æœ‰å¯å§‹åŠ¨ä½œçš„æ–¹æ³•</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> msg1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s]-å‘ç°å¥¶é…ª(ğŸ§€)"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œç»“æœ</li></ul><p><img src="https://s1.ax1x.com/2020/03/29/GZIufs.png" alt="GZIufs.png"></p><h2 id="Condittion"><a class="header-anchor" href="#Condittion"></a>Condittion</h2><p><strong>Condittion</strong>èƒ½è®©ä¸åŒçº¿ç¨‹ä¹‹é—´ç›¸äº’åä½œï¼Œç­‰å¾…æ»¡è¶³æ¡ä»¶åç»§ç»­æ‰§è¡Œã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConditionDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ConditionDemo</span> conditionDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConditionDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span><span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                conditionDemo<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conditionDemo<span class="token punctuation">.</span><span class="token function">method0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":æ¡ä»¶æœªå‡†å¤‡å®Œæ¯•..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":å¼€å§‹æ‰§è¡Œ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":æ¡ä»¶å‡†å¤‡å®Œæ¯•..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Condition</strong>æ˜¯locké”æä¾›çš„ä¸€ç§å¯ä¾›çº¿ç¨‹ä¹‹é—´è¿›è¡Œäº¤äº’çš„ä¸€ç§æ–¹æ³•ã€‚ç”±äº<strong>signal</strong>åº•å±‚ä¼šä½¿ç”¨åˆ°å½“å‰çº¿ç¨‹å’Œlocké”çš„æŒæœ‰çº¿ç¨‹è¿›è¡Œå¯¹æ¯”ï¼Œç›¸ç­‰æ‰ä¼šè¿›è¡Œå”¤é†’å…¶ä»–çº¿ç¨‹ã€‚</p><h1>æ€»ç»“</h1><ul><li><p><strong>semaphore</strong><br>ä¿¡å·é‡çš„ä½œç”¨æ˜¯åªæœ‰è·å¾—ä¿¡å·é‡çš„çº¿ç¨‹æ‰èƒ½<strong>æ‰§è¡Œ</strong>ï¼Œå…¶ä½™çº¿ç¨‹åªèƒ½ç­‰å¾…æŒæœ‰ä¿¡å·é‡çš„çº¿ç¨‹é‡Šæ”¾åæ‰æœ‰æœºä¼šæ‰§è¡Œã€‚</p></li><li><p><strong>countDownLatch</strong>æ˜¯ç­‰å¾…ä¸€ç»„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åç­‰å¾…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œï¼Œæ˜¯äº‹ä»¶è§¦å‘</p></li><li><p><strong>CyclicBarriar</strong>æ˜¯ä¸€ç»„çº¿ç¨‹åˆ°è¾¾**wait()**çŠ¶æ€ä»¥åæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œï¼Œè§¦å‘åŠ¨ä½œæ˜¯è®¾å®šçš„ä¸€ç»„çº¿ç¨‹éƒ½åˆ°è¾¾æŸä¸ªä¸´ç•ŒçŠ¶æ€ï¼Œå¹¶ä¸”å¯è¢«å¤ç”¨ï¼Œ</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹åä½œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Futrueåˆæ¢</title>
      <link href="2017/05/19/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/9.Futrue%E5%88%9D%E6%8E%A2/"/>
      <url>2017/05/19/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/9.Futrue%E5%88%9D%E6%8E%A2/</url>
      
        <content type="html"><![CDATA[<h1>Futrueåˆæ¢</h1><h2 id="Runnableå’ŒCallableçš„åŒºåˆ«ï¼Ÿ"><a class="header-anchor" href="#Runnableå’ŒCallableçš„åŒºåˆ«ï¼Ÿ"></a>Runnableå’ŒCallableçš„åŒºåˆ«ï¼Ÿ</h2><p><strong>Runnable</strong>æ˜¯ä¸€ä¸ªæ— è¿”å›å€¼ï¼Œå¹¶ä¸”ä¸èƒ½checked Exceptionçš„ä»»åŠ¡ã€‚javaä¸­ä¹‹æ‰€ä»¥è¿™æ ·å®ç°æ˜¯å› ä¸ºæ‰§è¡ŒRunnableæ–¹æ³•æ˜¯è°ƒç”¨çš„Threa.run()æ–¹æ³•ï¼Œä¸æ˜¯å½“å‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥å°±ç®—æŠ›å‡ºå¼‚å¸¸æˆ‘ä»¬ä¹Ÿæ— æ³•æ•æ‰åˆ°ï¼›</p><p><strong>Callable</strong>æ–¹æ³•å®šä¹‰çš„æ˜¯ä¸€ä¸ªæœ‰è¿”å›å€¼å¹¶ä¸”å¯æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ï¼Œåº•å±‚é‡‡ç”¨çš„æ˜¯<strong>submit()<strong>æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯</strong>Futrue<T></strong>ï¼Œä¼šç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è¿”å›å€¼</p><h2 id="Futrueçš„ä¸»è¦åŠŸèƒ½ï¼Ÿ"><a class="header-anchor" href="#Futrueçš„ä¸»è¦åŠŸèƒ½ï¼Ÿ"></a>Futrueçš„ä¸»è¦åŠŸèƒ½ï¼Ÿ</h2><blockquote><p>Futrueæ¥å£</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>        <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è·å–è¿”å›å€¼</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> futures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> future  <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        futures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    futures<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>e <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>checked Exception</li><li>å–æ¶ˆä»»åŠ¡</li><li>åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæ¯•</li></ul><h2 id="Futrueçš„æ³¨æ„ç‚¹"><a class="header-anchor" href="#Futrueçš„æ³¨æ„ç‚¹"></a>Futrueçš„æ³¨æ„ç‚¹?</h2><ol><li>**Futrue.get()**æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œåœ¨éå†Futrueæ—¶æ³¨æ„ä¼šæ–¹æ³•æ˜¯é˜»å¡çš„å»è·å–ä¸åŒçº¿ç¨‹çš„è¿”å›å€¼çš„ï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨get(timeout)çš„æ–¹å¼</li><li>Futrueæœ¬èº«å¹¶æ²¡æœ‰äº§ç”Ÿæ–°çš„çº¿ç¨‹ï¼Œè¿™é‡Œæ˜¯åˆ©ç”¨Threaæˆ–è€…çº¿ç¨‹æ± çš„æŠ€æœ¯æ¥æ‰§è¡Œä»»åŠ¡çš„</li></ol><h2 id="æ¼”ç¤ºä»£ç "><a class="header-anchor" href="#æ¼”ç¤ºä»£ç "></a>æ¼”ç¤ºä»£ç </h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> set <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tasks <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> task <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span><span class="token punctuation">&#123;</span>            <span class="token keyword">double</span> val <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  execute...val:"</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> task0 <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> task1 <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> task2 <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> task <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>task0<span class="token punctuation">,</span>task1<span class="token punctuation">,</span>task2<span class="token punctuation">)</span><span class="token punctuation">;</span>    task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    set<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>e <span class="token operator">-></span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é€šè¿‡<strong>Collections.synchronizedSet</strong>è·å–åˆ°å¹¶å‘å®‰å…¨çš„set,åˆ©ç”¨<strong>Completable.runAsync</strong>æ‰§è¡Œä»»åŠ¡å¹¶å°†ç»“æœå†™å…¥setä¸­ï¼Œ<strong>Futureé˜Ÿåˆ—</strong>è¿›è¡Œç­‰å¾…ï¼Œå®šæ—¶ç­‰å¾…ç»“æŸï¼Œè·å–ç»“æœã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Futrue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThreadLocalçš„åˆ†æ</title>
      <link href="2017/05/09/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/8.Thread%E7%9A%84%E5%88%86%E6%9E%90/"/>
      <url>2017/05/09/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/8.Thread%E7%9A%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>ThreadLocalçš„åˆ†æ</h1><h2 id="ThreadLocalçš„é€‚ç”¨åœºæ™¯"><a class="header-anchor" href="#ThreadLocalçš„é€‚ç”¨åœºæ™¯"></a>ThreadLocalçš„é€‚ç”¨åœºæ™¯</h2><ul><li><strong>ThreadLocal</strong>é€‚ç”¨äºä¿å­˜æ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬äº«çš„å¯¹è±¡</li><li><strong>ThreadLocal</strong>é€‚ç”¨äºä¿å­˜æ¯ä¸ªçº¿ç¨‹ç‹¬äº«çš„å¯¹è±¡å¯ä¾›å…¶ä»–æ–¹æ³•è·å–çš„åœºæ™¯<br>ä¾‹å¦‚webåº”ç”¨ç¨‹åºä¸­çš„ç”¨æˆ·ä¿¡æ¯å¯ä»¥ä¿å­˜ä¸­ç”¨çº¿ç¨‹ä¸­ï¼Œä»è€Œåœ¨å…¶ä»–éœ€è¦ç”¨åˆ°çš„åœ°æ–¹ç›´æ¥å¯ä»¥è·å–åˆ°</li></ul><h2 id="ThreadLocalæ˜¯ä¸æ˜¯ç”¨æ¥è§£å†³å…±äº«èµ„æºå¤šçº¿ç¨‹è®¿é—®çš„ï¼Ÿ"><a class="header-anchor" href="#ThreadLocalæ˜¯ä¸æ˜¯ç”¨æ¥è§£å†³å…±äº«èµ„æºå¤šçº¿ç¨‹è®¿é—®çš„ï¼Ÿ"></a>ThreadLocalæ˜¯ä¸æ˜¯ç”¨æ¥è§£å†³å…±äº«èµ„æºå¤šçº¿ç¨‹è®¿é—®çš„ï¼Ÿ</h2><ul><li>ä¸æ˜¯ï¼ŒThreadLocalçš„åº•å±‚æœºåˆ¶å†³å®šäº†æ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬ç«‹æ‹¥æœ‰ä¸€ä»½ç©ºé—´æ¥å­˜æ”¾æ•°æ®ã€‚è™½ç„¶åœ¨æ•ˆæœä¸Šçº¿ç¨‹å®‰å…¨çš„ï¼Œä½†è¿™å¹¶ä¸æ˜¯é€šè¿‡è§£å†³å…±äº«èµ„æºçš„æ–¹å¼å®ç°çš„ã€‚</li></ul><h2 id="åº•å±‚åŸç†"><a class="header-anchor" href="#åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h2><p>æ¯ä¸€ä¸ª<strong>Thread</strong>å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª<strong>ThreadLocalMap</strong>å¯¹è±¡ï¼Œåœ¨<strong>ThreadLocalMap</strong>ä¸­æœ‰ä¿å­˜çš„æ˜¯<strong>ThreadLocal</strong>ä½œä¸ºkeyï¼Œå€¼ä½œä¸ºvalueçš„k-vç»“æ„</p><blockquote><p>ThreadLocal.get()</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>this</strong>å°±æ˜¯ThreadLocalï¼Œå› ä¸ºThreadLocalMapä¸­çš„keyå°±æ˜¯ThreadLocal,å› æ­¤é€šè¿‡getEntry(this)çš„æ–¹å¼å–åˆ°å¯¹åº”çš„å€¼</p><blockquote><p>Thread.getMap()</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */</span><span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">/* * InheritableThreadLocal values pertaining to this thread. This map is * maintained by the InheritableThreadLocal class. */</span><span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//InheritableThreadLocal</span><span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> t<span class="token punctuation">.</span>inheritableThreadLocals<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>getMap()å°±æ˜¯è·å–<strong>Thread</strong>çš„æˆå‘˜å˜é‡<strong>threadLocals</strong>ã€<strong>inheritableThreadLocals</strong></p><ul><li>ThreadLocalMap<br><strong>ThreadLocalMap</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** The value associated with this ThreadLocal. */</span>    <span class="token class-name">Object</span> value<span class="token punctuation">;</span>    <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>        value <span class="token operator">=</span> v<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Entryæ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç±»ä¼¼äºmapç»“æ„ã€‚Entryè¿™é‡Œä¸æ˜¯é‡‡ç”¨HashMapçš„<strong>æ‹‰é“¾æ³•</strong>è€Œæ˜¯é‡‡ç”¨çš„æ˜¯<strong>çº¿æ€§æ¢æµ‹æ³•</strong><br><strong>çº¿æ€§æ¢æµ‹æ³•</strong>åŸç†å¦‚ä¸‹ï¼š<br><img src="https://s2.ax1x.com/2020/03/09/89Hm0e.png" alt="89Hm0e.png"></p><h2 id="ThreadLocal-remove"><a class="header-anchor" href="#ThreadLocal-remove"></a>ThreadLocal.remove</h2><p><strong>ThreadLocal.remove</strong>æ–¹æ³•ã€‚åœ¨çº¿ç¨‹ä¸ä½¿ç”¨ThreadLocalä¹‹åå¿…é¡»è¿›è¡Œ<strong>remove</strong>æ“ä½œï¼Œå› ä¸ºåœ¨ThreadLocalMapä¸­k-væ˜¯å¼ºå¼•ç”¨å…³ç³»ï¼Œä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚å› æ­¤åœ¨ä¸ä½¿ç”¨ThreaLocalä¹‹åä¸€å®šè¦è¿›è¡Œremoveæ“ä½œ</p><h2 id="InheritableThreadLocal"><a class="header-anchor" href="#InheritableThreadLocal"></a>InheritableThreadLocal</h2><p><strong>InheritableThreadLocal</strong>æ˜¯å­çº¿ç¨‹èƒ½è®¿é—®åˆ°çˆ¶çº¿ç¨‹çš„ThreadLoca</p><blockquote><p>Thread.init()</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>inheritThreadLocals <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">=</span>        <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">createInheritedMap</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>inheritableThreadLocals<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨çº¿ç¨‹åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œä¼šåˆ¤æ–­çˆ¶çº¿ç¨‹ä¸­çš„<strong>inheritableThreadLocals</strong>æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ä¼šå°†å€¼èµ‹ç»™å­çº¿ç¨‹</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Thread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸå­ç±»çš„åˆ†æ</title>
      <link href="2017/04/08/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/7.%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%9A%84%E5%88%86%E6%9E%90/"/>
      <url>2017/04/08/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/7.%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%9A%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1>åŸå­ç±»çš„åˆ†æ</h1><h2 id="åŸå­ç±»æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#åŸå­ç±»æ˜¯ä»€ä¹ˆï¼Ÿ"></a>åŸå­ç±»æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åŸå­ç±»æ˜¯æ“ä½œè¦ä¹ˆæ˜¯æˆåŠŸè¦ä¹ˆæ˜¯å¤±è´¥ï¼Œä¸èƒ½è¢«ä¸­æ–­çš„ç±»ã€‚åœ¨javaä¸­æ˜¯åœ¨<strong>java.util.concurrent.atomic</strong>ä¸‹ã€‚ä¸é”å¯¹æ¯”</p><ul><li>ç²’åº¦æ›´ç»†</li><li>æ•ˆç‡æ›´é«˜</li></ul><h2 id="åŸå­ç±»æœ‰å“ªäº›ï¼Ÿ"><a class="header-anchor" href="#åŸå­ç±»æœ‰å“ªäº›ï¼Ÿ"></a>åŸå­ç±»æœ‰å“ªäº›ï¼Ÿ</h2><table><thead><tr><th>åˆ†ç±»</th><th>ç±»å</th></tr></thead><tbody><tr><td>Atomic* åŸºæœ¬ç±»å‹åŸå­ç±»</td><td>AtomicIntegerã€AtomicLongã€AtomicBoolean</td></tr><tr><td>Atomic*Array æ•°ç»„åŸå­ç±»</td><td>AtomicIntgerArrayã€AtomicLongArrayã€AtoimcReferenceArray</td></tr><tr><td>Atomic*Reference å¼•ç”¨ç±»å‹</td><td>AtomicReferenceã€AtomicStampedReferenceã€AtomicMarkableReference</td></tr><tr><td>Atomic*FieldUpdater å‡çº§ç±»å‹åŸå­ç±»</td><td>AtomicIntegerfieldupdaterã€AtomicLongFieldUpdaterã€AtomicReferenceFieldUpdater</td></tr><tr><td>Adder ç´¯åŠ å™¨</td><td>LongAdderã€DoubleAdder</td></tr><tr><td>Accumulator ç§¯ç´¯å™¨</td><td>LongAccumulatorã€DoubleAccumulator</td></tr></tbody></table><h3 id="Atomic-åŸºæœ¬ç±»å‹åŸå­ç±»"><a class="header-anchor" href="#Atomic-åŸºæœ¬ç±»å‹åŸå­ç±»"></a>Atomic* åŸºæœ¬ç±»å‹åŸå­ç±»</h3><p>Atomic* åŸºæœ¬åŸå­ç±»ï¼Œä¸»è¦æ˜¯AtomicIntegerã€AtomicLongã€AtomicBoolean<br><strong>AtomicInteger</strong> ç±»å¸¸ç”¨æ–¹æ³•</p><ul><li>public final int get() //è·å–å½“å‰çš„å€¼</li><li>public final int getAndSet(int newValue) //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</li><li>public final int getAndIncrement() //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</li><li>public final int getAndDecrement() //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</li><li>public final int getAndAdd(int delta) //è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</li></ul><h3 id="Atomic-Array-æ•°ç»„ç±»å‹åŸå­ç±»"><a class="header-anchor" href="#Atomic-Array-æ•°ç»„ç±»å‹åŸå­ç±»"></a>Atomic*Array æ•°ç»„ç±»å‹åŸå­ç±»</h3><p>Atomic*Array æ•°ç»„ç±»å‹åŸå­ç±»ï¼Œæ•°ç»„é‡Œçš„å…ƒç´ ï¼Œéƒ½å¯ä»¥ä¿è¯å…¶åŸå­æ€§ï¼Œæ¯”å¦‚ AtomicIntegerArray ç›¸å½“äºæŠŠ AtomicInteger èšåˆèµ·æ¥ï¼Œç»„åˆæˆä¸€ä¸ªæ•°ç»„ã€‚ä¸»è¦æ˜¯<strong>AtomicIntegerArray</strong>ï¼šæ•´å½¢æ•°ç»„åŸå­ç±»ã€<strong>AtomicLongArray</strong>ï¼šé•¿æ•´å½¢æ•°ç»„åŸå­ç±»ã€<strong>AtomicReferenceArray</strong>ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</p><h3 id="Atomic-Reference-å¼•ç”¨ç±»å‹åŸå­ç±»"><a class="header-anchor" href="#Atomic-Reference-å¼•ç”¨ç±»å‹åŸå­ç±»"></a>Atomic*Reference å¼•ç”¨ç±»å‹åŸå­ç±»</h3><ul><li><strong>AtomicReference å¼•ç”¨ç±»å‹åŸå­ç±»</strong>,å¯ä»¥è®©ä¸€ä¸ªå¯¹è±¡ä¿è¯åŸå­æ€§ã€‚</li><li><strong>AtomicStampedReference</strong>ï¼šå®ƒæ˜¯å¯¹ AtomicReference çš„å‡çº§ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åŠ äº†æ—¶é—´æˆ³ï¼Œç”¨äºè§£å†³ CAS çš„ ABA é—®é¢˜</li><li><strong>AtomicMarkableReference</strong> å’ŒAtomicReferenceç±»ä¼¼ï¼Œä½†æ˜¯å¤šä¸€ä¸ªbooleanç±»å‹å¯ä»¥ç”¨æ¥æ ‡è®°æ˜¯å¦åˆ é™¤äº†å¯¹è±¡</li></ul><h3 id="Atomic-FieldUpdater-åŸå­æ›´æ–°å™¨"><a class="header-anchor" href="#Atomic-FieldUpdater-åŸå­æ›´æ–°å™¨"></a>Atomic*FieldUpdater åŸå­æ›´æ–°å™¨</h3><ul><li>AtomicIntegerFieldUpdaterï¼šåŸå­æ›´æ–°æ•´å½¢çš„æ›´æ–°å™¨</li><li>AtomicLongFieldUpdaterï¼šåŸå­æ›´æ–°é•¿æ•´å½¢çš„æ›´æ–°å™¨ï¼›</li><li>AtomicReferenceFieldUpdaterï¼šåŸå­æ›´æ–°å¼•ç”¨çš„æ›´æ–°å™¨ã€‚<br>å¯ä»¥å°†ä¸€ä¸ªåŸæœ¬ä¸å…·æœ‰åŸå­ç±»æ“ä½œçš„ç±»å‹å‡çº§æˆä¸ºä¸€ä¸ªå…·æœ‰åŸå­çš„ç±»ã€‚</li></ul><h3 id="Adder-åŠ æ³•å™¨"><a class="header-anchor" href="#Adder-åŠ æ³•å™¨"></a>Adder åŠ æ³•å™¨</h3><ul><li>LongAdder</li><li>DubleAdder</li></ul><h3 id="Accumulator-ç§¯ç´¯å™¨"><a class="header-anchor" href="#Accumulator-ç§¯ç´¯å™¨"></a>Accumulator ç§¯ç´¯å™¨</h3><ul><li>LongAccumulator</li><li>DoubleAccumulator</li></ul><h2 id="åº•å±‚åŸç†"><a class="header-anchor" href="#åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h2><p>ç”¨AtomicIntgerç±»æ¥åˆ†æ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">+</span> delta<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç”¨çš„æ˜¯<strong>unsafe.getAndAddInt</strong>æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªè°ƒç”¨ç¡¬ä»¶è¿›è¡ŒCASçš„æ–¹æ³•ï¼Œé€šè¿‡è‡ªæ—‹å’ŒCASä¿è¯äº†å¹¶å‘çš„å®‰å…¨æ€§</p><h2 id="AtomicIntgeråœ¨é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½é—®é¢˜"><a class="header-anchor" href="#AtomicIntgeråœ¨é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½é—®é¢˜"></a>AtomicIntgeråœ¨é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½é—®é¢˜</h2><p><strong>AtomicIntger</strong>åº•å±‚æ˜¯ç”¨ä¸€ä¸ª<strong>volatile</strong>è¿›è¡Œä¿®é¥°äº†ï¼Œå› æ­¤åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹ä¼šä¸æ–­çš„è¿›è¡Œ<strong>flush</strong>ã€<strong>reflush</strong>ã€‚<br>å› æ­¤<strong>LongAdder</strong>æ˜¯æ›´æ–°æ–¹æ¡ˆï¼Œé‡‡ç”¨çš„æ˜¯<strong>base</strong>åŠ <strong>call[/]<strong>ç”¨åˆ†æ®µçš„æ€æƒ³ï¼Œåœ¨å¹¶å‘æ¿€çƒˆçš„åœºæ™¯ä¸‹ä¼šåŠ çº¿ç¨‹éœ€è¦çš„èµ„æºåˆ†é…åˆ°ä¸åŒçš„callä¸­å»ï¼Œåœ¨éœ€è¦sumç­‰æ“ä½œæ—¶éå†</strong>call[]<strong>æ•°ç»„å’Œ</strong>base</strong>ä»è€Œå¾—å‡ºå€¼</p><h2 id="åŸå­ç±»å’Œvolatileçš„åŒºåˆ«"><a class="header-anchor" href="#åŸå­ç±»å’Œvolatileçš„åŒºåˆ«"></a>åŸå­ç±»å’Œvolatileçš„åŒºåˆ«</h2><p>åŸå­ç±»æ˜¯å¯¹ç±»çš„ä¸€ç³»åˆ—æ“ä½œè¿›è¡Œäº†å°è£…ï¼Œè®©è¿™ä¸€ç³»åˆ—çš„æ“ä½œæˆä¸ºä¸€ä¸ªåŸå­æ€§çš„åŠ¨ä½œã€‚volatileä¿®é¥°çš„å˜é‡æ˜¯åœ¨å†…å­˜æ¨¡å‹ä¸Šå¯¹å…¶ä»–çº¿ç¨‹é€æ˜ã€‚<br>ä¸¤è€…çš„é€‚ç”¨åœºæ™¯ä¹Ÿä¸ä¸€æ ·ï¼Œvolatileé€‚ç”¨äºå¯è§æ€§æ–¹é¢ï¼ŒåŸå­ç±»é€‚ç”¨äºå¯¹ä¸€ç³»åˆ—æ“ä½œå…·æœ‰çš„åŸå­æ€§çš„è¦æ±‚ã€‚</p><h2 id="LongAccumulator"><a class="header-anchor" href="#LongAccumulator"></a>LongAccumulator</h2><p><strong>LongAccumulator</strong>æ˜¯å¯¹<strong>longAdder</strong>çš„ä¸€ä¸ªå‡çº§ï¼Œæä¾›äº†è‡ªå®šä¹‰å‡½æ•°çš„åŠŸèƒ½ï¼Œæ„é€ å™¨å¦‚ä¸‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">LongAccumulator</span><span class="token punctuation">(</span><span class="token class-name">LongBinaryOperator</span> accumulatorFunction<span class="token punctuation">,</span>                       <span class="token keyword">long</span> identity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>function <span class="token operator">=</span> accumulatorFunction<span class="token punctuation">;</span>    base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>identity <span class="token operator">=</span> identity<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>LongBinaryOperator</strong>æ˜¯ä¸€ä¸ªå®ç°å€¼å¦‚ä½•å¤„ç†çš„ç±»</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LongBinaryOperator</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * Applies this operator to the given operands.     *     * @param left the first operand     * @param right the second operand     * @return the operator result     */</span>    <span class="token keyword">long</span> <span class="token function">applyAsLong</span><span class="token punctuation">(</span><span class="token keyword">long</span> left<span class="token punctuation">,</span> <span class="token keyword">long</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CountDownLatch</span> flag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LongAccumulator</span> accumulator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-></span> x <span class="token operator">+</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":executer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    accumulator<span class="token punctuation">.</span><span class="token function">accumulate</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    flag<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>flag<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>accumulator<span class="token punctuation">.</span><span class="token function">getThenReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œç»“æœï¼š<br><img src="https://s2.ax1x.com/2020/03/08/3zjqL8.png" alt="3zjqL8.png"></p><p>é€‚ç”¨åœºæ™¯ï¼š</p><ul><li>å¤§é‡çš„è®¡ç®—å¹¶ä¸”éœ€è¦å¹¶è¡Œè®¡ç®—</li><li>çº¿ç¨‹ä¹‹é—´æ‰§è¡Œä¸éœ€è¦é¡ºåºæ‰§è¡Œ</li></ul>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åŸå­ç±» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é˜»å¡é˜Ÿåˆ—</title>
      <link href="2017/04/07/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/6.%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97/"/>
      <url>2017/04/07/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/6.%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1>é˜»å¡é˜Ÿåˆ—</h1><h2 id="é˜»å¡é˜Ÿåˆ—çš„å®šä¹‰"><a class="header-anchor" href="#é˜»å¡é˜Ÿåˆ—çš„å®šä¹‰"></a>é˜»å¡é˜Ÿåˆ—çš„å®šä¹‰</h2><p><strong>é˜»å¡é˜Ÿåˆ—</strong>æ˜¯å®ç°äº†BlockingQueueæ¥å£çš„ä¹‹ç±»ï¼ŒBlockingQueueçš„ä»£ç å…¥ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>BlockingQueue</strong>çš„ç‰¹ç‚¹æ˜¯æœ‰é˜»å¡èƒ½åŠ›ï¼š</p><ol><li>**take()**çš„åŠŸèƒ½æ˜¯ç§»é™¤å¤´èŠ‚ç‚¹ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œåˆ™é˜»å¡</li><li>**put()**çš„åŠŸèƒ½æ˜¯å‘å¯¹ä½æ·»åŠ å…ƒç´ ï¼Œå½“é˜Ÿåˆ—æ»¡è½½æ—¶ï¼Œåˆ™é˜»å¡</li></ol><p>BlocakingQueueçš„å®ç°ç±»æœ‰ï¼š</p><ol><li>ArrayBlockingQueue</li><li>LinkedBlockingQueue</li><li>SynchronousQueue</li><li>DelayQueue</li><li>PriorityBlockingQueue</li><li>LinkedTransferQueue</li></ol><p><img src="https://s2.ax1x.com/2020/03/07/3jrGTI.png" alt="3jrGTI.png"></p><h2 id="é˜»å¡é˜Ÿåˆ—å¸¸ç”¨çš„æ–¹æ³•"><a class="header-anchor" href="#é˜»å¡é˜Ÿåˆ—å¸¸ç”¨çš„æ–¹æ³•"></a>é˜»å¡é˜Ÿåˆ—å¸¸ç”¨çš„æ–¹æ³•</h2><p>åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ä¸»è¦æœ‰8ç§æ–¹æ³•ï¼ŒæŒ‰ç…§åˆ†ç±»åˆ†ä¸º3å¤§ç±»ï¼š</p><ol><li><strong>æŠ›å‡ºå¼‚å¸¸</strong> addã€removeã€element</li><li><strong>è¿”å›ç»“æœä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸</strong> offerã€pollã€peek</li><li><strong>é˜»å¡</strong> putã€take</li></ol><table><thead><tr><th>åŠ¨ä½œ\å¤±è´¥å¤„ç†æ–¹å¼</th><th>æŠ›å‡ºå¼‚å¸¸</th><th>è¿”å›ç»“æœä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸</th><th>é˜»å¡</th></tr></thead><tbody><tr><td>æ·»åŠ å…ƒç´ </td><td>add</td><td>offer</td><td>put</td></tr><tr><td>ç§»é™¤å…ƒç´ </td><td>remove</td><td>poll</td><td>take</td></tr><tr><td>è¿”å›å¤´èŠ‚ç‚¹</td><td>element</td><td>peek</td><td>æ— </td></tr></tbody></table><h2 id="å¸¸è§çš„é˜»å¡é˜Ÿåˆ—"><a class="header-anchor" href="#å¸¸è§çš„é˜»å¡é˜Ÿåˆ—"></a>å¸¸è§çš„é˜»å¡é˜Ÿåˆ—</h2><ul><li>ArrayBlockingQueue<br><strong>ArrayBlockingQueue</strong>æ˜¯ä¸€ä¸ªå®¹é‡å›ºå®šçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</li></ul> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//çœç•¥ä»£ç ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>fair</strong>è¡¨ç¤ºé˜Ÿåˆ—æ˜¯å…¬å¹³çš„è¿˜æ˜¯ä¸å…¬å¹³çš„</p><ul><li>LinkBlockingQueue<br><strong>LinkedBlockingQueue</strong>æ˜¯ä¸€ä¸ªé»˜è®¤æ„é€ å™¨åˆ›å»ºçš„æ˜¯æ— ç•Œé˜»å¡é˜Ÿåˆ—ä¹Ÿå¯ä»¥æŒ‡å®šé˜Ÿåˆ—å®¹é‡ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>    last <span class="token operator">=</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>SynchronousQueue<br><strong>SynchronousQueue</strong>æ˜¯ä¸€ä¸ªå†…éƒ¨å®¹é‡ä¸º0çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¯æ¬¡å–æ•°æ®éƒ½è¦é˜»å¡ç­‰å¾…</p></li><li><p>PriorityBlockingQueue<br><strong>PriorityBlockingQueue</strong>æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„é˜»å¡é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ã€‚æ„é€ æ–¹æ³•</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>DelayQueue</li></ul><p><strong>DelayQueue</strong>æ˜¯ä¸€ä¸ªå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼Œæ„é€ å‡½æ•°ä¸ºï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">DelayQueue</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é˜»å¡é˜Ÿåˆ—å’Œéé˜»å¡é˜Ÿåˆ—å¹¶å‘å®‰å…¨çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#é˜»å¡é˜Ÿåˆ—å’Œéé˜»å¡é˜Ÿåˆ—å¹¶å‘å®‰å…¨çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>é˜»å¡é˜Ÿåˆ—å’Œéé˜»å¡é˜Ÿåˆ—å¹¶å‘å®‰å…¨çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id="ArrayBlockingQueue"><a class="header-anchor" href="#ArrayBlockingQueue"></a>ArrayBlockingQueue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** Main lock guarding all access */</span><span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span><span class="token comment">/** Condition for waiting takes */</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span><span class="token comment">/** Condition for waiting puts */</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span>            notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">enqueue</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å…±ç”¨åŒä¸€ä¸ªlockæ¥é”ä½é˜Ÿåˆ—åï¼Œç”¨é¦–å°¾ä¸¤ä¸ª<strong>Condition</strong>æ¥åˆ†åˆ«é”ä½é˜Ÿåˆ—</p><h3 id="ConcurrentLinkedQueue"><a class="header-anchor" href="#ConcurrentLinkedQueue"></a>ConcurrentLinkedQueue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> t <span class="token operator">=</span> tail<span class="token punctuation">,</span> p <span class="token operator">=</span> t<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// p is last node</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">// Successful CAS is the linearization point</span>                    <span class="token comment">// for e to become an element of this queue,</span>                    <span class="token comment">// and for newNode to become "live".</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> t<span class="token punctuation">)</span> <span class="token comment">// hop two nodes at a time</span>                        <span class="token function">casTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Failure is OK.</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// Lost CAS race to another thread; re-read next</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> q<span class="token punctuation">)</span>                <span class="token comment">// We have fallen off list.  If tail is unchanged, it</span>                <span class="token comment">// will also be off-list, in which case we need to</span>                <span class="token comment">// jump to head, from which all live nodes are always</span>                <span class="token comment">// reachable.  Else the new tail is a better bet.</span>                p <span class="token operator">=</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> t <span class="token operator">:</span> head<span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token comment">// Check for tail updates after two hops.</span>                p <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> t <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> t <span class="token operator">:</span> q<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥ä»æ–¹æ³•ä¸­çœ‹å‡ºofferæ–¹æ³•å°±æ˜¯ä¸åœçš„é‡è¯•åŠ ä¸ŠCASæœºåˆ¶ä¿è¯äº†å¹¶å‘çš„å®‰å…¨æ€§ï¼Œè¿™æ˜¯ä¹è§‚é”çš„ä¸€ç§æ€æƒ³ã€‚é€‚ç”¨ç”¨çº¿ç¨‹ç«äº‰ä¸æ¿€çƒˆçš„åœºæ™¯ã€‚</p><h2 id="å¦‚ä½•é€‰æ‹©é˜»å¡é˜Ÿåˆ—"><a class="header-anchor" href="#å¦‚ä½•é€‰æ‹©é˜»å¡é˜Ÿåˆ—"></a>å¦‚ä½•é€‰æ‹©é˜»å¡é˜Ÿåˆ—</h2><p>å¦‚ä½•é€‰æ‹©é˜»å¡é˜Ÿåˆ—å¯ä»¥ä¸­çº¿ç¨‹æ± æ¥è¿›è¡Œåˆ†æ</p><h3 id="LinkedBlockingQueue"><a class="header-anchor" href="#LinkedBlockingQueue"></a>LinkedBlockingQueue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>                            <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>                            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹å‡ºå›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± é‡‡ç”¨çš„æ˜¯æ— é™é•¿åº¦çš„é˜Ÿåˆ—ä½œä¸ºç¼“å­˜æ± </p><h3 id="SynchronousQueue"><a class="header-anchor" href="#SynchronousQueue"></a>SynchronousQueue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>                                  <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>                                  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ— æœ€å¤§çº¿ç¨‹æ•°çš„çº¿ç¨‹æ± é‡‡ç”¨çš„æ˜¯æ— å®¹é‡çš„é˜Ÿåˆ—åšä¸ºç¼“å­˜æ± </p><h3 id="DelayedWorkQueue"><a class="header-anchor" href="#DelayedWorkQueue"></a>DelayedWorkQueue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NANOSECONDS<span class="token punctuation">,</span>          <span class="token keyword">new</span> <span class="token class-name">DelayedWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å…·æœ‰å‘¨æœŸæ€§æ‰§è¡Œçš„çº¿ç¨‹æ± é‡‡ç”¨çš„æ˜¯å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä»è€Œå®ç°å‘¨æœŸæ€§æ‰§è¡Œçš„åŠŸèƒ½</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>å› æ­¤é€‰æ‹©é˜Ÿåˆ—ä¹Ÿåº”è¯¥ä»ä¸šåŠ¡çš„å±æ€§å‡ºå‘ï¼Œåœ¨è¿™å‡ ä¸ªæ–¹é¢è¿›è¡Œå–èˆ<strong>é•¿åº¦</strong>ã€<strong>ç‰¹ç‚¹</strong>ã€<strong>æ€§èƒ½</strong>ã€‚ä»è€Œé€‰æ‹©æœ€é€‚åˆä¸šåŠ¡åœºæ™¯çš„é˜Ÿåˆ—ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é˜»å¡é˜Ÿåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¹¶å‘å®¹å™¨</title>
      <link href="2017/03/27/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/5.%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/"/>
      <url>2017/03/27/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/5.%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1>å¹¶å‘å®¹å™¨</h1><p>æœ‰å…³å¹¶å‘çš„å®¹å™¨ï¼šHashMapã€ConcurrentHashMapã€CopyOnWriteArrayList</p><h2 id="HashMap"><a class="header-anchor" href="#HashMap"></a>HashMap</h2><p><strong>HashMap</strong>åœ¨å¹¶å‘åœºæ™¯æ—¶å€™å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>get()æ–¹æ³•åœ¨å®¹å™¨æ‰©å®¹æ—¶ï¼Œè·å–åˆ°çš„å€¼å¯èƒ½ä¼šä¸æ­£ç¡®ã€‚å› ä¸ºåœ¨æ‰©å®¹æ—¶å€™ï¼ŒhashMapæ²¡æœ‰ä¿è¯å®¹å™¨å®‰å…¨æ€§ï¼Œå¯èƒ½ä¼šå‡ºç°get()æ–¹æ³•è·å–åˆ°é•œåƒé“¾è¡¨ä¸Šï¼Œè€Œé•œåƒé“¾è¡¨æ­¤æ—¶å¹¶æ²¡æœ‰å€¼çš„æƒ…å†µ</li><li>put()æ–¹æ³•å¯èƒ½ä¼šé€ æˆå€¼æ¶ˆå¤±ï¼ˆè¿™ä¹Ÿæ˜¯map k-vçš„ç‰¹æ€§ï¼‰</li><li>å¯è§æ€§é—®é¢˜</li><li>æ­»å¾ªç¯cpuå ç”¨100%ã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰©å®¹æ—¶ï¼Œä¼šåè½¬æ•£åˆ—è¡¨çš„èŠ‚ç‚¹ï¼Œä¼šæœ‰æ­»é”åœºæ™¯ç›¸äº’ç­‰å¾…ã€‚</li></ol><h2 id="ConcurrentHashMap"><a class="header-anchor" href="#ConcurrentHashMap"></a>ConcurrentHashMap</h2><p><strong>ConcurrentHashMap</strong>åº•å±‚æ˜¯é‡‡ç”¨CAS+synchronizedçš„æ–¹å¼ï¼Œæ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ã€‚synchronizedä¿è¯å†™æ“ä½œæ—¶èµ„æºç«äº‰æ¿€çƒˆæƒ…å†µä¸‹çš„å®‰å…¨ç”¨CASæœºåˆ¶æ¥ä¿è¯å†™æ“ä½œä¸‹è½»é‡çº§çš„ç«äº‰çš„å®‰å…¨æ€§ã€‚</p><p>mapä¸­é“¾è¡¨çº¢é»‘æ ‘çš„è®¾è®¡ï¼šçº¢é»‘æ ‘åœ¨mapä¸­å±äºä¸€ç§ä¿åº•ï¼Œé˜²å¾¡æ€§çš„ç¼–ç¨‹æ–¹å¼ã€‚å½“hash()æ–¹æ³•è®¾è®¡è‰¯å¥½çš„æ—¶å€™ï¼Œæ•£åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯ç¬¦åˆæ³Šæ¾åˆ†å¸ƒï¼Œæ­¤æ—¶å¾ˆéš¾å‡ºç°çº¢é»‘æ ‘çš„æƒ…å†µï¼Œå¯èƒ½æ€§ä¸ºåƒä¸‡åˆ†ä¹‹ä¸€ï¼Œå½“å‡ºç°è¿™æ ·çš„æƒ…å†µæ—¶ã€‚é¦–å…ˆçœ‹å®¹é‡ï¼Œåœ¨è€ƒè™‘hash()æ–¹æ³•æ˜¯å¦è®¾è®¡è‰¯å¥½ã€‚8ä¸ªçš„é™åˆ¶æ˜¯åŸºäºç©ºé—´å’Œæ—¶é—´æƒè¡¡ä¸‹å¾—å‡ºçš„ã€‚</p><h2 id="CopyOnWriteArrayList"><a class="header-anchor" href="#CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h2><p><strong>CopyOnWriteArrayList</strong>æ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ—è¡¨ï¼Œé€‚åˆäºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œåˆ—å…¥å†…å­˜å­—å…¸ç­‰ã€‚<br>CopyOnWriteArrayListåº•å±‚æ˜¯é‡‡ç”¨__ReentrantLock__å’Œvolatileä¿®é¥°æ•°ç»„æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨æ€§çš„ã€‚<br>ç‰¹ç‚¹ï¼šå¯åœ¨è¿­ä»£å™¨ä¸­è¿›è¡Œä¿®æ”¹åˆ—è¡¨ï¼Œå½“æ—¶ä¸ä¼šåœ¨æ­¤æ¬¡è¿­ä»£ä¸­ä½“ç³»ã€‚åŸå› æ˜¯å†…éƒ¨é‡‡ç”¨åŒé‡æ•°ç»„çš„æ–¹å¼è¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è¿­ä»£å™¨åªèƒ½è¯»å–è¿­ä»£å¼€å§‹æ—¶çš„å…ƒç´ é›†åˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¹¶å‘å®¹å™¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é”</title>
      <link href="2017/03/16/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/4.%E9%94%81/"/>
      <url>2017/03/16/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/4.%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h1>é”</h1><p>å…³äºjavaä¸­é”çš„æœ‰å…³çŸ¥è¯†ï¼Œä¾‹å¦‚æœ‰é”çš„ç§ç±»ã€ä¹è§‚é”å’Œæ‚²è§‚é”çš„å®šä¹‰ã€synchronizedå’Œlockçš„ç‰¹ç‚¹ã€å…¬å¹³é”å’Œéå…¬å¹³é”ã€è¯»å†™é”ReadWriteLockã€è‡ªæ—‹é”ã€jvmå¯¹é”çš„ä¼˜åŒ–</p><h2 id="é”çš„åˆ†ç±»"><a class="header-anchor" href="#é”çš„åˆ†ç±»"></a>é”çš„åˆ†ç±»</h2><p>javaä¸­æŒ‰ç…§ç‰¹å®šå¯ä»¥å°†é”åˆ’åˆ†ä¸º7ä¸ªç‰¹æ€§ï¼š</p><ul><li>åå‘é”/è½»é‡çº§é”/é‡é‡çº§é”</li><li>å¯é‡å…¥é”/ä¸å¯é‡å…¥é”</li><li>å…±äº«é”/éå…±äº«é”</li><li>æ‚²è§‚é”/ä¹è§‚é”</li><li>è‡ªæ—‹é”/éè‡ªæ—‹é”</li><li>å¯ä¸­æ–­é”/ä¸å¯ä¸­æ–­é”</li></ul><h3 id="åå‘é”-è½»é‡çº§é”-é‡é‡çº§é”"><a class="header-anchor" href="#åå‘é”-è½»é‡çº§é”-é‡é‡çº§é”"></a>åå‘é”/è½»é‡çº§é”/é‡é‡çº§é”</h3><p>è¿™ä¸‰ç§éƒ½æ˜¯æè¿°synchronizedæŒæœ‰çš„é”ï¼Œsynchronizedé”åº•å±‚æ˜¯é€šè¿‡æŒæœ‰å…±äº«å¯¹è±¡çš„moniteræ¥å®ç°çš„ï¼Œåœ¨æŒæœ‰å¯¹è±¡çš„å¯¹è±¡å¤´ç”¨mark wordçš„æ ‡è®°ï¼Œå½“å‰å¯¹è±¡æ˜¯å±äºé‚£ç§é”ã€‚</p><h4 id="åå‘é”"><a class="header-anchor" href="#åå‘é”"></a>åå‘é”</h4><p>åå‘é”ï¼šå½“å…±äº«å¯¹è±¡æ²¡æœ‰å‘ç”Ÿçº¿ç¨‹ç«äº‰æ—¶ï¼Œæ‰§è¡Œçº¿ç¨‹æŒæœ‰é”å°±æ˜¯åå‘é”ã€‚æ­¤æ—¶å…±äº«å¯¹è±¡çš„å¯¹è±¡å°†æŒæœ‰çº¿ç¨‹è®°å½•ä¸‹æ¥ï¼Œå†æ¬¡è®¿é—®è¯¥å¯¹è±¡æ—¶ï¼Œå¦‚æœæ˜¯æ‰§è¡Œçº¿ç¨‹å°±ç›´æ¥è·å–ï¼Œå¦‚æœä¸æ˜¯æ‰§è¡Œçº¿ç¨‹è¯¥é”ä¼šå‡çº§ä¸ºè½»é‡çº§é”</p><h4 id="è½»é‡çº§é”"><a class="header-anchor" href="#è½»é‡çº§é”"></a>è½»é‡çº§é”</h4><p>è½»é‡çº§é”ï¼šå½“å…±äº«å¯¹è±¡å­˜åœ¨èµ„æºç«äº‰æ—¶ï¼Œå¦‚æœä¹‹å‰çš„é”æ˜¯åå‘é”çš„çŠ¶æ€å°±ä¼šå‘ç”Ÿé”çš„å‡çº§ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚è½»é‡çº§é”é‡‡ç”¨CASå’Œè‡ªæ—‹çš„æœºåˆ¶ï¼Œé¿å…äº†çº¿ç¨‹åˆ‡æ¢æ‰€å¸¦æ¥çš„å¼€é”€</p><h4 id="é‡é‡çº§é”"><a class="header-anchor" href="#é‡é‡çº§é”"></a>é‡é‡çº§é”</h4><p>é‡é‡çº§é”ï¼šé‡é‡çº§é”æ˜¯åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„åŒæ­¥æœºåˆ¶å®ç°çš„ï¼Œçº¿ç¨‹ä¼šç­‰å¾…å’Œå”¤é†’å¼€é”€æ¯”è¾ƒå¤§ã€‚</p><h3 id="å¯é‡å…¥é”å’Œä¸å¯é‡å…¥é”"><a class="header-anchor" href="#å¯é‡å…¥é”å’Œä¸å¯é‡å…¥é”"></a>å¯é‡å…¥é”å’Œä¸å¯é‡å…¥é”</h3><p>å¯é‡å…¥é”æŒ‡çš„æ˜¯å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå†æ¬¡è¯·æ±‚æŒæœ‰é”çš„æ—¶å€™å¯ä»¥ç›´æ¥è·å¾—ï¼›<br>ä¸å¯é‡å…¥é”æŒ‡å®šæ˜¯å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå†æ¬¡è¯·æ±‚æŒæœ‰é”çš„æ—¶å€™ä¹Ÿä¸èƒ½ç›´æ¥è·å¾—éœ€è¦æ’é˜Ÿï¼›<br><strong>ReentrantLock</strong>å°±æ˜¯é‡å…¥é”</p><h3 id="å…±äº«é”-éå…±äº«é”"><a class="header-anchor" href="#å…±äº«é”-éå…±äº«é”"></a>å…±äº«é”/éå…±äº«é”</h3><p>å…±äº«é”æŒ‡çš„æ˜¯ä¸€ä¸ªé”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è·å¾—ï¼›éå…±äº«é”åˆå«ç‹¬å é”ï¼Œåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚<br><strong>ReadWriteLock</strong>ä¸­çš„è¯»é”å°±æ˜¯å…±äº«é”ï¼Œwriteå°±æ˜¯ç‹¬å é”ã€‚</p><h3 id="å…¬å¹³é”-éå…¬å¹³é”"><a class="header-anchor" href="#å…¬å¹³é”-éå…¬å¹³é”"></a>å…¬å¹³é”/éå…¬å¹³é”</h3><p>å…¬å¹³é”å’Œéå…¬å¹³é”æŒ‡çš„æ˜¯çº¿ç¨‹è·å–é”æ˜¯å¦è¦æŒ‰ç…§FIFOçš„è§„åˆ™</p><h3 id="ä¹è§‚é”-æ‚²è§‚é”"><a class="header-anchor" href="#ä¹è§‚é”-æ‚²è§‚é”"></a>ä¹è§‚é”/æ‚²è§‚é”</h3><p>ä¹è§‚é”ï¼šä¸ç‹¬å èµ„æºï¼Œåˆ©ç”¨CASæ€æƒ³æ¥å®Œæˆæ“ä½œ<br>æ‚²è§‚é”ï¼šå…ˆç‹¬å èµ„æºï¼Œåœ¨è¿›è¡Œæ“ä½œ</p><h3 id="è‡ªæ—‹é”-éè‡ªæ—‹é”"><a class="header-anchor" href="#è‡ªæ—‹é”-éè‡ªæ—‹é”"></a>è‡ªæ—‹é”/éè‡ªæ—‹é”</h3><p>è‡ªæ—‹é”ï¼šä¸å‡ºè®©cpu,é€šè¿‡ç©ºè½¬ä¸åœçš„å»è·å–èµ„æº<br>éè‡ªæ—‹é”ï¼šå°è¯•è·å–é”å¤±è´¥ï¼Œå°±è¿›å…¥ç­‰å¾…</p><h3 id="å¯ä¸­æ–­é”-ä¸å¯ä¸­æ–­é”"><a class="header-anchor" href="#å¯ä¸­æ–­é”-ä¸å¯ä¸­æ–­é”"></a>å¯ä¸­æ–­é”/ä¸å¯ä¸­æ–­é”</h3><p>å¯ä¸­æ–­é”ï¼šå¯å“åº”çº¿ç¨‹ä¸­æ–­çš„çš„é”<br>ä¸å¯ä¸­æ–­é”ï¼šå¿…é¡»ç­‰å¾…æ‰§è¡Œçº¿ç¨‹é‡Šæ”¾é”ï¼Œæ‰èƒ½å“åº”ä¸­æ–­æ“ä½œ</p><h2 id="synchronizedåº•å±‚çš„å®ç°æ–¹æ³•"><a class="header-anchor" href="#synchronizedåº•å±‚çš„å®ç°æ–¹æ³•"></a>synchronizedåº•å±‚çš„å®ç°æ–¹æ³•</h2><p>synchronizedä¿®é¥°<B>ä»£ç å—</B>æ—¶ï¼Œæ˜¯é€šè¿‡<strong>monitorenter</strong>ã€<strong>monitorexit</strong>æŒ‡ä»¤æ¥å®ç°çš„</p><p><strong>monitorenter</strong>æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯</p><ul><li>å¦‚æœæ‰§è¡Œçº¿ç¨‹å°è¯•è·å–å¯¹è±¡çš„monitorçš„è®¡æ•°å€¼æ˜¯0ï¼Œé‚£ä¹ˆå°±åŠ 1ï¼Œæ ‡è®°è¯¥çº¿ç¨‹æŒæœ‰é”å¯¹è±¡</li><li>å¦‚æœè¯¥çº¿ç¨‹å·²ç»æ‹¥æœ‰è¯¥å¯¹è±¡ï¼Œé‚£ä¹ˆmonitorçš„æŠ€æœ¯å€¼åœ¨åŠ 1</li><li>å¦‚æœè¯¥çº¿ç¨‹å°è¯•è·å–å¯¹è±¡çš„monitorä¸ä¸º0ï¼Œä¸”æ‰§è¡Œçº¿ç¨‹ä¸ä¸ºè‡ªå·±ï¼Œé‚£ä¹ˆç­‰å¾…monitorä¸º0ååœ¨å°è¯•è·å–</li></ul><p><strong>monitorexit</strong></p><ul><li>å°†é”å¯¹è±¡çš„monitorè®¡æ•°å‡1æ“ä½œ</li></ul><p>synchronizedä¿®é¥°æ–¹æ³•æ—¶ï¼Œæ˜¯é€šè¿‡==ACC_SYNCHRONIZED==æ ‡è®°ä½æ¥å®ç°çš„ï¼Œ__ACC_SYNCHRONIZED__æ ‡è®°ä½æ ‡è®°çš„æ–¹æ³•ä¼šåœ¨å°è¯•è·å–åˆ°monitoré”åæ‰æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åå°±é‡Šæ”¾ã€‚</p><h2 id="RLockæ¥å£çš„å¸¸ç”¨æ–¹æ³•"><a class="header-anchor" href="#RLockæ¥å£çš„å¸¸ç”¨æ–¹æ³•"></a>RLockæ¥å£çš„å¸¸ç”¨æ–¹æ³•</h2><table><thead><tr><th>æ–¹æ³•</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>lock()</td><td>ç›´æ¥è·å–é”</td></tr><tr><td>tryLock()</td><td>å°è¯•è·å–é”ï¼Œè¿”å›å€¼è¡¨ç¤ºè·å–æˆåŠŸè¿˜æ˜¯å¤±è´¥</td></tr><tr><td>tryLock()</td><td>å¸¦ç­‰å¾…æ—¶é—´çš„tryLock()</td></tr><tr><td>lockInterruptibly()</td><td>å¯å“åº”ä¸­æ–­çš„é”</td></tr><tr><td>unlock()</td><td>é‡Šæ”¾é”</td></tr><tr><td>newCondition()</td><td>è·å–æ‰§è¡Œçº¿ç¨‹çš„Conditionå¯¹è±¡</td></tr></tbody></table><h2 id="å…¬å¹³é”å’Œéå…¬å¹³é”"><a class="header-anchor" href="#å…¬å¹³é”å’Œéå…¬å¹³é”"></a>å…¬å¹³é”å’Œéå…¬å¹³é”</h2><p>éå…¬å¹³é”å­˜åœ¨çš„æ„ä¹‰æ˜¯,å½“å‰cpuæ‰§è¡Œçº¿ç¨‹å¯ä»¥ç›´æ¥è·å–åˆ°é”ï¼Œä¸ç”¨å‚ä¸çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œä»è€Œå‡å°‘çº¿ç¨‹æŒ‚èµ·å’Œå”¤é†’æ¶ˆè€—çš„æ—¶é—´ã€‚æœ‰å¯èƒ½çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæˆåï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹æ‰è¿›è¡Œå”¤èµ·ã€‚</p><ul><li><strong>ReentrantLock</strong>é»˜è®¤å°±æ˜¯éå…¬å¹³é”</li></ul><h2 id="è¯»å†™é”"><a class="header-anchor" href="#è¯»å†™é”"></a>è¯»å†™é”</h2><ul><li><strong>ReadWriteLock</strong></li></ul><h3 id="ç‰¹ç‚¹"><a class="header-anchor" href="#ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h3><p>è¦ä¹ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªçº¿ç¨‹å ç”¨äº†è¯»é”ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹å ç”¨äº†å†™é”ã€‚ä¸¤è€…ä¸ä¼šåŒæ—¶å‡ºç°</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock</span> readWriteLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writeLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ReentrantReadWriteLockæ˜¯ReadWriteæ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œé€šè¿‡readLock()è·å–è¯»é”ï¼Œé€šè¿‡writeLock()å¯ä»¥è·å–å†™é”<br>åœ¨è·å–è¯»å†™é”çš„æ—¶å€™ï¼Œå¯ä»¥å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°readLocké”ï¼Œä½†æ˜¯åœ¨è·å–å†™é”çš„æ—¶å€™åªèƒ½å•ä¸ªå†™è·å–åˆ°å†™é”å¹¶ä¸”è¯¥é”åªèƒ½ç‹¬å åœ¨ä½¿ç”¨åˆ°å†™é”çš„æ—¶å€™</p><h3 id="è·å–é”çš„æ–¹å¼å’Œè¯»å†™é”å‡é™çº§ç­–ç•¥"><a class="header-anchor" href="#è·å–é”çš„æ–¹å¼å’Œè¯»å†™é”å‡é™çº§ç­–ç•¥"></a>è·å–é”çš„æ–¹å¼å’Œè¯»å†™é”å‡é™çº§ç­–ç•¥</h3><p>å…¬å¹³çš„è¯»å†™é”æ—¶ï¼Œéƒ½ä¸å…è®¸æ’é˜Ÿï¼Œè¯»é”å’Œå†™é”éƒ½è¦æŒ‰ç…§ç­‰å¾…é˜Ÿåˆ—çš„é¡ºåºä¾æ¬¡è¿›è¡Œæ’é˜Ÿåœ¨è·å–é”</p><p>éå…¬å¹³é”çš„æ—¶å€™ï¼Ÿè¯»é”åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸æ˜¯ç«äº‰å†™é”çš„æ—¶å€™å¯ä»¥å…è®¸æ’é˜Ÿï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªæ˜¯ç«äº‰å†™é”çš„çº¿ç¨‹æ—¶ä¸å…è®¸æ’é˜Ÿ<br>å†™é”ç«äº‰æ—¶ï¼Œå…è®¸æ’é˜Ÿï¼Œæ’é˜Ÿå¦‚æœå¤±è´¥çš„è¯è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­</p><p>é”çš„å‡é™çº§ç­–ç•¥ï¼šåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å…ˆè·å–åˆ°å†™é”å¹¶ä¸”ä¸é‡Šæ”¾ï¼Œç„¶åè·å–åˆ°è¯»é”ï¼Œå†é‡Šæ”¾å†™é”ï¼Œä»è€Œå®ç°çº¿ç¨‹æŒæœ‰é”çš„é™çº§ï¼Œä»å†™é”é™çº§ä¸ºè¯»é”ã€‚</p><p>æ³¨æ„é”çš„é™çº§æ˜¯åœ¨åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¹¶ä¸æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å®ç°çš„ã€‚<br>è¿™æ ·åšçš„ä¼˜ç‚¹åœ¨äºï¼Œå†™é”åªç‹¬å ä¿®æ”¹çš„é‚£ä¸€æ®µæ—¶é—´ï¼Œé™çº§ä¸ºè¯»é”åå…¶ä»–çº¿ç¨‹éƒ½å¯ä»¥è·å–åˆ°è¯»é”ä»è€Œæé«˜æ•ˆç‡ã€‚</p><h2 id="è‡ªæ—‹é”"><a class="header-anchor" href="#è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h2><p>è‡ªæ—‹é”äº§ç”Ÿçš„åŸå› æ˜¯ï¼Œç”±äºçº¿ç¨‹ç‹¬å æ‰§è¡Œçš„ä»£ç æ—¶é—´è¾ƒçŸ­ï¼Œæ¯”æŒ‚èµ·å’Œå”¤é†’çº¿ç¨‹çš„æ—¶é—´è¦çŸ­å¾ˆå¤šï¼Œå› æ­¤çº¿ç¨‹é€šè¿‡å¾ªç¯åˆ¤æ–­ç«äº‰é”çš„æ¡ä»¶ä¸æ–­çš„å°è¯•è·å–é”ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚<br>å¦‚æœä¸´ç•ŒåŒºå¾ˆå¤§ï¼Œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡è€—æ—¶éœ€è¦å¾ˆä¹…çš„è¯ï¼Œè¿™ç§æ–¹å¼åè€Œä¸åˆ©äºæ€§èƒ½<br>é€‚ç”¨äºå¹¶å‘åº¦ä¸æ˜¯å¾ˆé«˜ï¼Œå¹¶ä¸”ä¸´ç•ŒåŒºæ¯”è¾ƒçŸ­å°çš„æƒ…å†µè¿™æ ·ã€‚</p><h2 id="JVMå¯¹é”çš„ä¼˜åŒ–"><a class="header-anchor" href="#JVMå¯¹é”çš„ä¼˜åŒ–"></a>JVMå¯¹é”çš„ä¼˜åŒ–</h2><p>1.è‡ªé€‚åº”é”çš„è‡ªæ—‹<br>2.é”æ¶ˆé™¤   å¯¹äºä¸ä¼šæœ‰ç«äº‰çš„åœºæ™¯ï¼Œä¼šè‡ªåŠ¨æ¶ˆé™¤é”<br>3.é”ç²—åŒ–   é”çš„èŒƒå›´ä¼šæ”¾å¤§ï¼Œå‡å°‘åŠ é”è§£é”çš„æ­¥éª¤ï¼Œä»è€Œæé«˜æ•ˆç‡<br>4.åå‘é”/è½»é‡çº§é”/é‡é‡çº§é”</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ³¨éŸ³è¯å…¸(ä¸€)</title>
      <link href="2017/03/04/9.%E6%B3%A8%E9%9F%B3%E8%AF%8D%E5%85%B8/%E6%B3%A8%E9%9F%B3%E8%AF%8D%E5%85%B8-1/"/>
      <url>2017/03/04/9.%E6%B3%A8%E9%9F%B3%E8%AF%8D%E5%85%B8/%E6%B3%A8%E9%9F%B3%E8%AF%8D%E5%85%B8-1/</url>
      
        <content type="html"><![CDATA[<h1>æ³¨éŸ³è¯å…¸</h1><table><thead><tr><th>è‹±æ–‡</th><th>è¯»éŸ³</th><th>ä¸­æ–‡</th><th>éŸ³æ ‡</th></tr></thead><tbody><tr><td>transaction</td><td>ç©¿äº‹å®‰å¯å‹</td><td>äº‹åŠ¡</td><td>Ëˆzak-,tranËˆsakSHÉ™n</td></tr><tr><td>template</td><td>è°ˆæ™®å†·ç‰¹</td><td>æ¨¡æ¿</td><td>ËˆtemplÉ™t</td></tr><tr><td>reflect</td><td>ç‘å¯Œæ¥å®¢ç‰¹</td><td>åå°„</td><td>riËˆflekt</td></tr><tr><td>method</td><td>éº¦èˆå¾—</td><td>æ–¹æ³•</td><td>ËˆmeTHÉ™d</td></tr><tr><td>interceptor</td><td>åº”ä¹èµ›ç ´ç‰¹å„¿</td><td>æ‹¦æˆªå™¨</td><td>ËŒintÉ™rËˆseptÉ™r</td></tr><tr><td>execution</td><td>å“å…‹æ–¯æ‰£æ–°</td><td>æ‰§è¡Œ</td><td>ËŒeksiËˆkyoÍoSHÉ™n</td></tr><tr><td>component</td><td>è‚¯ç€å†·ç‰¹</td><td>é›¶ä»¶</td><td></td></tr><tr><td>definition</td><td>å¸¦é£ç±»å‹</td><td>å®šä¹‰</td><td>defÉ™ËˆniSHÉ™n</td></tr><tr><td>abstract</td><td>é˜¿æ³¢æ–¯æ‹½å…‹ç‰¹</td><td>æŠ½è±¡</td><td></td></tr><tr><td>default</td><td>åœ°å¦å“¦</td><td>é»˜è®¤</td><td></td></tr><tr><td>annotation</td><td>æŒ‰ç±»å¿’å‹</td><td>æ³¨è§£</td><td></td></tr><tr><td>componet</td><td>è‚¯ç€å†·ç‰¹</td><td>é›¶ä»¶</td><td></td></tr><tr><td>register</td><td>å®Œå³ä½¿å¿’</td><td>æ³¨å†Œ</td><td></td></tr><tr><td>scanner</td><td>æ–¯ä¸¹å‹’å„¿</td><td>æ‰«æå™¨</td><td></td></tr><tr><td>prepare</td><td>ç€ä½©å„¿</td><td>å‡†å¤‡</td><td></td></tr><tr><td>obtain</td><td>å¥¥ç€å¬</td><td>è·å¾—</td><td></td></tr><tr><td>generic</td><td>å§æç‘å…‹</td><td>é€šç”¨</td><td></td></tr><tr><td>process</td><td>æ³¢å•¦èˆæ–¯</td><td>å¤„ç†</td><td></td></tr><tr><td>source</td><td>é”æ–¯</td><td>èµ„æº</td><td></td></tr><tr><td>multicaster</td><td>è°‹æå‡¯æ–¯ç‰¹</td><td>å¤šè·¯å¹¿æ’­</td><td></td></tr><tr><td>Event</td><td>é¢å®Œç‰¹</td><td>äº‹ä»¶</td><td></td></tr><tr><td>listable</td><td>ç±»ä¼¼ç‰¹åš</td><td>å¯åˆ—å‡º</td><td></td></tr><tr><td>Initialize</td><td>å› ç«‹æ–°æ¥ç´«</td><td>åˆå§‹åŒ–</td><td></td></tr><tr><td>obtain</td><td>ç†¬æ™®å»·</td><td>è·å–</td><td></td></tr><tr><td>Delegating</td><td>å¾…ä¹ç»™å› </td><td>å§”æ‰˜</td><td></td></tr><tr><td>resolve</td><td>è•Šæ—©å¯Œ</td><td>è§£å†³</td><td></td></tr><tr><td>Instantiation</td><td>å› æ˜¯ä¸¹å†™Aæ€§</td><td>å®ä¾‹åŒ–</td><td></td></tr><tr><td>constructor</td><td>è‚¯æ–¯ç©¿å…‹ç‰¹å„¿</td><td>æ„å»ºå™¨</td><td></td></tr><tr><td>Concurrent</td><td>è‚¯å—å„¿æ¶¦</td><td>å¹¶å‘çš„</td><td></td></tr><tr><td>Reference</td><td>è½¯åˆ†æ–¯</td><td>å‚è€ƒ</td><td>Ëˆref(É™)rÉ™ns</td></tr><tr><td>Atomic</td><td>é¢å¥—ç±³å…‹</td><td>åŸå­</td><td>É™ËˆtÃ¤mik</td></tr><tr><td>volatile</td><td>ç“¦å‹’å¤š</td><td>æ˜“å˜çš„</td><td>ËˆvÃ¤lÉ™tl</td></tr><tr><td>accumulator</td><td>é¢Qç±³å‹’å¾—å„¿</td><td>ç´¯åŠ å™¨</td><td>É™ËˆkyoÍomyÉ™ËŒlÄtÉ™r</td></tr><tr><td>inherit</td><td>è¥é»‘å„¿</td><td>ç»§æ‰¿</td><td>inËˆherit</td></tr><tr><td>Creator</td><td>é­è•Šå¾—å„¿</td><td>åˆ›ä½œè€…</td><td>krÄ“ËˆÄtÉ™r</td></tr><tr><td>proxy</td><td>æ€•å…‹èˆ</td><td>ä»£ç†</td><td>ËˆprÃ¤ksÄ“</td></tr><tr><td>status</td><td>æ–¯ä¸¹ç‰¹æ–¯</td><td>çŠ¶æ€</td><td>statÉ™s</td></tr><tr><td>platform</td><td>ç€é‚£åšå„¿</td><td>å¹³å°</td><td>ËˆplatfÃ´rm</td></tr><tr><td>prepared</td><td>ç€ä½©å„¿çš„</td><td>å‡†å¤‡</td><td>priËˆpe(É™)r</td></tr><tr><td>Resolver</td><td>è•Šé­é£å„¿</td><td>è§£æå™¨</td><td></td></tr><tr><td>annotated</td><td>ä¿ºå‹’æ</td><td>æ³¨é‡Š</td><td>ËˆanÉ™ËŒtÄt</td></tr><tr><td>semaphore</td><td>ä¸‰æ¨¡å¦å„¿</td><td>ä¿¡å·</td><td>semÉ™ËŒfÃ´r</td></tr><tr><td>acquire</td><td>é¢å¿«å„¿</td><td>è·å¾—</td><td></td></tr><tr><td>Latch</td><td>è“æ± </td><td>é”å­˜å™¨</td><td></td></tr><tr><td>environment</td><td>è¥æ­ªå‹’ä»¬ç‰¹</td><td>ç¯å¢ƒ</td><td></td></tr><tr><td>cyclicBarrier</td><td>cå…‹ç«‹å…‹æ†‹è•Šå„¿</td><td>å¾ªç¯å±éšœ</td><td>sÄ«klik ËˆbarÄ“É™r</td></tr><tr><td>groups</td><td>æ ¼è‚‰ç ´ä¸</td><td>å›¢ä½“</td><td>É¡roÍops</td></tr><tr><td>completion</td><td>åº·ç€ç±»æ–°</td><td>å®Œæˆæ—¶é—´</td><td></td></tr><tr><td>Servivor</td><td>è‰²å¤–å¾·äºŒ</td><td>å¹¸å­˜è€…</td><td>sÉ™rËˆvÄ«vÉ™r</td></tr><tr><td>minor</td><td>ä¹°å‹’å„¿</td><td>æ¬¡è¦</td><td>ËˆmÄ«nÉ™r</td></tr><tr><td>major</td><td>æ¢…å‰å„¿</td><td>é‡è¦</td><td>ËˆmÄjÉ™r</td></tr><tr><td>throwable</td><td>å¦æ¬§-é¢åš</td><td>æŠ›å‡º</td><td>THrÅ ËˆÄbÉ™l</td></tr><tr><td>transient</td><td>ç©¿ç«™ç‰¹</td><td>çŸ­æš‚çš„</td><td>tranSHÉ™nt</td></tr><tr><td>Issues</td><td>ä¸€å®¿æ—¶~</td><td>é—®é¢˜</td><td>ËˆiSHoÍos</td></tr><tr><td>dynamic</td><td>å¾…è“ç±³å…‹</td><td>åŠ¨æ€çš„</td><td>dÄ«Ëˆnamik</td></tr><tr><td>acquire Shared</td><td>é¢å¿«å„¿ è¥¿å„¿</td><td>è·å–å…±äº«</td><td></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> è‹±æ–‡å‘éŸ³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è‹±æ–‡å‘éŸ³ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹æ± </title>
      <link href="2017/03/02/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/3.%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
      <url>2017/03/02/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/3.%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
      
        <content type="html"><![CDATA[<h1>çº¿ç¨‹æ± </h1><p>æœ‰å…³çº¿ç¨‹æ± çš„åˆ›å»ºã€å¸¸è§çš„å‡ ç§çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„ä½¿ç”¨æ–¹å¼</p><h2 id="åˆ›å»ºçº¿ç¨‹æ± "><a class="header-anchor" href="#åˆ›å»ºçº¿ç¨‹æ± "></a>åˆ›å»ºçº¿ç¨‹æ± </h2><p>åˆ›å»ºçº¿ç¨‹æ± ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å„ä¸ªå‚æ•°å«ä¹‰</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>corePoolSize</td><td>æ ¸å¿ƒçº¿ç¨‹æ•°</td></tr><tr><td>maximumPoolSize</td><td>æœ€å¤§çº¿ç¨‹æ•°</td></tr><tr><td>keepAliveTimeå’Œunit</td><td>ç©ºé—²å­˜æ´»æ—¶é—´</td></tr><tr><td>workQueue</td><td>ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—</td></tr><tr><td>threadFactory</td><td>çº¿ç¨‹å·¥å‚</td></tr><tr><td>handler</td><td>æ‹’ç»ç­–ç•¥</td></tr></tbody></table><p>çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹ä¸ºã€</p><ol><li>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æœªè¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹ï¼Œ<strong>æäº¤ä»»åŠ¡åå°±ä¼šç«‹åˆ»æ‰§è¡Œä»»åŠ¡</strong></li><li>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œ<strong>å°†ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—</strong></li><li>ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—å·²æ»¡ï¼Œæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œ<strong>å°†ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</strong></li><li>è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥</li></ol><h2 id="æ‹’ç»ç­–ç•¥"><a class="header-anchor" href="#æ‹’ç»ç­–ç•¥"></a>æ‹’ç»ç­–ç•¥</h2><table><thead><tr><th>åˆå§‹åŒ–</th><th>ç‰¹æ€§</th></tr></thead><tbody><tr><td>ThreadPoolExecutor.AbortPolicy()</td><td>æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>ThreadPoolExecutor.DiscardPolicy()</td><td>ç›´æ¥ä¸¢å¼ƒä¸æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>ThreadPoolExecutor.DiscardOldestPolicy()</td><td>ä¸¢å¼ƒé˜Ÿåˆ—ä¸­å­˜åœ¨æœ€é•¿çš„æ—¶é—´</td></tr><tr><td>ThreadPoolExecutor.CallerRunsPolicy()</td><td>ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</td></tr></tbody></table><p><strong>ThreadPoolExecutor.CallerRunsPolicy()</strong> è¿™ç§æ‹’ç»ç­–ç•¥æ¯”è¾ƒåˆç†ï¼Œé€šè¿‡å°†ä»»åŠ¡ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹å»æ‰§è¡Œè¿™æ ·å¯ä»¥å‡å°‘ä»»åŠ¡çš„ç´¯ç§¯</p><h2 id="é€šè¿‡Executersåˆ›å»ºçš„çº¿ç¨‹æ± "><a class="header-anchor" href="#é€šè¿‡Executersåˆ›å»ºçš„çº¿ç¨‹æ± "></a>é€šè¿‡Executersåˆ›å»ºçš„çº¿ç¨‹æ± </h2><table><thead><tr><th>åˆå§‹åŒ–</th><th>ç‰¹æ€§</th></tr></thead><tbody><tr><td>Executors.newCachedThreadPool()</td><td>æ— ä¸Šé™çš„çº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ,çº¿ç¨‹ä¼šä¿æŒ60s</td></tr><tr><td>Executors.newFixedThreadPool()</td><td>å›ºå®šçº¿ç¨‹æ•°,æ— ä¸Šé™çš„ç¼“å­˜ä»»åŠ¡é˜Ÿåˆ—</td></tr><tr><td>Executors.newSingleThreadExecutor()</td><td>å•ä¸ªçº¿ç¨‹,æ— ä¸Šé™çš„ç¼“å­˜ä»»åŠ¡é˜Ÿåˆ—</td></tr><tr><td>Executors.ScheduledThreadPoolExecutor()</td><td>æœ‰å›ºå®šçº¿ç¨‹æ•°,å»¶è¿Ÿé˜Ÿåˆ—</td></tr></tbody></table><p><strong>ForkJoinPoolçº¿ç¨‹æ± </strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ForkJoinTask</span> task <span class="token operator">=</span> forkJoinPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="é˜»å¡é˜Ÿåˆ—"><a class="header-anchor" href="#é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—</h2><table><thead><tr><th>åˆå§‹åŒ–</th><th>ç‰¹æ€§</th></tr></thead><tbody><tr><td>LinkedBlockingQueue</td><td>æ— å®¹é‡ä¸Šé™çš„é˜Ÿåˆ—</td></tr><tr><td>SynchronousQueue</td><td>æ— å®¹é‡çš„é˜Ÿåˆ—ï¼Œæäº¤ä»»åŠ¡ç«‹å³å¼¹å‡º</td></tr><tr><td>DelayedWorkQueue</td><td>å»¶è¿Ÿé˜Ÿåˆ—</td></tr></tbody></table><h2 id="æ ¸å¿ƒçº¿ç¨‹æ•°çš„é€‰æ‹©"><a class="header-anchor" href="#æ ¸å¿ƒçº¿ç¨‹æ•°çš„é€‰æ‹©"></a>æ ¸å¿ƒçº¿ç¨‹æ•°çš„é€‰æ‹©</h2><p>æ ¸å¿ƒçº¿ç¨‹æ•°çš„é€‰æ‹©æ˜¯æ ¹æ®ä»»åŠ¡çš„ç±»å‹<strong>CPUå¯†é›†æ€§</strong>ã€<strong>IOå¯†é›†å‹</strong></p><p><strong>CPUå¯†é›†æ€§</strong>ä»»åŠ¡ï¼Œä¼šä¸€ç›´ä½¿ç”¨cpuè¿›è¡Œè®¡ç®—ï¼Œåˆé€‚çš„çº¿ç¨‹æ•°ä¸ºcpuæ ¸å¿ƒæ•°çš„<strong>1~2</strong>å€ï¼Œè¿‡å¤šçš„çº¿ç¨‹æ•°ä¼šé€ æˆçº¿ç¨‹ä¸Šä¸‹æ–‡çš„é¢‘ç¹åˆ‡æ¢ï¼Œæ‰§è¡Œæ•ˆç‡åè€Œä¸é«˜ã€‚</p><p><strong>IOå¯†é›†å‹</strong>ä»»åŠ¡ï¼Œä¼šæ‰§è¡ŒIOä»»åŠ¡ï¼Œcpuè¿›è¡Œç­‰å¾…ï¼Œå› æ­¤çº¿ç¨‹æ•°å¯ä»¥å°½é‡å¤šä¸€äº›ã€‚</p><p>*<em>çº¿ç¨‹æ•° =  CPUæ ¸å¿ƒæ•° <em>ï¼ˆ1 + å¹³å‡ç­‰å¾…æ—¶é—´/å¹³å‡å·¥ä½œæ—¶é—´ï¼‰</em></em></p><h2 id="shutdownå’ŒshutdownNewçš„åŒºåˆ«"><a class="header-anchor" href="#shutdownå’ŒshutdownNewçš„åŒºåˆ«"></a>shutdownå’ŒshutdownNewçš„åŒºåˆ«</h2><p>__shutdown__ä¸åœ¨å…è®¸æäº¤ä»»åŠ¡ï¼Œå¾…æ‰§è¡Œçº¿ç¨‹æ± ä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å’Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åçº¿ç¨‹æ± å…³é—­<br>__shutdownNow__ç«‹å³æš‚åœä»»åŠ¡ï¼Œå‘æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å‘é€ä¸­æ–­ä¿¡å·ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è½¬ç§»å‡ºæ¥ï¼Œç„¶åçº¿ç¨‹æ± å…³é—­</p><p>çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹çš„é€»è¾‘æ˜¯ï¼Œåˆ›å»ºçº¿ç¨‹åä¸åœçš„è·å–taskè¿›è¡Œæ‰§è¡Œï¼ˆrunï¼‰æ–¹æ³•</p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹å®‰å…¨</title>
      <link href="2017/02/27/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/2.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/"/>
      <url>2017/02/27/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/2.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<h1>çº¿ç¨‹å®‰å…¨</h1><p>ä»‹ç»å¤šçº¿ç¨‹ä¸­çš„æœ‰å…³çº¿ç¨‹å®‰å…¨çš„çŸ¥è¯†ï¼ŒåŒ…å«çº¿ç¨‹å®‰å…¨é—®é¢˜ã€æ€§èƒ½é—®é¢˜</p><h2 id="çº¿ç¨‹å®‰å…¨"><a class="header-anchor" href="#çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h2><p>å¤šçº¿ç¨‹è¿œè¡Œæ—¶åºä¸æ­£ç¡®å¯èƒ½ä¼šå¸¦æ¥<strong>è¿è¡Œç»“æœé”™è¯¯</strong>ã€<strong>åˆå§‹åŒ–çº¿ç¨‹å¯¼è‡´çš„å®‰å…¨é—®é¢˜</strong>ã€<strong>æ´»è·ƒæ€§é—®é¢˜</strong>ã€‚</p><ol><li><strong>è¿è¡Œç»“æœé—®é¢˜</strong>ï¼šå¤šçº¿ç¨‹è¿è¡Œæ—¶ï¼Œå…±äº«çš„èµ„æºæ²¡æœ‰å¾—åˆ°æ­£ç¡®çš„å¤„ç†å¯¼è‡´ç»“æœé”™è¯¯</li><li><strong>åˆå§‹åŒ–çº¿ç¨‹å¯¼è‡´çš„å®‰å…¨é—®é¢˜</strong>ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶åºé”™è¯¯ï¼Œå¯¼è‡´åˆå§‹åŒ–é”™è¯¯</li><li><strong>æ´»è·ƒæ€§é—®é¢˜</strong>ï¼šå¤šçº¿ç¨‹ç«äº‰å¯¼è‡´<strong>æ­»é”</strong>ã€<strong>æ´»é”</strong>ã€<strong>é¥¥é¥¿</strong>ç­‰é—®é¢˜</li></ol><h2 id="çº¿ç¨‹æ€§èƒ½"><a class="header-anchor" href="#çº¿ç¨‹æ€§èƒ½"></a>çº¿ç¨‹æ€§èƒ½</h2><ol><li>è°ƒåº¦å¼€é”€ï¼š<strong>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ã€<strong>ç¼“å­˜å¤±æ•ˆ</strong></li><li>ååŠ©å¼€é”€ï¼šå…±äº«èµ„æºç›¸äº’ååŠ©éœ€è¦ç­‰å¾…å’Œåˆ·æ–°ç­‰ç­‰ååŠ©çš„æ“ä½œä¼šè€—æ—¶<br><strong>ç¼“å­˜å¤±æ•ˆ</strong>æŒ‡çš„æ˜¯æ“ä½œç³»ç»Ÿåœ¨è¯»å–ä¸€æ®µæ•°æ®æ—¶ä¼šé¢„è½½ç£ç›˜åˆ†é…ä¸Šä¸‹èŠ‚ç‚¹çš„æ•°æ®ï¼Œå½“çº¿ç¨‹å‘ç”Ÿåˆ‡æ¢åï¼Œç¼“å­˜å¤±æ•ˆ</li></ol>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹åŸºç¡€</title>
      <link href="2017/02/22/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/1.%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
      <url>2017/02/22/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/1.%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1>çº¿ç¨‹åŸºç¡€</h1><p>ä»‹ç»å¤šçº¿ç¨‹ä¸­çš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…å«çº¿ç¨‹åˆ›å»ºã€çº¿ç¨‹è¿è¡ŒçŠ¶æ€å’Œçº¿ç¨‹ä¸­æ–­</p><h2 id="çº¿ç¨‹åˆ›å»º"><a class="header-anchor" href="#çº¿ç¨‹åˆ›å»º"></a>çº¿ç¨‹åˆ›å»º</h2><p>çº¿ç¨‹åˆ›å»ºæœ‰ä¸”/åªæœ‰ä¸€ç§æ–¹å¼ï¼Œç»§æ‰¿<strong>Thread</strong>ç±»,å¹¶ä¸”é‡å†™**Run()**æ–¹æ³•</p><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> TaskDemoKt<span class="token operator">:</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token function">println</span><span class="token punctuation">(</span> <span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"æ‰§è¡Œä»»åŠ¡"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">val</span> demoKt <span class="token operator">=</span> <span class="token function">TaskDemoKt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    demoKt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å®ç°Runnableæ¥å£ã€åˆ›å»ºçº¿ç¨‹æ± ã€Timerç±»ç­‰æ–¹å¼åº•å±‚éƒ½æ˜¯è¿™ç§æ–¹å¼å®ç°çš„.ä¸‹é¢åˆ†åˆ«ç¿»ä¸€ä¸‹è¿™ä¸‰ç§æ–¹å¼çš„æºä»£ç </p><h3 id="æ‰§è¡ŒRunnableæ¥å£"><a class="header-anchor" href="#æ‰§è¡ŒRunnableæ¥å£"></a>æ‰§è¡ŒRunnableæ¥å£</h3><ul><li>Thread</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token class-name">ThreadGroup</span> g<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> target<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> stackSize<span class="token punctuation">,</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inheritThreadLocals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//å…¶ä»–æ­¥éª¤çœç•¥...</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token comment">//run()æ–¹æ³•</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        target<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//æœ¬åœ°æ–¹æ³•</span><span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºThread(Runnable)å¯¹è±¡æ—¶,ä¼šå°†Runnableå¯¹è±¡ä½œä¸ºçº¿ç¨‹å†…éƒ¨çš„ä¸€ä¸ªæˆå‘˜å˜é‡target,è¿™ä¸ªtargetåœ¨ä¸¤ä¸ªåœ°æ–¹ä¼šä½¿ç”¨åˆ°,ç¬¬ä¸€ä¸ªæ˜¯ç›´æ¥æ‰§è¡Œrun()æ–¹æ³•æ—¶,ç¬¬äºŒä¸ªæ˜¯æœ¬åœ°native start0(),ä¸‹é¢åˆ†æJVMæ˜¯å¦‚ä½•æ‰§è¡Œstart0()è¿™ä¸ªæœ¬åœ°æ–¹æ³•çš„</p><ul><li>start0</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F;TODO ç¨ååˆ†æ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="åˆ›å»ºçº¿ç¨‹æ± "><a class="header-anchor" href="#åˆ›å»ºçº¿ç¨‹æ± "></a>åˆ›å»ºçº¿ç¨‹æ± </h3><p>åˆ›å»ºçº¿ç¨‹æ± ,ä»¥åˆ›å»ºåŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹æ± ä¸ºä¾‹</p><ul><li>åˆ›å»ºçº¿ç¨‹æ± </li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">fun <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//ä»¥åˆ›å»ºåŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹æ± ä¸ºä¾‹</span>    val poolExecutor <span class="token operator">=</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token class-name">IntRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>forEach <span class="token punctuation">&#123;</span> _ <span class="token operator">-></span> poolExecutor<span class="token punctuation">.</span>submit <span class="token punctuation">&#123;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ‰“å°å½“å‰æ—¶é—´:"</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//ThreadPoolExecutorä¸­çš„çº¿ç¨‹çš„åˆ›å»ºè¿‡ç¨‹</span><span class="token comment">//execute()</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//Worker(firstTask)</span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// inhibit interrupts until runWorker</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä½¿ç”¨Timer"><a class="header-anchor" href="#ä½¿ç”¨Timer"></a>ä½¿ç”¨Timer</h3><ul><li>ä½¿ç”¨Timer</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">val</span> timer <span class="token operator">=</span> <span class="token function">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>timerTask <span class="token punctuation">&#123;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°:"</span> <span class="token operator">+</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Timer.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å®ç°Timeræ‰§è¡Œçš„æ–¹æ³•</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sched</span><span class="token punctuation">(</span><span class="token class-name">TimerTask</span> task<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token keyword">long</span> period<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ›å»ºTimerThread</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TimerThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimerThread</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//TimerThread</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token function">mainLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Someone killed this Thread, behave as if Timer cancelled</span>        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            newTasksMayBeScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            queue<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Eliminate obsolete references</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//mainLoop</span>   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">TimerTask</span> task<span class="token punctuation">;</span>            <span class="token keyword">boolean</span> taskFired<span class="token punctuation">;</span>            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                task <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">getMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šè¿™æ˜¯Timeræ‰§è¡Œè¿‡ç¨‹çš„ä¼ªä»£ç ,ä¸»è¦æ˜¯åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†</p><ol><li>æ„å»ºTimeræ˜¯åˆå§‹åŒ–TimerThread/queue</li><li>TimerThreadå¾ªç¯å¤„ç†queueä¸­çš„task</li></ol><h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“"></a>å°ç»“</h3><p>å¯ä»¥çœ‹åˆ°ä»¥ä¸Šä¸‰ç§æ–¹å¼ä¸ç®¡æ˜¯å®ç°Ruannbleæ¥å£/åˆ›å»ºçº¿ç¨‹æ± /ä½¿ç”¨Timeråœ¨åº•å±‚éƒ½æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªThreadå¯¹è±¡æ¥æ‰§è¡Œçš„.<br>ä¸‹é¢æ¥åˆ†æä¸€ä¸‹Threadçš„æ–¹æ³•å’Œå®ç°</p><h2 id="çº¿ç¨‹ä»»åŠ¡"><a class="header-anchor" href="#çº¿ç¨‹ä»»åŠ¡"></a>çº¿ç¨‹ä»»åŠ¡</h2><p>çº¿ç¨‹èƒ½æ‰§è¡Œçš„ä»»åŠ¡åˆ†ä¸º<B>Runnable</B>,<B>Callable</B>,<B>ForkJoinTask</B>ä¸‰ç±»,ä¸‹é¢æ¥è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹</p><h3 id="Runnable"><a class="header-anchor" href="#Runnable"></a>Runnable</h3><p>å®ç°<strong>Runnable</strong>æ¥å£</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//TODO æ‰§è¡Œä»£ç </span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Callable"><a class="header-anchor" href="#Callable"></a>Callable</h3><p>å®ç°**Callable<Objetc>**æ¥å£</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ForkJoinTask"><a class="header-anchor" href="#ForkJoinTask"></a>ForkJoinTask</h3><p>ç»§æ‰¿<strong>ForkJoinTask</strong>æ¥å£</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getRawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setRawResult</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å®ç°Runnableæ¥å£çš„æ–¹å¼æ¥æ‰§è¡Œä»»åŠ¡æ¯”ç›´æ¥åˆ›å»ºçº¿ç¨‹è¦å¥½çš„å¤šï¼Œè¿™æ ·å¯ä»¥å¤ç”¨çº¿ç¨‹ã€‚</p><h2 id="çº¿ç¨‹çŠ¶æ€"><a class="header-anchor" href="#çº¿ç¨‹çŠ¶æ€"></a>çº¿ç¨‹çŠ¶æ€</h2><p>çº¿ç¨‹çš„çŠ¶æ€å¯ä»¥åˆ†ä¸º</p><ol><li>New(æ–°åˆ›å»º)</li><li>Runnable(å¯è¿è¡Œ)</li><li>Blocked(å¯é˜»å¡)</li><li>Waiting(ç­‰å¾…)</li><li>Timed Waiting(è®¡æ—¶ç­‰å¾…)</li><li>Terminated(è¢«ç»ˆæ­¢)</li></ol><p><img src="https://s2.ax1x.com/2020/02/23/31vE4A.png" alt="çº¿ç¨‹çŠ¶æ€"></p><p>çº¿ç¨‹çš„åˆ›å»º/å¯åŠ¨/æ‰§è¡Œæ˜¯ç”±JVMçš„nativeæ–¹æ³•è°ƒç”¨æ“ä½œç³»ç»Ÿçš„APIè¿›è¡Œæ‰§è¡Œ</p><h2 id="ä¸­æ–­çº¿ç¨‹"><a class="header-anchor" href="#ä¸­æ–­çº¿ç¨‹"></a>ä¸­æ–­çº¿ç¨‹</h2><p>åœ¨javaä¸­ä¸æä¾›å¼ºåˆ¶åœæ­¢çº¿ç¨‹çš„æ–¹å¼ï¼Œå› ä¸ºçº¿ç¨‹çš„å¼ºåˆ¶åœæ­¢å¯èƒ½ä¼šé€ æˆæ•°æ®å¼‚å¸¸æˆ–è€…ä¸šåŠ¡ä¸­æ–­ï¼Œè¿™æ˜¯ä¸šåŠ¡æ–¹å’Œä¸­æ–­æ–¹éƒ½ä¸æ„¿æ„çœ‹åˆ°çš„æ–¹å¼ã€‚javaæä¾›çš„æ–¹å¼æ˜¯å¸Œæœ›çº¿ç¨‹ä¹‹é—´å¯ä»¥ç›¸äº’çš„é€šçŸ¥ã€ç›¸äº’ååŠ©ã€‚æä¾›è¿™ä¸ªæ–¹å¼çš„æ˜¯<strong>interrupt</strong>ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//more work to do</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åˆ¤æ–­çº¿ç¨‹æ¡ä»¶å’Œä¸šåŠ¡è§„åˆ™éƒ½æ»¡è¶³æ—¶ï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</p><p>åœ¨çº¿ç¨‹<strong>sleep</strong>æœŸé—´ï¼Œçº¿ç¨‹å¯ä»¥æ„Ÿå—åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ„Ÿå—åˆ°ä¸­æ–­ä¿¡å·åä¼šæ¸…é™¤ä¸­æ–­ä½æ ‡å¿—å¹¶ä¸”æŠ›å‡º<strong>InterruptedException</strong>å¼‚å¸¸ã€‚</p><p>å…³äºçº¿ç¨‹ä¸­æ–­isInterrupted()å’Œçº¿ç¨‹å…³é—­stop()çš„åŒºåˆ«åœ¨äº<br>çº¿ç¨‹ä¸­æ–­æ˜¯ä¸ä¼šä¸­æ–­çº¿ç¨‹çš„è¿è¡Œçš„,è€Œçº¿ç¨‹å…³é—­stopä¼šå…³é—­çº¿ç¨‹,stop()æ˜¯ä¸å®‰å…¨çš„è¯´æ³•æ¥è‡ªäºstop()æ‰§è¡Œåä¼šç«‹å³é‡Šæ”¾è¯¥çº¿ç¨‹æ‰€æŒæœ‰çš„æ‰€æœ‰é”(åŒ…æ‹¬synchronizedæŒæœ‰çš„å…¨å±€å¯¹è±¡é”)</p><h2 id="volatileä¸èƒ½ä½œä¸ºçº¿ç¨‹æ ‡è®°ä½"><a class="header-anchor" href="#volatileä¸èƒ½ä½œä¸ºçº¿ç¨‹æ ‡è®°ä½"></a>volatileä¸èƒ½ä½œä¸ºçº¿ç¨‹æ ‡è®°ä½</h2><p>volatileä½œä¸ºæ ‡è®°ä½çš„æ—¶å€™ï¼Œå½“çº¿ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹ä»æ—§å¯ä»¥æ”¹å˜æ ‡è®°ä½çš„å€¼ï¼Œå› æ­¤volatileä¸é€‚åˆä½œä¸ºçº¿ç¨‹æ ‡è®°ä½ã€‚</p><h2 id="wait-notify-notifyAll-æ–¹æ³•ä½¿ç”¨æ³¨æ„"><a class="header-anchor" href="#wait-notify-notifyAll-æ–¹æ³•ä½¿ç”¨æ³¨æ„"></a>wait/notify/notifyAll()æ–¹æ³•ä½¿ç”¨æ³¨æ„</h2><ol><li>wait()æ–¹æ³•ï¼Œå¿…é¡»åœ¨<strong>synchronized</strong>ä¸­æŒæœ‰é”åæ‰èƒ½ä½¿ç”¨ï¼Œå› ä¸ºå¿…é¡»æŒæœ‰å¯¹è±¡çš„<strong>monitor</strong>é”ï¼Œè¿™æ ·æ‰èƒ½é˜²æ­¢åœ¨æ‰§è¡Œå‰åçº¿ç¨‹è¢«åˆ‡æ¢ã€‚</li><li><strong>sleep()<strong>è¢«å®šä¹‰åœ¨Threadä¸­ï¼Œwait/notify/notifyAlléƒ½è¦æ“ä½œ</strong>monitor</strong>,å±äºå¯¹è±¡çº§çš„é”ã€‚</li><li>wait/notifyä¸sleepçš„åŒºåˆ«<ol><li>ç›¸åŒç‚¹<br>éƒ½è®©çº¿ç¨‹é˜»å¡ã€éƒ½å¯å“åº”InterruptExceptionå¼‚å¸¸</li><li>ä¸åŒç‚¹<br>2.1 sleepä¸ä¼šé‡Šæ”¾monitoré”<br>2.2 sleepæ–¹æ³•å¿…é¡»å®šä¹‰ä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œåˆ°æœŸåå¯ä¸»åŠ¨æ¢å¤ï¼Œwaitæ–¹æ³•æ²¡æ—¶é—´å‚æ•°æ„å‘³ç€ä¸€ç›´ä¼šç­‰å¾…ä¸‹å»<br>2.3 wait/notifyæ˜¯Objectçš„ï¼Œsleepæ˜¯Threadçš„æ–¹æ³•<br>2.4 waitå¿…é¡»åœ¨synchronizedä¸­ä½¿ç”¨<br>waitå¿…é¡»åœ¨synchronizedä¸­ä½¿ç”¨çš„åŸå› æ˜¯å› ä¸ºé˜²æ­¢æŒ‡ä»¤çš„ä¹±åºæ‰§è¡Œå¯¼è‡´wait()åçš„ä»£ç æå‰æ‰§è¡Œ,ä½¿ç”¨synchronizedæ¥ä¿è¯åŸå­æ€§</li></ol></li></ol><h2 id="å‚è€ƒæ–‡ç« "><a class="header-anchor" href="#å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.baeldung.com/java-thread-stop">å¦‚ä½•æ€æ­»javaä¸­çš„Thread</a><br><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/doc-files/threadPrimitiveDeprecation.html">Java Thread Primitive Deprecation</a></p>]]></content>
      
      
      <categories>
          
          <category> javaå¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
