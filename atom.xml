<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>agmtopyåšå®¢</title>
  
  <subtitle>agmtopy</subtitle>
  <link href="https://agmtopy.gitee.io/atom.xml" rel="self"/>
  
  <link href="https://agmtopy.gitee.io/"/>
  <updated>2022-02-03T01:31:07.503Z</updated>
  <id>https://agmtopy.gitee.io/</id>
  
  <author>
    <name>agmtopy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>rediså¦‚ä½•å®ç°æŒä¹…åŒ–çš„</title>
    <link href="https://agmtopy.gitee.io/2022/01/20/1.%E6%9D%82%E8%AE%B0/redis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84/"/>
    <id>https://agmtopy.gitee.io/2022/01/20/1.%E6%9D%82%E8%AE%B0/redis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84/</id>
    <published>2022-01-20T15:07:22.000Z</published>
    <updated>2022-02-03T01:31:07.503Z</updated>
    
    <content type="html"><![CDATA[<h1>rediså¦‚ä½•å®ç°æŒä¹…åŒ–çš„</h1><p>redisç›®å‰å®ç°æŒä¹…åŒ–ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼,ä¸€ç§æ˜¯é€šè¿‡<B>RDBæ–‡ä»¶</B>,å¦å¤–ä¸€ç§æ˜¯é€šè¿‡<B>AOFæ–‡ä»¶</B>.<br>rediså¯¹äºæŒä¹…åŒ–æ”¯æŒ4ç§éƒ¨ç½²æ–¹å¼</p><ul><li>æ— æŒä¹…æ€§</li><li>RDB</li><li>AOF</li><li>RDB + AOF</li></ul><p>è®©å°±è®©æˆ‘ä»¬æ¥è¯¦ç»†æ¯”è¾ƒå’Œåˆ†æä»¥ä¸‹redisåº•å±‚æ˜¯å¦‚ä½•å®ç°çš„RDBå’ŒAOFæœºåˆ¶çš„</p><h2 id="RDBæ–‡ä»¶"><a class="header-anchor" href="#RDBæ–‡ä»¶"></a>RDBæ–‡ä»¶</h2><ul><li>RDBå®šä¹‰</li></ul><blockquote><p>RDB æŒä¹…æ€§æŒ‡çš„æ˜¯åœ¨æŒ‡å®šæ—¶é—´é—´éš”åæ‰§è¡Œè®°å½•å½“å‰æ•°æ®é›†çš„å…¨éƒ¨æ•°æ®å¿«ç…§</p></blockquote><p>RDBæ–‡ä»¶å°±ç±»ä¼¼äºMySqlè¿›è¡Œå…¨é‡å¤‡ä»½,è®°å½•æŸä¸€ä¸ªæ—¶é—´ç‚¹çš„å…¨éƒ¨æ•°æ®</p><ul><li>RDBä¼˜ç‚¹</li></ul><ol><li>æ–‡ä»¶å³æ•°æ®,ä¸æµªè´¹ç©ºé—´</li><li>å¼‚æ­¥ç”Ÿæˆæ–‡ä»¶,æ€§èƒ½æŸè€—æœ€å°</li><li>ä¸éœ€è¦é‡æ–°æ‰§è¡ŒæŒ‡ä»¤,æ•°æ®æ¢å¤æ›´å¿«</li><li>æ”¯æŒä¸»ä»åˆ‡æ¢åçš„æ•°æ®åŒæ­¥</li></ol><ul><li>RDBç¼ºç‚¹</li></ul><ol><li>æ²¡æœ‰é‡‡ç”¨LSMæ—¥å¿—å¤„ç†,ä¼šä¸¢å¤±æ•°æ®</li><li>å¯¹äºéœ€è¦æŒä¹…åŒ–å¤§é‡æ•°æ®æ—¶,æ€§èƒ½ä¸å¦‚AOFå¢é‡æ¨¡å¼</li></ol><h3 id="ä½¿ç”¨å®ä¾‹"><a class="header-anchor" href="#ä½¿ç”¨å®ä¾‹"></a>ä½¿ç”¨å®ä¾‹</h3><p>RDBæœ‰ä¸¤ç§è§¦å‘æ–¹å¼:</p><ol><li>é…ç½®æ–‡ä»¶è§¦å‘</li><li>å‘½ä»¤è§¦å‘</li></ol><ul><li>é…ç½®æ–‡ä»¶è§¦å‘</li></ul><p>é…ç½®æ–‡ä»¶è§¦å‘ä¸ºåœ¨<B>redis.conf</B>ä¸­è®¾ç½®</p><pre class="line-numbers language-config" data-language="config"><code class="language-config">#æ–‡ä»¶è·¯å¾„dir#RDBæ–‡ä»¶åç§°dbfilename #æ˜¯å¦å¯ç”¨æ•°æ®æ ¡éªŒrdbchecksum yes#æ˜¯å¦å¯ç”¨RDBæ–‡ä»¶å‹ç¼©æ ¼å¼rdbcompression yes#bgsaveå¼‚å¸¸æ—¶æ˜¯å¦åœæ­¢å†™å…¥ç¼“å­˜stop-writes-on-bgsave-error yes#60ç§’å†…æœ‰5ä¸ªå€¼å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘ç”ŸæˆRDBæ–‡ä»¶save 60 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>å‘½ä»¤è§¦å‘</p><ul><li>save<br>åŒæ­¥é˜»å¡å‘½ä»¤</li><li>bgsave<br>forkå­è¿›ç¨‹å¼‚æ­¥ç”ŸæˆRDBæ–‡ä»¶</li></ul></li></ul><h3 id="æºç è§£æ"><a class="header-anchor" href="#æºç è§£æ"></a>æºç è§£æ</h3><ul><li>bgsaveçš„æ‰§è¡Œè°ƒç”¨é“¾</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-22%20230847.jpg" alt="bgsaveçš„æ‰§è¡Œé“¾"></p><blockquote><p><B>server.main()</B> -&gt; <B>server.processCommand()</B> -&gt; <B>rdb.rdbSaveBackground()</B> -&gt; <B>rdb.redisFork()</B></p></blockquote><p>ä¸‹é¢è‡ªåº•å‘ä¸Šä¾æ¬¡åˆ†æä¸‹è¿™ä¸ªå››ä¸ªæ–¹æ³•</p><ul><li><B>rdbSave()</B></li></ul>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* å°†æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸Š */</span><span class="token keyword">int</span> <span class="token function">rdbSave</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> rdbSaveInfo <span class="token operator">*</span>rsi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> tmpfile<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> cwd<span class="token punctuation">[</span>MAXPATHLEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Current working dir path for error messages. */</span>    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    rio rdb<span class="token punctuation">;</span>    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">snprintf</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">"temp-%d.rdb"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>cwdp <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span>MAXPATHLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>            <span class="token string">"Failed opening the RDB file %s (in server root dir %s) "</span>            <span class="token string">"for saving: %s"</span><span class="token punctuation">,</span>            filename<span class="token punctuation">,</span>            cwdp <span class="token operator">?</span> cwdp <span class="token operator">:</span> <span class="token string">"unknown"</span><span class="token punctuation">,</span>            <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">rioInitWithFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdb<span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startSaving</span><span class="token punctuation">(</span>RDBFLAGS_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_save_incremental_fsync<span class="token punctuation">)</span>        <span class="token function">rioSetAutoSync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdb<span class="token punctuation">,</span>REDIS_AUTOSYNC_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rdbSaveRio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdb<span class="token punctuation">,</span><span class="token operator">&amp;</span>error<span class="token punctuation">,</span>RDBFLAGS_NONE<span class="token punctuation">,</span>rsi<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        errno <span class="token operator">=</span> error<span class="token punctuation">;</span>        <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* Make sure data will not remain on the OS's output buffers */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fflush</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fsync</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token comment">//é‡å‘½åæ–‡ä»¶æ¥å®ç°å†™å…¥æ–‡ä»¶çš„åŸå­æ€§</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span>filename<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>cwdp <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span>MAXPATHLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span>            <span class="token string">"Error moving temp DB file %s on the final "</span>            <span class="token string">"destination %s (in server root dir %s): %s"</span><span class="token punctuation">,</span>            tmpfile<span class="token punctuation">,</span>            filename<span class="token punctuation">,</span>            cwdp <span class="token operator">?</span> cwdp <span class="token operator">:</span> <span class="token string">"unknown"</span><span class="token punctuation">,</span>            <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">unlink</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">stopSaving</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"RDBè½ç›˜æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span>lastsave <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span>lastbgsave_status <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>    <span class="token function">stopSaving</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>werr<span class="token operator">:</span>    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Write error saving DB on disk: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unlink</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">stopSaving</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>rdbSave()</B>å®Œæˆå¯¹RDBæ–‡ä»¶çš„å†™å…¥æ“ä½œ:</p><ol><li>åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶,å°†å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œå†™å…¥,ç„¶ååˆ·ç›˜</li><li>å¯¹ä¸´æ—¶æ–‡ä»¶è¿›è¡Œrename(ğŸ‘å†™å…¥æ–‡ä»¶ä¸ä¸€å®šæ˜¯åŸå­,ä½†æ˜¯rename fileä¸€å®šæ˜¯åŸå­æ€§çš„),æ¥ä¿è¯æ–‡ä»¶å†™å…¥çš„åŸå­æ€§</li></ol><ul><li><B>rdbSaveBackground</B></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">rdbSaveBackground</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> rdbSaveInfo <span class="token operator">*</span>rsi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pid_t</span> childpid<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>    server<span class="token punctuation">.</span>dirty_before_bgsave <span class="token operator">=</span> server<span class="token punctuation">.</span>dirty<span class="token punctuation">;</span>    server<span class="token punctuation">.</span>lastbgsave_try <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//forkå­è¿›ç¨‹è¿›è¡Œå¤„ç†RDBæ–‡ä»¶,è¿™é‡Œçš„fork()è¿”å›å€¼-1è¡¨ç¤ºæ²¡æœ‰åˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸ,0è¡¨ç¤ºåˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>childpid <span class="token operator">=</span> <span class="token function">redisFork</span><span class="token punctuation">(</span>CHILD_TYPE_RDB<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> retval<span class="token punctuation">;</span>        <span class="token comment">/* Child */</span>        <span class="token function">redisSetProcTitle</span><span class="token punctuation">(</span><span class="token string">"redis-rdb-bgsave"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">redisSetCpuAffinity</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>bgsave_cpulist<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"RDBæ–‡ä»¶ä¸º: %s"</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>        retval <span class="token operator">=</span> <span class="token function">rdbSave</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span>rsi<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç”Ÿæˆrdbæ–‡ä»¶</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">sendChildCowInfo</span><span class="token punctuation">(</span>CHILD_INFO_TYPE_RDB_COW_SIZE<span class="token punctuation">,</span> <span class="token string">"RDB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">exitFromChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>retval <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/* çˆ¶è¿›ç¨‹å¤„ç† */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>childpid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            server<span class="token punctuation">.</span>lastbgsave_status <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Can't save in background: fork: %s"</span><span class="token punctuation">,</span>                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Background saving started by pid %ld"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> childpid<span class="token punctuation">)</span><span class="token punctuation">;</span>        server<span class="token punctuation">.</span>rdb_save_time_start <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        server<span class="token punctuation">.</span>rdb_child_type <span class="token operator">=</span> RDB_CHILD_TYPE_DISK<span class="token punctuation">;</span>        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span> <span class="token comment">/* unreached */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨é€šè¿‡<B>redisFork()</B>åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹æ¥å®Œæˆ<B>rdbSave()</B>çš„è°ƒç”¨</p><p>çˆ¶è¿›ç¨‹ä¸ä¼šé˜»å¡è€Œæ˜¯ç›´æ¥æ‰“å°RDBæ–‡ä»¶å¼€å§‹å¤„ç†çš„æ¶ˆæ¯</p><p>éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯fork()è¿›ç¨‹çš„æ–¹æ³•è¿”å›å€¼æ˜¯0-æˆåŠŸ/-1-å¤±è´¥</p><p>åœ¨è¿™ä¸€æ­¥çš„è°ƒç”¨ä¸­çœç•¥<B>rdb.bgsaveCommand()</B>çš„è°ƒç”¨é€»è¾‘,ç›´æ¥åˆ†æ<B>server.c</B>ä¸­çš„é€»è¾‘</p><ul><li><B>server.c()</B></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> redisCommandTable<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span><span class="token string">"module"</span><span class="token punctuation">,</span>moduleCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token string">"admin no-script"</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span><span class="token string">"get"</span><span class="token punctuation">,</span>getCommand<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token string">"read-only fast @string"</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span><span class="token string">"bgsave"</span><span class="token punctuation">,</span>bgsaveCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token string">"admin no-script"</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">//çœç•¥å…¶ä»–å‘½ä»¤</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä½¿ç”¨å‘½ä»¤æ¨¡å¼å°†æ‰€æœ‰å®¢æˆ·ç«¯å‘½ä»¤ä»¥åŠå‘½ä»¤çš„å¤„ç†æ–¹å¼æ”¾åˆ°<B>redisCommandTable</B>ä¸­è¿›è¡Œå¤„ç†,ç„¶ååœ¨å’Œç½‘ç»œæ—¶é—´ç»‘å®šå°±å½¢æˆæœ€å¼€å§‹è¯´çš„è°ƒç”¨é“¾ç»“æ„</p><ul><li>cronæ–¹å¼å¯åŠ¨<br>cronæ–¹å¼å¯åŠ¨çš„é€»è¾‘ä½äº<B>server.serverCron()</B>ä¸­</li></ul><h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“"></a>å°ç»“</h3><p>RDBæ–‡ä»¶æ˜¯é€šè¿‡fork()å­è¿›ç¨‹æ¥å¤„ç†æ–‡ä»¶,é‡‡ç”¨çš„æ˜¯rename temp fileçš„æ–¹å¼ä¿è¯åŸå­æ€§. çˆ¶è¿›ç¨‹å¹¶ä¸ä¼šé˜»å¡,è€Œæ˜¯å¯åŠ¨å­è¿›ç¨‹åç«‹å³è¿”å›</p><h2 id="AOFæ–‡ä»¶"><a class="header-anchor" href="#AOFæ–‡ä»¶"></a>AOFæ–‡ä»¶</h2><p>AOFæ–‡ä»¶å°±ç±»ä¼¼äºMySqlä¸­çš„binlogä½¿ç”¨çš„Statementæ ¼å¼è®°å½•æ•°æ®å˜åŒ–,æ¯æ¬¡åªè®°å½•æŒ‡ä»¤,å¹¶ä¸”è¶…è¿‡è®¾å®šçš„å¤§å°åä¼šè¿›è¡Œè¦†ç›–</p><h3 id="ä½¿ç”¨å®ä¾‹-v2"><a class="header-anchor" href="#ä½¿ç”¨å®ä¾‹-v2"></a>ä½¿ç”¨å®ä¾‹</h3><ul><li>é…ç½®æ–‡ä»¶</li></ul><pre class="line-numbers language-config" data-language="config"><code class="language-config">#å¼€å¯redis aofappendonly yes#aofåˆ·æ–°æœºåˆ¶ always:æ¯ä¸€æ¡éƒ½å†™å…¥ç£ç›˜,everysec:æ¯ç§’å†™å…¥ç£ç›˜ä¸€æ¬¡,no:æ–‡ä»¶ç³»ç»Ÿåˆ·æ–°appendfsync everysec#aofæ–‡ä»¶æ‰©å®¹çš„é˜€å€¼æ¯”ä¾‹auto-aof-rewrite-percentage 100#aofæ–‡ä»¶é‡å†™åçš„åˆå§‹å¤§å°auto-aof-rewrite-min-size 64mb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æºç è§£æ-v2"><a class="header-anchor" href="#æºç è§£æ-v2"></a>æºç è§£æ</h3><h3 id="å°ç»“-v2"><a class="header-anchor" href="#å°ç»“-v2"></a>å°ç»“</h3><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><h2 id="å‚è€ƒæ–‡ç« "><a class="header-anchor" href="#å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://redis.io/topics/persistence">Redis Persistence</a><br><a href="http://oldblog.antirez.com/post/redis-persistence-demystified.html">Redis persistence demystified</a><br><a href="https://redis.io/topics/latency">Redis å»¶è¿Ÿé—®é¢˜æ’æŸ¥</a><br><a href="https://dl.acm.org/doi/fullHtml/10.1145/3318159">TxFSï¼šåˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿå´©æºƒä¸€è‡´æ€§æ¥æä¾› ACID äº‹åŠ¡</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;rediså¦‚ä½•å®ç°æŒä¹…åŒ–çš„&lt;/h1&gt;
&lt;p&gt;redisç›®å‰å®ç°æŒä¹…åŒ–ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼,ä¸€ç§æ˜¯é€šè¿‡&lt;B&gt;RDBæ–‡ä»¶&lt;/B&gt;,å¦å¤–ä¸€ç§æ˜¯é€šè¿‡&lt;B&gt;AOFæ–‡ä»¶&lt;/B&gt;.&lt;br&gt;
rediså¯¹äºæŒä¹…åŒ–æ”¯æŒ4ç§éƒ¨ç½²æ–¹å¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ— æŒä¹…æ€§&lt;/li&gt;
&lt;li&gt;RDB&lt;/</summary>
      
    
    
    
    <category term="æ‚è®°" scheme="https://agmtopy.gitee.io/categories/%E6%9D%82%E8%AE%B0/"/>
    
    
    <category term="redis" scheme="https://agmtopy.gitee.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisæºä»£ç æ„å»º</title>
    <link href="https://agmtopy.gitee.io/2022/01/19/1.%E6%9D%82%E8%AE%B0/redis%E6%BA%90%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA/"/>
    <id>https://agmtopy.gitee.io/2022/01/19/1.%E6%9D%82%E8%AE%B0/redis%E6%BA%90%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA/</id>
    <published>2022-01-19T13:52:20.000Z</published>
    <updated>2022-01-20T15:06:15.063Z</updated>
    
    <content type="html"><![CDATA[<h1>redisæºä»£ç æ„å»º</h1><p>ä¸»è¦ç”¨æ¥è®°å½•ä»¥ä¸‹åœ¨WSLä¸‹ç¼–è¯‘å’Œéƒ¨ç½²redisæºç çš„è¿‡ç¨‹</p><h2 id="ç¯å¢ƒå‡†å¤‡"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ul><li><p>WSL<br>wsl2æ­é…Ubuntu 18.04ä½¿ç”¨,è¿™ä¸€é¡¹ä¸æ˜¯å¿…é¡»çš„<br><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20220306.jpg" alt="wsl"></p></li><li><p>Clion<br>JetBrainsçš„C/C++ IDE,è¿™ä¸€é¡¹ä¹Ÿä¸æ˜¯å¿…é¡»çš„</p></li><li><p>æºä»£ç <br><a href="https://github.com/redis/redis">https://github.com/redis/redis</a></p></li></ul><h2 id="æ„å»ºè¿‡ç¨‹"><a class="header-anchor" href="#æ„å»ºè¿‡ç¨‹"></a>æ„å»ºè¿‡ç¨‹</h2><ul><li>æŒ‰ç…§Linuxç¼–è¯‘å·¥å…·</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> update<span class="token function">apt</span> <span class="token function">install</span> <span class="token function">git</span>  cmake <span class="token function">make</span> gcc g++ gdb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>æ„å»ºrelease.h</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#æˆæƒ</span><span class="token function">chmod</span> +x mkreleasehdr.sh<span class="token comment">#æ‰§è¡Œmake</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤å°±å®Œæˆredisæºä»£ç çš„ç¼–è¯‘,æ¥ä¸‹æ¥è®©æˆ‘ä»¬æŠŠæºä»£ç å¯¼å…¥CLionä¸­è¿›è¡Œdebug</p><h2 id="è°ƒè¯•è¿‡ç¨‹"><a class="header-anchor" href="#è°ƒè¯•è¿‡ç¨‹"></a>è°ƒè¯•è¿‡ç¨‹</h2><ul><li>å¯¼å…¥é¡¹ç›®</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20231623.jpg" alt="å¯¼å…¥é¡¹ç›®"></p><ul><li>è®¾ç½®è¿œç¨‹éƒ¨ç½²</li></ul><ol><li>è®¾ç½®è¿œç¨‹éƒ¨ç½²å·¥å…·é“¾</li></ol><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20231847.jpg" alt="å·¥å…·é“¾"></p><ol start="2"><li>è®¾ç½®CMake</li></ol><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20231912.jpg" alt="CMake"></p><ol start="3"><li>è®¾ç½®MakeFile</li></ol><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20232004.jpg" alt="MakeFile"></p><ul><li>è®¾ç½®è°ƒè¯•å™¨</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20232030.jpg" alt="è®¾ç½®è°ƒè¯•å™¨"></p><h2 id="debug"><a class="header-anchor" href="#debug"></a>debug</h2><ul><li>å¯åŠ¨redis-server</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20232618.jpg" alt="å¯åŠ¨redis-server"></p><ul><li>è®¾ç½®æ–­ç‚¹</li></ul><p><img src="https://hexo-1254947285.cos.ap-chengdu.myqcloud.com/hexo/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-01-19%20235133.jpg" alt="è®¾ç½®æ–­ç‚¹"></p><p>ä»¥setä¸ºä¾‹,åŸºæœ¬è°ƒç”¨è¿‡ç¨‹ä¸º<br><B>server.c</B> -&gt; <B>connection.c</B> -&gt; <B>t_set.c</B></p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯æœ¬åœ°ç¼–è¯‘redisçš„è¿‡ç¨‹,åç»­å®˜ç½‘ä¸Šè¿˜æœ‰ç¼–è¯‘æŒ‚è½½redisæ‰©å±•åº“çš„è¿‡ç¨‹å’Œdockerfileçš„ç›¸å…³æ“ä½œ(æœªå®Œå¾…ç»­!)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;redisæºä»£ç æ„å»º&lt;/h1&gt;
&lt;p&gt;ä¸»è¦ç”¨æ¥è®°å½•ä»¥ä¸‹åœ¨WSLä¸‹ç¼–è¯‘å’Œéƒ¨ç½²redisæºç çš„è¿‡ç¨‹&lt;/p&gt;
&lt;h2 id=&quot;ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;/a&gt;ç¯å¢ƒå‡†å¤‡&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;WSL&lt;b</summary>
      
    
    
    
    <category term="æ‚è®°" scheme="https://agmtopy.gitee.io/categories/%E6%9D%82%E8%AE%B0/"/>
    
    
    <category term="redis" scheme="https://agmtopy.gitee.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisåº•å±‚æ•°æ®ç»“æ„åˆ†æ</title>
    <link href="https://agmtopy.gitee.io/2022/01/05/1.%E6%9D%82%E8%AE%B0/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/"/>
    <id>https://agmtopy.gitee.io/2022/01/05/1.%E6%9D%82%E8%AE%B0/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/</id>
    <published>2022-01-05T14:51:45.000Z</published>
    <updated>2022-01-19T13:48:09.270Z</updated>
    
    <content type="html"><![CDATA[<h1>redisåº•å±‚æ•°æ®ç»“æ„åˆ†æ</h1><p>redisåº•å±‚æ•°æ®ç»“æ„åˆ†æä¸»è¦æ˜¯æ ¹æ®ã€ŠRedis5 è®¾è®¡ä¸æºç åˆ†æã€‹ä¸€ä¹¦çš„ç« èŠ‚è€Œæ¥,å‚è€ƒå¯¹ç…§ä»£ç ç‰ˆæœ¬ä¸º6.2,æºä»£ç çš„ç¼–è¯‘å’Œéƒ¨ç½²å¯ä»¥æŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« </p><p>redisåº•å±‚æ•°æ®ç»“æ„å¯ä»¥åˆ’åˆ†ä¸º</p><ul><li>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</li><li>è·³è·ƒè¡¨</li><li>å‹ç¼©åˆ—è¡¨</li><li>å­—å…¸</li><li>æ•´æ•°é›†åˆ</li><li>quicklist</li><li>stream</li></ul><p>è¿™ä¸ƒç§æ•°æ®ç±»å‹,ä¸‹é¢åˆ†åˆ«å¯¹è¿™ä¸ƒç§æ•°æ®ç±»å‹è¿›è¡Œåˆ†æ</p><h2 id="ç®€å•åŠ¨æ€å­—ç¬¦ä¸²"><a class="header-anchor" href="#ç®€å•åŠ¨æ€å­—ç¬¦ä¸²"></a>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</h2><h3 id="æ•°æ®ç»“æ„"><a class="header-anchor" href="#æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²åˆè¢«ç§°ä¸º<B>SDS</B>,å‡ ä¹è´¯ç©¿redisä¸­æ‰€æœ‰çš„æ¨¡å—ã€‚redisä¸­é‡æ–°è®¾è®¡å­—ç¬¦ä¸²çš„åŸå› æ˜¯ç”±äºCè¯­è¨€ä¸­çš„char*,ä¸æ»¡è¶³redisä¸­çš„ä¸€äº›å¸¸ç”¨æ“ä½œä¾‹å¦‚è¿½åŠ å­—ç¬¦ã€<br>è®¡æ•°ç­‰ã€‚</p><ul><li><p>char*<br>åœ¨Cè¯­è¨€ä¸­å®šä¹‰çš„å­—ç¬¦ä¸²ç»“æ„ä¸º:å­—ç¬¦+å­—ç¬¦ç»“å°¾ï¼Œä¾‹å¦‚&quot;hello world!/n&quot;,è€Œ/nå°±æ˜¯å­—ç¬¦ç»“å°¾ï¼Œè¿™æ ·çš„ç»“æ„ä¸æ»¡è¶³redisæ‰€éœ€è¦çš„å¿«é€Ÿè¿½åŠ å’Œè®¡æ•°æ“ä½œ</p></li><li><p>SDS<br>SDSç»“æ„æ˜¯ä¸€ä¸ªå¯ä»¥æè¿°å­—ç¬¦ä¸²ç±»å‹(rediså†…éƒ¨ç”¨äºåŒºåˆ†é•¿åº¦)ã€å­—ç¬¦ä¸²é•¿åº¦ã€å­—ç¬¦æŒ‡é’ˆçš„ç±»å‹,ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„SDSçš„å®šä¹‰</p></li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">typedef char *sds;struct __attribute__ ((__packed__)) sdshdr8 &#123;    uint8_t len; &#x2F;* used *&#x2F;    uint8_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;    char buf[];&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°SDSçš„ç±»å‹è¿˜æ˜¯*charï¼Œä½†æ˜¯åœ¨å†…éƒ¨é‡æ–°å®šä¹‰äº†len-å ç”¨é•¿åº¦ã€alloc-æœ€å¤§é•¿åº¦ã€flags-æ ‡è¯†ç­‰ã€‚</p><p><img src="https://s2.loli.net/2022/01/17/VpmsYwhPUc9KBCq.png" alt="sdsçš„æ•°æ®ç»“æ„"></p><p>åœ¨è¿™å¼ å›¾ä¸­çš„<B>sdshdr8</B>ã€<B>sdshdr16</B>,flagsçš„ä½ä¸‰ä½å­˜å‚¨çš„æ˜¯SDSçš„ç±»å‹ï¼Œé«˜5ä½æ²¡æœ‰å«ä¹‰ï¼Œåœ¨SDS5ä¸­é«˜5ä½å­˜å‚¨çš„æ˜¯é•¿åº¦ã€‚<br>å®é™…å­˜å‚¨æ•°æ®çš„æ˜¯<B>buf[]</B>,buf[]æ˜¯ä¸€ä¸ªæŸ”æ€§æ•°ç»„ï¼ŒæŸ”æ€§æ•°ç»„æŒ‡çš„æ˜¯æ•°æ®ç»“æ„å’Œå†…å®¹åœ¨å†…å­˜ä¸Šæ˜¯è¿ç»­çš„ï¼Œè¿™æ ·çš„ç»“æ„æŸ¥è¯¢æ›´å¿«é€Ÿ(å› ä¸ºä¸éœ€è¦é¢å¤–è¿›è¡ŒæŒ‡é’ˆæ“ä½œ)<br>ä½¿ç”¨<B><strong>attribute</strong></B>è®©ç¼–è¯‘å™¨ä»¥ç´§å‡‘æ¨¡å¼è¿›è¡Œå†…å­˜åˆ†é…,è¿™æ ·å¯ä»¥èŠ‚çœ<B>flags</B>çš„3ä¸ªå­—èŠ‚ï¼Œé»˜è®¤å†…å­˜åˆ†é…æ˜¯ä»¥4ä¸ªå­—èŠ‚è¿›è¡Œåˆ†é…çš„</p><ul><li>å°ç»“<br>å…³äºSDSéœ€è¦è®°ä½çš„tags:</li></ul><ol><li>[ç»§æ‰¿] ç»§æ‰¿äºchar*</li><li>[ç±»å‹] æ˜¯ä¸€ç§åŠ¨æ€çš„å­—ç¬¦ä¸²ï¼Œæ ¹æ®å­—ç¬¦çš„é•¿åº¦å¯ä»¥åˆ†é…ä¸åŒçš„SDSç±»å‹</li><li>[ç»„æˆ] ç”±äºlenã€allocã€flagsã€buf[]æ„æˆ</li><li>[ç´§å‡‘] ç´§å‡‘æ¨¡å¼åˆ†é…ç±»å‹</li></ol><h3 id="æ“ä½œ"><a class="header-anchor" href="#æ“ä½œ"></a>æ“ä½œ</h3><p>SDS-åŠ¨æ€å­—ç¬¦ä¸²å…·æœ‰çš„æ“ä½œåˆ†åˆ«æœ‰å¢åˆ æ”¹æŸ¥è¿™å‡ ç§ï¼Œå…¶ä¸­åˆ é™¤çš„è®¾è®¡æ¯”è¾ƒç‰¹åˆ«ã€‚</p><ul><li>åˆ é™¤</li></ul><p>SDSçš„åˆ é™¤æ˜¯é€šè¿‡<B>sdsclear</B>æ¥å®ç°çš„,ç›´æ¥è®¾ç½®lenä¸º0çš„æ–¹å¼æ¥å®ç°</p><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* Modify an sds string in-place to make it empty (zero length).* However all the existing buffer is not discarded but set as free space* so that next append operations will not require allocations up to the* number of bytes previously available. *&#x2F;void sdsclear(sds s) &#123;    sdssetlen(s, 0);    s[0] &#x3D; &#39;\0&#39;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¢åŠ </li></ul><p>å¢åŠ æœºåˆ¶å¯å‚è€ƒä¸‹å›¾<br><img src="https://s2.loli.net/2022/01/06/LUTovNR2k3hyIKm.png" alt="redis_sds_æ‰©å®¹æœºåˆ¶"></p><p>ä¸»è¦æ˜¯è¿›è¡Œä¸¤ä¸ªåˆ¤æ–­</p><ol><li>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç±»å‹æ›´æ”¹</li></ol><p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸ä¼šä½¿ç”¨SDS5çš„ç±»å‹,å› ä¸ºRedisè®¤ä¸ºæ‰©å®¹æ˜¯ä¸€ç§å¸¸è§çš„æ“ä½œ,å› æ­¤SDS5å¾ˆå¤§çš„å‡ ç‡ä¼šæ›´æ–°æˆä¸ºSDS8ç±»å‹.</p><h2 id="è·³è·ƒåˆ—è¡¨"><a class="header-anchor" href="#è·³è·ƒåˆ—è¡¨"></a>è·³è·ƒåˆ—è¡¨</h2><h3 id="æ•°æ®ç»“æ„-v2"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v2"></a>æ•°æ®ç»“æ„</h3><p>è·³è·ƒåˆ—è¡¨æŒ‡çš„æ˜¯é€šè¿‡ç»´æŠ¤ä¸€ä¸ªå¤šå±‚çš„é“¾è¡¨ç»“æ„æ¥å®ç°å¿«é€ŸæŸ¥æ‰¾çš„æ•°æ®ç»“æ„<br><a href="https://zh.wikipedia.org/wiki/%E8%B7%B3%E8%B7%83%E5%88%97%E8%A1%A8">è·³è·ƒåˆ—è¡¨</a>çš„è§£é‡Š.<br>ä¸‹é¢æ˜¯ä¸€ä¸ªè·³è·ƒåˆ—è¡¨çš„æ•°æ®ç»“æ„</p><p><img src="https://s2.loli.net/2022/01/06/uciEDA9j2THBkJx.gif" alt="è·³è·ƒåˆ—è¡¨"></p><blockquote><p>é€šè¿‡å°†æœ‰åºé›†åˆçš„éƒ¨åˆ†èŠ‚ç‚¹åˆ†å±‚ï¼Œç”±æœ€ä¸Šå±‚å¼€å§‹ä¾æ¬¡å‘åæŸ¥æ‰¾ï¼Œå¦‚æœæœ¬å±‚çš„nextèŠ‚ç‚¹å¤§äºè¦æŸ¥æ‰¾çš„å€¼æˆ–nextèŠ‚ç‚¹ä¸ºNULLï¼Œåˆ™ä»æœ¬èŠ‚ç‚¹å¼€å§‹ï¼Œé™ä½ä¸€å±‚ç»§ç»­å‘åæŸ¥æ‰¾ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå¦‚æœæ‰¾åˆ°åˆ™è¿”å›èŠ‚ç‚¹ï¼›å¦åˆ™è¿”å›NULLã€‚é‡‡ç”¨è¯¥åŸç†æŸ¥æ‰¾èŠ‚ç‚¹ï¼Œåœ¨èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤šæ—¶ï¼Œå¯ä»¥è·³è¿‡ä¸€äº›èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢æ•ˆç‡å¤§å¤§æå‡ï¼Œè¿™å°±æ˜¯è·³è·ƒè¡¨çš„åŸºæœ¬æ€æƒ³ã€‚</p></blockquote><p>redisä¸­çš„è·³è·ƒåˆ—è¡¨ä¸»è¦æ˜¯ç”±ä¸¤ä¸ªå…ƒç´ è¿›è¡Œå®ç°<B>zskiplistNode</B>ã€<B>zskiplist</B>,ä¸‹é¢æ¥è¯¦ç»†åˆ†æä¸€ä¸‹è¿™ä¸¤ä¸ªå…ƒç´ çš„æºä»£ç </p><ul><li>zskiplistNode</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* ZSETs æ‰€ä½¿ç”¨çš„ç‰¹æ®Šç‰ˆæœ¬çš„Skiplists *&#x2F;typedef struct zskiplistNode &#123;    &#x2F;&#x2F;å­—ç¬¦ä¸²ç±»å‹ele    sds ele;    &#x2F;&#x2F;ç”¨äºå­˜å‚¨æ’åºçš„åˆ†å€¼,æœ€åº•å±‚çš„åˆ—è¡¨å°±æ˜¯æ ¹æ®è¿™ä¸ªåˆ†å€¼è¿›è¡Œæ’åº    double score;    &#x2F;&#x2F;åé€€æŒ‡é’ˆ    struct zskiplistNode *backward;    &#x2F;&#x2F;å±‚ä¿¡æ¯æè¿°    struct zskiplistLevel &#123;        &#x2F;&#x2F;åŒå±‚ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ        struct zskiplistNode *forward;        &#x2F;&#x2F;åŒå±‚ä¸­çš„è·¨åº¦,ç”¨äºè®¡æ•°        unsigned long span;    &#125; level[];&#125; zskiplistNode;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>zskiplist</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">typedef struct zskiplist &#123;    &#x2F;&#x2F;åˆ†åˆ«æŒ‡å‘è·³è·ƒåˆ—è¡¨çš„å¤´ç»“ç‚¹æŒ‡é’ˆå’Œå°¾èŠ‚ç‚¹æŒ‡é’ˆ    struct zskiplistNode *header, *tail;    &#x2F;&#x2F;åˆ—è¡¨çš„é•¿åº¦    unsigned long length;    &#x2F;&#x2F;åˆ—è¡¨çš„é«˜åº¦    int level;&#125; zskiplist;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ“ä½œ-v2"><a class="header-anchor" href="#æ“ä½œ-v2"></a>æ“ä½œ</h3><ul><li>æŸ¥æ‰¾è¿‡ç¨‹</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* æŸ¥è¯¢åŒ…å«åœ¨æŒ‡å®šèŒƒå›´å†…çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåä¹‹è¿”å›null. *&#x2F;zskiplistNode *zslFirstInRange(zskiplist *zsl, zrangespec *range)&#123;    zskiplistNode *x;    int i;    &#x2F;* åˆ¤æ–­ä¼ å…¥èŒƒå›´è¶…è¿‡åˆ—è¡¨èŒƒå›´ *&#x2F;    if (!zslIsInRange(zsl, range))        return NULL;    x &#x3D; zsl-&gt;header;    &#x2F;&#x2F;ä»æœ€é«˜å±‚å‘ä¸‹æŸ¥æ‰¾    for (i &#x3D; zsl-&gt;level - 1; i &gt;&#x3D; 0; i--)    &#123;        &#x2F;* åœ¨åŒä¸€å±‚å†…ä»å·¦åˆ°å³ä¾æ¬¡æŸ¥æ‰¾ *&#x2F;        while (x-&gt;level[i].forward &amp;&amp; !zslValueGteMin(x-&gt;level[i].forward-&gt;score, range))            x &#x3D; x-&gt;level[i].forward;    &#125;    &#x2F;* ç›®æ ‡èŠ‚ç‚¹ä¸èƒ½æ˜¯æœ€åä¸€ä¸ª*tailèŠ‚ç‚¹ *&#x2F;    x &#x3D; x-&gt;level[0].forward;    serverAssert(x !&#x3D; NULL);    &#x2F;*å†æ¬¡æ£€æµ‹åˆ†æ•°é™åˆ¶ *&#x2F;    if (!zslValueLteMax(x-&gt;score, range))        return NULL;    return x;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆä»ä¸Šåˆ°ä¸‹ï¼Œå†ä»å·¦åˆ°å³çš„è¿›è¡ŒæŸ¥æ‰¾</p><ul><li>è·³è·ƒåˆ—è¡¨çš„å®é™…åº”ç”¨</li></ul><p>è·³è·ƒåˆ—è¡¨ä¸»è¦æ˜¯ä½œä¸º<B>zset</B>çš„ä¸€ç§åº•å±‚å®ç°,åœ¨æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶åzsetä¼šä½¿ç”¨<B>å‹ç¼©åˆ—è¡¨-ziplist</B>ä½œä¸ºåº•å±‚å®ç°</p><ol><li>æœ‰åºé›†åˆå…ƒç´ æ•°é‡å°äº128ä¸ªæ—¶</li><li>å…ƒç´ å¤§å°ä¸è¶…è¿‡64å­—èŠ‚æ—¶</li><li>é›†åˆå¤§å°æ“ä½œ1Gæ—¶<br>å¦‚æœä¸åŒæ—¶æ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶æ—¶,åˆ™ä½¿ç”¨<B>skipList-è·³è·ƒåˆ—è¡¨</B>ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„,è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯zsetåº•å±‚ç»“æ„è½¬æ¢æˆä¸ºskipListä»¥å,å°±ä¸ä¼šåœ¨è½¬æ¢æˆä¸ºziplist</li></ol><ul><li>zset</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">//å¦‚æœå½“å‰åˆ—è¡¨é•¿åº¦å¤§äº128ä¸ªæ—¶è¿›è¡Œè½¬åŒ–</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zzlLength</span><span class="token punctuation">(</span>zobj<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">></span> server<span class="token punctuation">.</span>zset_max_ziplist_entries <span class="token operator">||</span> <span class="token comment">//å¦‚æœå½“å‰åˆ—è¡¨æ ¼å¼å¤§äº64ä¸ªæ—¶è¿›è¡Œè½¬åŒ–</span>    <span class="token function">sdslen</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span> <span class="token operator">></span> server<span class="token punctuation">.</span>zset_max_ziplist_value <span class="token operator">||</span>  <span class="token comment">//å¦‚æœå½“å‰åˆ—è¡¨å¤§å°å¤§äº1Gæ—¶è¿›è¡Œè½¬åŒ–</span>    <span class="token operator">!</span><span class="token function">ziplistSafeToAdd</span><span class="token punctuation">(</span>zobj<span class="token operator">-></span>ptr<span class="token punctuation">,</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>      <span class="token comment">//è½¬æ¢ä¸ºskipç»“æ„</span>      <span class="token function">zsetConvert</span><span class="token punctuation">(</span>zobj<span class="token punctuation">,</span>OBJ_ENCODING_SKIPLIST<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//ç»§ç»­æ·»åŠ æ•°æ®</span>      zobj<span class="token operator">-></span>ptr <span class="token operator">=</span> <span class="token function">zzlInsert</span><span class="token punctuation">(</span>zobj<span class="token operator">-></span>ptr<span class="token punctuation">,</span>ele<span class="token punctuation">,</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newscore<span class="token punctuation">)</span> <span class="token operator">*</span>newscore <span class="token operator">=</span> score<span class="token punctuation">;</span>      <span class="token operator">*</span>out_flags <span class="token operator">|=</span> ZADD_OUT_ADDED<span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‹ç¼©åˆ—è¡¨"><a class="header-anchor" href="#å‹ç¼©åˆ—è¡¨"></a>å‹ç¼©åˆ—è¡¨</h2><blockquote><p>å‹ç¼©åˆ—è¡¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„,æ˜¯redisä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´è€Œè®¾è®¡çš„ç´§å‡‘æ€§æ•°æ®ç»“æ„,å¯ä»¥åŒ…å«å¤šä¸ªå…ƒç´ .å‹ç¼©åˆ—è¡¨å¯ä»¥ä½œä¸ºæœ‰åºé›†åˆ(zset)ã€æ•£åˆ—(hash)ã€åˆ—è¡¨(list)</p></blockquote><h3 id="æ•°æ®ç»“æ„-v3"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v3"></a>æ•°æ®ç»“æ„</h3><p><img src="https://s2.loli.net/2022/01/10/79cA85aCil3IzJf.png" alt="ziplistç»“æ„"></p><ul><li>zlbytesï¼šå‹ç¼©åˆ—è¡¨çš„å­—èŠ‚é•¿åº¦ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œå› æ­¤å‹ç¼©åˆ—è¡¨æœ€å¤šæœ‰232-1ä¸ªå­—èŠ‚</li><li>zltailï¼šå‹ç¼©åˆ—è¡¨å°¾å…ƒç´ ç›¸å¯¹äºå‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»é‡ï¼Œå 4ä¸ªå­—èŠ‚</li><li>zllenï¼šå‹ç¼©åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå 2ä¸ªå­—èŠ‚ã€‚zllenæ— æ³•å­˜å‚¨å…ƒç´ ä¸ªæ•°è¶…è¿‡65535ï¼ˆ216-1ï¼‰çš„å‹ç¼©åˆ—è¡¨ï¼Œå¿…é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è·å–åˆ°å…ƒç´ ä¸ªæ•°</li><li>entryXï¼šå‹ç¼©åˆ—è¡¨å­˜å‚¨çš„å…ƒç´ ï¼Œå¯ä»¥æ˜¯å­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°ï¼Œé•¿åº¦ä¸é™ã€‚entryçš„ç¼–ç ç»“æ„å°†åœ¨åé¢è¯¦ç»†ä»‹ç»</li><li>zlendï¼šå‹ç¼©åˆ—è¡¨çš„ç»“å°¾ï¼Œå 1ä¸ªå­—èŠ‚ï¼Œæ’ä¸º0xFF</li></ul><p>ä»¥ä¸‹æ˜¯åˆ›å»ºziplistçš„ä»£ç </p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* åˆ›å»ºä¸€ä¸ªç©ºç™½çš„ziplist *&#x2F;  unsigned char *ziplistNew(void) &#123;      &#x2F;&#x2F;ZIPLIST_HEADER_SIZE &#x3D; (sizeof(uint32_t)*2+sizeof(uint16_t))  + (sizeof(uint8_t))      &#x2F;&#x2F;8ä¸ªå­—èŠ‚ + 2ä¸ªå­—èŠ‚ + 1ä¸ªå­—èŠ‚      unsigned int bytes &#x3D; ZIPLIST_HEADER_SIZE+ZIPLIST_END_SIZE;      &#x2F;&#x2F;åˆ†é…å†…å­˜,è¿”å›åˆ—è¡¨æŒ‡é’ˆ      unsigned char *zl &#x3D; zmalloc(bytes);      &#x2F;&#x2F;å°è¯•å°†å¤§ç«¯æ•°æ®è½¬æ¢æˆå°ç«¯æ•°æ®      ZIPLIST_BYTES(zl) &#x3D; intrev32ifbe(bytes);      ZIPLIST_TAIL_OFFSET(zl) &#x3D; intrev32ifbe(ZIPLIST_HEADER_SIZE);      &#x2F;&#x2F;åˆå§‹åŒ–åˆ—è¡¨é•¿åº¦      ZIPLIST_LENGTH(zl) &#x3D; 0;      &#x2F;&#x2F;è®¾ç½®åˆ—è¡¨å°¾éƒ¨å­—ç¬¦ä¸ºhex_ff      zl[bytes-1] &#x3D; ZIP_END;      return zl;  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸‰ä¸ªæ­¥éª¤ä½¿ç”¨<B>intrev32ifbe()</B>å°è¯•å°†å¤§ç«¯æ•°æ®è½¬æ¢æˆä¸ºå°æ®µæ•°æ®;</p><p>å¤§å°ç«¯æ•°æ®å®šä¹‰</p><blockquote><p>å­—èŠ‚çš„æ’åˆ—æ–¹å¼æœ‰ä¸¤ä¸ªé€šç”¨è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªå¤šä½æ•°çš„ä½ä½æ”¾åœ¨è¾ƒå°çš„åœ°å€å¤„ï¼Œé«˜ä½æ”¾åœ¨è¾ƒå¤§çš„åœ°å€å¤„ï¼Œåˆ™ç§°å°ç«¯åºï¼›åä¹‹åˆ™ç§°å¤§ç«¯åºã€‚åœ¨ç½‘ç»œåº”ç”¨ä¸­ï¼Œå­—èŠ‚åºæ˜¯ä¸€ä¸ªå¿…é¡»è¢«è€ƒè™‘çš„å› ç´ ï¼Œå› ä¸ºä¸åŒæœºå™¨ç±»å‹å¯èƒ½é‡‡ç”¨ä¸åŒæ ‡å‡†çš„å­—èŠ‚åºï¼Œæ‰€ä»¥å‡æŒ‰ç…§ç½‘ç»œæ ‡å‡†è½¬åŒ–ã€‚<br>è¿™é‡Œrediså°½é‡é‡‡ç”¨å°ç«¯çš„åŸå› æ˜¯åœ¨äº<B>X86æ¶æ„</B>å’Œ<B>ARMæ¶æ„</B>æ˜¯é‡‡ç”¨çš„å°ç«¯æ¨¡å¼,ä½†æ˜¯ç½‘ç»œä¼ è¾“é‡‡ç”¨çš„æ˜¯å¤§ç«¯æ¨¡å¼.</p></blockquote><h3 id="Entryçš„å†…éƒ¨ç»“æ„"><a class="header-anchor" href="#Entryçš„å†…éƒ¨ç»“æ„"></a>Entryçš„å†…éƒ¨ç»“æ„</h3><p>entryçš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹:</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥æ¥æ”¶æœ‰å…³ ziplist æ¡ç›®çš„ä¿¡æ¯ã€‚   è¯·æ³¨æ„ï¼Œè¿™ä¸æ˜¯æ•°æ®çš„å®é™…ç¼–ç æ–¹å¼ï¼Œè¿™æ˜¯æˆ‘ä»¬  è¢«ä¸€ä¸ªå‡½æ•°å¡«å……ä»¥ä¾¿æ›´å®¹æ˜“æ“ä½œã€‚ *&#x2F;typedef struct zlentry &#123;    unsigned int prevrawlensize; &#x2F;* å¯¹prevrawlenç¼–ç åçš„å­—èŠ‚å¤§å°*&#x2F;    unsigned int prevrawlen;     &#x2F;* ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ *&#x2F;    unsigned int lensize;        &#x2F;* å¯¹lenç¼–ç åçš„é•¿åº¦*&#x2F;    unsigned int len;            &#x2F;* å½“å‰èŠ‚ç‚¹çš„é•¿åº¦ *&#x2F;    unsigned int headersize;     &#x2F;* prevrawlensize + lensize. *&#x2F;    unsigned char encoding;      &#x2F;* å½“å‰èŠ‚ç‚¹æ‰€ä½¿ç”¨çš„ç¼–ç ç±»å‹:ZIP_STR_* or ZIP_INT *&#x2F;    unsigned char *p;            &#x2F;* æŒ‡å‘åˆ—è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆ *&#x2F;&#125; zlentry;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ziplistä¸­éœ€è¦æ³¨æ„çš„æ˜¯â€™è¿é”æ›´æ–°â€™é—®é¢˜,ç”±äºziplistçš„ç»“æ„å¹¶ä¸æ˜¯é“¾è¡¨ç»“æ„è€Œæ˜¯è¿ç»­å†…å­˜ç»“æ„,å¯¼è‡´åœ¨åˆ é™¤ä¸Šä¸€ä¸ªå¤§èŠ‚ç‚¹æ—¶ä¼šå¯¼è‡´æ•°ç»„æ•´ä½“ç§»åŠ¨çš„é—®é¢˜</p><h2 id="å­—å…¸"><a class="header-anchor" href="#å­—å…¸"></a>å­—å…¸</h2><blockquote><p>å­—å…¸åˆç§°æ•£åˆ—è¡¨ï¼Œæ˜¯ç”¨æ¥å­˜å‚¨é”®å€¼ï¼ˆkey-valueï¼‰å¯¹çš„ä¸€ç§æ•°æ®ç»“æ„.</p></blockquote><h3 id="æ•°æ®ç»“æ„-v4"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v4"></a>æ•°æ®ç»“æ„</h3><p>Rediså­—å…¸å®ç°ä¾èµ–çš„æ•°æ®ç»“æ„ä¸»è¦åŒ…å«äº†ä¸‰éƒ¨åˆ†ï¼šå­—å…¸ã€Hashè¡¨ã€Hashè¡¨èŠ‚ç‚¹ã€‚å­—å…¸ä¸­åµŒå…¥äº†ä¸¤ä¸ªHashè¡¨ï¼ŒHashè¡¨ä¸­çš„tableå­—æ®µå­˜æ”¾ç€Hashè¡¨èŠ‚ç‚¹ï¼ŒHashè¡¨èŠ‚ç‚¹å¯¹åº”å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹ã€‚</p><p>ç»“æ„å¦‚ä¸‹:<br><img src="https://s2.loli.net/2022/01/16/sbcuXE1oLvhFzi9.jpg" alt="ç©ºHashè¡¨ç»“æ„ç¤ºæ„"></p><ul><li>dict</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;** hashç»“æ„ä½“* ä¼šåŒæ—¶ä½¿ç”¨ä¸¤ä¸ªhashç»“æ„ä½“,ä»¥ä¾¿å®ç°å¢é‡æ‰©å®¹*&#x2F;typedef struct dictht &#123;    &#x2F;&#x2F;æŒ‡é’ˆæ•°ç»„,ç”¨äºå­˜å‚¨é”®å€¼å¯¹    dictEntry **table;    &#x2F;&#x2F;tableæ•°ç»„çš„å¤§å°    unsigned long size;    &#x2F;&#x2F;æ©ç (size-1)    unsigned long sizemask;    &#x2F;&#x2F;å·²å­˜å‚¨çš„å…ƒç´ æ•°é‡    unsigned long used;&#125; dictht;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œç€é‡ä»‹ç»ä¸€ä¸‹æ©ç (sizemask)è¿™ä¸ªå­—æ®µ,sizemaskçš„è®¡ç®—æ–¹å¼ä¸ºå–(size-1)è¿™æ ·çš„å¥½å¤„æ˜¯é€šè¿‡<br><B>hash_key&amp;sizemask = hash_key/size</B><br>ä½æ“ä½œçš„æ€§èƒ½è¦é«˜äºå–ä½™æ“ä½œ</p><ul><li>dictEntry</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">typedef struct dictEntry &#123;    void *key;    union &#123;        void *val;        uint64_t u64;        int64_t s64;        double d;    &#125; v;    struct dictEntry *next;&#125; dictEntry;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>dictEntryæ˜¯hashçš„èŠ‚ç‚¹å…ƒç´ ç»“æ„,éœ€è¦æ³¨æ„çš„æ˜¯<B>V</B>æ˜¯ä¸€ç§è”åˆä½“ç»“æ„,æ ¹æ®ä½¿ç”¨åœºæ™¯ä½¿ç”¨ä¸åŒç±»å‹<br>*nextæ˜¯ç”¨æ¥è§£å†³hashå†²çªçš„,é‡‡ç”¨çš„æ˜¯å¤´æ’æ³•</p><ul><li>æ¸è¿›å¼ReHash</li></ul><ol><li>å½“æ‰§è¡Œæ’å…¥\åˆ é™¤\æŸ¥æ‰¾\ä¿®æ”¹æ—¶éƒ½ä¼šå…ˆåˆ¤æ–­å½“å‰å­—å…¸æ˜¯å¦åœ¨è¿›è¡Œrehash,ç„¶åå°è¯•è¿›è¡Œrehashåæ‰ä¼šæ‰§è¡Œæ“ä½œ</li><li>çº¿ç¨‹ç©ºé—²æ—¶ä¼šæ¯æ¬¡å¯¹100ä¸ªèŠ‚ç‚¹è¿›è¡Œrehash</li></ol><h3 id="æ“ä½œ-v3"><a class="header-anchor" href="#æ“ä½œ-v3"></a>æ“ä½œ</h3><ul><li>è¿­ä»£æ“ä½œ</li></ul><p>redisä¸­çš„æ•°æ®è¿­ä»£åˆ†ä¸ºä¸¤ç§ç±»å‹</p><ol><li>æ™®é€šè¿­ä»£å™¨<br>æ™®é€šè¿­ä»£å™¨åªä¼šéå†æ•°æ®</li><li>å®‰å…¨è¿­ä»£å™¨<br>å®‰å…¨è¿­ä»£å™¨,åœ¨éå†è¿‡ç¨‹ä¸­ä¼šåˆ é™¤æ•°æ®</li></ol><p>è¿™ä¸¤ç§è¿­ä»£å™¨å¯¹è¿­ä»£è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿé‡å¤æ•°æ®çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·</p><ol><li>æ™®é€šè¿­ä»£å™¨<br>æ™®é€šè¿­ä»£å™¨æ˜¯é€šè¿‡æ ‡å¿—ä½æ¥é™åˆ¶å­—å…¸ç»“æ„çš„å˜åŒ–</li><li>å®‰å…¨è¿­ä»£å™¨<br>å®‰å…¨è¿­ä»£å™¨æ˜¯é€šè¿‡é™åˆ¶rehashæ¥ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§</li></ol><h2 id="æ•´æ•°é›†åˆ"><a class="header-anchor" href="#æ•´æ•°é›†åˆ"></a>æ•´æ•°é›†åˆ</h2><p>redisä¸­çš„<B>æ•´æ•°é›†åˆ</B>æ˜¯ä½œä¸ºé›†åˆçš„åº•å±‚æ•°æ®ç»“æ„,ç”¨æ¥ä¿å­˜å°‘é‡çš„æ•°æ®å’Œæ•´æ•°å…ƒç´ ,ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æå®ƒçš„æ•°æ®ç»“æ„å’Œæ“ä½œ</p><h3 id="æ•°æ®ç»“æ„-v5"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v5"></a>æ•°æ®ç»“æ„</h3><ul><li>intset.h</li></ul><pre class="line-numbers language-h" data-language="h"><code class="language-h">&#x2F;*** æ•´æ•°é›†åˆç»“æ„ä½“*&#x2F;typedef struct intset &#123;    &#x2F;&#x2F;ç¼–ç æ ¼å¼    uint32_t encoding;    &#x2F;&#x2F;æ•°ç»„é•¿åº¦    uint32_t length;    &#x2F;&#x2F;å…ƒç´ æ•°ç»„    int8_t contents[];&#125; intset;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æ•´æ•°é›†åˆçš„ç»“æ„ä½“æ¯”è¾ƒç®€å•,åªæœ‰ç¼–ç æ ¼å¼/é•¿åº¦/æ•°æ®,è¿™ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ.ä¸‹é¢ç»§ç»­åˆ†æä¸€ä¸‹æ•´æ•°æ•°ç»„åˆ›å»ºçš„è¿‡ç¨‹</p><ul><li>intsetNew</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* åˆ›å»ºç©ºç™½çš„intset *&#x2F;intset *intsetNew(void) &#123;    &#x2F;&#x2F;é€šè¿‡zmallocåˆ†é…è¿ç»­å†…å­˜    intset *is &#x3D; zmalloc(sizeof(intset));    &#x2F;&#x2F;è®¾ç½®ç¼–ç     is-&gt;encoding &#x3D; intrev32ifbe(INTSET_ENC_INT16);    &#x2F;&#x2F;è®¾ç½®é•¿åº¦    is-&gt;length &#x3D; 0;    return is;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ“ä½œ-v4"><a class="header-anchor" href="#æ“ä½œ-v4"></a>æ“ä½œ</h3><p>æ“ä½œä¸»è¦åˆ†ææ·»åŠ å…ƒç´ (intsetAdd)å’Œåˆ é™¤å…ƒç´ ()è¿™ä¸¤ä¸ªæ“ä½œ</p><ul><li>intsetAdd</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* æ·»åŠ å…ƒç´  *&#x2F;intset *intsetAdd(intset *is, int64_t value, uint8_t *success) &#123;    &#x2F;&#x2F;1. è®¡ç®—valueçš„ç¼–ç æ ¼å¼    uint8_t valenc &#x3D; _intsetValueEncoding(value);    uint32_t pos;    if (success) *success &#x3D; 1;    &#x2F;*    *åˆ¤æ–­å³å°†æ·»åŠ çš„å…ƒç´ æ˜¯å¦éœ€è¦ä¿®æ”¹intsetä¿®æ”¹ç¼–ç æ‰èƒ½æ·»åŠ     *&#x2F;    if (valenc &gt; intrev32ifbe(is-&gt;encoding)) &#123;        &#x2F;* è¿™ä¸ªæ“ä½œé»˜è®¤éƒ½æ˜¯æˆåŠŸçš„ *&#x2F;        return intsetUpgradeAndAdd(is, value);    &#125; else &#123;        &#x2F;&#x2F;åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­,å¦‚æœæœ‰åˆ™è¿”å›å¤±è´¥        &#x2F;&#x2F;*pos        if (intsetSearch(is, value, &amp;pos)) &#123;            if (success) *success &#x3D; 0;            return is;        &#125;        &#x2F;&#x2F;åˆ¤æ–­å½“å‰æ·»åŠ å…ƒç´ åæ˜¯å¦éœ€è¦æ‰©å®¹        is &#x3D; intsetResize(is, intrev32ifbe(is-&gt;length) + 1);        &#x2F;&#x2F;poså¦‚æœåœ¨å½“å‰æ•°ç»„ä¸­,éœ€è¦å¯¹å…ƒç´ è¿›è¡Œç§»ä½æ“ä½œ        if (pos &lt; intrev32ifbe(is-&gt;length)) intsetMoveTail(is, pos, pos + 1);    &#125;    &#x2F;&#x2F;å‘posçš„ä½ç½®ä¸Šæ’å…¥å…ƒç´ value    _intsetSet(is, pos, value);    &#x2F;&#x2F;è®¾ç½®length    is-&gt;length &#x3D; intrev32ifbe(intrev32ifbe(is-&gt;length) + 1);    return is;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ·»åŠ å…ƒç´ æ˜¯é€šè¿‡*posæŒ‡é’ˆæ¥è¿›è¡Œç¡®å®šä½ç½®çš„,å…ˆè·å–å¯ä»¥æ’å…¥çš„ä½ç½®,åœ¨å°†å…ƒç´ æ’åˆ°æŒ‡å®šçš„ä½ç½®ä¸Š,æœ€ååœ¨è¿›è¡Œä½ç§»æ“ä½œ</p><ul><li>intsetRemove</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;* åˆ é™¤å…ƒç´  *&#x2F;intset *intsetRemove(intset *is, int64_t value, int *success) &#123;    &#x2F;&#x2F;åˆ¤æ–­å…ƒç´ ç¼–ç     uint8_t valenc &#x3D; _intsetValueEncoding(value);    uint32_t pos;    if (success) *success &#x3D; 0;    &#x2F;&#x2F;æŸ¥æ‰¾å…ƒç´ ä½ç½®    if (valenc &lt;&#x3D; intrev32ifbe(is-&gt;encoding) &amp;&amp; intsetSearch(is, value, &amp;pos)) &#123;        uint32_t len &#x3D; intrev32ifbe(is-&gt;length);        &#x2F;* We know we can delete *&#x2F;        if (success) *success &#x3D; 1;        &#x2F;*ä½¿ç”¨ä½ç§»æ“ä½œè¦†ç›–å…ƒç´ *&#x2F;        if (pos &lt; (len - 1)) intsetMoveTail(is, pos + 1, pos);        &#x2F;&#x2F;é‡æ–°è®¾ç½®æ•°ç»„é•¿åº¦        is &#x3D; intsetResize(is, len - 1);        is-&gt;length &#x3D; intrev32ifbe(len - 1);    &#125;    return is;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆæŸ¥æ‰¾å…ƒç´ ,åœ¨æ ¹æ®å…ƒç´ çš„ä½ç½®è¿›è¡Œç§»ä½æ“ä½œ.<br>ä»<B>intsetAdd</B>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°æ•´æ•°é›†åˆä¸­çš„æ•°æ®æ˜¯ä¸å…è®¸é‡å¤çš„,æ˜¯æœ‰åºçš„æ•°ç»„ç»„æˆ.</p><h2 id="quicklist"><a class="header-anchor" href="#quicklist"></a>quicklist</h2><p>quicklistæ˜¯ä¸ºä¼˜åŒ–å¤„ç†<B>List</B>çš„åº•å±‚å­˜å‚¨ç»“æ„ziplistå’Œadlistè€Œæ¥,å…³äºListçš„å®šä¹‰è¿™ä¸ªæè¿°çš„æ¯”è¾ƒå¥½</p><blockquote><p>é“¾è¡¨æ˜¯è¿™æ ·ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¶ä¸­çš„å„å¯¹è±¡æŒ‰çº¿æ€§é¡ºåºæ’åˆ—ã€‚é“¾è¡¨ä¸æ•°ç»„çš„ä¸åŒç‚¹åœ¨äºï¼Œæ•°ç»„çš„é¡ºåºç”±ä¸‹æ ‡å†³å®šï¼Œé“¾è¡¨çš„é¡ºåºç”±å¯¹è±¡ä¸­çš„æŒ‡é’ˆå†³å®šã€‚</p></blockquote><p>å…³äºquicklistçš„å®šä¹‰å¦‚ä¸‹</p><blockquote><p>Redisä¸­å¯¹quciklistçš„æ³¨é‡Šä¸ºA doubly linked list of ziplistsã€‚quicklistæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªziplistç»“æ„ã€‚quicklistå¯ä»¥çœ‹æˆæ˜¯ç”¨åŒå‘é“¾è¡¨å°†è‹¥å¹²å°å‹çš„ziplistè¿æ¥åˆ°ä¸€èµ·ç»„æˆçš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</p></blockquote><h3 id="æ•°æ®ç»“æ„-v6"><a class="header-anchor" href="#æ•°æ®ç»“æ„-v6"></a>æ•°æ®ç»“æ„</h3><ul><li>quicklist</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;*** quickListç»“æ„ä½“* å¤§å°ä¸º40å­—èŠ‚*&#x2F;typedef struct quicklist &#123;    &#x2F;&#x2F;é¦–å°¾èŠ‚ç‚¹    quicklistNode *head;    quicklistNode *tail;    &#x2F;&#x2F;æ€»æ¡æ•°    unsigned long count;    &#x2F;&#x2F;èŠ‚ç‚¹æ•°é‡    unsigned long len;    &#x2F;&#x2F;å•ä¸ªèŠ‚ç‚¹çš„å¡«å……å› å­    int fill : QL_FILL_BITS;    &#x2F;&#x2F;ä¸åŒèŠ‚ç‚¹çš„æ·±åº¦    unsigned int compress : QL_COMP_BITS;    unsigned int bookmark_count: QL_BM_BITS;    &#x2F;&#x2F;ä¹¦ç­¾åˆ—è¡¨(ç”¨äºå¿«é€ŸæŸ¥æ‰¾èŠ‚ç‚¹ä½¿ç”¨)    quicklistBookmark bookmarks[];&#125; quicklist;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºè¶…å¤§å‹åˆ—è¡¨ä¼šé‡‡ç”¨åˆ—è¡¨å°¾éƒ¨ä½¿ç”¨ä¹¦ç­¾è¿™ç§æ•°æ®ç»“æ„æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾</p><ul><li>quicklistBookmark</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">typedef struct quicklistBookmark &#123;    quicklistNode *node;    char *name;&#125; quicklistBookmark;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥ä»quicklist/quicklistBookmarkçš„ç»“æ„ä½“ä¸­çœ‹åˆ°<B>quicklistNode</B>æ˜¯åº•å±‚å…ƒç´ å­˜å‚¨èŠ‚ç‚¹çš„ç»“æ„ä½“</p><ul><li>quicklistNode</li></ul><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;*** quicklistNode æ˜¯ä¸€ä¸ª 32 å­—èŠ‚çš„ç»“æ„ï¼Œç”¨äºæè¿°ä¸€ä¸ªå¿«é€Ÿåˆ—è¡¨çš„ziplistã€‚* æˆ‘ä»¬ä½¿ç”¨sz(ä½åŸŸ)å°† quicklistNode ä¿æŒåœ¨ 32 å­—èŠ‚ã€‚* count: 16ä½ï¼Œæœ€å¤§ 65536ï¼ˆæœ€å¤§ zl å­—èŠ‚ä¸º 65kï¼Œå› æ­¤æœ€å¤§è®¡æ•°å®é™…ä¸Š &lt; 32kï¼‰ã€‚* encoding: 2ä½ï¼ŒRAW&#x3D;1ï¼ŒLZF&#x3D;2ã€‚* container: 2 ä½ï¼ŒNONE&#x3D;1ï¼ŒZIPLIST&#x3D;2ã€‚* recompress: 1 ä½ï¼Œå¸ƒå°”å€¼ï¼Œå¦‚æœèŠ‚ç‚¹ä¸´æ—¶è§£å‹ç¼©ä»¥ä¾›ä½¿ç”¨ï¼Œåˆ™ä¸º trueã€‚* attempted_compress: 1 ä½ï¼Œå¸ƒå°”å€¼ï¼Œç”¨äºæµ‹è¯•æœŸé—´çš„éªŒè¯ã€‚* extra: 10 ä½ï¼Œå…è´¹ä¾›ä»¥åä½¿ç”¨ï¼› å¡«å……å‰©ä½™çš„ 32 ä½*&#x2F;typedef struct quicklistNode &#123;    struct quicklistNode *prev;    struct quicklistNode *next;    unsigned char *zl;    unsigned int sz;             &#x2F;* ziplist size in bytes *&#x2F;    unsigned int count : 16;     &#x2F;* count of items in ziplist *&#x2F;    unsigned int encoding : 2;   &#x2F;* RAW&#x3D;&#x3D;1 or LZF&#x3D;&#x3D;2 *&#x2F;    unsigned int container : 2;  &#x2F;* NONE&#x3D;&#x3D;1 or ZIPLIST&#x3D;&#x3D;2 *&#x2F;    unsigned int recompress : 1; &#x2F;* was this node previous compressed? *&#x2F;    unsigned int attempted_compress : 1; &#x2F;* node can&#39;t compress; too small *&#x2F;    unsigned int extra : 10; &#x2F;* more bits to steal for future usage *&#x2F;&#125; quicklistNode;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£æquicklistNode:</p><ol><li>ç»“æ„ä¸Šäºziplistä¸ç›¸åŒ,é‡‡ç”¨çš„æ˜¯åˆ—è¡¨æ ¼å¼è®°å½•æ•°æ®</li><li>å•ä¸ªnodeæœ€å¤§é“¾è¡¨æ•°é‡ä¸æ“ä½œ32K</li><li>encoding:LZFè¿›è¡Œå‹ç¼©ç¼–ç </li></ol><p>æ€»ç»“:<br>redisåº•å±‚æ•°æ®æ ¼å¼åˆ†ä¸ºå…­ç§</p><ul><li><p>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²<br>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²(SDS),é€»è¾‘ä¸Šæ˜¯å¯¹*charæŒ‡é’ˆçš„æ‰©å±•,ç»“æ„ä¸Šæ ¹æ®ä¸åŒçš„é•¿åº¦å¯ä»¥åˆ†ä¸ºå¤šç§ç±»å‹,ä½¿ç”¨æƒ°æ€§åˆ é™¤æœºåˆ¶</p></li><li><p>è·³è·ƒåˆ—è¡¨<br>è·³è·ƒåˆ—è¡¨(skipList)ç»“æ„ä¸ŠzskiplistNode/zskiplist,zsetåœ¨æ»¡è¶³ä»»æ„æ¡ä»¶(å…ƒç´ ä¸ªæ•°è¶…è¿‡128/å…ƒç´ å¤§å°å¤§äº64å­—èŠ‚/ziplistå¤§å°è¶…è¿‡1G)åä½¿ç”¨skipä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ä¸”ä¸ä¼šå›é€€</p></li><li><p>å‹ç¼©åˆ—è¡¨<br>å‹ç¼©åˆ—è¡¨(ziplist)ç»“æ„ä¸Šåˆ†ä¸º*ziplist/entry,éœ€è¦æ³¨æ„çš„æ˜¯ziplistæ˜¯è¿ç»­çš„å†…å­˜èŠ‚ç‚¹ç»„æˆ,å¹¶ä¸”entryä¸Šè¿˜æœ‰ä¸Šä¸€èŠ‚ç‚¹çš„ä¿¡æ¯</p></li><li><p>å­—å…¸<br>å­—å…¸(dict)ç»“æ„æ˜¯é€šè¿‡hashç»“æ„æ¥ç»„æˆ,ç‰¹ç‚¹æ˜¯é‡‡ç”¨ä½è¿ç®—ä¸æ¥å–ä½™æ•°,å¹¶ä¸”é‡‡ç”¨ä¸¤ä¸ªhashæ¥å®ç°æ¸è¿›å¼Rehash,æ˜¯é€šè¿‡æ‡’å¤„ç†å’Œçº¿ç¨‹ç©ºé—²æ—¶å¤„ç†çš„æ–¹å¼æ¥å®Œæˆ</p></li><li><p>æ•´æ•°é›†åˆ<br>æ•´æ•°é›†åˆç»“æ„æ˜¯è¿ç»­çš„å†…å­˜,æ¯æ¬¡æ·»åŠ å‰éƒ½è¦å…ˆè®¡ç®—ç¼–ç é•¿åº¦å’Œæ’å…¥ä½ç½®ä»¥ä¾¿è¿›è¡Œæ‰©å®¹</p></li><li><p>quicklist<br>quicklistæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„,æ¯ä¸ªèŠ‚ç‚¹åˆæ˜¯ziplistç»„æˆ</p></li><li><p>stream<br>çœç•¥,è¯¦è§src/stream.hæ–‡ä»¶</p></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://redis.io/topics/internals-sds">Hacking Strings</a><br><a href="http://www.itabin.com/redis-zskiplist/">zskiplist</a><br><a href="https://www.geek-share.com/detail/2714589322.html">redisdæºä»£ç çš„å¤§ç«¯ä¸å°ç«¯</a><br><a href="https://cache.one/read/2884987">rediså‹ç¼©åˆ—è¡¨ziplistçš„è¿é”æ‰©å®¹</a><br><a href="https://redisbook.readthedocs.io/en/latest/compress-datastruct/intset.html">æ•´æ•°é›†åˆ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;redisåº•å±‚æ•°æ®ç»“æ„åˆ†æ&lt;/h1&gt;
&lt;p&gt;redisåº•å±‚æ•°æ®ç»“æ„åˆ†æä¸»è¦æ˜¯æ ¹æ®ã€ŠRedis5 è®¾è®¡ä¸æºç åˆ†æã€‹ä¸€ä¹¦çš„ç« èŠ‚è€Œæ¥,å‚è€ƒå¯¹ç…§ä»£ç ç‰ˆæœ¬ä¸º6.2,æºä»£ç çš„ç¼–è¯‘å’Œéƒ¨ç½²å¯ä»¥æŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« &lt;/p&gt;
&lt;p&gt;redisåº•å±‚æ•°æ®ç»“æ„å¯ä»¥åˆ’åˆ†ä¸º&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®€å•åŠ¨</summary>
      
    
    
    
    <category term="æ‚è®°" scheme="https://agmtopy.gitee.io/categories/%E6%9D%82%E8%AE%B0/"/>
    
    
    <category term="redis" scheme="https://agmtopy.gitee.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£linuxå†…æ ¸ç¬”è®°</title>
    <link href="https://agmtopy.gitee.io/2021/12/08/1.%E6%9D%82%E8%AE%B0/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E5%86%85%E6%A0%B8%E7%AC%94%E8%AE%B0/"/>
    <id>https://agmtopy.gitee.io/2021/12/08/1.%E6%9D%82%E8%AE%B0/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E5%86%85%E6%A0%B8%E7%AC%94%E8%AE%B0/</id>
    <published>2021-12-08T13:25:57.000Z</published>
    <updated>2021-12-15T12:47:43.279Z</updated>
    
    <content type="html"><![CDATA[<h1>æ·±å…¥ç†è§£linuxå†…æ ¸ç¬”è®°</h1><h2 id="å†…æ ¸"><a class="header-anchor" href="#å†…æ ¸"></a>å†…æ ¸</h2><p>unixå†…æ ¸æ ¹æ®æ‰§è¡ŒçŠ¶æ€åˆ†ä¸ºâ€™ç”¨æˆ·æ€â€™å’Œâ€™æ‰§è¡Œæ€â€™</p><ul><li>ç”¨æˆ·ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li></ul><ol><li>è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</li><li>è§¦å‘å¼‚å¸¸(exception)</li><li>å“åº”ä¸­æ–­</li><li>å†…æ ¸çº¿ç¨‹çš„æ‰§è¡Œ(è¿™é‡Œæœ‰ä¸€äº›æ­§ä¹‰,æœ¬èº«å°±æ˜¯å†…æ ¸æ€)</li></ol><ul><li>è¿›ç¨‹æè¿°ç¬¦</li></ul><p>è¿›ç¨‹æè¿°ç¬¦æ˜¯ç”¨æ¥æè¿°å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯,åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†<br>- ç¨‹åºè®¡æ•°å™¨å’Œæ ˆæŒ‡é’ˆ<br>- é€šç”¨å¯„å­˜å™¨<br>- æµ®ç‚¹å¯„å­˜å™¨<br>- å†…å­˜ç®¡ç†å¯„å­˜å™¨</p><ul><li>å¯é‡å…¥å†…æ ¸</li></ul><p>unixæ˜¯å¯é‡å…¥å†…æ ¸,æ„å‘³ç€åŒæ—¶æœ‰è‹¥å¹²ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œ,åœ¨æŠ¢å å¼å†…æ ¸è°ƒåº¦ç³»ç»Ÿä¸­è¿›ç¨‹ä¼šäº¤æ›¿æ‰§è¡Œ</p><ul><li><p>åƒµå°¸è¿›ç¨‹<br>åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿæ˜¯ç”±çˆ¶è¿›ç¨‹é€šè¿‡â€™wait4()'çš„ç³»ç»Ÿè°ƒç”¨ç­‰å¾…å­è¿›ç¨‹çš„ç»“æŸçš„çŠ¶æ€,</p></li><li><p>è¿›ç¨‹ç»„ä¸ä¼šè¯<br>è¿›ç¨‹ç»„æ˜¯å¯¹ä¸€ç§&quot;ä½œä¸š&quot;çš„æŠ½è±¡<br>ç™»å½•ä¼šè¯æŒ‡çš„æ˜¯</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;æ·±å…¥ç†è§£linuxå†…æ ¸ç¬”è®°&lt;/h1&gt;
&lt;h2 id=&quot;å†…æ ¸&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#å†…æ ¸&quot;&gt;&lt;/a&gt;å†…æ ¸&lt;/h2&gt;
&lt;p&gt;unixå†…æ ¸æ ¹æ®æ‰§è¡ŒçŠ¶æ€åˆ†ä¸ºâ€™ç”¨æˆ·æ€â€™å’Œâ€™æ‰§è¡Œæ€â€™&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”¨æˆ·ä¸å†…æ ¸æ€çš„åˆ‡æ¢&lt;/li&gt;
</summary>
      
    
    
    
    <category term="ç¬”è®°" scheme="https://agmtopy.gitee.io/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="linux" scheme="https://agmtopy.gitee.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥å‰–æKubernetesä¹‹ç¼–æ’èƒ½åŠ›</title>
    <link href="https://agmtopy.gitee.io/2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/3.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E7%BC%96%E6%8E%92%E8%83%BD%E5%8A%9B/"/>
    <id>https://agmtopy.gitee.io/2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/3.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E7%BC%96%E6%8E%92%E8%83%BD%E5%8A%9B/</id>
    <published>2021-11-28T15:41:26.000Z</published>
    <updated>2021-11-28T15:43:00.947Z</updated>
    
    <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹ç¼–æ’èƒ½åŠ›</h1><blockquote></blockquote><h2 id="ç¼–æ’èƒ½åŠ›"><a class="header-anchor" href="#ç¼–æ’èƒ½åŠ›"></a>ç¼–æ’èƒ½åŠ›</h2><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;æ·±å…¥å‰–æKubernetesä¹‹ç¼–æ’èƒ½åŠ›&lt;/h1&gt;
&lt;blockquote&gt;&lt;/blockquote&gt;
&lt;h2 id=&quot;ç¼–æ’èƒ½åŠ›&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#ç¼–æ’èƒ½åŠ›&quot;&gt;&lt;/a&gt;ç¼–æ’èƒ½åŠ›&lt;/h2&gt;
&lt;h2 id=&quot;å‚è€ƒèµ„æ–™&quot;&gt;&lt;a cl</summary>
      
    
    
    
    <category term="å®¹å™¨åŒ–" scheme="https://agmtopy.gitee.io/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
    
    <category term="Kubernetes" scheme="https://agmtopy.gitee.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥å‰–æKubernetesä¹‹Podsçš„æ¦‚å¿µ</title>
    <link href="https://agmtopy.gitee.io/2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/2.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BPod%E7%9A%84%E6%A6%82%E5%BF%B5/"/>
    <id>https://agmtopy.gitee.io/2021/11/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/2.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BPod%E7%9A%84%E6%A6%82%E5%BF%B5/</id>
    <published>2021-11-28T05:40:30.000Z</published>
    <updated>2021-11-28T15:40:46.956Z</updated>
    
    <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹Podsçš„æ¦‚å¿µ</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­äº†è§£åˆ°kubernetesçš„éƒ¨ç½²åœ¨é€»è¾‘ä¸Šæ˜¯æŒ‰ç…§<B>Pod</B>çš„æ¦‚å¿µè¿›è¡Œçš„,ä¸‹é¢æ¥è¯¦ç»†çš„äº†è§£ä¸€ä¸‹podçš„çŸ¥è¯†</p><h2 id="åŸºç¡€æ¦‚å¿µ"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><blockquote><p>Podsæ˜¯æ‚¨å¯ä»¥åœ¨ Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„æœ€å°çš„å¯éƒ¨ç½²è®¡ç®—å•å…ƒã€‚Podsæ˜¯ä¸€ç»„ç”±ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Šçš„å®¹å™¨ç»„æˆçš„å…±äº«å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œä»¥åŠå¦‚ä½•è¿è¡Œå®¹å™¨çš„è§„èŒƒã€‚Pod çš„å†…å®¹å§‹ç»ˆä½äºåŒä¸€åœ°ç‚¹å¹¶å…±åŒè°ƒåº¦ï¼Œå¹¶åœ¨å…±äº«ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚Pod ä¸ºç‰¹å®šäºåº”ç”¨ç¨‹åºçš„â€œé€»è¾‘ä¸»æœºâ€å»ºæ¨¡ï¼šå®ƒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å¯¹ç´§å¯†è€¦åˆçš„åº”ç”¨ç¨‹åºå®¹å™¨ã€‚åœ¨éäº‘ç¯å¢ƒä¸­ï¼Œåœ¨åŒä¸€ç‰©ç†æˆ–è™šæ‹Ÿæœºä¸Šæ‰§è¡Œçš„åº”ç”¨ç¨‹åºç±»ä¼¼äºåœ¨åŒä¸€é€»è¾‘ä¸»æœºä¸Šæ‰§è¡Œçš„äº‘åº”ç”¨ç¨‹åºã€‚</p></blockquote><p>Podsçš„å®˜ç½‘å®šä¹‰,è¿™ä¸ªå®šä¹‰ä¼ è¾¾å‡ºä¸‰ä¸ªè§„èŒƒ:</p><ol><li>Podsæ˜¯Kubernetesç®¡ç†æ‰§è¡Œçš„æœ€å°å•å…ƒ</li><li>Podsæ˜¯å®¹å™¨ç»„æˆ,å¹¶ä¸”å®¹å™¨å†…éƒ¨å¯ä»¥å…±äº«ç½‘ç»œå’Œå­˜å‚¨</li><li>Podsæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µ,æ›¿kuberneteså®Œæˆåº•å±‚æ“ä½œçš„è¿˜æ˜¯å®¹å™¨ä¸‰å‰‘å®¢â€™Namespaceâ€™ã€â€˜Cgroupâ€™ã€â€˜rootFsâ€™</li></ol><h2 id="Podsç»„æˆ"><a class="header-anchor" href="#Podsç»„æˆ"></a>Podsç»„æˆ</h2><p>Podsçš„ç»„æˆå¯ä»¥å‚è€ƒè¿™å¼ å›¾:<br><img src="https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg" alt="Podsç»„æˆ"></p><p>Podsé™¤äº†æœ¬èº«çš„å®¹å™¨â€™ContainerA/ContainerBâ€™ä»¥å¤–è¿˜æœ‰ä¸€ä¸ª<B>Infra container</B>å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨çš„é•œåƒå¾ˆå°è§£å‹åä¹Ÿåªæœ‰100kb~200kbå¤§å°ã€‚</p><ul><li><p>Initå®¹å™¨<br>initå®¹å™¨æ˜¯åœ¨ç”¨æˆ·å®¹å™¨å¯åŠ¨ä¹‹å‰-ç½‘ç»œå’Œæ•°æ®å·åˆå§‹åŒ–å®Œæˆåå¯åŠ¨<br>ç”¨äºä»£ç†ç”¨æˆ·å®¹å™¨çš„ç½‘ç»œå’ŒIO,å…¶å®å°±æ˜¯Sidecaræ¨¡å¼</p></li><li><p>ç”¨æˆ·å®¹å™¨<br>ç”¨æˆ·å®¹å™¨æ˜¯â€™Web Serverâ€™ä¹Ÿå°±æ˜¯åœ¨YMLä¸­å®šä¹‰çš„å®¹å™¨</p></li></ul><h2 id="PodsåŠŸèƒ½"><a class="header-anchor" href="#PodsåŠŸèƒ½"></a>PodsåŠŸèƒ½</h2><ul><li><p>volume</p><p>volumeæ•°æ®å·å…¶ä¸­æœ‰ä¸€ç§ç‰¹æ®Šçš„volume-&gt;â€˜Projected Volumeâ€™(æŠ•å°„æ•°æ®å·)ä¸»è¦æ˜¯ç”¨æ¥å‘å®¹å™¨å†…éƒ¨æä¾›é¢„å…ˆå®šä¹‰å¥½çš„æ•°æ®ï¼Œå¯ä»¥åˆ’åˆ†ä¸º</p><ol><li>Secret</li><li>ConfigMao</li><li>DownwardApi</li><li>ServiceAccountToken</li></ol><p>è¿™å‡ ç§ç±»å‹ï¼Œå…¶ä¸­SecretæŒ‡çš„æ˜¯å°†é…ç½®æ·»åŠ åˆ°kubernetesä¸­é•œåƒç®¡ç†çš„æ•°æ®ï¼Œåœ¨é€šè¿‡Podsçš„YMALæ–‡ä»¶çš„å®šä¹‰å¯ä»¥å°†è¿™éƒ¨åˆ†é…ç½®ä¿¡æ¯ç›´æ¥å†™å…¥å®¹å™¨ä¸­ï¼Œå¹¶ä¸”å¯ä»¥éšç€Kubernetesä¸­å†…å®¹çš„å˜åŒ–è€Œå˜åŒ–ï¼Œç±»ä¼¼ä¸é…ç½®ä¸­å¿ƒçš„ä½¿ç”¨</p></li><li><p>å¼‚å¸¸æ¢å¤ç­–ç•¥</p><p>Podsçš„å¼‚å¸¸æ¢å¤ç­–ç•¥å¯ä»¥åˆ†ä¸º:</p><ol><li>åªè¦å®¹å™¨æ²¡æœ‰è¿è¡Œå°±è¿›è¡Œè‡ªåŠ¨é‡å¯</li><li>åªæœ‰åœ¨å®¹å™¨å¼‚å¸¸æ—¶æ‰è¿›è¡Œchongq</li><li>æ°¸ä¸è‡ªåŠ¨é‡å¯å®¹å™¨</li></ol><p>æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œçš„æ–¹æ³•æœ‰:</p><ol><li>å“åº”å¤–éƒ¨è¯·æ±‚ï¼Œä¾‹å¦‚httpè¯·æ±‚</li><li>å¤–éƒ¨æ£€æŸ¥é¢„è®¾çš„å¯åŠ¨åçš„é’©å­æ–¹æ³•ï¼Œä¾‹å¦‚æ£€æŸ¥æ–‡ä»¶å·å®—é¢„è®¾çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ç­‰</li></ol><p>å®ç°å¯¹å®¹å™¨è¿›è¡Œå®šæœŸè¯Šæ–­çš„åŠŸèƒ½å«â€™å®¹å™¨æ¢é’ˆâ€™ï¼Œç”±å®¹å™¨å†…éƒ¨è¿›è¡Œå®ç°ã€‚åˆ†ä¸ºä¸‰ç§ç±»å‹</p><ol><li>ExecAction</li><li>TCPSocketAction</li><li>HTTPGetAction</li></ol><p>å®¹å™¨æ¢é’ˆåˆåˆ†ä¸ºï¼š</p><ol><li>å­˜æ´»æ¢é’ˆ<br>å­˜æ´»æ¢é’ˆæŒ‡çš„æ˜¯è¦ç¡®è®¤ä¸€ä¸ªå®¹å™¨æ˜¯å¦çœŸæ­£çš„æ­»äº¡çš„åœºæ™¯ï¼Œä¾‹å¦‚é‡å¯æ—¶æ£€æµ‹ä¹‹å‰çš„å¤±è´¥å®¹å™¨æ˜¯å¦å·²ç»æ­»äº¡</li><li>å°±ç»ªæ¢é’ˆ<br>å°±ç»ªæ¢é’ˆæŒ‡çš„æ˜¯åŒºåˆ†åº”ç”¨æ˜¯å¦å‡†å¤‡å°±ç»ªçš„åœºæ™¯</li><li>å¯åŠ¨æ¢é’ˆ<br>å¯åŠ¨æ¢é’ˆæŒ‡çš„æ˜¯å¯¹äºå¤§å‹å®¹å™¨çš„å¯åŠ¨æ¯”è¾ƒæ…¢çš„åœºæ™¯éœ€è¦åŒºåˆ†å®¹å™¨æ˜¯å¦è¿˜åœ¨å¯åŠ¨</li></ol></li></ul><h2 id="Podsç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#Podsç”Ÿå‘½å‘¨æœŸ"></a>Podsç”Ÿå‘½å‘¨æœŸ</h2><p>Podçš„é˜¶æ®µåˆ†ä¸º</p><table><thead><tr><th>å–å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>Pendingï¼ˆæ‚¬å†³ï¼‰</td><td>Pod å·²è¢« Kubernetes ç³»ç»Ÿæ¥å—ï¼Œä½†æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨å°šæœªåˆ›å»ºäº¦æœªè¿è¡Œã€‚æ­¤é˜¶æ®µåŒ…æ‹¬ç­‰å¾… Pod è¢«è°ƒåº¦çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´ï¼Œ</td></tr><tr><td>Runningï¼ˆè¿è¡Œä¸­ï¼‰</td><td>Pod å·²ç»ç»‘å®šåˆ°äº†æŸä¸ªèŠ‚ç‚¹ï¼ŒPod ä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å·²è¢«åˆ›å»ºã€‚è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€ã€‚</td></tr><tr><td>Succeededï¼ˆæˆåŠŸï¼‰</td><td>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯ã€‚</td></tr><tr><td>Failedï¼ˆå¤±è´¥ï¼‰</td><td>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨ä»¥é 0 çŠ¶æ€é€€å‡ºæˆ–è€…è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</td></tr><tr><td>Unknownï¼ˆæœªçŸ¥ï¼‰</td><td>å› ä¸ºæŸäº›åŸå› æ— æ³•å–å¾— Pod çš„çŠ¶æ€ã€‚è¿™ç§æƒ…å†µé€šå¸¸æ˜¯å› ä¸ºä¸ Pod æ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥ã€‚</td></tr></tbody></table><h2 id="Podçš„ä¸Šå±‚æŠ½è±¡-Service"><a class="header-anchor" href="#Podçš„ä¸Šå±‚æŠ½è±¡-Service"></a>Podçš„ä¸Šå±‚æŠ½è±¡:Service</h2><p>è¿™é‡Œå…ˆç®€å•çš„ä»‹ç»ä»¥ä¸‹Serviceï¼Œkubernetesä¸­Serviceæ˜¯å°†ä¸€ç»„Podæš´éœ²ç»™å¤–ç•Œçš„ä¸€ç§æ–¹å¼ã€‚å¯¹å¤–æä¾›ä¸¤ç§è®¿é—®æ–¹å¼</p><ol><li><p>VIP<br>é€šè¿‡å¯¹å¤–æä¾›Serviceçš„è™šæ‹ŸIP,ç„¶ååœ¨å°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„Podä¸Šã€‚</p></li><li><p>DNS<br>- Normal Service<br>ä¸VIPæ–¹å¼ç±»ä¼¼<br>- Headles Service<br>å¯¹äºè¯·æ±‚ç›´æ¥è¿”å›å…·ä½“Podçš„IPã€‚ç±»ä¼¼äºDNSç›´æ¥è§£æå‡ºçœŸå®Podçš„IP</p></li></ol><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/">podæ˜¯ä»€ä¹ˆ?</a><br><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase">podçš„ç”Ÿå‘½å‘¨æœŸ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;æ·±å…¥å‰–æKubernetesä¹‹Podsçš„æ¦‚å¿µ&lt;/h1&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­äº†è§£åˆ°kubernetesçš„éƒ¨ç½²åœ¨é€»è¾‘ä¸Šæ˜¯æŒ‰ç…§&lt;B&gt;Pod&lt;/B&gt;çš„æ¦‚å¿µè¿›è¡Œçš„,ä¸‹é¢æ¥è¯¦ç»†çš„äº†è§£ä¸€ä¸‹podçš„çŸ¥è¯†&lt;/p&gt;
&lt;h2 id=&quot;åŸºç¡€æ¦‚å¿µ&quot;&gt;&lt;a class=&quot;header-anchor</summary>
      
    
    
    
    <category term="å®¹å™¨åŒ–" scheme="https://agmtopy.gitee.io/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
    
    <category term="Kubernetes" scheme="https://agmtopy.gitee.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ-åŸºç¡€ç¯‡</title>
    <link href="https://agmtopy.gitee.io/2021/11/09/19.%E5%88%86%E5%B8%83%E5%BC%8F/0.%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F-%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
    <id>https://agmtopy.gitee.io/2021/11/09/19.%E5%88%86%E5%B8%83%E5%BC%8F/0.%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F-%E5%9F%BA%E7%A1%80%E7%AF%87/</id>
    <published>2021-11-09T01:45:45.000Z</published>
    <updated>2021-11-11T05:57:59.932Z</updated>
    
    <content type="html"><![CDATA[<h1>å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ-åŸºç¡€ç¯‡</h1><p>ä¸»è¦æ˜¯è®°å½•é˜…è¯»ã€Šå¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼šåŸç†è§£æä¸æ¶æ„å®æˆ˜ã€‹åŸºç¡€ç¯‡ä¸­çš„ä¸€äº›çŸ¥è¯†å’Œç†è§£ã€‚</p><ul><li>ä¹¦è¯„</li></ul><p><a href="https://book.douban.com/subject/25723658/">å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ</a></p><p>åŸºç¡€ç¯‡ä¸»è¦æ˜¯ä»<B>å•æœºå­˜å‚¨ç³»ç»Ÿ</B>åˆ°<B>åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ</B>çš„æ¼”åŒ–è¿‡ç¨‹ä»¥åŠå„è‡ªçš„ç‰¹ç‚¹è¿›è¡Œåˆ†æ</p><h2 id="å•æœºå­˜å‚¨ç³»ç»Ÿ"><a class="header-anchor" href="#å•æœºå­˜å‚¨ç³»ç»Ÿ"></a>å•æœºå­˜å‚¨ç³»ç»Ÿ</h2><p>å•æœºå­˜å‚¨ç³»ç»Ÿæœ€æ—©åº”è¯¥æ˜¯æ¥æºè‡ªå…³ç³»å‹æ•°æ®åº“çš„ç†è®ºï¼Œæ ¹æ®æ•°æ®åº“æ“ä½œåœ¨å‘å±•å‡ºäº‹åŠ¡çš„æ¦‚å¿µ</p><h3 id="ç¡¬ä»¶åŸºç¡€"><a class="header-anchor" href="#ç¡¬ä»¶åŸºç¡€"></a>ç¡¬ä»¶åŸºç¡€</h3><p>ä»‹ç»CPUã€IOæ€»çº¿ã€ç½‘ç»œæ‹“æ‰‘ç­‰çŸ¥è¯†ï¼Œå…¶ä¸­å—æ¡¥/åŒ—æ¡¥çš„ä½œç”¨æ¯”è¾ƒæœ‰æ„æ€</p><ul><li>å—æ¡¥è´Ÿè´£ä¸ä½é€Ÿè®¾å¤‡çš„äº¤äº’</li><li>åŒ—æ¡¥è´Ÿè´£ä¸é«˜é€Ÿè®¾å¤‡çš„äº¤äº’</li></ul><p><img src="https://i.loli.net/2021/11/09/6OIbyw3zZGTFCkc.jpg" alt="å—åŒ—æ¡¥ç»“æ„"></p><h3 id="å­˜å‚¨å¼•æ“"><a class="header-anchor" href="#å­˜å‚¨å¼•æ“"></a>å­˜å‚¨å¼•æ“</h3><p>å­˜å‚¨å¼•æ“æ˜¯æ ¹æ®æ–‡ä»¶ç³»ç»Ÿå¯¹å­˜å‚¨ç³»ç»Ÿæä¾›åº•å±‚çš„CRUDèƒ½åŠ›çš„å¼•æ“,æ ¹æ®å­˜å‚¨å¼•æ“åº•å±‚ä½¿ç”¨çš„ç®—æ³•å¯ä»¥å¤§è‡´åˆ’åˆ†ä¸ºâ€™hashå­˜å‚¨å¼•æ“â€™ã€â€˜B treeå­˜å‚¨å¼•æ“â€™ã€'LSMå­˜å‚¨å¼•æ“â€™è¿™ä¸‰ç±»</p><ul><li><p>hashå­˜å‚¨å¼•æ“<br>hashå­˜å‚¨å¼•æ“åº•å±‚é‡‡ç”¨hashç®—æ³•ç¡®å®škeyçš„ä½ç½®ï¼Œvalueåˆ™ä»£è¡¨æ–‡ä»¶çš„ç‰©ç†ä½ç½®ã€‚ä½¿ç”¨è¿™ç§ç®—æ³•çš„å¯ä»¥å‚è€ƒRocketMQä¸­çš„indexFileå’ŒcommitLogæ–‡ä»¶ä¹‹é—´çš„å…³ç³».<br>hashå­˜å‚¨å¼•æ“ä¸æ”¯æŒé¡ºåºè¯»å†™</p></li><li><p>B+ treeå­˜å‚¨å¼•æ“<br>B+ treeå­˜å‚¨å¼•æ“å…·ä½“çš„å®ç°å¯ä»¥å‚è€ƒMySQLä¸­çš„innodbå­˜å‚¨å¼•æ“çš„è®¾è®¡æ¨¡å‹ï¼Œä¼šè®¾è®¡å‡ºä¸€ä¸ªç¼“å­˜åŒºæ¥å¯¹çƒ­ç‚¹æ•°æ®çš„ç¼“å­˜ã€‚å¯¹äºç¼“å­˜æ•°æ®çš„æ›¿æ¢ç­–ç•¥æœ‰<B>LRU</B>ã€<B>LIRS</B>ï¼Œå…¶ä¸­LIRSçš„è®¾è®¡æ¯”è¾ƒæœ‰è¶£ï¼ŒLIRSæ˜¯ä¸ºäº†è§£å†³LRUç­–ç•¥æ— æ³•å¤„ç†å› å…¨è¡¨æ‰«æå¯¼è‡´æ±¡æŸ“ç¼“å†²åŒºçš„åœºæ™¯ï¼Œåº•å±‚é‡‡ç”¨å¤šçº§ç¼“å†²çš„ç­–ç•¥ï¼Œè®¾ç½®æ™‹å‡é˜ˆå€¼æ¥é¿å…ä¸€çº§ç¼“å­˜å—åˆ°æ±¡æŸ“</p></li><li><p>LSMå­˜å‚¨å¼•æ“<br>LSMå­˜å‚¨å¼•æ“çš„å…¨ç§°æ˜¯â€™Log-structured merge-treeâ€™. å°†å¯¹æ•°æ®çš„ä¿®æ”¹å¢é‡ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œè¾¾åˆ°æŒ‡å®šçš„å¤§å°é™åˆ¶åå°†è¿™äº›ä¿®æ”¹æ“ä½œæ‰¹é‡é¡ºåºå†™å…¥ç£ç›˜ä¸­ã€‚LSMé€‚åˆäºå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œé€šè¿‡ç‰ºç‰²è¯»å–æ€§èƒ½æ¥æ¢å†™å…¥çš„æ€§èƒ½</p></li></ul><h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“"></a>å°ç»“</h3><p>å…³äºæ›´å¤šçš„å­˜å‚¨å¼•æ“å¯ä»¥å‚è€ƒ<br><a href="https://dev.to/creativcoder/what-is-a-lsm-tree-3d75">What is a LSM Tree?</a><br><a href="ttps://bbs.huaweicloud.com/blogs/detail/197482">å­˜å‚¨å¼•æ“å¯¹æ¯”</a><br><a href="https://www.cs.umb.edu/~poneil/lsmtree.pdf">LSM Tree è®ºæ–‡</a></p><h2 id="æ•°æ®æ¨¡å‹"><a class="header-anchor" href="#æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><p>æ•°æ®æ¨¡å‹æŒ‡çš„æ˜¯å­˜å‚¨å¼•æ“ç”¨ä»€ä¹ˆæ ¼å¼ä¿å­˜æ•°æ®å¸¸ç”¨çš„æ•°æ®æ¨¡å‹æœ‰â€™æ–‡ä»¶â€™ã€â€˜å…³ç³»â€™ã€â€˜é”®å€¼å¯¹â€™</p><h2 id="äº‹åŠ¡"><a class="header-anchor" href="#äº‹åŠ¡"></a>äº‹åŠ¡</h2><ul><li>äº‹åŠ¡çš„ç‰¹æ€§:ACID</li><li>äº‹åŠ¡çš„ç§ç±»:è¯»äº‹åŠ¡ã€å†™äº‹åŠ¡ã€æ··åˆäº‹åŠ¡</li><li>äº‹åŠ¡çš„å®ç°:é”ã€COWã€MVCC</li></ul><h2 id="æ•…éšœæ¢å¤"><a class="header-anchor" href="#æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h2><p>æ•°æ®åº“éœ€è¦å®ç°å®Œå–„çš„æ•…éšœæ¢å¤æœºåˆ¶ï¼Œä¸€èˆ¬æ˜¯é‡‡ç”¨æ“ä½œæ—¥å¿—æ¥å®ç°çš„ã€‚<br>æ“ä½œæ—¥å¿—åˆ†ä¸º</p><ul><li>å›æ»šæ—¥å¿—(UNDO log) ç”¨æ¥è®°å½•äº‹åŠ¡ä¿®æ”¹å‰çš„è®°å½•</li><li>é‡åšæ—¥å¿—(REDO log) ç”¨æ¥è®°å½•äº‹åŠ¡ä¿®æ”¹åçš„çŠ¶æ€</li><li>æ“ä½œæ—¥å¿—(binlog) ç”¨æ¥è®°å½•å¯¹ç‰©ç†ç£ç›˜çš„æ“ä½œ</li></ul><h2 id="æ•°æ®å‹ç¼©"><a class="header-anchor" href="#æ•°æ®å‹ç¼©"></a>æ•°æ®å‹ç¼©</h2><p>æ•°æ®å‹ç¼©æ˜¯å¯¹å¤§é‡æ•°æ®è¿›è¡Œå‹ç¼©ä»¥èŠ‚çœç©ºé—´ã€‚å‹ç¼©ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯æŸ¥æ‰¾é‡å¤æ•°æ®ï¼Œ'åˆ—å¼å­˜å‚¨æŠ€æœ¯â€™æ˜¯æŠŠç›¸åŒåˆ—çš„æ•°æ®ç»„ç»‡åœ¨ä¸€èµ·</p><h3 id="å‹ç¼©ç®—æ³•"><a class="header-anchor" href="#å‹ç¼©ç®—æ³•"></a>å‹ç¼©ç®—æ³•</h3><ul><li>Huffmanç¼–ç </li><li>LZç³»åˆ—å‹ç¼©ç®—æ³•</li></ul><h3 id="åˆ—å¼å­˜å‚¨"><a class="header-anchor" href="#åˆ—å¼å­˜å‚¨"></a>åˆ—å¼å­˜å‚¨</h3><pre><code>åˆ—å¼å­˜å‚¨æ˜¯é’ˆå¯¹äºä¼ ç»Ÿçš„è¡Œå¼å­˜å‚¨çš„å¯¹åº”ï¼Œé’ˆå¯¹çš„æ˜¯OLAPçš„åœºæ™¯ã€‚æŒ‰ç…§åˆ—æ¥å­˜å‚¨æ•°æ®å°±ä¼šå¯¼è‡´åˆ—ä¸Šé‡å¤çš„å€¼è¾ƒå¤šï¼Œå› æ­¤å°±éœ€è¦ä½¿ç”¨å‹ç¼©ç®—æ³•æ¥è¿›è¡Œå‹ç¼©</code></pre><h2 id="åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿç‰¹æ€§"><a class="header-anchor" href="#åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿç‰¹æ€§"></a>åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿç‰¹æ€§</h2><p>åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿåº•å±‚ä¸»è¦ä¾èµ–ä¸¤ä¸ªåè®®<B>Paxosé€‰ä¸¾åè®®</B>ã€<B>ä¸¤é˜¶æ®µæäº¤åè®®</B></p><h3 id="å¼‚å¸¸"><a class="header-anchor" href="#å¼‚å¸¸"></a>å¼‚å¸¸</h3><ul><li>å®•æœº</li><li>ç½‘ç»œå¼‚å¸¸<br>æ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯ä¹±åºã€ç½‘ç»œæ•°æ®åŒ…å¼‚å¸¸</li></ul><blockquote><p>è®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ä¸ªåŸåˆ™æ˜¯:ç½‘ç»œæ°¸è¿œæ˜¯ä¸å¯é çš„</p></blockquote><ul><li>ç£ç›˜æ•…éšœ</li></ul><h3 id="çŠ¶æ€"><a class="header-anchor" href="#çŠ¶æ€"></a>çŠ¶æ€</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®šä¹‰çš„ç³»ç»ŸçŠ¶æ€æœ‰ä¸”åªæœ‰<B>æˆåŠŸ</B>ã€<B>å¤±è´¥</B>ã€<B>æœªçŸ¥</B></p><h3 id="ä¸€è‡´æ€§"><a class="header-anchor" href="#ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ç”±äºå¼‚å¸¸æ˜¯æ— æ³•é¿å…çš„ï¼Œå› æ­¤éœ€è¦å†—ä½™å¤šä»½æ•°æ®æ¥ä¿è¯å¯ç”¨æ€§ã€‚å†—ä½™çš„å¤šä»½å‰¯æœ¬å°±ä¼šå­˜åœ¨æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå¦‚ä½•ä¿è¯å‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§æ˜¯å…³é”®</p><h2 id="æ•°æ®åˆ†å¸ƒ"><a class="header-anchor" href="#æ•°æ®åˆ†å¸ƒ"></a>æ•°æ®åˆ†å¸ƒ</h2><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸å•æœºå­˜å‚¨ç³»ç»Ÿç³»ç»Ÿæœ€å¤§çš„åŒºåˆ«åœ¨äº<B>æ•°æ®åˆ†å¸ƒ</B>ä¸Š,åˆ†å¸ƒå¼ç³»ç»Ÿå¯ä»¥å°†æ•°æ®æŒ‰ç…§<B>Hashåˆ†å¸ƒ</B>ã€<B>é¡ºåºåˆ†å¸ƒ</B>ä¸¤ç§æ–¹å¼è¿›è¡Œåˆ’åˆ†ã€‚</p><h3 id="Hashåˆ†å¸ƒ"><a class="header-anchor" href="#Hashåˆ†å¸ƒ"></a>Hashåˆ†å¸ƒ</h3><p>Hashåˆ†å¸ƒåŸç†æ¯”è¾ƒç®€å•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ‰©å®¹åœºæ™¯ä¸‹çš„å¤„ç†ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•åˆ†åˆ«æ˜¯</p><ul><li>å…ƒæ•°æ®åŒº<br>å¼•å…¥å…ƒæ•°æ®åŒºï¼Œé€šè¿‡å…ƒæ•°æ®åŒºæ¥ç®¡ç†hashçš„keyä¸valueä¹‹é—´çš„å…³ç³»</li><li>ä¸€è‡´æ€§hashç®—æ³•<br>ä½¿ç”¨ä¸€è‡´æ€§hashç®—æ³•,ä¿è¯èŠ‚ç‚¹çš„å¹³å‡åˆ†å¸ƒ</li></ul><blockquote><p>ä¸€è‡´æ€§hashç®—æ³•å¦‚ä½•åœ¨æ‰©å®¹æ—¶ä¿è¯æ•°æ®çš„å¹³å‡åˆ†å¸ƒ?</p></blockquote><p>Hashç®—æ³•ä¸æ”¯æŒé¡ºåºæŸ¥æ‰¾</p><h3 id="é¡ºåºåˆ†å¸ƒ"><a class="header-anchor" href="#é¡ºåºåˆ†å¸ƒ"></a>é¡ºåºåˆ†å¸ƒ</h3><p>é¡ºåºåˆ†å¸ƒæŒ‡çš„æ˜¯æ•°æ®æŒ‰ç…§æŒ‡å®šçš„ç»´åº¦é¡ºåºçš„å†™å…¥æ•°æ®ï¼Œå¤šç”¨äºåˆ†å¸ƒå¼è¡¨æ ¼ç³»ç»Ÿä¸­</p><h2 id="å¤åˆ¶"><a class="header-anchor" href="#å¤åˆ¶"></a>å¤åˆ¶</h2><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®çš„å¤åˆ¶æœºåˆ¶å†³å®šäº†è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹å¯ç”¨æ€§å’Œä¸€è‡´æ€§çš„å–èˆã€‚æ•°æ®çš„å¤åˆ¶å¯ä»¥åˆ†ä¸º<B>å¼ºåŒæ­¥å¤åˆ¶</B>ã€<B>å¼‚æ­¥å¤åˆ¶</B>ä¸¤ç§æ–¹å‘ã€‚<br>åœ¨å·¥ç¨‹å®è·µä¸­åˆå¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªæ–¹å‘åšä¸åŒçš„å–èˆï¼Œä»¥Oracleçš„DataGuardå¤åˆ¶ç»„ä»¶ä¸ºä¾‹,æä¾›äº†ä¸‰ç§ä¸åŒçš„æ¨¡å¼</p><ul><li>æœ€å¤§ä¿æŠ¤æ¨¡å¼<br>æœ€å¤§ä¿æŠ¤æ¨¡å¼ä¹Ÿå°±æ˜¯å¼ºåŒæ­¥å¤åˆ¶æ¨¡å¼</li><li>æœ€å¤§æ€§èƒ½æ¨¡å¼<br>æœ€å¤§æ€§èƒ½æ¨¡å¼ä¹Ÿå°±æ˜¯å¼‚æ­¥å¤åˆ¶æ¨¡å¼</li><li>æœ€å¤§å¯ç”¨æ¨¡å¼<br>æœ€å¤§å¯ç”¨æ¨¡å¼æ˜¯é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨å¼ºåŒæ­¥å¤åˆ¶æ¨¡å¼ï¼Œç½‘ç»œå¼‚å¸¸æ—¶ä½¿ç”¨å¼‚æ­¥å¤åˆ¶æ¨¡å¼</li></ul><h2 id="æ•…éšœæ£€æµ‹"><a class="header-anchor" href="#æ•…éšœæ£€æµ‹"></a>æ•…éšœæ£€æµ‹</h2><p>æ•…éšœæ£€æµ‹å¸¸ç”¨çš„æ–¹æ³•æœ‰å¿ƒè·³ã€Ï†-accrual(ç´¯è®¡å†å²æ•…éšœæ£€æµ‹å™¨)ã€ Gossipæ•…éšœæ£€æµ‹.è¿™å‡ ç§æ–¹å¼</p><p><a href="https://iswade.github.io/database/db_internals_ch09_failure_detection/#gossip">åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹æ•…éšœæ£€æµ‹</a><br><a href="https://www.serf.io/docs/internals/gossip.html">serfå®˜ç½‘</a><br><a href="https://flogx.com/post/using-serf-to-implement-distributed-fault-detection/">ä½¿ç”¨serfå®ç°åˆ†å¸ƒå¼æ•…éšœæ£€æµ‹</a></p><h2 id="æ•…éšœæ¢å¤-v2"><a class="header-anchor" href="#æ•…éšœæ¢å¤-v2"></a>æ•…éšœæ¢å¤</h2><p>æ•…éšœæ¢å¤æ˜¯ç”±äºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹æœºå™¨æˆ–ç½‘ç»œçš„æ•…éšœï¼Œéœ€è¦é€šè¿‡æ•…éšœæ¢å¤çš„æœºåˆ¶å°†æœåŠ¡ä»ä¸å¯ç”¨çŠ¶æ€æ¢å¤æˆå¯ç”¨çŠ¶æ€ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„å­˜å‚¨æ–¹æ¡ˆåˆ†ä¸ºä¸¤ç§ç»“æ„:<B>å•å±‚ç»“æ„</B>ã€<B>åŒå±‚ç»“æ„</B></p><ul><li>å•å±‚ç»“æ„<br>å•å±‚ç»“æ„æŒ‡çš„æ˜¯æœåŠ¡å’Œå­˜å‚¨éƒ½ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæŒ‰ç…§èŠ‚ç‚¹è¿›è¡Œåˆ†ç‰‡</li><li>å¤šå±‚ç»“æ„<br>å¤šå±‚ç»“æ„æŒ‡çš„æ˜¯å­˜å‚¨ç³»ç»ŸæŒ‰ç…§æœåŠ¡å±‚å’Œå­˜å‚¨å±‚è¿›è¡Œåˆ†å±‚,åœ¨æœåŠ¡å±‚åªæä¾›ä¸€ä¸ªä¸€ä»½æ•°æ®</li></ul><h2 id="åˆ†å¸ƒå¼åè®®"><a class="header-anchor" href="#åˆ†å¸ƒå¼åè®®"></a>åˆ†å¸ƒå¼åè®®</h2><p><B>åˆ†å¸ƒå¼åè®®</B>æ ¹æ®ä¸åŒçš„ä½œç”¨åŸŸå¯ä»¥åˆ’åˆ†ä¸ºç§Ÿçº¦\å¤åˆ¶åè®®\ä¸€è‡´æ€§åè®®ç­‰.æ¯”è¾ƒé‡è¦çš„æ˜¯<B>ä¸¤é˜¶æ®µæäº¤åè®®</B>ã€<B>Paxosé€‰ä¸¾åè®®</B></p><ul><li><p>ä¸¤é˜¶æ®µæäº¤åè®®<br>ä¸¤é˜¶æ®µæäº¤åè®®æŒ‡çš„æ˜¯å°†åˆ†å¸ƒå¼äº‹åŠ¡çš„æ“ä½œåˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ,åˆ†åˆ«æ˜¯<B>è¯·æ±‚é˜¶æ®µ</B>ã€<B>æäº¤é˜¶æ®µ</B><br>ä¸¤é˜¶æ®µæäº¤åè®®ä¸­çš„åŒ…æ‹¬çš„èŠ‚ç‚¹æœ‰ä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯<B>åè°ƒè€…</B>å’Œ<B>å‚ä¸è€…</B></p><p><img src="https://i.loli.net/2021/11/11/qxE9X3mhKwDJfBg.jpg" alt="ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹.jpg"></p></li><li><p>Paxosé€‰ä¸¾åè®®<br>Paxosé€‰ä¸¾åè®®ä¸»è¦æ˜¯ç”¨äºè§£å†³å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ä¸€è‡´æ€§é—®é¢˜ã€‚å¯ä»¥å‚è€ƒä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« <a href="https://agmtopy.github.io/2020/06/23/1.%E6%9D%82%E8%AE%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7paxos%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0zab%E5%8D%8F%E8%AE%AE/">åˆ†å¸ƒå¼ä¸­çš„ä¸€è‡´æ€§paxosç®—æ³•ä»¥åŠå…¶å®ç°zabåè®®</a><br>é‡‡ç”¨â€™Quorumæœºåˆ¶â€™æœºåˆ¶æ¥ä¿è¯èŠ‚ç‚¹ä½œä¸ºä¸€ä¸ªæ•´ä½“å¯¹å¤–çš„ä¸€è‡´æ€§,ç®€å•çš„æ¥è¯´å°±æ˜¯é€šè¿‡åºåˆ—å·å’Œå¤§å¤šæ•°ç¡®è®¤æœºåˆ¶æ¥ä¿è¯é›†ç¾¤çš„ä¸€è‡´æ€§</p></li><li><p>Paxosä¸2PCæ··åˆåœºæ™¯<br><img src="https://i.loli.net/2021/11/11/M12yJLwtjePQfnr.jpg" alt="2PCä¸Paoxsçš„å¯¹æ¯”.jpg"></p></li></ul><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>åŸºç¡€ç¯‡ä¸»è¦æ˜¯ä»‹ç»å•æœºå­˜å‚¨ç³»ç»Ÿçš„<B>ç¡¬ä»¶åŸºç¡€</B>ã€<B>å­˜å‚¨å¼•æ“</B>ã€åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ<B>æ•°æ®æ¨¡å‹</B>ã€<B>åˆ†å¸ƒå¼ç‰¹æ€§</B>ã€<B>æ•…éšœæ£€æµ‹/æ¢å¤</B>ã€<B>åˆ†å¸ƒå¼åè®®</B>ç­‰</p><ul><li></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ-åŸºç¡€ç¯‡&lt;/h1&gt;
&lt;p&gt;ä¸»è¦æ˜¯è®°å½•é˜…è¯»ã€Šå¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼šåŸç†è§£æä¸æ¶æ„å®æˆ˜ã€‹åŸºç¡€ç¯‡ä¸­çš„ä¸€äº›çŸ¥è¯†å’Œç†è§£ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¹¦è¯„&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&quot;https://book.douban.com/subject</summary>
      
    
    
    
    <category term="åˆ†å¸ƒå¼" scheme="https://agmtopy.gitee.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://agmtopy.gitee.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥å‰–æKubernetesä¹‹Kubernetesçš„åŸºç¡€æ¦‚å¿µ</title>
    <link href="https://agmtopy.gitee.io/2021/11/08/18.%E5%AE%B9%E5%99%A8%E5%8C%96/1.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BKubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
    <id>https://agmtopy.gitee.io/2021/11/08/18.%E5%AE%B9%E5%99%A8%E5%8C%96/1.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8BKubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/</id>
    <published>2021-11-08T08:31:00.000Z</published>
    <updated>2021-11-28T05:39:51.593Z</updated>
    
    <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹Kubernetesçš„åŸºç¡€</h1><blockquote><p>Kubernetesæ˜¯ç”±googleå’ŒRetHotä¸»å¯¼çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œå·²ç»ç§°ä¸ºå®¹å™¨ç¼–æ’çš„æ ‡å‡†.Kubernetesæºè‡ªGoogleå†…éƒ¨çš„Borg,å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </p></blockquote><p><a href="https://kubernetes.io/zh/blog/2015/04/borg-predecessor-to-kubernetes/">Borg: Kubernetes çš„å‰èº«</a></p><h2 id="æ¦‚å¿µ"><a class="header-anchor" href="#æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Kubernetesæ˜¯ä¸€ä¸ªå¯¹å®¹å™¨è¿›è¡Œç®¡ç†çš„æ¡†æ¶,æä¾›äº†<B>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</B>ã€<B>å­˜å‚¨ç¼–æ’</B>ã€<B>è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š</B>ã€<B>è‡ªåŠ¨å®Œæˆè£…ç®±è®¡ç®—</B>ã€<B>è‡ªæˆ‘ä¿®å¤</B>ã€<B>å¯†é’¥ä¸é…ç½®ç®¡ç†</B>ç­‰åŠŸèƒ½ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </p><p><a href="https://kubernetes.io/zh/docs/concepts/overview/">Kubernetes æ˜¯ä»€ä¹ˆ</a></p><h2 id="ç»„ä»¶"><a class="header-anchor" href="#ç»„ä»¶"></a>ç»„ä»¶</h2><p><img src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt="kubernetesç»„ä»¶æ€»è§ˆ"></p><p>kubernetesçš„ç»„ä»¶åˆ†ä¸º<B>æ§åˆ¶å¹³é¢ç»„ä»¶</B>ã€<B>Node ç»„ä»¶</B>ã€<B>æ’ä»¶</B></p><h3 id="æ§åˆ¶å¹³é¢ç»„ä»¶"><a class="header-anchor" href="#æ§åˆ¶å¹³é¢ç»„ä»¶"></a>æ§åˆ¶å¹³é¢ç»„ä»¶</h3><p>æ§åˆ¶å¹³é¢ç»„ä»¶æ˜¯å¯¹é›†ç¾¤åšå‡ºå…¨å±€å†³ç­–(æ¯”å¦‚è°ƒåº¦)ï¼Œä»¥åŠæ£€æµ‹å’Œå“åº”é›†ç¾¤äº‹ä»¶çš„å†³ç­–å’Œå¤„ç†ã€‚</p><h3 id="Node-ç»„ä»¶"><a class="header-anchor" href="#Node-ç»„ä»¶"></a>Node ç»„ä»¶</h3><p>NodeèŠ‚ç‚¹ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾› Kubernetes è¿è¡Œç¯å¢ƒã€‚</p><h3 id="æ’ä»¶ï¼ˆAddonsï¼‰"><a class="header-anchor" href="#æ’ä»¶ï¼ˆAddonsï¼‰"></a>æ’ä»¶ï¼ˆAddonsï¼‰</h3><p>æ’ä»¶æ˜¯æ˜¯å¯¹Kubernetesèµ„æºï¼ˆDaemonSetã€ Deploymentç­‰ï¼‰å®ç°ç®¡ç†çš„åŠŸèƒ½ã€‚ å› ä¸ºè¿™äº›æ’ä»¶æä¾›é›†ç¾¤çº§åˆ«çš„åŠŸèƒ½ï¼Œæ’ä»¶ä¸­å‘½åç©ºé—´åŸŸçš„èµ„æºå±äºkube-systemå‘½åç©ºé—´ã€‚</p><h2 id="éƒ¨ç½²"><a class="header-anchor" href="#éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>Kubernetesçš„éƒ¨ç½²å·¥å…·ç›®å‰æœ‰<B>kubectl</B>ã€<B>kind</B>ã€<B>minikube</B>ã€<B>kubeadm</B></p><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/">kubernetesçš„éƒ¨ç½²å·¥å…·æ–‡æ¡£</a></p><h2 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h2><p>å¦‚ä½•åˆ›å»ºä¸€ä¸ªç®€å•çš„kubernetesçš„æœ¬åœ°ç¯å¢ƒ</p><h3 id="å‰ç½®å‡†å¤‡"><a class="header-anchor" href="#å‰ç½®å‡†å¤‡"></a>å‰ç½®å‡†å¤‡</h3><ul><li><p>å·¥å…·</p><ol><li>minikube</li><li>kubectl</li></ol></li><li><p>æ­¥éª¤</p><ol><li>å®‰è£…minikube</li></ol><ul><li>æ£€æŸ¥æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–</li></ul><blockquote><p>grep -E --color â€˜vmx|svmâ€™ /proc/cpuinfo</p></blockquote><ul><li>å®‰è£…é…ç½® kubectl</li></ul>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https<span class="token function">curl</span> -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -<span class="token builtin class-name">echo</span> <span class="token string">"deb https://apt.kubernetes.io/ kubernetes-xenial main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/apt/sources.list.d/kubernetes.list<span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å®‰è£…minikube</li></ul>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64<span class="token function">sudo</span> <span class="token function">install</span> minikube-linux-amd64 /usr/local/bin/minikube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>å¯åŠ¨</li></ol><ul><li>æŸ¥çœ‹æ‰€æœ‰namespaceä¸‹çš„pod</li></ul><blockquote><p>kubectl get po -A</p></blockquote><ul><li>å®‰è£…ä»ªè¡¨ç›˜</li></ul><blockquote><p>minikube dashboard</p></blockquote><p>å¯åŠ¨æ§åˆ¶å°åå¯ä»¥çœ‹åˆ°<br><img src="https://i.loli.net/2021/11/27/iYAxaecJMdFurZQ.jpg" alt="kubernetesæ§åˆ¶å°"></p></li></ul><h3 id="é…ç½®æ–‡ä»¶"><a class="header-anchor" href="#é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>kubernetesä¸æ¨èä½¿ç”¨å‘½ä»¤è¡Œæ¥æ“ä½œå®¹å™¨ï¼Œè€Œæ˜¯æ¨èä½¿ç”¨YAMLæ–‡ä»¶æ¥è¿›è¡Œé…ç½®</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„zké›†ç¾¤çš„é…ç½®æ–‡ä»¶</p><ul><li>application/zookeeper/zookeeper.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>hs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2888</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> server  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3888</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>election  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>cs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2181</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> client  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> zk<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>pdb<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> zk  <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> zk  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>hs  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> zk    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"app"</span>                    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                    <span class="token key atrule">values</span><span class="token punctuation">:</span>                    <span class="token punctuation">-</span> zk              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/hostname"</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>zookeeper        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10"</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"1Gi"</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"0.5"</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">2181</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">2888</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> server        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3888</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>election        <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> "start<span class="token punctuation">-</span>zookeeper \          <span class="token punctuation">-</span><span class="token punctuation">-</span>servers=3 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>data_dir=/var/lib/zookeeper/data \          <span class="token punctuation">-</span><span class="token punctuation">-</span>data_log_dir=/var/lib/zookeeper/data/log \          <span class="token punctuation">-</span><span class="token punctuation">-</span>conf_dir=/opt/zookeeper/conf \          <span class="token punctuation">-</span><span class="token punctuation">-</span>client_port=2181 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>election_port=3888 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>server_port=2888 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>tick_time=2000 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>init_limit=10 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>sync_limit=5 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>heap=512M \          <span class="token punctuation">-</span><span class="token punctuation">-</span>max_client_cnxns=60 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>snap_retain_count=3 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>purge_interval=12 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>max_session_timeout=40000 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>min_session_timeout=4000 \          <span class="token punctuation">-</span><span class="token punctuation">-</span>log_level=INFO"        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> sh            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c            <span class="token punctuation">-</span> <span class="token string">"zookeeper-ready 2181"</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> sh            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c            <span class="token punctuation">-</span> <span class="token string">"zookeeper-ready 2181"</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> datadir          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/zookeeper      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> datadir    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é…ç½®æ–‡ä»¶ä»¥â€™â€”'ä½œä¸ºå®¹å™¨é…ç½®åˆ†å‰²ç¬¦ï¼Œåˆ†åˆ«åˆ›å»ºäº†4ä¸ªå®¹å™¨ä»è€Œåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ZKé›†ç¾¤</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">service/zk-hs createdservice/zk-cs createdpoddisruptionbudget.policy/zk-pdb createdstatefulset.apps/zk created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><ol><li>kuberneteså†…éƒ¨æ˜¯ç”±å››ä¸ªç»„ä»¶ç»„æˆ</li></ol><ul><li>æ§åˆ¶å¹³é¢ç»„ä»¶</li><li>NodeèŠ‚ç‚¹ç»„ä»¶</li><li>æ’ä»¶</li></ul><ol start="2"><li>éƒ¨ç½²å·¥å…·</li></ol><ul><li>minikube</li><li>kind</li><li>kubeadm</li></ul><ol start="3"><li>é…ç½®æ–‡ä»¶<br>é…ç½®æ–‡ä»¶å°†å®¹å™¨ä¸­æŒ‰ç…§é›†ç¾¤éƒ¨ç½²çš„æ–¹å¼æ ¹æ®åº”ç”¨ç»´åº¦æ‰“åŒ…å½¢æˆä¸€ä¸ªé…ç½®æ–‡ä»¶,åç»­å°±å¯ä»¥è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œå¯åŠ¨ã€‚è¿™é‡Œåº”ç”¨çš„æ¦‚å¿µåœ¨kubernetesä¸­è¢«ç§°ä¸ºpod,ä¸€ä¸ªpodæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆçš„ã€‚</li></ol><h2 id="å‚è€ƒæ–‡æ¡£"><a class="header-anchor" href="#å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p><a href="https://kubernetes.io/zh">kubernetesä¸­æ–‡å®˜ç½‘</a><br><a href="https://kubernetes.io/zh/docs/tutorials/kubernetes-basics/create-cluster/cluster-interactive/">kubernetesäº¤äº’æ–‡æ¡£</a><br><a href="https://minikube.sigs.k8s.io/docs/handbook/">minikubeå®˜ç½‘</a><br><a href="https://kubernetes.io/zh/docs/tutorials/stateful-application/zookeeper/">éƒ¨ç½²è¿è¡ŒZooKeeperé›†ç¾¤</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;æ·±å…¥å‰–æKubernetesä¹‹Kubernetesçš„åŸºç¡€&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;Kubernetesæ˜¯ç”±googleå’ŒRetHotä¸»å¯¼çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œå·²ç»ç§°ä¸ºå®¹å™¨ç¼–æ’çš„æ ‡å‡†.Kubernetesæºè‡ªGoogleå†…éƒ¨çš„Borg,å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« &lt;/p&gt;
</summary>
      
    
    
    
    <category term="å®¹å™¨åŒ–" scheme="https://agmtopy.gitee.io/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
    
    <category term="Kubernetes" scheme="https://agmtopy.gitee.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ReadWriteLockçš„æºç åˆ†æ</title>
    <link href="https://agmtopy.gitee.io/2021/11/02/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/16.ReadWriteLock%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://agmtopy.gitee.io/2021/11/02/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/16.ReadWriteLock%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2021-11-02T08:24:34.000Z</published>
    <updated>2021-11-16T08:38:21.966Z</updated>
    
    <content type="html"><![CDATA[<h1>ReadWriteLockçš„æºç åˆ†æ</h1><p>ReadWriteLockæ˜¯JUCåŒ…ä¸‹çš„å®šä¹‰çš„è¯»å†™é”çš„æ¥å£,å®šä¹‰ä¸¤ä¸ªæ¥å£<B>readLock()</B>ã€<B>writeLock()</B>åˆ†åˆ«æ˜¯è¿”å›è¯»é”å’Œè¿”å›ä¸€ä¸ªå†™é”ã€‚<br>ReadWriteLocké»˜è®¤æœ‰ä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯<B>ReadWriteLockView</B>ã€<B>ReentrantReadWriteLock</B>ã€‚</p><p>ReentrantReadWriteLockæ˜¯é»˜è®¤çš„è¯»å†™é”çš„å®ç°<br>ReadWriteLockViewæ˜¯<B>StampedLock</B>çš„å†…éƒ¨ç±»ï¼ŒStampedLockæ˜¯JDK 1.8ä¸­å¯¹ReentrantReadWriteLockçš„ä¸€ä¸ªå¢å¼ºçš„å®ç°<br>ä¸‹é¢ä¼šå…ˆåˆ†æReentrantReadWriteLockï¼Œåœ¨å¯¹StampedLockè¿›è¡Œåˆ†æ</p><h2 id="ReentrantReadWriteLock"><a class="header-anchor" href="#ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h2><blockquote><p>ReentrantReadWriteLockæ˜¯å®ç°ReadWriteLockæ¥å£,å¯¹å¤–æä¾›read()å’Œwirte()æ–¹æ³•ã€‚ç‰¹ç‚¹ä¸»è¦æ˜¯æ”¯æŒå…¬å¹³é”é€‰æ‹©ã€å¯é‡å…¥ã€é”é™çº§çš„åˆ†ç±»</p></blockquote><h3 id="ç”¨ä¾‹"><a class="header-anchor" href="#ç”¨ä¾‹"></a>ç”¨ä¾‹</h3><p>è¿™ä¸ªç”¨ä¾‹æ˜¯å¯¹ReentrantReadWriteLockæä¾›çš„ç”¨ä¾‹CachedDataçš„ç®€åŒ–ç‰ˆæœ¬</p><ul><li>CachedData</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> CachedData <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> <span class="token keyword">data</span><span class="token operator">:</span> String    <span class="token keyword">private</span> <span class="token keyword">var</span> cacheValid<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> lock<span class="token operator">:</span> ReentrantReadWriteLock <span class="token operator">=</span> <span class="token function">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">fun</span> <span class="token function">processCacheData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è·å–è¯»é”</span>        lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheValid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è·å–å†™é”ä¹‹å‰å…ˆè¦é‡Šæ”¾è¯»é”</span>            lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">//è·å–å†™é”</span>            lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å†æ¬¡æ£€æŸ¥æ ‡è®°,å› ä¸ºä¸Šä¸€æ¬¡æ£€æŸ¥æ ‡è®°æ˜¯åœ¨è·å–å†™é”ä¹‹å‰</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheValid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                    <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" set data"</span><span class="token punctuation">)</span>                    <span class="token keyword">data</span> <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    cacheValid <span class="token operator">=</span> <span class="token boolean">true</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//é‡æ–°è·å–è¯»é”æ¥å®Œæˆé”é™çº§</span>                lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"æ‰“å°data:"</span> <span class="token operator">+</span>  <span class="token keyword">data</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>main</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ›å»ºçº¿ç¨‹æ± </span>    <span class="token keyword">val</span> poolExecutor <span class="token operator">=</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token function">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//åˆ›å»ºä»»åŠ¡</span>    <span class="token keyword">var</span> cache<span class="token operator">:</span>CachedData <span class="token operator">=</span> <span class="token function">CachedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> barrier<span class="token operator">:</span>CyclicBarrier <span class="token operator">=</span> <span class="token function">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">&#123;</span>        poolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">&#123;</span>            barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            cache<span class="token punctuation">.</span><span class="token function">processCacheData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œç»“æœ</li></ul><p><img src="https://i.loli.net/2021/11/12/wNerlsGfKLpEhzd.jpg" alt="æ‰§è¡Œç»“æœ"><br>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªçº¿ç¨‹å¯¹dataçš„å†™é”è¿›è¡Œç«äº‰,ä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸæ‰§è¡Œsetæ–¹æ³•,å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹åªèƒ½æ‰§è¡Œè¯»é”çš„æ“ä½œ<br>ä»ç°è±¡ä¸Šæ¥çœ‹ä¸€ä¸ª<B>ReentrantReadWriteLock</B>å¯¹å¤–æä¾›äº†è¯»é”å’Œå†™é”ä¸¤ä¸ªåŠŸèƒ½,ä¸‹é¢å°±å¼€å§‹å¯¹ä»£ç è¿›è¡Œè¯¦ç»†çš„åˆ†æ</p><h3 id="æ„é€ å‡½æ•°"><a class="header-anchor" href="#æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3>  <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Creates a new &#123;@code ReentrantReadWriteLock&#125; with * default (nonfair) ordering properties. */</span><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * Creates a new &#123;@code ReentrantReadWriteLock&#125; with * the given fairness policy. * * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy */</span><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    readerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    writerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æ— å‚çš„æ„é€ å‡½æ•°æ˜¯éå…¬å¹³é”çš„ç­–ç•¥,åœ¨æ„é€ æ–¹æ³•ä¸­ä¸»è¦æ˜¯åˆ›å»ºäº†ä¸‰ä¸ªæˆå‘˜å˜é‡</p>  <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å…¬å¹³é”ç±»å‹</span>    <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>    <span class="token comment">//å†…éƒ¨è¯»é”</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readerLock<span class="token punctuation">;</span>    <span class="token comment">//å†…éƒ¨å†™é”</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writerLock<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æºç è§£æ"><a class="header-anchor" href="#æºç è§£æ"></a>æºç è§£æ</h3><h4 id="æ„é€ æ–¹æ³•"><a class="header-anchor" href="#æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><ul><li>è·å–é”çš„æ–¹æ³•<br>è·å–è¯»é”/å†™é”å°±æ˜¯ç›´æ¥è¿”å›å†…éƒ¨çš„è¯»é”/å†™é”å˜é‡</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> writerLock<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span>  <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> readerLock<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°é”çš„ç±»å‹åˆ†åˆ«æ˜¯ReadLockå’ŒWriteLock,ç»§ç»­åˆ†æReadLock/WriteLock</p><ul><li><p>ReadLockä¸WriteLockå¯¹æ¯”</p></li><li><p>ReadLock</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5992448646407690164L</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token class-name">ReadLock</span><span class="token punctuation">(</span><span class="token class-name">ReentrantReadWriteLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync <span class="token operator">=</span> lock<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireSharedNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> sync<span class="token punctuation">.</span><span class="token function">getReadLockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">"[Read locks = "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>WriteLock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4992448646407690164L</span><span class="token punctuation">;</span>    <span class="token comment">//ReentrantReadWriteLockå†…éƒ¨çš„AQSå…¬å¹³/éå…¬å¹³æŠ½è±¡ç±»</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token class-name">WriteLock</span><span class="token punctuation">(</span><span class="token class-name">ReentrantReadWriteLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync <span class="token operator">=</span> lock<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Thread</span> o <span class="token operator">=</span> sync<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span>                                    <span class="token string">"[Unlocked]"</span> <span class="token operator">:</span>                                    <span class="token string">"[Locked by thread "</span> <span class="token operator">+</span> o<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æŸ¥è¯¢å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰å†™é”</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å½“å‰å†™é”çš„é”å®šæ¬¡æ•°</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getWriteHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å¯¹æ¯”å¯çŸ¥<B>WriteLock</B>åªæ˜¯æ¯”<B>ReadLock</B>å¤šä¸¤ä¸ªæ–¹æ³•</p><ul><li>isHeldByCurrentThread()<br>æŸ¥è¯¢å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰å†™é”</li><li>getHoldCount()<br>å½“å‰å†™é”çš„é”å®šæ¬¡æ•°</li></ul><p>åŒæ—¶å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯<B>WriteLock</B>ã€<B>ReadLock</B>éƒ½æ˜¯ä½¿ç”¨<B>Sync</B>æ¥å®ç°çš„åŠŸèƒ½ï¼Œä¸‹é¢è¯¦ç»†çš„åˆ†æä¸€ä¸‹<B>Sync</B>ç±»çš„å®ç°</p><ul><li><B>Sync</B></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">ThreadLocalHoldCounter</span> readHolds<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>    <span class="token comment">//æ„é€ å‡½æ•°</span>    <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ›å»ºThreadLocalHoldCounter(è®°å½•çº¿ç¨‹æŒæœ‰çš„é”æ•°é‡)</span>        readHolds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalHoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®çŠ¶æ€ï¼Œè°ƒç”¨AQSçš„setState()</span>        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ensures visibility of readHolds</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º<B>Sync</B>æ˜¯ç»§æ‰¿è‡ª<B>AbstractQueuedSynchronizer</B>ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»º<B>ThreadLocalHoldCounter</B>å’Œè°ƒç”¨AQSçš„<B>setState()</B>æ–¹æ³•</p><p>æœ‰å…³<B>AbstractQueuedSynchronizer</B>çš„å†…å®¹å¯ä»¥å‚è€ƒä¹‹å‰å†™çš„<br><a href="../../../../../2020/05/22/2.%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86/13.AbstractQueuedSynchronizer%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">AbstractQueuedSynchronizerçš„æºç åˆ†æ</a></p><ul><li><p>ThreadLocalHoldCounter<br>ThreadLocalHoldCounterçš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p></li><li><p>ThreadLocalHoldCounter</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalHoldCounter</span>    <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HoldCounter</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">HoldCounter</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HoldCounter</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HoldCounter</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹ä¸º0</span>    <span class="token keyword">int</span> count<span class="token punctuation">;</span>    <span class="token comment">//ä½¿ç”¨idæ¥æ ‡è¯†Threadè€Œä¸æ˜¯å¼•ç”¨,é¿å…å¼•ç”¨é€ƒé€¸</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> tid <span class="token operator">=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ThreadLocalHoldCounterç»§æ‰¿äºThreadLocalç„¶ååœ¨åˆå§‹åŒ–æ—¶ç”¨initialValue()æ–¹æ³•è¿”å›ä¸€ä¸ª<B>HoldCounter</B>å¼•ç”¨<br>HoldCounteræ˜¯ç”¨æ¥è®°å½•çº¿ç¨‹ä¸­åŠ é”çš„ç»Ÿè®¡ä¸çº¿ç¨‹idç›¸å…³è”,è¿™é‡Œå…³è”çº¿ç¨‹å¼•ç”¨æ˜¯æ¯”è¾ƒä¼˜ç§€çš„,é€šè¿‡<B>LockSupport.getThreadId</B>è·å–ä¸€ä¸ªlongç±»å‹çš„çº¿ç¨‹æ ‡è¯†</p><ul><li>LockSupport.getThreadId</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//Uæ˜¯Unsafeç±»å‹çš„å¯¹è±¡</span>    <span class="token keyword">return</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> TID<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><B>Sync</B>é™¤äº†é€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–ä¸Šè¿°çš„ThreadLocalHoldCounterå¯¹è±¡ä»¥å¤–,è¿˜æœ‰ä¸€äº›é™æ€æˆå‘˜å˜é‡æ¥å®Œæˆä¸€äº›ä¾‹å¦‚æ§åˆ¶å…è®¸çº¿ç¨‹é‡å¤æŒæœ‰é”çš„æ¬¡æ•°ç­‰</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_SHIFT   <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_UNIT    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_COUNT      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCLUSIVE_MASK <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//çœç•¥...</span><span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span> <span class="token operator">></span> MAX_COUNT<span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Reentrant acquire</span>    <span class="token function">setState</span><span class="token punctuation">(</span>c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯å¯¹åŒä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”è¶…è¿‡é˜ˆå€¼çš„æ¼”ç¤º</p><p><img src="https://i.loli.net/2021/11/13/uon9IW6fcLxPRv5.jpg" alt="è¶…è¿‡é”é˜ˆå€¼åœºæ™¯"></p><h4 id="readLock"><a class="header-anchor" href="#readLock"></a>readLock()</h4><ul><li>lock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç›´æ¥ä½¿ç”¨<B>AbstractQueuedSynchronizer</B>çš„<B>acquireShared()</B>è·å–ä¸€æŠŠå…±äº«é”,å¤±è´¥å°±é˜»å¡</p><ul><li>AbstractQueuedSynchronizer.acquireShared</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è°ƒç”¨å­ç±»çš„tryAcquireShared()å®ç°</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ReentrantReadWriteLock.tryAcquireShared()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ReservedStackAccess</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/*    * ä¾‹å­:    * 1. å¦‚æœå†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰å°±è¿”å›å¤±è´¥    * 2. å› æ­¤è¯¥çº¿ç¨‹è·å–åˆ°å†™å…¥èµ„æ ¼,æ ¹æ®çº¿ç¨‹é˜Ÿåˆ—åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œé˜»å¡,ä¸éœ€è¦è¿›è¡Œé˜»å¡æ—¶å°±é€šè¿‡CASçš„æ–¹å¼æ¥æ“ä½œé”ä»¥åŠè®¡æ•°    * 3. å¯¹caså¤±è´¥çš„åœºæ™¯è¿›è¡Œé‡è¯•    */</span>    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–åŒæ­¥çŠ¶æ€</span>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœæœ‰ç‹¬å çº¿ç¨‹å¹¶ä¸”ç‹¬å çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹æ—¶ç›´æ¥è¿”å›-1(å¤±è´¥)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//å…±äº«è®¡æ•°</span>    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//1. é€šè¿‡readerShouldBlock()åˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥æ“ä½œ,readerShouldBlock()ä¸»è¦æ˜¯å¯¹å…¬å¹³é”å’Œéå…¬å¹³é”çš„ä¸€ä¸ªåˆ¤æ–­</span>    <span class="token comment">//2. åˆ¤æ–­å½“å‰æ˜¯å¦æ“ä½œäº†æœ€å¤§çš„åŠ é”é‡</span>    <span class="token comment">//3. é€šè¿‡CASè¿›è¡Œæ“ä½œ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> MAX_COUNT <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> SHARED_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¦‚æœæ˜¯é¦–æ¬¡åŠ é”,è®¾ç½®é¦–æ¬¡åŠ é”çº¿ç¨‹å’Œæ¬¡æ•°</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>            firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¦‚æœæ˜¯é¦–æ¬¡åŠ é”çº¿ç¨‹è¿›è¡Œç»§ç»­åŠ é”é‚£ä¹ˆæ¬¡æ•°++</span>            firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¤„ç†holdCounterå¯¹è±¡</span>            <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>                cachedHoldCounter <span class="token operator">=</span> rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>            rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é‡å¤å¤„ç†</span>    <span class="token keyword">return</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>tryAcquireShared</B>æ˜¯ä¼šæ‰§è¡Œé”çš„è®¡æ•°ã€åˆå§‹çº¿ç¨‹çš„ç»‘å®šç­‰å·¥ä½œï¼Œå¹¶ä¸”ä¼šå¯¹æ‰§è¡Œå¤±è´¥è¿›è¡Œè‡ªæ—‹é‡è¯•</p><ul><li>unlock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨<B>releaseShared</B>æ¥å®Œæˆé‡Šæ”¾é”çš„æ“ä½œ,AQSåˆæ˜¯é€šè¿‡<B>tryReleaseShared</B>æ¥å®Œæˆçš„ï¼Œä¸‹é¢å¯ä»¥çœ‹ä¸€ä¸‹tryReleaseSharedçš„ä»£ç </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å°è¯•é‡Šæ”¾é”</span><span class="token annotation punctuation">@ReservedStackAccess</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœæ˜¯é¦–æ¬¡åŠ é”çº¿ç¨‹å¯¹é¦–æ¬¡çš„æ ‡è®°è¿›è¡Œä¿®æ”¹</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// assert firstReaderHoldCount > 0;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReaderHoldCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>            firstReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            firstReaderHoldCount<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¯¹HoldCounterè¿›è¡Œä¿®æ”¹</span>        <span class="token comment">//å¦‚æœä¸æ˜¯ä¸´æ—¶holdCounter,é‚£ä¹ˆè·å–holdCounterååœ¨è¿›è¡Œå¤„ç†</span>        <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>            rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> rh<span class="token punctuation">.</span>count<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            readHolds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">throw</span> <span class="token function">unmatchedUnlockException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">--</span>rh<span class="token punctuation">.</span>count<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è‡ªæ—‹</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">-</span> SHARED_UNIT<span class="token punctuation">;</span>        <span class="token comment">//CASçš„æ–¹å¼å¯¹é”è¿›è¡Œé‡Šæ”¾</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="writeLock"><a class="header-anchor" href="#writeLock"></a>writeLock()</h4><ul><li>lock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç›´æ¥ä½¿ç”¨<B>AbstractQueuedSynchronizer</B>çš„<B>acquire()</B>è·å–ä¸€æŠŠç‹¬å é”,å¤±è´¥å°±é˜»å¡</p><ul><li>unlock</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨<B>release</B>æ¥å®Œæˆé‡Šæ”¾é”çš„æ“ä½œ</p><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯é€šè¿‡<B>Sync</B>è¿™ä¸ªç±»å§”æ‰˜ç»™<B>AbstractQueuedSynchronizer</B>æ¥è¿›è¡Œçš„,ä¸»è¦æ˜¯ä¸‰ä¸ªåŠŸèƒ½</p><ul><li>åŠ é”(å…±äº«/ç‹¬å )</li><li>è§£é”(å…±äº«/ç‹¬å )</li><li>è®¡æ•°(å…±äº«/ç‹¬å )<br>ç„¶åAQSä½œä¸ºå…¥å£ä¹Ÿä¼šé€šè¿‡è°ƒç”¨<B>ReentrantReadWriteLock</B>çš„å…·ä½“çš„åŠ é”/è§£é”/è®¡æ•°çš„è¿›è¡Œæ“ä½œã€‚<br>è¯»é”ä¸è¿›è¡Œæ’é˜Ÿï¼Œå†™é”ä¼šè¿›è¡Œæ’é˜Ÿé˜»å¡<br><B>ReentrantReadWriteLock</B>ä¸­æœ‰è¶£çš„æ“ä½œæ˜¯æŠŠstateçš„é«˜16ä½ä½œä¸ºè¯»é”æ ‡è¯†ï¼Œä½16ä½ä½œä¸ºå†™é”æ ‡è¯†ï¼Œå› æ­¤ä¹Ÿæ˜¯åªèƒ½åŠ é”2^16çš„åŸå› </li></ul><h2 id="StampedLock"><a class="header-anchor" href="#StampedLock"></a>StampedLock</h2><p><B>StampedLock</B>æ˜¯å¯¹ReentrantReadWriteLockçš„è¿­ä»£ï¼Œåœ¨å¯¹StampedLockä¸­ä¼˜åŒ–äº†å†™é”é¥¥é¥¿çš„é—®é¢˜</p><h3 id="ç”¨ä¾‹-v2"><a class="header-anchor" href="#ç”¨ä¾‹-v2"></a>ç”¨ä¾‹</h3><ul><li>StampedLockDemo</li></ul><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> StampedLockDemo <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">val</span> stampedLock <span class="token operator">=</span> <span class="token function">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">var</span> <span class="token keyword">data</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">fun</span> <span class="token function">writeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">val</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">data</span> <span class="token operator">+=</span> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token number">1</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fun</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">&#123;</span>        <span class="token comment">//1.ä½¿ç”¨ä¹è§‚é”</span>        <span class="token keyword">var</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">var</span> curData <span class="token operator">=</span> <span class="token keyword">data</span>        <span class="token comment">//2. å†™æ³•1 åŒé‡é”ä¿è¯è¯»å–åˆ°çš„æ˜¯æœ€æ–°æ•°æ®</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stampedLock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                curData <span class="token operator">=</span> <span class="token keyword">data</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                stampedLock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//3. å†™æ³•2 å¾ªç¯</span><span class="token comment">//        while(!stampedLock.validate(stamp)) &#123;</span><span class="token comment">//            stamp = stampedLock.tryOptimisticRead();</span><span class="token comment">//            curData = this.data;</span><span class="token comment">//        &#125;</span>        <span class="token keyword">return</span> curData    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>StampedLock</B>åœ¨åŠ é”æ—¶ä¼šè¿”å›ä¸€ä¸ªæˆ³(stamp),å¯ä»¥æŠŠå®ƒç†è§£ä¸ºç‰ˆæœ¬å·/æ—¶é—´æˆ³ï¼Œåœ¨åç»­è§£é”æ—¶ä¼šç”¨åˆ°.</p><ul><li><p>æä¾›äº†ä¹è§‚é”å’Œæ‚²è§‚é”çš„å®ç°</p><ul><li>tryOptimisticRead()</li><li>tryReadLock()</li></ul></li><li><p>é”é™/å‡çº§</p><ul><li>tryConvertToWriteLock()</li><li>tryConvertToReadLock()</li></ul></li></ul><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>ReadWriteLockæ˜¯è¯»å†™é”çš„æ¥å£ï¼Œé»˜è®¤æœ‰ä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯<B>ReentrantReadWriteLock</B>ã€<B>StampedLock</B>,åˆ†åˆ«æ˜¯é’ˆå¯¹è¯»å¤šå†™å°‘çš„åœºæ™¯å’Œéœ€è¦ä½¿ç”¨ä¹è§‚é”çš„åœºæ™¯ã€‚<br>åº•å±‚éƒ½é‡‡ç”¨ä¸€ä¸ªæ ‡å¿—ä½æ¥è¿›è¡ŒåŒºåˆ†è¯»é”/å†™é”æ ‡è¯†,ä¸€ä¸ªæ˜¯Int(32ä½),ä¸€ä¸ªæ˜¯Long(64ä½)ï¼Œå¹¶ä¸”éƒ½ç»§æ‰¿ä¸<B>AbstractQueuedSynchronizer</B>æ¥è¿›è¡Œå®ç°çš„ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.cnblogs.com/zxporz/p/11642176.html">StampedLockçš„ç†è§£å’Œä½¿ç”¨</a><br><a href="https://zxs.io/article/1667">StampedLockæºç åˆ†æ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;ReadWriteLockçš„æºç åˆ†æ&lt;/h1&gt;
&lt;p&gt;ReadWriteLockæ˜¯JUCåŒ…ä¸‹çš„å®šä¹‰çš„è¯»å†™é”çš„æ¥å£,å®šä¹‰ä¸¤ä¸ªæ¥å£&lt;B&gt;readLock()&lt;/B&gt;ã€&lt;B&gt;writeLock()&lt;/B&gt;åˆ†åˆ«æ˜¯è¿”å›è¯»é”å’Œè¿”å›ä¸€ä¸ªå†™é”ã€‚&lt;br&gt;
ReadWriteLocké»˜è®¤æœ‰ä¸¤</summary>
      
    
    
    
    <category term="å¹¶å‘" scheme="https://agmtopy.gitee.io/categories/%E5%B9%B6%E5%8F%91/"/>
    
    
    <category term="ReadWriteLock" scheme="https://agmtopy.gitee.io/tags/ReadWriteLock/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥å‰–æKubernetesä¹‹å®¹å™¨åŒ–çš„åŸºç¡€</title>
    <link href="https://agmtopy.gitee.io/2021/10/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/0.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%9F%BA%E7%A1%80/"/>
    <id>https://agmtopy.gitee.io/2021/10/28/18.%E5%AE%B9%E5%99%A8%E5%8C%96/0.%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%9F%BA%E7%A1%80/</id>
    <published>2021-10-28T06:08:23.000Z</published>
    <updated>2021-11-08T08:31:04.505Z</updated>
    
    <content type="html"><![CDATA[<h1>æ·±å…¥å‰–æKubernetesä¹‹å®¹å™¨åŒ–çš„åŸºç¡€</h1><h2 id="å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†"><a class="header-anchor" href="#å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†"></a>å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†</h2><p><B>å®¹å™¨åŒ–çš„åŸºç¡€</B>æ˜¯ä¾èµ–äºLinuxåº•å±‚æä¾›çš„ä¸¤ç§èƒ½åŠ›åˆ†åˆ«æ˜¯<B>cgroups</B>,<B>Namespace</B></p><h3 id="cgroups"><a class="header-anchor" href="#cgroups"></a>cgroups</h3><blockquote><p>cgroups çš„å…¨ç§°æ˜¯control groups,æ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§å¯ä»¥é™åˆ¶å•ä¸ªè¿›ç¨‹æˆ–è€…å¤šä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨èµ„æºçš„æœºåˆ¶<br>cgroupså¯ä»¥ç®¡ç†çš„èµ„æºæœ‰:</p></blockquote><ul><li><B>cpuå­ç³»ç»Ÿ</B><br>ä¸»è¦é™åˆ¶è¿›ç¨‹çš„cpuä½¿ç”¨ç‡</li><li><B>cpuacctå­ç³»ç»Ÿ</B><br>å¯ä»¥ç»Ÿè®¡cgroupsä¸­çš„è¿›ç¨‹çš„cpuä½¿ç”¨æŠ¥å‘Š</li><li><B>cpuset å­ç³»ç»Ÿ</B><br>å¯ä»¥ä¸ºcgroupsä¸­çš„è¿›ç¨‹åˆ†é…å•ç‹¬çš„cpuèŠ‚ç‚¹æˆ–è€…å†…å­˜èŠ‚ç‚¹</li><li><B>memoryå­ç³»ç»Ÿ</B><br>å¯ä»¥é™åˆ¶è¿›ç¨‹çš„ </B><br>å¯ä»¥é™åˆ¶è¿›ç¨‹çš„å—è®¾å¤‡ io</li><li><B>deviceså­ç³»ç»Ÿ</B><br>å¯ä»¥æ§åˆ¶è¿›ç¨‹èƒ½å¤Ÿè®¿é—®æŸäº›è®¾å¤‡</li><li><B>net_clså­ç³»ç»Ÿ</B><br>å¯ä»¥æ ‡è®°cgroupsä¸­è¿›ç¨‹çš„ç½‘ç»œæ•°æ®åŒ…ï¼Œç„¶åå¯ä»¥ä½¿ç”¨tcæ¨¡å—(traffic control)å¯¹æ•°æ®åŒ…è¿›è¡Œæ§åˆ¶</li><li><B>freezerå­ç³»ç»Ÿ</B><br>å¯ä»¥æŒ‚èµ·æˆ–è€…æ¢å¤cgroupsä¸­çš„è¿›ç¨‹</li><li><B>nså­ç³»ç»Ÿ</B><br>å¯ä»¥ä½¿ä¸åŒcgroupsä¸‹é¢çš„è¿›ç¨‹ä½¿ç”¨ä¸åŒçš„namespace</li></ul><p><B>cgroups</B>æ˜¯é€šè¿‡ä¸å†…æ ¸çš„å…¶ä»–æ¨¡å—æ¥å®Œæˆ<B>è¿›ç¨‹ç»´åº¦</B>å¯¹<B>èµ„æº</B>çš„ç®¡ç†</p><h3 id="Namespace"><a class="header-anchor" href="#Namespace"></a>Namespace</h3><p><B>namespace</B>æ˜¯å¯¹å†…æ ¸èµ„æºè¿›è¡Œåˆ†ç»„ç®¡ç†çš„ä¸€ä¸ªç‰¹æ€§,ç”¨æ¥ä¿®æ”¹è¿›ç¨‹é—´çš„å¯è§æ€§</p><p>namespaceåˆ›å»ºè¿›ç¨‹æ—¶ä¼šä½¿ç”¨<B>CLONE_NEWPID</B>è¿™ä¸ªå‚æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ç©ºé—´</p><h3 id="è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«"><a class="header-anchor" href="#è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«"></a>è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«</h3><p>è™šæ‹Ÿæœºä¸Dockerçš„åŒºåˆ«åœ¨äºè™šæ‹Ÿæœºä¼šé‡‡ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ–åŠŸèƒ½,æ¨¡æ‹Ÿå‡ºæ“ä½œç³»ç»Ÿåº•å±‚çš„è®¾å¤‡;dockeråªæ˜¯åœ¨å®¿ä¸»æœºä¸Šåšäº†è¿›ç¨‹éš”ç¦»å’Œèµ„æºéš”ç¦»</p><h2 id="å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹éš”ç¦»å’Œé™åˆ¶"><a class="header-anchor" href="#å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹éš”ç¦»å’Œé™åˆ¶"></a>å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹éš”ç¦»å’Œé™åˆ¶</h2><p><img src="https://i.loli.net/2021/10/28/HNTkSg5vwd7jymf.jpg" alt="å®¹å™¨åŒ–ä¸è™šæ‹Ÿæœºä¹‹é—´çš„å¯¹æ¯”"></p><p>é€šè¿‡<B>namespace</B>æ¥å®Œæˆè¿›ç¨‹ä¹‹é—´çš„éš”ç¦»,é€šè¿‡<B>cgroups</B>æ¥å®Œæˆå¯¹èµ„æºçš„é™åˆ¶</p><p><B>cgroups</B>æ˜¯é€šè¿‡é…ç½®åœ¨<B>/sys/fs/cgroup</B>æ–‡ä»¶å¤¹ä¸‹ä¼šæœ‰</p><ul><li><p>èµ„æºåˆ†ç»„<br><img src="https://i.loli.net/2021/10/28/gUHWXSlaGd7Lpn8.jpg" alt="cgroupèµ„æºåˆ†ç»„"><br>è¿™äº›é™åˆ¶é¡¹æ¥è¿›è¡Œå¤„ç†</p></li><li><p>æ§åˆ¶ç»„<br><img src="https://i.loli.net/2021/10/28/PFv8caUqsLiYBpo.jpg" alt="cgroupè¯¦ç»†æ§åˆ¶"></p></li></ul><p>é€šè¿‡è¯¦ç»†ä¿¡æ¯å¯ä»¥çœ‹åˆ°è¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸åŒçš„é…ç½®æ–‡ä»¶<B>cgroup.procs</B>,å†…å®¹å¦‚ä¸‹å±•ç¤º</p><p><img src="https://z3.ax1x.com/2021/10/29/5jdCIx.jpg" alt="cgroup.procså†…å®¹"><br>å¯ä»¥çœ‹åˆ°è¿™é‡Œè®°å½•çš„å°±æ˜¯pidåˆ—è¡¨,<cgroup>å°±æ˜¯é€šè¿‡ç®¡ç†ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…èµ„æºçš„æ‰§è¡Œæ—¶é—´æ¥æ§åˆ¶ä¸åŒè¿›ç¨‹çš„èµ„æºä½¿ç”¨æƒ…å†µ</p><p>dockerå°±æ˜¯åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™ä¸ºæ¯ä¸€ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„,åœ¨å°†ç”¨æˆ·æŒ‡å®šçš„dockerå®¹å™¨åˆå§‹åŒ–èµ„æºé…ç½®å†™å…¥æ§åˆ¶ç»„ä¸­å°±å¯ä»¥äº†<br><B>cgroups</B>é‡‡ç”¨çš„èµ„æºé™åˆ¶æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡æ§åˆ¶æ—¶é—´çš„å½¢å¼æ¥å®ç°çš„,å› æ­¤å°±ä¼šå­˜åœ¨å®¹å™¨çš„è¿›ç¨‹å®é™…ä¸Šå¯ä»¥çœ‹åˆ°æ•´ä¸ªå®¿ä¸»æœºçš„ä¸€äº›çŠ¶æ€.è¿™æ˜¯ç›¸è¾ƒä¸è™šæ‹Ÿæœºæ–¹å¼çš„ä¸è¶³</p><blockquote><p><B>å®¹å™¨çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¿›ç¨‹</B></p></blockquote><h2 id="å®¹å™¨ä¸­é•œåƒçš„æ¦‚å¿µ"><a class="header-anchor" href="#å®¹å™¨ä¸­é•œåƒçš„æ¦‚å¿µ"></a>å®¹å™¨ä¸­é•œåƒçš„æ¦‚å¿µ</h2><blockquote><p>é•œåƒæŒ‡çš„æ˜¯ä¸€ä¸ªç”±å®¹å™¨è¯†åˆ«çš„åªè¯»æ¨¡æ¿.é€šå¸¸è¿™ä¸ªæ¨¡æ¿æ˜¯åŸºäºå¦å¤–çš„ä¸€ä¸ªæ¨¡æ¿å¹¶è¿›è¡Œä¸€äº›è‡ªå®šä¹‰æ”¹åŠ¨çš„</p></blockquote><p>ä»¥ä¸Šæ˜¯dockerå®˜ç½‘ä¸­å¯¹é•œåƒæ¦‚å¿µçš„æè¿°,é•œåƒåœ¨ç‰©ç†ä¸ŠæŒ‡çš„æ˜¯å®¹å™¨è¿›ç¨‹å®é™…å¯ç”¨çš„æ–‡ä»¶<br>é€šè¿‡<B>Namespace</B>å’Œ<B>cgroups</B>å®ç°äº†å¯¹è¿›ç¨‹å’Œæ“ä½œæ—¶é—´çš„éš”ç¦»,ä½†æ˜¯å®¹å™¨ä¹‹é—´æ²¡æœ‰å¯¹æ–‡ä»¶çš„éš”ç¦»,å®¹å™¨è¿›ç¨‹çš„å¯ç”¨æ–‡ä»¶ä¸å…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„å¯ç”¨æ–‡ä»¶ç›¸åŒ.<br>å› æ­¤éœ€è¦å¯¹å®¹å™¨çš„å¯ç”¨æ–‡ä»¶è¿›è¡Œé™åˆ¶,åœ¨dockerä¸Šæ˜¯ä¼˜å…ˆä½¿ç”¨<B>pivot_root</B>,å…¶æ¬¡ä½¿ç”¨<B>chroot</B></p><h3 id="pivot-rootä¸chrootçš„åŒºåˆ«"><a class="header-anchor" href="#pivot-rootä¸chrootçš„åŒºåˆ«"></a>pivot_rootä¸chrootçš„åŒºåˆ«</h3><ul><li><p>pivot_rootæ”¹å˜å½“å‰mount namespaceçš„rootfs(&quot;/&quot;ç›®å½•)</p></li><li><p>chrootæ”¹å˜çš„æ˜¯å½“å‰è¿›ç¨‹çš„rootfs(&quot;/&quot;ç›®å½•)</p></li></ul><p>pivot_rootçš„æ‰§è¡Œæ­¥éª¤åˆ†ä¸ºä¸‰æ­¥:</p><ol><li>åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å°†å½“å‰æ‰€æœ‰çš„root mountç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•</li><li>åˆ›å»ºæ–°ç›®å½•(â€œ/â€)</li><li>æ¸…ç†æ–°ç›®å½•</li></ol><h3 id="rootfs"><a class="header-anchor" href="#rootfs"></a>rootfs</h3><p><B>rootfs</B>æŒ‡çš„æ˜¯å°±æ˜¯é•œåƒä¸­çš„æ–‡ä»¶,ä¹Ÿå°±æ˜¯ç™»å½•åˆ°å…·ä½“çš„é•œåƒä¸­çœ‹åˆ°çš„æ–‡ä»¶.<B>rootfs</B>åœ¨ç»“æ„ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰å±‚<B>å¯è¯»å†™å±‚</B>ã€<br><B>initå±‚</B>ã€<B>åªè¯»å±‚</B></p><p>ä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯åº”ç”¨å±‚åˆ°ç³»ç»Ÿå±‚çš„åˆ’åˆ†,åœ¨è¯¦ç»†çš„å¯¹è¿™ä¸‰å±‚è¿›è¡Œåˆ†æä¹‹å‰éœ€è¦äº†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆé•œåƒæ–‡ä»¶ä¸­åˆ†å±‚çš„æ–‡ä»¶åœ¨ä½¿ç”¨çš„æ—¶å€™å¯ä»¥æƒ³åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ä¸€æ ·ï¼Ÿ<br>è¿™æ˜¯é‡‡ç”¨äº†ä¸€ç§è¢«ç§°ä¸ºè”åˆæ–‡ä»¶ç³»ç»Ÿ(union file System)æ¦‚å¿µ,dockerä¸­é»˜è®¤æ˜¯ä½¿ç”¨Overlay2çš„å®ç°ï¼Œå…³äºè”åˆæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ç« çœ‹å¯ä»¥å‚è€ƒ<br><a href="https://lwn.net/Articles/324291/">https://lwn.net/Articles/324291/</a></p><ul><li><p>å¯è¯»å†™å±‚<br>å¯è¯»å†™å±‚æ˜¯rootfsä¸­æœ€ä¸Šé¢çš„ä¸€å±‚ï¼Œæ˜¯æ‰¿è½½å®¹å™¨ä¸­æ–‡ä»¶è¯»å†™çš„æ“ä½œä¸€å±‚,åœ¨è¿™ä¸€å±‚ä¸­çš„æŒ‚è½½æ–¹å¼æ˜¯read + write</p></li><li><p>initå±‚<br>initå±‚æŒ‡çš„æ˜¯Dockeré¡¹ç›®ç”¨æ¥å­˜æ”¾å¯¹åº•å±‚æ“ä½œç³»ç»Ÿçš„æ”¹åŠ¨ä¿¡æ¯ä¾‹å¦‚â€™etc/hostsâ€™ã€â€˜etc/resolv.confâ€™ç­‰ï¼Œå› ä¸ºå®¹å™¨åœ¨å¯åŠ¨æ—¶å¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚initå±‚åœ¨æŒ‚è½½æ—¶æ˜¯é‡‡ç”¨â€™roâ€™ + 'whâ€™çš„æ–¹å¼ï¼Œ'roâ€™æŒ‡çš„æ˜¯read onley,'whâ€™æŒ‡çš„æ˜¯whiteout,å³åªè¯» + â€˜whiteoutâ€™,whiteoutæŒ‡çš„æ˜¯å¯¹æ–‡ä»¶çš„æ“ä½œä¼šåœ¨é€šè¿‡ä¸€å®šçš„æ‰‹æ®µè¿›è¡Œéšè—ï¼Œç±»ä¼¼ä¸javaä¸­çš„ä¸´æ—¶å˜é‡çš„æ¦‚å¿µï¼Œåªåœ¨å½“å‰å®¹å™¨ä¸­æœ‰æ•ˆï¼Œä¸ä¼šçœŸæ­£çš„ä¿®æ”¹åº•å±‚çš„æ–‡ä»¶</p></li><li><p>åªè¯»å±‚<br>åªè¯»å±‚æŒ‡çš„æ˜¯é•œåƒä¸­æœ€åº•å±‚çš„ç³»ç»Ÿé•œåƒå±‚ï¼Œå®ƒä»¬çš„æŒ‚è½½æ–¹å¼ä¹Ÿæ˜¯â€™roâ€™ + â€˜whâ€™</p></li></ul><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><p>dockerä¸­çš„é•œåƒé€šè¿‡è¿™ç§åˆ†å±‚æ„å»ºçš„æ–¹å¼å¤§å¤§çš„å‡å°‘äº†ä¼ ç»Ÿé•œåƒä¸­æ“ä½œç³»ç»Ÿçš„å¤§å°ï¼ŒåªåŒ…å«äº†å¯è¯»å†™å±‚ä¸­åº”ç”¨çš„éƒ¨åˆ†ã€‚åº•å±‚æ”¯æŒè¿™ç§æ„å»ºæ–¹å¼ä¸»è¦æ˜¯ä¾èµ–<B>chroot</B>(åˆ‡æ¢æ ¹ç›®å½•çš„èƒ½åŠ›)å’Œ<B>union file System</B>(è”åˆæ–‡ä»¶ç³»ç»Ÿ)</p><h2 id="æ€»ç»“-v2"><a class="header-anchor" href="#æ€»ç»“-v2"></a>æ€»ç»“</h2><p>dockerå®¹å™¨åŒ–çš„åŸºç¡€æ˜¯ä¸‰ä¸ªéƒ¨åˆ†</p><ul><li>Namespaceæä¾›çš„è¿›ç¨‹éš”ç¦»èƒ½åŠ›</li><li>Cgroupæä¾›çš„èµ„æºé™åˆ¶èƒ½åŠ›</li><li>rootfsçš„æ–‡ä»¶åˆ†å±‚ç»“æ„è®¾è®¡</li></ul><p><B>clone(true)/cgroup file/union file System</B></p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://tech.meituan.com/2015/03/31/cgroups.html">Linuxèµ„æºç®¡ç†ä¹‹cgroupsç®€ä»‹</a><br><a href="https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/">ä»€ä¹ˆæ˜¯å‘½åç©ºé—´å’Œcgroup,ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;æ·±å…¥å‰–æKubernetesä¹‹å®¹å™¨åŒ–çš„åŸºç¡€&lt;/h1&gt;
&lt;h2 id=&quot;å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†&quot;&gt;&lt;/a&gt;å®¹å™¨åŒ–çš„åŸºç¡€ä¹‹è¿›ç¨‹ç®¡ç†&lt;/h2&gt;
&lt;p&gt;&lt;B&gt;å®¹å™¨åŒ–çš„åŸºç¡€&lt;/B&gt;æ˜¯ä¾èµ–äºLi</summary>
      
    
    
    
    <category term="å®¹å™¨åŒ–" scheme="https://agmtopy.gitee.io/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
    
    <category term="docker" scheme="https://agmtopy.gitee.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>rocketmqç´¢å¼•å®ç°åŸç†ä¹‹IndexService</title>
    <link href="https://agmtopy.gitee.io/2021/10/13/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/15.rocketmq%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BIndexService/"/>
    <id>https://agmtopy.gitee.io/2021/10/13/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/15.rocketmq%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BIndexService/</id>
    <published>2021-10-12T16:23:46.000Z</published>
    <updated>2021-11-06T08:04:22.885Z</updated>
    
    <content type="html"><![CDATA[<h1>rocketmqç´¢å¼•å®ç°åŸç†ä¹‹IndexService</h1><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­åˆ†æäº†æ¶ˆæ¯æ˜¯å¦‚æœé€šè¿‡Commitlogçš„é€»è¾‘è®¾è®¡åˆ°MappedFileçš„ä¸æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº¤ä»˜çš„è¿‡ç¨‹ï¼Œè¿™ç¯‡æ–‡ç« æ¥åˆ†ææ¶ˆæ¯ä½“æ˜¯å¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾çš„ä»¥åŠåº•å±‚å®ç°<br>RocketMQçš„ç´¢å¼•ç›¸å…³çš„å·¥ä½œéƒ½æ˜¯ç”±StoreåŒ…ä¸‹çš„<B>IndexService</B>å®ç°çš„,<B>IndexService</B>æ“ä½œçš„å¯¹è±¡æ˜¯<B>IndexFile</B>,ä¸‹é¢ä¸»è¦æ¥åˆ†æIndexFileçš„<B>åˆ›å»º</B>ã€<B>åŠ è½½</B>ã€<B>æ’å…¥</B>ã€<B>å†…å®¹</B>è¿‡ç¨‹ã€‚</p><h2 id="IndexFileæ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹</h2><p>åˆ›å»ºIndexç´¢å¼•æ–‡ä»¶çš„è¿‡ç¨‹çš„è§¦å‘ç‚¹æ˜¯åœ¨<B>load()</B>æ–¹æ³•ä¸­è¿›è¡Œè§¦å‘çš„,ä¸»è¦æ˜¯é€šè¿‡<B>IndexService.retryGetAndCreateIndexFile()</B>æ–¹æ³•æ‰§è¡Œçš„</p><ul><li>IndexService.retryGetAndCreateIndexFile</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">IndexFile</span> <span class="token function">retryGetAndCreateIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">IndexFile</span> indexFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">//1. é‡å¤å°è¯•åˆ›å»ºç´¢å¼•æ–‡ä»¶</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">null</span> <span class="token operator">==</span> indexFile <span class="token operator">&amp;&amp;</span> times <span class="token operator">&lt;</span> MAX_TRY_IDX_CREATE<span class="token punctuation">;</span> times<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//2.è·å–æˆ–åˆ›å»ºindexæ–‡ä»¶</span>        indexFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAndCreateLastIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> indexFile<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//çº¿ç¨‹ä¼‘çœ 1s,é‡æ–°å°è¯•åˆ›å»ºindexFileæ–‡ä»¶</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Tried to create index file fail. times: %s ,start sleep 1s"</span><span class="token punctuation">,</span> times<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Interrupted"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> indexFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getAccessRights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeIndexFileError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Mark index file cannot build flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> indexFile<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>retryGetAndCreateIndexFile()</B>æ–¹æ³•ä¸»è¦æ˜¯å¯¹æ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹æœ‰ä¸€ä¸ªé‡è¯•çš„æœºåˆ¶æ¥å°½é‡ä¿è¯<B>indexæ–‡ä»¶</B>çš„æˆåŠŸåˆ›å»º,å…·ä½“çš„åˆ›å»ºè¿‡ç¨‹å°±æ˜¯é€šè¿‡<br><B>getAndCreateLastIndexFile()</B>æ–¹æ³•æ¥è¿›è¡Œåˆ›å»º</p><ul><li>getAndCreateLastIndexFile()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * è·å–æˆ–åˆ›å»ºindexæ–‡ä»¶ */</span><span class="token keyword">private</span> <span class="token class-name">IndexFile</span> <span class="token function">getAndCreateLastIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–æˆå‘˜å˜é‡</span>    <span class="token class-name">IndexFile</span> indexFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token class-name">IndexFile</span> prevIndexFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> lastUpdateEndPhyOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> lastUpdateIndexTimestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//ä½¿ç”¨ä»£ç å—?</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//æ‰§è¡Œè¯»é”</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¦‚æœindexFileListä¸ä¸ºç©º</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è·å–æœ€åä¸€ä¸ªindexFile</span>            <span class="token class-name">IndexFile</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åˆ¤æ–­å½“å‰indexFileæ–‡ä»¶æ˜¯å¦å†™å…¥æ»¡é¢</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">.</span><span class="token function">isWriteFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å¦‚æœå†™å…¥æ»¡é¢çš„æ³•ç›´æ¥ä½¿ç”¨indexFile</span>                indexFile <span class="token operator">=</span> tmp<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//å¦‚æœå†™å…¥æ»¡é¢å°±ä¼šæŸ¥è¯¢è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€æ¬¡å†™å…¥çš„offset</span>                lastUpdateEndPhyOffset <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getEndPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//æŸ¥è¯¢æœ€åä¸€æ¬¡æ›´æ–°çš„æ—¶é—´æˆ³</span>                lastUpdateIndexTimestamp <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//æ ‡è®°å½“å‰æ–‡ä»¶ä¸ºä¸Šä¸€ä¸ªä½¿ç”¨çš„ç´¢å¼•æ–‡ä»¶</span>                prevIndexFile <span class="token operator">=</span> tmp<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//é‡Šæ”¾é”æ“ä½œ</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//indexFileæ–‡ä»¶æ²¡æœ‰è·å–æˆåŠŸæ—¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è®¡ç®—index fileName æ ¼å¼ä¸ºyyyyMMddHHmmssSSS</span>            <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeIndexPath <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">timeMillisToHumanString</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ–°å»ºindexFileæ–‡ä»¶</span>            indexFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> lastUpdateEndPhyOffset<span class="token punctuation">,</span> lastUpdateIndexTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å ç”¨å†™é”</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"getLastIndexFile exception "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//é‡Šæ”¾å†™é”</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å¯¹ä¸Šä¸€ä¸ªindexæ–‡ä»¶è¿›è¡Œåˆ·ç›˜æ“ä½œ</span>            <span class="token keyword">final</span> <span class="token class-name">IndexFile</span> flushThisFile <span class="token operator">=</span> prevIndexFile<span class="token punctuation">;</span>            <span class="token class-name">Thread</span> flushThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushThisFile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"FlushIndexFileThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            flushThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            flushThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> indexFile<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>getAndCreateLastIndexFile()</B>æ–¹æ³•ä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤</p><ul><li>æŸ¥è¯¢å¯ä»¥ä½¿ç”¨çš„indexFileæ–‡ä»¶</li><li>å¦‚æœæ²¡æœ‰indexæ–‡ä»¶å°±æ–°å»ºä¸€ä¸ªindexFileæ–‡ä»¶</li><li>å°è¯•å°†å·²ç»æ»¡é¢çš„indexFileæ–‡ä»¶åˆ·ç›˜</li></ul><h2 id="IndexFileæ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹</h2><p><B>IndexService</B>çš„åŠ è½½è¿‡ç¨‹æ˜¯ç”±<B>load()</B>æ–¹æ³•å®ç°çš„,è¿™ä¸ªæ–¹æ³•çš„è¢«è°ƒç”¨é“¾æ˜¯ç”±<br><B>BrokerController</B> -&gt; <B>DefaultMessageStore</B> -&gt; <B>IndexService</B></p><p><img src="https://i.loli.net/2021/10/17/KA9awWtHXcfGjRL.jpg" alt="IndexServiceè¢«è°ƒç”¨é“¾"><br><B>load()</B>æ„é€ æ–¹æ³•ä¸»è¦æ˜¯å¯¹åŸæœ‰çš„indexæ–‡ä»¶åˆ†æç„¶åç”ŸæˆIndexFileå¯¹è±¡çš„è¿‡ç¨‹</p><ul><li>load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1.æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨</span>    <span class="token class-name">File</span> dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeIndexPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//2.æŒ‰ç…§æ–‡ä»¶åç§°è¿›è¡Œå‡åº</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//3.æ ¹æ®indexæ–‡ä»¶åˆå§‹åŒ–indexFileå¯¹è±¡</span>                <span class="token class-name">IndexFile</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//3.åˆå§‹åŒ–indexFileå¯¹è±¡çš„å¤´æ–‡ä»¶ä¿¡æ¯</span>                f<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//4.åˆ¤æ–­ä¸Šæ¬¡æ˜¯å¦æ­£å¸¸é€€å‡ºï¼Œæœªæ­£å¸¸é€€å‡ºå¹¶ä¸”æ–‡ä»¶è®°å½•åœ¨æ—¥å¿—ä¿å­˜ç‚¹ä¹‹åçš„è¿›è¡Œèˆå¼ƒ</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastExitOK <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexMsgTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">//4.1 èˆå¼ƒæœªåˆ°ä¿å­˜ç‚¹çš„æ•°æ®</span>                    f<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load index file OK, "</span> <span class="token operator">+</span> f<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//5.å°†æ–‡ä»¶è£…è½½åˆ°indexFileListä¸­</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e <span class="token operator">|</span> <span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//çœç•¥...</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç å°±æ˜¯å¯¹ä¹‹å‰çš„indexFileæ–‡ä»¶è¿›è¡ŒåŠ è½½ï¼Œå¹¶ä¸”å¯¹åœ¨æ—¥å¿—ä¿å­˜ç‚¹ä¹‹åçš„æ•°æ®è¿›è¡ŒæŠ›å¼ƒã€‚</p><ul><li>IndexFile()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> indexNum<span class="token punctuation">,</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> endPhyOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> endTimestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è®¡ç®—indexæ–‡ä»¶å¤§å° = å¤´ä¿¡æ¯é•¿åº¦ + å“ˆå¸Œslotæ•°é‡*å“ˆå¸Œsloté•¿åº¦ + indexæ•°é‡*indexé•¿åº¦</span>    <span class="token keyword">int</span> fileTotalSize <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span>INDEX_HEADER_SIZE <span class="token operator">+</span> <span class="token punctuation">(</span>hashSlotNum <span class="token operator">*</span> hashSlotSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>indexNum <span class="token operator">*</span> indexSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºmappedFileå¯¹è±¡</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileTotalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¯¹å±æ€§è¿›è¡Œèµ‹å€¼</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getFileChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getMappedByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum <span class="token operator">=</span> hashSlotNum<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum <span class="token operator">=</span> indexNum<span class="token punctuation">;</span>    <span class="token comment">//å¤„ç†æ–‡ä»¶å¤´ä¿¡æ¯</span>    <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆå§‹åŒ–'ç©ºé—´ä½ç½®'å’Œ'æ—¶é—´ä½ç½®'</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>endPhyOffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>endTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>IndexFile()</B>æ–¹æ³•ä¼šæ ¹æ®æ–‡ä»¶åç§°åˆ›å»ºä¸€ä¸ªindexæ–‡ä»¶å¯¹è±¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ä¼šæ ¹æ®é…ç½®æ–‡ä»¶<B>è§£æ</B>ã€<B>åˆ›å»º</B>å¤´æ–‡ä»¶ä¿¡æ¯å¯¹è±¡<B>IndexHeader</B>è€Œä¸”è¿˜æ˜¯æ˜¯é€šè¿‡<B>MappedFile</B>å¯¹è±¡è¿›è¡Œå¤„ç†çš„</p><h2 id="IndexFileæ–‡ä»¶çš„æ’å…¥è¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„æ’å…¥è¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„æ’å…¥è¿‡ç¨‹</h2><p>IndexServiceå¯¹å¤–æä¾›æ’å…¥ç´¢å¼•çš„æ–¹æ³•æ˜¯<B>buildIndex</B>,buildIndex()æ˜¯é€šè¿‡<B>DefaultMessageStore</B>çš„<B>ReputMessageService</B>æ¥è¿›è¡Œè§¦å‘çš„</p><ul><li>ReputMessageService</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ReputMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceThread</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//çœŸæ­£å¯åŠ¨ç´¢å¼•ä»»åŠ¡å…¥å£</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//1.åˆ¤æ–­ç´¢å¼•çš„offsetæ˜¯å¦å°äºcommitLogä¸­æœ€å°çš„offset</span>        <span class="token comment">//2.åªå¤„ç†éœ€è¦è¿›è¡Œç´¢å¼•æ“ä½œçš„æ¶ˆæ¯</span>        <span class="token comment">//3.æ ¹æ®æ¶ˆæ¯ç»„è£…æ¶ˆæ¯åç½®å¤„ç†å™¨</span>        <span class="token comment">//4/5ã€‚å¤„ç†ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„å·®å¼‚</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doReput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨<B>ReputMessageService</B>å¯ä»¥çœ‹åˆ°æ˜¯ä½¿ç”¨ä¸€ä¸ªå¾ªç¯æ¯éš”1så»æŸ¥è¯¢ä¸€æ¬¡commitLogæ–‡ä»¶ä¸­éœ€è¦è¿›è¡Œåç½®å¤„ç†çš„æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†</p><h2 id="IndexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹"></a>IndexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹</h2><p>å‰é¢ä»‹ç»äº†å¯¹indexFileæ–‡ä»¶çš„åˆ›å»ºã€åŠ è½½ã€å†™å…¥çš„è¿‡ç¨‹ï¼Œæ¥ä¸‹ä»‹ç»ä¸€ä¸‹indexFileæ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹</p><ul><li>è°ƒç”¨æµç¨‹</li></ul><pre class="line-numbers language-none"><code class="language-none">NettyRemotingServer -&gt; NettyRemotingAbstract -&gt; QueryMessageProcessor -&gt; DefaultMessageStore -&gt; IndexService -&gt; IndexFile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»¥ä¸Šæ˜¯è°ƒç”¨ç´¢å¼•æ–‡ä»¶çš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œä»Nettyçš„æœåŠ¡ç«¯åˆ°IndexFileæ–‡ä»¶çš„æ•´ä½“æµç¨‹ï¼Œå…·ä½“çš„æ‰§è¡Œæ–¹æ³•æ˜¯IndexFileæ–‡ä»¶ä¸­çš„selectPhyOffset()</p><ul><li>selectPhyOffset</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è®¡ç®—å‡ºindexFileæ–‡ä»¶ä¸­æ•°æ®çš„å…·ä½“ç‰©ç†ä½ç½®</span><span class="token keyword">int</span> keyHash <span class="token operator">=</span> <span class="token function">indexKeyHashMethod</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> slotPos <span class="token operator">=</span> keyHash <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">;</span><span class="token keyword">int</span> absSlotPos <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span>INDEX_HEADER_SIZE <span class="token operator">+</span> slotPos <span class="token operator">*</span> hashSlotSize<span class="token punctuation">;</span><span class="token comment">//æ ¹æ®å…·ä½“çš„ä½ç½®è¿›è¡Œå–æ•°æ“ä½œ</span><span class="token keyword">int</span> keyHashRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> phyOffsetRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> timeDiff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> prevIndexRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="IndexFileæ–‡ä»¶çš„å†…å®¹"><a class="header-anchor" href="#IndexFileæ–‡ä»¶çš„å†…å®¹"></a>IndexFileæ–‡ä»¶çš„å†…å®¹</h2><p>ç´¢å¼•æ–‡ä»¶æ˜¯æ”¾ç½®åœ¨<B>${rootpath}/index</B>ç›®å½•ä¸‹çš„ï¼Œæ–‡ä»¶åç§°æŒ‰ç…§yyyyMMddhhmmsssssçš„å½¢å¼è¿›è¡Œç”Ÿæˆï¼Œé»˜è®¤å¤§å°ä¸º400MB,ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ</p><ul><li>header</li><li>slot table</li><li>index linked list</li></ul><p>ç»“æ„å¦‚ä¸‹æ‰€ç¤º:</p><pre class="line-numbers language-none"><code class="language-none">|&lt;-- 40 byte --&gt;|&lt;---   500w   ---&gt;|&lt;---   2000w   ---&gt;|+---------------+------------------+-------------------+|    header     |   slot table     | index linked list |+---------------+------------------+-------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¦ç»†çš„æ•°æ®ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><h3 id="B-headerç»“æ„-B"><a class="header-anchor" href="#B-headerç»“æ„-B"></a><B>headerç»“æ„</B></h3><pre class="line-numbers language-none"><code class="language-none">+---------------------+--0| beginTimestampIndex |             ----&gt; ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä¿å­˜æ—¶é—´+---------------------+--8| endTimestampIndex   |             ----&gt; æœ€åä¸€æ¡æ¶ˆæ¯çš„ä¿å­˜æ—¶é—´+---------------------+--16| beginPhyoffsetIndex |             ----&gt; ç¬¬ä¸€æ¡æ¶ˆæ¯çš„åœ¨commitlogä¸­çš„åç§»é‡+---------------------+--24| endPhyoffsetIndex   |             ----&gt; æœ€åä¸€æ¡æ¶ˆæ¯çš„åœ¨commitlogä¸­çš„åç§»é‡+---------------------+--32| hashSlotcountIndex  |             ----&gt; å“ˆå¸Œæ§½æ•°é‡ï¼Œä¿å­˜æ·»åŠ åˆ°æœ¬æ§½åˆ—è¡¨çš„æœ€æ–°ç´¢å¼•ä½ç½®+---------------------+--36| indexCountIndex     |             ----&gt; ç´¢å¼•æ•°é‡ï¼Œå…·ä½“ç´¢å¼•æ•°æ®+---------------------+--40<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®ä»£ç å¯ä»¥å‚è€ƒ<B>IndexHeader</B>çš„é™æ€æˆå‘˜å˜é‡,ä»¥ä¸‹æ˜¯å±•ç¤ºç”¨ä¾‹</p><ul><li>IndexHeader</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INDEX_HEADER_SIZE <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> beginTimestampIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> endTimestampIndex <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> beginPhyoffsetIndex <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> endPhyoffsetIndex <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> hashSlotcountIndex <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> indexCountIndex <span class="token operator">=</span> <span class="token number">36</span><span class="token punctuation">;</span>    <span class="token comment">//æ’å…¥indexFileæ–‡ä»¶çš„å¼€å§‹æ—¶é—´</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeginTimestamp</span><span class="token punctuation">(</span><span class="token keyword">long</span> beginTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æœ¬åœ°ç¼“å­˜</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>beginTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æŒ‡å®šä½ç½®æ’å…¥æ—¶é—´æˆ³,beginTimestampIndexé»˜è®¤ä¸º0</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>beginTimestampIndex<span class="token punctuation">,</span> beginTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåˆå§‹åŒ–çš„é™æ€å˜é‡ä¼šåœ¨æ’å…¥å…·ä½“çš„å¤´æ–‡ä»¶å€¼æ—¶è¿›è¡Œä½¿ç”¨,å¯ä»¥å‚è€ƒ<B>setBeginTimestamp</B>æ–¹æ³•;<br>é€šè¿‡vscodeçš„hexdumpæ’ä»¶å¯ä»¥çœ‹åˆ°indexFileæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹</p><p><img src="https://i.loli.net/2021/11/04/jXilUC1O9em3v4P.jpg" alt="indexFileåŸå§‹æ–‡ä»¶"></p><p>å¯ä»¥çœ‹åˆ°å‰8ä¸ªå­—èŠ‚ä¸º<B>00 00 01 7C E9 D4 AA A5</B>,é€šè¿‡è®¡ç®—å™¨è½¬æ¢ä¸ºåè¿›åˆ¶ä¸º<B>1636010601125</B></p><p><img src="https://i.loli.net/2021/11/04/UHYsJqGEyrotCxP.jpg" alt="æ—¶é—´æˆ³"></p><p>æ—¶é—´æˆ³åœ¨è¿›è¡Œä¸€æ¬¡è½¬æ¢å¯ä»¥çœ‹åˆ°ä¸º<br><img src="https://i.loli.net/2021/11/04/UQqBHVZ4vliWNIs.jpg" alt="å¼€å§‹æ—¶é—´"></p><p>å‰©ä¸‹çš„endTimestampIndexã€beginPhyoffsetIndexã€beginPhyoffsetIndexã€endPhyoffsetIndexã€hashSlotcountIndexã€indexCountIndexä¿¡æ¯çš„å¤„ç†æ–¹å¼ä¸è¿™ä¸ªç±»ä¼¼ï¼Œä¸è¿›è¡Œé‡å¤äº†</p><h3 id="B-slot-tableç»“æ„-B"><a class="header-anchor" href="#B-slot-tableç»“æ„-B"></a><B>slot tableç»“æ„</B></h3><p><B>slot tableç»“æ„</B>æ˜¯å¯¹</p><h3 id="B-index-linked-listç»“æ„-B"><a class="header-anchor" href="#B-index-linked-listç»“æ„-B"></a><B>index linked listç»“æ„</B></h3><p><B>index linked list</B>çš„ç»“æ„æ˜¯åœ¨indexFileä¸Šçš„hashç´¢å¼•ä¹‹åç”¨å­˜æ”¾å®é™…çš„offsetçš„å€¼</p><p>ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><pre class="line-numbers language-none"><code class="language-none">+---------------------+--0| key hash            |             ----&gt; ä¼šæ ¹æ®Topicå’Œkeyçš„å€¼æ‹¼æ¥åœ¨ä¸€èµ·è®¡ç®—çš„ä¸€ä¸ªhashå€¼+---------------------+--4| commitLogOffset     |             ----&gt; commitLog Offsetæ˜¯commitLogæ–‡ä»¶ä¸Šçš„ä½ç½®+---------------------+--12| timeDiff            |             ----&gt; timeDiffæ˜¯å†™å…¥æ—¶çš„ç›¸å¯¹æ—¶é—´æˆ³+---------------------+--16| slotValue           |             ----&gt; slotValueè¡¨ç¤ºçš„æ˜¯è®°å½•å› ä¸ºhashå†²çªé€ æˆçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„ç›¸å¯¹ä½ç½®+---------------------+--20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1. å†™å…¥keyHash é•¿åº¦ä¸º4</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos<span class="token punctuation">,</span> keyHash<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2. å†™å…¥commitLogOffset é•¿åº¦ä¸º 8</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> commitLogOffset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3. å†™å…¥æ—¶çš„ç›¸å¯¹æ—¶é—´æˆ³ é•¿åº¦ä¸º 4</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> timeDiff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4. å†™å…¥slotValue é•¿åº¦ä¸º 4,è®°å½•å› ä¸ºhashå†²çªé€ æˆçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„ç›¸å¯¹ä½ç½®</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> slotValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//5.æ›´æ–°slotä¸Šçš„è®°å½•çš„hashæ§½ä½ä½¿ç”¨æ•°é‡</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absSlotPos<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>IndexFileæ–‡ä»¶æœ€ç²¾åçš„è®¾è®¡åœ¨äºå¯¹ç´¢å¼•æ•°æ®çš„åˆ†ç±»ï¼Œå¹¶ä¸”æŒ‰ç…§åˆ†ç±»å°†æ•°æ®ä¾æ¬¡å†™å…¥IndexFileæ–‡ä»¶ã€‚IndexFileæ–‡ä»¶åˆ†ä¸ºheaderã€Hash soltã€offsetä¸‰ç§ç±»å‹æ•°æ®</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://zjykzk.github.io/post/cs/rocketmq/store/">http://zjykzk.github.io/post/cs/rocketmq/store/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;rocketmqç´¢å¼•å®ç°åŸç†ä¹‹IndexService&lt;/h1&gt;
&lt;p&gt;åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­åˆ†æäº†æ¶ˆæ¯æ˜¯å¦‚æœé€šè¿‡Commitlogçš„é€»è¾‘è®¾è®¡åˆ°MappedFileçš„ä¸æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº¤ä»˜çš„è¿‡ç¨‹ï¼Œè¿™ç¯‡æ–‡ç« æ¥åˆ†ææ¶ˆæ¯ä½“æ˜¯å¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾çš„ä»¥åŠåº•å±‚å®ç°&lt;br&gt;
RocketMQçš„ç´¢å¼•ç›¸å…³</summary>
      
    
    
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://agmtopy.gitee.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
    <category term="RocketMQ" scheme="https://agmtopy.gitee.io/tags/RocketMQ/"/>
    
    <category term="IndexService" scheme="https://agmtopy.gitee.io/tags/IndexService/"/>
    
  </entry>
  
  <entry>
    <title>G1GCçš„ç®—æ³•ä¸å®ç°</title>
    <link href="https://agmtopy.gitee.io/2021/09/26/12.JVM/6.G1GC%E7%9A%84%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/"/>
    <id>https://agmtopy.gitee.io/2021/09/26/12.JVM/6.G1GC%E7%9A%84%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/</id>
    <published>2021-09-26T14:48:01.000Z</published>
    <updated>2021-10-10T02:54:07.285Z</updated>
    
    <content type="html"><![CDATA[<h1>G1GCçš„ç®—æ³•ä¸å®ç°-ç®—æ³•ç¯‡</h1><p>æ ¹æ®ã€Šæ·±å…¥Javaè™šæ‹Ÿæœº-JVM G1GCçš„ç®—æ³•ä¸å®ç°ã€‹-ç®—æ³•ç¯‡æ•´ç†è€Œæ¥,è¯¥ç¯‡ä¸»è¦ç”±ä»¥ä¸‹ç« èŠ‚ç»„æˆ</p><ul><li>ç¬¬ä¸€ç«  G1GCæ˜¯ä»€ä¹ˆ?</li><li>ç¬¬äºŒç«  å¹¶å‘æ ‡è®°</li><li>ç¬¬ä¸‰ç«  è½¬ç§»</li><li>ç¬¬å››ç«  è½¯å®æ—¶æ€§</li><li>ç¬¬äº”ç«  åˆ†ä»£G1GCæ¨¡å¼</li><li>ç¬¬å…­ç«  ç®—æ³•ç¯‡æ€»ç»“</li></ul><h2 id="G1GCæ˜¯ä»€ä¹ˆ"><a class="header-anchor" href="#G1GCæ˜¯ä»€ä¹ˆ"></a>G1GCæ˜¯ä»€ä¹ˆ?</h2><blockquote><p>Garbage-First (G1) åƒåœ¾æ”¶é›†å™¨æ˜¯ä¸€ç§æœåŠ¡ç«¯çš„åƒåœ¾æ”¶é›†å™¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜å’Œå¤šå¤„ç†å™¨çš„æœºå™¨ã€‚å®ƒå°è¯•å°½é‡æ»¡è¶³ç”¨æˆ·è®¾å®šçš„åƒåœ¾æ”¶é›† (GC) æš‚åœæ—¶é—´ï¼ŒåŒæ—¶å®ç°é«˜ååé‡ã€‚GCæ“ä½œï¼ˆä¾‹å¦‚å…¨å±€æ ‡è®°ï¼‰ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚<br>è¿™æ˜¯JDKå®˜æ–¹å¯¹äºG1çš„å®šä¹‰,è¿™é‡Œä½œè€…æå‡ºä¸€ä¸ªç»“è®ºG1çš„ç‰¹ç‚¹æ˜¯éå¸¸éå¸¸çš„å…³æ³¨å®æ—¶æ€§,å¹¶ä¸”å®æ—¶æ€§åˆ†ä¸º<B>è½¯å®æ—¶æ€§</B>/<B>ç¡¬å®æ—¶æ€§</B><br>ç¡¬å®æ—¶æ€§æŒ‡çš„æ˜¯ç¡¬æ€§å¼ºåˆ¶è¦æ±‚çš„ï¼Œå¦‚æœè¾¾ä¸åˆ°æŒ‡å®šæ—¶é—´å°±ä¼šè¿”å›å¤±è´¥çš„å¤„ç†;<br>è½¯å®æ—¶æ€§æŒ‡çš„æ˜¯æŸ”æ€§çš„ï¼Œå¯¹äºè®¾å®šçš„æŒ‡å®šæ—¶é—´åªæ˜¯ä¸€ä¸ªæœŸæœ›ï¼Œä¸ä¼šåšå¼ºåˆ¶çš„è¦æ±‚é™åˆ¶;<br>é¢å¤–ä¸€ç‚¹æ˜¯<B>G1æ˜¯æ”¯æŒ4Gä»¥ä¸Šçš„å †å†…å­˜è¿›è¡Œåƒåœ¾æ”¶é›†</B></p></blockquote><h3 id="G1å‡ºç°çš„èƒŒæ™¯"><a class="header-anchor" href="#G1å‡ºç°çš„èƒŒæ™¯"></a>G1å‡ºç°çš„èƒŒæ™¯</h3><p>åœ¨G1å‡ºç°ä¹‹å‰çš„GCå¤„ç†å™¨ä¸»è¦æ˜¯é€šè¿‡å¢é‡GCæˆ–è€…æ˜¯å¹¶å‘GCæ¥æé«˜STWçš„æš‚åœæ—¶é—´ï¼Œä½†æ˜¯è¿™æ ·ç¼©çŸ­æ—¶é—´ä¼šé€ æˆååé‡ä¸‹é™ã€‚<br>G1çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³åœ¨æœŸæœ›çš„æš‚åœæ—¶é—´å‘¨å›´å°½é‡çš„å®Œæˆæ›´å¤§çš„GCååé‡ã€‚ç›®å‰GCçš„å…³æ³¨ç‚¹éƒ½æ˜¯åœ¨å°½å¯èƒ½çš„å‡å°‘æš‚åœæ—¶é—´ï¼Œè€Œä¸æ˜¯å¢å¤§ååé‡ä¸Šï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå †ä¸­çš„å¯¹è±¡å¤§å¤šå±äºæ˜¯æœç”Ÿå¤•æ­»çš„ç±»å‹</p><h3 id="G1çš„ç›®å‰çš„ç°çŠ¶"><a class="header-anchor" href="#G1çš„ç›®å‰çš„ç°çŠ¶"></a>G1çš„ç›®å‰çš„ç°çŠ¶</h3><p>G1åœ¨JDK9ä¸­å°±ä½œä¸ºé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨ï¼Œç°é˜¶æ®µG1åœ¨æœ€åä¸€æ¬¡å¢å¼ºæ˜¯åœ¨JDK14ä¸­å¢åŠ å¯¹NUMA(éç»Ÿä¸€å†…å­˜è®¿é—®)çš„å¢å¼ºã€‚åœ¨JDK14ä¸­æ–°å¢äº†ZGCæ”¶é›†å™¨ï¼Œå¹¶ä¸”é¢„è®¡å°†ZGCåœ¨æœªæ¥çš„JDKç‰ˆæœ¬ä¸­ä½œä¸ºé»˜è®¤GC</p><h2 id="G1GCçš„æ‰§è¡Œè¿‡ç¨‹"><a class="header-anchor" href="#G1GCçš„æ‰§è¡Œè¿‡ç¨‹"></a>G1GCçš„æ‰§è¡Œè¿‡ç¨‹</h2><p>æ‰€æœ‰GCåœ¨æ‰§è¡Œè¿‡ç¨‹å¯ä»¥éƒ½åˆ’åˆ†ä¸º</B>æ ‡è®°</B>å’Œ<B>æ•´ç†</B>ä¸¤ä¸ªå¤§çš„æ­¥éª¤ï¼Œä¸åŒçš„æ˜¯å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹ä¼šæœ‰å·®åˆ«</p><h3 id="G1GCçš„æ ‡è®°è¿‡ç¨‹"><a class="header-anchor" href="#G1GCçš„æ ‡è®°è¿‡ç¨‹"></a>G1GCçš„æ ‡è®°è¿‡ç¨‹</h3><p>G1GCçš„æ ‡è®°è¿‡ç¨‹æ˜¯<B>å¹¶å‘æ ‡è®°</B>,ä½†æ˜¯ç›®å‰çš„GCè¿˜åšä¸åˆ°å…¨å±€å¹¶å‘ï¼Œåªèƒ½åœ¨æŸäº›æ ‡è®°æ­¥éª¤ä¸­åšåˆ°å¹¶å‘ã€‚G1çš„æ ‡è®°è¿‡ç¨‹åˆ’åˆ†ä¸ºäº”ä¸ªæ­¥éª¤åˆ†åˆ«æ˜¯</p><ul><li>åˆå§‹æ ‡è®°é˜¶æ®µ</li><li>å¹¶å‘æ ‡è®°é˜¶æ®µ</li><li>æœ€ç»ˆæ ‡è®°é˜¶æ®µ</li><li>å­˜æ´»å¯¹è±¡è®¡æ•°é˜¶æ®µ</li><li>æ”¶å°¾å·¥ä½œ</li></ul><hr><ul><li><p>åˆå§‹åŒ–æ ‡è®°é˜¶æ®µ<br><b>åˆå§‹åŒ–æ ‡è®°é˜¶æ®µ</b>åªå¯¹<b>æ ¹å¼•ç”¨å¯¹è±¡</b>è¿›è¡Œæ ‡è®°è¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºæ ¹æ‰«æï¼Œç”±äºmutator(ç”¨æˆ·çº¿ç¨‹)ä¼šä¿®æ”¹æ ¹å¯¹è±¡å¼•ç”¨ï¼Œå› æ­¤åœ¨è€…ä¸€æ­¥æ˜¯éœ€è¦å°†mutatoræš‚åœä¸‹æ¥ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰é‡‡ç”¨è¯»/å†™å±éšœçš„æŠ€æœ¯æ¥å®ç°å¹¶å‘ä¸ªäººçŒœæµ‹æ˜¯å› ä¸ºmutatorä¼šé¢‘ç¹ä¿®æ”¹æ ¹å¯¹è±¡ï¼Œå› æ­¤åœ¨æ­¤å¤„ä¿è¯å¹¶å‘åçš„æ€§èƒ½æŸè€—è¿œè¿œå¤§äºé¡ºåºæ‰§è¡Œæ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚<br>åœ¨åˆå§‹åŒ–æ ‡è®°é˜¶æ®µåªä¼šå¯¹æ ¹å¼•ç”¨å¯¹è±¡è¿›è¡Œæ ‡è®°åˆ°ç‰¹å®šçš„å†…å­˜ä¸­ç§°ä¸º<b>æ ‡è®°ä½å›¾</b></p></li><li><p>å¹¶å‘æ ‡è®°é˜¶æ®µ<br><b>å¹¶å‘æ ‡è®°é˜¶æ®µ</b>çš„ç‰¹ç‚¹æ˜¯GCçº¿ç¨‹ä¸mutatorçº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œåœ¨mutatorçº¿ç¨‹ä¿®æ”¹æ ¹å¯¹è±¡å¼•ç”¨æ—¶ä¼šé‡‡ç”¨<b>å†™å±éšœ</b>æ¥è®°å½•å¯¹è±¡ä¹‹é—´å¼•ç”¨å…³ç³»çš„å˜åŒ–ã€‚<br>SATBæ˜¯è®°å½•å¯¹è±¡ä¹‹é—´é€»è¾‘å¼•ç”¨å…³ç³»çš„ç»“æ„ï¼Œå…¨ç§°ä¸ºSnapshot At The Beginning(åˆå§‹å¿«ç…§),åœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°å¯¹è±¡ä¼šä½œä¸ºâ€œå·²å®Œæˆæ‰«æå’Œæ ‡è®°â€çš„å¯¹è±¡ï¼Œåœ¨mutatorçº¿ç¨‹å‘ç”Ÿå¯¹æ ‡è®°å¯¹è±¡çš„ä¿®æ”¹æ—¶ï¼ŒSATBä¸“ç”¨å†™å±éšœä¹Ÿä¼šå°†è¯¥å¯¹è±¡è®°å½•åˆ°SATBé˜Ÿåˆ—ä¸­ã€‚SATBé˜Ÿåˆ—åœ¨å®ç°ä¸Šé‡‡ç”¨ä¸çº¿ç¨‹ç»‘å®šçš„å½¢å¼æ¥è¿›è¡Œï¼Œå½“é˜Ÿåˆ—è£…æ»¡æ—¶ï¼Œå°†ä¼šæ·»åŠ åˆ°å…¨å±€SATBé˜Ÿåˆ—ä¸­ã€‚</p></li></ul><p>log</p><blockquote><p>å¹¶å‘æŒ‡çš„æ˜¯æ›´å¤šçš„æŒ‡çš„æ˜¯è½¯ä»¶é¢†åŸŸçš„æ— åºæ‰§è¡Œï¼Œä¸åŒä»»åŠ¡ä¹‹é—´æ²¡æœ‰é¡ºåºå…³ç³»çš„ä¸€ç§è½¯ä»¶å¯åŠ¨æ–¹å¼</br>å¹¶è¡Œæ›´å¤šçš„æŒ‡çš„æ˜¯åœ¨ç¡¬ä»¶é¢†åŸŸä¸åŒæŒ‡ä»¤åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œçš„</p></blockquote><h2 id="å‚è€ƒæ–‡ç« "><a class="header-anchor" href="#å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://tech.meituan.com/2016/09/23/g1.html">https://tech.meituan.com/2016/09/23/g1.html</a><br><a href="https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;G1GCçš„ç®—æ³•ä¸å®ç°-ç®—æ³•ç¯‡&lt;/h1&gt;
&lt;p&gt;æ ¹æ®ã€Šæ·±å…¥Javaè™šæ‹Ÿæœº-JVM G1GCçš„ç®—æ³•ä¸å®ç°ã€‹-ç®—æ³•ç¯‡æ•´ç†è€Œæ¥,è¯¥ç¯‡ä¸»è¦ç”±ä»¥ä¸‹ç« èŠ‚ç»„æˆ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬ä¸€ç«  G1GCæ˜¯ä»€ä¹ˆ?&lt;/li&gt;
&lt;li&gt;ç¬¬äºŒç«  å¹¶å‘æ ‡è®°&lt;/li&gt;
&lt;li&gt;ç¬¬ä¸‰ç«  è½¬ç§»&lt;/li&gt;</summary>
      
    
    
    
    <category term="jvm" scheme="https://agmtopy.gitee.io/categories/jvm/"/>
    
    
    <category term="jvm" scheme="https://agmtopy.gitee.io/tags/jvm/"/>
    
    <category term="G1" scheme="https://agmtopy.gitee.io/tags/G1/"/>
    
  </entry>
  
  <entry>
    <title>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹commitlog</title>
    <link href="https://agmtopy.gitee.io/2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/13.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8Bcommitlog/"/>
    <id>https://agmtopy.gitee.io/2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/13.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8Bcommitlog/</id>
    <published>2021-09-09T15:17:09.000Z</published>
    <updated>2021-10-10T04:08:48.736Z</updated>
    
    <content type="html"><![CDATA[<h1>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹commitlog</h1><p>åœ¨ä¹‹å‰çš„ã€Šrocketmqçš„å­˜å‚¨åŸç†ã€‹æ–‡ç« ä¸­åˆ†æäº†rocketmqçš„å­˜å‚¨è¿‡ç¨‹ä¸»è¦æ˜¯é€šè¿‡ä¸¤ä¸ªç±»æ¥å®ç°çš„åˆ†åˆ«æ˜¯commitlogå’ŒMappedFileï¼Œè¿™ç¯‡æ–‡ç« é‡ç‚¹åˆ†æcommitlogè¿™ä¸ªç±»çš„å®ç°</p><h2 id="åˆå§‹åŒ–è¿‡ç¨‹"><a class="header-anchor" href="#åˆå§‹åŒ–è¿‡ç¨‹"></a>åˆå§‹åŒ–è¿‡ç¨‹</h2><p>comitlogå¯¹è±¡æ˜¯é€šè¿‡ä¸‰ä¸ªæ–¹æ³•æ¥è´Ÿè´£åˆå§‹åŒ–å¤„ç†è¿‡ç¨‹åˆ†åˆ«æ˜¯æ„é€ æ–¹æ³•<b>commitLog()</b>/åŠ è½½æ–¹æ³•<b>load()</b>/å¯åŠ¨æ–¹æ³•<b>start()</b>,è¿™é‡Œå°†commitlogçš„å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹å’Œloadè¿‡ç¨‹ä»¥åŠå¯åŠ¨-startè¿‡ç¨‹éƒ½åˆ’åˆ†ä¸ºåˆå§‹åŒ–è¿‡ç¨‹ä¸­</p><h3 id="commitLog-æ„é€ æ–¹æ³•"><a class="header-anchor" href="#commitLog-æ„é€ æ–¹æ³•"></a>commitLog()æ„é€ æ–¹æ³•</h3><p>CommitLog()æ„é€ æ–¹æ³•çš„è°ƒç”¨é“¾å¦‚å›¾æ‰€ç¤º<br><img src="https://i.loli.net/2021/09/10/s2fcpiQdSHC8Tyv.png" alt="CommitLog()"><br>å¯ä»¥çœ‹åˆ°åœ¨Brokerå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šé€šè¿‡<B>DefaultMessageStore</B>æ¥è°ƒç”¨<B>Commitlog</B>æ„é€ æ–¹æ³•,commitlogçš„æ„é€ æ–¹æ³•ä¸»è¦æ˜¯åšåˆå§‹åŒ–æ—¥å¿—ç¯å¢ƒçš„åŠŸèƒ½ï¼Œä¸‹é¢è¯¦ç»†çš„çœ‹ä¸€ä¸‹<B>commitLog()</B>æ–¹æ³•çš„å®ç°</p><ul><li>CommitLogæ„é€ æ–¹æ³•</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DefaultMessageStore</span> defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1. åˆå§‹åŒ–æ–‡ä»¶ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„æ˜ å°„çš„queue</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getAllocateMappedFileService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2. è®¾ç½®é»˜è®¤çš„æ¶ˆæ¯å­˜å‚¨</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>    <span class="token comment">//3. è®¾ç½®åˆ·ç›˜ç­–ç•¥</span>    <span class="token comment">//TODO è¿™é‡Œçš„åˆ·ç›˜ç­–ç•¥'FlushCommitLogService'æ˜¯ä½¿ç”¨finalå…³é”®å­—è¿›è¡Œä¿®é¥°çš„ï¼Œåœ¨åˆå§‹åŒ–å®Œæˆä»¥åå°±ä¸å…è®¸æ›´æ–°åˆ·ç›˜ç­–ç•¥çš„ã€‚æš‚æ—¶è¿˜ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™æ ·åš</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FlushDiskType</span><span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è®¾ç½®åŒæ­¥åˆ·ç›˜ç­–ç•¥</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è®¾ç½®å¼‚æ­¥åˆ·ç›˜ç­–ç•¥</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//4. è®¾ç½®æ¶ˆæ¯æäº¤ç­–ç•¥ä¸ºå®æ—¶æäº¤,CommitRealTimeServiceç»§æ‰¿FlushCommitLogServiceå¹¶ä½œä¸ºé»˜è®¤çš„æäº¤ç­–ç•¥ï¼Œå…·ä½“å®ç°ç±»è¿˜æœ‰GroupCommitService/FlushRealTimeService</span>    <span class="token comment">//TODO è¿™é‡Œçš„æŠ½è±¡ä¸æ˜¯å¾ˆå¥½ï¼Œå°†æäº¤ç­–ç•¥é€šè¿‡å†…éƒ¨ç±»çš„æ–¹å¼æ¥éšè—å®ç°</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>commitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//5. è®¾ç½®é»˜è®¤å“åº”ç­–ç•¥</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAppendMessageCallback</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//6. åˆå§‹åŒ–æäº¤æ¶ˆæ¯çº¿ç¨‹</span>    putMessageThreadLocal <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">PutMessageThreadLocal</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//7. åˆå§‹åŒ–æäº¤æ¶ˆæ¯çš„é”ï¼ŒTODO  ä¼šæ ¹æ®é…ç½®åˆå§‹åŒ–å‡ºå¯é‡å…¥é”æˆ–è‡ªæ—‹é”??</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>putMessageLock <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUseReentrantLockWhenPutMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageSpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¥éª¤1~7æ˜¯åˆå§‹åŒ–æ—¥å¿—ç¯å¢ƒçš„å·¥ä½œï¼Œä¾æ¬¡æ˜¯</p><ul><li>åˆå§‹åŒ–messagequeue\messafestore</li><li>è®¾ç½®åˆ·ç›˜ç­–ç•¥ã€æäº¤ç­–ç•¥ã€å“åº”ç­–ç•¥</li><li>åˆå§‹åŒ–æäº¤çº¿ç¨‹æ± </li></ul><hr><h3 id="load-æ–¹æ³•"><a class="header-anchor" href="#load-æ–¹æ³•"></a>load()æ–¹æ³•</h3><p>åœ¨æ„é€ æ–¹æ³•å®Œæˆå<B>BrokerController</B>ä¼šç»§ç»­è°ƒç”¨<B>DefaultMessageStore</B>load()æ–¹æ³•,æ¥å¯¹<B>CommitLog</B>å¯¹è±¡è¿›è¡ŒåŠ è½½</p><ul><li>BrokerController.load</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//initialize()æ–¹æ³•æ‰§è¡ŒmessageåŠ è½½åŠ¨ä½œ</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//çœç•¥...</span>    result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//çœç•¥...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>DefaultMessageStore.load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> loadResult <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//1. é€šè¿‡æ˜¯å¦å­˜åœ¨ä¸´æ—¶æ–‡ä»¶åˆ¤æ–­æ˜¯å¦ä¸Šä¸€æ¬¡æ­£å¸¸é€€å‡º</span>        <span class="token keyword">boolean</span> lastExitOK <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTempFileExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"last shutdown &#123;&#125;"</span><span class="token punctuation">,</span> lastExitOK <span class="token operator">?</span> <span class="token string">"normally"</span> <span class="token operator">:</span> <span class="token string">"abnormally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//2. TODO è¿™é‡Œçš„åˆ¤æ–­æ˜¯å¤šä½™çš„</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> scheduleMessageService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//æ‰§è¡Œè°ƒåº¦</span>            loadResult <span class="token operator">=</span> loadResult <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//3. åŠ è½½CommitLog</span>        loadResult <span class="token operator">=</span> loadResult <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//4.åŠ è½½loadConsumeQueue</span>        loadResult <span class="token operator">=</span> loadResult <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//5.åˆ›å»ºæˆåŠŸåç»­æ“ä½œ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//åˆå§‹åŒ–æ–‡ä»¶å­˜å‚¨çš„æ£€æŸ¥å¯¹è±¡</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>storeCheckpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreCheckpoint</span><span class="token punctuation">(</span><span class="token class-name">StorePathConfigHelper</span><span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åŠ è½½indexçš„ç®¡ç†æœåŠ¡</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ ¹æ®ä¸Šæ¬¡æœåŠ¡æ˜¯å¦å¼‚å¸¸ä¸­æ–­è¿›è¡ŒçŠ¶æ€æ¢å¤</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load over, and the max phy offset = &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"load exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        loadResult <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åŠ è½½å¤±è´¥æ—¶,å…³é—­ TODO è¿™é‡Œå°±åªæœ‰æ–‡ä»¶æ˜ å°„æœåŠ¡(MappedFileService)éœ€è¦å…³é—­å—?</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> loadResult<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨DefaultMessageStore.loadçš„ç¬¬3æ­¥ä¼šå°†commitLogè¿›è¡ŒåŠ è½½,å…¶ä»–æ–¹æ³•æ˜¯å¯¹å¼‚å¸¸æ¢å¤ã€å»¶è¿Ÿæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœåŠ¡ã€ConsumerQueueè¿›è¡ŒåŠ è½½ã€‚<br>ä¸‹é¢ä»‹ç»ä¸€ä¸‹commitLog.loançš„åŠ è½½è¿‡ç¨‹</p><ul><li>CommitLog.load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åŠ è½½mappedFileQueue</span>    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load commit log "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>result <span class="token operator">?</span> <span class="token string">"OK"</span> <span class="token operator">:</span> <span class="token string">"Failed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°CommitLog.load()æ–¹æ³•å°±æ˜¯åŠ è½½<B>MappedFileQueue</B></p><ul><li>MappedFileQueue.load()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åŠ è½½commit logæ–‡ä»¶ */</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//é»˜è®¤åœ°å€ä¸ºSystem.getProperty("user.home") + File.separator + "store" + File.separator + "commitlog"; @see org.apache.rocketmq.store.config.MessageStoreConfig.storePathCommitLog</span>    <span class="token class-name">File</span> dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶ä¸å­˜åœ¨æ—¶,ç›´æ¥è¿”å›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token operator">||</span> files<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¯¹æ–‡ä»¶æŒ‰ç…§å‡åºè¿›è¡Œæ’åº TODO è¿™é‡Œä¹Ÿæ˜¯å¤šä½™çš„æ–‡ä»¶çš„å‘½åè§„åˆ™æ˜¯æœ‰åº</span>    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//commitLogçš„æ–‡ä»¶å¤§å°é»˜è®¤ä¸º1G TODO è¿™ä¸ªå¤§å°æ˜¯ä»‹äºæ€§èƒ½å’Œå®¹é‡ä¹‹é—´çš„ä¸€ä¸ªé€‰æ‹©</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>file <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" length not matched message store config value, please check it manually"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è®¾ç½®MappedFileå¯¹è±¡ä¿¡æ¯</span>            <span class="token class-name">MappedFile</span> mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            mappedFile<span class="token punctuation">.</span><span class="token function">setWrotePosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            mappedFile<span class="token punctuation">.</span><span class="token function">setFlushedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            mappedFile<span class="token punctuation">.</span><span class="token function">setCommittedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å°†MappedFileå¯¹è±¡æ·»åŠ åˆ°mappedFilesï¼Œæ³¨æ„æ˜¯é€šè¿‡CopyOnWriteArrayListå®¹å™¨è¿›è¡Œä¿å­˜</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"CommitLog  call MappedFileQueue load &#123;&#125; :OK"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"CommitLog  call MappedFileQueue load &#123;&#125; :ERROR"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>mappedFiles.load()æ–¹æ³•ä¸»è¦é€šè¿‡æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„åŠ è½½æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶å¯¹è±¡é€šè¿‡CopyOnWriteArrayListå®¹å™¨è¿›è¡Œå­˜æ”¾<br>CopyOnWriteArrayListæ˜¯è¯»æ— é”-å†™æœ‰é”çš„å®¹å™¨ï¼Œå­˜å‚¨commitLogä¿¡æ¯</p><h3 id="start-æ–¹æ³•"><a class="header-anchor" href="#start-æ–¹æ³•"></a>start()æ–¹æ³•</h3><ul><li>commitLog.Start()</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1.å¯åŠ¨åˆ·ç›˜çº¿ç¨‹</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//2.åˆ¤æ–­æ˜¯å¦å¯åŠ¨å¼‚æ­¥æäº¤</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLogService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>commitLog.start()æ–¹æ³•ä¸»è¦æ˜¯å¯åŠ¨åˆ·ç›˜çº¿ç¨‹å’Œåˆ¤æ–­æ˜¯å¦å¯åŠ¨å¼‚æ­¥æäº¤</p><h2 id="è°ƒç”¨è¿‡ç¨‹"><a class="header-anchor" href="#è°ƒç”¨è¿‡ç¨‹"></a>è°ƒç”¨è¿‡ç¨‹</h2><p>CommitLogåº•å±‚æ˜¯é€šè¿‡<B>asyncPutMessage()</B>æ–¹æ³•æ¥å®ç°å¼‚æ­¥å‘æ–‡ä»¶ç³»ç»Ÿæäº¤çš„ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ ¹æ®asyncPutMessage()æ¥åˆ†æä»ä¸Šè‡³ä¸‹çš„è°ƒç”¨é“¾è¿‡ç¨‹</p><h3 id="è°ƒç”¨é“¾"><a class="header-anchor" href="#è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h3><p>é€šè¿‡Arthasåˆ†æ<B>asyncPutMessage()</B>çš„è°ƒç”¨è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</p><p><img src="https://i.loli.net/2021/09/13/rbDHVqyCkc8XJoj.jpg" alt="/è°ƒç”¨é“¾è·¯.jpg"></p><ul><li>arthas cmd</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">stack org.apache.rocketmq.store.CommitLog asyncPutMessage  -n <span class="token number">5</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»å›¾ä¸­å¯ä»¥çœ‹å¤„ç†æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ä»ç½‘ç»œI/Oåˆ°æ–‡ä»¶I/Oæ˜¯éå¸¸çŸ­çš„</p><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">@</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span>CommitLog<span class="token punctuation">.</span>asyncPutMessage<span class="token operator">(</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span>DefaultMessageStore<span class="token punctuation">.</span>asyncPutMessage<span class="token operator">(</span>DefaultMessageStore<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">435</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>SendMessageProcessor<span class="token punctuation">.</span>asyncSendMessage<span class="token operator">(</span>SendMessageProcessor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">314</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>SendMessageProcessor<span class="token punctuation">.</span>asyncProcessRequest<span class="token operator">(</span>SendMessageProcessor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">101</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>SendMessageProcessor<span class="token punctuation">.</span>asyncProcessRequest<span class="token operator">(</span>SendMessageProcessor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">82</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>NettyRemotingAbstract<span class="token operator">$</span>1<span class="token punctuation">.</span>run<span class="token operator">(</span>NettyRemotingAbstract<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">225</span><span class="token operator">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>RequestTask<span class="token punctuation">.</span>run<span class="token operator">(</span>RequestTask<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">80</span><span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NettyRemotingAbstract -&gt; SendMessageProcessor -&gt; CommitLog ä¸‰ä¸ªç±»å°±å®Œæˆäº†å¤„ç†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹commitlog&lt;/h1&gt;
&lt;p&gt;åœ¨ä¹‹å‰çš„ã€Šrocketmqçš„å­˜å‚¨åŸç†ã€‹æ–‡ç« ä¸­åˆ†æäº†rocketmqçš„å­˜å‚¨è¿‡ç¨‹ä¸»è¦æ˜¯é€šè¿‡ä¸¤ä¸ªç±»æ¥å®ç°çš„åˆ†åˆ«æ˜¯commitlogå’ŒMappedFileï¼Œè¿™ç¯‡æ–‡ç« é‡ç‚¹åˆ†æcommitlogè¿™ä¸ªç±»çš„å®ç°&lt;/p&gt;
</summary>
      
    
    
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://agmtopy.gitee.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
    <category term="RocketMQ" scheme="https://agmtopy.gitee.io/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹MappedFile</title>
    <link href="https://agmtopy.gitee.io/2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/14.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BMappedFile/"/>
    <id>https://agmtopy.gitee.io/2021/09/09/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/14.rocketmq%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BMappedFile/</id>
    <published>2021-09-09T15:17:09.000Z</published>
    <updated>2021-10-12T16:23:09.335Z</updated>
    
    <content type="html"><![CDATA[<h1>rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹MappedFile</h1><p><B>MappedFile</B>æ˜¯RoketMqå¤„ç†åº•å±‚æ–‡ä»¶çš„ç±»,åœ¨ä¸Šé¢ä¸€ç¯‡æ–‡ç« ä¸­å·²ç»äº†è§£äº†å¦‚ä½•é€šè¿‡<B>CommitLog</B>ç±»æ¥å¤„ç†è¯·æ±‚ä»¥åŠå¦‚ä½•é€šè¿‡<B>MappedFile</B>æ¥å®ç°åº•å±‚å­˜å‚¨çš„<br><B>MappedFile</B>çš„æ•´ä½“é€»è¾‘æ˜¯</p><h2 id="MappedFile"><a class="header-anchor" href="#MappedFile"></a>MappedFile</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;rocketmqçš„å­˜å‚¨å®ç°åŸç†ä¹‹MappedFile&lt;/h1&gt;
&lt;p&gt;&lt;B&gt;MappedFile&lt;/B&gt;æ˜¯RoketMqå¤„ç†åº•å±‚æ–‡ä»¶çš„ç±»,åœ¨ä¸Šé¢ä¸€ç¯‡æ–‡ç« ä¸­å·²ç»äº†è§£äº†å¦‚ä½•é€šè¿‡&lt;B&gt;CommitLog&lt;/B&gt;ç±»æ¥å¤„ç†è¯·æ±‚ä»¥åŠå¦‚ä½•é€šè¿‡&lt;B&gt;MappedFile&lt;/B&gt;æ¥å®ç°åº•å±‚</summary>
      
    
    
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://agmtopy.gitee.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
    <category term="RocketMQ" scheme="https://agmtopy.gitee.io/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>Nacosä½¿ç”¨æŒ‡å—</title>
    <link href="https://agmtopy.gitee.io/2021/09/05/17.Nacos/0.Nacos%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
    <id>https://agmtopy.gitee.io/2021/09/05/17.Nacos/0.Nacos%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</id>
    <published>2021-09-05T13:41:02.000Z</published>
    <updated>2021-09-08T16:20:50.579Z</updated>
    
    <content type="html"><![CDATA[<h1>Nacosä½¿ç”¨æŒ‡å—</h1><p>Nacosçš„å®šä½æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œæ”¯æŒç›®å‰ä¸»æµçš„åˆ†å¸ƒå¼æ¶æ„K8S/RPC/RESTfulã€‚ä¸»è¦åŠŸèƒ½æœ‰</p><ul><li>æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹</li><li>åŠ¨æ€é…ç½®æœåŠ¡</li><li>åŠ¨æ€ DNS æœåŠ¡</li><li>æœåŠ¡åŠå…¶å…ƒæ•°æ®ç®¡ç†</li></ul><h2 id="æ„å»ºNacos"><a class="header-anchor" href="#æ„å»ºNacos"></a>æ„å»ºNacos</h2><h3 id="Nacos-docker"><a class="header-anchor" href="#Nacos-docker"></a>Nacos docker</h3><ul><li>cloneé¡¹ç›®</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/nacos-group/nacos-docker.git<span class="token builtin class-name">cd</span> nacos-docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å•æœºæ¨¡å¼ Derby</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker-compose -f example/standalone-derby.yaml up<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ³¨æ„ä¸€å®šè¦å¯åŠ¨docker desktopæˆ–è€…dockerè¿›ç¨‹ï¼Œç„¶åå°±ç»è¿‡æ¼«é•¿çš„ç¼–è¯‘ç¯èŠ‚ï¼Œç¼–è¯‘å®Œæˆådockeré•œåƒä¼šè‡ªåŠ¨å¯åŠ¨</p><p><img src="https://i.loli.net/2021/09/08/xpdPVki2fA18yh3.jpg" alt="/é•œåƒimage.jpg"></p><ul><li>æµ‹è¯•æœåŠ¡çŠ¶æ€</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -X POST <span class="token string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/09/08/yt43erZ8ED2SoBm.jpg" alt="/æœåŠ¡æ³¨å†Œ.jpg"><br>Nacosæä¾›çš„æœåŠ¡ä»¥RESTfulé£æ ¼è¿›è¡Œæä¾›ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡httpè¯·æ±‚è¿›è¡Œæ“ä½œ</p><h3 id="Nacos-Cons"><a class="header-anchor" href="#Nacos-Cons"></a>Nacos Cons</h3><ul><li>æœåŠ¡åœ°å€<br><a href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></li><li>è´¦å·/å¯†ç <br>nacos/nacos<br>è¿™ä¸ªè´¦å·/å¯†ç æ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ä¸­çš„ï¼Œå¯ä»¥è¿›è¡Œæ›´æ”¹</li></ul><p><img src="https://i.loli.net/2021/09/08/qSbWEAl1zR4Cpxa.jpg" alt="/nacos_admin.jpg"></p><h3 id="spring-bootç¤ºä¾‹"><a class="header-anchor" href="#spring-bootç¤ºä¾‹"></a>spring bootç¤ºä¾‹</h3><h4 id="é…ç½®ç®¡ç†"><a class="header-anchor" href="#é…ç½®ç®¡ç†"></a>é…ç½®ç®¡ç†</h4><ul><li>ConfigExample</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> serverAddr <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> dataId <span class="token operator">=</span> <span class="token string">"nacos.cfg.dataId1"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> group <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">;</span>    <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">PropertyKeyConst</span><span class="token punctuation">.</span>SERVER_ADDR<span class="token punctuation">,</span> serverAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºè¿æ¥</span>    <span class="token class-name">ConfigService</span> configService <span class="token operator">=</span> <span class="token class-name">NacosFactory</span><span class="token punctuation">.</span><span class="token function">createConfigService</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–é…ç½®</span>    <span class="token class-name">String</span> content <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content1:"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è®¾ç½®ç›‘å¬</span>    configService<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveConfigInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> configInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"recieve:"</span> <span class="token operator">+</span> configInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ¨é€é…ç½®</span>    <span class="token keyword">boolean</span> isPublishOk <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">publishConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>isPublishOk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    content <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content2:"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç§»é™¤é…ç½®</span>    <span class="token keyword">boolean</span> isRemoveOk <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">removeConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>isRemoveOk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    content <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content3:"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ³¨å†Œä¸­å¿ƒ"><a class="header-anchor" href="#æ³¨å†Œä¸­å¿ƒ"></a>æ³¨å†Œä¸­å¿ƒ</h4>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;Nacosä½¿ç”¨æŒ‡å—&lt;/h1&gt;
&lt;p&gt;Nacosçš„å®šä½æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œæ”¯æŒç›®å‰ä¸»æµçš„åˆ†å¸ƒå¼æ¶æ„K8S/RPC/RESTfulã€‚ä¸»è¦åŠŸèƒ½æœ‰&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹&lt;/li&gt;
&lt;li&gt;åŠ¨æ€é…ç½®æœåŠ¡&lt;/li&gt;
&lt;li&gt;åŠ¨æ€ DNS æœåŠ¡&lt;/li&gt;
&lt;li&gt;æœ</summary>
      
    
    
    
    <category term="æ¡†æ¶" scheme="https://agmtopy.gitee.io/categories/%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="Nacos" scheme="https://agmtopy.gitee.io/tags/Nacos/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç¼–å†™JavaAgent</title>
    <link href="https://agmtopy.gitee.io/2021/07/03/12.JVM/5.%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99JavaAgent/"/>
    <id>https://agmtopy.gitee.io/2021/07/03/12.JVM/5.%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99JavaAgent/</id>
    <published>2021-07-03T15:11:15.000Z</published>
    <updated>2021-09-26T14:48:14.630Z</updated>
    
    <content type="html"><![CDATA[<h1>å¦‚ä½•ç¼–å†™JavaAgent</h1><p>è¿™ç¯‡æ–‡ç« æ˜¯æ ¹æ®MegaEaseçš„è¢ä¼Ÿè€å¸ˆçš„åˆ†äº«è€Œæ¥,åœ°å€æ˜¯<a href="https://www.youtube.com/watch?v=ujhqct2POLU">How To Write a JavaAgent</a></p><h2 id="ç®€ä»‹"><a class="header-anchor" href="#ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="java-agentæ˜¯ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#java-agentæ˜¯ä»€ä¹ˆï¼Ÿ"></a>java agentæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>java agentæ˜¯jdk1.5æ—¶å€™æ¨å‡ºçš„ä¸€ä¸ªåœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹class,ä»è€Œè¾¾åˆ°åŠ¨æ€ä¿®æ”¹è¡Œä¸ºçš„ç›®çš„</p><h3 id="èƒ½åšä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#èƒ½åšä»€ä¹ˆï¼Ÿ"></a>èƒ½åšä»€ä¹ˆï¼Ÿ</h3><p>åŠŸèƒ½ä¸AOPç±»ä¼¼ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨ä¸å½»åº•å’Œä¸šåŠ¡ä»£ç éš”ç¦»ï¼Œå¯ä»¥å®ŒæˆAOPç›¸åŒçš„äº‹æƒ…ï¼Œå¹¶ä¸”ä¸å…¥ä¾µä¸šåŠ¡ä»£ç ï¼Œé€‚åˆäºæ—¥å¿—é‡‡é›†ã€é“¾è·¯è¿½è¸ªç­‰åŸºç¡€ç»„ä»¶</p><h2 id="ç”¨æ³•"><a class="header-anchor" href="#ç”¨æ³•"></a>ç”¨æ³•</h2><p>java agentä¸»è¦å¯ä»¥åœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹è¿›è¡ŒåŠ è½½ï¼š</p><ol><li>JVMå¯åŠ¨æ—¶</li><li>ç›®æ ‡æ–¹æ³•è¿è¡Œæ—¶</li></ol><h4 id="é¡¹ç›®ç»“æ„"><a class="header-anchor" href="#é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h4><p><img src="https://i.loli.net/2021/07/11/uUxsh1JqQzaSXAW.png" alt="é¡¹ç›®ç»“æ„"></p><h4 id="å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹"><a class="header-anchor" href="#å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹"></a>å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹</h4><ul><li>AgentExampleDemo</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentExampleDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"premain start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>AgentTarget</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentTarget</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>build.gradle</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">  //é‡æ–°å®šä¹‰MANIFEST.MF  jar <span class="token punctuation">&#123;</span>    manifest <span class="token punctuation">&#123;</span>        attributes <span class="token string">'Premain-Class'</span><span class="token builtin class-name">:</span> <span class="token string">'com.agmtopy.source.agent.AgentExampleDemo'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>javaagentå¯åŠ¨å‚æ•°</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-javaagent:build/libs/jvmsource-1.0-SNAPSHOT.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/07/11/kH6wQJD5my7bxuX.png" alt="Ideaè®¾ç½®"></p><ul><li>è¿è¡Œç»“æœ</li></ul><p><a href="https://imgtu.com/i/R7rfyV"><img src="https://z3.ax1x.com/2021/07/07/R7rfyV.png" alt="ç»“æœ"></a></p><blockquote><p>è¿™æ˜¯ç¬¬ä¸€ç§ä½¿ç”¨agentçš„æ–¹å¼,åœ¨ç›®æ ‡ä»£ç è¿è¡Œå‰ä½¿ç”¨,java agentä»£ç ä¸ç›®æ ‡æ–¹æ³•è¿›è¡Œç»„åˆçš„æ–¹å¼è¿›è¡Œæ‰§è¡Œ</p></blockquote><h3 id="è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹"><a class="header-anchor" href="#è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹"></a>è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹</h3><p>ç›®æ ‡æ–¹æ³•è¿œè¡Œæ—¶åŠ è½½è¦ä½¿ç”¨åˆ°javassistè¿™ä¸ªå·¥å…·å¸®åŠ©æˆ‘ä»¬ä¿®æ”¹class,æ³¨æ„javassistæœ‰ä¸¤ä¸ªé¡¹ç›®,è¦ä½¿ç”¨<b>org.javassist</b>ğŸ˜‚æ‰å¯ä»¥</p><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">implementation &quot;org.javassist:javassist:3.28.0-GA&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>ä¿®æ”¹AgentTarget</li></ol><p>ä¿æŒjvmè¿è¡Œ,ä»¥ä¾¿é€šè¿‡Attachçš„æ–¹å¼è¿›è¡Œæ›¿æ¢</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentTarget</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>åœ¨AgentExampleDemoä¸­å¢åŠ agentmainæ–¹æ³•</li></ol><ul><li>AgentExampleDemo</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * attach:æ–¹å¼è¿è¡Œ */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"agentmain start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´</span>    inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShowExecTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//é‡å†™è½½å…¥æ–°çš„å­—èŠ‚ç </span>        inst<span class="token punctuation">.</span><span class="token function">retransformClasses</span><span class="token punctuation">(</span><span class="token class-name">AgentTarget</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnmodifiableClassException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>å¢åŠ ShowExecTimeæ¥ä¿®æ”¹å­—èŠ‚ç </li></ol><ul><li>ShowExecTime</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** è‡ªå®šä¹‰ClassFileTransformer*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShowExecTime</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> classBeingRedefined<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åªé’ˆå¯¹ç›®æ ‡åŒ…ä¸‹è¿›è¡Œè€—æ—¶ç»Ÿè®¡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"com/agmtopy/source/agent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨åŠ è½½ç±»ï¼š"</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            classPool<span class="token punctuation">.</span><span class="token function">appendClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoaderClassPath</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">CtClass</span> cl <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// æ‰€æœ‰æ–¹æ³•ï¼Œç»Ÿè®¡è€—æ—¶</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CtMethod</span> method <span class="token operator">:</span> cl<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ä¿®æ”¹:"</span> <span class="token operator">+</span> method <span class="token operator">+</span><span class="token string">" æ–¹æ³•"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//éœ€è¦é€šè¿‡`addLocalVariable`æ¥å£°æ˜å±€éƒ¨å˜é‡</span>                method<span class="token punctuation">.</span><span class="token function">addLocalVariable</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token class-name">CtClass</span><span class="token punctuation">.</span>longType<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//æ’å…¥ å¼€å§‹è¯­å¥</span>                method<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">"start = java.lang.System.currentTimeMillis();"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getLongName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//åˆ›å»ºå¹¶æ’å…¥ æ‰“å°è¯­å¥ System.out.println("æ–¹æ³•ï¼štestï¼Œ æ‰§è¡Œæ—¶é—´ï¼š" + (System.currentTimeMillis() - start));</span>                <span class="token class-name">String</span> statement <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"java.lang.System.out.println(\"æ–¹æ³•ï¼š%sï¼Œ æ‰§è¡Œæ—¶é—´ï¼š\" + (java.lang.System.currentTimeMillis() - start));"</span><span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>                method<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformed <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> transformed<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>transform()æ–¹æ³•æ˜¯é€šè¿‡javassistæ¥ä¿®æ”¹å­—èŠ‚ç ,åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥å±€éƒ¨å˜é‡ï¼Œç„¶åæ‰“å°æ–¹æ³•æ‰§è¡Œè€—æ—¶</p><ol start="4"><li>è¿è¡Œjarè¿›è¡Œæ›¿æ¢å­—èŠ‚ç æ›¿æ¢</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * ä¿®æ”¹æŒ‡å®šè¿è¡Œä¸­çš„ä»£ç  */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ä¼ å…¥ç›®æ ‡ JVM pid</span>    <span class="token class-name">VirtualMachine</span> vm <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token string">"6068"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    vm<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">"D:\\project\\jvmsource\\build\\libs\\jvmsource-1.0-SNAPSHOT.jar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>ä¿®æ”¹MANIFEST.MF<br>éœ€è¦å°†<b>Agent-Class</b>å†™å…¥MANIFEST.MFæ–‡ä»¶</li></ol><ul><li>gradle</li></ul><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">jar &#123;    manifest &#123;        attributes &#39;Can-Redefine-Classes&#39;: true        attributes &#39;Can-Retransform-Classes&#39;: true        attributes &#39;Agent-Class&#39;: &#39;com.agmtopy.source.agent.AgentExampleDemo&#39;        attributes &#39;Premain-Class&#39;: &#39;com.agmtopy.source.agent.AgentExampleDemo&#39;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢</li></ol><p>6.1 å…ˆå°†é¡¹ç›®æ„å»ºæˆä¸ºjaråŒ…<br>6.2 è¿è¡ŒAgentTarget<br>ä¸éœ€è¦ä½¿ç”¨-javaagentçš„æ–¹å¼è¿›è¡Œå¯åŠ¨<br><img src="https://i.loli.net/2021/07/11/d3kZXA769yheB8L.png" alt="AgentTargetç»“æœ"><br>6.3 æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢</p><ul><li>è¿è¡Œç»“æœ<br><img src="https://i.loli.net/2021/07/11/bksIl8USHRMc72d.png" alt="è¿è¡Œç»“æœ"></li></ul><h2 id="æºç åˆ†æ"><a class="header-anchor" href="#æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>java agentçš„åŸç†æ ¹æ®åŠ è½½æ—¶æœºè¿˜æ˜¯å¯ä»¥åˆ†ä¸ºä¸¤ç±»å…¥å£ï¼Œä¸€ç±»æ˜¯å¯åŠ¨æ—¶å°†agent classæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šï¼Œå¦å¤–ä¸€ç±»å…¥å£æ˜¯è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼Œé‡‡ç”¨çš„æ˜¯JVM attachæŠ€æœ¯</p><h3 id="å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ"><a class="header-anchor" href="#å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ"></a>å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ</h3><h4 id="åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾"><a class="header-anchor" href="#åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾"></a>åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentExampleDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"premain start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ‰“å°è°ƒç”¨æ ˆ</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">StringBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" ClassName: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" Method Name : "</span> <span class="token operator">+</span> elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://i.loli.net/2021/07/07/f4o2qQryOKwpWPL.png" alt="è°ƒç”¨æ ˆ"></p><p>é€šè¿‡è°ƒç”¨æ ˆå¯ä»¥åˆ†æå‡ºæ˜¯<B>InstrumentationImpl</B>è°ƒç”¨<B>premain()</B>æ–¹æ³•çš„,ä¸‹é¢å¼€å§‹åˆ†æInstrumentationImpl</p><h4 id="InstrumentationImpl"><a class="header-anchor" href="#InstrumentationImpl"></a>InstrumentationImpl</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstrumentationImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Instrumentation</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><B>InstrumentationImpl</B>å®ç°<B>Instrumentation</B>,<B>Instrumentation</B>æ¥å£æ˜¯JVMå®šä¹‰å¯¹å­—èŠ‚ç æ“ä½œçš„æ¥å£ï¼Œæˆ‘ä»¬æŒ‰ç…§è°ƒç”¨é“¾çš„é¡ºåºå€’å™è¿›è¡Œåˆ†æï¼ˆæ‰§è¡Œã€è§¦å‘ï¼‰</p><ol><li>permainæ‰§è¡Œè¿‡ç¨‹åˆ†æ</li></ol><p>ç”±äº<B>InstrumentationImpl.loadClassAndCallPremain()</B>æ–¹æ³•å·²ç»æœ€é¡¶å±‚çš„javaä»£ç å…¥å£ï¼Œé€šè¿‡æ–¹æ³•åç§°æŸ¥æ‰¾å¯ä»¥åœ¨<B>JPLISAgent.h</B>æ–‡ä»¶ä¸­æŸ¥è¯¢åˆ°è¯¥æ–¹æ³•åç§°è¢«å®šä¹‰æˆä¸ºä¸€ä¸ªå¸¸é‡</p><ul><li>JPLISAgent.h</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">#define JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODNAME      &quot;loadClassAndCallPremain&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¯¥å¸¸é‡è¢«<B>JPLISAgent.c</B>çš„<B>createInstrumentationImpl</B>æ–¹æ³•æ‰€ä½¿ç”¨</p><ul><li>JPLISAgent.c</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">jboolean createInstrumentationImpl(JNIEnv *jnienv,JPLISAgent *agent)&#123;    &#x2F;&#x2F;çœç•¥....    &#x2F;* Now look up the method ID for the pre-main caller (we will need this more than once) *&#x2F;    if (!errorOutstanding)    &#123;        &#x2F;&#x2F;â‘ è·å–åˆ°è°ƒç”¨permainæ–¹æ³•MethodId        premainCallerMethodID &#x3D; (*jnienv)-&gt;GetMethodID(jnienv,                                                       implClass,                                                       JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODNAME,                                                       JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODSIGNATURE);    &#125;    if (!errorOutstanding)    &#123;        agent-&gt;mInstrumentationImpl &#x3D; resultImpl;        &#x2F;&#x2F;â‘¡æŒ‡é’ˆèµ‹å€¼        agent-&gt;mPremainCaller &#x3D; premainCallerMethodID;        agent-&gt;mAgentmainCaller &#x3D; agentmainCallerMethodID;        agent-&gt;mTransform &#x3D; transformMethodID;    &#125;        &#x2F;&#x2F;çœç•¥....    return !errorOutstanding;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µæ–¹æ³•ä¸»è¦æ˜¯åšä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€æ˜¯è·å–åˆ°è°ƒç”¨permainæ–¹æ³•MethodIdï¼›ç¬¬äºŒä»¶äº‹æ˜¯å°†è¿™ä¸ªMethodIdä¼ é€’å‡ºå»,åˆ†æmPremainCallerçš„ä½¿ç”¨å¯ä»¥å¾—åˆ°è¯¥å€¼åœ¨â€™processJavaStartâ€™ä¸­ä½¿ç”¨</p><p><img src="https://i.loli.net/2021/07/07/WbT3LyNCQilShcv.png" alt="mPremainCaller"></p><ul><li>processJavaStart</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">result &#x3D; startJavaAgent(agent, jnienv,                        agent-&gt;mAgentClassName,                         agent-&gt;mOptionsString,                        agent-&gt;mPremainCaller);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>processJavaStarté€šè¿‡å‰é¢è·å–åˆ°çš„MethodIdå¯åŠ¨javaAgentï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ<B>statrJavaAgent</B></p><ul><li>statrJavaAgent</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//...</span>success <span class="token operator">=</span> <span class="token function">invokeJavaAgentMainMethod</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span>                                    agent<span class="token operator">-></span>mInstrumentationImpl<span class="token punctuation">,</span>                                    agentMainMethod<span class="token punctuation">,</span>                                    classNameObject<span class="token punctuation">,</span>                                    optionsStringObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨</B>invokeJavaAgentMainMethod</B>ä¼ å…¥å¯¹è±¡ã€æ–¹æ³•IDã€å®å‚ï¼Œæ‰§è¡Œå®šä¹‰çš„premainæ–¹æ³•</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æçŸ¥é“äº†permaiæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œç»§ç»­çœ‹ä¸€ä¸‹permainæ–¹æ³•æ˜¯å¦‚ä½•è§¦å‘çš„</p><ol start="2"><li>permainè§¦å‘è¿‡ç¨‹åˆ†æ</li></ol><p><B>processJavaStart</B>æ–¹æ³•æ˜¯æ‰§è¡Œpermainçš„å…¥å£ï¼Œå®ƒåœ¨<B>JPLISAgent.h</B>ä¸­è¿›è¡Œå®šä¹‰çš„,åœ¨æºä»£ç ä¸­å…¨å±€æœç´¢ï¼š<B> JPLISAgent *</B>å¯ä»¥æ‰¾åˆ°JPLISAgentæ˜¯åœ¨&lt;InvocationAdapter.c&gt;ä¸­é‡æ–°è¿›è¡Œè¿‡èµ‹å€¼</p><ul><li>InvocationAdapter.c</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">void JNICALL eventHandlerVMInit(jvmtiEnv *jvmtienv,                    JNIEnv *jnienv,                    jthread thread)  &#123;      JPLISAgent *agent &#x3D; environment-&gt;mAgent;  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><B>eventHandlerVMInit</B>æ–¹æ³•åœ¨<B>JPLISAgent.c</B>çš„<B>initializeJPLISAgent</B>æ–¹æ³•ä¸­è¢«è®¾ç½®ä¸ºå›è°ƒæ–¹æ³•</p><ul><li>initializeJPLISAgent</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F;å…³é”®æ‰§è¡Œé€»è¾‘if (jvmtierror &#x3D;&#x3D; JVMTI_ERROR_NONE)&#123;    jvmtiEventCallbacks callbacks;    memset(&amp;callbacks, 0, sizeof(callbacks));    &#x2F;&#x2F;è®¾ç½®JVMå›è°ƒ    callbacks.VMInit &#x3D; &amp;eventHandlerVMInit;    jvmtierror &#x3D; (*jvmtienv)-&gt;SetEventCallbacks(jvmtienv,                                                &amp;callbacks,                                                sizeof(callbacks));    check_phase_ret_blob(jvmtierror, JPLIS_INIT_ERROR_FAILURE);    jplis_assert(jvmtierror &#x3D;&#x3D; JVMTI_ERROR_NONE);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–JPLISAgentæ—¶å€™å°±è®¾ç½®äº†JVMåˆå§‹åŒ–å®Œæˆåä¼šå›è°ƒInvocationAdapteræ¥æ‰§è¡Œ<B>permain</B>æ–¹æ³•</p><ol start="3"><li>JPLISAgentçš„åˆå§‹åŒ–</li></ol><p>å›æº¯<B>initializeJPLISAgent</B>æ–¹æ³•å¯ä»¥æ‰¾åˆ°åˆ†åˆ«åœ¨<B>InvocationAdapter.c</B>çš„<B>DEF_Agent_OnLoad</B>ã€<B>DEF_Agent_OnAttach</B>ä¸Šè¢«è°ƒç”¨ã€‚è¿™ä¸¤ç§æ–¹å¼ä¹Ÿæ­£æ˜¯å‰é¢è®²åˆ°çš„agentçš„ä¸¤ç§å¢å¼ºæ–¹å¼çš„å…¥å£ã€‚</p><p>åœ¨JVMå¯åŠ¨æ—¶æœ€å¼€å§‹åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢æ‰¾åˆ°JVMTIçš„å…¥å£æ–¹æ³•ï¼šAgent_OnLoadå’ŒAgent_OnAttachã€‚InvocationAdapter.cçš„å®šä¹‰</p><ul><li>InvocationAdapter.c</li></ul><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;**  This will be called once for every -javaagent on the command line.*  Each call to Agent_OnLoad will create its own agent and agent data.**  The argument tail string provided to Agent_OnLoad will be of form*  &lt;jarfile&gt;[&#x3D;&lt;options&gt;]. The tail string is split into the jarfile and*  options components. The jarfile manifest is parsed and the value of the*  Premain-Class attribute will become the agent&#39;s premain class. The jar*  file is then added to the system class path, and if the Boot-Class-Path*  attribute is present then all relative URLs in the value are processed*  to create boot class path segments to append to the boot class path.*&#x2F;JNIEXPORT jint JNICALLDEF_Agent_OnLoad(JavaVM *vm, char *tail, void *reserved)&#x2F;**  This will be called once each time a tool attaches to the VM and loads*  the JPLIS library.*&#x2F;JNIEXPORT jint JNICALLDEF_Agent_OnAttach(JavaVM *vm, char *args, void *reserved)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>æ•´ä½“é€»è¾‘<br>æ•´ä½“çš„æ‰§è¡Œé€»è¾‘å°±æ˜¯ï¼š</li></ol><ul><li>JPLISAgentå£°æ˜JVMå¯åŠ¨æ—¶å€™åˆå§‹åŒ–JPLISAgent</li><li>JPLISAgentåˆå§‹åŒ–æ—¶è®¾ç½®InvocationAdapterçš„å›è°ƒæ–¹æ³•</li><li>JVMåˆå§‹åŒ–å®Œæˆåæ‰§è¡Œå›è°ƒæ–¹æ³•</li><li>InvocationAdapterçš„å›è°ƒæ–¹æ³•æ‰§è¡Œpermainæ–¹æ³•</li></ul><h3 id="è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ"><a class="header-anchor" href="#è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ"></a>è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ</h3><ol><li>åˆ†æå­—èŠ‚ç <br>ä½¿ç”¨<B>HSDB</B>æŸ¥çœ‹AgentTargetæœªè¿›è¡Œå­—èŠ‚ç æ›¿æ¢å‰çš„æ•°æ®</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">jhsdb hsdb --pid <span class="token number">21656</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¸¸é‡æ± </li></ul><p><img src="https://i.loli.net/2021/07/11/phklzJKYTs7IG16.jpg" alt="æ›¿æ¢å‰çš„å¸¸é‡æ± "></p><p><img src="https://i.loli.net/2021/07/11/tkaOxIQ62fbs84K.png" alt="æ›¿æ¢åçš„å¸¸é‡æ± "><br>æ˜æ˜¾å¯ä»¥çœ‹åˆ°å¸¸é‡æ± ä¸­å¢åŠ äº†22æ¡æŒ‡ä»¤ï¼Œè¿™22æ¡æŒ‡ä»¤å°±æ˜¯æ–°åŠ å…¥çš„å­—èŠ‚ç æ‰€è¦ä½¿ç”¨åˆ°çš„å¸¸é‡</p><ul><li>æ–¹æ³•åŒº</li></ul><p><img src="https://i.loli.net/2021/07/11/3DvWBpyuHQ7I2cM.jpg" alt="æ›¿æ¢å‰çš„æ–¹æ³•åŒº"></p><p><img src="https://i.loli.net/2021/07/11/e9TObiVwDPH7Whv.jpg" alt="æ›¿æ¢åçš„æ–¹æ³•åŒº"></p><ol start="2"><li>é‡æ–°åŠ è½½å­—èŠ‚ç åŸç†<br>@TODO</li></ol><blockquote><p>é€šè¿‡å­—èŠ‚ç å¯¹æ¯”å¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºåœ¨ä½¿ç”¨<B>Instrumentation.addTransformer();</B>åç¡®å®å°†å­—èŠ‚ç è¿›è¡Œäº†ä¿®æ”¹,å…¶å®ä¿®æ”¹å­—èŠ‚ç è¿˜æ˜¯æœ‰ä¸¤ä¸ªæ—¶æœº:</p></blockquote><ul><li>ä¸€ä¸ªæ˜¯åœ¨å¯åŠ¨ç¼–è¯‘æ—¶,ä¼šåœ¨jvmå¯åŠ¨å®Œæ¯•ååœ¨æ‰§è¡Œpermainæ–¹æ³•æ¥ä¿®æ”¹å­—èŠ‚ç </li><li>ä¸€ä¸ªå°±æ˜¯åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€çš„ä¿®æ”¹å­—èŠ‚ç </li></ul><h3 id="æ•´ä½“æ‰§è¡Œé€»è¾‘"><a class="header-anchor" href="#æ•´ä½“æ‰§è¡Œé€»è¾‘"></a>æ•´ä½“æ‰§è¡Œé€»è¾‘</h3><p><img src="https://i.loli.net/2021/07/11/sCey6D7USV9LRXo.jpg" alt="æ•´ä½“æ‰§è¡Œé€»è¾‘"></p><h2 id="å¼€å‘å·¥å…·"><a class="header-anchor" href="#å¼€å‘å·¥å…·"></a>å¼€å‘å·¥å…·</h2><ul><li><p>ASM</p></li><li><p>Javassist</p></li><li><p>Byte Buddy</p></li></ul><h3 id="åŠŸèƒ½å¯¹æ¯”"><a class="header-anchor" href="#åŠŸèƒ½å¯¹æ¯”"></a>åŠŸèƒ½å¯¹æ¯”</h3><table><thead><tr><th>-</th><th>ASM</th><th>Javassist</th><th>Byte Buddy</th></tr></thead><tbody><tr><td>å­¦ä¹ æˆæœ¬</td><td>é«˜</td><td>ä½</td><td>ä½</td></tr><tr><td>ä½¿ç”¨æ–¹æ³•</td><td>ä½¿ç”¨å­—èŠ‚ç æ–¹å¼è¿›è¡Œæ’å…¥,éœ€è¦äº†è§£classç±»ç»“æ„å’ŒJVMæŒ‡ä»¤é›†</td><td>æä¾›é«˜çº§æŠ½è±¡æ¥å£å’Œä½çº§å­—èŠ‚ç æ¥å£</td><td>åŒJavassist,å¹¶ä¸”æä¾›å£°æ˜å¼æ¥å£</td></tr><tr><td>æ€§èƒ½</td><td>æå¿«</td><td>ä¸€èˆ¬</td><td>å¿«</td></tr></tbody></table><p>è¯¦ç»†çš„å¯¹æ¯”å¯å‚è€ƒbyteBuddyå®˜æ–¹èµ„æ–™:<a href="https://bytebuddy.net/#/tutorial">https://bytebuddy.net/#/tutorial</a></p><h3 id="Byte-Buddy"><a class="header-anchor" href="#Byte-Buddy"></a>Byte Buddy</h3><h4 id="ç¤ºä¾‹"><a class="header-anchor" href="#ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><ul><li>gradle</li></ul><pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">&#x2F;&#x2F;ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º1.11.6implementation &quot;net.bytebuddy:byte-buddy:LATEST&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>AgentExampleForByteBuddy</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentExampleForByteBuddy</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Advice.OnMethodEnter</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Advice.Origin</span> <span class="token class-name">Executable</span> method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"byte buddy before : "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Advice.OnMethodExit</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Advice.Origin</span> <span class="token class-name">Executable</span> method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"byte buddy after : "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> arguments<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰§è¡Œ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">AgentBuilder<span class="token punctuation">.</span>RedefinitionStrategy</span><span class="token punctuation">.</span>RETRANSFORMATION<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">AgentBuilder<span class="token punctuation">.</span>InstallationListener<span class="token punctuation">.</span>StreamWriting</span><span class="token punctuation">.</span><span class="token function">toSystemError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">"AgentTarget"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> td<span class="token punctuation">,</span> cl<span class="token punctuation">,</span> m<span class="token punctuation">)</span> <span class="token operator">-></span> builder<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">Advice</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">AgentExampleForByteBuddy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token class-name">MethodDescription</span><span class="token operator">::</span><span class="token function">isConstructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>AgentTarget</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentTarget</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰“å°...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">AgentTarget</span> agentTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        agentTarget<span class="token punctuation">.</span><span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"123"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ¼”ç¤ºçš„æ˜¯ä¸€ä¸ªé‡å†™åŠ è½½ç±»çš„ç¤ºä¾‹:</p><ol><li>é€šè¿‡</B>@Advice.OnMethodEnter</B>å’Œ<B>@Advice.OnMethodExit</B>å®šä¹‰æ‰§è¡Œæ–¹æ³•å‰åæ’å…¥çš„å­—èŠ‚ç </li><li>é€šè¿‡<B>AgentBuilder</B>æŒ‡å®šè¦å¢å¼ºçš„ç±»å’Œç±»å‹</li><li><B>AgentBuilder.with</B>å¯ä»¥æ·»åŠ ç›‘å¬ï¼Œæ–¹ä¾¿è¾“å‡ºè°ƒè¯•</li></ol><h3 id="Byte-Byddyå¸¸è§é—®é¢˜"><a class="header-anchor" href="#Byte-Byddyå¸¸è§é—®é¢˜"></a>Byte Byddyå¸¸è§é—®é¢˜</h3><ul><li>ä¾èµ–å†²çª</li></ul><p>å¤„ç†æ–¹æ¡ˆï¼š</p><ol><li><p>æ„å»ºå·¥å…·æ’é™¤</p></li><li><p>ä½¿ç”¨è‡ªå®šä¹‰classLoaderåŠ è½½agentæ‰€ä½¿ç”¨çš„ç±»<br>é€šè¿‡æŒ‡å®šagentç±»çš„åŠ è½½å™¨,è®©</B>BootstrapClassLoader</B>å»åŠ è½½</p></li></ol><ul><li>Byte-Buddyæä¾›çš„API</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ClassInjector<span class="token punctuation">.</span>UsingInstrumentation</span>         <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">FileJar</span><span class="token punctuation">,</span> <span class="token class-name">ClassInjector<span class="token punctuation">.</span>UsingInstrumentation<span class="token punctuation">.</span>Target</span><span class="token punctuation">.</span>BOOTSTRAP<span class="token punctuation">,</span> instrumentation<span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">injectRaw</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">,</span> <span class="token class-name">ClassFileLocator                 <span class="token punctuation">.</span>ForClassLoader</span><span class="token punctuation">.</span><span class="token function">ofSystemLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token punctuation">.</span><span class="token function">locate</span><span class="token punctuation">(</span><span class="token string">"com.agmtopy.source.agent.AgentExampleForByteBuddy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>java agentä¸­ä¼ å‚</li></ul><p>å¤„ç†æ–¹æ¡ˆ:</p><ol><li>ThreadLocal</li><li>å¢åŠ ä¸´æ—¶çš„æˆå‘˜å˜é‡</li></ol><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://asm.ow2.io/">https://asm.ow2.io/</a><br><a href="https://www.javassist.org/">https://www.javassist.org/</a><br><a href="https://bytebuddy.net/#/">https://bytebuddy.net/#/</a><br><a href="https://blog.csdn.net/wanxiaoderen/article/details/107079741">https://blog.csdn.net/wanxiaoderen/article/details/107079741</a><br><a href="https://www.cnblogs.com/old-cha/p/13264114.html">https://www.cnblogs.com/old-cha/p/13264114.html</a><br><a href="https://www.cnblogs.com/chiangchou/p/javassist.html#_label9">https://www.cnblogs.com/chiangchou/p/javassist.html#_label9</a><br><a href="https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html">https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html</a><br><a href="https://github.com/gzzchh/de-ag">https://github.com/gzzchh/de-ag</a><br><a href="https://gitee.com/mazhimazh/bytecode-examples">https://gitee.com/mazhimazh/bytecode-examples</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å¦‚ä½•ç¼–å†™JavaAgent&lt;/h1&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« æ˜¯æ ¹æ®MegaEaseçš„è¢ä¼Ÿè€å¸ˆçš„åˆ†äº«è€Œæ¥,åœ°å€æ˜¯&lt;a href=&quot;https://www.youtube.com/watch?v=ujhqct2POLU&quot;&gt;How To Write a JavaAgent&lt;/a&gt;&lt;/p</summary>
      
    
    
    
    <category term="jvm" scheme="https://agmtopy.gitee.io/categories/jvm/"/>
    
    
    <category term="jvm" scheme="https://agmtopy.gitee.io/tags/jvm/"/>
    
    <category term="agent" scheme="https://agmtopy.gitee.io/tags/agent/"/>
    
  </entry>
  
  <entry>
    <title>é€šè¿‡WSL2ç¼–è¯‘JDKæºç </title>
    <link href="https://agmtopy.gitee.io/2021/06/19/1.%E6%9D%82%E8%AE%B0/%E9%80%9A%E8%BF%87WSL2%E7%BC%96%E8%AF%91JDK%E6%BA%90%E7%A0%81/"/>
    <id>https://agmtopy.gitee.io/2021/06/19/1.%E6%9D%82%E8%AE%B0/%E9%80%9A%E8%BF%87WSL2%E7%BC%96%E8%AF%91JDK%E6%BA%90%E7%A0%81/</id>
    <published>2021-06-19T11:39:54.000Z</published>
    <updated>2021-06-19T16:44:54.486Z</updated>
    
    <content type="html"><![CDATA[<h1>é€šè¿‡WSL2ç¼–è¯‘JDKæºç </h1><p>WSLçš„å…¨ç§°æ˜¯â€™Windows Subsystem for Linuxâ€™,é€šè¿‡åœ¨ç³»ç»Ÿå±‚é¢å¯¹Linuxå†…æ ¸è¿›è¡Œæ”¯æŒ,WSL1åªæ˜¯éƒ¨åˆ†æ”¯æŒLinuxå†…æ ¸è€ŒWSL2æ”¯æŒå®Œæ•´çš„Linuxå†…æ ¸ã€‚ä¸ä½†å¯ä»¥é€šè¿‡WSLè¿è¡ŒLinuxå†…æ ¸ï¼Œç”šè‡³å¯ä»¥å°†Windows DockeræŒ‡å®šé€šè¿‡WSL2æ¥è¿›è¡Œè¿œè¡Œ</p><h2 id="WSL1-WSL2"><a class="header-anchor" href="#WSL1-WSL2"></a>WSL1 -&gt; WSL2</h2><ul><li><p>å®‰è£…Linuxå‘è¡Œç‰ˆ<br>WSL1åªéœ€è¦å¼€å¯Linuxå­ç³»ç»Ÿå¹¶ä¸‹è½½linuxå‘è¡Œç‰ˆå³å¯,linuxå‘è¡Œç‰ˆé»˜è®¤æ˜¯åªèƒ½é€šè¿‡Windows Storeè¿›è¡Œä¸‹è½½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹è½½å®‰è£…åŒ…(msi)è¿›è¡Œå®‰è£…,æ‰‹åŠ¨é€‰æ‹©å®‰è£…åŒ…åœ°å€å¦‚ä¸‹(<a href="https://docs.microsoft.com/zh-cn/windows/wsl/install-manual">https://docs.microsoft.com/zh-cn/windows/wsl/install-manual</a>)</p></li><li><p>åˆ‡æ¢WSL2</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wsl --set-default-version <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¯åŠ¨WSL</li></ul><ol><li>åº”ç”¨ç¨‹åºç›´æ¥å¯åŠ¨å®‰è£…Linuxå‘è¡Œç‰ˆ</li><li>â€˜wsl -l -vâ€™ æ£€æŸ¥WSLç‰ˆæœ¬,VERSION -&gt; 2å³å¯<br><a href="https://imgtu.com/i/RPsbr9"><img src="https://z3.ax1x.com/2021/06/19/RPsbr9.png" alt="WSL2"></a></li></ol><h2 id="ç¼–è¯‘JDK"><a class="header-anchor" href="#ç¼–è¯‘JDK"></a>ç¼–è¯‘JDK</h2><p>ä¸¥è°¨çš„è¯´æ³•æ˜¯ç¼–è¯‘OpenJDK</p><h3 id="ä¸‹è½½JDKæºä»£ç "><a class="header-anchor" href="#ä¸‹è½½JDKæºä»£ç "></a>ä¸‹è½½JDKæºä»£ç </h3><p>æ¨èç›´æ¥ä¸‹è½½,ä¸‹é¢æ˜¯JDK11çš„æºä»£ç åœ°å€,ç›´æ¥é€‰æ‹©zip fileè¿›è¡Œä¸‹è½½,ä¹Ÿå¯ä»¥é€‰æ‹©ä¸åŒçš„ç‰ˆæœ¬<br><a href="https://jdk.java.net/java-se-ri/11">https://jdk.java.net/java-se-ri/11</a></p><h3 id="å‡†å¤‡JDKç¼–è¯‘ç¯å¢ƒ"><a class="header-anchor" href="#å‡†å¤‡JDKç¼–è¯‘ç¯å¢ƒ"></a>å‡†å¤‡JDKç¼–è¯‘ç¯å¢ƒ</h3><h4 id="å®‰è£…å¿…è¦ç¨‹åº"><a class="header-anchor" href="#å®‰è£…å¿…è¦ç¨‹åº"></a>å®‰è£…å¿…è¦ç¨‹åº</h4><ul><li>æ¨èå…ˆå…ˆåˆ‡æ¢è½¯ä»¶æº</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">sed</span> -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list<span class="token function">sudo</span> <span class="token function">apt</span> update -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å®‰è£…å¿…è¦è½¯ä»¶</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token function">curl</span> <span class="token function">ssh</span> <span class="token function">zip</span> <span class="token function">unzip</span> ant <span class="token function">git</span> build-essential ccache cpio g++ gcc gdb libx11-dev libxext-dev libxrender-dev libxtst-dev libxt-dev libcups2-dev libfreetype6-dev libasound2-dev libelf-dev ccache libfontconfig1-dev autoconf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="å®‰è£…BootStrap-JDK"><a class="header-anchor" href="#å®‰è£…BootStrap-JDK"></a>å®‰è£…BootStrap JDK</h4><p>BootStrap JDKçš„ä½œç”¨æ˜¯ç¼–è¯‘JDKæºä»£ç ä¸­çš„javaä»£ç ,é»˜è®¤è¦æ¯”ç¼–è¯‘çš„JDKå°ä¸€ä¸ªç‰ˆæœ¬</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openjdk-10-jdkjava -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="è§£å‹JDKæºä»£ç "><a class="header-anchor" href="#è§£å‹JDKæºä»£ç "></a>è§£å‹JDKæºä»£ç </h4><p>ç”±äºæˆ‘æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨VS code,VS codeä¸­å·²ç»é›†æˆäº†è¿æ¥WSLçš„æ’ä»¶ï¼Œå› æ­¤åªéœ€è¦å°†JDKæºä»£ç ç›´æ¥æ‹–æ‹½åˆ°Linuxçš„ç›®å½•ä¸‹å³å¯ã€‚ä¹Ÿå¯ä»¥é€šè¿‡WSLè¿›è¡Œå¤åˆ¶<br>å¾—åˆ°JDKæºä»£ç åå°±å¯ä»¥è¿›è¡Œè§£å‹</p><h4 id="ç¼–è¯‘JDKæºä»£ç "><a class="header-anchor" href="#ç¼–è¯‘JDKæºä»£ç "></a>ç¼–è¯‘JDKæºä»£ç </h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å‡†å¤‡é…ç½®(è­¦å‘Šä¸ä½œä¸ºå¼‚å¸¸æŠ›å‡º)</span><span class="token function">bash</span> ./configure --disable-warnings-as-errors<span class="token function">make</span> all<span class="token comment"># ç¼–è¯‘å¤±è´¥æ—¶æ¨èå…ˆè¿›è¡Œclean,åœ¨é‡æ–°è¿›è¡Œç¼–è¯‘</span><span class="token function">make</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å¼‚å¸¸å¤„ç†"><a class="header-anchor" href="#å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h4><ol><li>åœ¨æ„å»ºä½ç‰ˆæœ¬çš„JDKæ—¶å¯èƒ½å‡ºç°OSç‰ˆæœ¬ä¸æ”¯æŒ<br>ä¿®æ”¹./hotspot/make/linux/Makefile</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 5% å†…æ ¸ç‰ˆæœ¬</span>SUPPORTED_OS_VERSION <span class="token operator">=</span> <span class="token number">2.4</span>% <span class="token number">2.5</span>% <span class="token number">2.6</span>% <span class="token number">2.7</span>% <span class="token number">3</span>% <span class="token number">4</span>%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;é€šè¿‡WSL2ç¼–è¯‘JDKæºç &lt;/h1&gt;
&lt;p&gt;WSLçš„å…¨ç§°æ˜¯â€™Windows Subsystem for Linuxâ€™,é€šè¿‡åœ¨ç³»ç»Ÿå±‚é¢å¯¹Linuxå†…æ ¸è¿›è¡Œæ”¯æŒ,WSL1åªæ˜¯éƒ¨åˆ†æ”¯æŒLinuxå†…æ ¸è€ŒWSL2æ”¯æŒå®Œæ•´çš„Linuxå†…æ ¸ã€‚ä¸ä½†å¯ä»¥é€šè¿‡WSLè¿è¡ŒLinuxå†…æ ¸ï¼Œç”šè‡³å¯</summary>
      
    
    
    
    <category term="æ‚è®°" scheme="https://agmtopy.gitee.io/categories/%E6%9D%82%E8%AE%B0/"/>
    
    
    <category term="WSL" scheme="https://agmtopy.gitee.io/tags/WSL/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQä¸­NameSrvçš„è¯¦ç»†è®¾è®¡åˆ†æ</title>
    <link href="https://agmtopy.gitee.io/2021/06/11/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/98.RocketMQ%E4%B8%ADNameSrv%E7%9A%84%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90/"/>
    <id>https://agmtopy.gitee.io/2021/06/11/7.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9F%A5%E8%AF%86/98.RocketMQ%E4%B8%ADNameSrv%E7%9A%84%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90/</id>
    <published>2021-06-11T14:57:56.000Z</published>
    <updated>2021-09-09T15:17:40.849Z</updated>
    
    <content type="html"><![CDATA[<h1>RocketMQä¸­NameSrvçš„è¯¦ç»†è®¾è®¡åˆ†æ</h1><h2 id="è®¾è®¡ç›®æ ‡"><a class="header-anchor" href="#è®¾è®¡ç›®æ ‡"></a>è®¾è®¡ç›®æ ‡</h2><p>NameSrvæ˜¯RoctetMQé¡¹ç›®ä¸‹çš„ä¸€ä¸ªæ¨¡å—ï¼Œä½œä¸ºRockerMQä¸­çš„è½»å‹æ³¨å†Œä¸­å¿ƒ,åªè´Ÿè´£ä¸Topicæœ‰å…³çš„åŠŸèƒ½ã€‚<br>ä½¿ç”¨NameSrvæ¥æ›¿ä»£ZKç­‰æ³¨å†Œä¸­å¿ƒä¸»è¦æ˜¯æœ‰ä¸¤ä¸ªå¥½å¤„:</p><ol><li>å‡å°‘æ•´ä½“å¤æ‚æ€§<br>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¼ºä¾èµ–å¦å¤–ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¢åŠ äº†æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚æ€§(æ•´ä½“ä»£ç å¤æ‚æ€§ã€è¿ç»´çš„å¤æ‚æ€§);<br>ä½¿ç”¨å†…ç½®çš„è½»é‡çº§æ³¨å†Œä¸­å¿ƒ,å°±å¯ä»¥æ¶ˆé™¤åŸæ¥ä¸ZKç­‰ç¬¬ä¸‰æ–¹æ³¨å†Œä¸­å¿ƒçš„å„ç§åè®®é€‚é…;<br>Namesrvä¸­åªéœ€è¦å¼€å‘ä¸Topicæœ‰å…³çš„ä¸šåŠ¡åœºæ™¯;<br>ç³»ç»Ÿç»´æŠ¤æ—¶ä¹Ÿä¸ç”¨åœ¨è€ƒè™‘ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„å¤„ç†æœºåˆ¶;</li><li>æ‰©å±•èƒ½åŠ›<br>RocketMQä»è®¾è®¡åˆå°±è€ƒè™‘è¿‡åœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šè¿›è¡Œéƒ¨ç½²çš„èƒ½åŠ›,å› æ­¤é‡‡ç”¨Namesrvçš„è®¾è®¡èƒ½æœ€å¤§é™åº¦çš„æŒæ¡ç³»ç»Ÿ</li></ol><p>ç›®å‰Kafkaåœ¨è¿™æ–¹é¢åšçš„æ›´å¥½ï¼Œåœ¨V2.8ä¹‹åä¸ä½†å»æ‰äº†ZKï¼Œå¹¶ä¸”é‡‡ç”¨brokeré›†ç¾¤ä¸­é€šè¿‡é€‰ä¸¾çš„æ–¹å¼é€‰å‡ºleaderèŠ‚ç‚¹æ¥ç®¡ç†Topicã€brokerã€consumer</p><h2 id="åŸºç¡€åŠŸèƒ½"><a class="header-anchor" href="#åŸºç¡€åŠŸèƒ½"></a>åŸºç¡€åŠŸèƒ½</h2><ul><li><p>æ•´ä½“æ¶æ„<br><img src="https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_architecture_3.png" alt="æ•´ä½“æ¶æ„"><br>Namesrvé›†ç¾¤æ˜¯æ— çŠ¶æ€çš„è®¾è®¡,æ¯ä¸ªç»„ä»¶(Brokerã€Producerã€Consumer)éƒ½ä¼šå‘æ¯ä¸€ä¸ªNamesrvè¿›è¡Œè¯·æ±‚,å› æ­¤Namesrvæ˜¯é€‰æ‹©äº†å¯ç”¨æ€§</p></li><li><p>åŠŸèƒ½è§£æ</p></li></ul><ol><li>Topicè·¯ç”±ç®¡ç†</li><li>Remotingè¿œç¨‹æœåŠ¡</li><li>å®šæ—¶ä»»åŠ¡</li><li>KVç®¡ç†æ¨¡å—</li></ol><h2 id="æºç åˆ†æ"><a class="header-anchor" href="#æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Namesrvæ—¶åºå›¾"><a class="header-anchor" href="#Namesrvæ—¶åºå›¾"></a>Namesrvæ—¶åºå›¾</h3><p><a href="https://imgtu.com/i/2jkklQ"><img src="https://z3.ax1x.com/2021/06/16/2jkklQ.png" alt="Namesrvæ‰§è¡Œæµç¨‹"></a></p><h3 id="NamesrvStartup"><a class="header-anchor" href="#NamesrvStartup"></a>NamesrvStartup</h3><h4 id="main"><a class="header-anchor" href="#main"></a>main()</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">/** * ä¸»å‡½æ•°å…¥å£ */</span><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">main0</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/** * å…·ä½“æ‰§è¡Œé€»è¾‘:é¿å…åœ¨mainå‡½æ•°ä¸­æ·»åŠ è¿‡å¤šçš„é€»è¾‘ */</span><span class="token keyword">fun</span> <span class="token function">main0</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> controller <span class="token operator">=</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>        <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span>        <span class="token keyword">val</span> tip <span class="token operator">=</span>            <span class="token string">"The Name Server boot success. serializeType="</span> <span class="token operator">+</span> RemotingCommand<span class="token punctuation">.</span><span class="token function">getSerializeTypeConfigInThisServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        log<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">println</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * åˆå§‹åŒ–NamesrvController */</span><span class="token keyword">fun</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> NamesrvController <span class="token punctuation">&#123;</span>  <span class="token comment">//å»é™¤TLSå’Œapache.commonsçš„ç‰ˆæœ¬</span>  <span class="token keyword">return</span> <span class="token function">NamesrvController</span><span class="token punctuation">(</span><span class="token function">NamesrvConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NettyServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="start"><a class="header-anchor" href="#start"></a>start()</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">/**  * å¯åŠ¨NamesrvController  */</span><span class="token keyword">fun</span> <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token operator">:</span> NamesrvController<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>controller <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"NamesrvController is null"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//NamesrvControlleræ‰§è¡Œåˆå§‹åŒ–,å¦‚æœå¤±è´¥æ—¶é€€å‡ºè¿›ç¨‹</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        controller<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    controller<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>NamesrvStartupå¯åŠ¨æ—¶å€™ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºNamesrvController</li><li>å¤„ç†TLSå’ŒåŠ è½½Namesrvé…ç½®æ–‡ä»¶</li><li>å¯åŠ¨NamesrvController</li><li>å…³é—­NamesrvController</li></ol><ul><li>NamesrvController<br>NamesrvControllerä¸»è¦é€»è¾‘å¾ˆä¸ºä¸¤ä¸ªéƒ¨åˆ†åˆå§‹åŒ–å’Œæ‰§è¡Œ</li></ul><ol><li>åˆå§‹åŒ–</li></ol><ul><li>åˆå§‹åŒ–é‚£äº›ä¸œè¥¿</li></ul><ol><li><p>é…ç½®</p></li><li><p>æœåŠ¡</p></li><li><p>çº¿ç¨‹æ± </p></li><li><p>è‡ªçœ</p></li><li><p>åŠ è½½é…ç½®æ–‡ä»¶</p></li></ol><h2 id="æ‰©å±•æ€è€ƒ"><a class="header-anchor" href="#æ‰©å±•æ€è€ƒ"></a>æ‰©å±•æ€è€ƒ</h2><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://rocketmq.apache.org/">rocketmq</a><br><a href="https://github.com/apache/rocketmq">rocketmq-github</a><br><a href="https://www.confluent.io/blog/kafka-without-zookeeper-a-sneak-peek/">Apache Kafka Made Simple: A First Glimpse of a Kafka Without ZooKeeper</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;RocketMQä¸­NameSrvçš„è¯¦ç»†è®¾è®¡åˆ†æ&lt;/h1&gt;
&lt;h2 id=&quot;è®¾è®¡ç›®æ ‡&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#è®¾è®¡ç›®æ ‡&quot;&gt;&lt;/a&gt;è®¾è®¡ç›®æ ‡&lt;/h2&gt;
&lt;p&gt;NameSrvæ˜¯RoctetMQé¡¹ç›®ä¸‹çš„ä¸€ä¸ªæ¨¡å—ï¼Œä½œä¸ºRockerMQä¸­çš„è½»</summary>
      
    
    
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://agmtopy.gitee.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
    <category term="RocketMQ" scheme="https://agmtopy.gitee.io/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€äº›å†å²</title>
    <link href="https://agmtopy.gitee.io/2021/05/08/1.%E6%9D%82%E8%AE%B0/%E5%85%B3%E4%BA%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8E%86%E5%8F%B2/"/>
    <id>https://agmtopy.gitee.io/2021/05/08/1.%E6%9D%82%E8%AE%B0/%E5%85%B3%E4%BA%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8E%86%E5%8F%B2/</id>
    <published>2021-05-08T14:03:28.000Z</published>
    <updated>2021-05-09T08:43:52.000Z</updated>
    
    <content type="html"><![CDATA[<h1>å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€äº›å†å²</h1><p>è¿™æ˜¯ä¸€ç¯‡å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„å†å²æ–‡ç« ï¼Œæœ‰å…³æ¶ˆæ¯é˜Ÿåˆ—çš„å‰ä¸–ä»Šç”Ÿçš„ä¸€äº›ä¿¡æ¯ã€‚</p><h2 id="èµ·æº"><a class="header-anchor" href="#èµ·æº"></a>èµ·æº</h2><p>è½¯ä»¶é¢†åŸŸçš„æ¶ˆæ¯é˜Ÿåˆ—æœ€æ—©æ˜¯ç”±Vivek Ranadiveå‚è€ƒç¡¬ä»¶ä¸­çš„ç³»ç»Ÿæ€»çº¿æå‡ºæ¥çš„,è¿™è€å“¥æ˜¯ä¸€ä¸ªå°åº¦è£”,ç°åœ¨è¿˜æ˜¯å›½ç‹é˜Ÿçš„è€æ¿ã€‚<br>ç¡¬ä»¶é¢†åŸŸä¸­çš„ç³»ç»Ÿæ€»çº¿ä¸»è¦åˆ†ä¸ºæ•°æ®æ€»çº¿ã€åœ°å€æ€»çº¿ã€æ§åˆ¶æ€»çº¿è¿™å‡ ä¸ªéƒ¨åˆ†ï¼Œç”¨æ¥è¿æ¥ä¸åŒçš„è®¾å¤‡ä¼ è¾“æ•°æ®ä½¿ç”¨ã€‚<br><a href="https://imgtu.com/i/gJ4Q61"><img src="https://z3.ax1x.com/2021/05/09/gJ4Q61.png" alt="ç³»ç»Ÿæ€»çº¿"></a><br>ç¡¬ä»¶ä¸Šçš„ç³»ç»Ÿæ€»çº¿ç€é‡åœ¨äºé€šè¿‡çº¿è¿æ¥ä¸åŒè®¾å¤‡ä¹‹é—´çš„äº¤äº’ï¼Œè€Œæ¶ˆæ¯é˜Ÿåˆ—æ˜¯è½¯ä»¶é¢†åŸŸçš„è¿æ¥ä¸åŒç³»ç»Ÿä¹‹é—´äº¤äº’çš„æ–¹å¼æœ‰åº”ç”¨å±‚åè®®ï¼Œç°ä»£çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦ç€é‡ç‚¹æ˜¯åœ¨äºé˜Ÿåˆ—ä¸Šã€‚</p><h2 id="ä¸Šå¤æ—¶æœŸ"><a class="header-anchor" href="#ä¸Šå¤æ—¶æœŸ"></a>ä¸Šå¤æ—¶æœŸ</h2><ul><li><p>1985<br>Vivek Ranadiveæ ¹æ®ç³»ç»Ÿæ€»çº¿è®¾è®¡å‡ºæ¥çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿå«The Information Bus(TIB)ï¼ŒTIBä½†æ˜¯ä¸»è¦æ˜¯åœ¨ç”µä¿¡å’Œé‡‘èé¢†åŸŸè¿›è¡Œä½¿ç”¨ã€‚</p></li><li><p>1993<br>IBM MQæ˜¯ç”±è“è‰²å·¨äººIBMä¸1993å¹´æ¨å‡ºçš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“ï¼Œç›®å‰è¿˜ä¿æŒæ›´æ–°ç°åœ¨è¿­ä»£åˆ°äº†V9ç‰ˆæœ¬</p></li><li><p>1997<br>MS MQæ˜¯ç”±å¾®è½¯æ¨å‡ºçš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“,ä¸ç”±æ„Ÿæ…¨ä¸€å¥å¾®è½¯æ˜¯çœŸåŠï¼Œä¸ºäº†.netç¡¬æ˜¯æ•´äº†ä¸€ä¸ªå…¨å®¶æ¡¶ã€‚</p></li></ul><p>è¿™ä¸€æ—¶æœŸç”±äºå„å®¶çš„MQäº§å“éƒ½æ˜¯ä¸ºäº†æ——ä¸‹å…¶ä»–äº§å“è¿›è¡ŒæœåŠ¡ï¼Œä¸ºäº†å½¢æˆå£å’ï¼Œå„å®¶çš„MQäº§å“å¹¶æœªå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒï¼Œå¯¼è‡´ä¸åŒå…¬å¸ä¸‹çš„äº§å“å¹¶ä¸èƒ½ä½¿ç”¨å…¶ä»–å…¬å¸çš„MQã€‚</p><h2 id="ä¸­å¤æ—¶æœŸ"><a class="header-anchor" href="#ä¸­å¤æ—¶æœŸ"></a>ä¸­å¤æ—¶æœŸ</h2><p>ç”±äºæ—©æœŸçš„MQäº§å“å„è‡ªä¸ºæ”¿çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸€æ—¶æœŸä¸»è¦ç»Ÿä¸€äº†æ¶ˆæ¯é˜Ÿåˆ—çš„åè®®ï¼Œè¿™äº›åè®®ä¸€ç›´å½±å“åˆ°äº†ç°åœ¨ï¼Œä¸»è¦è¯ç”Ÿäº†ä»¥ä¸‹å‡ ç§åè®®ä»¥åŠæ¥å…¥è§„èŒƒï¼š</p><ul><li><p>JMS<br>JMSæ˜¯ä¸€å¥—æ¥å…¥MQä¸­é—´ä»¶äº§å“çš„æ¥å£è§„èŒƒï¼Œjavaä¸ºäº†é»åˆå„å®¶çš„æ¶ˆæ¯é˜Ÿåˆ—è¯•å›¾é€šè¿‡ç±»ä¼¼äºJDBCçš„æ–¹æ¡ˆåœ¨javaç«¯é€šè¿‡ç»Ÿä¸€çš„åè®®ï¼Œåœ¨æ ¹æ®ä¸åŒäº§å“çš„é©±åŠ¨å»è¿æ¥MQã€‚<br>å„ä¸ªå‚å•†æ ¹æ®è¿™å¥—æ¥å£è§„èŒƒè‡ªè¡Œé€‰æ‹©å®¢æˆ·ç«¯è¿›è¡Œå®ç°ï¼Œå®ç°äº†è¿™ä¸ªæ¥å£è§„èŒƒçš„å®¢æˆ·ç«¯å¯ä»¥åœ¨javaåº”ç”¨ç¨‹åºå†…è‡ªç”±åˆ‡æ¢ï¼Œç±»ä¼¼äºé€‚é…å™¨æ¨¡å¼</p></li><li><p>AMQP<br>AMQPæ˜¯å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€ç§åè®®ï¼Œåœ¨åè®®å±‚è§„å®šäº†æ¶ˆæ¯é˜Ÿåˆ—åº”è¯¥æœ‰çš„é€»è¾‘è§„èŒƒã€‚AMQPä¸å…·ä½“çš„MQ(ä¾‹å¦‚RabbitMQã€ActiveMQ)çš„å…³ç³»ç±»ä¼¼ä¸jvmè§„èŒƒå’ŒJVMå®ç°(HotSpot)ä¸€æ ·</p></li><li><p>MQTT<br>ä¸ºåµŒå…¥å¼è®¾å¤‡è®¾è®¡çš„ä¸€å¥—æ¶ˆæ¯é˜Ÿåˆ—åè®®</p></li><li><p>STOMP<br>Stompåè®®ï¼Œè‹±æ–‡å…¨åStreaming Text Orientated Message Protocolï¼Œä¸­æ–‡åç§°ä¸º â€˜æµæ–‡æœ¬å®šå‘æ¶ˆæ¯åè®®â€™ã€‚æ˜¯ä¸€ç§ä»¥çº¯æ–‡æœ¬ä¸ºè½½ä½“çš„åè®®ï¼ˆä»¥æ–‡æœ¬ä¸ºè½½ä½“çš„æ„æ€æ˜¯å®ƒçš„æ¶ˆæ¯æ ¼å¼è§„èŒƒä¸­æ²¡æœ‰ç±»ä¼¼XMPPåè®®é‚£æ ·çš„xmlæ ¼å¼è¦æ±‚ï¼Œä½ å¯ä»¥å°†å®ƒçœ‹ä½œâ€˜åŠç»“æ„åŒ–æ•°æ®â€™ï¼‰<br>åŒå‘æ¶ˆæ¯é€šä¿¡åè®®è¿˜æœ‰å¾ˆå¤šï¼Œé™¤äº†AMQPä»¥å¤–å…¶ä»–çš„å¤§å¤šéƒ½æ˜¯å³æ—¶æ¶ˆæ¯åè®®ã€‚</p></li><li><p>ActiveMQ<br>åœ¨è¿™ä¸€æ—¶æœŸè¿˜æœ‰æ ¹æ®AMQPè¿˜è¯ç”Ÿäº†ActiveMQè¿™ä¸€å¼€æºäº§å“ï¼ŒActiveMQæ˜¯ç¬¬ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨åˆ°çš„å¼€æºMQäº§å“</p></li><li><p>RabbitMQ<br>RabbitMQæ˜¯2006å¹´è¯ç”Ÿçš„ï¼Œç°åœ¨å’Œspringæ¡†æ¶åŒå±äºvmwareã€‚ç”±Erlangå¼€å‘çš„ã€‚</p></li></ul><h2 id="ç°ä»£æ—¶æœŸ"><a class="header-anchor" href="#ç°ä»£æ—¶æœŸ"></a>ç°ä»£æ—¶æœŸ</h2><p>ç”±äºActiveMQå’ŒRabbitMQå‘å±•äº†å¤šå¹´ï¼ŒèƒŒè´Ÿç€æ²‰é‡çš„å†å²åŒ…è¢±æ”¯æŒè¿™éå¸¸å…¨çš„MQåŠŸèƒ½ï¼Œåœ¨ç°ä»£çš„MQä½¿ç”¨åœºæ™¯ä¸­è¿™äº›æ¶ˆæ¯é˜Ÿåˆ—ä¸ç¬¦åˆå½“ä¸‹æ•°æ®çˆ†ç‚¸ï¼Œå°å‹æœºç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„åœºæ™¯äº†ã€‚è¿™æ—¶å€™å‡ºç°äº†é’ˆå¯¹æŸä¸ªç»†åˆ†é¢†åŸŸçš„æ¶ˆæ¯é˜Ÿåˆ—æ¡†æ¶Kafkaã€RocketMQã€Pulsar</p><ul><li><p>Kafka<br>Kafkaæ˜¯Linkedinä¸ºè§£å†³ActiveMQæ€§èƒ½é—®é¢˜è€Œå¼€å‘çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›®å‰å·²ç»æˆä¸ºå¤§æ•°æ®é¢†åŸŸå®é™…çš„æ¶ˆæ¯ä¼ é€’ç»„ä»¶</p></li><li><p>RocketMQ<br>RocketMQæ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œåœ¨è®¾è®¡ä¸Šå‚è€ƒäº†kafka,é€šè¿‡javaè¯­è¨€è¿›è¡Œå¼€å‘</p></li><li><p>Pulsar<br>Pulsaræ˜¯é›…è™å¼€æºçš„ï¼Œå¤©ç„¶æ”¯æŒå¤šç»„æˆå¹¶ä¸”æ˜¯è®¡ç®—å’Œå­˜å‚¨åˆ†ç¦»å¼çš„å®ç°</p></li></ul><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>æ¶ˆæ¯é˜Ÿåˆ—çš„è¯ç”Ÿæ˜¯ä»é‡‘èåœºæ™¯å‡ºå‘ï¼Œå‘å±•åˆ°ç°åœ¨æœ€å¼€å§‹çš„é‚£å‡ ç§æ¶ˆæ¯é˜Ÿåˆ—åœ¨åŠŸèƒ½ä¸Šå·²ç»å˜å¾—éå¸¸è‡ƒè‚¿ã€‚ç°ä»£çš„æ¶ˆæ¯é˜Ÿåˆ—æ ¹æ®æŸä¸€æ–¹é¢çš„ç€é‡ç‚¹å¼€å§‹è¿›è¡Œå‘å±•ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://tryrabbitmq.com/">http://tryrabbitmq.com/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€äº›å†å²&lt;/h1&gt;
&lt;p&gt;è¿™æ˜¯ä¸€ç¯‡å…³äºæ¶ˆæ¯é˜Ÿåˆ—çš„å†å²æ–‡ç« ï¼Œæœ‰å…³æ¶ˆæ¯é˜Ÿåˆ—çš„å‰ä¸–ä»Šç”Ÿçš„ä¸€äº›ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&quot;èµ·æº&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#èµ·æº&quot;&gt;&lt;/a&gt;èµ·æº&lt;/h2&gt;
&lt;p&gt;è½¯ä»¶é¢†åŸŸçš„æ¶ˆæ¯é˜Ÿåˆ—æœ€æ—©æ˜¯ç”±Vi</summary>
      
    
    
    
    <category term="æ‚è®°" scheme="https://agmtopy.gitee.io/categories/%E6%9D%82%E8%AE%B0/"/>
    
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://agmtopy.gitee.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-è¡Œä¸ºæ¨¡å¼</title>
    <link href="https://agmtopy.gitee.io/2021/04/29/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F/"/>
    <id>https://agmtopy.gitee.io/2021/04/29/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%A1%80-%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-04-29T15:12:03.000Z</published>
    <updated>2021-05-08T13:59:04.000Z</updated>
    
    <content type="html"><![CDATA[<h1>è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-è¡Œä¸ºæ¨¡å¼</h1><p>è¡Œä¸ºæ¨¡å¼æ˜¯é€šè¿‡å°†å¤šä¸ªç±»é€šè¿‡ç»§æ‰¿\ç»„åˆçš„å½¢å¼å½¢æˆå¯¹æ–¹æ³•çš„å¤„ç†,ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§</p><ol><li>è´£ä»»é“¾æ¨¡å¼</li><li>å‘½ä»¤æ¨¡å¼</li><li>è§£é‡Šå™¨æ¨¡å¼</li><li>è¿­ä»£å™¨æ¨¡å¼</li><li>ä¸­ä»‹è€…æ¨¡å¼</li><li>å¤‡å¿˜å½•æ¨¡å¼</li><li>è§‚å¯Ÿè€…æ¨¡å¼</li><li>çŠ¶æ€æ¨¡å¼</li><li>ç­–ç•¥æ¨¡å¼</li><li>æ¨¡æ¿æ¨¡å¼</li><li>è®¿é—®è€…æ¨¡å¼</li></ol><h2 id="è´£ä»»é“¾æ¨¡å¼"><a class="header-anchor" href="#è´£ä»»é“¾æ¨¡å¼"></a>è´£ä»»é“¾æ¨¡å¼</h2><h3 id="æ„å›¾"><a class="header-anchor" href="#æ„å›¾"></a>æ„å›¾</h3><blockquote><p>è´£ä»»é“¾æ¨¡å¼æ˜¯ä½¿å¾—å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚,ä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»,è¿™äº›å¯¹è±¡çš„å¤„ç†è¿‡ç¨‹é€»è¾‘ä¸Šå½¢æˆé“¾çŠ¶ç»“æ„,è¯·æ±‚æ²¿ç€è¿™æ¡é“¾ä¾æ¬¡è¢«ä¸åŒçš„å¯¹è±¡è¿›è¡Œå¤„ç†ã€‚æ ‡å‡†çš„å®šä¹‰æ˜¯ç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†è¯·æ±‚ä¸ºæ­¢ï¼Œæˆ‘è‡ªå·±ç†è§£åº”è¯¥æ˜¯ä¾æ¬¡è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯æœ‰ä¸€ä¸ªå¤„ç†å³æ­¢ï¼Œå› ä¸ºå¦‚æœåªæœ‰ä¸€ä¸ªå¤„ç†ï¼Œé‚£ä¹ˆè´£ä»»é“¾æ¨¡å¼ä¸ç­–ç•¥æ¨¡å¼ç±»ä¼¼ã€‚è´£ä»»é“¾æ¨¡å¼æ˜¯é€šè¿‡å°†è¯·æ±‚éœ€è¦ä¾æ¬¡å¤„ç†çš„åœºæ™¯ä»æ˜¾çš„å®¢æˆ·ç«¯ä¸€ä¸ªä¸€ä¸ªè°ƒç”¨çš„è¿‡ç¨‹ï¼Œå‡çº§æˆäº†å°†è¯·æ±‚ä¼ å…¥å’Œç”±è´£ä»»é“¾å®¢æˆ·ç«¯å»ä¸²è”æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼Œå¹¶ä¸”è¿™æ ·æ›´å®¹æ˜“æ‰©å±•æ­¥éª¤ã€‚</p></blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œé€šå¸¸æ¯ä¸ªæ¥æ”¶è€…éƒ½åŒ…å«å¯¹å¦ä¸€ä¸ªæ¥æ”¶è€…çš„å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤„ç†è¯¥è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒä¼šæŠŠç›¸åŒçš„è¯·æ±‚ä¼ ç»™ä¸‹ä¸€ä¸ªæ¥æ”¶è€…ï¼Œä¾æ­¤ç±»æ¨ã€‚</p><h3 id="ç»“æ„"><a class="header-anchor" href="#ç»“æ„"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/2021-chain-of-responsibility.svg" alt="è´£ä»»é“¾æ¨¡å¼"></p><h3 id="å®ä¾‹"><a class="header-anchor" href="#å®ä¾‹"></a>å®ä¾‹</h3><ul><li>AbstractLogger.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> INFO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> DEBUG <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ERROR <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">int</span> level<span class="token punctuation">;</span>    <span class="token comment">//è´£ä»»é“¾ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ </span>   <span class="token keyword">protected</span> <span class="token class-name">AbstractLogger</span> nextLogger<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNextLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span> nextLogger<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>nextLogger <span class="token operator">=</span> nextLogger<span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">&lt;=</span> level<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token function">write</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>nextLogger <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         nextLogger<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ChainPatternDemo.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChainPatternDemo</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AbstractLogger</span> <span class="token function">getChainOfLoggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token class-name">AbstractLogger</span> errorLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">AbstractLogger</span> fileLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">AbstractLogger</span> consoleLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsoleLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>       errorLogger<span class="token punctuation">.</span><span class="token function">setNextLogger</span><span class="token punctuation">(</span>fileLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>      fileLogger<span class="token punctuation">.</span><span class="token function">setNextLogger</span><span class="token punctuation">(</span>consoleLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> errorLogger<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">AbstractLogger</span> loggerChain <span class="token operator">=</span> <span class="token function">getChainOfLoggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       loggerChain<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token string">"This is an information."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       loggerChain<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span>          <span class="token string">"This is a debug level information."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       loggerChain<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token class-name">AbstractLogger</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>          <span class="token string">"This is an error information."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ErrorLoggerã€FileLoggerã€ConsoleLoggeréƒ½æ˜¯AbstractLogger.javaçš„å­ç±»ï¼Œåœ¨å®¢æˆ·ç«¯ä¸­ï¼Œé€šè¿‡æä¾›setNextHandlerçš„æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è‡ªç”±ç»„åˆé“¾çš„é¡ºåº</p><h2 id="å‘½ä»¤æ¨¡å¼"><a class="header-anchor" href="#å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h2><h3 id="æ„å›¾-v2"><a class="header-anchor" href="#æ„å›¾-v2"></a>æ„å›¾</h3><p>å°†è¯·æ±‚å°è£…æˆä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œä½¿å¾—ä½ å¯ä»¥ç”¨ä¸åŒçš„è¯·æ±‚å¯¹å®¢æˆ·è¿›è¡Œå‚æ•°åŒ–</p><h3 id="åŠ¨æœº"><a class="header-anchor" href="#åŠ¨æœº"></a>åŠ¨æœº</h3><p>å‘½ä»¤æ¨¡å¼ä¸»è¦æ˜¯å°†è¯·æ±‚å’Œå¯¹è¯·æ±‚æ‰§è¡Œçš„åŠ¨ä½œè´£ä»»åˆ†ç¦»,è®©ä¸¤è€…éƒ½å¯ä»¥ç‹¬ç«‹è¿›è¡Œæ¼”åŒ–ã€‚é€‚åˆè¯·æ±‚å†…å®¹æ˜¯ç±»ä¼¼äºä¿¡å·é‡çš„åœºæ™¯ï¼Œæ¥å—è€…å¯ä»¥æ ¹æ®è¿™ä¸ªè¯·æ±‚å†…å®¹è¿›è¡Œä¸åŒçš„å¤„ç†</p><h3 id="ç»“æ„-v2"><a class="header-anchor" href="#ç»“æ„-v2"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/commanduml.jpg" alt="å‘½ä»¤æ¨¡å¼"></p><h3 id="å®ä¾‹-v2"><a class="header-anchor" href="#å®ä¾‹-v2"></a>å®ä¾‹</h3><ul><li>Command</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * æ‰§è¡Œæ–¹æ³•     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Command.java å®šä¹‰çš„æŠ½è±¡å‘½ä»¤ç±»ï¼Œæ‰€æœ‰å…·ä½“å‘½ä»¤çš„æ¥å£</p><ul><li>PlayCommand.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//å…·ä½“çš„æ‰§è¡Œç±»</span>    <span class="token keyword">private</span> <span class="token class-name">AudioPlayer</span> myAudio<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token class-name">PlayCommand</span><span class="token punctuation">(</span><span class="token class-name">AudioPlayer</span> audioPlayer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        myAudio <span class="token operator">=</span> audioPlayer<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * æ‰§è¡Œæ–¹æ³•     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        myAudio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PlayCommandæ˜¯å…·ä½“çš„å‘½ä»¤æ‰§è¡Œç±»ï¼Œå†…éƒ¨å…·æœ‰ä¸€ä¸ªexecuteæ–¹æ³•,è¯¥æ–¹æ³•ä¼šæ‰§è¡Œè¯¥å‘½ä»¤å®šä¹‰çš„åŠ¨ä½œ</p><ul><li>Keypad.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Keypad</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Command</span> playCommand<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPlayCommand</span><span class="token punctuation">(</span><span class="token class-name">Command</span> playCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>playCommand <span class="token operator">=</span> playCommand<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">//æ‰§è¡Œæ’­æ”¾æ–¹æ³•</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        playCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>keyPadä½œä¸ºè¯·æ±‚ç±»ï¼Œå†æ¬¡å¯¹å‘½ä»¤è¿›è¡Œä¸€æ¬¡å°è£…ï¼Œä¾¿äºå®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨å†æ¬¡å°è£…ï¼Œè‡ªå·±é€šè¿‡å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨</p><ul><li>client.java</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Julia</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token comment">//åˆ›å»ºæ¥æ”¶è€…å¯¹è±¡</span>        <span class="token class-name">AudioPlayer</span> audioPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆ›å»ºå‘½ä»¤å¯¹è±¡</span>        <span class="token class-name">Command</span> playCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlayCommand</span><span class="token punctuation">(</span>audioPlayer<span class="token punctuation">)</span>         <span class="token comment">//åˆ›å»ºè¯·æ±‚è€…å¯¹è±¡</span>        <span class="token class-name">Keypad</span> keypad <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Keypad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        keypad<span class="token punctuation">.</span><span class="token function">setPlayCommand</span><span class="token punctuation">(</span>playCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//æ‰§è¡Œå…·ä½“çš„ç±»</span>        keypad<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨è¯·æ±‚ç±»==Keypad==çš„æŒ‡å®šæ–¹æ³•ï¼ŒkeyPadä¼šè°ƒç”¨å…·ä½“çš„å‘½ä»¤å°è£…ç±»è¿›è¡Œæ‰§è¡Œã€‚å…¶å®å‘½ä»¤æ¨¡å¼åªæ˜¯å°†è¯·æ±‚å’Œå¯¹åº”çš„åŠ¨ä½œè¿›è¡Œåˆ†ç¦»ï¼Œä¾¿äºå¤æ‚è¯·æ±‚åœºæ™¯çš„æ‰©å±•</p><h2 id="è§£é‡Šå™¨æ¨¡å¼"><a class="header-anchor" href="#è§£é‡Šå™¨æ¨¡å¼"></a>è§£é‡Šå™¨æ¨¡å¼</h2><h3 id="æ„å›¾-v3"><a class="header-anchor" href="#æ„å›¾-v3"></a>æ„å›¾</h3><p>è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreter Patternï¼‰æä¾›äº†è¯„ä¼°è¯­è¨€çš„è¯­æ³•æˆ–è¡¨è¾¾å¼çš„æ–¹å¼ï¼Œå®ƒå±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼å®ç°äº†ä¸€ä¸ªè¡¨è¾¾å¼æ¥å£ï¼Œè¯¥æ¥å£è§£é‡Šä¸€ä¸ªç‰¹å®šçš„ä¸Šä¸‹æ–‡ã€‚è¿™ç§æ¨¡å¼è¢«ç”¨åœ¨ SQL è§£æã€ç¬¦å·å¤„ç†å¼•æ“ç­‰ã€‚</p><h3 id="åŠ¨æœº-v2"><a class="header-anchor" href="#åŠ¨æœº-v2"></a>åŠ¨æœº</h3><p>ç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨è¯¥æ ‡è¯†æ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚</p><h3 id="ç»“æ„-v3"><a class="header-anchor" href="#ç»“æ„-v3"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/interpreter_pattern_uml_diagram.jpg" alt="è§£é‡Šå™¨æ¨¡å¼"></p><h2 id="è¿­ä»£å™¨æ¨¡å¼"><a class="header-anchor" href="#è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h2><h3 id="æ„å›¾-v4"><a class="header-anchor" href="#æ„å›¾-v4"></a>æ„å›¾</h3><p>æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€è¦æš´éœ²èšåˆå¯¹è±¡å†…éƒ¨è¡¨ç¤ºçš„æ¨¡å¼</p><h3 id="åˆ«å"><a class="header-anchor" href="#åˆ«å"></a>åˆ«å</h3><p>æ¸¸æ ‡(Cursor)</p><h3 id="åŠ¨æœº-v3"><a class="header-anchor" href="#åŠ¨æœº-v3"></a>åŠ¨æœº</h3><p>è¿­ä»£å™¨æ¨¡å¼æ˜¯ä¸ºäº†å°†å†…éƒ¨å…ƒç´ å’Œè®¿é—®/éå†åŠ¨ä½œåˆ†ç¦»å¼€ï¼Œé€šè¿‡å¢åŠ ä¸€ä¸ªè¿­ä»£å™¨ï¼Œé€šè¿‡è¿­ä»£å™¨æ¥è®¿é—®å†…éƒ¨å…ƒç´ ã€‚</p><h3 id="ç»“æ„-v4"><a class="header-anchor" href="#ç»“æ„-v4"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/iterator_pattern_uml_diagram.jpg" alt="è¿­ä»£å™¨æ¨¡å¼"></p><h2 id="ä¸­ä»‹è€…æ¨¡å¼"><a class="header-anchor" href="#ä¸­ä»‹è€…æ¨¡å¼"></a>ä¸­ä»‹è€…æ¨¡å¼</h2><h3 id="æ„å›¾-v5"><a class="header-anchor" href="#æ„å›¾-v5"></a>æ„å›¾</h3><p>ç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—çš„å¯¹è±¡äº¤äº’ã€‚ä¸­ä»‹è€…ä½¿å„å¯¹è±¡ä¸éœ€è¦æ˜¾å¼åœ°ç›¸äº’å¼•ç”¨ï¼Œä»è€Œä½¿å…¶è€¦åˆæ¾æ•£ï¼Œè€Œä¸”å¯ä»¥ç‹¬ç«‹çš„æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’</p><h3 id="åŠ¨æœº-v4"><a class="header-anchor" href="#åŠ¨æœº-v4"></a>åŠ¨æœº</h3><p>ç”±äºé¢å‘å¯¹è±¡é¼“åŠ±æŒ‰ç…§è¡Œä¸ºè¿›è¡Œç±»çš„åˆ’åˆ†ï¼Œå› æ­¤ç³»ç»Ÿä¸­ä¼šå­˜åœ¨å¤§é‡çš„ç±»ã€‚å¦‚æœä¸åŒçš„ç±»ä¹‹é—´éƒ½è¦ç›¸äº’å¼•ç”¨æ¥å®Œæˆä¸€ä¸ªè¡Œä¸ºçš„è¯ä¸ç¬¦åˆé¢å‘å¯¹è±¡çš„ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦æœ‰ä¸€ä¸ªä¸­ä»‹æ¥å°†æœåŠ¡èšåˆèµ·æ¥ï¼Œç›¸å½“äºå°†ç»†å°çš„è¡Œä¸ºè¿›è¡Œä¸€æ¬¡èšåˆå½¢æˆè¾ƒå¤§çš„è¡Œä¸ºï¼Œè¿™æ ·ä¸ç”¨å…³æ³¨ç»†å°çš„è¡Œä¸ºå¯¹è±¡ã€‚</p><h3 id="ç»“æ„-v5"><a class="header-anchor" href="#ç»“æ„-v5"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/mediator_pattern_uml_diagram.jpg" alt="ä¸­ä»‹è€…æ¨¡å¼"></p><p>ä¸­ä»‹è€…æ¨¡å¼åœ¨åŠŸèƒ½ä¸Šç±»ä¼¼äºé—¨é¢æ¨¡å¼ï¼Œä½†æ˜¯é—¨é¢æ¨¡å¼ç€é‡äºå¯¹å­ç³»ç»Ÿç±»çš„å°è£…ï¼Œä¸­ä»‹è€…æ¨¡å¼ç€é‡æ˜¯å¯¹è¡Œä¸ºçš„å°è£…å’Œè°ƒå’Œå„ä¸ªå­è¡Œä¸ºä»è€Œå½¢æˆä¸€ä¸ªå¤§çš„è¡Œä¸ºï¼Œå› æ­¤é—¨é¢æ¨¡å¼æ˜¯ç»“æ„å‹è€Œä¸­ä»‹è€…æ¨¡å¼æ˜¯è¡Œä¸ºå‹ã€‚</p><h2 id="å¤‡å¿˜å½•æ¨¡å¼"><a class="header-anchor" href="#å¤‡å¿˜å½•æ¨¡å¼"></a>å¤‡å¿˜å½•æ¨¡å¼</h2><h3 id="æ„å›¾-v6"><a class="header-anchor" href="#æ„å›¾-v6"></a>æ„å›¾</h3><p>åœ¨ä¸ç ´åå¯¹è±¡å°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶å°†è¯¥çŠ¶æ€ä¿å­˜åœ¨å¯¹è±¡ä¹‹å¤–ã€‚åœ¨éœ€è¦æ—¶ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªæ•°æ®è¿›è¡Œæ¢å¤ã€‚ç±»ä¼¼äºæ¸¸æˆä¸­çš„å­˜æ¡£ç‚¹è®¾ç½®ã€‚</p><h3 id="åˆ«å-v2"><a class="header-anchor" href="#åˆ«å-v2"></a>åˆ«å</h3><p>token</p><h3 id="åŠ¨æœº-v5"><a class="header-anchor" href="#åŠ¨æœº-v5"></a>åŠ¨æœº</h3><p>å¤‡å¿˜å½•æ¨¡å¼é’ˆå¯¹äºé‚£äº›éœ€è¦è¿›è¡Œæš‚å­˜çš„æ•°æ®æˆ–å¯¹è±¡ï¼Œåœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ã€‚</p><h3 id="ç»“æ„-v6"><a class="header-anchor" href="#ç»“æ„-v6"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/memento_pattern_uml_diagram.jpg" alt="å¤‡å¿˜å½•æ¨¡å¼"></p><p>CareTaker.java è´Ÿè´£ä¿å­˜æ¯ä¸ªé˜¶æ®µçš„å¯¹è±¡çŠ¶æ€</p><h2 id="è§‚å¯Ÿè€…æ¨¡å¼"><a class="header-anchor" href="#è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h2><h3 id="æ„å›¾-v7"><a class="header-anchor" href="#æ„å›¾-v7"></a>æ„å›¾</h3><p>å®šä¹‰å¯¹è±¡ä¹‹é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘é€æ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½ä¼šå¾—åˆ°é€šçŸ¥</p><h3 id="åˆ«å-v3"><a class="header-anchor" href="#åˆ«å-v3"></a>åˆ«å</h3><p>ä¾èµ–(Dependents),å‘å¸ƒ-è®¢é˜…(Publish-Subscribe)</p><h3 id="åŠ¨æœº-v6"><a class="header-anchor" href="#åŠ¨æœº-v6"></a>åŠ¨æœº</h3><p>åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜ä¼šå¯¼è‡´å¼•èµ·ç›¸å…³å¯¹è±¡çš„æ”¹å˜ï¼Œå¦‚æœè¦ä¿æŒè¿™æ ·çš„ä¸€è‡´æ€§ä¼šå¯¼è‡´å¯¹è±¡é—´å¼ºä¾èµ–ã€‚è§‚å¯Ÿè€…æ¨¡å¼å°±æ˜¯é€šè¿‡å‘å¸ƒ-è®¢é˜…æ¨¡å¼å°†é€šçŸ¥çš„èŒè´£ä»åŠ¨ä½œç±»ä¸­å¼ºåˆ¶ä¾èµ–è½¬æ¢ä¸ºé€šçŸ¥çš„æ¨¡å¼</p><h3 id="ç»“æ„-v7"><a class="header-anchor" href="#ç»“æ„-v7"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/observer_pattern_uml_diagram.jpg" alt="è§‚å¯Ÿè€…æ¨¡å¼"></p><p>Subjectä½œä¸ºè¢«è§‚å¯Ÿè€…ä¸­ç»´æŠ¤ä¸€ä¸ªæ‰€æœ‰è§‚å¯Ÿè€…çš„å¼•ç”¨ï¼ŒObserverä½œä¸ºè¢«è§‚å¯Ÿè€…ç»´æŠ¤ä¸€ä¸ªSubjectçš„å¼•ç”¨ï¼Œå°†è‡ªå·±ç»„æˆåˆ°è¢«è§‚å¯Ÿè€…ä¸­<br>å¯å‚è€ƒ<br><a href="../../../../../2020/05/06/3.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/#more">è§‚å¯Ÿè€…æ¨¡å¼</a></p><h3 id="å®ä¾‹-v3"><a class="header-anchor" href="#å®ä¾‹-v3"></a>å®ä¾‹</h3><p>springä¸­çš„ApplicationListenerå’ŒApplicationEventã€ApplicationEventPublisherAwareåˆ†åˆ«ä½œä¸ºè¢«è§‚å¯Ÿè€…ã€è§‚å¯Ÿè€…å’Œå®¢æˆ·ç«¯</p><h2 id="çŠ¶æ€æ¨¡å¼"><a class="header-anchor" href="#çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h2><h3 id="æ„å›¾-v8"><a class="header-anchor" href="#æ„å›¾-v8"></a>æ„å›¾</h3><p>å…è®¸ä¸€ä¸ªå¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚ä»è¡¨è±¡ä¸Šæ¥çœ‹å°±æ˜¯å¯¹è±¡å¯ä»¥æ ¹æ®å†…éƒ¨çŠ¶æ€æ‰§è¡Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘ã€‚</p><h3 id="åŠ¨æœº-v7"><a class="header-anchor" href="#åŠ¨æœº-v7"></a>åŠ¨æœº</h3><p>ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºå–å†³äºå†…éƒ¨çŠ¶æ€è¿›è¡Œé©±åŠ¨æ—¶ï¼ŒçŠ¶æ€æ¨¡å¼å¯ä»¥å°†çŠ¶æ€å’Œè¡Œä¸ºåˆ†ç¦»ï¼Œå‡å°‘åˆ†æ”¯çš„æ¡ä»¶è¯­å¥ã€‚</p><h3 id="ç»“æ„-v8"><a class="header-anchor" href="#ç»“æ„-v8"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/state_pattern_uml_diagram.png" alt="çŠ¶æ€æ¨¡å¼"></p><p>å¯ä»¥çœ‹åˆ°doAction()æ–¹æ³•ä¸­æ‰ä¼šæ‰§è¡Œå…·ä½“çš„è¡Œä¸ºï¼Œä¸åŒçš„çŠ¶æ€å…·æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œé€šè¿‡contextç»´æŠ¤çŠ¶æ€ï¼Œå½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¯¹åº”çš„è¡Œä¸ºä¹Ÿéšä¹‹å‘ç”Ÿæ”¹å˜</p><h2 id="ç­–ç•¥æ¨¡å¼"><a class="header-anchor" href="#ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h2><h3 id="æ„å›¾-v9"><a class="header-anchor" href="#æ„å›¾-v9"></a>æ„å›¾</h3><p>ç­–ç•¥æ¨¡å¼æ˜¯å°†ä¸åŒçš„ç®—æ³•å•ç‹¬å®šä¹‰èµ·æ¥ï¼Œé€šè¿‡ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸åŒçš„ç®—æ³•ã€‚å°†å®¢æˆ·ç«¯ä¸­çš„æ¡ä»¶åˆ†æ”¯å»æ‰ï¼Œå¹¶ä¸”æ”¯æŒæ‰©å±•ã€‚</p><h3 id="ç»“æ„-v9"><a class="header-anchor" href="#ç»“æ„-v9"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/strategy_pattern_uml_diagram.jpg" alt="ç­–ç•¥æ¨¡å¼"></p><p>Contextä¸­çš„strategyç±»æ˜¯å…·ä½“æ‰§è¡Œçš„ç®—æ³•ï¼Œè¿™é‡Œæœ‰ä¸¤ç§è®¾è®¡æ–¹æ¡ˆï¼Œç¬¬ä¸€ç§å°±æ˜¯UMLå›¾ä¸­çš„å†™æ³•ï¼Œå°†Contetxxä½œä¸ºæ¯æ¬¡è¡ŒåŠ¨çš„å®¹å™¨ï¼Œæ¯æ¬¡æ‰§è¡Œå‰éƒ½å…ˆè¿›è¡Œèµ‹å€¼ã€‚ç¬¬äºŒç§æ˜¯ContextæŒæœ‰ä¸€ä¸ªStrategyçš„Listæ ¹æ®æ·»åŠ é€‰æ‹©ç®—æ³•ã€</p><p>ç­–ç•¥æ¨¡å¼åœ¨å®é™…å·¥ä½œä¸­å¤§é‡ä½¿ç”¨åˆ°ï¼Œå› ä¸ºæ¶ˆé™¤äº†æ¡ä»¶åˆ¤æ–­å‡å°‘äº†åˆ†æ”¯ã€‚é€šè¿‡å¢åŠ ç±»çš„æ–¹å¼æ¥å‡å°‘åˆ†æ”¯ï¼Œç»“æ„ä¸Šä¾¿äºæ‰©å±•äº†</p><h2 id="æ¨¡æ¿æ¨¡å¼"><a class="header-anchor" href="#æ¨¡æ¿æ¨¡å¼"></a>æ¨¡æ¿æ¨¡å¼</h2><h3 id="æ„å›¾-v10"><a class="header-anchor" href="#æ„å›¾-v10"></a>æ„å›¾</h3><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•çš„éª¨æ¶ï¼Œé€šè¿‡ç»§æ‰¿çš„æ–¹å¼è®©å­ç±»å¯ä»¥æ”¹å˜ç‰¹ç‚¹è¡Œä¸ºï¼Œä½¿å¾—ä¸ç”¨é‡æ–°å®šä¹‰ç®—æ³•çš„é¡ºåºå°±èƒ½æ”¹å˜è¡Œä¸ºã€‚</p><h3 id="åŠ¨æœº-v8"><a class="header-anchor" href="#åŠ¨æœº-v8"></a>åŠ¨æœº</h3><p>æ¨¡æ¿æ–¹æ³•çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³é‡å¤å®šä¹‰çš„ç®—æ³•æ‰§è¡Œé¡ºåºå¹¶ä¸”å…·ä½“æ‰§è¡Œæœ‰å·®å¼‚çš„åœºæ™¯</p><h3 id="ç»“æ„-v10"><a class="header-anchor" href="#ç»“æ„-v10"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/template_pattern_uml_diagram.jpg" alt="æ¨¡æ¿æ¨¡å¼"></p><p>æ¨¡æ¿æ¨¡å¼ä¸ç­–ç•¥æ¨¡å¼çš„åŒºåˆ«åœ¨äºæ¨¡æ¿æ¨¡å¼æ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ¥æ”¹å˜è¡Œä¸ºï¼Œç­–ç•¥æ¨¡å¼æ˜¯é€šè¿‡æ”¹å˜å§”æ‰˜å¯¹è±¡çš„æ–¹å¼æ¥æ”¹å˜è¡Œä¸ºï¼›ç­–ç•¥æ¨¡å¼é’ˆå¯¹çš„åœºæ™¯æ˜¯ç›¸åŒç±»åœ¨å¤„ç†ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æ—¶å€™ç®—æ³•çš„é€‰æ‹©é—®é¢˜ï¼Œæ¨¡æ¿æ¨¡å¼é’ˆå¯¹çš„æ˜¯ç›¸åŒçš„ç±»åœ¨å¤„ç†ç›¸åŒçš„ä¸šåŠ¡åœºæ™¯ä¸‹ç®—æ³•ç»†å¾®çš„å·®å¼‚ç»“æ„ä¸Šã€‚</p><h2 id="è®¿é—®è€…æ¨¡å¼"><a class="header-anchor" href="#è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h2><h3 id="æ„å›¾-v11"><a class="header-anchor" href="#æ„å›¾-v11"></a>æ„å›¾</h3><p>å°†æ•°æ®å’Œæ•°æ®æ“ä½œåˆ†ç¦»</p><h3 id="åŠ¨æœº-v9"><a class="header-anchor" href="#åŠ¨æœº-v9"></a>åŠ¨æœº</h3><p>å¯¹ä¸€ä¸ªå¯¹è±¡éœ€è¦è¿›è¡Œå¤šæ¬¡æ“ä½œæ—¶ï¼Œä¸ºäº†é¿å…è¿™äº›æ“ä½œå°†å¯¹è±¡æ±¡æŸ“ï¼Œå¯ä»¥é€šè¿‡è®¿é—®è€…æ¨¡å¼å°†æ•°æ®å’Œæ“ä½œè¿›è¡Œéš”ç¦»ã€‚å®ç°ä¸åŒçš„è®¿é—®è€…è®¿é—®ä¸åŒçš„æ•°æ®ã€‚</p><h3 id="ç»“æ„-v11"><a class="header-anchor" href="#ç»“æ„-v11"></a>ç»“æ„</h3><p><img src="https://www.runoob.com/wp-content/uploads/2014/08/visitor_pattern_uml_diagram.jpg" alt="è®¿é—®è€…æ¨¡å¼"></p><p>è®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ˜¯åœ¨äºæ•°æ®å¯¹è±¡ä¼šé’ˆå¯¹ä¸åŒçš„è®¿é—®è€…å®šä¹‰å‡ºä¸åŒçš„è¡Œä¸ºï¼Œç”±äºè®¿é—®è€…çŸ¥é“è¢«è®¿é—®çš„æ•°æ®å¯¹è±¡ä¸­çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤è®¿é—®è€…å¯ä»¥æ ¹æ®ä¸åŒçš„å¯¹è±¡å®šä¹‰å‡ºä¸åŒçš„è¡Œä¸º</p><p>è®¿é—®è€…çš„å¥½å¤„åœ¨äºå°†æ•°æ®å¯¹è±¡çš„æ“ä½œå»¶è¿Ÿåˆ°çš„è®¿é—®è€…é‚£ä¸€æ­¥ä¸­å»äº†ï¼Œé€šè¿‡å®šä¹‰ä¸åŒçš„è®¿é—®è€…å¯ä»¥æ‰§è¡Œä¸åŒçš„åŠ¨ä½œã€‚</p><h2 id="è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾"><a class="header-anchor" href="#è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾"></a>è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾</h2><p><a href="https://imgtu.com/i/gJVn2Q"><img src="https://z3.ax1x.com/2021/05/08/gJVn2Q.png" alt="è®¾è®¡æ¨¡å¼æ€ç»´å¯¼å›¾"></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶è®¾è®¡çš„åŸºç¡€-è¡Œä¸ºæ¨¡å¼&lt;/h1&gt;
&lt;p&gt;è¡Œä¸ºæ¨¡å¼æ˜¯é€šè¿‡å°†å¤šä¸ªç±»é€šè¿‡ç»§æ‰¿\ç»„åˆçš„å½¢å¼å½¢æˆå¯¹æ–¹æ³•çš„å¤„ç†,ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è´£ä»»é“¾æ¨¡å¼&lt;/li&gt;
&lt;li&gt;å‘½ä»¤æ¨¡å¼&lt;/li&gt;
&lt;li&gt;è§£é‡Šå™¨æ¨¡å¼&lt;/li&gt;
&lt;li&gt;è¿­ä»£å™¨æ¨¡å¼&lt;/l</summary>
      
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://agmtopy.gitee.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://agmtopy.gitee.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
</feed>
