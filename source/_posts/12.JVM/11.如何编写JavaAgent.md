---
title: å¦‚ä½•ç¼–å†™JavaAgent
date: 2021-07-03 23:11:15
categories: jvm
tags:
  - jvm
  - agent
---

# å¦‚ä½•ç¼–å†™JavaAgent
è¿™ç¯‡æ–‡ç« æ˜¯æ ¹æ®MegaEaseçš„è¢ä¼Ÿè€å¸ˆçš„åˆ†äº«è€Œæ¥,åœ°å€æ˜¯[How To Write a JavaAgent](https://www.youtube.com/watch?v=ujhqct2POLU)

## ç®€ä»‹

### java agentæ˜¯ä»€ä¹ˆï¼Ÿ
java agentæ˜¯jdk1.5æ—¶å€™æ¨å‡ºçš„ä¸€ä¸ªåœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹class,ä»è€Œè¾¾åˆ°åŠ¨æ€ä¿®æ”¹è¡Œä¸ºçš„ç›®çš„

### èƒ½åšä»€ä¹ˆï¼Ÿ
åŠŸèƒ½ä¸AOPç±»ä¼¼ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨ä¸å½»åº•å’Œä¸šåŠ¡ä»£ç éš”ç¦»ï¼Œå¯ä»¥å®ŒæˆAOPç›¸åŒçš„äº‹æƒ…ï¼Œå¹¶ä¸”ä¸å…¥ä¾µä¸šåŠ¡ä»£ç ï¼Œé€‚åˆäºæ—¥å¿—é‡‡é›†ã€é“¾è·¯è¿½è¸ªç­‰åŸºç¡€ç»„ä»¶


## ç”¨æ³•
java agentä¸»è¦å¯ä»¥åœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹è¿›è¡ŒåŠ è½½ï¼š
1. JVMå¯åŠ¨æ—¶
2. ç›®æ ‡æ–¹æ³•è¿è¡Œæ—¶

#### é¡¹ç›®ç»“æ„
![é¡¹ç›®ç»“æ„](https://i.loli.net/2021/07/11/uUxsh1JqQzaSXAW.png)


#### å¯åŠ¨æ—¶åŠ è½½ç¤ºä¾‹

- AgentExampleDemo

```java
    public class AgentExampleDemo {
        public static void premain(String agentArgs, Instrumentation instrumentation) {
            System.out.println("premain start...");
        }
    }
```

- AgentTarget

```java
  public class AgentTarget {
    public static void main(String[] args) {
        System.out.println("å¼€å§‹æ‰“å°....");
    }
  }
```

- build.gradle

```bash
  //é‡æ–°å®šä¹‰MANIFEST.MF
  jar {
    manifest {
        attributes 'Premain-Class': 'com.agmtopy.source.agent.AgentExampleDemo'
    }
}
```

- javaagentå¯åŠ¨å‚æ•°

```bash
  -javaagent:build/libs/jvmsource-1.0-SNAPSHOT.jar
```

![Ideaè®¾ç½®](https://i.loli.net/2021/07/11/kH6wQJD5my7bxuX.png)


- è¿è¡Œç»“æœ

[![ç»“æœ](https://z3.ax1x.com/2021/07/07/R7rfyV.png)](https://imgtu.com/i/R7rfyV)

> è¿™æ˜¯ç¬¬ä¸€ç§ä½¿ç”¨agentçš„æ–¹å¼,åœ¨ç›®æ ‡ä»£ç è¿è¡Œå‰ä½¿ç”¨,java agentä»£ç ä¸ç›®æ ‡æ–¹æ³•è¿›è¡Œç»„åˆçš„æ–¹å¼è¿›è¡Œæ‰§è¡Œ

### è¿è¡Œæ—¶åŠ è½½ç¤ºä¾‹

ç›®æ ‡æ–¹æ³•è¿œè¡Œæ—¶åŠ è½½è¦ä½¿ç”¨åˆ°javassistè¿™ä¸ªå·¥å…·å¸®åŠ©æˆ‘ä»¬ä¿®æ”¹class,æ³¨æ„javassistæœ‰ä¸¤ä¸ªé¡¹ç›®,è¦ä½¿ç”¨<b>org.javassist</b>ğŸ˜‚æ‰å¯ä»¥

```gradle
    implementation "org.javassist:javassist:3.28.0-GA"
```

1. ä¿®æ”¹AgentTarget

ä¿æŒjvmè¿è¡Œ,ä»¥ä¾¿é€šè¿‡Attachçš„æ–¹å¼è¿›è¡Œæ›¿æ¢

```java
    public class AgentTarget {
        public static void main(String[] args) throws Exception {
            System.out.println("å¼€å§‹æ‰“å°....");
            while (true) {
                TimeUnit.SECONDS.sleep(5);
                println();
            }
        }

        public static void println() {
            System.out.println(LocalTime.now());
        }
    }
```


2. åœ¨AgentExampleDemoä¸­å¢åŠ agentmainæ–¹æ³•

- AgentExampleDemo

```java
    /**
     * attach:æ–¹å¼è¿è¡Œ
     */
    public static void agentmain(String agentArgs, Instrumentation inst) {
        System.out.println("agentmain start...");
        // æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
        inst.addTransformer(new ShowExecTime(), true);
        try {
            //é‡å†™è½½å…¥æ–°çš„å­—èŠ‚ç 
            inst.retransformClasses(AgentTarget.class);
        } catch (UnmodifiableClassException e) {
            e.printStackTrace();
        }
    }
```

3. å¢åŠ ShowExecTimeæ¥ä¿®æ”¹å­—èŠ‚ç 

- ShowExecTime

```java
    /**
    * è‡ªå®šä¹‰ClassFileTransformer
    */
    public class ShowExecTime implements ClassFileTransformer {

        @Override
        public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
            //åªé’ˆå¯¹ç›®æ ‡åŒ…ä¸‹è¿›è¡Œè€—æ—¶ç»Ÿè®¡
            if (!className.startsWith("com/agmtopy/source/agent")) {
                return classfileBuffer;
            }
            System.out.println("æ­£åœ¨åŠ è½½ç±»ï¼š" + className);

            try {
                ClassPool classPool = ClassPool.getDefault();
                classPool.appendClassPath(new LoaderClassPath(loader));

                CtClass cl = classPool.makeClass(new ByteArrayInputStream(classfileBuffer));
                // æ‰€æœ‰æ–¹æ³•ï¼Œç»Ÿè®¡è€—æ—¶
                for (CtMethod method : cl.getDeclaredMethods()) {
                    System.out.println("å¼€å§‹ä¿®æ”¹:" + method +" æ–¹æ³•" );
                    //éœ€è¦é€šè¿‡`addLocalVariable`æ¥å£°æ˜å±€éƒ¨å˜é‡
                    method.addLocalVariable("start", CtClass.longType);
                    //æ’å…¥ å¼€å§‹è¯­å¥
                    method.insertBefore("start = java.lang.System.currentTimeMillis();");
                    String methodName = method.getLongName();
                    //åˆ›å»ºå¹¶æ’å…¥ æ‰“å°è¯­å¥ System.out.println("æ–¹æ³•ï¼štestï¼Œ æ‰§è¡Œæ—¶é—´ï¼š" + (System.currentTimeMillis() - start));
                    String statement = String.format("java.lang.System.out.println(\"æ–¹æ³•ï¼š%sï¼Œ æ‰§è¡Œæ—¶é—´ï¼š\" + (java.lang.System.currentTimeMillis() - start));", methodName);
                    method.insertAfter(statement);
                }

                byte[] transformed = cl.toBytecode();
                return transformed;
            } catch (Exception e) {
                e.printStackTrace();
            }
            return classfileBuffer;
        }
    }
```

transform()æ–¹æ³•æ˜¯é€šè¿‡javassistæ¥ä¿®æ”¹å­—èŠ‚ç ,åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥å±€éƒ¨å˜é‡ï¼Œç„¶åæ‰“å°æ–¹æ³•æ‰§è¡Œè€—æ—¶

4. è¿è¡Œjarè¿›è¡Œæ›¿æ¢å­—èŠ‚ç æ›¿æ¢

```java
    /**
     * ä¿®æ”¹æŒ‡å®šè¿è¡Œä¸­çš„ä»£ç 
     */
    public static void main(String[] args) throws Exception {
        // ä¼ å…¥ç›®æ ‡ JVM pid
        VirtualMachine vm = VirtualMachine.attach("6068");
        vm.loadAgent("D:\\project\\jvmsource\\build\\libs\\jvmsource-1.0-SNAPSHOT.jar");
    }
```


5. ä¿®æ”¹MANIFEST.MF
éœ€è¦å°†<b>Agent-Class</b>å†™å…¥MANIFEST.MFæ–‡ä»¶

- gradle

```gradle
    jar {
        manifest {
            attributes 'Can-Redefine-Classes': true
            attributes 'Can-Retransform-Classes': true
            attributes 'Agent-Class': 'com.agmtopy.source.agent.AgentExampleDemo'
            attributes 'Premain-Class': 'com.agmtopy.source.agent.AgentExampleDemo'
        }
    }

```


6. æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢

6.1 å…ˆå°†é¡¹ç›®æ„å»ºæˆä¸ºjaråŒ…
6.2 è¿è¡ŒAgentTarget
ä¸éœ€è¦ä½¿ç”¨-javaagentçš„æ–¹å¼è¿›è¡Œå¯åŠ¨
![AgentTargetç»“æœ](https://i.loli.net/2021/07/11/d3kZXA769yheB8L.png)
6.3 æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢

- è¿è¡Œç»“æœ
![è¿è¡Œç»“æœ](https://i.loli.net/2021/07/11/bksIl8USHRMc72d.png)



## æºç åˆ†æ
java agentçš„åŸç†æ ¹æ®åŠ è½½æ—¶æœºè¿˜æ˜¯å¯ä»¥åˆ†ä¸ºä¸¤ç±»å…¥å£ï¼Œä¸€ç±»æ˜¯å¯åŠ¨æ—¶å°†agent classæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šï¼Œå¦å¤–ä¸€ç±»å…¥å£æ˜¯è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼Œé‡‡ç”¨çš„æ˜¯JVM attachæŠ€æœ¯

### å¯åŠ¨æ—¶åŠ è½½åŸç†åˆ†æ

#### åˆ†æç›®æ ‡æ–¹æ³•è°ƒç”¨é“¾

```java
  public class AgentExampleDemo {

      public static void premain(String agentArgs, Instrumentation instrumentation) {
          System.out.println("premain start...");
          println(Thread.currentThread().getStackTrace());
      }

      //æ‰“å°è°ƒç”¨æ ˆ
      public static void println(StackTraceElement[] elements) {
          for (int i = 0; i < elements.length; i++) {
              StringBuffer buffer = new StringBuffer();
              buffer.append("index: ").append(i).append(" ClassName: ").append(elements[i].getClassName())
                      .append(" Method Name : " + elements[i].getMethodName());
              System.out.println(buffer.toString());
          }
      }
  }
```

![è°ƒç”¨æ ˆ](https://i.loli.net/2021/07/07/f4o2qQryOKwpWPL.png)

é€šè¿‡è°ƒç”¨æ ˆå¯ä»¥åˆ†æå‡ºæ˜¯<B>InstrumentationImpl</B>è°ƒç”¨<B>premain()</B>æ–¹æ³•çš„,ä¸‹é¢å¼€å§‹åˆ†æInstrumentationImpl

#### InstrumentationImpl

```java
  public class InstrumentationImpl implements Instrumentation 
```

<B>InstrumentationImpl</B>å®ç°<B>Instrumentation</B>,<B>Instrumentation</B>æ¥å£æ˜¯JVMå®šä¹‰å¯¹å­—èŠ‚ç æ“ä½œçš„æ¥å£ï¼Œæˆ‘ä»¬æŒ‰ç…§è°ƒç”¨é“¾çš„é¡ºåºå€’å™è¿›è¡Œåˆ†æï¼ˆæ‰§è¡Œã€è§¦å‘ï¼‰

1. permainæ‰§è¡Œè¿‡ç¨‹åˆ†æ

ç”±äº<B>InstrumentationImpl.loadClassAndCallPremain()</B>æ–¹æ³•å·²ç»æœ€é¡¶å±‚çš„javaä»£ç å…¥å£ï¼Œé€šè¿‡æ–¹æ³•åç§°æŸ¥æ‰¾å¯ä»¥åœ¨<B>JPLISAgent.h</B>æ–‡ä»¶ä¸­æŸ¥è¯¢åˆ°è¯¥æ–¹æ³•åç§°è¢«å®šä¹‰æˆä¸ºä¸€ä¸ªå¸¸é‡

- JPLISAgent.h

```C
  #define JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODNAME      "loadClassAndCallPremain"
```
è¯¥å¸¸é‡è¢«<B>JPLISAgent.c</B>çš„<B>createInstrumentationImpl</B>æ–¹æ³•æ‰€ä½¿ç”¨

- JPLISAgent.c

```C
jboolean createInstrumentationImpl(JNIEnv *jnienv,JPLISAgent *agent)
{
    //çœç•¥....
    /* Now look up the method ID for the pre-main caller (we will need this more than once) */
    if (!errorOutstanding)
    {
        //â‘ è·å–åˆ°è°ƒç”¨permainæ–¹æ³•MethodId
        premainCallerMethodID = (*jnienv)->GetMethodID(jnienv,
                                                       implClass,
                                                       JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODNAME,
                                                       JPLIS_INSTRUMENTIMPL_PREMAININVOKER_METHODSIGNATURE);
    }

    if (!errorOutstanding)
    {
        agent->mInstrumentationImpl = resultImpl;
        //â‘¡æŒ‡é’ˆèµ‹å€¼
        agent->mPremainCaller = premainCallerMethodID;
        agent->mAgentmainCaller = agentmainCallerMethodID;
        agent->mTransform = transformMethodID;
    }
    
    //çœç•¥....
    return !errorOutstanding;
}
```
è¿™æ®µæ–¹æ³•ä¸»è¦æ˜¯åšä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€æ˜¯è·å–åˆ°è°ƒç”¨permainæ–¹æ³•MethodIdï¼›ç¬¬äºŒä»¶äº‹æ˜¯å°†è¿™ä¸ªMethodIdä¼ é€’å‡ºå»,åˆ†æmPremainCallerçš„ä½¿ç”¨å¯ä»¥å¾—åˆ°è¯¥å€¼åœ¨'processJavaStart'ä¸­ä½¿ç”¨

![mPremainCaller](https://i.loli.net/2021/07/07/WbT3LyNCQilShcv.png)

- processJavaStart

```C
  result = startJavaAgent(agent, jnienv,
                          agent->mAgentClassName, 
                          agent->mOptionsString,
                          agent->mPremainCaller);
```

processJavaStarté€šè¿‡å‰é¢è·å–åˆ°çš„MethodIdå¯åŠ¨javaAgentï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ<B>statrJavaAgent</B>

- statrJavaAgent

```java
  //...
  success = invokeJavaAgentMainMethod(jnienv,
                                      agent->mInstrumentationImpl,
                                      agentMainMethod,
                                      classNameObject,
                                      optionsStringObject);

```
è°ƒç”¨</B>invokeJavaAgentMainMethod</B>ä¼ å…¥å¯¹è±¡ã€æ–¹æ³•IDã€å®å‚ï¼Œæ‰§è¡Œå®šä¹‰çš„premainæ–¹æ³•

é€šè¿‡ä¸Šé¢çš„åˆ†æçŸ¥é“äº†permaiæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œç»§ç»­çœ‹ä¸€ä¸‹permainæ–¹æ³•æ˜¯å¦‚ä½•è§¦å‘çš„

2. permainè§¦å‘è¿‡ç¨‹åˆ†æ

<B>processJavaStart</B>æ–¹æ³•æ˜¯æ‰§è¡Œpermainçš„å…¥å£ï¼Œå®ƒåœ¨<B>JPLISAgent.h</B>ä¸­è¿›è¡Œå®šä¹‰çš„,åœ¨æºä»£ç ä¸­å…¨å±€æœç´¢ï¼š<B> JPLISAgent *</B>å¯ä»¥æ‰¾åˆ°JPLISAgentæ˜¯åœ¨<InvocationAdapter.c>ä¸­é‡æ–°è¿›è¡Œè¿‡èµ‹å€¼

- InvocationAdapter.c

```C
  void JNICALL eventHandlerVMInit(jvmtiEnv *jvmtienv,
                      JNIEnv *jnienv,
                      jthread thread)
    {
        JPLISAgent *agent = environment->mAgent;
    }
```

<B>eventHandlerVMInit</B>æ–¹æ³•åœ¨<B>JPLISAgent.c</B>çš„<B>initializeJPLISAgent</B>æ–¹æ³•ä¸­è¢«è®¾ç½®ä¸ºå›è°ƒæ–¹æ³•

- initializeJPLISAgent

```C
    //å…³é”®æ‰§è¡Œé€»è¾‘
    if (jvmtierror == JVMTI_ERROR_NONE)
    {
        jvmtiEventCallbacks callbacks;
        memset(&callbacks, 0, sizeof(callbacks));
        //è®¾ç½®JVMå›è°ƒ
        callbacks.VMInit = &eventHandlerVMInit;

        jvmtierror = (*jvmtienv)->SetEventCallbacks(jvmtienv,
                                                    &callbacks,
                                                    sizeof(callbacks));
        check_phase_ret_blob(jvmtierror, JPLIS_INIT_ERROR_FAILURE);
        jplis_assert(jvmtierror == JVMTI_ERROR_NONE);
    }

```
é€šè¿‡è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–JPLISAgentæ—¶å€™å°±è®¾ç½®äº†JVMåˆå§‹åŒ–å®Œæˆåä¼šå›è°ƒInvocationAdapteræ¥æ‰§è¡Œ<B>permain</B>æ–¹æ³•


3. JPLISAgentçš„åˆå§‹åŒ–

å›æº¯<B>initializeJPLISAgent</B>æ–¹æ³•å¯ä»¥æ‰¾åˆ°åˆ†åˆ«åœ¨<B>InvocationAdapter.c</B>çš„<B>DEF_Agent_OnLoad</B>ã€<B>DEF_Agent_OnAttach</B>ä¸Šè¢«è°ƒç”¨ã€‚è¿™ä¸¤ç§æ–¹å¼ä¹Ÿæ­£æ˜¯å‰é¢è®²åˆ°çš„agentçš„ä¸¤ç§å¢å¼ºæ–¹å¼çš„å…¥å£ã€‚

åœ¨JVMå¯åŠ¨æ—¶æœ€å¼€å§‹åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢æ‰¾åˆ°JVMTIçš„å…¥å£æ–¹æ³•ï¼šAgent_OnLoadå’ŒAgent_OnAttachã€‚InvocationAdapter.cçš„å®šä¹‰

- InvocationAdapter.c

```C

    /*
    *  This will be called once for every -javaagent on the command line.
    *  Each call to Agent_OnLoad will create its own agent and agent data.
    *
    *  The argument tail string provided to Agent_OnLoad will be of form
    *  <jarfile>[=<options>]. The tail string is split into the jarfile and
    *  options components. The jarfile manifest is parsed and the value of the
    *  Premain-Class attribute will become the agent's premain class. The jar
    *  file is then added to the system class path, and if the Boot-Class-Path
    *  attribute is present then all relative URLs in the value are processed
    *  to create boot class path segments to append to the boot class path.
    */
    JNIEXPORT jint JNICALL
    DEF_Agent_OnLoad(JavaVM *vm, char *tail, void *reserved)

    /*
    *  This will be called once each time a tool attaches to the VM and loads
    *  the JPLIS library.
    */
    JNIEXPORT jint JNICALL
    DEF_Agent_OnAttach(JavaVM *vm, char *args, void *reserved)

```


4. æ•´ä½“é€»è¾‘
æ•´ä½“çš„æ‰§è¡Œé€»è¾‘å°±æ˜¯ï¼š
  - JPLISAgentå£°æ˜JVMå¯åŠ¨æ—¶å€™åˆå§‹åŒ–JPLISAgent
  - JPLISAgentåˆå§‹åŒ–æ—¶è®¾ç½®InvocationAdapterçš„å›è°ƒæ–¹æ³•
  - JVMåˆå§‹åŒ–å®Œæˆåæ‰§è¡Œå›è°ƒæ–¹æ³•
  - InvocationAdapterçš„å›è°ƒæ–¹æ³•æ‰§è¡Œpermainæ–¹æ³•



### è¿è¡Œæ—¶åŠ è½½åŸç†åˆ†æ

1. åˆ†æå­—èŠ‚ç 
ä½¿ç”¨<B>HSDB</B>æŸ¥çœ‹AgentTargetæœªè¿›è¡Œå­—èŠ‚ç æ›¿æ¢å‰çš„æ•°æ®

```bash
    jhsdb hsdb --pid 21656
```


- å¸¸é‡æ± 

![æ›¿æ¢å‰çš„å¸¸é‡æ± ](https://i.loli.net/2021/07/11/phklzJKYTs7IG16.jpg)


![æ›¿æ¢åçš„å¸¸é‡æ± ](https://i.loli.net/2021/07/11/tkaOxIQ62fbs84K.png)
æ˜æ˜¾å¯ä»¥çœ‹åˆ°å¸¸é‡æ± ä¸­å¢åŠ äº†22æ¡æŒ‡ä»¤ï¼Œè¿™22æ¡æŒ‡ä»¤å°±æ˜¯æ–°åŠ å…¥çš„å­—èŠ‚ç æ‰€è¦ä½¿ç”¨åˆ°çš„å¸¸é‡

- æ–¹æ³•åŒº

![æ›¿æ¢å‰çš„æ–¹æ³•åŒº](https://i.loli.net/2021/07/11/3DvWBpyuHQ7I2cM.jpg)


![æ›¿æ¢åçš„æ–¹æ³•åŒº](https://i.loli.net/2021/07/11/e9TObiVwDPH7Whv.jpg)


2. é‡æ–°åŠ è½½å­—èŠ‚ç åŸç†
@TODO

> é€šè¿‡å­—èŠ‚ç å¯¹æ¯”å¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºåœ¨ä½¿ç”¨<B>Instrumentation.addTransformer();</B>åç¡®å®å°†å­—èŠ‚ç è¿›è¡Œäº†ä¿®æ”¹,å…¶å®ä¿®æ”¹å­—èŠ‚ç è¿˜æ˜¯æœ‰ä¸¤ä¸ªæ—¶æœº:
- ä¸€ä¸ªæ˜¯åœ¨å¯åŠ¨ç¼–è¯‘æ—¶,ä¼šåœ¨jvmå¯åŠ¨å®Œæ¯•ååœ¨æ‰§è¡Œpermainæ–¹æ³•æ¥ä¿®æ”¹å­—èŠ‚ç 
- ä¸€ä¸ªå°±æ˜¯åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€çš„ä¿®æ”¹å­—èŠ‚ç 

### æ•´ä½“æ‰§è¡Œé€»è¾‘

![æ•´ä½“æ‰§è¡Œé€»è¾‘](https://i.loli.net/2021/07/11/sCey6D7USV9LRXo.jpg)




## å¼€å‘å·¥å…·
- ASM

- Javassist

- Byte Buddy

### åŠŸèƒ½å¯¹æ¯”

-|ASM|Javassist|Byte Buddy
--|--|--|--
å­¦ä¹ æˆæœ¬|é«˜|ä½|ä½
ä½¿ç”¨æ–¹æ³•|ä½¿ç”¨å­—èŠ‚ç æ–¹å¼è¿›è¡Œæ’å…¥,éœ€è¦äº†è§£classç±»ç»“æ„å’ŒJVMæŒ‡ä»¤é›†|æä¾›é«˜çº§æŠ½è±¡æ¥å£å’Œä½çº§å­—èŠ‚ç æ¥å£|åŒJavassist,å¹¶ä¸”æä¾›å£°æ˜å¼æ¥å£
æ€§èƒ½|æå¿«|ä¸€èˆ¬|å¿«  

è¯¦ç»†çš„å¯¹æ¯”å¯å‚è€ƒbyteBuddyå®˜æ–¹èµ„æ–™:https://bytebuddy.net/#/tutorial


### Byte Buddy


#### ç¤ºä¾‹

- gradle

```gradle
    //ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º1.11.6
    implementation "net.bytebuddy:byte-buddy:LATEST"
```

- AgentExampleForByteBuddy

```java

    public class AgentExampleForByteBuddy {

        @Advice.OnMethodEnter
        public static boolean before(@Advice.Origin Executable method) {
            System.out.println("byte buddy before : " + method);
            return true;
        }

        @Advice.OnMethodExit
        public static void after(@Advice.Origin Executable method) {
            System.out.println("byte buddy after : " + method);
        }

        public static void premain(String arguments, Instrumentation inst) {
            System.out.println("å¼€å§‹æ‰§è¡Œ...");
            new AgentBuilder.Default()
                    .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)
                    .with(AgentBuilder.InstallationListener.StreamWriting.toSystemError())
                    .type(ElementMatchers.nameContains("AgentTarget"))
                    .transform((builder, td, cl, m) -> builder.visit(Advice.to(AgentExampleForByteBuddy.class).on(MethodDescription::isConstructor)))
                    .installOn(inst);
        }
    }

```


- AgentTarget

```java
    public class AgentTarget {
        public static void main(String[] args) throws Exception {
            System.out.println("å¼€å§‹æ‰“å°....");
            AgentTarget agentTarget = new AgentTarget();
            agentTarget.printInfo();
        }

        public void printInfo() {
            System.out.println("123" + LocalTime.now());
        }
    }
```


è¿™é‡Œæ¼”ç¤ºçš„æ˜¯ä¸€ä¸ªé‡å†™åŠ è½½ç±»çš„ç¤ºä¾‹:
1. é€šè¿‡</B>@Advice.OnMethodEnter</B>å’Œ<B>@Advice.OnMethodExit</B>å®šä¹‰æ‰§è¡Œæ–¹æ³•å‰åæ’å…¥çš„å­—èŠ‚ç 
2. é€šè¿‡<B>AgentBuilder</B>æŒ‡å®šè¦å¢å¼ºçš„ç±»å’Œç±»å‹
3. <B>AgentBuilder.with</B>å¯ä»¥æ·»åŠ ç›‘å¬ï¼Œæ–¹ä¾¿è¾“å‡ºè°ƒè¯•



### Byte Byddyå¸¸è§é—®é¢˜

- ä¾èµ–å†²çª

å¤„ç†æ–¹æ¡ˆï¼š
1. æ„å»ºå·¥å…·æ’é™¤

2. ä½¿ç”¨è‡ªå®šä¹‰classLoaderåŠ è½½agentæ‰€ä½¿ç”¨çš„ç±»
  é€šè¿‡æŒ‡å®šagentç±»çš„åŠ è½½å™¨,è®©</B>BootstrapClassLoader</B>å»åŠ è½½

- Byte-Buddyæä¾›çš„API

```java
       ClassInjector.UsingInstrumentation
                .of(FileJar, ClassInjector.UsingInstrumentation.Target.BOOTSTRAP, instrumentation)
                .injectRaw(Collections.singletonMap(instrumentation, ClassFileLocator
                        .ForClassLoader.ofSystemLoader()
                        .locate("com.agmtopy.source.agent.AgentExampleForByteBuddy").resolve()));

```



- java agentä¸­ä¼ å‚

å¤„ç†æ–¹æ¡ˆ:
1. ThreadLocal
2. å¢åŠ ä¸´æ—¶çš„æˆå‘˜å˜é‡



## å‚è€ƒèµ„æ–™
https://asm.ow2.io/
https://www.javassist.org/
https://bytebuddy.net/#/
https://blog.csdn.net/wanxiaoderen/article/details/107079741
https://www.cnblogs.com/old-cha/p/13264114.html
https://www.cnblogs.com/chiangchou/p/javassist.html#_label9
https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html
https://github.com/gzzchh/de-ag