---
title: 多线程是否会影响执行效率
date: 2022-11-15 22:50:30
categories: 杂记
tags:
  - 多线程
---

# 多线程是否会影响执行效率

## 前提
今天一位同事问了一个问题感觉比较有趣,问题简化规范后是这样的
> 在同一机器/操作系统上,使用n个线程处理X个任务是不是和使用n*m个线程处理X个任务效率相同?

这样的观点是基于<B>RR-时间片轮转</B>来进行推导的;我不太认同这种观点,直觉上认为参与处理的任务过多或过少都会影响执行效率;下面先进行这两种观点的推导然后在进行实际的验证

## 时间片轮转

假设前提:
1. 操作系统对进程的调度是采用的<B>时间片轮转</B>算法来进行处理的,时间片划分的大小为1s;
2. 每个Task需要消耗单核CPU执行0.5s
3. 不考虑线程上下文切换耗时

根据以上的前提可以得出下面这个运行图例:

![2Thread执行示例](https://github.com/agmtopy/noteBook/blob/master/png/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%98%AF%E5%90%A6%E4%BC%9A%E5%BD%B1%E5%93%8D%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%871-%E7%AC%AC%201%20%E9%A1%B5.drawio.png?raw=true)

![4Thread执行示例](https://github.com/agmtopy/noteBook/blob/master/png/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%98%AF%E5%90%A6%E4%BC%9A%E5%BD%B1%E5%93%8D%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%871-%E7%AC%AC%202%20%E9%A1%B5.drawio.png?raw=true)

从上图中可以看到无论是2Thread来进行执行还是4Thread来进行执行对于任务的执行耗时其实都是没有任何影响的,因为这其实是1000个Task与2个执行core之间的关系;


这种说法正确的前提必须是满足<B>假设前提</B>中的3点


## 线程过多过少都会影响执行效率

这种观点主要是基于《Java并发编程实战》一书中的观点:

![推算线程池大小](https://github.com/agmtopy/noteBook/blob/master/png/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%AE%BE%E7%BD%AE%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%A4%A7%E5%B0%8F.jpg?raw=true)


N~cpu~ ：指的是执行机器上的物理核心数,额外注意使用容器启动的核心数
U~cpu~ ：指的期望的对CPU的使用率
W/C ：指的是等待时间与计算时间的比例,对于计算密集型与IO密集型这个值还有所区别

例子:

N~Thread~ = 2 * 0.8 * (1 + 10/2) = 8

如果需要N~Thread~持续增长时需要<B>W/C</B>比例更大,这是不可能实现的,由于w/c是由于Task决定的;
以上是通过反证法的方式来解释提高N~Thread~ 并不能增加并发执行效率的原因;

实际在运用过程中还需要注意<B>Amdahl定律</B>和线程引入造成的性能开销

![Amdahl定律](https://github.com/agmtopy/noteBook/blob/master/png/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/amdahl%E5%AE%9A%E5%BE%8B.jpg?raw=true)

Amdahl定律就是表达并发执行线程池数并不能提高效率,而是并发度提高才能提高执行效率


![线程引入造成的性能开销](https://github.com/agmtopy/noteBook/blob/master/png/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%BA%BF%E7%A8%8B%E5%BC%95%E5%85%A5%E7%9A%84%E5%BC%80%E9%94%80.jpg?raw=true)

频繁的线程切换会引起性能损耗








## 参考资料

[Threads configuration based on no. of CPU-cores](https://stackoverflow.com/questions/13834692/threads-configuration-based-on-no-of-cpu-cores/13958877#13958877)
[Amdahl's law](https://en.wikipedia.org/wiki/Amdahl%27s_law)
[Amdahl's Law in the Multicore Era](https://research.cs.wisc.edu/multifacet/amdahl/)

