---
title: MySQL索引与锁
date: 2021-03-21 14:12:10
categories: 数据库
tags:
  - MySQL
---

## 索引
InnoDB存储引擎支持以下几种索引结构:
1. B+树索引
2. 全文索引
3. 哈希索引

### B+树索引

结构为'B+树'的索引有聚集索引/辅助索引
聚集索引是以主键来构造B+树,在叶子节点中存放行记录,也就是叶子节点称为数据页.
辅助索引是以索引key来构造B+树,叶子节点记录的是主键,因此在进行查找是会进行一次读取聚集索引的操作

### 全文索引
全文索引指的是将存储与数据库中的全部数据中的任意内容信息查询出来的技术.
全文索引主要是用倒排索引的技术来进行实现,倒排索引需要用到一个索引辅助表,对全文中的值进行分词和索引定位

### 哈希索引
哈希索引指的是用哈希算法来存储索引的结构,InnoDB的哈希索引不能由用户自定义,而是由客户进行多次查询和命中某种条件后会将B+树索引进行升级转换成哈希索引,这种算法有点类似JVM中对热点代码的JIT技术,提前将热点数据拿出来

## 锁

>锁是数据库系统区别于文件系统的一个关键特性.锁机制用于管理对共享资源的并发访问.InnoDB存储引擎会在行级别上对表数据上锁.

### 锁类型
InnoDB存储引擎实现了两种标准的行级锁
- 共享锁(S Lock),允许事务读一行数据
- 排他锁(X Lock),允许事务删除或更新一行数据

InnoDB存储引擎支持多粒度锁定,这种锁定允许事务在行级上的锁和表级上的锁同时存在.
为了支持在不同粒度上进行加锁操作,InnoDB存储引擎支持意向锁,意向锁可以分为'意向共享锁'/'意向排他锁'
意向共享锁:事务想要获得一张表中的某几行的共享锁
意向排他锁:事务想要获得一张表中的某几行的排他锁

### 一致性非锁定读
'一致性非锁定读'指的是InnoDB通过行的多版本控制系统,在读取时不必等待X锁的释放.
RC隔离级别下,一致性非锁定读一定是读取最新的一份快照数据
RR隔离级别下,一致性非锁定读一定是读取事务开始时的一份快照数据

### 一致性锁定读
InnoDB通过两种操作显式的支持一致性锁定读,第一种是
- SELECT * FOR UPDATE 加X锁
- SELECT * LOCK IN SHARE MODE 加S锁

### 自增计数
InnoDB的自增计数是通过表上的一个自增长计数器来进行的,当插入SQL执行完毕后该自增计数器就完成自增操作并提交

### 锁算法
1. Record Lock:行锁
2. Gap Lock:间隙锁
3. Next-Key Lock:行锁+间隙锁

- Next-Key Lock是默认InnoDB默认采用的锁定算法,但是当查询时使用到了聚集索引时会降级成'Record Lock'锁.
这里有一个小疑问,InnoDB对于Insert的操作会检查插入记录的下一条记录是否被锁定,如果锁定则不允许操作 

Next-Key Loc只在RR隔离模式下使用,主要是为了解决RR模式下的幻读问题(这是又有一个疑问了既然RR模式读取的是数据的快照,按理说这个时候应该没有新插入数据的快照,为什么要这样设计喃)

- 阻塞
阻塞指的是不同锁之间的兼容关系,在某些时刻需要等待另外一个事务中的锁释放.在默认情况下InnoDB的存储引擎在大部分情况下都不会对异常进行回滚.

- 死锁
死锁指的是两个以上的事务在执行过程中相互等待.解决死锁最简单的方法是超时机制.MySQL检测超时机制是通过'等待图'的机制来进行死锁检测.
- 等待图检测机制
通过保存锁信息和事务等待链表形成一张图结构,检测图中是否存在回路,如果存在回路证明发生了死锁.
- 死锁回滚
对于死锁异常,InnoDB会选择回滚UNDO量最小的事务进行回滚




