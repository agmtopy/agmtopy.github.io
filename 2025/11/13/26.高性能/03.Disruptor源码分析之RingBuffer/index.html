<!DOCTYPE HTML>
<html lang="zh-Hans">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Disruptor源码分析之RingBuffer, agmtopy博客">
    <meta name="description" content="你瞧这些白云聚了又散，散了又聚，人生离合，亦复如斯">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Disruptor源码分析之RingBuffer | agmtopy博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="agmtopy博客" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">agmtopy博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">agmtopy博客</div>
        <div class="logo-desc">
            
            你瞧这些白云聚了又散，散了又聚，人生离合，亦复如斯
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/agmtopy" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/agmtopy" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/40.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Disruptor源码分析之RingBuffer</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/disruptor/">
                                <span class="chip bg-color">disruptor</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD/" class="post-category">
                                高性能
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-11-13
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>字数:&nbsp;&nbsp;
                    3.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时间:&nbsp;&nbsp;
                    15 分钟
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <link rel="stylesheet" href="/libs/prism/prism.css">

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>Disruptor源码分析之RingBuffer</h1>
<p>RingBuffer是Disruptor的核心组件之一,它是一个高效的环形缓冲区,用于在生产者和消费者之间传递事件对象,RingBuffer通过预分配内存和无锁设计实现了高性能的数据传输,本文将深入分析RingBuffer的源码实现,包括其继承结构、属性、初始化过程以及读写逻辑。</p>
<h2 id="RingBuffer类"><a class="header-anchor" href="#RingBuffer类"></a>RingBuffer类</h2>
<p><img src="https://github.com/agmtopy/noteBook/blob/master/png/d-disruptor/RingBuffer_%E7%BB%A7%E6%89%BF%E7%B1%BB%E5%9B%BE.png?raw=true" alt="RingBuffer继承图"></p>
<p>可用看到RingBuffer继承实现<B>RingBufferPad</B>、<B>Cursored</B>、<B>Sequenced</B>,其中RingBufferPad是对RingBuffer自身结构的描述,Sequenced和Cursored接口定义RingBuffer的行为;</p>
<h3 id="RingBufferPad-核心抽象"><a class="header-anchor" href="#RingBufferPad-核心抽象"></a>RingBufferPad:核心抽象</h3>
<p>可以看到RingBuffer继承自RingBufferPad,其中RingBufferPad的作用是进行缓存行填充,防止伪共享,RingBufferPad对于缓存行填充的实现有前后两个版本,第一个版本是使用Long类型的字段进行填充,第二个版本是使用byte数组进行填充,具体代码如下:<br>
<a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/commit/bd5d7d8dd6271d1b9086b96323fbd8fca51e33b1">Commit bd5d7d8</a></p>
<p>为什么要从Long类型改为byte数组呢?<br>
因为Long类型的字段在JDK15之后由于内存布局调整,导致Long类型的继承布局结构可能会被优化,导致缓存行填充失效,而byte数组可以确保填充字段不会被优化掉,从而保证缓存行填充的效果,因此在使用padding trick技巧时需要关注不同JDK版本对继承字段的优化;</p>
<h3 id="Cursored-序列接口"><a class="header-anchor" href="#Cursored-序列接口"></a>Cursored:序列接口</h3>
<p>Cursored用于声明当前&quot;当前最大序列号&quot;的抽象接口,当RingBuffer继承Cursored时,需要实现getCursor()方法,用于获取当前最大序列号;</p>
<h3 id="Sequenced-基本操作接口"><a class="header-anchor" href="#Sequenced-基本操作接口"></a>Sequenced:基本操作接口</h3>
<p>Sequenced是RingBuffer的核心父类,它定义了RingBuffer的基本操作接口,包括获取容量、发布事件、检查是否有可用事件等方法,定义了其他类如何与RingBuffer进行交互的方式;</p>
<h2 id="RingBuffer的属性"><a class="header-anchor" href="#RingBuffer的属性"></a>RingBuffer的属性</h2>
<p>RingBuffer的核心属性都是放到<B>RingBufferFields</B>中的分别是:</p>
<ol>
<li><B>indexMask</B>:用于计算核心环形缓冲区的索引的掩码,大小为RingBuffer长度减1,计算索引方式为:index = num &amp; indexMask,等效与num % bufferSize,通过位运算可以提高计算效率;<br>
例如,RingBuffer的长度为4,则indexMask = 4 - 1 = 3(二进制为0011),当num=6(二进制为0110)时,index = 0011 &amp; 0110 = 0010 = 2,所以索引为2;</li>
<li><B>entries</B>:核心环形缓冲区,用于存储事件对象的数组,有界数组;</li>
<li><B>sequencer</B>:生产者序列号对象,用于管理生产者的序列<br>
sequencer是Disruptor的<B>核心调度器</B>,它其实是继承Cursored(状态管理)和Sequenced(基本操作)两个接口的抽象类,它定义了生产者如何发布事件,以及如何与消费者进行协调,其中它有两个实现类:
<ul>
<li>SingleProducerSequencer:单生产者实现,适用于只有一个生产者的场景,它通过简单的自旋锁来实现线程间的协调,性能较高;</li>
<li>MultiProducerSequencer:多生产者实现,适用于有多个生产者的场景,它使用CAS操作来实现线程间的协调,从而避免锁的使用,性能稍低于单生产者实现;</li>
</ul>
</li>
<li><B>bufferSize</B>:环形缓冲区的大小,必须是2的幂次方;</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/blob/17a619e9412951ec8762affbe08d10d7bca92c1a/src/main/java/com/lmax/disruptor/RingBuffer.java#L34">RingBufferFields</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RingBufferFields</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">RingBufferPad</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//数组前后空闲填充数量,防止伪共享</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BUFFER_PAD</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token comment">//索引掩码</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> indexMask<span class="token punctuation">;</span>
    <span class="token comment">//有界事件数组</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">E</span><span class="token punctuation">[</span><span class="token punctuation">]</span> entries<span class="token punctuation">;</span>
    <span class="token comment">//数组大小</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">;</span>
    <span class="token comment">//控制器</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Sequencer</span> sequencer<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="RingBuffer初始化过程"><a class="header-anchor" href="#RingBuffer初始化过程"></a>RingBuffer初始化过程</h2>
<p>RingBuffer初始化主要是通过Disruptor类来完成的,Disruptor.create()方法会创建RingBuffer对象,具体代码如下:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/blob/95c705f60c1833b07f1fed6e08a08d7bee7f0971/src/main/java/com/lmax/disruptor/dsl/Disruptor.java#L92">Disruptor.create</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Disruptor</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">EventFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> eventFactory<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> ringBufferSize<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">ProducerType</span> producerType<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">WaitStrategy</span> waitStrategy<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>
        <span class="token class-name">RingBuffer</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>producerType<span class="token punctuation">,</span> eventFactory<span class="token punctuation">,</span> ringBufferSize<span class="token punctuation">,</span> waitStrategy<span class="token punctuation">)</span><span class="token punctuation">,</span>
        threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/blob/17a619e9412951ec8762affbe08d10d7bca92c1a/src/main/java/com/lmax/disruptor/RingBuffer.java#L201">RingBuffer.create()</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">RingBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">ProducerType</span> producerType<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">EventFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> eventFactory<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">WaitStrategy</span> waitStrategy<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">Sequencer</span> sequencer<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>producerType<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token constant">SINGLE</span><span class="token operator">:</span>
            <span class="token comment">//单生产者模式</span>
            sequencer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SingleProducerSequencer</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">,</span> waitStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">MULTI</span><span class="token operator">:</span>
            <span class="token comment">//多生产者模式</span>
            sequencer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiProducerSequencer</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">,</span> waitStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown producer type: "</span> <span class="token operator">+</span> producerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RingBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>sequencer<span class="token punctuation">,</span> eventFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到buffersize会被用于创建Sequencer对象,然后传递给RingBuffer的构造方法,在RingBuffer的构造方法中,会使用Sequencer对象中的buffersize属性来创建entries数组,具体代码如下:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/blob/17a619e9412951ec8762affbe08d10d7bca92c1a/src/main/java/com/lmax/disruptor/RingBuffer.java#L43">RingBufferFields#RingBufferFields</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">RingBufferFields</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">EventFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> eventFactory<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">Sequencer</span> sequencer<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sequencer <span class="token operator">=</span> sequencer<span class="token punctuation">;</span>
        <span class="token comment">//使用sequencer中的BufferSize作为数组长度</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">=</span> sequencer<span class="token punctuation">.</span><span class="token function">getBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferSize <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"bufferSize must not be less than 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">bitCount</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"bufferSize must be a power of 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>indexMask <span class="token operator">=</span> bufferSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//创建事件数组</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>bufferSize <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">BUFFER_PAD</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">fill</span><span class="token punctuation">(</span>eventFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在创建entries数组时,可以看到使用bufferSize加上了2倍的BUFFER_PAD,其中<B>BUFFER_PAD</B>是为了进行缓存行填充,防止伪共享;然后就进行了fill操作,用于初始化entries数组,具体代码如下:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/blob/17a619e9412951ec8762affbe08d10d7bca92c1a/src/main/java/com/lmax/disruptor/RingBuffer.java#L43">RingBufferFields#fill</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">EventFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> eventFactory<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bufferSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//对数组进行填充,可以看到前BUFFER_PAD和后BUFFER_PAD的位置没有进行填充</span>
        entries<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token constant">BUFFER_PAD</span><span class="token punctuation">]</span> <span class="token operator">=</span> eventFactory<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对空数组进行填充使用EventFactory创建事件对象,eventFactory是用户自定义的,用于创建事件对象的工厂接口,用户可以实现自己的EventFactory来创建不同类型的事件对象;</p>
<h3 id="小结"><a class="header-anchor" href="#小结"></a>小结</h3>
<p>RingBuffer的初始化主要是通过Disruptor类来完成的,在创建RingBuffer时会根据生产者类型(单生产者或者多生产者)创建不同的Sequencer对象,然后传递给RingBuffer的构造方法,在构造方法中会使用Sequencer中的bufferSize来创建entries数组,并使用EventFactory进行初始化填充,同时还会在数组中使用空的位置防止伪共享;</p>
<h2 id="RingBuffer的读写逻辑"><a class="header-anchor" href="#RingBuffer的读写逻辑"></a>RingBuffer的读写逻辑</h2>
<p>RingBuffer的读写逻辑是整个Disruptor的关键,主要是通过Sequencer来实现的,生产者通过Sequencer来发布事件,消费者通过Sequencer来获取可用事件;</p>
<h3 id="写入流程"><a class="header-anchor" href="#写入流程"></a>写入流程</h3>
<p>生产者写入事件的流程主要包括以下几个步骤:</p>
<ol>
<li>获取下一个可用的序列号:生产者通过调用sequencer.next()</li>
<li>通过第一步获取的序列号获取事件对象:生产者通过ringBuffer.get(sequence)获取对应的事件对象;</li>
<li>填充事件对象:生产者对获取到的事件对象进行填充;</li>
<li>发布事件:生产者通过sequencer.publish(sequence)将事件发布出去;</li>
</ol>
<p>可以参考:<a target="_blank" rel="noopener" href="https://github.com/agmtopy/Disruptor/blob/631de39d356887a175d9ffdb1aadaa7a8cb49354/src/main/java/performance/basis/Disruptor1P1C.java#L29">Disruptor1P1C</a></p>
<p>根据这个流程依次进行分析:</p>
<ul>
<li>获取下一个可用序号的</li>
</ul>
<p>Sequencer#next方法是实现Sequenced接口的next方法,有两种不同的实现,分别是SingleProducerSequencer和MultiProducerSequencer,先对SingleProducerSequencer进行分析:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/0950b4d69396e90c2c0643a51d99c2fb9cfab703/src/main/java/com/lmax/disruptor/SingleProducerSequencer.java#L134">SingleProducerSequencer#next</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
 <span class="token punctuation">&#123;</span>
     <span class="token comment">//判断线程和生产者是否是最开始的匹配关系,首次获取nextSeq时,会将两者之间存到Map中</span>
     <span class="token keyword">assert</span> <span class="token function">sameThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"Accessed by two threads - use ProducerType.MULTI!"</span><span class="token punctuation">;</span>

     <span class="token comment">//检测是否超过有效索引长度</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">></span> bufferSize<span class="token punctuation">)</span>
     <span class="token punctuation">&#123;</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"n must be > 0 and &lt; bufferSize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>

     <span class="token comment">//this.nextValue作为上一次写入索引</span>
     <span class="token keyword">long</span> nextValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextValue<span class="token punctuation">;</span>

     <span class="token comment">//关注点1:下一次索引+n</span>
     <span class="token keyword">long</span> nextSequence <span class="token operator">=</span> nextValue <span class="token operator">+</span> n<span class="token punctuation">;</span>

     <span class="token comment">//关注点2:wrapPoint:理论上的最晚可以消费的索引地址</span>
     <span class="token keyword">long</span> wrapPoint <span class="token operator">=</span> nextSequence <span class="token operator">-</span> bufferSize<span class="token punctuation">;</span>
     <span class="token comment">//获取缓存下来的最小消费者序号</span>
     <span class="token keyword">long</span> cachedGatingSequence <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedValue<span class="token punctuation">;</span>

     <span class="token comment">//关注点3:判断nextIndex是否超过当前最小的消费者序号</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapPoint <span class="token operator">></span> cachedGatingSequence <span class="token operator">||</span> cachedGatingSequence <span class="token operator">></span> nextValue<span class="token punctuation">)</span>
     <span class="token punctuation">&#123;</span>
         <span class="token comment">//重新设置内存屏障</span>
         cursor<span class="token punctuation">.</span><span class="token function">setVolatile</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// StoreLoad fence</span>

         <span class="token comment">//设置局部变量用于暂存最慢的消费索引</span>
         <span class="token keyword">long</span> minSequence<span class="token punctuation">;</span>

         <span class="token comment">//关注点4:循环等待,生产者等待最慢的消费者消费出空闲的位置</span>
         <span class="token keyword">while</span> <span class="token punctuation">(</span>wrapPoint <span class="token operator">></span> <span class="token punctuation">(</span>minSequence <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getMinimumSequence</span><span class="token punctuation">(</span>gatingSequences<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
             <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TODO: Use waitStrategy to spin?</span>
         <span class="token punctuation">&#125;</span>
         <span class="token comment">//重新设置位置</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>cachedValue <span class="token operator">=</span> minSequence<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>

     <span class="token keyword">this</span><span class="token punctuation">.</span>nextValue <span class="token operator">=</span> nextSequence<span class="token punctuation">;</span>

     <span class="token keyword">return</span> nextSequence<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码中的四个关注点参考这个图:<br>
<img src="https://github.com/agmtopy/noteBook/blob/master/png/d-disruptor/RingBuffer_next%E8%8E%B7%E5%8F%96%E4%B8%8B%E4%B8%80%E4%B8%AA%E4%BD%8D%E7%BD%AE.png?raw=true" alt="获取下一个位置"></p>
<p>在获取下一个可用位置时,由于是单线程写入,因此在校验过是单线程写入后,后续主要做的事情就是在保证有空闲位置时,直接返回下一个可用位置,如果没有空闲位置,则通过循环等待的方式等待消费者消费出空闲位置;</p>
<p>ps:循环等待是通过<B>LockSupport.parkNanos(1L);</B>这种方式实现的;</p>
<ul>
<li>
<p>MultiProducerSequencer#next<br>
@TODO 待补充</p>
</li>
<li>
<p>获取对应的事件对象</p>
</li>
</ul>
<p>获取事件对象是通过RingBuffer#get方法实现的,具体代码如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">elementAt</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">E</span> <span class="token function">elementAt</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//先加数组前BUFFER_PAD位插入的空白,在进行位运算返回事件</span>
    <span class="token keyword">return</span> entries<span class="token punctuation">[</span><span class="token constant">BUFFER_PAD</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sequence <span class="token operator">&amp;</span> indexMask<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取事件很简单,直接获取entries数组中对应位置的事件对象即可,需要注意的是由于entries数组前后有BUFFER_PAD个空白位置,因此在获取时需要加上BUFFER_PAD;</p>
<p>获取完成事件后,对事件进行填充,这个过程是用户自行实现的,填充完成后,需要发布事件通知消费者;</p>
<ul>
<li>发布事件</li>
</ul>
<p>RingBuffer的pushlish方法是调用Sequencer的publish方法实现的,具体代码如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    sequencer<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>Sequencer#publish<br>
Sequencer的publish方法同样有两个实现,分别是SingleProducerSequencer和MultiProducerSequencer,先对SingleProducerSequencer进行分析:</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/a617447ce5091233d96d5fbd318ae52e49a51d9f/src/main/java/com/lmax/disruptor/SingleProducerSequencer.java#L235">SingleProducerSequencer#publish(long)</a></p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//设置最大序列号</span>
    cursor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通知消费者等待策略唤醒</span>
    waitStrategy<span class="token punctuation">.</span><span class="token function">signalAllWhenBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>cursor.set(sequence)的作用是发布当前事件的序列号,类似于声明该事件已处理完成,消费者可以开始消费该事件,cursor对象是Sequence的一个实例对象,cursor.set(sequence)方法会将cursor的值设置为传入的sequence值,表示当前已发布的最大序列号;</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Sequence</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> initialValue<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//写屏障,保证写操作不会被指令重排序</span>
    <span class="token class-name">VarHandle</span><span class="token punctuation">.</span><span class="token function">releaseFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> initialValue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用waitStrategy.signalAllWhenBlocking()方法通知等待策略唤醒消费者线程,从而让消费者开始消费事件;</p>
<p>signalAllWhenBlocking方法不同的消费者有不同的实现,例如BusySpinWaitStrategy从不释放CPU,也不存在唤醒<br>
<a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/1384012154411b4c4e2081cd594d03f12616c417/src/main/java/com/lmax/disruptor/BusySpinWaitStrategy.java#L43">com.lmax.disruptor.BusySpinWaitStrategy#signalAllWhenBlocking</a></p>
<p>BlockingWaitStrategy使用信号量mutex来控制释放CPU时,对于signalAllWhenBlocking需要进行notifyAll操作</p>
<p><a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/1384012154411b4c4e2081cd594d03f12616c417/src/main/java/com/lmax/disruptor/BlockingWaitStrategy.java#L55">com.lmax.disruptor.BlockingWaitStrategy#signalAllWhenBlocking</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">signalAllWhenBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        mutex<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="读取流程"><a class="header-anchor" href="#读取流程"></a>读取流程</h3>
<p>先从消费者如何注册开始分析,消费者注册分为两种注册方式分别是<B>handleEventsWith()</B>注册广播消息处理器和<B>handleEventsWithWorkerPool</B>注册事件消费组的方式;</p>
<ul>
<li>
<p>广播模式<br>
广播模式指的是消息会被每一个注册的消费器处理一次,需要继承<B>EventHandler</B>接口,实现<B>onEvent</B>方法;</p>
</li>
<li>
<p>事件消费组模式<br>
事件消费模式指的是消息会被事件消费组中的某一个消费者处理一次,需要实现<B>WorkHandler</B>接口,实现<B>onEvent</B>方法;<br>
ps:WorkerPool的方式在Disruptor中已被废弃,建议使用EventHandler的方式;</p>
</li>
</ul>
<p>下面基于disruptor4.0版本对EventHandler进行分析;</p>
<ol>
<li>注册流程<br>
Disruptor#handleEventsWith()  -&gt;  <a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/ff615c140fcd068c1d7296ce7f1a76cfd70e0588/src/main/java/com/lmax/disruptor/dsl/Disruptor.java#L506">createEventProcessors()</a></li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token class-name">EventHandlerGroup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">createEventProcessors</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">Sequence</span><span class="token punctuation">[</span><span class="token punctuation">]</span> barrierSequences<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">EventHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> eventHandlers<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">checkNotStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//每个消费者一个Sequence</span>
        <span class="token keyword">final</span> <span class="token class-name">Sequence</span><span class="token punctuation">[</span><span class="token punctuation">]</span> processorSequences <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequence</span><span class="token punctuation">[</span>eventHandlers<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">SequenceBarrier</span> barrier <span class="token operator">=</span> ringBuffer<span class="token punctuation">.</span><span class="token function">newBarrier</span><span class="token punctuation">(</span>barrierSequences<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//依次处理EventHandler</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> eventHandlersLength <span class="token operator">=</span> eventHandlers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> eventHandlersLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//取出EventHandler包装成BatchEventProcessor</span>
            <span class="token keyword">final</span> <span class="token class-name">EventHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> eventHandler <span class="token operator">=</span> eventHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">BatchEventProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> batchEventProcessor <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">BatchEventProcessorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>ringBuffer<span class="token punctuation">,</span> barrier<span class="token punctuation">,</span> eventHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置异常处理器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                batchEventProcessor<span class="token punctuation">.</span><span class="token function">setExceptionHandler</span><span class="token punctuation">(</span>exceptionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">//核心关键点1:用consumerRepository来存储EventProcessor</span>
            consumerRepository<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batchEventProcessor<span class="token punctuation">,</span> eventHandler<span class="token punctuation">,</span> barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//对序列数组进行初始化</span>
            processorSequences<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> batchEventProcessor<span class="token punctuation">.</span><span class="token function">getSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//核心关键点2:更新消费者门闩,防止生产者将未消费位置覆盖</span>
        <span class="token function">updateGatingSequencesForNextInChain</span><span class="token punctuation">(</span>barrierSequences<span class="token punctuation">,</span> processorSequences<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventHandlerGroup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> consumerRepository<span class="token punctuation">,</span> processorSequences<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法中有两个地方值得注意,第一个地方是在于<B>consumerRepository</B>,用于保存消费者对象的容器,内部是通过Map的方式进行实现的</p>
<ul>
<li>ConsumerRepository</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">ConsumerRepository</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventHandlerIdentity</span><span class="token punctuation">,</span> <span class="token class-name">EventProcessorInfo</span><span class="token punctuation">></span></span> eventProcessorInfoByEventHandler <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">IdentityHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sequence</span><span class="token punctuation">,</span> <span class="token class-name">ConsumerInfo</span><span class="token punctuation">></span></span> eventProcessorInfoBySequence <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">IdentityHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerInfo</span><span class="token punctuation">></span></span> consumerInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//省略......</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS:IdentityHashMap中的key是比较对象引用地址</p>
<p>第二个关键点是<B>updateGatingSequencesForNextInChain</B>方法,这个方法的作用是在于防止生产者提前将未消费的事件覆盖掉;</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/ff615c140fcd068c1d7296ce7f1a76cfd70e0588/src/main/java/com/lmax/disruptor/dsl/Disruptor.java#L573">Disruptor#updateGatingSequencesForNextInChain</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateGatingSequencesForNextInChain</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Sequence</span><span class="token punctuation">[</span><span class="token punctuation">]</span> barrierSequences<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Sequence</span><span class="token punctuation">[</span><span class="token punctuation">]</span> processorSequences<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//消费者处理序列长度大于0时,才进行处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>processorSequences<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 把新的消费者序列 (B) 加入 RingBuffer 的监控名单</span>
        ringBuffer<span class="token punctuation">.</span><span class="token function">addGatingSequences</span><span class="token punctuation">(</span>processorSequences<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 把旧的屏障序列 (A) 从监控名单移除</span>
        <span class="token comment">// 因为 B 依赖 A，所以 B 肯定比 A 慢，RingBuffer 只要盯着 B 就够了</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Sequence</span> barrierSequence <span class="token operator">:</span> barrierSequences<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            ringBuffer<span class="token punctuation">.</span><span class="token function">removeGatingSequence</span><span class="token punctuation">(</span>barrierSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 3. 同时也告诉这个消费者组，下次如果再有人接在 B 后面（比如 .then(C)），</span>
        <span class="token comment">// B 就变成了由于旧的序列，需要被移除</span>
        consumerRepository<span class="token punctuation">.</span><span class="token function">unMarkEventProcessorsAsEndOfChain</span><span class="token punctuation">(</span>barrierSequences<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为disruptor支持消费者之间相互依赖进行消费,因此对于有相互依赖关系的两个消费者,例如A消费者完成在then B消费者这种场景,只需要判断B消费者是否完成消费即可,如果B完成表示A肯定完成,因此只需要监控B消费者的Sequences即可;</p>
<p>第三步设置处理链结束的方法是<a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/aa7c19701dae05d138911ee350a1b52cbca9613a/src/main/java/com/lmax/disruptor/dsl/EventProcessorInfo.java#L87">EventProcessorInfo#markAsUsedInBarrier</a><br>
将endOfChain设置未false即可;</p>
<ol start="2">
<li>启动消费者流程</li>
</ol>
<p>disruptor的启动方法是[Disruptor#start],这个方法会调用<a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/5eb647d1603c39f7f670cd718ef3e73b673c6488/src/main/java/com/lmax/disruptor/dsl/ConsumerRepository.java#L60">ConsumerRepository#startAll</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startAll</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    consumerInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>c <span class="token operator">-></span> c<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>threadFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/aa7c19701dae05d138911ee350a1b52cbca9613a/src/main/java/com/lmax/disruptor/dsl/EventProcessorInfo.java#L66">EventProcessorInfo#start</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//通过线程工厂创建一个指定好任务的线程</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread <span class="token operator">=</span> threadFactory<span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span>eventprocessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> thread<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create thread to run: "</span> <span class="token operator">+</span> eventprocessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//立即启动线程执行任务</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这一个步骤又和注册consumerhandler关联到一起了,注册时将eventHandler包装成BatchEventProcessor,ConsumerInfo启动后会执行BatchEventProcessor子类的<B>run</B>方法,下面以<B>BatchEventProcessor</B>来进行分析:<br>
BatchEventProcessor.run()方法主要做的事为:清除屏障标识、开始循环处理事件</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/agmtopy/disruptor-source/blob/d9fefddb24f28a8e8dfd5464029d6c01f4c1e9f2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L149">com.lmax.disruptor.BatchEventProcessor#processEvents</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token class-name">T</span> event <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token comment">//设置需要处理的下一个序列号</span>
       <span class="token keyword">long</span> nextSequence <span class="token operator">=</span> sequence<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1L</span><span class="token punctuation">;</span>

       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           <span class="token keyword">final</span> <span class="token keyword">long</span> startOfBatchSequence <span class="token operator">=</span> nextSequence<span class="token punctuation">;</span>
           <span class="token comment">//外层try-catch处理系统异常</span>
           <span class="token keyword">try</span>
           <span class="token punctuation">&#123;</span>
               <span class="token comment">//内层try-catch处理可重试异常</span>
               <span class="token keyword">try</span>
               <span class="token punctuation">&#123;</span>
                   <span class="token comment">//关键点1:检测是否可以进行消费:是否有可消费的消息,是否前置消费处理器已处理完成</span>
                   <span class="token comment">//返回的最大的可消费位置</span>
                   <span class="token keyword">final</span> <span class="token keyword">long</span> availableSequence <span class="token operator">=</span> sequenceBarrier<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span>nextSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token comment">//设置单次消费的最大限制</span>
                   <span class="token keyword">final</span> <span class="token keyword">long</span> endOfBatchSequence <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>nextSequence <span class="token operator">+</span> batchLimitOffset<span class="token punctuation">,</span> availableSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>

                   <span class="token comment">//判断是否有消费,有消费时通知消费事件</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSequence <span class="token operator">&lt;=</span> endOfBatchSequence<span class="token punctuation">)</span>
                   <span class="token punctuation">&#123;</span>
                       <span class="token comment">//通知开始处理</span>
                       eventHandler<span class="token punctuation">.</span><span class="token function">onBatchStart</span><span class="token punctuation">(</span>endOfBatchSequence <span class="token operator">-</span> nextSequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> availableSequence <span class="token operator">-</span> nextSequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">&#125;</span>

                   <span class="token comment">//循环开始处理</span>
                   <span class="token keyword">while</span> <span class="token punctuation">(</span>nextSequence <span class="token operator">&lt;=</span> endOfBatchSequence<span class="token punctuation">)</span>
                   <span class="token punctuation">&#123;</span>
                       <span class="token comment">//关键点2:从RingBuffer数组中获取元素</span>
                       event <span class="token operator">=</span> dataProvider<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token comment">//通知事件</span>
                       eventHandler<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> nextSequence<span class="token punctuation">,</span> nextSequence <span class="token operator">==</span> endOfBatchSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       nextSequence<span class="token operator">++</span><span class="token punctuation">;</span>
                   <span class="token punctuation">&#125;</span>

                   retriesAttempted <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                   <span class="token comment">//设置本次读取的终止位置</span>
                   sequence<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>endOfBatchSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">&#125;</span>
               <span class="token comment">//省略...</span>
           <span class="token punctuation">&#125;</span>
           <span class="token comment">//省略...</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法有两个重要的关键点,分别是关键点1负责检测是否可以进行消费和关键点2从RingBuffer数组中获取元素进行消费的动作<br>
关键点1<B>sequenceBarrier.waitFor</B>方法的作用是在于使用传入的等待策略来等待可消费的消息;<br>
关键点2<B>dataProvider.get(nextSequence)</B>方法的作用是去取RingBuffer中的event数组中的数据,然后在将event传递到eventHandler.onEvent方法中</p>
<h2 id="参考资料"><a class="header-anchor" href="#参考资料"></a>参考资料</h2>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mjunz/p/18896162">Disruptor—3.核心源码实现分析</a></p>

                
            </div>
            <hr/>

            
    

            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/disruptor/">
                                    <span class="chip bg-color">disruptor</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;Current
            </div>
            <div class="card">
                <a href="/2025/11/13/26.%E9%AB%98%E6%80%A7%E8%83%BD/03.Disruptor%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BRingBuffer/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/40.jpg" class="responsive-img" alt="Disruptor源码分析之RingBuffer">
                        
                        <span class="card-title">Disruptor源码分析之RingBuffer</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-11-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD/" class="post-category">
                                    高性能
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/disruptor/">
                        <span class="chip bg-color">disruptor</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/11/09/26.%E9%AB%98%E6%80%A7%E8%83%BD/02.Disruptor%E4%B9%8B%E7%90%86%E8%AE%BA%E5%88%86%E6%9E%90/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/37.jpg" class="responsive-img" alt="Disruptor之理论基础">
                        
                        <span class="card-title">Disruptor之理论基础</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-11-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD/" class="post-category">
                                    高性能
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/disruptor/">
                        <span class="chip bg-color">disruptor</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
                <div class="container row center-align"
                    style="margin-bottom: 0px !important;">
                    <div class="col s12 m8 l8 copy-right">
                        
                            <span id="year">
                            </span>
                            
                                    <span id="year">
                                    </span>
                                    <a href="/about" target="_blank">
                                    </a>
                                    &nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
                                    |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery"
                                        target="_blank">Matery</a>
                                    <!-- <br> -->
                                    
                                        &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                                            class="white-color">
                                            232.1k
                                        </span>&nbsp;字
                                        
                                            
                                                
                                                    
                                                        
                                                            

                                                                
                                                                    

                                                                        
                                                                            <br>
                                                                            
                                                                                    <br>
                                                                                    
                    </div>
                    <div class="col s12 m4 l4 social-link social-statis">
                        

        
            <a href="mailto:zjytian@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我"
                data-position="top" data-delay="50">
                <i class="fas fa-envelope-open"></i>
            </a>
            

                

                        

                                

                                        

                                                

                                                        
                    </div>
                </div>
</footer>

<div class="progress-bar"></div>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入关键词"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
